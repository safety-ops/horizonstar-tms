---
phase: 12-core-dispatch-pages
plan: 06
type: execute
wave: 2
depends_on: [12-01]
files_modified: [index.html]
autonomous: false

must_haves:
  truths:
    - "Order Detail page header uses design system tokens for spacing, typography, and border-radius"
    - "Order Detail info grid, route columns, vehicle section, and sidebar cards use design system tokens"
    - "Order Detail inspection photos display in a 4-image grid layout with pickup/delivery sections (per user exception)"
    - "Order Detail payment card, assignment card, customer info card, and activity card use design system tokens"
    - "All existing functionality preserved: back navigation, edit order, send invoice, generate BOL/invoice/route sheet, send tracking, mark as paid, edit notes, view/open attachments, view inspection photos"
  artifacts:
    - path: "index.html"
      provides: "Restyled openOrderDetailPage() and renderInspectionCard() functions"
      contains: "inspection-photo-grid"
  key_links:
    - from: "index.html openOrderDetailPage()"
      to: "assets/css/design-system.css"
      via: "CSS token references"
      pattern: "var\\(--radius\\)|var\\(--text-sm\\)"
---

<objective>
Restyle the Order Detail page (openOrderDetailPage function) and implement the inspection photos 4-image grid layout. Replace hardcoded font sizes, paddings, and border radii with design system CSS tokens. The inspection photo grid restructure is the one user-approved DOM exception in Phase 12.

Purpose: Order Detail is the deepest drill-down page in the dispatch workflow. Design system consistency plus the improved photo grid provides dispatchers a polished, professional view of each vehicle order.

Output: Updated openOrderDetailPage() in index.html with design system tokens, plus restructured inspection photo grid per mockup.
</objective>

<execution_context>
@/Users/reepsy/.claude/get-shit-done/workflows/execute-plan.md
@/Users/reepsy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-core-dispatch-pages/12-CONTEXT.md
@.planning/phases/12-core-dispatch-pages/12-RESEARCH.md
@mockups/web-tms-redesign/order-detail.html
@assets/css/design-system.css
@index.html (lines 13022-13421 for openOrderDetailPage, and the renderInspectionCard function)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restyle Order Detail page with design system tokens</name>
  <files>index.html</files>
  <action>
  In openOrderDetailPage() (starts at line 13022), apply design system token substitutions to the page header and body content. CRITICAL: Only change inline style values and CSS token references. Do NOT change JavaScript logic, async data fetching, onclick handlers, or template literal expressions.

  Note: The Order Detail page already has a well-structured DOM with dedicated CSS classes (.order-detail-layout, .order-detail-card, .route-side-by-side, etc.) that were created for this page. The main work here is ensuring inline styles within the template literal use design system tokens.

  **1. Loading state (line ~13037):**
  - Replace `padding:80px` with `padding:var(--spacing-20)` (or keep as 80px if no 20 token)
  - Replace `margin-top:16px` with `margin-top:var(--spacing-4)`

  **2. Page header (lines ~13378-13411):**
  - The header already uses CSS classes (header-left, header-right, etc.) — these come from the existing `<style>` block in index.html
  - No inline style changes needed in the header section — it's already class-based

  **3. Order info card (lines ~13087-13119):**
  - Already uses .order-detail-card, .order-info-grid, .order-info-item CSS classes
  - Replace `font-family:monospace;font-size:12px` on VIN cell with `font-family:var(--font-mono);font-size:var(--text-xs)`
  - Keep everything else as-is (class-based styling)

  **4. Route card (lines ~13122-13194):**
  - Already uses .route-side-by-side, .route-column, .route-column-badge, etc. CSS classes
  - No inline style changes needed — fully class-based

  **5. Vehicle table (lines ~13197-13222):**
  - Already uses .vehicle-table CSS class
  - Replace `font-family:monospace;font-size:12px` on VIN cell with `font-family:var(--font-mono);font-size:var(--text-xs)`
  - Replace `text-align:right` — keep as-is (layout property)

  **6. Payment card (lines ~13236-13267):**
  - Already uses .payment-card, .payment-amount, .payment-details CSS classes
  - Replace `width:100%;margin-top:12px` on Mark as Paid button with `width:100%;margin-top:var(--spacing-3)`

  **7. Customer information card (lines ~13270-13284):**
  - Already uses .customer-info, .customer-name, .customer-contact CSS classes
  - No inline style changes needed

  **8. Assignment card (lines ~13287-13315):**
  - Already uses .sidebar-info-list, .sidebar-info-row CSS classes
  - No inline style changes needed

  **9. Quick Actions card (lines ~13346-13360):**
  - Replace `grid-template-columns: repeat(3, 1fr)` — keep as inline (overrides default grid)
  - No other changes needed

  **10. Internal Notes and Activity cards (lines ~13321-13343):**
  - Already class-based, no inline style changes needed
  </action>
  <verify>
  1. Search for `var(--font-mono)` in openOrderDetailPage — should find it on VIN fields
  2. Search for `var(--text-xs)` in openOrderDetailPage — should find it on VIN fields
  3. All onclick handlers preserved (navigate back, openOrderModal, sendInvoiceToBroker, generateBOLPDF, generateInvoicePDF, openOrderAttachmentsModal, generateRouteSheetPDF, sendTrackingLinkToBroker, markOrderPaid, editOrderNotes)
  4. Async data fetching (inspections, photos, damages, videos) unchanged
  5. Page structure (two-column layout with main + sidebar) preserved
  </verify>
  <done>
  Order Detail page uses design system tokens for inline style values where applicable. Most of the page is already class-based and needed minimal changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement inspection photo 4-image grid layout</name>
  <files>index.html</files>
  <action>
  Find the renderInspectionCard() function in index.html and restructure the inspection photo display to match the mockup's 4-image grid layout. This is the ONE user-approved DOM restructure exception in Phase 12 (from CONTEXT.md: "Inspection photos: match mockup's 4-image grid layout with pickup/delivery sections").

  First, find renderInspectionCard by searching for `function renderInspectionCard`. Read the entire function to understand current photo rendering.

  **Target layout (from mockup order-detail.html):**
  Each inspection card (pickup and delivery) should show photos in a 2x2 grid (4 photos max per card), with any additional photos accessible via a "+N more" overlay on the 4th photo.

  **Implementation:**
  1. In the photo rendering section of renderInspectionCard, replace the current photo display with:
  ```javascript
  // Photo grid - 2x2 layout, max 4 visible
  const visiblePhotos = photos.slice(0, 4);
  const remainingCount = photos.length - 4;

  '<div class="inspection-photo-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:var(--spacing-2);margin-top:var(--spacing-3)">' +
  visiblePhotos.map((p, i) => {
    const isLast = i === 3 && remainingCount > 0;
    return '<div style="position:relative;border-radius:var(--radius);overflow:hidden;aspect-ratio:4/3;cursor:pointer" onclick="openPhotoGallery(' + photos.indexOf(p) + ')">' +
      '<img src="' + getPhotoUrl(p) + '" style="width:100%;height:100%;object-fit:cover" alt="Inspection photo">' +
      (isLast ? '<div style="position:absolute;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;color:white;font-size:var(--text-xl);font-weight:var(--weight-bold)">+' + remainingCount + '</div>' : '') +
    '</div>';
  }).join('') +
  '</div>'
  ```

  2. Add the CSS class `.inspection-photo-grid` to design-system.css if needed (or use inline grid styles as shown above — inline is fine since this is a one-off layout).

  3. Ensure the existing photo gallery/lightbox functionality (`openPhotoGallery`) still works with the new grid layout.

  4. If the current renderInspectionCard doesn't have a photo gallery click handler, keep whatever click behavior exists.

  IMPORTANT:
  - Only restructure the PHOTO DISPLAY portion of renderInspectionCard
  - Keep all other parts of the inspection card (header, status, damage list, videos, notes) exactly as-is
  - If photos array is empty, keep existing "No photos" message
  - Preserve all existing inspection data (damage markers, video links, notes, signatures)
  </action>
  <verify>
  1. Search for `inspection-photo-grid` in index.html — should find the new grid container
  2. Search for `grid-template-columns:1fr 1fr` in the inspection card section — should find the 2x2 grid
  3. Search for `aspect-ratio:4/3` in the inspection card section — should find it on photo containers
  4. Photos still clickable to open gallery/lightbox
  5. "+N more" overlay shows when more than 4 photos exist
  6. Empty state ("No photos") still displays when no photos available
  </verify>
  <done>
  Inspection photos display in a 2x2 grid layout with 4 visible photos max and a "+N more" overlay for additional photos. Both pickup and delivery inspection cards use the same grid pattern.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  All 6 core dispatch pages restyled with design system tokens:
  1. Dashboard — stat cards with icons, section-title classes, design tokens
  2. Load Board — category/subcategory tabs with tokens, table styling
  3. Trips list — status/truck tabs with tokens, table styling
  4. Trip Detail — stat cards, pricing widget, vehicle tables with tokens
  5. Orders list — filter bar, search, table with tokens
  6. Order Detail — tokens applied, inspection photo 4-image grid
  </what-built>
  <how-to-verify>
  1. Open index.html in browser
  2. Navigate to Dashboard — verify:
     - Stat cards show colored icon circles instead of left borders
     - Section headers have colored underlines
     - All data and interactions work (period filter, year selector, task checkboxes)
  3. Navigate to Load Board (Future Cars) — verify:
     - Category tabs styled consistently
     - Table renders with vehicle data
     - Add Vehicle and AI Import buttons work
  4. Navigate to Trips — verify:
     - Status tabs (Active/Completed/All) styled consistently
     - Truck tabs styled consistently
     - Click a trip to view Trip Detail
  5. On Trip Detail — verify:
     - Stat cards row shows financial summary
     - Pricing widget renders (if data available)
     - Vehicle direction tables render
     - Expenses and Miles sections render
  6. Navigate to Orders — verify:
     - Filter bar styled consistently
     - Search works
     - Click an order to view Order Detail
  7. On Order Detail — verify:
     - Route card shows pickup/delivery side by side
     - Inspection photos show in 2x2 grid (if inspection data exists)
     - Payment sidebar renders
     - All quick action buttons work
  8. Toggle dark theme — verify all pages look correct in dark mode
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. openOrderDetailPage renders all sections: order info, route, vehicle, inspections, payment, customer, assignment, notes, activity, quick actions
2. Inspection photos display in 2x2 grid with "+N more" overlay
3. All interactive elements work: back button, edit order, send invoice, generate BOL, attachments, route sheet, send tracking, mark as paid, edit notes
4. Dark theme works correctly on Order Detail page
</verification>

<success_criteria>
- Order Detail page uses design system tokens where inline styles exist
- Inspection photos render in 2x2 grid layout (user-approved DOM exception)
- "+N more" overlay shows when photos exceed 4
- All existing functionality preserved
- Visual verification checkpoint passed by user
</success_criteria>

<output>
After completion, create `.planning/phases/12-core-dispatch-pages/12-06-SUMMARY.md`
</output>
