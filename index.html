<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>HORIZON STAR TMS</title>
  
  <!-- PWA Support -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#22c55e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Horizon Star TMS">
  <link rel="apple-touch-icon" href="icon-192.svg">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Typography: Space Grotesk (Display), IBM Plex Sans (Body), JetBrains Mono (Data) -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- External CSS Files -->
  <link rel="stylesheet" href="assets/css/variables.css">
  <link rel="stylesheet" href="assets/css/base.css">
  <link rel="stylesheet" href="assets/css/print.css" media="print">

  <!-- Supabase Client Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      /* Light Theme (Default) - Horizon Star Green */
      --primary: #22c55e;
      --primary-hover: #16a34a;
      --primary-light: rgba(34, 197, 94, 0.12);
      --primary-dark: #15803d;
      --secondary: #64748b;
      --success: #22c55e;
      --success-light: rgba(34, 197, 94, 0.12);
      --warning: #f59e0b;
      --warning-light: rgba(245, 158, 11, 0.12);
      --danger: #ef4444;
      --danger-light: rgba(239, 68, 68, 0.12);
      --info: #3b82f6;
      --info-light: rgba(59, 130, 246, 0.12);
      
      /* Light backgrounds */
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f1f5f9;
      --bg-card: #ffffff;
      --bg-hover: #f1f5f9;
      
      /* Text colors */
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      
      /* Borders */
      --border: #e2e8f0;
      --border-light: #f1f5f9;
      
      /* Shadows for light mode */
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
      
      /* Accent gradient - Green for Horizon Star */
      --accent-gradient: linear-gradient(135deg, #22c55e 0%, #10b981 100%);
      --glass-bg: rgba(255, 255, 255, 0.9);
      
      --radius-sm: 6px;
      --radius: 10px;
      --radius-lg: 14px;
      --radius-xl: 20px;
      --sidebar-width: 240px;
      --sidebar-collapsed-width: 72px;
      --header-height: 64px;
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      
      /* ðŸŽ¨ MODERN UI ENHANCEMENTS v3.0 */
      /* Gradient System */
      --gradient-primary: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      --gradient-primary-hover: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
      --gradient-secondary: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      --gradient-danger: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      --gradient-purple: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      --gradient-sidebar: linear-gradient(180deg, #1a2f2a 0%, #0f1f1a 100%);
      --gradient-card: linear-gradient(180deg, rgba(255,255,255,1) 0%, rgba(248,250,252,0.5) 100%);
      
      /* Enhanced Shadows */
      --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-card: 0 1px 3px rgba(0,0,0,0.04), 0 4px 20px rgba(0,0,0,0.03);
      --shadow-card-hover: 0 8px 30px rgba(0,0,0,0.08), 0 2px 8px rgba(0,0,0,0.04);
      --shadow-float: 0 20px 50px rgba(0,0,0,0.12);
      --shadow-glow-green: 0 4px 20px rgba(34, 197, 94, 0.25);
      --shadow-glow-blue: 0 4px 20px rgba(59, 130, 246, 0.25);
      --shadow-inset: inset 0 2px 4px rgba(0,0,0,0.04);
      --shadow-inner-glow: inset 0 1px 0 rgba(255,255,255,0.1);
      
      /* Animation System */
      --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
      --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
      --ease-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
      --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
      --duration-instant: 100ms;
      --duration-fast: 150ms;
      --duration-normal: 250ms;
      --duration-slow: 400ms;
      
      /* Glass Effect */
      --glass-bg: rgba(255, 255, 255, 0.92);
      --glass-border: rgba(255, 255, 255, 0.2);
      --glass-blur: blur(16px);
      
      /* Text Sizes - More dramatic hierarchy */
      --text-xs: 0.6875rem;    /* 11px - labels */
      --text-sm: 0.8125rem;    /* 13px - secondary */
      --text-base: 0.9375rem;  /* 15px - body */
      --text-md: 1.0625rem;    /* 17px - emphasized */
      --text-lg: 1.25rem;      /* 20px - subheadings */
      --text-xl: 1.625rem;     /* 26px - section titles */
      --text-2xl: 2.25rem;     /* 36px - page titles */
      --text-3xl: 3rem;        /* 48px - hero stats */
      --text-4xl: 4rem;        /* 64px - mega numbers */

      /* Typography - Precision Industrial */
      --font-display: 'Space Grotesk', -apple-system, sans-serif;
      --font-body: 'IBM Plex Sans', -apple-system, sans-serif;
      --font-mono: 'JetBrains Mono', 'SF Mono', monospace;

      /* Extended Primary Green Spectrum */
      --primary-50: #f0fdf4;
      --primary-100: #dcfce7;
      --primary-200: #bbf7d0;
      --primary-300: #86efac;
      --primary-400: #4ade80;
      --primary-500: #22c55e;
      --primary-600: #16a34a;
      --primary-700: #15803d;
      --primary-800: #166534;
      --primary-900: #14532d;

      /* Accent: Electric Cyan */
      --accent: #06b6d4;
      --accent-light: rgba(6, 182, 212, 0.15);

      /* Enhanced Gradients */
      --gradient-surface: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0) 100%);
      --gradient-glow: radial-gradient(ellipse at center, rgba(34, 197, 94, 0.15) 0%, transparent 70%);
      --gradient-mesh:
        radial-gradient(at 40% 20%, rgba(34, 197, 94, 0.08) 0px, transparent 50%),
        radial-gradient(at 80% 0%, rgba(6, 182, 212, 0.05) 0px, transparent 50%),
        radial-gradient(at 0% 50%, rgba(34, 197, 94, 0.05) 0px, transparent 50%);

      /* Glow Effects */
      --glow-primary: 0 0 20px rgba(34, 197, 94, 0.3);
      --glow-accent: 0 0 20px rgba(6, 182, 212, 0.2);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    html {
      height: 100%;
    }
    
    body {
      font-family: var(--font-body);
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: var(--transition);
      font-size: var(--text-base);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100%;
      overflow: auto;
    }

    /* Typography - Display font for headings */
    h1, h2, h3, .display, .page-title {
      font-family: var(--font-display);
      letter-spacing: -0.03em;
      font-weight: 700;
    }

    /* Monospace for data/numbers */
    .stat-value, .money, .row-number, code, .mono {
      font-family: var(--font-mono);
      font-variant-numeric: tabular-nums;
    }
    
    /* Background gradient effect - only for dark theme */
    body.dark-theme::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      background: radial-gradient(circle at 30% 20%, rgba(34, 197, 94, 0.06) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.04) 0%, transparent 50%);
    }
    
    .app { display: flex; min-height: 100vh; position: relative; z-index: 1; overflow: visible; }
    
    /* ============ SIDEBAR - Precision Industrial Design ============ */
    .sidebar {
      width: var(--sidebar-width);
      max-width: var(--sidebar-width);
      min-width: var(--sidebar-width);
      background: #0a1014;
      background-image:
        linear-gradient(180deg, rgba(34, 197, 94, 0.04) 0%, transparent 25%),
        var(--gradient-mesh);
      color: white;
      padding: 0;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      border-right: 1px solid rgba(255, 255, 255, 0.06);
      z-index: 100;
      transition: width 0.3s ease, min-width 0.3s ease, max-width 0.3s ease;
    }
    
    .sidebar::-webkit-scrollbar {
      width: 4px;
    }
    
    .sidebar::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }
    
    .sidebar.collapsed {
      width: var(--sidebar-collapsed-width);
      min-width: var(--sidebar-collapsed-width);
      max-width: var(--sidebar-collapsed-width);
      overflow-y: auto;
    }
    
    .sidebar.collapsed .logo h1 span,
    .sidebar.collapsed .logo p,
    .sidebar.collapsed .nav-section-title,
    .sidebar.collapsed .nav-item-text,
    .sidebar.collapsed .user-info .name,
    .sidebar.collapsed .user-info .role,
    .sidebar.collapsed .logout-btn span,
    .sidebar.collapsed .settings-panel {
      display: none;
    }
    
    .sidebar.collapsed .logo {
      padding: 16px 12px;
    }
    
    .sidebar.collapsed .logo h1 {
      justify-content: center;
    }
    
    .sidebar.collapsed .logo-icon {
      width: 40px;
      height: 40px;
      font-size: 22px;
    }
    
    .sidebar.collapsed .nav-item {
      justify-content: center;
      padding: 12px;
      margin: 2px 6px;
      width: calc(100% - 12px);
    }
    
    .sidebar.collapsed .nav-item .icon {
      margin: 0;
      font-size: 18px;
    }
    .sidebar.collapsed .nav-item .icon svg {
      width: 22px;
      height: 22px;
    }
    
    .sidebar.collapsed .user-info {
      padding: 12px;
    }
    
    .sidebar.collapsed .user-info-content {
      justify-content: center;
    }
    
    .sidebar.collapsed .user-avatar {
      width: 36px;
      height: 36px;
    }
    
    .sidebar.collapsed .logout-btn {
      padding: 10px;
      font-size: 16px;
      justify-content: center;
    }
    
    /* Fixed position tooltip for collapsed sidebar */
    .nav-tooltip {
      position: fixed;
      background: #1e293b;
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      z-index: 9999;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s ease;
    }
    
    .nav-tooltip.visible {
      opacity: 1;
    }
    
    .nav-tooltip::before {
      content: '';
      position: absolute;
      left: -6px;
      top: 50%;
      transform: translateY(-50%);
      border: 6px solid transparent;
      border-right-color: #1e293b;
    }
    
    .sidebar-toggle {
      position: absolute;
      top: 20px;
      right: 12px;
      width: 28px;
      height: 28px;
      background: var(--primary);
      border: 2px solid var(--bg-secondary);
      border-radius: 50%;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      z-index: 101;
      transition: var(--transition);
      box-shadow: var(--shadow);
    }
    
    .sidebar-toggle:hover {
      background: var(--primary-hover);
      transform: scale(1.1);
    }
    
    .sidebar.collapsed .sidebar-toggle {
      top: 70px;
      right: 50%;
      transform: translateX(50%) rotate(180deg);
    }
    
    .sidebar.collapsed .sidebar-toggle:hover {
      transform: translateX(50%) rotate(180deg) scale(1.1);
    }
    
    .logo {
      padding: 24px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }
    .logo h1 {
      font-family: var(--font-display);
      font-size: 1.375rem;
      font-weight: 700;
      letter-spacing: -0.03em;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--gradient-primary);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.25);
    }
    .logo p {
      font-family: var(--font-mono);
      font-size: 10px;
      color: rgba(255,255,255,0.4);
      margin-top: 4px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.15em;
    }
    
    .nav-section { padding: 8px 8px 4px; }
    .nav-section:first-child { padding-top: 16px; }
    .nav-section-title {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      color: rgba(255,255,255,0.35);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 16px 16px 8px;
      margin: 0 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.04);
    }
    .nav-section:first-child .nav-section-title {
      border-top: none;
      padding-top: 8px;
    }

    .nav-item {
      position: relative;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      margin: 2px 12px;
      color: rgba(255,255,255,0.6);
      font-family: var(--font-body);
      font-size: var(--text-sm);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      border: none;
      background: none;
      width: calc(100% - 24px);
      text-align: left;
      border-radius: 10px;
      overflow: hidden;
    }
    .nav-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 0;
      background: var(--primary);
      border-radius: 0 3px 3px 0;
      transition: height 0.2s ease;
    }
    .nav-item:hover {
      color: rgba(255,255,255,0.95);
      background: rgba(255,255,255,0.06);
    }
    .nav-item:hover::before {
      height: 40%;
    }
    .nav-item.active {
      color: var(--primary);
      background: rgba(34, 197, 94, 0.12);
      font-weight: 600;
    }
    .nav-item.active::before {
      height: 60%;
      display: block;
    }
    .nav-item .icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
      opacity: 0.85;
    }
    .nav-item:hover .icon,
    .nav-item.active .icon {
      opacity: 1;
    }
    .nav-item .icon svg {
      width: 20px;
      height: 20px;
      stroke: currentColor;
    }
    
    /* Navigation badge for notifications */
    .nav-badge {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: #ef4444;
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .sidebar.collapsed .nav-badge {
      right: 4px;
      top: 4px;
      transform: none;
      padding: 1px 4px;
      font-size: 9px;
      min-width: 14px;
    }
    
    /* Mini Chat Widget */
    .mini-chat-bubble {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary) 0%, #16a34a 100%);
      color: white;
      border: none;
      font-size: 26px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .mini-chat-bubble:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 24px rgba(34, 197, 94, 0.5);
    }
    
    .mini-chat-bubble .badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ef4444;
      color: white;
      font-size: 11px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 20px;
      text-align: center;
    }
    
    .mini-chat-window {
      position: fixed;
      bottom: 100px;
      right: 24px;
      width: 380px;
      height: 500px;
      background: var(--bg-card);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      z-index: 998;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid var(--border);
      animation: slideInUp 0.3s ease;
    }
    
    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .mini-chat-header {
      padding: 16px;
      background: linear-gradient(135deg, var(--primary) 0%, #16a34a 100%);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .mini-chat-header h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }
    
    .mini-chat-header button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .mini-chat-header button:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .mini-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--bg-secondary);
    }
    
    .mini-chat-input-area {
      padding: 12px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
      background: var(--bg-card);
    }
    
    .mini-chat-input-area input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 24px;
      font-size: 14px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .mini-chat-input-area button {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 18px;
    }
    
    @media (max-width: 768px) {
      .mini-chat-bubble {
        bottom: calc(80px + env(safe-area-inset-bottom, 0px));
        right: 16px;
        width: 56px;
        height: 56px;
      }
      
      .mini-chat-window {
        bottom: 0;
        right: 0;
        left: 0;
        width: 100%;
        height: 70vh;
        border-radius: 20px 20px 0 0;
      }
    }
    
    /* Hide mini chat on team_chat page */
    body.on-team-chat .mini-chat-bubble,
    body.on-team-chat .mini-chat-window {
      display: none !important;
    }
    
    /* Submenu toggle button */
    .nav-item.submenu-toggle {
      justify-content: space-between;
    }
    .nav-item-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .nav-arrow {
      font-size: 10px;
      opacity: 0.5;
    }
    
    /* Submenu items */
    .nav-item.nav-subitem {
      padding-left: 44px;
      font-size: 12px;
    }
    
    .main { 
      margin-left: var(--sidebar-width); 
      flex: 1; 
      padding: 18px 24px; 
      min-height: 100vh;
      background: var(--bg-primary);
      overflow: auto;
      box-sizing: border-box;
    }
    
    .main.sidebar-collapsed {
      margin-left: var(--sidebar-collapsed-width);
    }
    
    /* Ensure margin on desktop screens */
    @media (min-width: 769px) {
      .main {
        margin-left: var(--sidebar-width) !important;
      }
      .main.sidebar-collapsed {
        margin-left: var(--sidebar-collapsed-width) !important;
      }
    }
    
    /* ============ USER INFO ============ */
    .user-info { 
      padding: 16px; 
      border-top: 1px solid rgba(255,255,255,0.1);
      margin-top: auto;
    }
    .user-info-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      color: white;
    }
    .user-info .name { font-size: 14px; color: white; font-weight: 600; }
    .user-info .role { 
      font-size: 11px; 
      color: rgba(255,255,255,0.5);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }
    .logout-btn { 
      margin-top: 12px; 
      width: 100%; 
      padding: 10px; 
      background: rgba(239, 68, 68, 0.15);
      border: none;
      color: #f87171;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .logout-btn:hover {
      background: rgba(239, 68, 68, 0.25);
      color: #fca5a5;
    }
    
    /* ============ HEADER ============ */
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 16px; 
      flex-wrap: wrap; 
      gap: 12px;
    }
    .header h2 { 
      font-size: 20px; 
      font-weight: 700; 
      color: var(--text-primary);
      letter-spacing: -0.5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    /* ============ TOPBAR - Adapts to Theme ============ */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }
    
    .topbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .welcome-text {
      font-size: 18px;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .welcome-name {
      color: #22c55e;
      font-weight: 600;
    }
    
    .topbar-center {
      display: flex;
      align-items: center;
      gap: 24px;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .world-clock {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding: 6px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      min-width: 80px;
    }
    
    .clock-city {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 500;
    }
    
    .clock-time {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    }
    
    .topbar {
      position: relative;
    }
    
    @media (max-width: 1100px) {
      .topbar-center {
        display: none;
      }
    }
    
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .topbar-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-secondary);
    }
    
    .topbar-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--primary);
      color: var(--primary);
    }
    
    /* Empty State - Lovable style */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
    }
    .empty-state-icon {
      font-size: 48px;
      color: var(--text-muted);
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    .empty-state-text {
      font-size: 14px;
      color: var(--text-muted);
      max-width: 300px;
    }
    
    .topbar-btn-text {
      font-size: 12px;
      font-weight: 500;
    }
    
    .notification-btn {
      position: relative;
    }
    
    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 18px;
      height: 18px;
      background: #ef4444;
      color: white;
      font-size: 10px;
      font-weight: 600;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }
    
    .notification-wrapper {
      position: relative;
    }
    
    .notification-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      width: 360px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      margin-top: 8px;
      z-index: 1000;
      display: none;
      max-height: 480px;
      overflow: hidden;
    }
    
    .notification-dropdown.open {
      display: block;
    }
    
    .notification-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .notification-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .notification-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    
    .notification-item:hover {
      background: var(--bg-hover);
    }
    
    .notification-item.unread {
      background: var(--primary-light);
    }
    
    .notification-item.unread:hover {
      background: var(--bg-hover);
    }
    
    .notification-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    
    .notification-content {
      flex: 1;
      min-width: 0;
    }
    
    .notification-title {
      font-weight: 500;
      margin-bottom: 2px;
      color: var(--text-primary);
    }
    
    .notification-message {
      font-size: 13px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .notification-time {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    .topbar-user {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 12px 6px 6px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 30px;
      margin-left: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .topbar-user:hover {
      background: var(--bg-tertiary);
      border-color: var(--primary);
    }
    
    .topbar-user-wrapper {
      position: relative;
    }
    
    .topbar-user-arrow {
      font-size: 10px;
      color: var(--text-muted);
      margin-left: 4px;
      transition: transform 0.2s;
    }
    
    .topbar-user-wrapper.open .topbar-user-arrow {
      transform: rotate(180deg);
    }
    
    .topbar-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 220px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s;
      z-index: 1000;
    }
    
    .topbar-user-wrapper.open .topbar-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .topbar-dropdown-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
    }
    
    .topbar-dropdown-avatar {
      width: 40px;
      height: 40px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      color: white;
    }
    
    .topbar-dropdown-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .topbar-dropdown-email {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .topbar-dropdown-divider {
      height: 1px;
      background: var(--border);
      margin: 0 12px;
    }
    
    .topbar-dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 12px 16px;
      background: none;
      border: none;
      font-size: 14px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
      text-align: left;
    }
    
    .topbar-dropdown-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }
    
    .topbar-dropdown-item:first-of-type {
      border-radius: 0;
    }
    
    .topbar-dropdown-item:last-child {
      border-radius: 0 0 12px 12px;
    }
    
    .topbar-dropdown-item.logout {
      color: var(--danger);
    }
    
    .topbar-dropdown-item.logout:hover {
      background: var(--danger-light);
      color: var(--danger);
    }
    
    .topbar-avatar {
      width: 32px;
      height: 32px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
      color: white;
    }
    
    .topbar-user-info {
      display: none;
    }
    
    @media (min-width: 768px) {
      .topbar-user-info {
        display: block;
      }
      .topbar-user-name {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
      }
      .topbar-user-role {
        font-size: 11px;
        color: var(--text-muted);
      }
    }
    
    /* ============ SEARCH BOX ============ */
    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      min-width: 240px;
    }
    .search-box input {
      border: none;
      background: none;
      outline: none;
      font-size: 13px;
      color: var(--text-primary);
      width: 100%;
    }
    .search-box input::placeholder {
      color: var(--text-muted);
    }
    .search-box:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }
    
    /* ============ BUTTONS - Lovable Style ============ */
    .btn { 
      padding: 8px 14px; 
      border-radius: 6px;
      border: none; 
      cursor: pointer; 
      font-size: 13px; 
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: inherit;
    }
    .btn-primary { 
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover { 
      background: var(--primary-hover);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }
    .btn-secondary { 
      background: var(--bg-secondary);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover {
      background: var(--bg-tertiary);
    }
    .btn-sm { padding: 8px 14px; font-size: 13px; }
    .btn-icon {
      width: 40px;
      height: 40px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }
    .btn-icon:hover {
      background: var(--bg-tertiary);
    }
    
    /* Assign to trip button - Lovable style */
    .btn-assign {
      color: var(--primary);
      background: none;
      border: none;
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-assign:hover {
      text-decoration: underline;
    }
    
    /* ============ STATS CARDS - Adapts to Theme ============ */
    .stats-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
      gap: 12px; 
      margin-bottom: 16px;
    }
    .stat-card { 
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: 14px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      border: 1px solid var(--border);
      position: relative;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .stat-card:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow-md);
    }
    .stat-card .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    .stat-card .stat-icon.green { background: var(--success-light); color: var(--success); }
    .stat-card .stat-icon.orange { background: var(--warning-light); color: var(--warning); }
    .stat-card .stat-icon.red { background: var(--danger-light); color: var(--danger); }
    .stat-card .stat-icon.blue { background: var(--info-light); color: var(--info); }
    .stat-card .stat-content {
      flex: 1;
    }
    .stat-card .label { 
      font-size: 11px; 
      color: var(--text-muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .stat-card .value { 
      font-size: 22px; 
      font-weight: 700; 
      color: var(--text-primary);
      letter-spacing: -0.5px;
      line-height: 1.2;
    }
    .stat-card .value.green { color: var(--success); }
    .stat-card .value.red { color: var(--danger); }
    .stat-card .value.orange { color: var(--warning); }
    .stat-card .trend {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    .stat-card .trend.up { color: var(--success); }
    .stat-card .trend.down { color: var(--danger); }
    .stat-card .icon { 
      width: 48px; 
      height: 48px; 
      border-radius: 12px;
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 22px;
      flex-shrink: 0;
    }
    .stat-card .icon.green { background: rgba(16, 185, 129, 0.15); color: var(--success); }
    .stat-card .icon.blue { background: rgba(59, 130, 246, 0.15); color: var(--info); }
    .stat-card .icon.amber { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
    .stat-card .icon.red { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
    
    /* Dashboard Colored Cards - Premium Treatment */
    .dashboard-stat-card {
      background: var(--bg-tertiary);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .dashboard-stat-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(255,255,255,0.04) 0%, rgba(255,255,255,0) 100%);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .dashboard-stat-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-card-hover);
    }
    .dashboard-stat-card:hover::before {
      opacity: 1;
    }
    .dashboard-stat-card .stat-label {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dashboard-stat-card .stat-value {
      font-family: var(--font-mono);
      font-size: var(--text-2xl);
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    .dashboard-stat-card .stat-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      font-family: var(--font-mono);
      font-size: 9px;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Revenue card - green glow accent */
    .dashboard-stat-card.revenue {
      background:
        radial-gradient(ellipse at top right, rgba(34, 197, 94, 0.12) 0%, transparent 50%),
        var(--bg-tertiary);
      border-color: rgba(34, 197, 94, 0.25);
    }
    .dashboard-stat-card.revenue .stat-value {
      color: var(--primary);
      text-shadow: 0 0 25px rgba(34, 197, 94, 0.3);
    }
    .dashboard-stat-card.revenue .stat-icon { color: var(--primary); }

    /* Deductions card - orange glow accent */
    .dashboard-stat-card.deductions {
      background:
        radial-gradient(ellipse at top right, rgba(245, 158, 11, 0.1) 0%, transparent 50%),
        var(--bg-tertiary);
      border-color: rgba(245, 158, 11, 0.2);
    }
    .dashboard-stat-card.deductions .stat-value { color: var(--warning); }
    .dashboard-stat-card.deductions .stat-icon { color: var(--warning); }

    /* Costs card - neutral with subtle accent */
    .dashboard-stat-card.costs {
      background: var(--bg-tertiary);
    }
    .dashboard-stat-card.costs .stat-value { color: var(--text-primary); }

    /* Profit card - green or red based on value */
    .dashboard-stat-card.profit {
      background:
        radial-gradient(ellipse at top right, rgba(34, 197, 94, 0.12) 0%, transparent 50%),
        var(--bg-tertiary);
      border-color: rgba(34, 197, 94, 0.2);
    }
    .dashboard-stat-card.profit .stat-value {
      color: var(--primary);
      text-shadow: 0 0 25px rgba(34, 197, 94, 0.3);
    }
    .dashboard-stat-card.profit.negative {
      background:
        radial-gradient(ellipse at top right, rgba(239, 68, 68, 0.1) 0%, transparent 50%),
        var(--bg-tertiary);
      border-color: rgba(239, 68, 68, 0.2);
    }
    .dashboard-stat-card.profit.negative .stat-value {
      color: var(--danger);
      text-shadow: 0 0 20px rgba(239, 68, 68, 0.25);
    }
    
    /* Mini stat cards row */
    .mini-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .mini-stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      text-align: center;
    }
    .mini-stat-card .mini-icon {
      font-size: 20px;
      margin-bottom: 8px;
      color: var(--text-muted);
    }
    .mini-stat-card .mini-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    .mini-stat-card .mini-label {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    /* Direction Tabs for Future Cars */
    .direction-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }
    .direction-tab {
      padding: 8px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .direction-tab:hover {
      background: var(--bg-tertiary);
      border-color: var(--text-muted);
    }
    .direction-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .direction-tab.orange {
      background: var(--warning-light);
      border-color: var(--warning);
      color: var(--warning);
    }
    .direction-tab.orange.active {
      background: var(--warning);
      color: white;
    }
    .direction-tab.red {
      background: var(--danger-light);
      border-color: var(--danger);
      color: var(--danger);
    }
    .direction-tab.red.active {
      background: var(--danger);
      color: white;
    }
    
    /* Table section header - like Future Cars "NY to Home" header */
    .table-section-header {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      padding: 12px 16px;
      font-weight: 600;
      font-size: 14px;
      border-radius: var(--radius) var(--radius) 0 0;
    }
    
    /* Toggle switch */
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--bg-tertiary);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid var(--border);
    }
    .toggle-switch.active {
      background: var(--primary);
      border-color: var(--primary);
    }
    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s;
    }
    .toggle-switch.active::after {
      left: 22px;
    }
    
    /* Remove old colored headers */
    .stat-card.green-header,
    .stat-card.blue-header,
    .stat-card.amber-header,
    .stat-card.red-header {
      border-left: none;
    }
    
    /* ============ CARDS - Adapts to Theme ============ */
    .card { 
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      overflow: hidden; 
      margin-bottom: 14px;
      border: 1px solid var(--border);
    }
    .card > .table-wrapper,
    .card > div > .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .card-header { 
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      background: transparent;
    }
    .card-header h3 { 
      font-size: 14px; 
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-header h3 .icon {
      font-size: 16px;
    }
    .card-body {
      padding: 0;
    }
    
    /* Metric card style */
    .metric-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .metric-card .metric-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .metric-card .metric-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }
    .metric-card .metric-value.green { color: var(--success); }
    .metric-card .metric-value.red { color: var(--danger); }
    .metric-card .metric-value.orange { color: var(--warning); }
    
    /* Page header - Lovable style */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .page-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .page-title .icon {
      font-size: 24px;
    }
    
    .page-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    /* Search input - Lovable dark style */
    .search-input-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      min-width: 200px;
    }
    
    .search-input-wrap input {
      border: none;
      background: none;
      outline: none;
      font-size: 14px;
      color: var(--text-primary);
      width: 100%;
    }
    
    .search-input-wrap input::placeholder {
      color: var(--text-muted);
    }
    
    /* Icon buttons - filter, download */
    .icon-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-secondary);
    }
    
    .icon-btn:hover {
      background: var(--bg-hover);
      border-color: var(--primary);
      color: var(--primary);
    }
    
    /* ============ TRUCK TABS - Adapts to Theme ============ */
    .truck-tabs-container {
      display: flex !important;
      flex-wrap: nowrap !important;
      overflow-x: scroll !important;
      overflow-y: hidden !important;
      white-space: nowrap !important;
      margin-bottom: 0;
      padding-bottom: 10px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: var(--border) var(--bg-tertiary);
      max-width: 100%;
      width: 100%;
      position: relative;
      gap: 8px;
    }
    
    .truck-tabs-container::-webkit-scrollbar {
      height: 6px;
      display: block !important;
    }
    
    .truck-tabs-container::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }
    
    .truck-tabs-container::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
      min-width: 40px;
    }
    
    .truck-tabs-container::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }
    
    .truck-tabs-container button,
    .truck-tabs-container .truck-tab,
    .truck-tab {
      flex-shrink: 0 !important;
      flex-grow: 0 !important;
      white-space: nowrap !important;
      background: var(--bg-secondary) !important;
      border: 1px solid var(--border) !important;
      color: var(--text-secondary) !important;
      padding: 12px 20px !important;
      border-radius: 10px !important;
      font-weight: 700 !important;
      font-size: 15px !important;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .truck-tabs-container button:hover,
    .truck-tab:hover {
      background: var(--bg-tertiary) !important;
      border-color: var(--primary) !important;
    }
    
    .truck-tabs-container button.active,
    .truck-tab.active {
      background: var(--primary) !important;
      border-color: var(--primary) !important;
      color: white !important;
    }
    
    /* ============ TABLE - Adapts to Theme ============ */
    .table-wrapper { 
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: var(--radius);
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      min-width: 600px;
    }
    th {
      text-align: left; 
      padding: 14px 16px;
      background: var(--bg-tertiary);
      font-size: 12px; 
      font-weight: 600; 
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
    }
    th:first-child {
      border-radius: var(--radius) 0 0 0;
    }
    th:last-child {
      border-radius: 0 var(--radius) 0 0;
    }
    td { 
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 14px; 
      color: var(--text-secondary);
      vertical-align: middle;
      background: var(--bg-secondary);
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { 
      background: var(--bg-tertiary);
    }
    td strong {
      color: var(--text-primary);
      font-weight: 600;
    }
    td.money {
      font-weight: 600;
      color: var(--success);
    }
    
    /* Row numbers in green */
    .row-number {
      color: var(--primary);
      font-weight: 600;
    }
    
    /* Action icons */
    .action-icons {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .action-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-muted);
      background: transparent;
      border: none;
    }
    .action-icon:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    .action-icon.danger:hover {
      background: var(--danger-light);
      color: var(--danger);
    }
    .action-icon svg {
      width: 18px;
      height: 18px;
    }
    
    /* Avatar in tables */
    .table-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    .table-user {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .table-user-info {
      display: flex;
      flex-direction: column;
    }
    
    .table-user-name {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .table-user-email {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    /* ============ BADGES - Lovable Style ============ */
    .badge { 
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-green { background: #dcfce7; color: #15803d; }
    .badge-amber { background: transparent; border: 1px solid #f59e0b; color: #f59e0b; }
    .badge-blue { background: transparent; border: 1px solid #3b82f6; color: #3b82f6; }
    .badge-red { background: transparent; border: 1px solid #ef4444; color: #ef4444; }
    .badge-gray { background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted); }
    .badge-purple { background: #f3e8ff; color: #7c3aed; }
    
    /* Payment type badges - filled gray */
    .badge-payment {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-weight: 600;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 6px;
    }
    
    /* Category badges - outlined with colors */
    .badge-category {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge-category.dealer { background: var(--success-light); border: 1px solid var(--success); color: var(--success); }
    .badge-category.auction { background: var(--warning-light); border: 1px solid var(--warning); color: var(--warning); }
    .badge-category.private { background: rgba(139, 92, 246, 0.15); border: 1px solid #8b5cf6; color: #8b5cf6; }
    
    /* Status badges - Lovable dark style */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-badge.success { background: var(--success-light); color: var(--success); }
    .status-badge.warning { background: var(--warning-light); color: var(--warning); }
    .status-badge.danger { background: var(--danger-light); color: var(--danger); }
    .status-badge.info { background: var(--info-light); color: var(--info); }
    
    /* ============ MODALS ============ */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

    .modal {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      width: 100%;
      max-width: 560px;
      max-height: 90vh;
      overflow-y: auto;
      transition: var(--transition);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      animation: slideUp 0.3s ease;
      border: 1px solid var(--border);
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: var(--bg-secondary);
      z-index: 10;
    }
    .modal-header h3 {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    .modal-close {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      width: 32px;
      height: 32px;
      border-radius: 8px;
      font-size: 18px;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    .modal-close:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: #ef4444;
      color: #ef4444;
    }
    .modal-body {
      padding: 24px;
      background: var(--bg-secondary);
      color: var(--text-primary);
    }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      background: var(--bg-tertiary);
    }

    /* Override inline purple modal headers */
    .modal-header[style*="background:#8b5cf6"],
    .modal-header[style*="background:#a855f7"],
    .modal-header[style*="background: #8b5cf6"],
    .modal-header[style*="background: #a855f7"] {
      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%) !important;
    }

    /* ============ DARK THEME INLINE STYLE OVERRIDES ============ */
    /* Scoped to dark theme only - catches hardcoded light backgrounds */
    body.dark-theme [style*="background:#dbeafe"],
    body.dark-theme [style*="background: #dbeafe"] {
      background: rgba(59, 130, 246, 0.15) !important;
    }
    body.dark-theme [style*="background:#d1fae5"],
    body.dark-theme [style*="background: #d1fae5"] {
      background: rgba(34, 197, 94, 0.15) !important;
    }
    body.dark-theme [style*="background:#fef3c7"],
    body.dark-theme [style*="background: #fef3c7"] {
      background: rgba(245, 158, 11, 0.15) !important;
    }
    body.dark-theme [style*="background:#e2e8f0"],
    body.dark-theme [style*="background: #e2e8f0"] {
      background: rgba(255, 255, 255, 0.1) !important;
    }
    body.dark-theme [style*="background:#f1f5f9"],
    body.dark-theme [style*="background: #f1f5f9"] {
      background: rgba(255, 255, 255, 0.05) !important;
    }
    body.dark-theme [style*="background:white"],
    body.dark-theme [style*="background: white"],
    body.dark-theme [style*="background:#ffffff"],
    body.dark-theme [style*="background: #ffffff"],
    body.dark-theme [style*="background:#fff"],
    body.dark-theme [style*="background: #fff"] {
      background: var(--bg-secondary) !important;
    }
    /* Fix light gray backgrounds in dark theme */
    body.dark-theme [style*="background:#f8fafc"],
    body.dark-theme [style*="background: #f8fafc"],
    body.dark-theme [style*="background:#f3f4f6"],
    body.dark-theme [style*="background: #f3f4f6"] {
      background: rgba(255, 255, 255, 0.03) !important;
    }

    /* ============ FORMS - Lovable Dark Style ============ */
    .form-group { margin-bottom: 20px; }
    .form-group label { 
      display: block; 
      font-size: 13px; 
      font-weight: 600; 
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .form-group input, .form-group select, .form-group textarea { 
      width: 100%; 
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 14px;
      font-family: inherit;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      transition: var(--transition);
    }
    .form-group input:hover, .form-group select:hover, .form-group textarea:hover {
      border-color: var(--text-muted);
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
      outline: none; 
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }
    .form-group input::placeholder, .form-group textarea::placeholder {
      color: var(--text-muted);
    }
    .form-group select option {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    
    /* ============ ACTIONS ============ */
    .money { font-weight: 600; font-variant-numeric: tabular-nums; }
    .money.positive { color: var(--success); }
    .money.negative { color: var(--danger); }
    
    .actions { display: flex; gap: 8px; }
    .action-btn { 
      padding: 8px 12px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .action-btn.view { background: var(--success-light); color: var(--success); }
    .action-btn.view:hover { background: rgba(16, 185, 129, 0.25); }
    .action-btn.edit { background: var(--info-light); color: var(--info); }
    .action-btn.edit:hover { background: rgba(59, 130, 246, 0.25); }
    .action-btn.delete { background: var(--danger-light); color: var(--danger); }
    .action-btn.delete:hover { background: rgba(239, 68, 68, 0.25); }
    
    /* ============ TOAST ============ */
    .toast { 
      position: fixed; 
      bottom: 24px; 
      right: 24px; 
      padding: 16px 24px;
      border-radius: var(--radius);
      color: white; 
      font-size: 14px; 
      font-weight: 500;
      z-index: 2000;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideUp 0.3s ease;
    }
    .toast.success { background: linear-gradient(135deg, var(--success) 0%, #059669 100%); }
    .toast.error { background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%); }
    
    /* ============ LOGIN PAGE - Command Center Aesthetic ============ */
    /* Typography imports */
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Geist+Mono:wght@400;500;600&display=swap');

    .login-container {
      min-height: 100vh;
      background: #030808;
      position: relative;
      overflow: hidden;
      font-family: 'Outfit', sans-serif;
    }

    /* Gradient overlay - deeper, more dramatic */
    .login-container::before {
      content: '';
      position: absolute;
      inset: 0;
      background:
        radial-gradient(ellipse at 15% 25%, rgba(34, 197, 94, 0.15) 0%, transparent 45%),
        radial-gradient(ellipse at 85% 75%, rgba(34, 197, 94, 0.08) 0%, transparent 45%),
        radial-gradient(ellipse at 50% 100%, rgba(34, 197, 94, 0.05) 0%, transparent 50%);
      pointer-events: none;
    }

    /* Technical grid overlay */
    .login-container::after {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(34, 197, 94, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(34, 197, 94, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
    }

    /* Rain Particles Container */
    .login-particles {
      position: absolute;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
    }

    /* Individual Rain Particle - Data stream effect */
    .login-particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: #22c55e;
      border-radius: 50%;
      opacity: 0;
      box-shadow: 0 0 6px #22c55e, 0 0 12px rgba(34,197,94,0.4);
      animation: particleRain linear infinite;
    }

    @keyframes particleRain {
      0% { transform: translateY(-10px); opacity: 0; }
      5% { opacity: 0.8; }
      50% { opacity: 0.5; transform: translateY(50vh); }
      95% { opacity: 0.2; }
      100% { transform: translateY(105vh); opacity: 0; }
    }

    /* Particle distribution - 30 particles */
    .login-particle:nth-child(1) { left: 3%; animation-duration: 18s; animation-delay: 0s; }
    .login-particle:nth-child(2) { left: 8%; animation-duration: 22s; animation-delay: 1.2s; width: 3px; height: 3px; }
    .login-particle:nth-child(3) { left: 13%; animation-duration: 20s; animation-delay: 2.5s; }
    .login-particle:nth-child(4) { left: 18%; animation-duration: 25s; animation-delay: 0.8s; width: 3px; height: 3px; }
    .login-particle:nth-child(5) { left: 23%; animation-duration: 19s; animation-delay: 3.2s; }
    .login-particle:nth-child(6) { left: 28%; animation-duration: 23s; animation-delay: 1.5s; }
    .login-particle:nth-child(7) { left: 33%; animation-duration: 21s; animation-delay: 4.0s; width: 3px; height: 3px; }
    .login-particle:nth-child(8) { left: 38%; animation-duration: 24s; animation-delay: 0.3s; }
    .login-particle:nth-child(9) { left: 43%; animation-duration: 20s; animation-delay: 2.8s; }
    .login-particle:nth-child(10) { left: 48%; animation-duration: 26s; animation-delay: 1.8s; width: 3px; height: 3px; }
    .login-particle:nth-child(11) { left: 53%; animation-duration: 22s; animation-delay: 3.5s; }
    .login-particle:nth-child(12) { left: 58%; animation-duration: 19s; animation-delay: 0.5s; }
    .login-particle:nth-child(13) { left: 63%; animation-duration: 24s; animation-delay: 2.2s; width: 3px; height: 3px; }
    .login-particle:nth-child(14) { left: 68%; animation-duration: 21s; animation-delay: 4.5s; }
    .login-particle:nth-child(15) { left: 73%; animation-duration: 25s; animation-delay: 1.0s; }
    .login-particle:nth-child(16) { left: 78%; animation-duration: 20s; animation-delay: 3.8s; width: 3px; height: 3px; }
    .login-particle:nth-child(17) { left: 83%; animation-duration: 23s; animation-delay: 0.7s; }
    .login-particle:nth-child(18) { left: 88%; animation-duration: 18s; animation-delay: 2.0s; }
    .login-particle:nth-child(19) { left: 93%; animation-duration: 26s; animation-delay: 4.2s; width: 3px; height: 3px; }
    .login-particle:nth-child(20) { left: 97%; animation-duration: 21s; animation-delay: 1.3s; }
    .login-particle:nth-child(21) { left: 5%; animation-duration: 24s; animation-delay: 5.5s; }
    .login-particle:nth-child(22) { left: 15%; animation-duration: 19s; animation-delay: 6.2s; width: 3px; height: 3px; }
    .login-particle:nth-child(23) { left: 25%; animation-duration: 22s; animation-delay: 7.0s; }
    .login-particle:nth-child(24) { left: 35%; animation-duration: 25s; animation-delay: 5.8s; }
    .login-particle:nth-child(25) { left: 45%; animation-duration: 20s; animation-delay: 6.5s; width: 3px; height: 3px; }
    .login-particle:nth-child(26) { left: 55%; animation-duration: 23s; animation-delay: 7.5s; }
    .login-particle:nth-child(27) { left: 65%; animation-duration: 18s; animation-delay: 5.2s; }
    .login-particle:nth-child(28) { left: 75%; animation-duration: 26s; animation-delay: 6.8s; width: 3px; height: 3px; }
    .login-particle:nth-child(29) { left: 85%; animation-duration: 21s; animation-delay: 7.2s; }
    .login-particle:nth-child(30) { left: 95%; animation-duration: 24s; animation-delay: 5.0s; }
    
    /* Navigation Bar */
    .login-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 60px;
      position: relative;
      z-index: 10;
    }

    .login-nav-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: var(--font-display, 'Space Grotesk', sans-serif);
      font-size: 22px;
      font-weight: 700;
      color: white;
    }

    .login-nav-logo-icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
    }
    
    .login-nav-links {
      display: flex;
      align-items: center;
      gap: 32px;
    }
    
    .login-nav-links a {
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: color 0.2s;
    }
    
    .login-nav-links a:hover {
      color: white;
    }
    
    .login-nav-buttons {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .login-nav-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    
    .login-nav-btn.register {
      background: #3b82f6;
      color: white;
    }
    
    .login-nav-btn.register:hover {
      background: #2563eb;
    }
    
    .login-nav-btn.login {
      background: white;
      color: #1e293b;
    }
    
    .login-nav-btn.login:hover {
      background: #f1f5f9;
    }
    
    .login-nav-lang {
      color: rgba(255,255,255,0.8);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* Hero Section */
    .login-hero {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 40px 60px 80px;
      gap: 60px;
      min-height: calc(100vh - 100px);
    }
    
    .login-hero-content {
      flex: 1;
      max-width: 600px;
    }
    
    .login-hero h1 {
      font-size: 52px;
      font-weight: 700;
      color: white;
      line-height: 1.15;
      margin-bottom: 20px;
      letter-spacing: -1px;
    }
    
    .login-hero h1 span {
      color: #60a5fa;
    }
    
    .login-hero-subtitle {
      font-size: 18px;
      color: rgba(255,255,255,0.75);
      margin-bottom: 40px;
      line-height: 1.6;
    }
    
    /* Feature cards grid - 5 cards */
    .login-features {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 40px;
      max-width: 560px;
    }

    .login-feature {
      background: rgba(34, 197, 94, 0.08);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 14px;
      padding: 16px 14px;
      width: calc(33.333% - 8px);
      min-width: 100px;
      transition: all 0.3s ease;
      cursor: pointer;
      text-align: center;
    }

    .login-feature:nth-child(4),
    .login-feature:nth-child(5) {
      width: calc(50% - 6px);
    }

    .login-feature:hover {
      background: rgba(34, 197, 94, 0.18);
      border-color: rgba(34, 197, 94, 0.4);
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(34, 197, 94, 0.15);
    }

    .login-feature-icon {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .login-feature-title {
      font-size: 12px;
      font-weight: 700;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .login-feature-subtitle {
      font-size: 11px;
      color: #22c55e;
      font-weight: 600;
      text-transform: uppercase;
      margin-top: 2px;
    }
    
    /* Embedded Auth Form - Premium Dark Card */
    .login-form-card {
      position: relative;
      z-index: 1;
      width: 420px;
      min-width: 400px;
      background: #0a1014;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 24px;
      padding: 48px;
      box-shadow:
        0 25px 50px -12px rgba(0, 0, 0, 0.5),
        0 0 80px rgba(34, 197, 94, 0.08);
    }

    .login-form-card h2 {
      font-family: var(--font-display, 'Space Grotesk', sans-serif);
      font-size: 2rem;
      font-weight: 700;
      color: #f0f4f8;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .login-form-card .subtitle {
      font-family: var(--font-mono, 'JetBrains Mono', monospace);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: #6b7280;
      margin-bottom: 32px;
    }

    .login-form-card .form-group {
      margin-bottom: 20px;
    }

    .login-form-card .form-group label {
      display: block;
      font-family: var(--font-body, 'IBM Plex Sans', sans-serif);
      font-size: 12px;
      font-weight: 600;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .login-form-card .form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      font-family: var(--font-body, 'IBM Plex Sans', sans-serif);
      font-size: 15px;
      transition: all 0.2s ease;
      background: #1a2835;
      color: #f0f4f8;
    }

    .login-form-card .form-group input:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
      background: #141f2a;
    }

    .login-form-card .form-group input::placeholder {
      color: #6b7280;
    }

    .login-form-card .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .login-form-card .btn-submit {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-family: var(--font-body, 'IBM Plex Sans', sans-serif);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: 8px;
      box-shadow:
        0 1px 2px rgba(0, 0, 0, 0.1),
        0 4px 12px rgba(34, 197, 94, 0.25);
    }

    .login-form-card .btn-submit:hover {
      transform: translateY(-1px);
      box-shadow:
        0 2px 4px rgba(0, 0, 0, 0.1),
        0 8px 20px rgba(34, 197, 94, 0.35);
    }

    .login-form-card .form-footer {
      text-align: center;
      margin-top: 24px;
      font-size: 14px;
      color: #6b7280;
    }

    .login-form-card .form-footer a {
      color: #22c55e;
      font-weight: 600;
      text-decoration: none;
    }

    .login-form-card .form-footer a:hover {
      text-decoration: underline;
    }

    .login-form-card .lang-toggle {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
    }
    
    .login-form-card .lang-btn {
      padding: 8px 16px;
      border: 1px solid #e2e8f0;
      background: white;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .login-form-card .lang-btn:hover {
      background: #f1f5f9;
    }
    
    .login-form-card .lang-btn.active {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .login-error { 
      background: #fee2e2;
      color: #dc2626;
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 13px;
      font-weight: 500;
      display: none;
    }
    
    .login-error.show {
      display: block;
    }
    
    /* Truck decoration */
    .login-truck-decoration {
      position: absolute;
      bottom: 30px;
      right: 60px;
      font-size: 100px;
      opacity: 0.15;
    }
    
    /* Route line decoration */
    .login-route-line {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0.3;
    }
    
    /* Footer */
    .login-footer-bar {
      display: flex;
      justify-content: center;
      gap: 24px;
      padding: 24px;
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
    }
    
    .login-footer-bar a {
      color: rgba(255,255,255,0.6);
      font-size: 20px;
      text-decoration: none;
      transition: color 0.2s;
    }
    
    .login-footer-bar a:hover {
      color: white;
    }
    
    /* Dark theme */
    body.dark-theme .login-form-card {
      background: #1e293b;
    }
    
    body.dark-theme .login-form-card h2 {
      color: #f8fafc;
    }
    
    body.dark-theme .login-form-card .subtitle {
      color: #94a3b8;
    }
    
    body.dark-theme .login-form-card .form-group label {
      color: #cbd5e1;
    }
    
    body.dark-theme .login-form-card .form-group input {
      background: #334155;
      border-color: #475569;
      color: #f8fafc;
    }
    
    body.dark-theme .login-form-card .lang-btn {
      background: #334155;
      border-color: #475569;
      color: #cbd5e1;
    }
    
    /* Mobile responsive */
    @media (max-width: 1024px) {
      .login-nav {
        padding: 16px 24px;
      }
      
      .login-nav-links {
        display: none;
      }
      
      .login-hero {
        flex-direction: column;
        padding: 30px 24px 60px;
        gap: 40px;
        text-align: center;
      }
      
      .login-hero-content {
        max-width: 100%;
      }
      
      .login-hero h1 {
        font-size: 36px;
      }
      
      .login-hero-subtitle {
        font-size: 16px;
        margin-bottom: 24px;
      }
      
      .login-features {
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 24px;
        max-width: 100%;
      }

      .login-feature {
        width: calc(33.333% - 8px);
        min-width: 90px;
        padding: 14px 10px;
      }

      .login-feature:nth-child(4),
      .login-feature:nth-child(5) {
        width: calc(50% - 6px);
      }
      
      .login-form-card {
        width: 100%;
        min-width: auto;
        max-width: 400px;
      }
      
      .login-truck-decoration {
        display: none;
      }
    }
    
    @media (max-width: 600px) {
      .login-hero h1 {
        font-size: 24px;
      }

      .login-hero-subtitle {
        font-size: 14px;
      }

      .login-features {
        gap: 8px;
        margin-top: 20px;
      }

      .login-feature {
        width: calc(33.333% - 6px);
        min-width: 80px;
        padding: 10px 6px;
      }

      .login-feature:nth-child(4),
      .login-feature:nth-child(5) {
        width: calc(50% - 4px);
      }

      .login-feature-icon {
        font-size: 22px;
        margin-bottom: 6px;
      }

      .login-feature-title {
        font-size: 10px;
      }

      .login-feature-subtitle {
        font-size: 9px;
      }

      .login-form-card {
        padding: 28px 24px;
      }

      .login-nav-btn.register {
        display: none;
      }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
      border-radius: var(--radius-sm);
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
    
    /* ============ LOADING ============ */
    .loading { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      padding: 60px;
      color: var(--text-muted);
      font-weight: 500;
    }
    .spinner { 
      width: 28px; 
      height: 28px; 
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%; 
      animation: spin 0.8s linear infinite;
      margin-right: 14px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* ============ DRIVER CARDS ============ */
    .drivers-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
      gap: 24px;
    }
    /* ============ DRIVER CARDS - Adapts to Theme ============ */
    .driver-card { 
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      border: 1px solid var(--border);
    }
    .driver-card:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow-lg);
    }
    .driver-avatar { 
      width: 48px; 
      height: 48px; 
      border-radius: 50%;
      background: var(--primary);
      color: white; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-weight: 600;
      font-size: 16px;
    }
    .driver-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .driver-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .driver-cut {
      font-size: 13px;
      color: var(--text-muted);
    }
    .driver-contact {
      font-size: 13px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }
    .driver-badges {
      display: flex;
      gap: 8px;
      margin: 12px 0;
      flex-wrap: wrap;
    }
    .driver-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 500;
    }
    .driver-badge.qual { background: var(--info-light); color: var(--info); }
    .driver-badge.personal { background: rgba(139, 92, 246, 0.15); color: #a78bfa; }
    .driver-badge.expired { background: var(--danger-light); color: var(--danger); }
    .driver-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      margin-top: 12px;
    }
    .driver-stat {
      text-align: center;
    }
    .driver-stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    .driver-stat-value.green { color: var(--success); }
    .driver-stat-label {
      font-size: 11px;
      color: var(--text-muted);
    }
    .driver-actions {
      display: flex;
      gap: 8px;
    }
    .driver-action-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s;
    }
    .driver-action-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }
    .driver-action-btn.danger:hover {
      background: var(--danger-light);
      color: var(--danger);
    }
    
    /* ============ SETTINGS PANEL ============ */
    .settings-panel {
      padding: 12px;
      border-top: 1px solid var(--border);
    }
    .settings-row {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }
    .settings-btn {
      flex: 1;
      padding: 8px 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: var(--transition);
      font-family: inherit;
    }
    .settings-btn:hover {
      background: var(--primary-light);
      color: var(--primary);
      border-color: var(--primary);
    }
    .settings-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* ============ LIGHT MODE CHAT STYLING ============ */
    .chat-container {
      background: #ffffff;
      border: 1px solid #e2e8f0;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    
    .chat-header {
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      border-bottom: 2px solid #e2e8f0;
    }
    
    .chat-header h2 {
      color: #1e293b;
    }
    
    .chat-messages {
      background: linear-gradient(180deg, #f1f5f9 0%, #e2e8f0 100%);
    }
    
    .chat-input-area {
      background: #ffffff;
      border-top: 2px solid #e2e8f0;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
    }
    
    /* Message bubbles - light mode */
    .chat-msg-other {
      background: #ffffff;
      color: #1e293b;
      border: 1px solid #e2e8f0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .chat-msg-own {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
    }
    
    /* Light mode mini-chat enhancements */
    .mini-chat-messages {
      background: linear-gradient(180deg, #f1f5f9 0%, #e2e8f0 100%);
    }
    
    .mini-chat-window {
      border: 1px solid #e2e8f0;
      box-shadow: 0 10px 50px rgba(0,0,0,0.15);
    }
    
    .mini-chat-input-area input {
      background: #ffffff;
      border: 2px solid #e2e8f0;
    }
    
    .mini-chat-input-area input:focus {
      border-color: #22c55e;
      outline: none;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }
    
    /* Dark mode chat overrides */
    body.dark-theme .chat-container {
      background: var(--bg-card);
    }
    
    body.dark-theme .chat-header {
      background: var(--bg-card);
      border-bottom-color: var(--border);
    }
    
    body.dark-theme .chat-header h2 {
      color: var(--text-primary);
    }
    
    body.dark-theme .chat-messages {
      background: var(--bg-secondary);
    }
    
    body.dark-theme .chat-input-area {
      background: var(--bg-card);
      border-top-color: var(--border);
    }
    
    body.dark-theme .chat-msg-other {
      background: var(--bg-card);
      color: var(--text-primary);
      border-color: var(--border);
    }
    
    /* Chat online status */
    .chat-online-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #22c55e;
      font-size: 13px;
    }
    
    .chat-online-indicator::before {
      content: '';
      width: 8px;
      height: 8px;
      background: #22c55e;
      border-radius: 50%;
      animation: blink 1.5s infinite;
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    /* ============ RESPONSIVE ============ */
    @media (max-width: 1024px) {
      .main { padding: 24px; }
      .stats-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    }
    @media (max-width: 768px) { 
      .sidebar { 
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      .sidebar.mobile-open { transform: translateX(0); }
      .main { margin-left: 0; padding: 20px; }
      .form-row { grid-template-columns: 1fr; }
      .header h2 { font-size: 22px; }
      .stat-card .value { font-size: 26px; }
    }
    
    /* ============ DARK THEME - Lovable Style ============ */
    body.dark-theme { 
      --bg-primary: #0c1520;
      --bg-secondary: #111c2a;
      --bg-tertiary: #1a2735;
      --bg-card: #151f2c;
      --bg-hover: #1e2d3d;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #94a3b8;
      --border: #1e3a4a;
      --border-light: #1a2f3d;
      --primary-light: rgba(16, 185, 129, 0.15);
      --success-light: rgba(16, 185, 129, 0.15);
      --warning-light: rgba(245, 158, 11, 0.15);
      --danger-light: rgba(239, 68, 68, 0.15);
      --info-light: rgba(59, 130, 246, 0.15);
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
      --shadow: 0 2px 4px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 8px rgba(0,0,0,0.4);
      --shadow-lg: 0 8px 16px rgba(0,0,0,0.4);
      --shadow-xl: 0 16px 32px rgba(0,0,0,0.5);
    }
    body.dark-theme .sidebar { 
      background: var(--bg-secondary);
      border-right-color: var(--border);
    }
    body.dark-theme .sidebar .logo h1 { color: var(--success); }
    body.dark-theme .sidebar .nav-item { color: #e2e8f0; }
    body.dark-theme .sidebar .nav-item:hover { background: var(--bg-hover); color: #ffffff; }
    body.dark-theme .sidebar .nav-item.active { background: var(--primary); color: white; }
    body.dark-theme .sidebar .nav-section-title { color: #94a3b8; }
    body.dark-theme .sidebar .user-info { border-top-color: var(--border); }
    body.dark-theme .sidebar .user-info .name { color: #ffffff; }
    body.dark-theme .sidebar .user-info .role { color: #cbd5e1; }
    body.dark-theme .sidebar .settings-panel { border-top-color: var(--border); }
    body.dark-theme .sidebar .settings-btn { background: var(--bg-tertiary); border-color: var(--border); color: #e2e8f0; }
    body.dark-theme .sidebar .logout-btn { background: var(--danger-light); border: none; color: var(--danger); }
    body.dark-theme .welcome-text { color: #e2e8f0; }
    body.dark-theme .topbar { border-bottom-color: var(--border); }
    body.dark-theme .topbar-btn { background: var(--bg-tertiary); border-color: var(--border); color: #e2e8f0; }
    body.dark-theme .topbar-btn:hover { background: var(--bg-hover); border-color: var(--primary); color: var(--primary); }
    body.dark-theme .topbar-user { background: var(--bg-tertiary); border-color: var(--border); }
    body.dark-theme .topbar-dropdown { background: var(--bg-card); border-color: var(--border); }
    body.dark-theme .topbar-dropdown-item:hover { background: var(--bg-hover); }
    body.dark-theme .topbar-dropdown-item.logout:hover { background: var(--danger-light); }
    body.dark-theme .stat-card,
    body.dark-theme .card,
    body.dark-theme .driver-card,
    body.dark-theme .metric-card { 
      background: var(--bg-card);
      border-color: var(--border);
    }
    body.dark-theme .stat-card:hover,
    body.dark-theme .card:hover,
    body.dark-theme .driver-card:hover { border-color: var(--primary); }
    body.dark-theme .modal { background: var(--bg-card); border: 1px solid var(--border); }
    body.dark-theme .modal-header { background: var(--bg-card); }
    body.dark-theme .modal-overlay { background: rgba(0,0,0,0.7); }
    body.dark-theme .card-header { background: transparent; }
    body.dark-theme th { background: var(--bg-tertiary); }
    body.dark-theme td { background: var(--bg-card); }
    body.dark-theme tr:hover td { background: var(--bg-hover); }
    /* Ensure Actions column (last column) gets dark background with !important */
    body.dark-theme th:last-child { background: var(--bg-tertiary) !important; }
    body.dark-theme td:last-child { background: var(--bg-card) !important; }
    body.dark-theme tr:hover td:last-child { background: var(--bg-hover) !important; }
    body.dark-theme .form-group input,
    body.dark-theme .form-group select,
    body.dark-theme .form-group textarea { 
      background: var(--bg-tertiary);
      border-color: var(--border);
      color: var(--text-primary);
    }
    body.dark-theme .form-group input:focus,
    body.dark-theme .form-group select:focus,
    body.dark-theme .form-group textarea:focus { 
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }
    body.dark-theme .btn-secondary { 
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border-color: var(--border);
    }
    body.dark-theme .btn-secondary:hover {
      background: var(--bg-hover);
      border-color: var(--text-muted);
    }
    body.dark-theme .search-box,
    body.dark-theme .search-input-wrap {
      background: var(--bg-tertiary);
      border-color: var(--border);
    }
    body.dark-theme .search-box input,
    body.dark-theme .search-input-wrap input { color: var(--text-primary); }
    body.dark-theme .icon-btn {
      background: var(--bg-tertiary);
      border-color: var(--border);
    }
    body.dark-theme .icon-btn:hover {
      background: var(--bg-hover);
      border-color: var(--primary);
      color: var(--primary);
    }
    body.dark-theme .action-btn {
      background: var(--bg-hover) !important;
      border: 1px solid var(--border) !important;
    }
    body.dark-theme .action-btn.view {
      background: rgba(16, 185, 129, 0.3) !important;
      color: #4ade80 !important;
      border-color: rgba(16, 185, 129, 0.4) !important;
    }
    body.dark-theme .action-btn.edit {
      background: rgba(59, 130, 246, 0.3) !important;
      color: #60a5fa !important;
      border-color: rgba(59, 130, 246, 0.4) !important;
    }
    body.dark-theme .action-btn.delete {
      background: rgba(239, 68, 68, 0.3) !important;
      color: #f87171 !important;
      border-color: rgba(239, 68, 68, 0.4) !important;
    }
    body.dark-theme .truck-tabs-container button,
    body.dark-theme .truck-tab {
      background: var(--bg-tertiary) !important;
      border-color: var(--border) !important;
      color: var(--text-secondary) !important;
    }
    body.dark-theme .truck-tabs-container button:hover,
    body.dark-theme .truck-tab:hover {
      background: var(--bg-hover) !important;
      border-color: var(--primary) !important;
    }
    body.dark-theme .truck-tabs-container button.active,
    body.dark-theme .truck-tab.active {
      background: var(--primary) !important;
      border-color: var(--primary) !important;
      color: white !important;
    }
    body.dark-theme .direction-tab {
      background: var(--bg-tertiary);
      border-color: var(--border);
      color: var(--text-secondary);
    }
    body.dark-theme .direction-tab:hover {
      background: var(--bg-hover);
    }
    body.dark-theme .direction-tab.active {
      background: var(--primary);
      color: white;
    }
    body.dark-theme .dashboard-stat-card {
      background: var(--bg-card);
      border-color: var(--border);
    }
    body.dark-theme .dashboard-stat-card.revenue {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, var(--bg-card) 100%);
      border-color: rgba(16, 185, 129, 0.3);
    }
    body.dark-theme .dashboard-stat-card.deductions {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, var(--bg-card) 100%);
      border-color: rgba(245, 158, 11, 0.3);
    }
    body.dark-theme .mini-stat-card {
      background: var(--bg-card);
      border-color: var(--border);
    }
    /* Dashboard stat cards - dark theme */
    body.dark-theme .dashboard-stat-card.costs {
      background: var(--bg-card);
      border-color: var(--border);
    }
    body.dark-theme .dashboard-stat-card.profit {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, var(--bg-card) 100%);
      border-color: rgba(34, 197, 94, 0.3);
    }
    body.dark-theme .dashboard-stat-card.profit.negative {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, var(--bg-card) 100%);
      border-color: rgba(239, 68, 68, 0.3);
    }
    /* Task items - dark theme */
    body.dark-theme .task-row,
    body.dark-theme .task-item,
    body.dark-theme [class*="task-"] {
      background: var(--bg-card) !important;
      border-color: var(--border) !important;
    }
    body.dark-theme .task-row:hover,
    body.dark-theme .task-item:hover {
      background: var(--bg-hover) !important;
    }
    /* Table cells - ensure dark background */
    body.dark-theme table {
      background: var(--bg-card);
    }
    body.dark-theme tbody tr {
      background: var(--bg-card);
    }
    body.dark-theme tbody tr:hover {
      background: var(--bg-hover);
    }
    body.dark-theme td {
      background: transparent !important;
      border-color: var(--border);
    }
    body.dark-theme tr:hover td {
      background: transparent !important;
    }
    /* Card body backgrounds */
    body.dark-theme .card-body {
      background: var(--bg-card);
    }
    /* Badges in dark theme */
    body.dark-theme .badge-green { 
      background: rgba(34, 197, 94, 0.2); 
      color: #4ade80; 
      border: 1px solid rgba(34, 197, 94, 0.3); 
    }
    body.dark-theme .badge-amber { 
      background: rgba(245, 158, 11, 0.2); 
      border-color: rgba(245, 158, 11, 0.3); 
      color: #fbbf24; 
    }
    body.dark-theme .badge-blue { 
      background: rgba(59, 130, 246, 0.2); 
      border-color: rgba(59, 130, 246, 0.3); 
      color: #60a5fa; 
    }
    body.dark-theme .badge-red { 
      background: rgba(239, 68, 68, 0.2); 
      border-color: rgba(239, 68, 68, 0.3); 
      color: #f87171; 
    }
    body.dark-theme .badge-gray { 
      background: rgba(148, 163, 184, 0.2); 
      border-color: rgba(148, 163, 184, 0.3); 
      color: #cbd5e1; 
    }
    body.dark-theme .badge-purple { 
      background: rgba(139, 92, 246, 0.2); 
      color: #a78bfa; 
      border: 1px solid rgba(139, 92, 246, 0.3); 
    }
    /* Status badges */
    body.dark-theme .status-badge.success { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    body.dark-theme .status-badge.warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
    body.dark-theme .status-badge.danger { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    body.dark-theme .status-badge.info { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
    /* Payment collection cards */
    body.dark-theme [style*="background: #d"], 
    body.dark-theme [style*="background: #e"],
    body.dark-theme [style*="background: #f"],
    body.dark-theme [style*="background:#d"],
    body.dark-theme [style*="background:#e"],
    body.dark-theme [style*="background:#f"] {
      background: var(--bg-card) !important;
      border: 1px solid var(--border) !important;
    }
    /* Money colors in dark theme */
    body.dark-theme .money.positive,
    body.dark-theme td.money { color: #4ade80; }
    body.dark-theme .money.negative { color: #f87171; }
    /* Expense breakdown bars */
    body.dark-theme .expense-bar {
      background: var(--bg-tertiary);
    }
    /* Top performers cards */
    body.dark-theme .performer-card,
    body.dark-theme [class*="performer"] {
      background: var(--bg-card) !important;
      border-color: var(--border) !important;
    }
    /* KPI cards */
    body.dark-theme .kpi-card {
      background: var(--bg-card);
      border-color: var(--border);
    }
    /* Any remaining light backgrounds */
    body.dark-theme [style*="background: white"],
    body.dark-theme [style*="background:white"],
    body.dark-theme [style*="background: #fff"],
    body.dark-theme [style*="background:#fff"],
    body.dark-theme [style*="background: rgb(255"],
    body.dark-theme [style*="background:rgb(255"] {
      background: var(--bg-card) !important;
    }
    /* Fix text colors in dark mode overridden backgrounds */
    body.dark-theme [style*="background:white"] span,
    body.dark-theme [style*="background: white"] span {
      color: var(--text-primary) !important;
    }
    /* Override ALL light-colored inline backgrounds in dark mode */
    body.dark-theme [style*="background:#d1fae5"],
    body.dark-theme [style*="background: #d1fae5"] {
      background: rgba(34, 197, 94, 0.15) !important;
    }
    body.dark-theme [style*="background:#d1fae5"] div,
    body.dark-theme [style*="background: #d1fae5"] div {
      color: #4ade80 !important;
    }
    body.dark-theme [style*="background:#fee2e2"],
    body.dark-theme [style*="background: #fee2e2"] {
      background: rgba(239, 68, 68, 0.15) !important;
    }
    body.dark-theme [style*="background:#fee2e2"] div,
    body.dark-theme [style*="background: #fee2e2"] div {
      color: #f87171 !important;
    }
    body.dark-theme [style*="background:#f8fafc"],
    body.dark-theme [style*="background: #f8fafc"] {
      background: var(--bg-tertiary) !important;
    }
    body.dark-theme [style*="background:#f8fafc"] div,
    body.dark-theme [style*="background: #f8fafc"] div {
      color: var(--text-primary) !important;
    }
    body.dark-theme [style*="background:#fef3c7"],
    body.dark-theme [style*="background: #fef3c7"] {
      background: rgba(245, 158, 11, 0.15) !important;
    }
    body.dark-theme [style*="background:#fef3c7"] div,
    body.dark-theme [style*="background: #fef3c7"] div {
      color: #fbbf24 !important;
    }
    body.dark-theme [style*="background:#dbeafe"],
    body.dark-theme [style*="background: #dbeafe"] {
      background: rgba(59, 130, 246, 0.15) !important;
    }
    body.dark-theme [style*="background:#dbeafe"] div,
    body.dark-theme [style*="background: #dbeafe"] div {
      color: #60a5fa !important;
    }
    body.dark-theme [style*="background:#ede9fe"],
    body.dark-theme [style*="background: #ede9fe"] {
      background: rgba(139, 92, 246, 0.15) !important;
    }
    body.dark-theme [style*="background:#ede9fe"] div,
    body.dark-theme [style*="background: #ede9fe"] div {
      color: #a78bfa !important;
    }
    body.dark-theme [style*="background:#f1f5f9"],
    body.dark-theme [style*="background: #f1f5f9"] {
      background: var(--bg-tertiary) !important;
    }
    body.dark-theme [style*="background:#f1f5f9"] div,
    body.dark-theme [style*="background: #f1f5f9"] div {
      color: var(--text-secondary) !important;
    }
    body.dark-theme [style*="background:#bbf7d0"],
    body.dark-theme [style*="background: #bbf7d0"] {
      background: rgba(34, 197, 94, 0.2) !important;
    }
    body.dark-theme [style*="background:#bbf7d0"] div,
    body.dark-theme [style*="background: #bbf7d0"] div {
      color: #4ade80 !important;
    }
    body.dark-theme [style*="background:#e2e8f0"],
    body.dark-theme [style*="background: #e2e8f0"] {
      background: var(--bg-tertiary) !important;
    }
    /* Fix text colors in dark theme */
    body.dark-theme [style*="color:#047857"] { color: #4ade80 !important; }
    body.dark-theme [style*="color: #047857"] { color: #4ade80 !important; }
    body.dark-theme [style*="color:#15803d"] { color: #4ade80 !important; }
    body.dark-theme [style*="color: #15803d"] { color: #4ade80 !important; }
    body.dark-theme [style*="color:#dc2626"] { color: #f87171 !important; }
    body.dark-theme [style*="color: #dc2626"] { color: #f87171 !important; }
    body.dark-theme [style*="color:#b45309"] { color: #fbbf24 !important; }
    body.dark-theme [style*="color: #b45309"] { color: #fbbf24 !important; }
    body.dark-theme [style*="color:#92400e"] { color: #fbbf24 !important; }
    body.dark-theme [style*="color: #92400e"] { color: #fbbf24 !important; }
    body.dark-theme [style*="color:#1d4ed8"] { color: #60a5fa !important; }
    body.dark-theme [style*="color: #1d4ed8"] { color: #60a5fa !important; }
    body.dark-theme [style*="color:#1e293b"] { color: var(--text-primary) !important; }
    body.dark-theme [style*="color: #1e293b"] { color: var(--text-primary) !important; }
    body.dark-theme [style*="color:#64748b"] { color: var(--text-secondary) !important; }
    body.dark-theme [style*="color: #64748b"] { color: var(--text-secondary) !important; }
    body.dark-theme [style*="color:#7c3aed"] { color: #a78bfa !important; }
    body.dark-theme [style*="color: #7c3aed"] { color: #a78bfa !important; }
    /* Progress bars in dark mode */
    body.dark-theme [style*="background:#fee2e2;height:8px"],
    body.dark-theme [style*="background: #fee2e2;height:8px"] {
      background: rgba(239, 68, 68, 0.2) !important;
    }
    body.dark-theme [style*="background:#fef3c7;height:8px"],
    body.dark-theme [style*="background: #fef3c7;height:8px"] {
      background: rgba(245, 158, 11, 0.2) !important;
    }
    body.dark-theme [style*="background:#ede9fe;height:8px"],
    body.dark-theme [style*="background: #ede9fe;height:8px"] {
      background: rgba(139, 92, 246, 0.2) !important;
    }
    body.dark-theme [style*="background:#e2e8f0;height:8px"],
    body.dark-theme [style*="background: #e2e8f0;height:8px"] {
      background: var(--bg-hover) !important;
    }
    /* Border colors in dark mode */
    body.dark-theme [style*="border:1px solid #e5e7eb"],
    body.dark-theme [style*="border: 1px solid #e5e7eb"] {
      border-color: var(--border) !important;
    }
    body.dark-theme .toggle-switch {
      background: var(--bg-tertiary);
      border-color: var(--border);
    }
    body.dark-theme .toggle-switch.active {
      background: var(--primary);
      border-color: var(--primary);
    }
    body.dark-theme .login-hero {
      background: 
        linear-gradient(135deg, rgba(3, 7, 18, 0.92) 0%, rgba(10, 15, 26, 0.88) 100%),
        url('https://images.unsplash.com/photo-1524661135-423995f22d0b?auto=format&fit=crop&w=2000&q=80');
      background-size: cover;
      background-position: center;
    }
    body.dark-theme .modal-close { background: var(--bg-tertiary); }
    body.dark-theme .modal-footer { background: var(--bg-tertiary); border-top-color: var(--border); }
    body.dark-theme .mobile-header { background: linear-gradient(135deg, #0c1520 0%, #111c2a 100%); }
    
    /* ============ MOBILE HAMBURGER MENU ============ */
    .mobile-header {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(135deg, #064e3b 0%, #059669 100%);
      z-index: 200;
      padding: 0 16px;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .mobile-header .logo-text {
      color: white;
      font-size: 17px;
      font-weight: 700;
      letter-spacing: -0.3px;
    }
    
    .hamburger {
      width: 42px;
      height: 42px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      background: rgba(255,255,255,0.15);
      border: none;
      padding: 10px;
      border-radius: 10px;
      transition: all 0.2s ease;
    }
    
    .hamburger:active {
      transform: scale(0.95);
      background: rgba(255,255,255,0.2);
    }
    
    .hamburger span {
      display: block;
      width: 20px;
      height: 2px;
      background: white;
      border-radius: 2px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .hamburger.active span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }
    
    .hamburger.active span:nth-child(2) {
      opacity: 0;
      transform: scaleX(0);
    }
    
    .hamburger.active span:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }
    
    .mobile-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 199;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    
    .mobile-overlay.active {
      display: block;
      opacity: 1;
      pointer-events: auto;
    }
    
    /* ============ RESPONSIVE - TABLET (768px - 1024px) ============ */
    @media (max-width: 1024px) {
      .main {
        padding: 24px 20px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }
      
      .header h2 {
        font-size: 24px;
      }
      
      .table-wrapper {
        overflow-x: auto;
      }
      
      table {
        min-width: 600px;
      }
      
      .modal {
        max-width: 90% !important;
        margin: 20px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 12px;
      }
      
      .form-row .form-group {
        flex: 1 1 100%;
      }
    }
    
    /* ============ RESPONSIVE - MOBILE (< 768px) ============ */
    @media (max-width: 768px) {
      /* === HIDE TOPBAR ON MOBILE (use mobile-header instead) === */
      .topbar {
        display: none !important;
      }
      
      /* === MOBILE HEADER === */
      .mobile-header {
        display: flex;
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      }
      
      /* === MOBILE OVERLAY - behind sidebar === */
      .mobile-overlay {
        z-index: 200 !important;
      }
      
      /* === SIDEBAR === */
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 250 !important;
        width: 85%;
        min-width: 200px;
        max-width: 320px;
        padding-top: 60px;
        box-shadow: 4px 0 25px rgba(0,0,0,0.3);
        pointer-events: auto;
      }
      
      .sidebar.mobile-open {
        transform: translateX(0);
      }
      
      .sidebar.mobile-open nav,
      .sidebar.mobile-open .nav-item {
        pointer-events: auto !important;
        position: relative;
        z-index: 251;
      }
      
      .sidebar .sidebar-toggle {
        display: none;
      }
      
      .sidebar .nav-item {
        padding: 14px 18px;
        font-size: 15px;
        border-radius: 12px;
        margin: 3px 10px;
        -webkit-tap-highlight-color: rgba(34, 197, 94, 0.3);
        touch-action: manipulation;
        cursor: pointer;
        user-select: none;
        -webkit-user-select: none;
      }
      
      .sidebar .nav-item:active {
        background: rgba(34, 197, 94, 0.3) !important;
        transform: scale(0.98);
      }
      
      .sidebar .nav-item .icon {
        font-size: 20px;
        width: 28px;
      }
      
      .sidebar .settings-panel {
        padding: 16px;
        margin: 8px;
        background: rgba(255,255,255,0.05);
        border-radius: 12px;
      }
      
      .sidebar .settings-row {
        flex-direction: row;
        gap: 8px;
      }
      
      .sidebar .settings-btn {
        flex: 1;
        padding: 12px;
        font-size: 14px;
        border-radius: 10px;
      }
      
      .sidebar .user-info {
        padding: 16px;
        margin: 8px;
        background: rgba(255,255,255,0.05);
        border-radius: 12px;
      }
      
      .sidebar .logout-btn {
        padding: 14px;
        font-size: 15px;
        border-radius: 10px;
        margin-top: 12px;
      }
      
      /* === MAIN CONTENT === */
      .main {
        margin-left: 0 !important;
        padding: 72px 16px 100px 16px;
        width: 100%;
        min-height: 100vh;
        min-height: -webkit-fill-available;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        position: relative;
      }
      
      /* Ensure body allows scrolling */
      html {
        height: 100%;
        height: -webkit-fill-available;
        overflow: auto;
      }
      
      body {
        min-height: 100%;
        min-height: -webkit-fill-available;
        overflow: auto;
        position: relative;
      }
      
      /* Fix for app container */
      .app {
        display: block !important;
        min-height: 100vh;
        min-height: -webkit-fill-available;
        overflow: visible;
      }
      
      /* Fix for content not scrolling */
      #main-content {
        height: auto !important;
        min-height: calc(100vh - 72px);
        overflow: visible !important;
      }
      
      /* When menu is open, lock scroll */
      body.menu-open {
        overflow: hidden !important;
        position: fixed;
        width: 100%;
        height: 100%;
      }
      
      /* === PAGE HEADER === */
      .header {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }
      
      .header h2 {
        font-size: 22px;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .header-actions {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .header-actions .btn,
      .header .btn {
        justify-content: center;
        padding: 14px 12px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 12px;
      }
      
      .header-actions .btn-primary {
        grid-column: span 2;
        background: linear-gradient(135deg, var(--primary) 0%, #4f46e5 100%);
      }
      
      /* === STATS CARDS === */
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
      }
      
      .stat-card {
        padding: 16px;
        border-radius: 16px;
        position: relative;
        overflow: hidden;
      }
      
      .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 60px;
        height: 60px;
        background: currentColor;
        opacity: 0.05;
        border-radius: 0 0 0 60px;
      }
      
      .stat-card .label {
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
        opacity: 0.8;
      }
      
      .stat-card .value {
        font-size: 20px;
        font-weight: 800;
        letter-spacing: -0.5px;
      }
      
      /* === CARDS === */
      .card {
        padding: 16px;
        border-radius: 16px;
        margin-bottom: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        overflow: visible;
      }
      
      .card h3 {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--border);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      /* === TABLES === */
      .table-wrapper {
        margin: 0 -16px;
        padding: 0 16px 16px;
        overflow-x: auto;
        overflow-y: visible;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        position: relative;
      }
      
      /* Scroll hint - fade on right edge */
      .table-wrapper::after {
        content: '';
        position: sticky;
        right: 0;
        top: 0;
        bottom: 0;
        width: 30px;
        background: linear-gradient(90deg, transparent, var(--bg-secondary));
        pointer-events: none;
      }
      
      .table-wrapper::-webkit-scrollbar {
        height: 6px;
      }
      
      .table-wrapper::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
      }
      
      table {
        min-width: 550px;
        font-size: 13px;
        border-collapse: separate;
        border-spacing: 0;
      }
      
      table th {
        padding: 12px 10px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: var(--bg-tertiary);
        position: sticky;
        top: 0;
        z-index: 5;
      }
      
      table th:first-child {
        border-radius: 10px 0 0 0;
      }
      
      table th:last-child {
        border-radius: 0 10px 0 0;
      }
      
      table td {
        padding: 14px 10px;
        border-bottom: 1px solid var(--border-light);
        vertical-align: middle;
      }
      
      table tr:active {
        background: var(--primary-light);
      }
      
      /* === MODALS - Bottom Sheet Style === */
      .modal-overlay {
        padding: 0;
        align-items: flex-end;
        background: rgba(0,0,0,0.6);
      }
      
      .modal {
        max-width: 100% !important;
        width: 100% !important;
        max-height: 92vh !important;
        margin: 0;
        border-radius: 24px 24px 0 0;
        animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
      }
      
      @keyframes slideUp {
        from { 
          transform: translateY(100%);
          opacity: 0.5;
        }
        to { 
          transform: translateY(0);
          opacity: 1;
        }
      }
      
      .modal::before {
        content: '';
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 4px;
        background: var(--border);
        border-radius: 2px;
      }
      
      .modal-header {
        padding: 24px 20px 16px;
        position: sticky;
        top: 0;
        background: var(--bg-secondary);
        z-index: 10;
        border-bottom: 1px solid var(--border);
      }
      
      .modal-header h3 {
        font-size: 20px;
        font-weight: 700;
      }
      
      .modal-close {
        width: 36px;
        height: 36px;
        font-size: 20px;
      }
      
      .modal-body {
        padding: 20px;
        max-height: calc(92vh - 160px);
        overflow-y: auto;
        overscroll-behavior: contain;
      }
      
      .modal-footer {
        padding: 16px 20px;
        padding-bottom: max(16px, env(safe-area-inset-bottom));
        gap: 12px;
        position: sticky;
        bottom: 0;
        background: var(--bg-secondary);
        border-top: 1px solid var(--border);
        box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
      }
      
      .modal-footer .btn {
        flex: 1;
        padding: 16px;
        font-size: 15px;
        font-weight: 600;
        border-radius: 14px;
      }
      
      /* === FORMS === */
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      
      .form-row > div,
      .form-row .form-group {
        flex: 1 1 100% !important;
        width: 100% !important;
      }
      
      .form-group {
        margin-bottom: 16px;
      }
      
      .form-group label {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 8px;
        display: block;
        color: var(--text-secondary);
      }
      
      .form-group input,
      .form-group select,
      .form-group textarea {
        padding: 16px;
        font-size: 16px;
        border-radius: 12px;
        border: 2px solid var(--border);
        transition: all 0.2s ease;
        -webkit-appearance: none;
      }
      
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px var(--primary-light);
        outline: none;
      }
      
      .form-group select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 20px;
        padding-right: 44px;
      }
      
      /* === BUTTONS === */
      .btn {
        padding: 14px 20px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 12px;
        min-height: 48px;
        touch-action: manipulation;
      }
      
      .btn:active {
        transform: scale(0.97);
      }
      
      .btn-sm {
        padding: 10px 16px;
        font-size: 13px;
        min-height: 40px;
      }
      
      .btn-primary {
        box-shadow: 0 4px 14px rgba(99, 102, 241, 0.35);
      }
      
      /* === ACTION BUTTONS === */
      .actions {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      
      .action-btn {
        padding: 8px 12px;
        font-size: 12px;
        font-weight: 600;
        border-radius: 8px;
        min-height: 36px;
      }
      
      /* === BADGES === */
      .badge {
        font-size: 11px;
        padding: 6px 10px;
        font-weight: 700;
        border-radius: 8px;
        letter-spacing: 0.3px;
      }
      
      /* === DRIVER/TRUCK CARDS === */
      .drivers-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .driver-card {
        padding: 20px;
        border-radius: 16px;
        border: 1px solid var(--border);
      }
      
      .driver-card h3 {
        font-size: 18px;
        margin-bottom: 12px;
      }
      
      /* === TRIP TABS / HORIZONTAL SCROLL TABS === */
      [style*="overflow-x:auto"][style*="white-space:nowrap"] {
        display: flex !important;
        gap: 8px !important;
        padding: 8px 16px !important;
        margin: 0 -16px 0 -16px !important;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      
      [style*="overflow-x:auto"][style*="white-space:nowrap"]::-webkit-scrollbar {
        display: none;
      }
      
      [style*="overflow-x:auto"][style*="white-space:nowrap"] button {
        flex-shrink: 0 !important;
        padding: 14px 18px !important;
        font-size: 13px !important;
        border-radius: 12px 12px 0 0 !important;
        min-width: auto !important;
        white-space: nowrap !important;
      }
      
      /* === DASHBOARD GRIDS === */
      [style*="display:grid"][style*="grid-template-columns"]:not(.stats-grid) {
        display: block !important;
      }
      
      [style*="display:grid"]:not(.stats-grid) > div {
        margin-bottom: 16px;
      }
      
      /* === PAYMENT BOXES === */
      [style*="grid-template-columns:repeat(auto-fit"] {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 10px !important;
      }
      
      [style*="grid-template-columns:repeat(auto-fit"] > div {
        padding: 14px !important;
        border-radius: 12px !important;
      }
      
      /* === INFO BOXES === */
      [style*="background:#dbeafe"],
      [style*="background:#d1fae5"],
      [style*="background:#fef3c7"],
      [style*="background:#fee2e2"],
      [style*="background:#f0fdf4"] {
        padding: 16px !important;
        border-radius: 14px !important;
        margin-bottom: 16px !important;
        font-size: 14px !important;
      }
      
      /* === AUTOCOMPLETE DROPDOWNS === */
      [id$="-dropdown"] {
        max-height: 200px !important;
        border-radius: 12px !important;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15) !important;
      }
      
      [id$="-dropdown"] > div {
        padding: 14px 16px !important;
        font-size: 15px !important;
      }
      
      /* === TOAST NOTIFICATIONS === */
      .toast {
        left: 16px !important;
        right: 16px !important;
        bottom: 90px !important;
        max-width: none !important;
        border-radius: 14px !important;
        padding: 16px 20px !important;
        font-size: 14px !important;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important;
      }
      
      /* === LOGIN PAGE === */
      /* Login styles are in main login section */
      
      /* === FLOATING ACTION HINT === */
      .scroll-hint {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--text-primary);
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 50;
      }
      
      .scroll-hint.visible {
        opacity: 0.9;
      }
      
      /* === SAFE AREA FOR NOTCHED PHONES === */
      @supports (padding-bottom: env(safe-area-inset-bottom)) {
        .main {
          padding-bottom: calc(100px + env(safe-area-inset-bottom));
        }
        
        .mobile-header {
          padding-top: env(safe-area-inset-top);
          height: calc(60px + env(safe-area-inset-top));
        }
        
        .sidebar {
          padding-top: calc(60px + env(safe-area-inset-top));
        }
      }
    }
    
    /* ============ RESPONSIVE UTILITY CLASSES ============ */
    @media (max-width: 768px) {
      /* Force flex items to wrap - but not for tabs */
      [style*="display:flex"]:not(.truck-tabs-container),
      [style*="display: flex"]:not(.truck-tabs-container) {
        flex-wrap: wrap !important;
      }
      
      /* Make inline grids responsive - 2 columns on tablet */
      [style*="display:grid"]:not(.truck-tabs-container),
      [style*="display: grid"]:not(.truck-tabs-container) {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
      }
      
      /* Two column layouts become single */
      [style*="grid-template-columns: 1fr 1fr"],
      [style*="grid-template-columns:1fr 1fr"] {
        grid-template-columns: 1fr !important;
      }
      
      /* Fix Financial Analysis gradient box */
      [style*="linear-gradient"] {
        padding: 16px !important;
        border-radius: 12px !important;
      }
      
      /* Financial Analysis Dark Mode Support */
      body.dark-theme .fin-metric-card {
        background: #1e293b !important;
        border-color: #334155 !important;
      }
      body.dark-theme .fin-metric-card div[style*="color:#1e293b"] {
        color: #f1f5f9 !important;
      }
      body.dark-theme .fin-metric-card div[style*="color:#64748b"] {
        color: #94a3b8 !important;
      }
      body.dark-theme .fin-metric-card div[style*="background:#dbeafe"],
      body.dark-theme .fin-metric-card div[style*="background:#dcfce7"],
      body.dark-theme .fin-metric-card div[style*="background:#fef3c7"],
      body.dark-theme .fin-metric-card div[style*="background:#e0e7ff"],
      body.dark-theme .fin-metric-card div[style*="background:#fee2e2"],
      body.dark-theme .fin-metric-card div[style*="background:#fce7f3"] {
        opacity: 0.9;
      }
      body.dark-theme [style*="background:#f8fafc"],
      body.dark-theme [style*="background: #f8fafc"] {
        background: #1e293b !important;
      }
      body.dark-theme [style*="background:#f1f5f9"],
      body.dark-theme [style*="background: #f1f5f9"] {
        background: #334155 !important;
      }
      body.dark-theme [style*="background:white"],
      body.dark-theme [style*="background: white"] {
        background: #1e293b !important;
      }
      body.dark-theme [style*="color:#334155"],
      body.dark-theme [style*="color: #334155"] {
        color: #e2e8f0 !important;
      }
      body.dark-theme [style*="border:1px solid #e2e8f0"],
      body.dark-theme [style*="border: 1px solid #e2e8f0"] {
        border-color: #475569 !important;
      }
      body.dark-theme details summary {
        background: #92400e !important;
      }
      
      /* Form rows with inline gap */
      [style*="gap:16px"],
      [style*="gap: 16px"] {
        gap: 12px !important;
      }
      
      /* Fix min-width items */
      [style*="min-width:180px"],
      [style*="min-width: 180px"],
      [style*="min-width:200px"],
      [style*="min-width: 200px"],
      [style*="min-width:140px"],
      [style*="min-width: 140px"] {
        min-width: unset !important;
        width: 100% !important;
      }
      
      /* Truck tabs should scroll horizontally */
      .truck-tabs-container {
        display: flex !important;
        flex-wrap: nowrap !important;
        overflow-x: scroll !important;
        overflow-y: hidden !important;
        -webkit-overflow-scrolling: touch !important;
        padding-bottom: 10px;
        max-width: 100% !important;
        width: 100% !important;
      }
      
      .truck-tabs-container button,
      .truck-tabs-container .truck-tab,
      .truck-tab {
        flex-shrink: 0 !important;
        white-space: nowrap !important;
      }
    }
    
    /* ============ RESPONSIVE - SMALL MOBILE (< 480px) ============ */
    @media (max-width: 480px) {
      .main {
        padding: 68px 12px 100px 12px;
      }
      
      .header h2 {
        font-size: 20px;
      }
      
      .header-actions {
        grid-template-columns: 1fr;
      }
      
      .header-actions .btn-primary {
        grid-column: span 1;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .stat-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
      }
      
      .stat-card .label {
        margin-bottom: 0;
        order: 1;
      }
      
      .stat-card .value {
        font-size: 22px;
        order: 2;
      }
      
      table {
        font-size: 12px;
        min-width: 480px;
      }
      
      table th, table td {
        padding: 10px 8px;
      }
      
      .modal-header h3 {
        font-size: 18px;
      }
      
      .modal-body {
        padding: 16px;
      }
      
      .card {
        padding: 14px;
        border-radius: 14px;
      }
      
      .card h3 {
        font-size: 15px;
      }
      
      .form-group input,
      .form-group select {
        padding: 14px;
      }
      
      [style*="grid-template-columns:repeat(auto-fit"] {
        grid-template-columns: 1fr !important;
      }
      
      [style*="grid-template-columns: repeat(auto-fit"] {
        grid-template-columns: 1fr !important;
      }
      
      /* Force all inline flex containers to wrap - except tabs */
      [style*="display:flex"]:not(.truck-tabs-container),
      [style*="display: flex"]:not(.truck-tabs-container) {
        flex-wrap: wrap !important;
      }
      
      /* Force all inline grids to single column */
      [style*="display:grid"]:not(.truck-tabs-container),
      [style*="display: grid"]:not(.truck-tabs-container) {
        grid-template-columns: 1fr !important;
      }
      
      /* Truck tabs should still scroll */
      .truck-tabs-container {
        display: flex !important;
        flex-wrap: nowrap !important;
        overflow-x: scroll !important;
        overflow-y: hidden !important;
        -webkit-overflow-scrolling: touch !important;
        padding-bottom: 10px;
        margin-left: -12px;
        margin-right: -12px;
        padding-left: 12px;
        padding-right: 12px;
        max-width: calc(100% + 24px) !important;
      }
      
      .truck-tabs-container button,
      .truck-tabs-container .truck-tab,
      .truck-tab {
        padding: 10px 14px !important;
        font-size: 12px !important;
        flex-shrink: 0 !important;
        white-space: nowrap !important;
      }
      
      /* Ensure gradient headers stay nice */
      [style*="linear-gradient"] {
        border-radius: 8px !important;
      }
      
      .driver-card {
        padding: 16px;
      }
      
      .driver-card h3 {
        font-size: 16px;
      }
    }
    
    /* ============ PRINT STYLES === */
    @media print {
      .mobile-header,
      .sidebar,
      .hamburger,
      .modal-overlay {
        display: none !important;
      }
      
      .main {
        margin: 0 !important;
        padding: 20px !important;
      }
    }
    
    /* ============ MOBILE SWIPE ACTIONS ============ */
    .swipe-container {
      position: relative;
      overflow: hidden;
      touch-action: pan-y;
    }
    
    .swipe-content {
      position: relative;
      background: var(--bg-card);
      transition: transform 0.3s ease;
      z-index: 2;
    }
    
    .swipe-actions {
      position: absolute;
      top: 0;
      bottom: 0;
      display: flex;
      align-items: stretch;
      z-index: 1;
    }
    
    .swipe-actions-left {
      left: 0;
      justify-content: flex-start;
    }
    
    .swipe-actions-right {
      right: 0;
      justify-content: flex-end;
    }
    
    .swipe-action {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 24px;
      color: white;
      font-weight: 600;
      font-size: 13px;
      gap: 8px;
      min-width: 80px;
    }
    
    .swipe-action-edit {
      background: #3b82f6;
    }
    
    .swipe-action-delete {
      background: #ef4444;
    }
    
    .swipe-action-complete {
      background: #22c55e;
    }
    
    .swipe-action-call {
      background: #8b5cf6;
    }
    
    /* ============ MOBILE LIST CARDS ============ */
    @media (max-width: 768px) {
      .mobile-list-item {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
      }
      
      .mobile-list-item:active {
        background: var(--bg-hover);
      }
      
      .mobile-list-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }
      
      .mobile-list-title {
        font-weight: 600;
        font-size: 15px;
        color: var(--text-primary);
      }
      
      .mobile-list-subtitle {
        font-size: 13px;
        color: var(--text-muted);
        margin-top: 2px;
      }
      
      .mobile-list-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }
      
      .mobile-list-body {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        font-size: 13px;
      }
      
      .mobile-list-field {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      
      .mobile-list-field-label {
        font-size: 10px;
        text-transform: uppercase;
        color: var(--text-muted);
        font-weight: 600;
      }
      
      .mobile-list-field-value {
        color: var(--text-primary);
        font-weight: 500;
      }
      
      .mobile-list-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border);
      }
      
      .mobile-list-action {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        border: none;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        min-height: 44px;
        touch-action: manipulation;
      }
      
      .mobile-list-action-primary {
        background: var(--primary);
        color: white;
      }
      
      .mobile-list-action-secondary {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      
      .mobile-list-action-danger {
        background: #fee2e2;
        color: #dc2626;
      }
    }
    
    /* ============ FLOATING ACTION BUTTON ============ */
    @media (max-width: 768px) {
      .fab {
        position: fixed;
        bottom: calc(24px + env(safe-area-inset-bottom, 0px));
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary) 0%, #16a34a 100%);
        color: white;
        border: none;
        font-size: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
        cursor: pointer;
        z-index: 100;
        touch-action: manipulation;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      
      .fab:active {
        transform: scale(0.92);
        box-shadow: 0 2px 10px rgba(34, 197, 94, 0.3);
      }
      
      /* Add bottom padding to main content when FAB is present */
      .has-fab .main {
        padding-bottom: calc(120px + env(safe-area-inset-bottom, 0px)) !important;
      }
    }
    
    /* ============ ENHANCED TOUCH TARGETS ============ */
    @media (max-width: 768px) {
      /* All interactive elements minimum 44px */
      button, 
      a, 
      input[type="checkbox"], 
      input[type="radio"],
      select,
      .clickable,
      [onclick] {
        min-height: 44px;
        min-width: 44px;
      }
      
      /* Table action buttons */
      table .btn,
      table button {
        padding: 10px 14px !important;
        min-height: 40px;
        font-size: 12px !important;
      }
      
      /* Checkbox and radio larger */
      input[type="checkbox"],
      input[type="radio"] {
        width: 22px;
        height: 22px;
        cursor: pointer;
      }
      
      /* Better tap states */
      button:active,
      a:active,
      .clickable:active,
      [onclick]:active {
        opacity: 0.8;
        transform: scale(0.98);
      }
      
      /* Search input */
      input[type="search"],
      input[type="text"],
      input[placeholder*="Search"],
      input[placeholder*="áƒ«áƒ”áƒ‘áƒœáƒ"] {
        min-height: 48px;
        font-size: 16px !important; /* Prevents iOS zoom */
      }
      
      /* Filter dropdowns */
      .filter-group select {
        min-height: 44px;
        padding: 12px 40px 12px 14px;
      }
      
      /* Notification dropdown */
      .notification-dropdown {
        width: calc(100vw - 24px);
        right: -60px;
        max-width: 400px;
      }
      
      .notification-item {
        padding: 16px;
        min-height: 72px;
      }
    }
    
    /* ============ MOBILE CHAT IMPROVEMENTS ============ */
    @media (max-width: 768px) {
      .chat-container {
        height: calc(100vh - 80px) !important;
        max-width: 100% !important;
      }
      
      .chat-header {
        padding: 12px 16px !important;
        border-radius: 0 !important;
      }
      
      .chat-header h2 {
        font-size: 18px !important;
      }
      
      .chat-messages {
        padding: 12px !important;
      }
      
      .chat-input-area {
        padding: 12px !important;
        padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px)) !important;
      }
      
      #chatInput {
        font-size: 16px !important; /* Prevents iOS zoom */
        min-height: 44px !important;
        padding: 12px !important;
      }
      
      #mentionDropdown {
        max-height: 180px;
      }
    }
    
    /* ============ PULL TO REFRESH INDICATOR ============ */
    .pull-refresh-indicator {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%) translateY(-60px);
      background: var(--bg-card);
      padding: 10px 20px;
      border-radius: 24px;
      box-shadow: var(--shadow-lg);
      z-index: 100;
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: var(--text-muted);
    }
    
    .pull-refresh-indicator.visible {
      transform: translateX(-50%) translateY(0);
    }
    
    .pull-refresh-indicator .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    /* ============ MOBILE LIVE MAP ============ */
    @media (max-width: 768px) {
      #liveMapContainer {
        height: 50vh !important;
        min-height: 300px !important;
        border-radius: 12px !important;
      }
      
      #truckListPanel {
        width: 100% !important;
        height: auto !important;
        max-height: 40vh;
        margin-top: 12px;
      }
      
      /* Stack map and list vertically */
      .live-map-layout {
        flex-direction: column !important;
      }
    }
    
    /* ============ BOTTOM SHEET MENU (for actions) ============ */
    .bottom-sheet-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    .bottom-sheet-overlay.open {
      opacity: 1;
      visibility: visible;
    }
    
    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border-radius: 20px 20px 0 0;
      padding: 8px 0;
      padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      z-index: 1001;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .bottom-sheet-overlay.open .bottom-sheet {
      transform: translateY(0);
    }
    
    .bottom-sheet::before {
      content: '';
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
    }
    
    .bottom-sheet-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 24px;
      font-size: 16px;
      color: var(--text-primary);
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      min-height: 56px;
    }
    
    .bottom-sheet-item:active {
      background: var(--bg-hover);
    }
    
    .bottom-sheet-item-icon {
      width: 24px;
      text-align: center;
      font-size: 20px;
    }
    
    .bottom-sheet-item-danger {
      color: #ef4444;
    }
    
    .bottom-sheet-divider {
      height: 1px;
      background: var(--border);
      margin: 8px 24px;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #0f172a;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    .loading-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    
    .loading-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 40px;
      color: white;
      animation: loadingFadeInUp 0.5s ease;
    }
    
    .loading-logo-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }
    
    .loading-logo span {
      color: #10b981;
    }
    
    .loading-truck {
      position: relative;
      width: 200px;
      height: 60px;
      margin-bottom: 30px;
    }
    
    .truck {
      font-size: 50px;
      position: absolute;
      animation: driveTruck 2s ease-in-out infinite;
    }
    
    @keyframes driveTruck {
      0% { left: -60px; }
      50% { left: calc(50% - 25px); }
      100% { left: calc(100% + 10px); }
    }
    
    .road {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
      overflow: hidden;
    }
    
    .road::after {
      content: '';
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 100%;
      height: 2px;
      background: repeating-linear-gradient(90deg, #fbbf24 0px, #fbbf24 20px, transparent 20px, transparent 40px);
      animation: roadMove 0.5s linear infinite;
    }
    
    @keyframes roadMove {
      0% { transform: translateY(-50%) translateX(0); }
      100% { transform: translateY(-50%) translateX(-40px); }
    }
    
    .loading-text {
      font-size: 16px;
      color: rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .loading-dots {
      display: flex;
      gap: 4px;
    }
    
    .loading-dots span {
      width: 6px;
      height: 6px;
      background: #10b981;
      border-radius: 50%;
      animation: loadingBounce 1.4s infinite ease-in-out both;
    }
    
    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    .loading-dots span:nth-child(3) { animation-delay: 0s; }
    
    @keyframes loadingBounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    
    @keyframes loadingFadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ðŸŽ¨ MODERN UI/UX IMPROVEMENTS v3.0 - Comprehensive Design System
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* ============ MICRO-INTERACTIONS & ANIMATIONS ============ */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.96); }
      to { opacity: 1; transform: scale(1); }
    }
    
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(24px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-24px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    @keyframes pulse-soft {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }
    
    @keyframes ripple {
      0% { transform: scale(0); opacity: 0.4; }
      100% { transform: scale(4); opacity: 0; }
    }
    
    @keyframes gradient-shift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    @keyframes border-glow {
      0%, 100% { border-color: var(--primary); box-shadow: 0 0 8px rgba(34, 197, 94, 0.3); }
      50% { border-color: var(--primary-hover); box-shadow: 0 0 16px rgba(34, 197, 94, 0.5); }
    }
    
    /* Page entry animation - premium */
    .main {
      animation: pageEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes pageEnter {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* ============ ENHANCED TYPOGRAPHY ============ */
    .text-truncate {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
    }
    
    .text-truncate-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .text-truncate-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .text-wrap {
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    /* ============ ENHANCED CARDS ============ */
    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow-card);
      overflow: hidden;
      transition: all var(--duration-normal) var(--ease-smooth);
      position: relative;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity var(--duration-fast);
    }
    
    .card:hover {
      border-color: rgba(34, 197, 94, 0.3);
      box-shadow: var(--shadow-card-hover);
      transform: translateY(-2px);
    }
    
    .card:hover::before {
      opacity: 1;
    }
    
    .card-header {
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, var(--bg-secondary) 0%, rgba(248, 250, 252, 0.6) 100%);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card-header h3 {
      font-size: var(--text-md);
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.3px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .card-header h3 .icon {
      font-size: 18px;
      opacity: 0.85;
    }
    
    .card-body {
      padding: 0;
    }
    
    /* Glass card variant */
    .card-glass {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
    }
    
    /* ============ ENHANCED STAT CARDS - Premium Treatment ============ */
    .stat-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-card);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    /* Gradient overlay on hover */
    .stat-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0) 100%);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    /* Top accent line - animated */
    .stat-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--gradient-primary);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-card-hover), 0 0 30px rgba(34, 197, 94, 0.08);
      border-color: rgba(34, 197, 94, 0.3);
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-card:hover::after {
      transform: scaleX(1);
    }

    /* Stat icon - premium treatment */
    .stat-card .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stat-card:hover .stat-icon {
      transform: scale(1.08);
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.2);
    }

    /* Label - monospace uppercase */
    .stat-card .label {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    /* Value - large monospace numbers */
    .stat-card .value {
      font-family: var(--font-mono);
      font-size: var(--text-3xl);
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1;
      color: var(--text-primary);
    }

    .stat-card .value.green {
      color: var(--primary);
      text-shadow: 0 0 30px rgba(34, 197, 94, 0.3);
    }
    .stat-card .value.red { color: var(--danger); }
    .stat-card .value.orange { color: var(--warning); }
    .stat-card .value.blue { color: var(--accent); }

    /* Trend badge */
    .stat-card .trend {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 4px 10px;
      border-radius: 6px;
      margin-top: 12px;
    }

    .stat-card .trend::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .stat-card .trend.up {
      background: rgba(34, 197, 94, 0.1);
      color: var(--primary);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .stat-card .trend.down {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    /* Revenue card - hero treatment with glow */
    .stat-card.revenue,
    .stat-card.green-header {
      background:
        radial-gradient(ellipse at top right, rgba(34, 197, 94, 0.1) 0%, transparent 50%),
        var(--bg-tertiary);
      border-color: rgba(34, 197, 94, 0.2);
    }

    .stat-card.revenue .value,
    .stat-card.green-header .value {
      color: var(--primary);
      text-shadow: 0 0 30px rgba(34, 197, 94, 0.3);
    }
    
    /* ============ ENHANCED BUTTONS - Tactile & Premium ============ */
    .btn {
      position: relative;
      font-family: var(--font-body);
      font-size: var(--text-sm);
      font-weight: 600;
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    /* Primary button - hero green with layered shadows */
    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      box-shadow:
        0 1px 2px rgba(0, 0, 0, 0.1),
        0 4px 12px rgba(34, 197, 94, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow:
        0 2px 4px rgba(0, 0, 0, 0.1),
        0 8px 20px rgba(34, 197, 94, 0.35),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow:
        0 1px 2px rgba(0, 0, 0, 0.1),
        0 2px 8px rgba(34, 197, 94, 0.2),
        inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Secondary button - ghost style */
    .btn-secondary {
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Small button variant */
    .btn-sm {
      padding: 8px 14px;
      font-size: 12px;
      border-radius: 8px;
    }

    /* Icon buttons */
    .btn-icon {
      width: 40px;
      height: 40px;
      padding: 0;
      border-radius: 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .btn-icon:hover {
      background: var(--bg-secondary);
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
      transform: scale(1.05);
    }
    
    /* ============ ENHANCED TABLES - Premium Data Display ============ */
    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 0 0 16px 16px;
      background: var(--bg-tertiary);
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    /* Header row - bold industrial treatment */
    th {
      text-align: left;
      padding: 14px 16px;
      background: var(--bg-secondary);
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }

    th:first-child { border-radius: 0; padding-left: 20px; }
    th:last-child { border-radius: 0; padding-right: 20px; }

    /* Body cells */
    td {
      padding: 16px;
      font-family: var(--font-body);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
      transition: all 0.15s ease;
      vertical-align: middle;
      background: var(--bg-tertiary);
    }

    td:first-child { padding-left: 20px; }
    td:last-child { padding-right: 20px; }

    /* Text truncation in table cells */
    td {
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    td.wrap {
      white-space: normal;
      max-width: none;
    }

    td.actions-cell {
      white-space: nowrap;
      max-width: none;
    }

    /* Alternate row pattern - subtle stripe */
    tbody tr:nth-child(even) td {
      background: rgba(255, 255, 255, 0.01);
    }

    /* Hover state - sophisticated green tint */
    tr:hover td {
      background: rgba(34, 197, 94, 0.04);
    }

    tr:last-child td {
      border-bottom: none;
    }

    td strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    /* Money columns - monospace with tabular numbers */
    td.money {
      font-family: var(--font-mono);
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      color: var(--primary);
    }

    /* Row number column - accent color */
    .row-number {
      font-family: var(--font-mono);
      font-weight: 600;
      font-size: 12px;
      color: var(--primary);
    }
    
    /* ============ ENHANCED BADGES - Industrial Style ============ */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 6px;
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .badge-green {
      background: rgba(34, 197, 94, 0.1);
      color: var(--primary);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .badge-amber {
      background: rgba(245, 158, 11, 0.1);
      color: #d97706;
      border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .badge-red {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .badge-blue {
      background: rgba(6, 182, 212, 0.1);
      color: var(--accent);
      border: 1px solid rgba(6, 182, 212, 0.2);
    }

    .badge-purple {
      background: rgba(139, 92, 246, 0.1);
      color: #a78bfa;
      border: 1px solid rgba(139, 92, 246, 0.2);
    }

    .badge-gray {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    /* Status badges with animated dot indicator */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 6px;
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }
    
    .status-badge::before {
      content: '';
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse-soft 2s ease-in-out infinite;
    }
    
    .status-badge.success {
      background: rgba(34, 197, 94, 0.12);
      color: #16a34a;
    }
    
    .status-badge.warning {
      background: rgba(245, 158, 11, 0.12);
      color: #d97706;
    }
    
    .status-badge.danger {
      background: rgba(239, 68, 68, 0.12);
      color: #dc2626;
    }
    
    .status-badge.info {
      background: rgba(59, 130, 246, 0.12);
      color: #2563eb;
    }
    
    /* ============ ENHANCED FORMS - Refined Inputs ============ */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-family: var(--font-body);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .form-group label .required {
      color: var(--danger);
      margin-left: 3px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      font-family: var(--font-body);
      font-size: var(--text-base);
      padding: 14px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    .form-group input:hover,
    .form-group select:hover,
    .form-group textarea:hover {
      border-color: var(--text-muted);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
      background: var(--bg-secondary);
    }

    .form-group input::placeholder,
    .form-group textarea::placeholder {
      color: var(--text-muted);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    /* ============ ENHANCED SEARCH - Premium Search Box ============ */
    .search-box,
    .search-input-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 12px;
      transition: all 0.2s ease;
    }

    .search-box:focus-within,
    .search-input-wrap:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
      background: var(--bg-secondary);
    }

    .search-box input,
    .search-input-wrap input {
      border: none;
      background: none;
      outline: none;
      font-family: var(--font-body);
      font-size: var(--text-base);
      color: var(--text-primary);
      width: 100%;
    }
    
    /* ============ ENHANCED MODALS - Cinematic Premium ============ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 24px;
      animation: overlayFadeIn 0.3s ease;
    }

    @keyframes overlayFadeIn {
      from { opacity: 0; backdrop-filter: blur(0); }
      to { opacity: 1; backdrop-filter: blur(8px); }
    }

    .modal {
      background: var(--bg-secondary, #0a1014);
      border: 1px solid var(--border);
      border-radius: 20px;
      width: 100%;
      max-width: 540px;
      max-height: 85vh;
      overflow: hidden;
      box-shadow:
        0 25px 50px -12px rgba(0, 0, 0, 0.5),
        0 0 0 1px rgba(255, 255, 255, 0.05) inset;
      animation: modalSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      display: flex;
      flex-direction: column;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-family: var(--font-display);
      font-size: var(--text-lg);
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: var(--danger);
      color: var(--danger);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    /* Modal footer with gradient edge */
    .modal-footer {
      padding: 20px 24px;
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    /* ============ ENHANCED NAVIGATION ============ */
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 11px 16px;
      margin: 2px 10px;
      color: rgba(255, 255, 255, 0.75);
      font-size: var(--text-sm);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-smooth);
      border: none;
      background: none;
      width: calc(100% - 20px);
      text-align: left;
      border-radius: 10px;
      position: relative;
    }
    
    .nav-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 0;
      background: var(--primary);
      border-radius: 0 3px 3px 0;
      transition: height var(--duration-fast);
    }
    
    .nav-item:hover {
      background: rgba(255, 255, 255, 0.08);
      color: white;
    }
    
    .nav-item:hover::before {
      height: 60%;
    }
    
    .nav-item.active {
      background: var(--gradient-primary);
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }
    
    .nav-item.active::before {
      display: none;
    }
    
    .nav-item .icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      opacity: 0.9;
      transition: transform var(--duration-fast);
    }
    
    .nav-item:hover .icon {
      transform: scale(1.15);
    }
    
    /* ============ ENHANCED PAGE HEADER ============ */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 28px;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .page-title {
      font-size: var(--text-2xl);
      font-weight: 800;
      color: var(--text-primary);
      letter-spacing: -0.8px;
      display: flex;
      align-items: center;
      gap: 14px;
    }
    
    .page-title .icon {
      font-size: 28px;
      opacity: 0.9;
    }
    
    /* ============ ENHANCED TABS ============ */
    .direction-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .direction-tab {
      padding: 10px 18px;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: 10px;
      color: var(--text-secondary);
      font-size: var(--text-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-smooth);
    }
    
    .direction-tab:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-2px);
    }
    
    .direction-tab.active {
      background: var(--gradient-primary);
      border-color: transparent;
      color: white;
      box-shadow: var(--shadow-glow-green);
    }
    
    /* Truck tabs */
    .truck-tabs-container button,
    .truck-tab {
      padding: 12px 20px !important;
      border-radius: 12px !important;
      font-weight: 700 !important;
      font-size: var(--text-base) !important;
      transition: all var(--duration-fast) var(--ease-smooth) !important;
    }
    
    .truck-tabs-container button:hover,
    .truck-tab:hover {
      transform: translateY(-2px) !important;
      box-shadow: var(--shadow-sm) !important;
    }
    
    .truck-tabs-container button.active,
    .truck-tab.active {
      background: var(--gradient-secondary) !important;
      box-shadow: var(--shadow-glow-blue) !important;
    }
    
    /* ============ ENHANCED TOAST ============ */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      border-radius: 14px;
      color: white;
      font-size: var(--text-base);
      font-weight: 600;
      z-index: 2000;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInRight var(--duration-normal) var(--ease-spring);
      box-shadow: var(--shadow-float);
      max-width: 400px;
    }
    
    .toast.success { background: var(--gradient-primary); }
    .toast.error { background: var(--gradient-danger); }
    .toast.warning { background: var(--gradient-warning); }
    .toast.info { background: var(--gradient-secondary); }
    
    /* ============ ENHANCED EMPTY STATE ============ */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 24px;
      text-align: center;
    }
    
    .empty-state-icon {
      font-size: 56px;
      margin-bottom: 20px;
      opacity: 0.4;
      animation: float 3s ease-in-out infinite;
    }
    
    .empty-state-title {
      font-size: var(--text-xl);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    
    .empty-state-text {
      font-size: var(--text-base);
      color: var(--text-muted);
      max-width: 320px;
      line-height: 1.6;
    }
    
    /* ============ ENHANCED DRIVER CARDS ============ */
    .driver-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-card);
      transition: all var(--duration-normal) var(--ease-smooth);
      position: relative;
      overflow: hidden;
    }
    
    .driver-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity var(--duration-fast);
    }
    
    .driver-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-card-hover);
      border-color: rgba(34, 197, 94, 0.4);
    }
    
    .driver-card:hover::before {
      opacity: 1;
    }
    
    .driver-avatar {
      width: 54px;
      height: 54px;
      border-radius: 14px;
      background: var(--gradient-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      box-shadow: var(--shadow-glow-green);
    }
    
    .driver-name {
      font-size: 17px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.3px;
    }
    
    /* ============ ACTION BUTTONS ============ */
    .action-btn {
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: var(--text-sm);
      font-weight: 600;
      transition: all var(--duration-fast);
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .action-btn.view {
      background: rgba(34, 197, 94, 0.1);
      color: #16a34a;
    }
    
    .action-btn.view:hover {
      background: rgba(34, 197, 94, 0.2);
      transform: translateY(-1px);
    }
    
    .action-btn.edit {
      background: rgba(59, 130, 246, 0.1);
      color: #2563eb;
    }
    
    .action-btn.edit:hover {
      background: rgba(59, 130, 246, 0.2);
      transform: translateY(-1px);
    }
    
    .action-btn.delete {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
    }
    
    .action-btn.delete:hover {
      background: rgba(239, 68, 68, 0.2);
      transform: translateY(-1px);
    }
    
    /* ============ SKELETON LOADING ============ */
    .skeleton {
      background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-hover) 50%, var(--bg-tertiary) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }
    
    .skeleton-text { height: 14px; margin-bottom: 8px; }
    .skeleton-title { height: 24px; width: 60%; margin-bottom: 12px; }
    .skeleton-card { height: 120px; border-radius: 16px; }
    
    /* ============ ENHANCED SCROLLBARS ============ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }
    
    /* ============ TOPBAR ENHANCEMENTS ============ */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }
    
    .topbar-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: var(--text-base);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--duration-fast);
      color: var(--text-secondary);
    }
    
    .topbar-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
    }
    
    /* ============ DARK THEME ENHANCEMENTS ============ */
    body.dark-theme {
      --glass-bg: rgba(30, 41, 59, 0.9);
      --glass-border: rgba(255, 255, 255, 0.08);
      --shadow-card: 0 1px 3px rgba(0,0,0,0.3), 0 4px 20px rgba(0,0,0,0.2);
      --shadow-card-hover: 0 8px 30px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.2);
      --gradient-card: linear-gradient(180deg, var(--bg-card) 0%, rgba(30, 41, 59, 0.5) 100%);
    }
    
    body.dark-theme .card::before,
    body.dark-theme .stat-card::after,
    body.dark-theme .driver-card::before {
      background: var(--gradient-primary);
    }
    
    body.dark-theme .card-header,
    body.dark-theme .modal-header {
      background: linear-gradient(180deg, var(--bg-card) 0%, rgba(30, 41, 59, 0.5) 100%);
    }
    
    body.dark-theme .stat-card .value {
      color: #f8fafc;
    }
    
    body.dark-theme .stat-card .value.green { color: #4ade80; }
    body.dark-theme .stat-card .value.red { color: #f87171; }
    body.dark-theme .stat-card .value.orange { color: #fbbf24; }
    body.dark-theme .stat-card .value.blue { color: #60a5fa; }
    
    body.dark-theme tr:hover td {
      background: rgba(34, 197, 94, 0.08);
    }
    
    /* ============ RESPONSIVE FIXES ============ */
    @media (max-width: 768px) {
      .stat-card .value { font-size: var(--text-2xl); }
      .page-title { font-size: var(--text-xl); }
      .card-header { padding: 16px 18px; }
      .modal { max-width: 95%; }
      td { padding: 12px 14px; max-width: 150px; }
      th { padding: 12px 14px; }
      .form-row { grid-template-columns: 1fr; }
    }
    
    /* ============ UTILITY CLASSES ============ */
    .animate-in { animation: fadeInUp var(--duration-normal) var(--ease-out-expo); }
    .animate-scale { animation: scaleIn var(--duration-normal) var(--ease-spring); }
    .animate-slide-right { animation: slideInRight var(--duration-normal) var(--ease-out-expo); }
    .hover-lift { transition: transform var(--duration-fast); }
    .hover-lift:hover { transform: translateY(-3px); }
    .hover-glow:hover { box-shadow: var(--shadow-glow-green); }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       ðŸŽ¬ ADDITIONAL SUBTLE ANIMATIONS & EFFECTS
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    /* ============ STAGGERED ENTRANCE ANIMATIONS - Premium Timing ============ */
    @keyframes staggerFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes cardEnter {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Stat cards stagger - premium timing */
    .stats-grid .stat-card:nth-child(1) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.1s both; }
    .stats-grid .stat-card:nth-child(2) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.15s both; }
    .stats-grid .stat-card:nth-child(3) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.2s both; }
    .stats-grid .stat-card:nth-child(4) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.25s both; }
    .stats-grid .stat-card:nth-child(5) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.3s both; }
    .stats-grid .stat-card:nth-child(6) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.35s both; }

    /* Driver cards stagger */
    .drivers-grid .driver-card:nth-child(1) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.1s both; }
    .drivers-grid .driver-card:nth-child(2) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.15s both; }
    .drivers-grid .driver-card:nth-child(3) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.2s both; }
    .drivers-grid .driver-card:nth-child(4) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.25s both; }
    .drivers-grid .driver-card:nth-child(5) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.3s both; }
    .drivers-grid .driver-card:nth-child(6) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.35s both; }

    /* Cards animate in */
    .card {
      animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    /* Number pop animation for stat values */
    .stat-card .value {
      display: inline-block;
      animation: numberPop 0.4s cubic-bezier(0.16, 1, 0.3, 1) 0.3s backwards;
    }

    @keyframes numberPop {
      from {
        opacity: 0;
        transform: scale(0.5);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Toast slide-in animation */
    .toast {
      animation: toastSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes toastSlideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Page title animation */
    .page-title {
      animation: titleEnter 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.1s both;
    }

    @keyframes titleEnter {
      from {
        opacity: 0;
        transform: translateY(-15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* ============ TABLE ROW ANIMATIONS ============ */
    @keyframes rowSlideIn {
      from { opacity: 0; transform: translateX(-8px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    tbody tr {
      animation: rowSlideIn 0.3s ease-out both;
    }
    
    tbody tr:nth-child(1) { animation-delay: 0.02s; }
    tbody tr:nth-child(2) { animation-delay: 0.04s; }
    tbody tr:nth-child(3) { animation-delay: 0.06s; }
    tbody tr:nth-child(4) { animation-delay: 0.08s; }
    tbody tr:nth-child(5) { animation-delay: 0.1s; }
    tbody tr:nth-child(6) { animation-delay: 0.12s; }
    tbody tr:nth-child(7) { animation-delay: 0.14s; }
    tbody tr:nth-child(8) { animation-delay: 0.16s; }
    tbody tr:nth-child(9) { animation-delay: 0.18s; }
    tbody tr:nth-child(10) { animation-delay: 0.2s; }
    
    /* Row hover lift effect */
    tbody tr {
      transition: transform var(--duration-fast), box-shadow var(--duration-fast);
    }
    
    tbody tr:hover {
      transform: scale(1.005);
      position: relative;
      z-index: 1;
    }
    
    /* ============ BUTTON ENHANCEMENTS ============ */
    /* Icon spin on hover for icon buttons */
    .btn-icon:hover .icon,
    .btn-icon:hover svg,
    .action-icon:hover {
      transition: transform 0.3s var(--ease-spring);
    }
    
    /* Subtle pulse on primary buttons */
    .btn-primary {
      position: relative;
    }
    
    .btn-primary::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: inherit;
      opacity: 0;
      z-index: -1;
      transition: opacity 0.3s, transform 0.3s;
    }
    
    .btn-primary:hover::before {
      opacity: 0.4;
      transform: scale(1.08);
      filter: blur(8px);
    }
    
    /* Action button icons */
    .action-btn {
      transition: all var(--duration-fast) var(--ease-smooth);
    }
    
    .action-btn:hover {
      transform: translateY(-2px) scale(1.02);
    }
    
    .action-btn:active {
      transform: translateY(0) scale(0.98);
    }
    
    /* ============ NAVIGATION ENHANCEMENTS ============ */
    /* Smooth icon transition */
    .nav-item .icon {
      transition: transform var(--duration-fast) var(--ease-spring), color var(--duration-fast);
    }
    
    .nav-item:hover .icon {
      transform: scale(1.15) rotate(-3deg);
    }
    
    .nav-item.active .icon {
      animation: none;
      transform: scale(1.1);
    }
    
    /* Nav badge pulse */
    .nav-badge {
      animation: pulse-soft 2s ease-in-out infinite;
    }
    
    /* ============ CARD HOVER EFFECTS ============ */
    /* Subtle inner glow on card hover */
    .card::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      opacity: 0;
      transition: opacity var(--duration-normal);
      background: radial-gradient(circle at 50% 0%, rgba(34, 197, 94, 0.08) 0%, transparent 60%);
      pointer-events: none;
    }
    
    .card:hover::after {
      opacity: 1;
    }
    
    /* Stat card icon bounce on hover */
    .stat-card:hover .stat-icon {
      animation: iconBounce 0.4s var(--ease-spring);
    }
    
    @keyframes iconBounce {
      0%, 100% { transform: scale(1.1) rotate(0deg); }
      30% { transform: scale(1.2) rotate(-5deg); }
      60% { transform: scale(1.05) rotate(3deg); }
    }
    
    /* ============ DRIVER CARD AVATAR ============ */
    .driver-avatar {
      transition: transform var(--duration-normal) var(--ease-spring), box-shadow var(--duration-normal);
    }
    
    .driver-card:hover .driver-avatar {
      transform: scale(1.1) rotate(-5deg);
      box-shadow: 0 8px 20px rgba(34, 197, 94, 0.35);
    }
    
    /* ============ BADGE HOVER ============ */
    .badge {
      transition: all var(--duration-fast) var(--ease-smooth);
    }
    
    .badge:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
    }
    
    /* Status badge dot pulse */
    .status-badge::before {
      animation: pulse-soft 2s ease-in-out infinite;
    }
    
    /* ============ FORM FOCUS EFFECTS ============ */
    .form-group input,
    .form-group select,
    .form-group textarea {
      transition: all var(--duration-fast) var(--ease-smooth), box-shadow var(--duration-normal);
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      transform: translateY(-1px);
    }
    
    /* ============ SEARCH BOX ANIMATION ============ */
    .search-box,
    .search-input-wrap {
      transition: all var(--duration-fast) var(--ease-smooth);
    }
    
    .search-box:focus-within,
    .search-input-wrap:focus-within {
      transform: translateY(-1px);
    }
    
    /* Search icon animation */
    .search-box:focus-within .search-icon,
    .search-input-wrap:focus-within .search-icon {
      animation: searchPulse 0.3s var(--ease-spring);
    }
    
    @keyframes searchPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }
    
    /* ============ MODAL ENHANCEMENTS ============ */
    /* Modal content slide up */
    .modal-body {
      animation: modalContentIn 0.3s ease-out 0.1s both;
    }
    
    @keyframes modalContentIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Modal close button */
    .modal-close {
      transition: all var(--duration-fast) var(--ease-spring);
    }
    
    .modal-close:hover {
      transform: rotate(90deg) scale(1.1);
    }

    /* ============ ROUTE SEQUENCE STYLES ============ */
    .sequence-container {
      max-height: 60vh;
      overflow-y: auto;
      padding: 8px;
    }

    .sequence-item {
      user-select: none;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .sequence-item:hover {
      transform: translateX(4px);
    }

    .sequence-item:active {
      cursor: grabbing;
      opacity: 0.9;
    }

    .drag-handle {
      cursor: grab;
    }

    .drag-handle:active {
      cursor: grabbing;
    }

    /* ============ TOPBAR BUTTON EFFECTS ============ */
    .topbar-btn {
      transition: all var(--duration-fast) var(--ease-smooth);
    }
    
    .topbar-btn:hover {
      transform: translateY(-2px);
    }
    
    .topbar-btn:active {
      transform: translateY(0) scale(0.98);
    }
    
    /* Notification badge bounce */
    .notification-badge {
      animation: badgeBounce 0.5s var(--ease-spring);
    }
    
    @keyframes badgeBounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    
    /* ============ TABS ANIMATION ============ */
    .direction-tab,
    .truck-tab {
      transition: all var(--duration-fast) var(--ease-smooth) !important;
    }
    
    .direction-tab:active,
    .truck-tab:active {
      transform: scale(0.96) !important;
    }
    
    .direction-tab.active,
    .truck-tab.active {
      animation: tabActivate 0.3s var(--ease-spring);
    }
    
    @keyframes tabActivate {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.03); }
    }
    
    /* ============ PROGRESS BAR ANIMATION ============ */
    /* Animated fill for progress bars */
    [style*="height:8px"][style*="border-radius:4px"] > div,
    [style*="height: 8px"][style*="border-radius: 4px"] > div {
      animation: progressFill 0.8s ease-out both;
      transform-origin: left;
    }
    
    @keyframes progressFill {
      from { transform: scaleX(0); }
      to { transform: scaleX(1); }
    }
    
    /* ============ AVATAR HOVER ============ */
    .table-avatar,
    .topbar-avatar,
    .user-avatar {
      transition: transform var(--duration-fast) var(--ease-spring), box-shadow var(--duration-fast);
    }
    
    .table-avatar:hover,
    .topbar-avatar:hover,
    .user-avatar:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }
    
    /* ============ WORLD CLOCK PULSE ============ */
    .world-clock {
      transition: all var(--duration-fast);
    }
    
    .world-clock:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
    
    .clock-time {
      transition: color var(--duration-fast);
    }
    
    /* ============ TOAST ENHANCEMENTS ============ */
    .toast {
      animation: toastIn 0.4s var(--ease-spring);
    }
    
    @keyframes toastIn {
      0% { opacity: 0; transform: translateX(100%) scale(0.9); }
      100% { opacity: 1; transform: translateX(0) scale(1); }
    }
    
    /* Toast exit animation (add via JS) */
    .toast.exiting {
      animation: toastOut 0.3s ease-in forwards;
    }
    
    @keyframes toastOut {
      0% { opacity: 1; transform: translateX(0) scale(1); }
      100% { opacity: 0; transform: translateX(100%) scale(0.9); }
    }
    
    /* ============ DROPDOWN ANIMATIONS ============ */
    .topbar-dropdown,
    .notification-dropdown {
      animation: dropdownIn 0.2s var(--ease-out-expo);
      transform-origin: top right;
    }
    
    @keyframes dropdownIn {
      from { opacity: 0; transform: scale(0.95) translateY(-8px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    
    .topbar-dropdown-item,
    .notification-item {
      transition: all var(--duration-instant);
    }
    
    .topbar-dropdown-item:hover,
    .notification-item:hover {
      transform: translateX(4px);
    }
    
    /* ============ MINI CHAT BUBBLE ============ */
    .mini-chat-bubble {
      transition: all var(--duration-fast) var(--ease-spring);
    }
    
    .mini-chat-bubble:hover {
      transform: scale(1.08);
    }
    
    .mini-chat-bubble:active {
      transform: scale(0.95);
    }
    
    /* Chat bubble pulse when has messages */
    .mini-chat-bubble:has(.badge) {
      animation: chatPulse 2s ease-in-out infinite;
    }
    
    @keyframes chatPulse {
      0%, 100% { box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4); }
      50% { box-shadow: 0 4px 30px rgba(34, 197, 94, 0.6); }
    }
    
    /* ============ SIDEBAR TOGGLE ============ */
    .sidebar-toggle {
      transition: all var(--duration-fast) var(--ease-spring);
    }
    
    .sidebar-toggle:hover {
      transform: scale(1.15);
    }
    
    .sidebar-toggle:active {
      transform: scale(0.95);
    }
    
    /* ============ LOGOUT BUTTON ============ */
    .logout-btn {
      transition: all var(--duration-fast) var(--ease-smooth);
    }
    
    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25);
    }
    
    /* ============ LOADING SPINNER ENHANCEMENT ============ */
    .spinner {
      animation: spin 0.7s linear infinite;
    }
    
    .loading {
      animation: fadeInUp 0.3s ease-out;
    }
    
    /* ============ EMPTY STATE ICON ============ */
    .empty-state-icon {
      animation: float 3s ease-in-out infinite, fadeInScale 0.5s ease-out;
    }
    
    /* ============ HOVER REVEAL FOR ACTIONS ============ */
    /* Actions become more visible on row hover */
    .actions,
    .action-icons {
      opacity: 0.7;
      transition: opacity var(--duration-fast);
    }
    
    tr:hover .actions,
    tr:hover .action-icons {
      opacity: 1;
    }
    
    /* ============ LINK HOVER UNDERLINE ============ */
    a, .link-style {
      position: relative;
    }
    
    /* ============ CHECKBOX/TOGGLE ANIMATION ============ */
    .toggle-switch {
      transition: all var(--duration-fast) var(--ease-smooth);
    }
    
    .toggle-switch::after {
      transition: all var(--duration-fast) var(--ease-spring);
    }
    
    .toggle-switch:hover {
      transform: scale(1.05);
    }
    
    .toggle-switch.active::after {
      animation: toggleOn 0.3s var(--ease-spring);
    }
    
    @keyframes toggleOn {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }
    
    /* ============ SUBTLE HOVER GLOW FOR MONEY VALUES ============ */
    .money {
      transition: all var(--duration-fast);
    }
    
    tr:hover .money.positive,
    tr:hover td.money {
      text-shadow: 0 0 8px rgba(34, 197, 94, 0.3);
    }
    
    tr:hover .money.negative {
      text-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
    }
    
    /* ============ PAGE HEADER ANIMATION ============ */
    .page-header,
    .header {
      animation: slideInLeft 0.4s var(--ease-out-expo);
    }
    
    .page-title,
    .header h2 {
      display: inline-flex;
      align-items: center;
      gap: 12px;
    }
    
    .page-title .icon,
    .header h2 .icon {
      display: inline-block;
      transition: transform var(--duration-fast) var(--ease-spring);
    }
    
    .page-header:hover .page-title .icon,
    .header:hover h2 .icon {
      transform: rotate(-5deg) scale(1.1);
    }
    
    /* ============ SMOOTH COLOR TRANSITIONS ============ */
    * {
      transition-property: color, background-color, border-color, box-shadow, opacity;
      transition-duration: 0;
    }
    
    a, button, .btn, .nav-item, .badge, .card, input, select, textarea {
      transition-duration: var(--duration-fast);
    }
    
    /* ============ STICKY ACTIONS COLUMN ============ */
    /* Must be at end for highest CSS specificity */
    table th.sticky-col,
    table td.sticky-col {
      position: sticky !important;
      right: 0 !important;
      box-shadow: -4px 0 8px rgba(0,0,0,0.15);
    }
    table td.sticky-col {
      z-index: 2 !important;
      background: #ffffff !important;
    }
    table th.sticky-col {
      top: 0 !important;
      right: 0 !important;
      z-index: 12 !important;
      background: #f1f5f9 !important;
    }
    [data-theme="dark"] table td.sticky-col {
      background: #1e293b !important;
    }
    [data-theme="dark"] table th.sticky-col {
      background: #334155 !important;
    }

    /* ============ ENHANCED MOBILE TABLE STYLES ============ */
    @media (max-width: 768px) {
      /* Table wrapper with scroll indicators */
      .table-wrapper {
        position: relative;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
      }

      /* Scroll indicator shadows */
      .table-wrapper::before,
      .table-wrapper::after {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        width: 20px;
        pointer-events: none;
        z-index: 5;
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .table-wrapper::before {
        left: 0;
        background: linear-gradient(to right, rgba(0,0,0,0.1), transparent);
      }

      .table-wrapper::after {
        right: 0;
        background: linear-gradient(to left, rgba(0,0,0,0.1), transparent);
      }

      .table-wrapper.scrolled-left::before {
        opacity: 1;
      }

      .table-wrapper.scrolled-right::after {
        opacity: 1;
      }

      /* Larger touch targets for mobile */
      table td .action-btn,
      table td button {
        min-width: 44px;
        min-height: 44px;
        padding: 10px;
      }

      /* Mobile-friendly table cells */
      table th,
      table td {
        padding: 12px 10px;
        font-size: 13px;
      }

      /* First column sticky on mobile for context */
      table th:first-child,
      table td:first-child {
        position: sticky;
        left: 0;
        z-index: 3;
        background: inherit;
        box-shadow: 4px 0 8px rgba(0,0,0,0.1);
      }

      /* Card-style table rows on very small screens */
      @media (max-width: 480px) {
        .table-responsive-cards table,
        .table-responsive-cards thead,
        .table-responsive-cards tbody,
        .table-responsive-cards th,
        .table-responsive-cards td,
        .table-responsive-cards tr {
          display: block;
        }

        .table-responsive-cards thead tr {
          position: absolute;
          top: -9999px;
          left: -9999px;
        }

        .table-responsive-cards tr {
          background: var(--bg-card);
          border: 1px solid var(--border);
          border-radius: var(--radius);
          margin-bottom: 12px;
          padding: 12px;
        }

        .table-responsive-cards td {
          border: none;
          padding: 8px 0;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .table-responsive-cards td::before {
          content: attr(data-label);
          font-weight: 600;
          color: var(--text-muted);
          font-size: 12px;
          text-transform: uppercase;
        }
      }
    }

    /* ============ REDUCE MOTION FOR ACCESSIBILITY ============ */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ============ SKIP LINK FOR ACCESSIBILITY ============ */
    .skip-link {
      position: absolute;
      top: -50px;
      left: 16px;
      background: var(--primary);
      color: #000;
      padding: 12px 24px;
      border-radius: var(--radius);
      font-weight: 600;
      z-index: 10000;
      text-decoration: none;
      transition: top 0.2s ease;
    }
    .skip-link:focus {
      top: 16px;
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }

    /* Screen reader only - visually hidden but accessible */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Focus visible for keyboard navigation */
    :focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Live region for dynamic announcements */
    .aria-live-region {
      position: absolute;
      left: -10000px;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }

    /* Inline spinner for buttons */
    .spinner-inline {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Skeleton loading animation */
    @keyframes skeleton-pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }

    /* Loading state container */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Skip to Main Content Link for Accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-logo">
      <div class="loading-logo-icon">ðŸš›</div>
      Horizon <span>Star</span>
    </div>
    <div class="loading-truck">
      <div class="truck">ðŸš›</div>
      <div class="road"></div>
    </div>
    <div class="loading-text">
      <span id="loading-message">Logging out</span>
      <div class="loading-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>

  <div id="app"></div>
  <script>
    // ============ SUPABASE CLIENT SETUP ============
    const SUPABASE_URL = 'https://yrrczhlzulwvdqjwvhtu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlycmN6aGx6dWx3dmRxand2aHR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NDYyOTQsImV4cCI6MjA4MTEyMjI5NH0.qVVxDH36OkLXnUe3Sfng1CJY7_Qt_IOGC-1QaDw6WlE';
    
    // Initialize Supabase client
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Current auth session
    let authSession = null;
    
    // Get current access token for API calls
    function getAccessToken() {
      return authSession?.access_token || SUPABASE_KEY;
    }

    // ============ GLOBAL ERROR HANDLER ============
    // Catch unhandled errors to prevent silent failures
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('Unhandled error:', message, 'at', source, lineno + ':' + colno);
      // Show user-friendly message (showToast will be available after app loads)
      if (typeof showToast === 'function') {
        showToast('Something went wrong. Please try again or refresh the page.', 'error');
      }
      return false; // Let error propagate for debugging
    };

    // Catch unhandled promise rejections
    window.addEventListener('unhandledrejection', function(event) {
      console.error('Unhandled promise rejection:', event.reason);
      if (typeof showToast === 'function') {
        showToast('A network or data error occurred. Please try again.', 'error');
      }
    });

    // ============ KEYBOARD SHORTCUTS ============
    const keyboardShortcuts = {
      enabled: true,
      shortcuts: {
        'k': { ctrl: true, action: 'search', description: 'Quick Search' },
        'n': { ctrl: true, action: 'new', description: 'New Item' },
        'd': { ctrl: true, shift: true, action: 'dashboard', description: 'Go to Dashboard' },
        't': { ctrl: true, shift: true, action: 'trips', description: 'Go to Trips' },
        '/': { action: 'help', description: 'Show Shortcuts' },
        'Escape': { action: 'close', description: 'Close Modal' }
      }
    };

    // Keyboard shortcut handler
    document.addEventListener('keydown', function(e) {
      // Skip if typing in input/textarea
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
        // Only handle Escape in inputs
        if (e.key === 'Escape') {
          e.target.blur();
          closeAllModals();
        }
        return;
      }

      // Ctrl/Cmd + K - Quick Search
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        openQuickSearch();
        return;
      }

      // Ctrl/Cmd + N - New Item (context-aware)
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        triggerNewItem();
        return;
      }

      // Ctrl/Cmd + Shift + D - Dashboard
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'D') {
        e.preventDefault();
        if (typeof navigate === 'function') navigate('dashboard');
        return;
      }

      // Ctrl/Cmd + Shift + T - Trips
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'T') {
        e.preventDefault();
        if (typeof navigate === 'function') navigate('trips');
        return;
      }

      // ? or / - Show keyboard shortcuts help
      if (e.key === '?' || (e.key === '/' && !e.ctrlKey)) {
        e.preventDefault();
        showKeyboardShortcutsHelp();
        return;
      }

      // Escape - Close modals
      if (e.key === 'Escape') {
        closeAllModals();
        return;
      }

      // Number keys 1-9 for quick navigation
      if (/^[1-9]$/.test(e.key) && !e.ctrlKey && !e.metaKey && !e.altKey) {
        const navPages = ['dashboard', 'trips', 'orders', 'drivers', 'trucks', 'fuel', 'ifta', 'payroll', 'settings'];
        const pageIndex = parseInt(e.key) - 1;
        if (pageIndex < navPages.length && typeof navigate === 'function') {
          navigate(navPages[pageIndex]);
          showToast('Navigated to ' + navPages[pageIndex].charAt(0).toUpperCase() + navPages[pageIndex].slice(1));
        }
      }
    });

    // Quick search modal
    function openQuickSearch() {
      const existing = document.querySelector('.quick-search-overlay');
      if (existing) {
        existing.remove();
        return;
      }

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay quick-search-overlay';
      overlay.style.cssText = 'display:flex;align-items:flex-start;justify-content:center;padding-top:15vh';
      overlay.innerHTML = `
        <div class="modal" style="max-width:500px;width:100%;margin:0 16px">
          <div style="padding:20px">
            <input type="text" id="quickSearchInput" placeholder="Search pages, trips, drivers..."
                   style="width:100%;padding:14px 18px;font-size:16px;border:2px solid var(--primary);border-radius:var(--radius);background:var(--bg-secondary);color:var(--text-primary)"
                   autocomplete="off">
            <div id="quickSearchResults" style="margin-top:16px;max-height:300px;overflow-y:auto"></div>
            <div style="margin-top:12px;font-size:12px;color:var(--text-muted);display:flex;gap:16px">
              <span>â†‘â†“ Navigate</span>
              <span>â†µ Select</span>
              <span>Esc Close</span>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);

      const input = document.getElementById('quickSearchInput');
      input.focus();

      input.addEventListener('input', handleQuickSearch);
      input.addEventListener('keydown', handleQuickSearchNav);
      overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
    }

    function handleQuickSearch(e) {
      const query = e.target.value.toLowerCase();
      const results = document.getElementById('quickSearchResults');

      if (!query) {
        results.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:20px">Start typing to search...</div>';
        return;
      }

      // Search pages
      const pages = [
        { name: 'Dashboard', page: 'dashboard', icon: 'ðŸ“Š' },
        { name: 'Trips', page: 'trips', icon: 'ðŸš›' },
        { name: 'Orders', page: 'orders', icon: 'ðŸ“¦' },
        { name: 'Drivers', page: 'drivers', icon: 'ðŸ‘¥' },
        { name: 'Trucks', page: 'trucks', icon: 'ðŸšš' },
        { name: 'Fuel', page: 'fuel', icon: 'â›½' },
        { name: 'IFTA', page: 'ifta', icon: 'ðŸ“‹' },
        { name: 'Payroll', page: 'payroll', icon: 'ðŸ’°' },
        { name: 'Chat', page: 'team_chat', icon: 'ðŸ’¬' },
        { name: 'Settings', page: 'settings', icon: 'âš™ï¸' }
      ];

      const matchedPages = pages.filter(p => p.name.toLowerCase().includes(query));

      if (matchedPages.length === 0) {
        results.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:20px">No results found</div>';
        return;
      }

      results.innerHTML = matchedPages.map((p, i) => `
        <div class="quick-search-item${i === 0 ? ' selected' : ''}" data-page="${p.page}"
             style="padding:12px 16px;cursor:pointer;border-radius:var(--radius);display:flex;align-items:center;gap:12px;${i === 0 ? 'background:var(--primary-light)' : ''}"
             onmouseover="this.style.background='var(--bg-hover)';selectQuickSearchItem(this)"
             onclick="navigateFromQuickSearch('${p.page}')">
          <span style="font-size:20px">${p.icon}</span>
          <span style="font-weight:500">${p.name}</span>
        </div>
      `).join('');
    }

    function handleQuickSearchNav(e) {
      const results = document.getElementById('quickSearchResults');
      const items = results.querySelectorAll('.quick-search-item');
      const selected = results.querySelector('.quick-search-item.selected');

      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        e.preventDefault();
        if (!items.length) return;

        let idx = Array.from(items).indexOf(selected);
        idx = e.key === 'ArrowDown' ? Math.min(idx + 1, items.length - 1) : Math.max(idx - 1, 0);

        items.forEach(i => { i.classList.remove('selected'); i.style.background = ''; });
        items[idx].classList.add('selected');
        items[idx].style.background = 'var(--primary-light)';
        items[idx].scrollIntoView({ block: 'nearest' });
      }

      if (e.key === 'Enter' && selected) {
        e.preventDefault();
        navigateFromQuickSearch(selected.dataset.page);
      }
    }

    function selectQuickSearchItem(item) {
      document.querySelectorAll('.quick-search-item').forEach(i => {
        i.classList.remove('selected');
        i.style.background = '';
      });
      item.classList.add('selected');
      item.style.background = 'var(--primary-light)';
    }

    function navigateFromQuickSearch(page) {
      document.querySelector('.quick-search-overlay')?.remove();
      if (typeof navigate === 'function') navigate(page);
    }

    // Trigger new item based on current page
    function triggerNewItem() {
      const newItemActions = {
        'trips': 'openTripModal',
        'orders': 'openOrderModal',
        'drivers': 'openDriverModal',
        'trucks': 'openTruckModal',
        'brokers': 'openBrokerModal',
        'tasks': 'openTaskModal',
        'fuel': 'openFuelModal',
        'future_cars': 'openLoadBoardOrder'
      };

      const action = newItemActions[typeof currentPage !== 'undefined' ? currentPage : ''];
      if (action && typeof window[action] === 'function') {
        window[action]();
      } else {
        showToast('Press + button to create new item on this page', 'info');
      }
    }

    // Close all modals
    function closeAllModals() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.remove());
    }

    // Show keyboard shortcuts help
    function showKeyboardShortcutsHelp() {
      const existing = document.querySelector('.shortcuts-help-overlay');
      if (existing) { existing.remove(); return; }

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay shortcuts-help-overlay';
      overlay.innerHTML = `
        <div class="modal" style="max-width:450px">
          <div class="modal-header">
            <h3>âŒ¨ï¸ Keyboard Shortcuts</h3>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
          </div>
          <div style="padding:20px">
            <div style="display:grid;gap:12px">
              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
                <span>Quick Search</span><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;font-family:monospace">Ctrl + K</kbd>
              </div>
              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
                <span>New Item</span><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;font-family:monospace">Ctrl + N</kbd>
              </div>
              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
                <span>Go to Dashboard</span><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;font-family:monospace">Ctrl + Shift + D</kbd>
              </div>
              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
                <span>Go to Trips</span><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;font-family:monospace">Ctrl + Shift + T</kbd>
              </div>
              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
                <span>Quick Navigate</span><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;font-family:monospace">1 - 9</kbd>
              </div>
              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
                <span>Close Modal</span><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;font-family:monospace">Esc</kbd>
              </div>
              <div style="display:flex;justify-content:space-between;padding:8px 0">
                <span>Show This Help</span><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;font-family:monospace">?</kbd>
              </div>
            </div>
            <div style="margin-top:16px;font-size:12px;color:var(--text-muted);text-align:center">
              Use <strong>Cmd</strong> instead of Ctrl on Mac
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
    }

    // ============ DATABASE FUNCTIONS ============
    async function dbFetch(table, options = {}) {
      let query = sb.from(table).select(options.select || '*');
      
      if (options.filter) {
        Object.entries(options.filter).forEach(([key, value]) => {
          // Parse filter like "email=eq.test@example.com"
          if (value.startsWith('eq.')) {
            query = query.eq(key, value.substring(3));
          } else if (value.startsWith('neq.')) {
            query = query.neq(key, value.substring(4));
          } else if (value.startsWith('gt.')) {
            query = query.gt(key, value.substring(3));
          } else if (value.startsWith('gte.')) {
            query = query.gte(key, value.substring(4));
          } else if (value.startsWith('lt.')) {
            query = query.lt(key, value.substring(3));
          } else if (value.startsWith('lte.')) {
            query = query.lte(key, value.substring(4));
          } else if (value.startsWith('like.')) {
            query = query.like(key, value.substring(5));
          } else if (value.startsWith('ilike.')) {
            query = query.ilike(key, value.substring(6));
          } else {
            query = query.eq(key, value);
          }
        });
      }
      
      if (options.order) {
        const [column, direction] = options.order.split('.');
        query = query.order(column, { ascending: direction !== 'desc' });
      }
      
      const { data, error } = await query;
      if (error) throw error;
      return data || [];
    }

    async function dbInsert(table, data) {
      const { data: result, error } = await sb
        .from(table)
        .insert(data)
        .select()
        .single();
      
      if (error) throw new Error(error.message || 'Insert failed');
      
      // Track that we just made a change (for realtime sync)
      window.lastSaveTimestamp = Date.now();
      
      // Invalidate cache so next load gets fresh data
      dataCache.invalidate('appData');
      
      return result;
    }

    // Store original updated_at when opening edit modals
    let editingRecords = {};
    
    function startEditing(table, id, updatedAt) {
      editingRecords[table + '_' + id] = updatedAt || new Date().toISOString();
    }
    
    function getEditingTimestamp(table, id) {
      return editingRecords[table + '_' + id];
    }
    
    function clearEditing(table, id) {
      delete editingRecords[table + '_' + id];
    }
    
    async function dbUpdate(table, id, data, skipConflictCheck = false) {
      // Check for conflicts on important tables
      if (!skipConflictCheck && ['trips', 'orders', 'drivers', 'trucks'].includes(table)) {
        const originalTimestamp = getEditingTimestamp(table, id);
        if (originalTimestamp) {
          // Fetch current record to check if it was modified
          const { data: current } = await sb.from(table).select('updated_at').eq('id', id).single();
          if (current && current.updated_at && current.updated_at !== originalTimestamp) {
            const confirmOverwrite = confirm(
              'âš ï¸ This record was modified by another user while you were editing.\n\n' +
              'Click OK to save your changes anyway (will overwrite their changes)\n' +
              'Click Cancel to refresh and see the latest version'
            );
            if (!confirmOverwrite) {
              await loadAllData(true); // Force refresh
              showToast('Data refreshed - please review and try again', 'info');
              return null; // Signal that save was cancelled
            }
          }
        }
      }
      
      const { data: result, error } = await sb
        .from(table)
        .update(data)
        .eq('id', id)
        .select();
      
      if (error) throw new Error(error.message || 'Update failed');
      
      // Track that we just made a change (for realtime sync)
      window.lastSaveTimestamp = Date.now();
      
      // Clear editing tracker
      clearEditing(table, id);
      
      // Invalidate cache so next load gets fresh data
      dataCache.invalidate('appData');
      
      return result;
    }

    async function dbDelete(table, id) {
      const { error } = await sb
        .from(table)
        .delete()
        .eq('id', id);
      
      if (error) throw new Error(error.message || 'Delete failed');
      
      // Track that we just made a change (for realtime sync)
      window.lastSaveTimestamp = Date.now();
      
      // Invalidate cache so next load gets fresh data
      dataCache.invalidate('appData');
    }

    // ============ SECURITY FUNCTIONS ============
    
    // Password Hashing using SHA-256
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password + 'horizonstar_salt_2024');
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
    
    // Login Attempt Tracking
    const LOGIN_ATTEMPT_LIMIT = 5;
    const LOGIN_LOCKOUT_MINUTES = 15;
    
    function getLoginAttempts(email) {
      const attempts = JSON.parse(localStorage.getItem('login_attempts') || '{}');
      return attempts[email] || { count: 0, lastAttempt: 0, lockedUntil: 0 };
    }
    
    function recordLoginAttempt(email, success) {
      const attempts = JSON.parse(localStorage.getItem('login_attempts') || '{}');
      const now = Date.now();
      
      if (success) {
        // Clear attempts on successful login
        delete attempts[email];
      } else {
        // Increment failed attempts
        if (!attempts[email]) {
          attempts[email] = { count: 0, lastAttempt: 0, lockedUntil: 0 };
        }
        attempts[email].count++;
        attempts[email].lastAttempt = now;
        
        // Lock account after too many attempts
        if (attempts[email].count >= LOGIN_ATTEMPT_LIMIT) {
          attempts[email].lockedUntil = now + (LOGIN_LOCKOUT_MINUTES * 60 * 1000);
        }
      }
      
      localStorage.setItem('login_attempts', JSON.stringify(attempts));
      return attempts[email];
    }
    
    function isAccountLocked(email) {
      const attempts = getLoginAttempts(email);
      if (attempts.lockedUntil && Date.now() < attempts.lockedUntil) {
        const remainingMinutes = Math.ceil((attempts.lockedUntil - Date.now()) / 60000);
        return { locked: true, remainingMinutes };
      }
      // Reset if lockout expired
      if (attempts.lockedUntil && Date.now() >= attempts.lockedUntil) {
        const allAttempts = JSON.parse(localStorage.getItem('login_attempts') || '{}');
        delete allAttempts[email];
        localStorage.setItem('login_attempts', JSON.stringify(allAttempts));
      }
      return { locked: false };
    }
    
    // Session Timeout Management
    const SESSION_TIMEOUT_MINUTES = 60; // 1 hour
    let sessionTimeoutId = null;
    let lastActivityTime = Date.now();
    
    function updateLastActivity() {
      lastActivityTime = Date.now();
      localStorage.setItem('last_activity', lastActivityTime.toString());
    }
    
    function checkSessionTimeout() {
      const storedLastActivity = parseInt(localStorage.getItem('last_activity') || '0');
      const timeout = SESSION_TIMEOUT_MINUTES * 60 * 1000;
      
      // If no last_activity set, this is likely a fresh login - set it now
      if (storedLastActivity === 0) {
        localStorage.setItem('last_activity', Date.now().toString());
        return false; // Don't expire, treat as fresh session
      }
      
      if (currentUser && (Date.now() - storedLastActivity) > timeout) {
        sessionExpired();
        return true;
      }
      return false;
    }
    
    function sessionExpired() {
      currentUser = null;
      localStorage.removeItem('horizonstar_user');
      localStorage.removeItem('last_activity');
      showToast('Session expired. Please log in again.', 'warning');
      renderLogin();
    }
    
    function startSessionMonitor() {
      // Update activity on user interactions
      ['click', 'keypress', 'mousemove', 'scroll'].forEach(event => {
        document.addEventListener(event, updateLastActivity, { passive: true });
      });
      
      // Check session every minute
      if (sessionTimeoutId) clearInterval(sessionTimeoutId);
      sessionTimeoutId = setInterval(() => {
        if (currentUser) checkSessionTimeout();
      }, 60000);
      
      updateLastActivity();
    }
    
    // ============ REAL-TIME COLLABORATION ============
    let realtimeChannel = null;
    
    function startRealtimeSync() {
      if (!sb || realtimeChannel) return;
      
      // Subscribe to changes on key tables
      realtimeChannel = sb
        .channel('tms-realtime')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'trips' }, handleRealtimeChange)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, handleRealtimeChange)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'drivers' }, handleRealtimeChange)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'trucks' }, handleRealtimeChange)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'expenses' }, handleRealtimeChange)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'chat_messages' }, handleChatRealtimeChange)
        .subscribe((status) => {
          if (status === 'SUBSCRIBED') {
            console.log('âœ… Real-time sync active');
          }
        });
    }
    
    // Debounce realtime updates to avoid too many refreshes
    let realtimeDebounceTimer = null;
    let pendingRealtimeUpdate = false;
    
    function handleRealtimeChange(payload) {
      // Don't refresh if we just made the change ourselves (within last 3 seconds)
      const timeSinceLastSave = Date.now() - (window.lastSaveTimestamp || 0);
      if (timeSinceLastSave < 3000) {
        return; // Skip - this is likely our own change
      }

      // Debounce multiple rapid changes
      pendingRealtimeUpdate = true;
      if (realtimeDebounceTimer) clearTimeout(realtimeDebounceTimer);

      realtimeDebounceTimer = setTimeout(async () => {
        if (!pendingRealtimeUpdate) return;
        pendingRealtimeUpdate = false;

        // Show notification
        const table = payload.table;
        const action = payload.eventType;
        const tableNames = { trips: 'Trip', orders: 'Vehicle', drivers: 'Driver', trucks: 'Truck', expenses: 'Expense' };
        const actionNames = { INSERT: 'added', UPDATE: 'updated', DELETE: 'deleted' };

        showToast('ðŸ”„ ' + (tableNames[table] || table) + ' ' + (actionNames[action] || 'changed') + ' by another user', 'info');

        // Refresh data
        await loadAllData(true);

        // Respect current detail view - don't navigate away
        if (currentDetailView) {
          // Re-render the detail view instead of the page list
          if (currentDetailView.type === 'trip') {
            viewTrip(currentDetailView.id);
          } else if (currentDetailView.type === 'driver') {
            viewDriver(currentDetailView.id);
          } else if (currentDetailView.type === 'truck') {
            viewTruck(currentDetailView.id);
          } else {
            renderPage();
          }
        } else {
          renderPage();
        }
      }, 1000); // Wait 1 second for any additional changes
    }
    
    function handleChatRealtimeChange(payload) {
      // For chat, just trigger a re-render of chat if we're on that page
      if (payload.eventType === 'INSERT' && currentPage === 'team_chat') {
        const timeSinceLastSave = Date.now() - (window.lastSaveTimestamp || 0);
        if (timeSinceLastSave < 2000) return;
        
        // Reload chat messages
        loadAllData(true).then(() => {
          const main = document.getElementById('main-content');
          if (main && currentPage === 'team_chat') renderTeamChat(main);
        });
      }
    }
    
    function stopRealtimeSync() {
      if (realtimeChannel) {
        sb.removeChannel(realtimeChannel);
        realtimeChannel = null;
        console.log('Real-time sync stopped');
      }
    }
    
    // Activity Logging
    async function logActivity(action, details = {}) {
      try {
        await dbInsert('activity_log', {
          user_id: currentUser?.id || null,
          user_email: currentUser?.email || details.email || 'unknown',
          action: action,
          details: JSON.stringify(details),
          ip_address: 'client', // Can't get real IP from client
          created_at: new Date().toISOString()
        });
      } catch (e) {
        // Activity log table may not exist, fail silently
        console.log('Activity log:', action, details);
      }
    }
    
    // Password Reset Token Generation
    function generateResetToken() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
    }

    let currentUser = JSON.parse(localStorage.getItem('horizonstar_user') || 'null');
    let currentPage = 'dashboard';
    let currentLang = 'en';
    let appData = { users: [], trucks: [], drivers: [], local_drivers: [], dispatchers: [], trips: [], orders: [], expenses: [], fixed_costs: [], variable_costs: [], driver_files: [], truck_files: [], brokers: [], fuel_transactions: [], maintenance_records: [], claims: [], tickets: [], violations: [], ticket_files: [], violation_files: [], claim_files: [], compliance_tasks: [], accidents: [] };
    
    // ============ DEBOUNCE UTILITY ============
    function debounce(func, wait = 300) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // ============ DATA CACHE ============
    const dataCache = {
      data: {},
      timestamps: {},
      maxAge: 5 * 60 * 1000, // 5 minutes cache
      
      set(key, value) {
        this.data[key] = value;
        this.timestamps[key] = Date.now();
      },
      
      get(key) {
        if (!this.data[key]) return null;
        if (Date.now() - this.timestamps[key] > this.maxAge) {
          delete this.data[key];
          delete this.timestamps[key];
          return null;
        }
        return this.data[key];
      },
      
      invalidate(key) {
        if (key) {
          delete this.data[key];
          delete this.timestamps[key];
        } else {
          this.data = {};
          this.timestamps = {};
        }
      }
    };
    
    // ============ PAGINATION STATE ============
    const pagination = {
      trips: { page: 1, perPage: 50, total: 0 },
      orders: { page: 1, perPage: 50, total: 0 },
      maintenance: { page: 1, perPage: 50, total: 0 },
      expenses: { page: 1, perPage: 50, total: 0 },
      activity_log: { page: 1, perPage: 100, total: 0 }
    };
    
    function getPaginatedData(dataArray, pageKey) {
      const p = pagination[pageKey] || { page: 1, perPage: 50 };
      p.total = dataArray.length;
      const start = (p.page - 1) * p.perPage;
      const end = start + p.perPage;
      return {
        data: dataArray.slice(start, end),
        page: p.page,
        perPage: p.perPage,
        total: p.total,
        totalPages: Math.ceil(p.total / p.perPage)
      };
    }
    
    function renderPaginationControls(pageKey, onPageChange) {
      const p = pagination[pageKey];
      if (!p || p.total <= p.perPage) return '';
      
      const totalPages = Math.ceil(p.total / p.perPage);
      const prevDisabled = p.page <= 1 ? 'disabled' : '';
      const nextDisabled = p.page >= totalPages ? 'disabled' : '';
      
      return '<div class="pagination-controls" style="display:flex;align-items:center;justify-content:center;gap:12px;margin-top:20px;padding:16px;background:var(--bg-card);border-radius:12px">' +
        '<button class="btn btn-secondary" onclick="changePage(\'' + pageKey + '\', ' + (p.page - 1) + ')" ' + prevDisabled + ' style="padding:10px 16px">â† ' + ('Previous') + '</button>' +
        '<span style="color:var(--text-muted)">' + ('Page') + ' <strong>' + p.page + '</strong> / ' + totalPages + ' (' + p.total + ' ' + ('records') + ')</span>' +
        '<button class="btn btn-secondary" onclick="changePage(\'' + pageKey + '\', ' + (p.page + 1) + ')" ' + nextDisabled + ' style="padding:10px 16px">' + ('Next') + ' â†’</button>' +
        '</div>';
    }
    
    function changePage(pageKey, newPage) {
      if (pagination[pageKey]) {
        pagination[pageKey].page = newPage;
        renderPage();
      }
    }

    // ============ TRANSLATIONS ============
    const translations = {
      en: {
        // Navigation
        dashboard: 'Dashboard',
        loadboard: 'Future Cars',
        trips: 'Trips',
        orders: 'Orders',
        drivers: 'Drivers',
        local_drivers: 'Local Drivers',
        trucks: 'Trucks',
        brokers: 'Brokers',
        dispatchers: 'Dispatchers',
        dispatcher_ranking: 'Dispatcher Ranking',
        fuel: 'Fuel Tracking',
        ifta: 'IFTA Report',
        compliance: 'Compliance',
        driver_compliance: 'Driver Compliance',
        financials: 'Financials',
        payroll: 'Payroll',
        reports: 'Reports',
        ai_advisor: 'AI Advisor',
        fixed_costs: 'Fixed Costs',
        variable_costs: 'Variable Costs',
        financial: 'Financial Analysis',
        profitability: 'Profitability',
        executive_dashboard: 'Executive Dashboard',
        maintenance: 'Maintenance',
        claims: 'Damage Claims',
        settings: 'Settings',
        users: 'Users',
        tasks: 'Tasks',
        activity_log: 'Activity Log',
        live_map: 'Live Map',
        team_chat: 'Team Chat',
        
        // Common buttons
        add: 'Add',
        edit: 'Edit',
        delete: 'Delete',
        save: 'Save',
        cancel: 'Cancel',
        close: 'Close',
        export: 'Export',
        search: 'Search',
        filter: 'Filter',
        view: 'View',
        
        // Dashboard
        welcome: 'Welcome',
        total_revenue: 'Total Revenue',
        active_trips: 'Active Trips',
        total_trucks: 'Total Trucks',
        total_drivers: 'Total Drivers',
        recent_trips: 'Recent Trips',
        quick_stats: 'Quick Stats',
        
        // Common labels
        date: 'Date',
        status: 'Status',
        amount: 'Amount',
        notes: 'Notes',
        actions: 'Actions',
        truck: 'Truck',
        driver: 'Driver',
        dispatcher: 'Dispatcher',
        broker: 'Broker',
        origin: 'Origin',
        destination: 'Destination',
        miles: 'Miles',
        revenue: 'Revenue',
        cost: 'Cost',
        profit: 'Profit',
        total: 'Total',
        
        // Trips
        trip_number: 'Trip #',
        trip_date: 'Trip Date',
        new_trip: 'New Trip',
        edit_trip: 'Edit Trip',
        trip_details: 'Trip Details',
        
        // Trucks
        truck_number: 'Truck #',
        new_truck: 'New Truck',
        edit_truck: 'Edit Truck',
        truck_details: 'Truck Details',
        vin: 'VIN',
        year: 'Year',
        make: 'Make',
        model: 'Model',
        license_plate: 'License Plate',
        
        // Drivers
        first_name: 'First Name',
        last_name: 'Last Name',
        phone: 'Phone',
        email: 'Email',
        new_driver: 'New Driver',
        edit_driver: 'Edit Driver',
        
        // Maintenance
        maintenance_records: 'Maintenance Records',
        new_record: 'New Record',
        service_date: 'Service Date',
        service_type: 'Service Type',
        shop_name: 'Shop Name',
        description: 'Description',
        parts_cost: 'Parts Cost',
        labor_cost: 'Labor Cost',
        total_cost: 'Total Cost',
        upload_invoice: 'Upload Invoice',
        extract_data: 'Extract Invoice Data',
        
        // Financial
        net_profit: 'Net Profit',
        profit_margin: 'Profit Margin',
        total_costs: 'Total Costs',
        fuel_cost: 'Fuel Cost',
        maintenance_cost: 'Maintenance Cost',
        driver_pay: 'Driver Pay',
        broker_fees: 'Broker Fees',
        
        // Status
        active: 'Active',
        inactive: 'Inactive',
        completed: 'Completed',
        in_progress: 'In Progress',
        planned: 'Planned',
        cancelled: 'Cancelled',
        
        // Messages
        saved_success: 'Saved successfully!',
        deleted_success: 'Deleted successfully!',
        error_occurred: 'An error occurred',
        confirm_delete: 'Are you sure you want to delete?',
        no_data: 'No data available',
        loading: 'Loading...',
        
        // Login
        login: 'Login',
        logout: 'Logout',
        username: 'Username',
        password: 'Password',
        sign_in: 'Sign In',
        
        // Misc
        all_time: 'All Time',
        this_month: 'This Month',
        this_year: 'This Year',
        per_mile: 'Per Mile',
        monthly: 'Monthly',
        annually: 'Annually',
        export_to_sheets: 'Export to Sheets'
      }
    };
    
    function t(key) {
      return translations.en[key] || key;
    }
    
    function setLanguage(lang) {
      // Language switching disabled - English only
    }
    
    // Dark Theme - Default to dark theme (true unless explicitly set to 'false')
    let isDarkTheme = localStorage.getItem('horizonstar_dark') !== 'false';
    
    function applyTheme() {
      if (isDarkTheme) {
        document.body.classList.add('dark-theme');
      } else {
        document.body.classList.remove('dark-theme');
      }
    }
    
    function toggleDarkTheme() {
      isDarkTheme = !isDarkTheme;
      localStorage.setItem('horizonstar_dark', isDarkTheme);
      applyTheme();
      if (currentUser) {
        renderApp();
      } else {
        renderLogin();
      }
    }
    
    // Apply theme on load
    applyTheme();

    function formatMoney(n) { 
      const val = n || 0;
      const formatted = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(Math.abs(val));
      return val < 0 ? '(' + formatted + ')' : formatted;
    }
    function formatDate(d) { return d ? new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '-'; }
    function showToast(msg, type = 'success') {
      document.querySelectorAll('.toast').forEach(t => t.remove());
      const t = document.createElement('div'); t.className = 'toast ' + type; t.textContent = msg;
      document.body.appendChild(t); setTimeout(() => t.remove(), 3000);
    }
    function getBadge(s) {
      const m = { COMPLETED: 'badge-green', IN_PROGRESS: 'badge-amber', PLANNED: 'badge-blue', CANCELLED: 'badge-red', ACTIVE: 'badge-green', INACTIVE: 'badge-gray', MAINTENANCE: 'badge-amber', DELIVERED: 'badge-green', IN_TRANSIT: 'badge-amber', PENDING: 'badge-blue' };
      return m[s] || 'badge-gray';
    }

    // ============ HTML SANITIZATION (XSS Prevention) ============
    // Escape HTML special characters to prevent XSS attacks
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const str = String(text);
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return str.replace(/[&<>"']/g, char => map[char]);
    }

    // Sanitize user input before displaying (alias for escapeHtml)
    function sanitize(text) {
      return escapeHtml(text);
    }

    // ============ FORM VALIDATION UTILITIES ============
    const validators = {
      required: (value, fieldName) => {
        if (!value || (typeof value === 'string' && !value.trim())) {
          return fieldName + ' is required';
        }
        return null;
      },
      email: (value) => {
        if (!value) return null;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(value)) {
          return 'Please enter a valid email address';
        }
        return null;
      },
      phone: (value) => {
        if (!value) return null;
        const cleaned = value.replace(/\D/g, '');
        if (cleaned.length < 10 || cleaned.length > 11) {
          return 'Please enter a valid phone number';
        }
        return null;
      },
      number: (value, min, max) => {
        if (!value && value !== 0) return null;
        const num = parseFloat(value);
        if (isNaN(num)) return 'Please enter a valid number';
        if (min !== undefined && num < min) return 'Value must be at least ' + min;
        if (max !== undefined && num > max) return 'Value must not exceed ' + max;
        return null;
      },
      date: (value) => {
        if (!value) return null;
        const date = new Date(value);
        if (isNaN(date.getTime())) return 'Please enter a valid date';
        return null;
      },
      vin: (value) => {
        if (!value) return null;
        if (value.length !== 17) return 'VIN must be exactly 17 characters';
        if (!/^[A-HJ-NPR-Z0-9]{17}$/i.test(value)) return 'Invalid VIN format';
        return null;
      }
    };

    // Validate a form field and show inline error
    function validateField(input, validations) {
      const value = input.value;
      const fieldName = input.getAttribute('data-field-name') || input.name || 'This field';

      for (const validation of validations) {
        let error;
        if (typeof validation === 'string') {
          error = validators[validation] ? validators[validation](value, fieldName) : null;
        } else if (typeof validation === 'object') {
          const { type, ...params } = validation;
          error = validators[type] ? validators[type](value, params.min, params.max) : null;
        }

        if (error) {
          showFieldError(input, error);
          return false;
        }
      }

      clearFieldError(input);
      return true;
    }

    // Show error message under a field
    function showFieldError(input, message) {
      clearFieldError(input);
      input.style.borderColor = '#ef4444';
      input.setAttribute('aria-invalid', 'true');

      const errorDiv = document.createElement('div');
      errorDiv.className = 'field-error';
      errorDiv.style.cssText = 'color:#ef4444;font-size:12px;margin-top:4px';
      errorDiv.textContent = message;
      errorDiv.id = input.id + '-error';
      input.setAttribute('aria-describedby', errorDiv.id);

      input.parentNode.appendChild(errorDiv);
    }

    // Clear error message from a field
    function clearFieldError(input) {
      input.style.borderColor = '';
      input.removeAttribute('aria-invalid');
      input.removeAttribute('aria-describedby');

      const existingError = input.parentNode.querySelector('.field-error');
      if (existingError) existingError.remove();
    }

    // Validate entire form
    function validateForm(formSelector, fieldValidations) {
      const form = typeof formSelector === 'string' ? document.querySelector(formSelector) : formSelector;
      if (!form) return false;

      let isValid = true;
      for (const [fieldId, validations] of Object.entries(fieldValidations)) {
        const input = form.querySelector('#' + fieldId) || form.querySelector('[name="' + fieldId + '"]');
        if (input && !validateField(input, validations)) {
          isValid = false;
        }
      }

      if (!isValid) {
        showToast('Please fix the errors in the form', 'error');
      }
      return isValid;
    }

    // ============ MOBILE TABLE SCROLL INDICATORS ============
    // Add scroll indicators to table wrappers
    function initTableScrollIndicators() {
      document.querySelectorAll('.table-wrapper').forEach(wrapper => {
        const updateScrollIndicators = () => {
          const scrollLeft = wrapper.scrollLeft;
          const scrollWidth = wrapper.scrollWidth;
          const clientWidth = wrapper.clientWidth;

          wrapper.classList.toggle('scrolled-left', scrollLeft > 10);
          wrapper.classList.toggle('scrolled-right', scrollLeft < scrollWidth - clientWidth - 10);
        };

        wrapper.addEventListener('scroll', updateScrollIndicators);
        // Initial check
        setTimeout(updateScrollIndicators, 100);
      });
    }

    // Initialize on page render
    if (typeof MutationObserver !== 'undefined') {
      const tableObserver = new MutationObserver(() => {
        initTableScrollIndicators();
      });
      document.addEventListener('DOMContentLoaded', () => {
        tableObserver.observe(document.body, { childList: true, subtree: true });
        initTableScrollIndicators();
      });
    }

    // ============ LOADING STATE UTILITIES ============
    // Set loading state on a button
    function setButtonLoading(button, isLoading, loadingText) {
      if (typeof button === 'string') {
        button = document.querySelector(button);
      }
      if (!button) return;

      if (isLoading) {
        button.disabled = true;
        button.setAttribute('data-original-text', button.innerHTML);
        button.innerHTML = '<span class="spinner-inline"></span> ' + (loadingText || 'Loading...');
        button.style.opacity = '0.7';
        button.style.cursor = 'not-allowed';
      } else {
        button.disabled = false;
        const originalText = button.getAttribute('data-original-text');
        if (originalText) button.innerHTML = originalText;
        button.style.opacity = '';
        button.style.cursor = '';
      }
    }

    // Show loading state in a container
    function showContainerLoading(container, message) {
      if (typeof container === 'string') {
        container = document.querySelector(container);
      }
      if (!container) return;

      container.setAttribute('data-original-content', container.innerHTML);
      container.innerHTML = '<div class="loading-state" role="status" aria-live="polite"><div class="spinner"></div><div style="margin-top:12px;color:var(--text-muted)">' + (message || 'Loading...') + '</div></div>';
    }

    // Restore container from loading state
    function hideContainerLoading(container) {
      if (typeof container === 'string') {
        container = document.querySelector(container);
      }
      if (!container) return;

      const originalContent = container.getAttribute('data-original-content');
      if (originalContent) {
        container.innerHTML = originalContent;
        container.removeAttribute('data-original-content');
      }
    }

    // Show skeleton loading placeholder
    function showSkeleton(container, rows) {
      if (typeof container === 'string') {
        container = document.querySelector(container);
      }
      if (!container) return;

      rows = rows || 3;
      let skeletonHtml = '<div class="skeleton-loading" aria-hidden="true">';
      for (let i = 0; i < rows; i++) {
        const width = 60 + Math.random() * 40;
        skeletonHtml += '<div class="skeleton-line" style="width:' + width + '%;height:16px;background:var(--bg-tertiary);border-radius:4px;margin-bottom:12px;animation:skeleton-pulse 1.5s ease-in-out infinite"></div>';
      }
      skeletonHtml += '</div>';

      container.setAttribute('data-original-content', container.innerHTML);
      container.innerHTML = skeletonHtml;
    }

    // Helper: Parse date string consistently (handles timezone issues)
    function parseTripDate(dateStr) {
      if (!dateStr) return null;
      // Parse as local date to avoid timezone issues
      // Date strings like "2024-12-29" from DB should be treated as local dates
      const parts = String(dateStr).split('T')[0].split('-');
      if (parts.length === 3) {
        return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
      }
      return new Date(dateStr);
    }

    function getTripFin(tripId) {
      const trip = appData.trips.find(t => t.id === tripId);
      const orders = appData.orders.filter(o => o.trip_id === tripId);
      const expenses = appData.expenses.filter(e => e.trip_id === tripId);
      const loadRevenue = orders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
      const localFees = orders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
      const brokerFee = orders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0) + parseFloat(trip?.broker_fee || 0);
      const cleanGross = loadRevenue - brokerFee - localFees;
      const driverCut = cleanGross * ((trip?.driver_cut_percent || 32) / 100);
      const totalExpenses = expenses.reduce((s, e) => s + parseFloat(e.amount || 0), 0);
      
      // Direct Trip Expenses = ALL costs for this trip
      const directTripExpenses = brokerFee + localFees + driverCut + totalExpenses;
      
      // Trip Net Profit = Revenue - All Trip Costs
      const netProfit = loadRevenue - directTripExpenses;
      
      // Keep these for backward compatibility
      const truckGross = cleanGross - driverCut;
      
      // Cash collected = COD and COP payments, but for split payments use cod_amount instead of full revenue
      const cashCollected = orders.filter(o => o.payment_type === 'COD' || o.payment_type === 'COP').reduce((s, o) => {
        // If bill_amount > 0, this is a split payment - only count cod_amount as cash
        if (parseFloat(o.bill_amount || 0) > 0) {
          return s + parseFloat(o.cod_amount || 0);
        }
        return s + parseFloat(o.revenue || 0);
      }, 0);
      
      return { 
        loadRevenue, 
        localFees, 
        brokerFee, 
        cleanGross, 
        driverCut, 
        truckGross, 
        totalExpenses, 
        directTripExpenses,  // All costs for this trip
        netProfit,           // Revenue - All Costs
        vehicleCount: orders.length, 
        cashCollected 
      };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ“Š ADVANCED FINANCIAL ANALYTICS ENGINE v2.0
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // ============ TRIP VOLUME & SEASONALITY TRACKING ============
    function calculateTripVolume(trips, truckId = null) {
      // Filter by truck if specified
      const filteredTrips = truckId 
        ? trips.filter(t => t.truck_id === truckId)
        : trips;
      
      if (filteredTrips.length === 0) return { 
        totalTrips: 0, totalTripValue: 0, monthlyAvg: 0, 
        monthlyData: {}, truckData: {}, seasonalIndex: {} 
      };
      
      const monthlyData = {};
      const truckMonthlyData = {};
      let totalTripValue = 0;
      
      filteredTrips.forEach(trip => {
        const startDate = parseTripDate(trip.trip_date || trip.period_start_date) || new Date();
        const endDate = trip.period_end_date ? (parseTripDate(trip.period_end_date) || startDate) : startDate;
        
        const startMonth = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}`;
        const endMonth = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}`;
        
        // Trip counting logic: Same month = 1, Cross month = 1.5
        const tripValue = (startMonth === endMonth) ? 1 : 1.5;
        totalTripValue += tripValue;
        
        // Track by month (attribute to start month)
        if (!monthlyData[startMonth]) {
          monthlyData[startMonth] = { trips: 0, tripValue: 0, revenue: 0, profit: 0, miles: 0, cars: 0 };
        }
        const fin = getTripFin(trip.id);
        monthlyData[startMonth].trips++;
        monthlyData[startMonth].tripValue += tripValue;
        monthlyData[startMonth].revenue += fin.loadRevenue;
        monthlyData[startMonth].profit += fin.netProfit;
        monthlyData[startMonth].miles += parseFloat(trip.miles || 0);
        monthlyData[startMonth].cars += fin.vehicleCount;
        
        // Track by truck per month
        if (trip.truck_id) {
          const truckKey = `${trip.truck_id}-${startMonth}`;
          if (!truckMonthlyData[truckKey]) {
            truckMonthlyData[truckKey] = { truckId: trip.truck_id, month: startMonth, trips: 0, tripValue: 0 };
          }
          truckMonthlyData[truckKey].trips++;
          truckMonthlyData[truckKey].tripValue += tripValue;
        }
      });
      
      // Calculate monthly average
      const monthCount = Object.keys(monthlyData).length || 1;
      const monthlyAvg = totalTripValue / monthCount;
      
      // Calculate seasonal index (compare each month to average)
      const seasonalIndex = {};
      Object.entries(monthlyData).forEach(([month, data]) => {
        seasonalIndex[month] = monthlyAvg > 0 ? (data.tripValue / monthlyAvg) : 1;
      });
      
      // Group truck data by truck
      const truckData = {};
      Object.values(truckMonthlyData).forEach(td => {
        if (!truckData[td.truckId]) {
          truckData[td.truckId] = { months: {}, totalTrips: 0, totalTripValue: 0 };
        }
        truckData[td.truckId].months[td.month] = td;
        truckData[td.truckId].totalTrips += td.trips;
        truckData[td.truckId].totalTripValue += td.tripValue;
      });
      
      return {
        totalTrips: filteredTrips.length,
        totalTripValue,
        monthlyAvg,
        monthlyData,
        truckData,
        seasonalIndex,
        monthCount
      };
    }

    // ============ BREAK-EVEN ANALYSIS ============
    function calculateBreakEven(options = {}) {
      const { truckId, tripId, targetProfit = 0 } = options;
      
      // Get monthly fixed costs
      const monthlyFixedCosts = (appData.fixed_costs || []).reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);
      const activeTrucks = appData.trucks.filter(t => t.status === 'ACTIVE').length || 1;
      const fixedCostPerTruck = monthlyFixedCosts / activeTrucks;
      
      // Calculate historical averages
      const allTrips = appData.trips || [];
      let totalBrokerFeeRatio = 0, totalLocalFeeRatio = 0, totalDriverCutRatio = 0;
      let totalExpensePerTrip = 0, avgMilesPerTrip = 0, avgCarsPerTrip = 0;
      let validTrips = 0;
      
      allTrips.forEach(trip => {
        const fin = getTripFin(trip.id);
        if (fin.loadRevenue > 0) {
          totalBrokerFeeRatio += fin.brokerFee / fin.loadRevenue;
          totalLocalFeeRatio += fin.localFees / fin.loadRevenue;
          const cleanGross = fin.loadRevenue - fin.brokerFee - fin.localFees;
          totalDriverCutRatio += cleanGross > 0 ? fin.driverCut / cleanGross : 0.32;
          totalExpensePerTrip += fin.totalExpenses;
          avgMilesPerTrip += parseFloat(trip.miles || 0);
          avgCarsPerTrip += fin.vehicleCount;
          validTrips++;
        }
      });
      
      const avgBrokerFeeRatio = validTrips > 0 ? totalBrokerFeeRatio / validTrips : 0.08;
      const avgLocalFeeRatio = validTrips > 0 ? totalLocalFeeRatio / validTrips : 0.02;
      const avgDriverCutRatio = validTrips > 0 ? totalDriverCutRatio / validTrips : 0.32;
      const avgExpensePerTrip = validTrips > 0 ? totalExpensePerTrip / validTrips : 500;
      avgMilesPerTrip = validTrips > 0 ? avgMilesPerTrip / validTrips : 2500;
      avgCarsPerTrip = validTrips > 0 ? avgCarsPerTrip / validTrips : 8;
      
      // Calculate break-even PPC (Price Per Car)
      // Revenue = PPC Ã— Cars
      // Net Profit = Revenue Ã— (1 - BrokerRatio - LocalRatio) Ã— (1 - DriverCutRatio) - Expenses - FixedCostAllocation
      // At break-even: 0 = Revenue Ã— TruckGrossRatio - Expenses - FixedCostAllocation
      // Revenue = (Expenses + FixedCostAllocation) / TruckGrossRatio
      
      const truckGrossRatio = (1 - avgBrokerFeeRatio - avgLocalFeeRatio) * (1 - avgDriverCutRatio);
      const tripVolume = calculateTripVolume(allTrips);
      const avgTripsPerMonth = tripVolume.monthlyAvg || 2;
      const fixedCostPerTrip = fixedCostPerTruck / avgTripsPerMonth;
      
      const breakEvenRevenue = truckGrossRatio > 0 
        ? (avgExpensePerTrip + fixedCostPerTrip + targetProfit) / truckGrossRatio 
        : 0;
      
      const breakEvenPPC = avgCarsPerTrip > 0 ? breakEvenRevenue / avgCarsPerTrip : 0;
      const profitablePPC = breakEvenPPC * 1.15; // 15% above break-even for comfortable profit
      
      // For specific trip calculation
      let tripSpecific = null;
      if (tripId) {
        const trip = appData.trips.find(t => t.id === tripId);
        if (trip) {
          const fin = getTripFin(tripId);
          const orders = appData.orders.filter(o => o.trip_id === tripId);
          const currentCars = orders.length;
          const currentRevenue = fin.loadRevenue;
          const driverCutPercent = trip.driver_cut_percent || 32;
          
          // Calculate what PPC is needed for break-even on THIS trip
          const tripBrokerRatio = currentRevenue > 0 ? fin.brokerFee / currentRevenue : avgBrokerFeeRatio;
          const tripLocalRatio = currentRevenue > 0 ? fin.localFees / currentRevenue : avgLocalFeeRatio;
          const tripTruckGrossRatio = (1 - tripBrokerRatio - tripLocalRatio) * (1 - driverCutPercent / 100);
          
          const tripBreakEvenRev = tripTruckGrossRatio > 0 
            ? (fin.totalExpenses + fixedCostPerTrip) / tripTruckGrossRatio 
            : 0;
          
          const remainingCapacity = 8 - currentCars; // Assuming 8-car hauler
          const currentPPC = currentCars > 0 ? currentRevenue / currentCars : 0;
          
          // What PPC needed for remaining cars to hit break-even
          const revenueNeeded = tripBreakEvenRev - currentRevenue;
          const ppcNeededForRemaining = remainingCapacity > 0 ? revenueNeeded / remainingCapacity : 0;
          
          tripSpecific = {
            currentCars,
            currentRevenue,
            currentPPC,
            remainingCapacity,
            tripBreakEvenRevenue: tripBreakEvenRev,
            ppcNeededForRemaining: Math.max(0, ppcNeededForRemaining),
            currentProfit: fin.netProfit,
            profitStatus: fin.netProfit >= fixedCostPerTrip ? 'PROFITABLE' : fin.netProfit >= 0 ? 'BREAK_EVEN' : 'LOSING',
            targetPPCForProfit: currentCars > 0 ? (tripBreakEvenRev * 1.15) / currentCars : profitablePPC
          };
        }
      }
      
      return {
        breakEvenPPC,
        profitablePPC,
        avgBrokerFeeRatio,
        avgLocalFeeRatio,
        avgDriverCutRatio,
        avgExpensePerTrip,
        avgMilesPerTrip,
        avgCarsPerTrip,
        fixedCostPerTruck,
        fixedCostPerTrip,
        truckGrossRatio,
        avgTripsPerMonth,
        tripSpecific
      };
    }

    // ============ CASH FLOW ANALYSIS ============
    function calculateCashFlow(periodStart = null, periodEnd = null) {
      const trips = appData.trips || [];
      const orders = appData.orders || [];
      const expenses = appData.expenses || [];
      const fixedCosts = appData.fixed_costs || [];
      
      // Filter by period if specified
      const filterByPeriod = (date) => {
        if (!periodStart && !periodEnd) return true;
        const d = new Date(date);
        if (periodStart && d < new Date(periodStart)) return false;
        if (periodEnd && d > new Date(periodEnd)) return false;
        return true;
      };
      
      const filteredTrips = trips.filter(t => filterByPeriod(t.trip_date));
      const filteredOrders = orders.filter(o => {
        const trip = trips.find(t => t.id === o.trip_id);
        return trip && filterByPeriod(trip.trip_date);
      });
      
      // CASH INFLOWS
      let codCollected = 0, copCollected = 0, localCodCollected = 0, checkPayments = 0, billedAmount = 0;
      
      filteredOrders.forEach(order => {
        const revenue = parseFloat(order.revenue || 0);
        const codAmount = parseFloat(order.cod_amount || 0);
        const billAmount = parseFloat(order.bill_amount || 0);
        
        switch (order.payment_type) {
          case 'COD':
            codCollected += billAmount > 0 ? codAmount : revenue;
            billedAmount += billAmount;
            break;
          case 'COP':
            copCollected += billAmount > 0 ? codAmount : revenue;
            billedAmount += billAmount;
            break;
          case 'LOCAL_COD':
            localCodCollected += billAmount > 0 ? codAmount : revenue;
            billedAmount += billAmount;
            break;
          case 'CHECK':
            checkPayments += revenue;
            break;
          case 'BILL':
          case 'SPLIT':
          default:
            billedAmount += revenue;
        }
      });
      
      const totalCashInflow = codCollected + copCollected + localCodCollected + checkPayments;
      const totalRevenue = codCollected + copCollected + localCodCollected + checkPayments + billedAmount;
      
      // CASH OUTFLOWS
      let driverPayments = 0, fuelExpenses = 0, tollsPermits = 0, maintenanceExpenses = 0, otherExpenses = 0;
      
      filteredTrips.forEach(trip => {
        const fin = getTripFin(trip.id);
        driverPayments += fin.driverCut;
        
        const tripExpenses = expenses.filter(e => e.trip_id === trip.id);
        tripExpenses.forEach(exp => {
          const amount = parseFloat(exp.amount || 0);
          switch (exp.category) {
            case 'FUEL': fuelExpenses += amount; break;
            case 'TOLLS':
            case 'PERMITS': tollsPermits += amount; break;
            case 'MAINTENANCE': maintenanceExpenses += amount; break;
            default: otherExpenses += amount;
          }
        });
      });
      
      // Fixed costs (monthly)
      const periodMonths = periodStart && periodEnd 
        ? Math.max(1, Math.ceil((new Date(periodEnd) - new Date(periodStart)) / (1000 * 60 * 60 * 24 * 30)))
        : 1;
      const totalFixedCosts = fixedCosts.reduce((s, fc) => s + parseFloat(fc.amount || 0), 0) * periodMonths;
      
      const totalCashOutflow = driverPayments + fuelExpenses + tollsPermits + maintenanceExpenses + otherExpenses + totalFixedCosts;
      const netCashFlow = totalCashInflow - totalCashOutflow;
      
      // Outstanding receivables (billed but not collected)
      const outstandingReceivables = billedAmount;
      
      return {
        inflows: {
          codCollected,
          copCollected,
          localCodCollected,
          checkPayments,
          billedAmount,
          totalCashInflow,
          totalRevenue
        },
        outflows: {
          driverPayments,
          fuelExpenses,
          tollsPermits,
          maintenanceExpenses,
          otherExpenses,
          totalFixedCosts,
          totalCashOutflow
        },
        netCashFlow,
        outstandingReceivables,
        cashPosition: netCashFlow + outstandingReceivables
      };
    }

    // ============ INCOME STATEMENT (P&L) ============
    function generateIncomeStatement(periodStart = null, periodEnd = null) {
      const trips = appData.trips || [];
      const fixedCosts = appData.fixed_costs || [];
      
      // Filter by period
      const filterByPeriod = (date) => {
        if (!periodStart && !periodEnd) return true;
        const d = new Date(date);
        if (periodStart && d < new Date(periodStart)) return false;
        if (periodEnd && d > new Date(periodEnd)) return false;
        return true;
      };
      
      const filteredTrips = trips.filter(t => filterByPeriod(t.trip_date));
      
      // REVENUE
      let grossRevenue = 0, brokerFees = 0, localFees = 0;
      
      // DIRECT COSTS (COGS)
      let driverCut = 0, fuelCosts = 0, tollsPermits = 0, otherDirectCosts = 0;
      
      filteredTrips.forEach(trip => {
        const fin = getTripFin(trip.id);
        grossRevenue += fin.loadRevenue;
        brokerFees += fin.brokerFee;
        localFees += fin.localFees;
        driverCut += fin.driverCut;
        
        const tripExpenses = (appData.expenses || []).filter(e => e.trip_id === trip.id);
        tripExpenses.forEach(exp => {
          const amount = parseFloat(exp.amount || 0);
          if (exp.category === 'FUEL') fuelCosts += amount;
          else if (exp.category === 'TOLLS' || exp.category === 'PERMITS') tollsPermits += amount;
          else otherDirectCosts += amount;
        });
      });
      
      const netRevenue = grossRevenue - brokerFees - localFees;
      const totalDirectCosts = driverCut + fuelCosts + tollsPermits + otherDirectCosts;
      const grossProfit = netRevenue - totalDirectCosts;
      const grossProfitMargin = grossRevenue > 0 ? (grossProfit / grossRevenue * 100) : 0;
      
      // OPERATING EXPENSES (Fixed Costs)
      const periodMonths = periodStart && periodEnd 
        ? Math.max(1, Math.ceil((new Date(periodEnd) - new Date(periodStart)) / (1000 * 60 * 60 * 24 * 30)))
        : Math.max(1, Object.keys(calculateTripVolume(filteredTrips).monthlyData).length);
      
      const totalFixedCosts = fixedCosts.reduce((s, fc) => s + parseFloat(fc.amount || 0), 0) * periodMonths;
      const operatingProfit = grossProfit - totalFixedCosts;
      const operatingProfitMargin = grossRevenue > 0 ? (operatingProfit / grossRevenue * 100) : 0;
      
      // Maintenance from maintenance_records
      const maintenanceCosts = (appData.maintenance_records || [])
        .filter(m => filterByPeriod(m.service_date))
        .reduce((s, m) => s + parseFloat(m.total_cost || 0), 0);
      
      const netProfit = operatingProfit - maintenanceCosts;
      const netProfitMargin = grossRevenue > 0 ? (netProfit / grossRevenue * 100) : 0;
      
      return {
        revenue: {
          grossRevenue,
          brokerFees,
          localFees,
          netRevenue
        },
        directCosts: {
          driverCut,
          fuelCosts,
          tollsPermits,
          otherDirectCosts,
          totalDirectCosts
        },
        grossProfit,
        grossProfitMargin,
        operatingExpenses: {
          fixedCosts: totalFixedCosts,
          maintenanceCosts
        },
        operatingProfit,
        operatingProfitMargin,
        netProfit,
        netProfitMargin,
        periodMonths
      };
    }

    // ============ FORECASTING ENGINE ============
    function generateForecast(monthsAhead = 3) {
      const tripVolume = calculateTripVolume(appData.trips);
      const incomeStatement = generateIncomeStatement();
      const breakEven = calculateBreakEven();
      
      // Historical monthly averages
      const monthlyData = Object.values(tripVolume.monthlyData);
      const avgMonthlyRevenue = monthlyData.length > 0 
        ? monthlyData.reduce((s, m) => s + m.revenue, 0) / monthlyData.length 
        : 0;
      const avgMonthlyProfit = monthlyData.length > 0 
        ? monthlyData.reduce((s, m) => s + m.profit, 0) / monthlyData.length 
        : 0;
      const avgMonthlyCars = monthlyData.length > 0 
        ? monthlyData.reduce((s, m) => s + m.cars, 0) / monthlyData.length 
        : 0;
      const avgMonthlyMiles = monthlyData.length > 0 
        ? monthlyData.reduce((s, m) => s + m.miles, 0) / monthlyData.length 
        : 0;
      
      // Calculate trend (simple linear regression on recent 6 months)
      const recentMonths = monthlyData.slice(-6);
      let trend = 0;
      if (recentMonths.length >= 3) {
        const n = recentMonths.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        recentMonths.forEach((m, i) => {
          sumX += i;
          sumY += m.revenue;
          sumXY += i * m.revenue;
          sumX2 += i * i;
        });
        trend = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX) || 0;
      }
      
      // Seasonal factors (by month of year)
      const seasonalFactors = {};
      for (let m = 1; m <= 12; m++) {
        const monthRevenues = monthlyData.filter(md => {
          const [year, month] = Object.keys(tripVolume.monthlyData).find(k => tripVolume.monthlyData[k] === md)?.split('-') || [];
          return parseInt(month) === m;
        });
        seasonalFactors[m] = monthRevenues.length > 0 && avgMonthlyRevenue > 0
          ? monthRevenues.reduce((s, md) => s + md.revenue, 0) / monthRevenues.length / avgMonthlyRevenue
          : 1;
      }
      
      // Generate forecasts
      const forecasts = [];
      const today = new Date();
      let cumulativeRevenue = 0, cumulativeProfit = 0;
      
      for (let i = 1; i <= monthsAhead; i++) {
        const forecastDate = new Date(today.getFullYear(), today.getMonth() + i, 1);
        const forecastMonth = forecastDate.getMonth() + 1;
        const seasonalFactor = seasonalFactors[forecastMonth] || 1;
        
        // Base forecast + trend + seasonal adjustment
        const baseRevenue = avgMonthlyRevenue + (trend * (monthlyData.length + i));
        const forecastRevenue = baseRevenue * seasonalFactor;
        
        // Estimate profit based on historical margin
        const profitMargin = avgMonthlyRevenue > 0 ? avgMonthlyProfit / avgMonthlyRevenue : 0.15;
        const forecastProfit = forecastRevenue * profitMargin;
        
        // Estimate cars and trips
        const forecastCars = avgMonthlyCars * seasonalFactor;
        const forecastTrips = tripVolume.monthlyAvg * seasonalFactor;
        
        cumulativeRevenue += forecastRevenue;
        cumulativeProfit += forecastProfit;
        
        forecasts.push({
          month: forecastDate.toLocaleString('default', { month: 'short', year: 'numeric' }),
          monthNum: forecastMonth,
          revenue: forecastRevenue,
          profit: forecastProfit,
          cars: forecastCars,
          trips: forecastTrips,
          seasonalFactor,
          cumulativeRevenue,
          cumulativeProfit,
          confidence: Math.max(0.5, 1 - (i * 0.1)) // Confidence decreases with time
        });
      }
      
      // Calculate annualized projections
      const annualizedRevenue = avgMonthlyRevenue * 12;
      const annualizedProfit = avgMonthlyProfit * 12;
      const annualizedCars = avgMonthlyCars * 12;
      
      // What-if scenarios
      const scenarios = {
        conservative: {
          revenue: annualizedRevenue * 0.85,
          profit: annualizedProfit * 0.75
        },
        base: {
          revenue: annualizedRevenue,
          profit: annualizedProfit
        },
        optimistic: {
          revenue: annualizedRevenue * 1.15,
          profit: annualizedProfit * 1.3
        }
      };
      
      return {
        forecasts,
        trend,
        seasonalFactors,
        avgMonthlyRevenue,
        avgMonthlyProfit,
        avgMonthlyCars,
        avgMonthlyMiles,
        annualized: {
          revenue: annualizedRevenue,
          profit: annualizedProfit,
          cars: annualizedCars
        },
        scenarios
      };
    }

    // ============ EFFICIENCY METRICS ============
    function calculateEfficiencyMetrics() {
      const trips = appData.trips || [];
      const trucks = appData.trucks.filter(t => t.status === 'ACTIVE') || [];
      const tripVolume = calculateTripVolume(trips);
      const incomeStatement = generateIncomeStatement();
      
      let totalMiles = 0, totalCars = 0, totalRevenue = 0, totalProfit = 0;
      
      trips.forEach(trip => {
        const fin = getTripFin(trip.id);
        totalMiles += parseFloat(trip.miles || 0);
        totalCars += fin.vehicleCount;
        totalRevenue += fin.loadRevenue;
        totalProfit += fin.netProfit;
      });
      
      const profitPerMile = totalMiles > 0 ? totalProfit / totalMiles : 0;
      const profitPerCar = totalCars > 0 ? totalProfit / totalCars : 0;
      const profitPerTrip = trips.length > 0 ? totalProfit / trips.length : 0;
      const revenuePerMile = totalMiles > 0 ? totalRevenue / totalMiles : 0;
      const revenuePerCar = totalCars > 0 ? totalRevenue / totalCars : 0;
      
      // Cost metrics
      const costPerMile = totalMiles > 0 ? (totalRevenue - totalProfit) / totalMiles : 0;
      const costPerCar = totalCars > 0 ? (totalRevenue - totalProfit) / totalCars : 0;
      
      // Utilization (assuming 8-car hauler)
      const maxCapacity = 8;
      const potentialCars = trips.length * maxCapacity * 2; // Round trip
      const utilizationRate = potentialCars > 0 ? (totalCars / potentialCars * 100) : 0;
      
      // Operating ratio
      const operatingRatio = totalRevenue > 0 ? ((totalRevenue - totalProfit) / totalRevenue * 100) : 100;
      
      // Per truck metrics
      const truckCount = trucks.length || 1;
      const monthCount = tripVolume.monthCount || 1;
      const profitPerTruckPerMonth = totalProfit / truckCount / monthCount;
      const tripsPerTruckPerMonth = tripVolume.totalTripValue / truckCount / monthCount;
      
      // Target benchmarks
      const targets = {
        profitPerMile: 0.50,
        profitPerCar: 75,
        profitPerTrip: 500,
        profitPerTruckPerMonth: 3000,
        revenuePerMile: 2.50,
        costPerMile: 2.00,
        utilizationRate: 85,
        operatingRatio: 85,
        tripsPerMonth: 2 // "Good Season" target
      };
      
      // Health scores (0-100)
      const scores = {
        profitPerMile: Math.min(100, (profitPerMile / targets.profitPerMile) * 100),
        profitPerCar: Math.min(100, (profitPerCar / targets.profitPerCar) * 100),
        utilizationRate: Math.min(100, (utilizationRate / targets.utilizationRate) * 100),
        operatingRatio: Math.min(100, (targets.operatingRatio / Math.max(operatingRatio, 1)) * 100),
        tripsPerMonth: Math.min(100, (tripsPerTruckPerMonth / targets.tripsPerMonth) * 100)
      };
      
      const overallHealthScore = Object.values(scores).reduce((s, v) => s + v, 0) / Object.keys(scores).length;
      
      return {
        metrics: {
          profitPerMile,
          profitPerCar,
          profitPerTrip,
          profitPerTruckPerMonth,
          revenuePerMile,
          revenuePerCar,
          costPerMile,
          costPerCar,
          utilizationRate,
          operatingRatio,
          tripsPerTruckPerMonth
        },
        targets,
        scores,
        overallHealthScore,
        totalMiles,
        totalCars,
        totalRevenue,
        totalProfit,
        truckCount,
        tripCount: trips.length
      };
    }

    // ============ DISPATCHER PRICING GUIDANCE ============
    function getDispatcherPricingGuidance(tripId) {
      const breakEven = calculateBreakEven({ tripId });
      const efficiency = calculateEfficiencyMetrics();
      const trip = appData.trips.find(t => t.id === tripId);
      const orders = appData.orders.filter(o => o.trip_id === tripId);
      const fin = getTripFin(tripId);
      
      if (!trip) return null;
      
      const currentCars = orders.length;
      const maxCapacity = 8;
      const remainingSlots = maxCapacity - currentCars;
      const currentRevenue = fin.loadRevenue;
      const currentPPC = currentCars > 0 ? currentRevenue / currentCars : 0;
      
      // Calculate recommended prices
      const minPPC = breakEven.breakEvenPPC; // Minimum to not lose money
      const targetPPC = breakEven.profitablePPC; // Target for good profit
      const avgMarketPPC = efficiency.metrics.revenuePerCar; // Historical average
      
      // Status indicators
      let tripStatus = 'LOADING';
      let statusColor = '#f59e0b';
      let statusMessage = '';
      
      if (fin.netProfit >= breakEven.fixedCostPerTrip) {
        tripStatus = 'PROFITABLE';
        statusColor = '#22c55e';
        statusMessage = `On track for $${fin.netProfit.toFixed(0)} profit`;
      } else if (fin.netProfit >= 0) {
        tripStatus = 'BREAK_EVEN';
        statusColor = '#3b82f6';
        statusMessage = 'Covering direct costs, need more revenue for profit';
      } else {
        tripStatus = 'BELOW_TARGET';
        statusColor = '#ef4444';
        statusMessage = `Need $${Math.abs(fin.netProfit).toFixed(0)} more to break even`;
      }
      
      // Calculate what remaining slots need to average
      let recommendedPPCForRemaining = targetPPC;
      if (currentCars > 0 && remainingSlots > 0) {
        const targetTotalRevenue = targetPPC * maxCapacity;
        const revenueNeeded = targetTotalRevenue - currentRevenue;
        recommendedPPCForRemaining = revenueNeeded / remainingSlots;
      }
      
      return {
        tripId,
        tripNumber: trip.trip_number,
        currentCars,
        remainingSlots,
        maxCapacity,
        currentRevenue,
        currentPPC,
        currentProfit: fin.netProfit,
        tripStatus,
        statusColor,
        statusMessage,
        pricing: {
          minimum: Math.max(0, minPPC),
          target: targetPPC,
          marketAvg: avgMarketPPC,
          recommendedForRemaining: Math.max(0, recommendedPPCForRemaining)
        },
        breakEvenInfo: {
          breakEvenPPC: breakEven.breakEvenPPC,
          fixedCostAllocation: breakEven.fixedCostPerTrip,
          truckGrossRatio: breakEven.truckGrossRatio
        }
      };
    }

    // ============ RENDER EXECUTIVE FINANCIAL DASHBOARD ============
    function renderExecutiveDashboard(c) {
      const efficiency = calculateEfficiencyMetrics();
      const cashFlow = calculateCashFlow();
      const incomeStatement = generateIncomeStatement();
      const forecast = generateForecast(6);
      const tripVolume = calculateTripVolume(appData.trips);
      const breakEven = calculateBreakEven();
      
      // Health score color
      const healthColor = efficiency.overallHealthScore >= 80 ? '#22c55e' 
        : efficiency.overallHealthScore >= 60 ? '#f59e0b' 
        : '#ef4444';
      
      const healthGrade = efficiency.overallHealthScore >= 90 ? 'A+' 
        : efficiency.overallHealthScore >= 80 ? 'A' 
        : efficiency.overallHealthScore >= 70 ? 'B' 
        : efficiency.overallHealthScore >= 60 ? 'C' 
        : efficiency.overallHealthScore >= 50 ? 'D' 
        : 'F';
      
      // Tabs for consolidated view
      const tabs = `
        <div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;">
          <button class="btn btn-primary" style="padding:6px 12px;font-size:12px" onclick="finTab='executive';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ¢ Executive</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='analysis';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ“ˆ Analysis</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='overview';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ“Š Overview</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='costs';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ’¸ Costs</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='trips';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸš› By Trip</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='drivers';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ‘¤ By Driver</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='brokers';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ¤ By Broker</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='lanes';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ—ºï¸ By Lane</button>
        </div>
      `;
      
      c.innerHTML = tabs + `
        <div class="header">
          <h2>ðŸ¢ Executive Financial Dashboard</h2>
          <div style="display:flex;gap:12px">
            <button class="btn btn-secondary" onclick="window.print()">ðŸ–¨ï¸ Print</button>
            <button class="btn btn-secondary" onclick="loadAllData(true).then(()=>renderPage())">ðŸ”„ Refresh</button>
          </div>
        </div>
        
        <!-- Health Score Banner -->
        <div style="background:linear-gradient(135deg,${healthColor}20,${healthColor}10);border:2px solid ${healthColor};border-radius:16px;padding:24px;margin-bottom:24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:20px">
          <div>
            <div style="font-size:14px;color:${healthColor};font-weight:600;margin-bottom:4px">BUSINESS HEALTH SCORE</div>
            <div style="font-size:48px;font-weight:800;color:${healthColor};line-height:1">${efficiency.overallHealthScore.toFixed(0)}<span style="font-size:24px">/100</span></div>
            <div style="font-size:16px;color:var(--text-secondary);margin-top:4px">Grade: ${healthGrade}</div>
          </div>
          <div style="display:flex;gap:24px;flex-wrap:wrap">
            ${Object.entries(efficiency.scores).map(([key, score]) => `
              <div style="text-align:center">
                <div style="width:60px;height:60px;border-radius:50%;border:4px solid ${score >= 80 ? '#22c55e' : score >= 60 ? '#f59e0b' : '#ef4444'};display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:${score >= 80 ? '#22c55e' : score >= 60 ? '#f59e0b' : '#ef4444'}">${score.toFixed(0)}%</div>
                <div style="font-size:10px;color:var(--text-muted);margin-top:4px;text-transform:uppercase">${key.replace(/([A-Z])/g, ' $1').trim()}</div>
              </div>
            `).join('')}
          </div>
        </div>
        
        <!-- AI-Powered Optimization Recommendations (moved here) -->
        <div class="card" style="margin-bottom:16px">
          <div class="card-header" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);color:white;padding:12px 16px">
            <h3 style="color:white;font-size:14px">ðŸ’¡ AI-Powered Optimization Recommendations</h3>
          </div>
          <div style="padding:14px">
            ${generateOptimizationRecommendations(efficiency, tripVolume, breakEven, forecast)}
          </div>
        </div>
        
        <!-- Key Financial Metrics Row -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
          <div class="stat-card" style="border-left:4px solid #22c55e">
            <div class="stat-icon green">ðŸ’°</div>
            <div class="stat-content">
              <div class="label">Total Revenue</div>
              <div class="value green">${formatMoney(efficiency.totalRevenue)}</div>
              <div class="trend up">â†‘ ${formatMoney(forecast.avgMonthlyRevenue)}/mo avg</div>
            </div>
          </div>
          <div class="stat-card" style="border-left:4px solid ${efficiency.totalProfit >= 0 ? '#22c55e' : '#ef4444'}">
            <div class="stat-icon ${efficiency.totalProfit >= 0 ? 'green' : 'red'}">ðŸ“ˆ</div>
            <div class="stat-content">
              <div class="label">Net Profit</div>
              <div class="value ${efficiency.totalProfit >= 0 ? 'green' : 'red'}">${formatMoney(efficiency.totalProfit)}</div>
              <div class="trend ${efficiency.totalProfit >= 0 ? 'up' : 'down'}">${incomeStatement.netProfitMargin.toFixed(1)}% margin</div>
            </div>
          </div>
          <div class="stat-card" style="border-left:4px solid #3b82f6">
            <div class="stat-icon blue">ðŸ’µ</div>
            <div class="stat-content">
              <div class="label">Cash Position</div>
              <div class="value">${formatMoney(cashFlow.netCashFlow)}</div>
              <div style="font-size:11px;color:var(--text-muted)">${formatMoney(cashFlow.outstandingReceivables)} outstanding</div>
            </div>
          </div>
          <div class="stat-card" style="border-left:4px solid #8b5cf6">
            <div class="stat-icon" style="background:rgba(139,92,246,0.12);color:#8b5cf6">ðŸš›</div>
            <div class="stat-content">
              <div class="label">Profit Per Mile</div>
              <div class="value" style="color:${efficiency.metrics.profitPerMile >= 0.50 ? '#22c55e' : '#f59e0b'}">${formatMoney(efficiency.metrics.profitPerMile)}</div>
              <div style="font-size:11px;color:var(--text-muted)">Target: $0.50+</div>
            </div>
          </div>
        </div>
        
        <!-- Quick View - Company Profitability Metrics -->
        ${(function() {
          const monthlyFixedCosts = (appData.fixed_costs || []).reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);
          const periodMonths = Math.max(1, incomeStatement.periodMonths || 1);
          const totalFixedCosts = monthlyFixedCosts * periodMonths;
          const maintenanceCosts = incomeStatement.operatingExpenses.maintenanceCosts || 0;
          const totalOperatingCosts = incomeStatement.revenue.brokerFees + incomeStatement.revenue.localFees + incomeStatement.directCosts.totalDirectCosts + totalFixedCosts + maintenanceCosts;
          const cpm = efficiency.totalMiles > 0 ? (totalOperatingCosts / efficiency.totalMiles) : 0;
          const rpm = efficiency.totalMiles > 0 ? (efficiency.totalRevenue / efficiency.totalMiles) : 0;
          const marginPerMile = rpm - cpm;
          const currentAvgPrice = efficiency.totalCars > 0 ? (efficiency.totalRevenue / efficiency.totalCars) : 0;
          const targetVehiclePrice = breakEven.profitablePPC || 0;
          const priceGap = targetVehiclePrice - currentAvgPrice;
          
          return '<div class="card" style="margin-bottom:24px;background:linear-gradient(135deg,#1e293b,#334155);color:white;overflow:hidden">' +
            '<div style="padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.1)">' +
            '<div style="display:flex;align-items:center;justify-content:space-between">' +
            '<h3 style="margin:0;color:white;font-size:16px">âš¡ Quick View - Company Profitability</h3>' +
            '<span style="background:rgba(255,255,255,0.15);padding:4px 10px;border-radius:12px;font-size:11px">' + efficiency.totalMiles.toLocaleString() + ' miles â€¢ ' + efficiency.totalCars + ' cars</span>' +
            '</div></div>' +
            '<div style="display:grid;grid-template-columns:repeat(6,1fr);gap:0">' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1)">' +
            '<div style="font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Cost Per Mile</div>' +
            '<div style="font-size:28px;font-weight:700;color:#f87171">$' + cpm.toFixed(2) + '</div>' +
            '<div style="font-size:10px;color:#94a3b8;margin-top:4px">Operating CPM</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1)">' +
            '<div style="font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Revenue Per Mile</div>' +
            '<div style="font-size:28px;font-weight:700;color:#4ade80">$' + rpm.toFixed(2) + '</div>' +
            '<div style="font-size:10px;color:#94a3b8;margin-top:4px">Gross RPM</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1);background:' + (marginPerMile >= 0 ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)') + '">' +
            '<div style="font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Margin Per Mile</div>' +
            '<div style="font-size:28px;font-weight:700;color:' + (marginPerMile >= 0 ? '#4ade80' : '#f87171') + '">$' + marginPerMile.toFixed(2) + '</div>' +
            '<div style="font-size:10px;color:' + (marginPerMile >= 0 ? '#86efac' : '#fca5a5') + ';margin-top:4px">' + (marginPerMile >= 0 ? 'âœ“ Profitable' : 'âœ— Losing Money') + '</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1)">' +
            '<div style="font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Avg Vehicle Price</div>' +
            '<div style="font-size:28px;font-weight:700;color:#60a5fa">$' + currentAvgPrice.toFixed(0) + '</div>' +
            '<div style="font-size:10px;color:#94a3b8;margin-top:4px">Current Average</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1)">' +
            '<div style="font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Break-Even Price</div>' +
            '<div style="font-size:28px;font-weight:700;color:#a78bfa">$' + targetVehiclePrice.toFixed(0) + '</div>' +
            '<div style="font-size:10px;color:#94a3b8;margin-top:4px">Min per vehicle</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;background:' + (priceGap <= 0 ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)') + '">' +
            '<div style="font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Profit Per Vehicle</div>' +
            '<div style="font-size:28px;font-weight:700;color:' + (priceGap <= 0 ? '#4ade80' : '#f87171') + '">$' + Math.abs(currentAvgPrice - targetVehiclePrice).toFixed(0) + '</div>' +
            '<div style="font-size:10px;color:' + (priceGap <= 0 ? '#86efac' : '#fca5a5') + ';margin-top:4px">' + (priceGap <= 0 ? 'âœ“ Profitable' : 'âœ— Losing $' + Math.abs(priceGap).toFixed(0) + '/car') + '</div>' +
            '</div>' +
            '</div></div>';
        })()}
        
        <!-- Two Column Layout -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px">
          
          <!-- Income Statement Summary -->
          <div class="card">
            <div class="card-header" style="background:linear-gradient(135deg,#059669,#10b981);color:white">
              <h3 style="color:white">ðŸ“‹ Income Statement (P&L)</h3>
            </div>
            <div style="padding:20px">
              <table style="width:100%;font-size:14px">
                <tr style="background:#f0fdf4"><td colspan="2" style="font-weight:700;color:#166534;padding:10px">REVENUE</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Gross Revenue</td><td style="text-align:right;font-weight:600">${formatMoney(incomeStatement.revenue.grossRevenue)}</td></tr>
                <tr><td style="padding:8px 10px 8px 24px;color:#64748b">Less: Broker Fees</td><td style="text-align:right;color:#ef4444">(${formatMoney(incomeStatement.revenue.brokerFees)})</td></tr>
                <tr><td style="padding:8px 10px 8px 24px;color:#64748b">Less: Local Fees</td><td style="text-align:right;color:#f59e0b">(${formatMoney(incomeStatement.revenue.localFees)})</td></tr>
                <tr style="border-top:1px solid var(--border)"><td style="padding:10px;font-weight:600">Net Revenue</td><td style="text-align:right;font-weight:700">${formatMoney(incomeStatement.revenue.netRevenue)}</td></tr>
                
                <tr style="background:#fef2f2"><td colspan="2" style="font-weight:700;color:#991b1b;padding:10px">DIRECT COSTS</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Driver Cut</td><td style="text-align:right">(${formatMoney(incomeStatement.directCosts.driverCut)})</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Fuel</td><td style="text-align:right">(${formatMoney(incomeStatement.directCosts.fuelCosts)})</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Tolls & Permits</td><td style="text-align:right">(${formatMoney(incomeStatement.directCosts.tollsPermits)})</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Other Direct</td><td style="text-align:right">(${formatMoney(incomeStatement.directCosts.otherDirectCosts)})</td></tr>
                <tr style="background:#bbf7d0"><td style="padding:10px;font-weight:700">GROSS PROFIT</td><td style="text-align:right;font-weight:700;color:#166534">${formatMoney(incomeStatement.grossProfit)} <span style="font-size:12px">(${incomeStatement.grossProfitMargin.toFixed(1)}%)</span></td></tr>
                
                <tr style="background:#fef3c7"><td colspan="2" style="font-weight:700;color:#92400e;padding:10px">OPERATING EXPENSES</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Fixed Costs</td><td style="text-align:right">(${formatMoney(incomeStatement.operatingExpenses.fixedCosts)})</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Maintenance</td><td style="text-align:right">(${formatMoney(incomeStatement.operatingExpenses.maintenanceCosts)})</td></tr>
                <tr style="background:${incomeStatement.netProfit >= 0 ? '#dcfce7' : '#fee2e2'}"><td style="padding:12px;font-weight:700;font-size:16px">NET PROFIT</td><td style="text-align:right;font-weight:700;font-size:18px;color:${incomeStatement.netProfit >= 0 ? '#166534' : '#dc2626'}">${formatMoney(incomeStatement.netProfit)}</td></tr>
              </table>
            </div>
          </div>
          
          <!-- Cash Flow Summary -->
          <div class="card">
            <div class="card-header" style="background:linear-gradient(135deg,#1e40af,#3b82f6);color:white">
              <h3 style="color:white">ðŸ’µ Cash Flow Statement</h3>
            </div>
            <div style="padding:20px">
              <table style="width:100%;font-size:14px">
                <tr style="background:#dbeafe"><td colspan="2" style="font-weight:700;color:#1e40af;padding:10px">CASH INFLOWS</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">COD Collected</td><td style="text-align:right;color:#22c55e;font-weight:600">+${formatMoney(cashFlow.inflows.codCollected)}</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">COP Collected</td><td style="text-align:right;color:#22c55e;font-weight:600">+${formatMoney(cashFlow.inflows.copCollected)}</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Local COD</td><td style="text-align:right;color:#22c55e;font-weight:600">+${formatMoney(cashFlow.inflows.localCodCollected)}</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Check Payments</td><td style="text-align:right;color:#22c55e;font-weight:600">+${formatMoney(cashFlow.inflows.checkPayments)}</td></tr>
                <tr style="border-top:1px solid var(--border)"><td style="padding:10px;font-weight:600">Total Cash In</td><td style="text-align:right;font-weight:700;color:#22c55e">${formatMoney(cashFlow.inflows.totalCashInflow)}</td></tr>
                
                <tr style="background:#fee2e2"><td colspan="2" style="font-weight:700;color:#991b1b;padding:10px">CASH OUTFLOWS</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Driver Payments</td><td style="text-align:right;color:#ef4444">-${formatMoney(cashFlow.outflows.driverPayments)}</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Fuel</td><td style="text-align:right;color:#ef4444">-${formatMoney(cashFlow.outflows.fuelExpenses)}</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Tolls & Permits</td><td style="text-align:right;color:#ef4444">-${formatMoney(cashFlow.outflows.tollsPermits)}</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Fixed Costs</td><td style="text-align:right;color:#ef4444">-${formatMoney(cashFlow.outflows.totalFixedCosts)}</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Maintenance & Other</td><td style="text-align:right;color:#ef4444">-${formatMoney(cashFlow.outflows.maintenanceExpenses + cashFlow.outflows.otherExpenses)}</td></tr>
                <tr style="border-top:1px solid var(--border)"><td style="padding:10px;font-weight:600">Total Cash Out</td><td style="text-align:right;font-weight:700;color:#ef4444">${formatMoney(cashFlow.outflows.totalCashOutflow)}</td></tr>
                
                <tr style="background:${cashFlow.netCashFlow >= 0 ? '#dcfce7' : '#fee2e2'}"><td style="padding:12px;font-weight:700;font-size:16px">NET CASH FLOW</td><td style="text-align:right;font-weight:700;font-size:18px;color:${cashFlow.netCashFlow >= 0 ? '#166534' : '#dc2626'}">${formatMoney(cashFlow.netCashFlow)}</td></tr>
                <tr><td style="padding:10px;color:#64748b">Outstanding Receivables</td><td style="text-align:right;font-weight:600;color:#f59e0b">${formatMoney(cashFlow.outstandingReceivables)}</td></tr>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Trip Volume & Seasonality -->
        <div class="card" style="margin-bottom:24px">
          <div class="card-header" style="background:linear-gradient(135deg,#7c3aed,#a855f7);color:white">
            <h3 style="color:white">ðŸ“… Trip Volume & Seasonality Analysis</h3>
            <div style="display:flex;gap:12px;align-items:center">
              <span style="font-size:13px;opacity:0.9">Target: 2 trips/truck/month</span>
            </div>
          </div>
          <div style="padding:20px">
            <!-- Trip Volume Stats -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:24px">
              <div style="background:#f3e8ff;padding:16px;border-radius:12px;text-align:center">
                <div style="font-size:11px;color:#7c3aed;font-weight:600">TOTAL TRIPS</div>
                <div style="font-size:28px;font-weight:800;color:#7c3aed">${tripVolume.totalTrips}</div>
                <div style="font-size:12px;color:#64748b">${tripVolume.totalTripValue.toFixed(1)} trip value</div>
              </div>
              <div style="background:#dbeafe;padding:16px;border-radius:12px;text-align:center">
                <div style="font-size:11px;color:#1e40af;font-weight:600">AVG TRIPS/MONTH</div>
                <div style="font-size:28px;font-weight:800;color:${tripVolume.monthlyAvg >= 2 * efficiency.truckCount ? '#22c55e' : '#f59e0b'}">${tripVolume.monthlyAvg.toFixed(1)}</div>
                <div style="font-size:12px;color:#64748b">Target: ${2 * efficiency.truckCount}/mo</div>
              </div>
              <div style="background:#dcfce7;padding:16px;border-radius:12px;text-align:center">
                <div style="font-size:11px;color:#166534;font-weight:600">TRIPS/TRUCK/MONTH</div>
                <div style="font-size:28px;font-weight:800;color:${efficiency.metrics.tripsPerTruckPerMonth >= 2 ? '#22c55e' : efficiency.metrics.tripsPerTruckPerMonth >= 1.5 ? '#f59e0b' : '#ef4444'}">${efficiency.metrics.tripsPerTruckPerMonth.toFixed(2)}</div>
                <div style="font-size:12px;color:#64748b">${efficiency.metrics.tripsPerTruckPerMonth >= 2 ? 'âœ… On Target' : 'âš ï¸ Below Target'}</div>
              </div>
              <div style="background:#fef3c7;padding:16px;border-radius:12px;text-align:center">
                <div style="font-size:11px;color:#92400e;font-weight:600">DATA PERIOD</div>
                <div style="font-size:28px;font-weight:800;color:#92400e">${tripVolume.monthCount}</div>
                <div style="font-size:12px;color:#64748b">months of data</div>
              </div>
            </div>
            
            <!-- Monthly Breakdown Chart (CSS bars) -->
            <div style="margin-bottom:20px">
              <div style="font-weight:600;margin-bottom:12px;color:var(--text-primary)">Monthly Trip Volume</div>
              <div style="display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto">
                ${Object.entries(tripVolume.monthlyData).slice(-12).map(([month, data]) => {
                  const maxTrips = Math.max(...Object.values(tripVolume.monthlyData).map(d => d.tripValue)) || 1;
                  const barWidth = (data.tripValue / maxTrips * 100);
                  const isGoodMonth = data.tripValue >= 2 * efficiency.truckCount;
                  return `
                    <div style="display:flex;align-items:center;gap:12px">
                      <div style="width:80px;font-size:13px;font-weight:500;color:var(--text-secondary)">${month}</div>
                      <div style="flex:1;background:var(--bg-tertiary);border-radius:4px;height:24px;overflow:hidden">
                        <div style="background:${isGoodMonth ? 'linear-gradient(90deg,#22c55e,#16a34a)' : 'linear-gradient(90deg,#f59e0b,#d97706)'};height:100%;width:${barWidth}%;border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding-right:8px">
                          <span style="font-size:11px;font-weight:600;color:white">${data.tripValue.toFixed(1)}</span>
                        </div>
                      </div>
                      <div style="width:100px;font-size:12px;color:var(--text-muted)">${formatMoney(data.revenue)}</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
            
            <!-- Truck Performance Table -->
            <div style="font-weight:600;margin-bottom:12px;color:var(--text-primary)">Performance by Truck</div>
            <div class="table-wrapper" style="border-radius:12px;border:1px solid var(--border)">
              <table>
                <thead>
                  <tr>
                    <th>Truck</th>
                    <th>Total Trips</th>
                    <th>Trip Value</th>
                    <th>Avg Trips/Month</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  ${appData.trucks.filter(t => t.status === 'ACTIVE').map(truck => {
                    const truckVolume = tripVolume.truckData[truck.id] || { totalTrips: 0, totalTripValue: 0 };
                    const avgPerMonth = tripVolume.monthCount > 0 ? truckVolume.totalTripValue / tripVolume.monthCount : 0;
                    const status = avgPerMonth >= 2 ? 'EXCELLENT' : avgPerMonth >= 1.5 ? 'GOOD' : avgPerMonth >= 1 ? 'FAIR' : 'NEEDS_ATTENTION';
                    const statusColors = { EXCELLENT: '#22c55e', GOOD: '#3b82f6', FAIR: '#f59e0b', NEEDS_ATTENTION: '#ef4444' };
                    return `
                      <tr>
                        <td><strong>#${truck.truck_number}</strong></td>
                        <td>${truckVolume.totalTrips}</td>
                        <td>${truckVolume.totalTripValue.toFixed(1)}</td>
                        <td style="font-weight:600;color:${statusColors[status]}">${avgPerMonth.toFixed(2)}</td>
                        <td><span class="badge" style="background:${statusColors[status]}20;color:${statusColors[status]};border:1px solid ${statusColors[status]}40">${status.replace('_', ' ')}</span></td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Forecasting Section -->
        <div class="card" style="margin-bottom:24px">
          <div class="card-header" style="background:linear-gradient(135deg,#0891b2,#06b6d4);color:white">
            <h3 style="color:white">ðŸ”® Financial Forecast (Next 6 Months)</h3>
          </div>
          <div style="padding:20px">
            <!-- Forecast Summary -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px">
              <div style="background:#ecfeff;padding:16px;border-radius:12px;text-align:center;border:1px solid #06b6d4">
                <div style="font-size:11px;color:#0891b2;font-weight:600">PROJECTED REVENUE (6MO)</div>
                <div style="font-size:24px;font-weight:800;color:#0891b2">${formatMoney(forecast.forecasts.reduce((s,f) => s + f.revenue, 0))}</div>
              </div>
              <div style="background:#f0fdf4;padding:16px;border-radius:12px;text-align:center;border:1px solid #22c55e">
                <div style="font-size:11px;color:#16a34a;font-weight:600">PROJECTED PROFIT (6MO)</div>
                <div style="font-size:24px;font-weight:800;color:#16a34a">${formatMoney(forecast.forecasts.reduce((s,f) => s + f.profit, 0))}</div>
              </div>
              <div style="background:#fefce8;padding:16px;border-radius:12px;text-align:center;border:1px solid #eab308">
                <div style="font-size:11px;color:#ca8a04;font-weight:600">TREND</div>
                <div style="font-size:24px;font-weight:800;color:${forecast.trend >= 0 ? '#16a34a' : '#ef4444'}">${forecast.trend >= 0 ? 'ðŸ“ˆ' : 'ðŸ“‰'} ${forecast.trend >= 0 ? '+' : ''}${formatMoney(forecast.trend)}/mo</div>
              </div>
            </div>
            
            <!-- Monthly Forecasts -->
            <div class="table-wrapper" style="border-radius:12px;border:1px solid var(--border)">
              <table>
                <thead>
                  <tr>
                    <th>Month</th>
                    <th>Forecast Revenue</th>
                    <th>Forecast Profit</th>
                    <th>Est. Cars</th>
                    <th>Est. Trips</th>
                    <th>Seasonal Factor</th>
                    <th>Confidence</th>
                  </tr>
                </thead>
                <tbody>
                  ${forecast.forecasts.map(f => `
                    <tr>
                      <td><strong>${f.month}</strong></td>
                      <td class="money">${formatMoney(f.revenue)}</td>
                      <td class="money ${f.profit >= 0 ? 'positive' : 'negative'}">${formatMoney(f.profit)}</td>
                      <td>${f.cars.toFixed(0)}</td>
                      <td>${f.trips.toFixed(1)}</td>
                      <td>${(f.seasonalFactor * 100).toFixed(0)}%</td>
                      <td>
                        <div style="background:var(--bg-tertiary);border-radius:4px;height:8px;width:60px">
                          <div style="background:${f.confidence >= 0.7 ? '#22c55e' : '#f59e0b'};height:100%;width:${f.confidence * 100}%;border-radius:4px"></div>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <!-- Scenarios -->
            <div style="margin-top:24px">
              <div style="font-weight:600;margin-bottom:12px">ðŸ“Š Annual Projection Scenarios</div>
              <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
                <div style="background:#fee2e2;padding:16px;border-radius:12px;text-align:center">
                  <div style="font-size:12px;color:#991b1b;font-weight:600">CONSERVATIVE (-15%)</div>
                  <div style="font-size:20px;font-weight:700;color:#dc2626;margin-top:8px">${formatMoney(forecast.scenarios.conservative.revenue)}</div>
                  <div style="font-size:14px;color:#dc2626">Profit: ${formatMoney(forecast.scenarios.conservative.profit)}</div>
                </div>
                <div style="background:#dbeafe;padding:16px;border-radius:12px;text-align:center;border:2px solid #3b82f6">
                  <div style="font-size:12px;color:#1e40af;font-weight:600">BASE CASE</div>
                  <div style="font-size:20px;font-weight:700;color:#2563eb;margin-top:8px">${formatMoney(forecast.scenarios.base.revenue)}</div>
                  <div style="font-size:14px;color:#2563eb">Profit: ${formatMoney(forecast.scenarios.base.profit)}</div>
                </div>
                <div style="background:#dcfce7;padding:16px;border-radius:12px;text-align:center">
                  <div style="font-size:12px;color:#166534;font-weight:600">OPTIMISTIC (+15%)</div>
                  <div style="font-size:20px;font-weight:700;color:#16a34a;margin-top:8px">${formatMoney(forecast.scenarios.optimistic.revenue)}</div>
                  <div style="font-size:14px;color:#16a34a">Profit: ${formatMoney(forecast.scenarios.optimistic.profit)}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Break-Even & Pricing Guidance -->
        <div class="card" style="margin-bottom:24px">
          <div class="card-header" style="background:linear-gradient(135deg,#dc2626,#ef4444);color:white">
            <h3 style="color:white">ðŸŽ¯ Break-Even Analysis & Pricing Targets</h3>
          </div>
          <div style="padding:20px">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px">
              <div style="background:#fef2f2;padding:20px;border-radius:12px;text-align:center;border:2px solid #fecaca">
                <div style="font-size:12px;color:#991b1b;font-weight:600;margin-bottom:8px">BREAK-EVEN PPC</div>
                <div style="font-size:32px;font-weight:800;color:#dc2626">${formatMoney(breakEven.breakEvenPPC)}</div>
                <div style="font-size:12px;color:#64748b;margin-top:8px">Minimum to cover all costs</div>
              </div>
              <div style="background:#dcfce7;padding:20px;border-radius:12px;text-align:center;border:2px solid #bbf7d0">
                <div style="font-size:12px;color:#166534;font-weight:600;margin-bottom:8px">TARGET PPC (PROFITABLE)</div>
                <div style="font-size:32px;font-weight:800;color:#16a34a">${formatMoney(breakEven.profitablePPC)}</div>
                <div style="font-size:12px;color:#64748b;margin-top:8px">15% above break-even</div>
              </div>
              <div style="background:#dbeafe;padding:20px;border-radius:12px;text-align:center;border:2px solid #bfdbfe">
                <div style="font-size:12px;color:#1e40af;font-weight:600;margin-bottom:8px">CURRENT AVG PPC</div>
                <div style="font-size:32px;font-weight:800;color:#2563eb">${formatMoney(efficiency.metrics.revenuePerCar)}</div>
                <div style="font-size:12px;color:#64748b;margin-top:8px">${efficiency.metrics.revenuePerCar >= breakEven.profitablePPC ? 'âœ… Above target' : 'âš ï¸ Below target'}</div>
              </div>
              <div style="background:#f3e8ff;padding:20px;border-radius:12px;text-align:center;border:2px solid #e9d5ff">
                <div style="font-size:12px;color:#7c3aed;font-weight:600;margin-bottom:8px">FIXED COST/TRIP</div>
                <div style="font-size:32px;font-weight:800;color:#7c3aed">${formatMoney(breakEven.fixedCostPerTrip)}</div>
                <div style="font-size:12px;color:#64748b;margin-top:8px">Overhead allocation</div>
              </div>
            </div>
            
            <!-- Cost Structure -->
            <div style="margin-top:24px;padding:20px;background:var(--bg-tertiary);border-radius:12px">
              <div style="font-weight:600;margin-bottom:16px">ðŸ’¡ Cost Structure Analysis</div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px">
                <div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-secondary);border-radius:8px">
                  <span>Avg Broker Fee</span>
                  <span style="font-weight:600">${(breakEven.avgBrokerFeeRatio * 100).toFixed(1)}%</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-secondary);border-radius:8px">
                  <span>Avg Local Fee</span>
                  <span style="font-weight:600">${(breakEven.avgLocalFeeRatio * 100).toFixed(1)}%</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-secondary);border-radius:8px">
                  <span>Avg Driver Cut</span>
                  <span style="font-weight:600">${(breakEven.avgDriverCutRatio * 100).toFixed(1)}%</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-secondary);border-radius:8px">
                  <span>Truck Gross Ratio</span>
                  <span style="font-weight:600;color:#22c55e">${(breakEven.truckGrossRatio * 100).toFixed(1)}%</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-secondary);border-radius:8px">
                  <span>Avg Expense/Trip</span>
                  <span style="font-weight:600">${formatMoney(breakEven.avgExpensePerTrip)}</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-secondary);border-radius:8px">
                  <span>Avg Cars/Trip</span>
                  <span style="font-weight:600">${breakEven.avgCarsPerTrip.toFixed(1)}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ============ OPTIMIZATION RECOMMENDATIONS ENGINE ============
    function generateOptimizationRecommendations(efficiency, tripVolume, breakEven, forecast) {
      const recommendations = [];
      
      // 1. Trip Volume Analysis
      if (efficiency.metrics.tripsPerTruckPerMonth < 2) {
        const currentTrips = efficiency.metrics.tripsPerTruckPerMonth;
        const targetTrips = 2;
        const additionalTripsNeeded = (targetTrips - currentTrips) * efficiency.truckCount;
        const potentialRevenue = additionalTripsNeeded * (efficiency.totalRevenue / efficiency.tripCount || 0);
        
        recommendations.push({
          category: 'UTILIZATION',
          priority: 'HIGH',
          icon: 'ðŸš›',
          title: 'Increase Trip Frequency',
          description: `Currently averaging ${currentTrips.toFixed(2)} trips/truck/month. Target is 2.0 trips.`,
          action: `Schedule ${additionalTripsNeeded.toFixed(1)} more trips/month across fleet`,
          impact: `Potential additional revenue: ${formatMoney(potentialRevenue)}/month`,
          color: '#ef4444'
        });
      }
      
      // 2. Utilization Rate
      if (efficiency.metrics.utilizationRate < 85) {
        const currentUtil = efficiency.metrics.utilizationRate;
        const additionalCars = ((85 - currentUtil) / 100) * efficiency.tripCount * 16; // 8 cars Ã— 2 ways
        
        recommendations.push({
          category: 'UTILIZATION',
          priority: 'HIGH',
          icon: 'ðŸ“¦',
          title: 'Improve Load Utilization',
          description: `Current utilization at ${currentUtil.toFixed(1)}% vs 85% target.`,
          action: `Fill ${additionalCars.toFixed(0)} more car slots per period`,
          impact: `Could increase revenue by ${formatMoney(additionalCars * breakEven.profitablePPC)}`,
          color: '#f59e0b'
        });
      }
      
      // 3. Pricing Analysis
      if (efficiency.metrics.revenuePerCar < breakEven.profitablePPC) {
        const ppcGap = breakEven.profitablePPC - efficiency.metrics.revenuePerCar;
        
        recommendations.push({
          category: 'PRICING',
          priority: 'HIGH',
          icon: 'ðŸ’°',
          title: 'Increase Average Price Per Car',
          description: `Current PPC of ${formatMoney(efficiency.metrics.revenuePerCar)} is below target ${formatMoney(breakEven.profitablePPC)}.`,
          action: `Increase average booking price by ${formatMoney(ppcGap)}/car`,
          impact: `Would add ${formatMoney(ppcGap * efficiency.totalCars)} to bottom line`,
          color: '#ef4444'
        });
      }
      
      // 4. Cost Reduction
      if (efficiency.metrics.operatingRatio > 85) {
        const excessCostRatio = efficiency.metrics.operatingRatio - 85;
        const excessCost = (excessCostRatio / 100) * efficiency.totalRevenue;
        
        recommendations.push({
          category: 'COSTS',
          priority: 'MEDIUM',
          icon: 'ðŸ“‰',
          title: 'Reduce Operating Costs',
          description: `Operating ratio at ${efficiency.metrics.operatingRatio.toFixed(1)}% (target: â‰¤85%)`,
          action: 'Review fuel efficiency, negotiate better rates with brokers',
          impact: `Potential savings: ${formatMoney(excessCost)}`,
          color: '#f59e0b'
        });
      }
      
      // 5. Seasonal Planning
      const lowSeasonMonths = Object.entries(tripVolume.seasonalIndex)
        .filter(([m, idx]) => idx < 0.8)
        .map(([m]) => m);
      
      if (lowSeasonMonths.length > 0) {
        recommendations.push({
          category: 'PLANNING',
          priority: 'MEDIUM',
          icon: 'ðŸ“…',
          title: 'Prepare for Seasonal Variations',
          description: `Low-volume periods identified: ${lowSeasonMonths.slice(-3).join(', ')}`,
          action: 'Build cash reserves, consider maintenance scheduling during slow periods',
          impact: 'Maintain profitability during seasonal dips',
          color: '#3b82f6'
        });
      }
      
      // 6. Driver Efficiency
      if (breakEven.avgDriverCutRatio > 0.35) {
        recommendations.push({
          category: 'OPERATIONS',
          priority: 'LOW',
          icon: 'ðŸ‘¤',
          title: 'Review Driver Compensation Structure',
          description: `Driver cut averaging ${(breakEven.avgDriverCutRatio * 100).toFixed(1)}% of clean gross`,
          action: 'Consider performance-based incentives or adjusted percentage tiers',
          impact: 'Balance driver retention with profitability',
          color: '#8b5cf6'
        });
      }
      
      // 7. Positive Reinforcement
      if (efficiency.overallHealthScore >= 80) {
        recommendations.push({
          category: 'SUCCESS',
          priority: 'INFO',
          icon: 'ðŸ†',
          title: 'Business is Performing Well!',
          description: `Health score of ${efficiency.overallHealthScore.toFixed(0)}/100 indicates strong operations`,
          action: 'Continue current practices, consider expansion opportunities',
          impact: 'Maintain competitive advantage',
          color: '#22c55e'
        });
      }
      
      // 8. Cash Flow Management
      const cashFlow = calculateCashFlow();
      if (cashFlow.outstandingReceivables > cashFlow.inflows.totalCashInflow * 0.3) {
        recommendations.push({
          category: 'CASH_FLOW',
          priority: 'MEDIUM',
          icon: 'ðŸ’µ',
          title: 'Reduce Outstanding Receivables',
          description: `${formatMoney(cashFlow.outstandingReceivables)} in unpaid invoices (${((cashFlow.outstandingReceivables / cashFlow.inflows.totalRevenue) * 100).toFixed(0)}% of revenue)`,
          action: 'Follow up on overdue invoices, consider COD for new customers',
          impact: 'Improve cash position and reduce risk',
          color: '#f59e0b'
        });
      }
      
      // Sort by priority
      const priorityOrder = { HIGH: 0, MEDIUM: 1, LOW: 2, INFO: 3 };
      recommendations.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
      
      // Generate HTML
      return `
        <div style="display:flex;flex-direction:column;gap:16px">
          ${recommendations.map(rec => `
            <div style="background:${rec.color}10;border:1px solid ${rec.color}30;border-radius:12px;padding:16px;display:flex;gap:16px">
              <div style="font-size:32px">${rec.icon}</div>
              <div style="flex:1">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                  <span style="font-weight:700;color:var(--text-primary)">${rec.title}</span>
                  <span style="font-size:10px;padding:2px 8px;border-radius:4px;background:${rec.color}20;color:${rec.color};font-weight:600">${rec.priority}</span>
                </div>
                <div style="font-size:13px;color:var(--text-secondary);margin-bottom:8px">${rec.description}</div>
                <div style="font-size:13px;color:var(--text-primary)"><strong>Action:</strong> ${rec.action}</div>
                <div style="font-size:13px;color:${rec.color};font-weight:500;margin-top:4px">ðŸ’¡ ${rec.impact}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Track if we're viewing a detail (trip, driver, truck, etc.)
    let currentDetailView = null; // { type: 'trip', id: 123 } or null
    
    async function loadAllData(forceReload = false) {
      try {
        // Check cache first (unless forced reload)
        if (!forceReload && dataCache.get('appData')) {
          appData = dataCache.get('appData');
          return;
        }
        
        // Load essential data first (what dashboard needs - including tasks)
        const [users, trucks, drivers, dispatchers, trips, orders, brokers, tasks] = await Promise.all([
          dbFetch('users'), 
          dbFetch('trucks', { order: 'truck_number' }), 
          dbFetch('drivers'), 
          dbFetch('dispatchers'), 
          dbFetch('trips', { order: 'trip_date.desc' }), 
          dbFetch('orders', { order: 'id.desc' }), 
          dbFetch('brokers', { order: 'name' }),
          dbFetch('tasks', { order: 'due_date.asc' })
        ]);
        
        // Set initial data
        appData = { 
          users, trucks, drivers, dispatchers, trips, orders, brokers: brokers || [],
          tasks: tasks || [],
          local_drivers: [], expenses: [], fixed_costs: [], variable_costs: [], 
          driver_files: [], truck_files: [], fuel_transactions: [], 
          maintenance_records: [], claims: [], tickets: [], violations: [], ticket_files: [], violation_files: [], claim_files: [], compliance_tasks: [], accidents: []
        };
        
        // Load secondary data in background (non-blocking)
        loadSecondaryData();
        
        // Cache the data
        dataCache.set('appData', appData);
      } catch (e) { 
        console.error('Failed to load data:', e);
        showToast('Failed to load data', 'error'); 
      }
    }
    
    async function loadSecondaryData() {
      try {
        const [local_drivers, expenses, fixed_costs, variable_costs, driver_files, truck_files, fuel_transactions, maintenance_records] = await Promise.all([
          dbFetch('local_drivers', { order: 'name' }),
          dbFetch('expenses'), 
          dbFetch('fixed_costs', { order: 'name' }), 
          dbFetch('variable_costs', { order: 'date.desc' }), 
          dbFetch('driver_files', { order: 'id.desc' }), 
          dbFetch('truck_files', { order: 'id.desc' }), 
          dbFetch('fuel_transactions', { order: 'transaction_date.desc' }), 
          dbFetch('maintenance_records', { order: 'service_date.desc' })
        ]);
        
        // Try to load claims separately (table may not exist yet)
        let claims = [];
        try { claims = await dbFetch('claims', { order: 'incident_date.desc' }) || []; } catch(e) { claims = []; }
        
        // Try to load tickets separately (table may not exist yet)
        let tickets = [];
        try { tickets = await dbFetch('tickets', { order: 'ticket_date.desc' }) || []; } catch(e) { tickets = []; }
        
        // Try to load violations separately (table may not exist yet)
        let violations = [];
        try { violations = await dbFetch('violations', { order: 'violation_date.desc' }) || []; } catch(e) { violations = []; }
        
        // Try to load ticket/violation files
        let ticket_files = [];
        try { ticket_files = await dbFetch('ticket_files') || []; } catch(e) { ticket_files = []; }
        let violation_files = [];
        try { violation_files = await dbFetch('violation_files') || []; } catch(e) { violation_files = []; }
        let claim_files = [];
        try { claim_files = await dbFetch('claim_files') || []; } catch(e) { claim_files = []; }
        
        // Try to load compliance tasks
        let compliance_tasks = [];
        try { compliance_tasks = await dbFetch('compliance_tasks', { order: 'next_due_date.asc' }) || []; } catch(e) { compliance_tasks = []; }
        
        // Try to load accidents
        let accidents = [];
        try { accidents = await dbFetch('accidents', { order: 'accident_date.desc' }) || []; } catch(e) { accidents = []; }
        
        // Update appData with secondary data
        Object.assign(appData, {
          local_drivers: local_drivers || [],
          expenses: expenses || [],
          fixed_costs: fixed_costs || [],
          variable_costs: variable_costs || [],
          driver_files: driver_files || [],
          truck_files: truck_files || [],
          fuel_transactions: fuel_transactions || [],
          maintenance_records: maintenance_records || [],
          claims: claims,
          tickets: tickets,
          violations: violations,
          ticket_files: ticket_files,
          violation_files: violation_files,
          claim_files: claim_files,
          compliance_tasks: compliance_tasks,
          accidents: accidents
        });
        
        // Update cache
        dataCache.set('appData', appData);
        
        // Load Samsara settings from database (shared across all users)
        await loadSamsaraSettings();
        
        // Only re-render if we're NOT viewing a detail page (trip/driver/truck detail)
        // This prevents getting kicked out of detail views when secondary data loads
        if (!currentDetailView) {
          renderPage();
        }
      } catch (e) {
        console.error('Failed to load secondary data:', e);
      }
    }
    
    // Invalidate cache and reload specific data
    async function reloadData(dataType) {
      dataCache.invalidate('appData');
      
      try {
        switch(dataType) {
          case 'trips':
            appData.trips = await dbFetch('trips', { order: 'trip_date.desc' }) || [];
            break;
          case 'orders':
            appData.orders = await dbFetch('orders', { order: 'id.desc' }) || [];
            break;
          case 'trucks':
            appData.trucks = await dbFetch('trucks', { order: 'truck_number' }) || [];
            break;
          case 'drivers':
            appData.drivers = await dbFetch('drivers') || [];
            break;
          case 'maintenance':
            appData.maintenance_records = await dbFetch('maintenance_records', { order: 'service_date.desc' }) || [];
            break;
          case 'tasks':
            appData.tasks = await dbFetch('tasks', { order: 'due_date.asc' }) || [];
            break;
          default:
            await loadAllData(true);
        }
        dataCache.set('appData', appData);
      } catch (e) {
        console.error('Failed to reload data:', e);
      }
    }

    let isSignUpMode = false;

    function renderLogin() {
      applyTheme();

      // Generate 30 particles for animated background
      let particlesHtml = '<div class="login-particles">';
      for (let i = 1; i <= 30; i++) {
        particlesHtml += '<div class="login-particle"></div>';
      }
      particlesHtml += '</div>';

      // Navigation bar
      const navBar = `
        <nav class="login-nav">
          <div class="login-nav-logo">
            <div class="login-nav-logo-icon">ðŸš›</div>
            <span>Horizon<span style="color:#22c55e">Star</span></span>
          </div>
          <div class="login-nav-links"></div>
          <div class="login-nav-buttons">
            <button class="login-nav-btn login" onclick="renderLogin()">LOGIN</button>
          </div>
        </nav>
      `;

      // Hero content (left side) with 5 features
      const heroContent = `
        <div class="login-hero-content">
          <h1>HORIZON STAR LLC<br><span>Transportation Management System</span></h1>
          <p class="login-hero-subtitle">Complete fleet operations platform â€” track, plan, optimize, and grow your transportation business</p>

          <div class="login-features">
            <div class="login-feature">
              <div class="login-feature-icon">ðŸš›</div>
              <div class="login-feature-title">FLEET</div>
              <div class="login-feature-subtitle">MANAGEMENT</div>
            </div>
            <div class="login-feature">
              <div class="login-feature-icon">ðŸ“</div>
              <div class="login-feature-title">TRIP</div>
              <div class="login-feature-subtitle">PLANNING</div>
            </div>
            <div class="login-feature">
              <div class="login-feature-icon">ðŸ—ºï¸</div>
              <div class="login-feature-title">REAL-TIME</div>
              <div class="login-feature-subtitle">TRACKING</div>
            </div>
            <div class="login-feature">
              <div class="login-feature-icon">ðŸ’°</div>
              <div class="login-feature-title">FINANCIAL</div>
              <div class="login-feature-subtitle">DASHBOARD</div>
            </div>
            <div class="login-feature">
              <div class="login-feature-icon">ðŸ“‹</div>
              <div class="login-feature-title">DRIVER</div>
              <div class="login-feature-subtitle">PAYROLL</div>
            </div>
          </div>
        </div>
      `;

      // Login Form
      const loginForm = `
        <div class="login-form-card">
          <h2>Welcome back</h2>
          <p class="subtitle">Enter your credentials to continue</p>
          <div class="login-error" id="login-error"></div>
          <form onsubmit="handleLogin(event)">
            <div class="form-group">
              <label>${t('email')}</label>
              <input type="email" id="login-email" required placeholder="you@company.com">
            </div>
            <div class="form-group">
              <label>${t('password')}</label>
              <input type="password" id="login-password" required placeholder="Your password">
              <a href="#" onclick="showForgotPassword();return false;" style="font-size:12px;color:#22c55e;text-decoration:none;display:block;text-align:right;margin-top:6px">Forgot password?</a>
            </div>
            <button type="submit" class="btn-submit" id="login-btn">${t('sign_in')}</button>
          </form>
        </div>
      `;

      // Footer bar
      const footerBar = `
        <div class="login-footer-bar">
          <span>Powered by <strong>Horizon Star LLC</strong></span>
          <span>â€¢</span>
          <span>Built by <a href="#">Levani Grigolia</a></span>
        </div>
      `;

      document.getElementById('app').innerHTML = `
        <div class="login-container">
          ${particlesHtml}
          ${navBar}
          <div class="login-hero">
            ${heroContent}
            ${loginForm}
          </div>
          ${footerBar}
        </div>
      `;
    }

    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim().toLowerCase();
      const password = document.getElementById('login-password').value;
      const errorEl = document.getElementById('login-error');
      const btnEl = document.getElementById('login-btn');
      
      // Check if account is locked
      const lockStatus = isAccountLocked(email);
      if (lockStatus.locked) {
        errorEl.textContent = `Account locked. Try again in ${lockStatus.remainingMinutes} minutes.`;
        errorEl.style.display = 'block';
        return;
      }
      
      btnEl.textContent = 'Signing in...';
      btnEl.disabled = true;
      
      try {
        // Try Supabase Auth first
        const { data: authData, error: authError } = await sb.auth.signInWithPassword({
          email: email,
          password: password
        });
        
        if (!authError && authData.session) {
          // Supabase Auth success - store session
          authSession = authData.session;
          recordLoginAttempt(email, true);
          
          // Get user from our users table
          let users = await dbFetch('users', { filter: { email: 'eq.' + email } });
          
          if (users.length === 0) {
            // Create user record if doesn't exist (new Supabase Auth user)
            const newUser = await dbInsert('users', {
              auth_id: authData.user.id,
              email: email,
              first_name: authData.user.user_metadata?.first_name || email.split('@')[0],
              last_name: authData.user.user_metadata?.last_name || '',
              role: 'DISPATCHER',
              is_active: true
            });
            users = [newUser];
          } else if (!users[0].auth_id) {
            // Link existing user to Supabase Auth
            await dbUpdate('users', users[0].id, { auth_id: authData.user.id });
            users[0].auth_id = authData.user.id;
          }
          
          currentUser = users[0];
          localStorage.setItem('horizonstar_user', JSON.stringify(currentUser));
          startSessionMonitor();
          await logActivity('LOGIN_SUCCESS', { email, method: 'supabase_auth' });
          renderApp();
          return;
        }
        
        // Supabase Auth failed - try legacy login for migration
        const users = await dbFetch('users', { filter: { email: 'eq.' + email } });
        
        if (users.length === 0) {
          recordLoginAttempt(email, false);
          const attempts = getLoginAttempts(email);
          const remaining = LOGIN_ATTEMPT_LIMIT - attempts.count;
          errorEl.textContent = `Invalid credentials. ${remaining} attempts remaining.`;
          errorEl.style.display = 'block';
          btnEl.textContent = 'Sign In';
          btnEl.disabled = false;
          return;
        }
        
        const user = users[0];
        
        // Check if user is active
        if (user.is_active === false) {
          errorEl.textContent = 'Account deactivated.';
          errorEl.style.display = 'block';
          btnEl.textContent = 'Sign In';
          btnEl.disabled = false;
          return;
        }
        
        // Check legacy password (for users not yet migrated to Supabase Auth)
        const hashedPassword = await hashPassword(password);
        const passwordMatch = user.password === hashedPassword || user.password === password;
        
        if (!passwordMatch) {
          recordLoginAttempt(email, false);
          const attempts = getLoginAttempts(email);
          
          if (attempts.count >= LOGIN_ATTEMPT_LIMIT) {
            errorEl.textContent = `Too many attempts. Account locked for ${LOGIN_LOCKOUT_MINUTES} minutes.`;
          } else {
            const remaining = LOGIN_ATTEMPT_LIMIT - attempts.count;
            errorEl.textContent = `Invalid password. ${remaining} attempts remaining.`;
          }
          errorEl.style.display = 'block';
          btnEl.textContent = 'Sign In';
          btnEl.disabled = false;
          return;
        }
        
        // Legacy password matched - migrate to Supabase Auth
        recordLoginAttempt(email, true);
        
        // Try to sign in with Supabase Auth first (user might already exist there)
        let { data: signInData, error: signInError } = await sb.auth.signInWithPassword({
          email: email,
          password: password
        });
        
        if (signInError) {
          // User doesn't exist in Supabase Auth - create account
          const { data: signUpData, error: signUpError } = await sb.auth.signUp({
            email: email,
            password: password,
            options: {
              data: {
                first_name: user.first_name,
                last_name: user.last_name
              }
            }
          });
          
          if (signUpError) {
            console.error('Supabase Auth signup error:', signUpError);
            // Continue anyway with legacy session
          } else if (signUpData.user) {
            // Update user with auth_id
            try {
              await dbUpdate('users', user.id, { auth_id: signUpData.user.id });
              user.auth_id = signUpData.user.id;
            } catch (e) { console.error('Update auth_id error:', e); }
            
            // Sign in immediately after signup
            const { data: newSignIn } = await sb.auth.signInWithPassword({
              email: email,
              password: password
            });
            if (newSignIn?.session) {
              authSession = newSignIn.session;
            }
          }
        } else if (signInData?.session) {
          // Successfully signed in to existing Supabase Auth account
          authSession = signInData.session;
          
          // Link auth_id if not linked yet
          if (!user.auth_id && signInData.user) {
            try {
              await dbUpdate('users', user.id, { auth_id: signInData.user.id });
              user.auth_id = signInData.user.id;
            } catch (e) { console.error('Update auth_id error:', e); }
          }
        }
        
        currentUser = user;
        localStorage.setItem('horizonstar_user', JSON.stringify(currentUser));
        startSessionMonitor();
        await logActivity('LOGIN_SUCCESS', { email, method: 'legacy_migrated' });
        renderApp();
        
      } catch (err) {
        console.error('Login error:', err);
        errorEl.textContent = 'Connection error';
        errorEl.style.display = 'block';
        btnEl.textContent = 'Sign In';
        btnEl.disabled = false;
      }
    }

    // Forgot Password Flow
    function showForgotPassword() {
      const m = document.createElement('div');
      m.className = 'modal-overlay';
      m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = `
        <div class="modal" style="max-width:420px">
          <div class="modal-header">
            <h3>ðŸ” Reset Password</h3>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
          </div>
          <div class="modal-body">
            <div id="forgot-step-1">
              <p style="color:var(--text-secondary);margin-bottom:20px;font-size:14px">
                ${'Enter your email and we\'ll send you a reset code.'}
              </p>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="forgot-email" placeholder="your@email.com">
              </div>
              <div id="forgot-error" style="color:#ef4444;font-size:13px;margin-bottom:12px;display:none"></div>
            </div>
            <div id="forgot-step-2" style="display:none">
              <p style="color:var(--text-secondary);margin-bottom:20px;font-size:14px">
                Enter your new password.
              </p>
              <div class="form-group">
                <label>New Password</label>
                <input type="password" id="forgot-new-password" placeholder="Min 6 characters">
              </div>
              <div class="form-group">
                <label>Confirm Password</label>
                <input type="password" id="forgot-confirm-password" placeholder="Confirm">
              </div>
              <div id="forgot-error-2" style="color:#ef4444;font-size:13px;margin-bottom:12px;display:none"></div>
            </div>
            <div id="forgot-success" style="display:none;text-align:center;padding:20px">
              <div style="font-size:48px;margin-bottom:16px">âœ…</div>
              <p style="color:var(--accent-primary);font-weight:600">Password reset successful!</p>
            </div>
          </div>
          <div class="modal-footer" id="forgot-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
            <button class="btn btn-primary" id="forgot-btn" onclick="handleForgotStep1()">Continue</button>
          </div>
        </div>
      `;
      document.body.appendChild(m);
    }

    async function handleForgotStep1() {
      const email = document.getElementById('forgot-email').value.trim().toLowerCase();
      const errorEl = document.getElementById('forgot-error');
      const btn = document.getElementById('forgot-btn');
      
      if (!email) {
        errorEl.textContent = 'Please enter your email';
        errorEl.style.display = 'block';
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Verifying...';
      
      try {
        const users = await dbFetch('users', { filter: { email: 'eq.' + email } });
        
        if (users.length === 0) {
          errorEl.textContent = 'Email not found';
          errorEl.style.display = 'block';
          btn.disabled = false;
          btn.textContent = 'Continue';
          return;
        }
        
        // Store user for step 2
        window.forgotPasswordUser = users[0];
        
        // Log activity
        await logActivity('PASSWORD_RESET_REQUEST', { email });
        
        // Move to step 2 (In a real app, you'd send an email with a code)
        document.getElementById('forgot-step-1').style.display = 'none';
        document.getElementById('forgot-step-2').style.display = 'block';
        btn.textContent = 'Reset Password';
        btn.disabled = false;
        btn.onclick = handleForgotStep2;
        
      } catch (e) {
        errorEl.textContent = 'Error: ' + e.message;
        errorEl.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Continue';
      }
    }

    async function handleForgotStep2() {
      const newPassword = document.getElementById('forgot-new-password').value;
      const confirmPassword = document.getElementById('forgot-confirm-password').value;
      const errorEl = document.getElementById('forgot-error-2');
      const btn = document.getElementById('forgot-btn');
      
      if (newPassword.length < 6) {
        errorEl.textContent = 'Password must be at least 6 characters';
        errorEl.style.display = 'block';
        return;
      }
      
      if (newPassword !== confirmPassword) {
        errorEl.textContent = 'Passwords do not match';
        errorEl.style.display = 'block';
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Resetting...';
      
      try {
        const hashedPassword = await hashPassword(newPassword);
        await dbUpdate('users', window.forgotPasswordUser.id, { password: hashedPassword });
        
        // Log activity
        await logActivity('PASSWORD_RESET_SUCCESS', { email: window.forgotPasswordUser.email });
        
        // Clear login attempts for this user
        const attempts = JSON.parse(localStorage.getItem('login_attempts') || '{}');
        delete attempts[window.forgotPasswordUser.email];
        localStorage.setItem('login_attempts', JSON.stringify(attempts));
        
        // Show success
        document.getElementById('forgot-step-2').style.display = 'none';
        document.getElementById('forgot-success').style.display = 'block';
        document.getElementById('forgot-footer').innerHTML = `
          <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Close</button>
        `;
        
        delete window.forgotPasswordUser;
        
      } catch (e) {
        errorEl.textContent = 'Error: ' + e.message;
        errorEl.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Reset Password';
      }
    }

    async function logout() { 
      // Log activity before clearing user
      if (currentUser) {
        await logActivity('LOGOUT', { email: currentUser.email });
      }
      
      // Update loading message based on language
      document.getElementById('loading-message').textContent = 'Logging out';
      
      // Show loading animation
      document.getElementById('loading-overlay').classList.add('show');
      
      // Sign out from Supabase Auth
      try {
        await sb.auth.signOut();
      } catch (e) { /* Ignore signout errors */ }
      
      // Clear session monitor
      if (sessionTimeoutId) {
        clearInterval(sessionTimeoutId);
        sessionTimeoutId = null;
      }
      
      // Clear user data and session
      currentUser = null; 
      authSession = null;
      localStorage.removeItem('horizonstar_user'); 
      localStorage.removeItem('last_activity');
      protectedAccessGranted = false; 
      
      // Redirect after 2.5 seconds
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 2500);
    }

    // World Clocks - Live time display
    function updateWorldClocks() {
      const now = new Date();
      
      // New York (Eastern Time)
      const nyTime = now.toLocaleTimeString('en-US', { 
        timeZone: 'America/New_York', 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
      });
      
      // California (Pacific Time)
      const caTime = now.toLocaleTimeString('en-US', { 
        timeZone: 'America/Los_Angeles', 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
      });
      
      // Tbilisi, Georgia (Georgia Standard Time)
      const tbilisiTime = now.toLocaleTimeString('en-US', { 
        timeZone: 'Asia/Tbilisi', 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
      });
      
      const clockNY = document.getElementById('clockNY');
      const clockCA = document.getElementById('clockCA');
      const clockTbilisi = document.getElementById('clockTbilisi');
      
      if (clockNY) clockNY.textContent = nyTime;
      if (clockCA) clockCA.textContent = caTime;
      if (clockTbilisi) clockTbilisi.textContent = tbilisiTime;
    }
    
    // Start world clocks - update every second
    setInterval(updateWorldClocks, 1000);

    async function renderApp() {
      applyTheme();
      const themeIcon = isDarkTheme ? 'â˜€ï¸' : 'ðŸŒ™';
      const userInitials = (currentUser.first_name?.charAt(0) || '') + (currentUser.last_name?.charAt(0) || '');
      
      const isSidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
      
      // Top bar like Lovable
      const topBar = '<div class="topbar">' +
        '<div class="topbar-left">' +
        '<span class="welcome-text">' + 'Welcome back,' + ' <span class="welcome-name">' + currentUser.first_name + '</span></span>' +
        '</div>' +
        '<div class="topbar-center" id="worldClocks">' +
        '<div class="world-clock"><span class="clock-city">ðŸ—½ NY</span><span class="clock-time" id="clockNY">--:--</span></div>' +
        '<div class="world-clock"><span class="clock-city">ðŸŒ´ CA</span><span class="clock-time" id="clockCA">--:--</span></div>' +
        '<div class="world-clock"><span class="clock-city">ðŸ‡¬ðŸ‡ª Tbilisi</span><span class="clock-time" id="clockTbilisi">--:--</span></div>' +
        '</div>' +
        '<div class="topbar-right">' +
        '' +
        '<button onclick="toggleDarkTheme()" class="topbar-btn" title="Theme">' + themeIcon + '</button>' +
        '<div class="notification-wrapper">' +
        '<button onclick="toggleNotificationDropdown()" class="topbar-btn notification-btn" title="Notifications">ðŸ””<span class="notification-badge" id="notificationBadge" style="display:none">0</span></button>' +
        '<div class="notification-dropdown" id="notificationDropdown">' +
        '<div class="notification-header"><strong>' + 'Notifications' + '</strong><button onclick="markAllNotificationsRead()" style="background:none;border:none;color:var(--primary);cursor:pointer;font-size:12px">' + 'Mark all read' + '</button></div>' +
        '<div id="notificationList" class="notification-list"><div style="padding:20px;text-align:center;color:var(--text-muted)">Loading...</div></div>' +
        '</div>' +
        '</div>' +
        '<div class="topbar-user-wrapper">' +
        '<div class="topbar-user" onclick="toggleUserDropdown()">' +
        '<div class="topbar-avatar">' + userInitials + '</div>' +
        '<div class="topbar-user-info"><div class="topbar-user-name">' + currentUser.first_name + ' ' + currentUser.last_name + '</div><div class="topbar-user-role">' + currentUser.role + '</div></div>' +
        '<span class="topbar-user-arrow">â–¼</span>' +
        '</div>' +
        '<div class="topbar-dropdown" id="userDropdown">' +
        '<div class="topbar-dropdown-header"><div class="topbar-dropdown-avatar">' + userInitials + '</div><div><div class="topbar-dropdown-name">' + currentUser.first_name + ' ' + currentUser.last_name + '</div><div class="topbar-dropdown-email">' + (currentUser.email || currentUser.role) + '</div></div></div>' +
        '<div class="topbar-dropdown-divider"></div>' +
        '<button class="topbar-dropdown-item logout" onclick="logout()"><span>ðŸšª</span> ' + t('logout') + '</button>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>';
      
      // Mobile header with hamburger menu
      const mobileHeader = '<div class="mobile-header">' +
        '<button class="hamburger" id="hamburger" onclick="toggleMobileMenu()" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="sidebar">' +
        '<span></span><span></span><span></span>' +
        '</button>' +
        '<div class="logo-text">â­ HORIZON STAR</div>' +
        '<div class="user-avatar" style="width:36px;height:36px;font-size:12px;font-weight:700;background:white;color:var(--primary);border-radius:10px" aria-label="User profile">' + userInitials + '</div>' +
        '</div>';
      
      document.getElementById('app').innerHTML = mobileHeader + '<div class="app">' +
        '<div class="mobile-overlay" id="mobileOverlay" onclick="if(event.target===this)toggleMobileMenu()"></div>' +
        '<aside class="sidebar' + (isSidebarCollapsed ? ' collapsed' : '') + '" id="sidebar" role="navigation" aria-label="Main navigation" onclick="event.stopPropagation()" ontouchstart="event.stopPropagation()">' +
        '<button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle Sidebar" aria-label="Collapse sidebar" aria-expanded="' + (!isSidebarCollapsed) + '">â—€</button>' +
        '<div class="logo"><div class="logo-icon">â­</div><h1><span>HORIZON STAR</span></h1></div>' +
        '<nav id="nav" role="menubar" aria-label="Application navigation"></nav>' +
        '</aside>' +
        '<main class="main' + (isSidebarCollapsed ? ' sidebar-collapsed' : '') + '" role="main" aria-label="Main content">' + topBar + '<div id="main-content"><div class="loading" role="status" aria-live="polite"><div class="spinner" aria-hidden="true"></div> ' + t('loading') + '</div></div></main>' +
        '</div>';
      
      // Restore saved page from localStorage (persist across refresh)
      const savedPage = localStorage.getItem('tms_current_page');
      const validPages = ['dashboard', 'live_map', 'team_chat', 'trips', 'orders', 'future_cars', 'tasks', 'drivers', 'trucks', 'local_drivers', 'brokers', 'dispatchers', 'dispatcher_ranking', 'financials', 'payroll', 'fuel', 'ifta', 'maintenance', 'compliance', 'settings', 'users', 'activity_log'];
      if (savedPage && validPages.includes(savedPage)) {
        currentPage = savedPage;
      }
      
      renderNav(); await loadAllData(); renderPage(); startNotificationPolling(); startSessionMonitor(); startRealtimeSync(); updateWorldClocks();
    }
    
    function toggleMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const hamburger = document.getElementById('hamburger');
      const overlay = document.getElementById('mobileOverlay');
      
      const isOpening = !sidebar.classList.contains('mobile-open');
      
      sidebar.classList.toggle('mobile-open');
      hamburger.classList.toggle('active');
      overlay.classList.toggle('active');
      
      // Prevent body scroll when menu is open
      if (isOpening) {
        document.body.classList.add('menu-open');
        // Setup touch handlers after menu opens
        setTimeout(setupMobileNavTouch, 50);
      } else {
        document.body.classList.remove('menu-open');
      }
    }
    
    // Close mobile menu when navigating
    function closeMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const hamburger = document.getElementById('hamburger');
      const overlay = document.getElementById('mobileOverlay');
      
      if (sidebar && sidebar.classList.contains('mobile-open')) {
        sidebar.classList.remove('mobile-open');
        hamburger?.classList.remove('active');
        overlay?.classList.remove('active');
        document.body.classList.remove('menu-open');
      }
    }
    
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const main = document.querySelector('.main'); // Target the actual main element, not main-content
      sidebar.classList.toggle('collapsed');
      main.classList.toggle('sidebar-collapsed');
      localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
    }
    
    function toggleUserDropdown() {
      const wrapper = document.querySelector('.topbar-user-wrapper');
      wrapper.classList.toggle('open');
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const wrapper = document.querySelector('.topbar-user-wrapper');
      if (wrapper && !wrapper.contains(e.target)) {
        wrapper.classList.remove('open');
      }
    });

    // Navigation items with translation keys
    // SVG Line Icons
    const icons = {
      dashboard: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
      loadboard: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
      trips: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13" rx="2"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>',
      orders: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/><path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/><path d="M5 17h-2v-6l2-5h9l4 5h1a2 2 0 0 1 2 2v4h-2m-4 0h-6m-6 -6h15m-6 0v-5"/></svg>',
      drivers: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
      local_drivers: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="7" r="4"/><path d="M5 21v-2a7 7 0 0 1 14 0v2"/></svg>',
      trucks: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13" rx="2"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>',
      brokers: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18"/><path d="M9 8h1"/><path d="M9 12h1"/><path d="M9 16h1"/><path d="M14 8h1"/><path d="M14 12h1"/><path d="M14 16h1"/><path d="M5 21V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16"/></svg>',
      dispatchers: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
      dispatcher_ranking: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2z"/></svg>',
      fuel: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 22V5a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v17"/><path d="M15 22H3"/><path d="M15 10h2a2 2 0 0 1 2 2v3a2 2 0 0 0 2 2v0a2 2 0 0 0 2-2V9.83a2 2 0 0 0-.59-1.42L18 4"/><path d="M7 10h4"/></svg>',
      ifta: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
      compliance: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',
      tickets: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 002 2 2 2 0 010 4 2 2 0 00-2 2v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 00-2-2 2 2 0 010-4 2 2 0 002-2V7a2 2 0 00-2-2H5z"/></svg>',
      financials: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
      payroll: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="6" y1="8" x2="12" y2="8"/><line x1="6" y1="16" x2="10" y2="16"/></svg>',
      reports: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
      ai_advisor: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a4 4 0 0 1 4 4v1a4 4 0 0 1-8 0V6a4 4 0 0 1 4-4z"/><path d="M12 11v3"/><circle cx="12" cy="18" r="4"/><path d="M9 18h6"/></svg>',
      fixed_costs: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/></svg>',
      variable_costs: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
      financial: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
      profitability: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
      executive: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>',
      maintenance: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
      claims: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
      settings: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
      users: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
      tasks: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',
      activity: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
      live_map: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="10" r="3"/><path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z"/></svg>',
      chat: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>'
    };
    
    const navItems = [
      // MAIN section
      { id: 'dashboard', labelKey: 'dashboard', icon: 'dashboard', section: 'MAIN' },
      { id: 'live_map', labelKey: 'live_map', icon: 'live_map', section: 'MAIN' },
      { id: 'team_chat', labelKey: 'team_chat', icon: 'chat', section: 'MAIN' },
      { id: 'trips', labelKey: 'trips', icon: 'trips', section: 'MAIN' },
      { id: 'orders', labelKey: 'orders', icon: 'orders', section: 'MAIN' },
      { id: 'loadboard', labelKey: 'loadboard', icon: 'loadboard', section: 'MAIN' },
      { id: 'tasks', labelKey: 'tasks', icon: 'tasks', section: 'MAIN' },
      
      // FLEET section
      { id: 'drivers', labelKey: 'drivers', icon: 'drivers', section: 'FLEET' },
      { id: 'trucks', labelKey: 'trucks', icon: 'trucks', section: 'FLEET' },
      { id: 'local_drivers', labelKey: 'local_drivers', icon: 'local_drivers', section: 'FLEET' },
      
      // PARTNERS section
      { id: 'brokers', labelKey: 'brokers', icon: 'brokers', section: 'PARTNERS' },
      { id: 'dispatchers', labelKey: 'dispatchers', icon: 'dispatchers', section: 'PARTNERS' },
      { id: 'dispatcher_ranking', labelKey: 'dispatcher_ranking', icon: 'dispatcher_ranking', section: 'PARTNERS' },
      
      // FINANCIALS section - Restricted to ADMIN and MANAGER only
      { id: 'financials', labelKey: 'financials', icon: 'financials', restricted: true, section: 'FINANCIALS' },
      { id: 'payroll', labelKey: 'payroll', icon: 'payroll', restricted: true, section: 'FINANCIALS' },
      { id: 'fuel', labelKey: 'fuel', icon: 'fuel', restricted: true, section: 'FINANCIALS' },
      { id: 'ifta', labelKey: 'ifta', icon: 'ifta', restricted: true, section: 'FINANCIALS' },
      { id: 'reports', labelKey: 'reports', icon: 'reports', restricted: true, section: 'FINANCIALS' },
      { id: 'ai_advisor', labelKey: 'ai_advisor', icon: 'ai_advisor', restricted: true, section: 'FINANCIALS' },
      
      // OPERATIONS
      { id: 'maintenance', labelKey: 'maintenance', icon: 'maintenance', section: 'OPERATIONS' },
      { id: 'compliance', labelKey: 'compliance', icon: 'compliance', section: 'OPERATIONS' },
      
      // Settings (separate)
      { id: 'settings', labelKey: 'settings', icon: 'settings', admin: true, section: 'SETTINGS' },
      { id: 'users', labelKey: 'users', icon: 'users', admin: true, section: 'SETTINGS' },
      { id: 'activity_log', labelKey: 'activity_log', icon: 'activity', admin: true, section: 'SETTINGS' }
    ];
    
    let expandedMenus = { financials: false };
    
    // Role-restricted pages (visible only to ADMIN and MANAGER)
    const restrictedPages = ['fuel', 'ifta', 'payroll', 'financials', 'reports', 'ai_advisor'];

    function getNavLabel(item) {
      // If Georgian and has custom Georgian label, use it
      
      return t(item.labelKey);
    }
    
    function renderNav() {
      const sections = {
        'MAIN': 'MAIN',
        'FLEET': 'FLEET',
        'PARTNERS': 'PARTNERS',
        'FINANCIALS': 'FINANCIALS',
        'OPERATIONS': 'OPERATIONS',
        'SETTINGS': ''
      };
      
      let html = '';
      const isAdminOrManager = currentUser.role === 'ADMIN' || currentUser.role === 'MANAGER';
      const filteredItems = navItems.filter(i => {
        // Hide admin-only items from non-admins
        if (i.admin && currentUser.role !== 'ADMIN') return false;
        // Hide restricted items from non-admin/manager users
        if (i.restricted && !isAdminOrManager) return false;
        return true;
      });
      
      // Group items by section
      const groupedItems = {};
      filteredItems.forEach(item => {
        const section = item.section || 'OTHER';
        if (!groupedItems[section]) groupedItems[section] = [];
        groupedItems[section].push(item);
      });
      
      // Render each section
      Object.keys(sections).forEach(sectionKey => {
        const items = groupedItems[sectionKey];
        if (!items || items.length === 0) return;
        
        const sectionTitle = sections[sectionKey];
        html += '<div class="nav-section">';
        if (sectionTitle) {
          html += '<div class="nav-section-title">' + sectionTitle + '</div>';
        }
        
        items.forEach(i => {
          const label = getNavLabel(i);
          const iconSvg = icons[i.icon] || i.icon;

          // Chat badge for unread messages
          const chatBadge = (i.id === 'team_chat' && unreadChatCount > 0)
            ? '<span class="nav-badge" id="navChatBadge">' + (unreadChatCount > 99 ? '99+' : unreadChatCount) + '</span>'
            : '';

          if (i.submenu) {
            const isExpanded = expandedMenus[i.id];
            const hasActiveSub = i.submenu.some(sub => sub.id === currentPage);
            html += '<button class="nav-item submenu-toggle ' + (hasActiveSub ? 'active' : '') + '" onclick="toggleMenu(\'' + i.id + '\')" data-tooltip="' + label + '" role="menuitem" aria-haspopup="true" aria-expanded="' + (isExpanded ? 'true' : 'false') + '"><span class="nav-item-content"><span class="icon" aria-hidden="true">' + iconSvg + '</span> <span class="nav-item-text">' + label + '</span></span><span class="nav-item-text nav-arrow" aria-hidden="true">' + (isExpanded ? 'â–¼' : 'â–¶') + '</span></button>';
            if (isExpanded || hasActiveSub) {
              i.submenu.forEach(sub => {
                const subLabel = t(sub.labelKey);
                const subIconSvg = icons[sub.icon] || sub.icon;
                html += '<button class="nav-item nav-subitem ' + (currentPage === sub.id ? 'active' : '') + '" onclick="navigate(\'' + sub.id + '\')" data-tooltip="' + subLabel + '" role="menuitem" aria-current="' + (currentPage === sub.id ? 'page' : 'false') + '"><span class="icon" aria-hidden="true">' + subIconSvg + '</span> <span class="nav-item-text">' + subLabel + '</span></button>';
              });
            }
          } else {
            html += '<button class="nav-item ' + (currentPage === i.id ? 'active' : '') + '" onclick="navigate(\'' + i.id + '\')" data-tooltip="' + label + '" role="menuitem" aria-current="' + (currentPage === i.id ? 'page' : 'false') + '"><span class="icon" aria-hidden="true">' + iconSvg + '</span> <span class="nav-item-text">' + label + '</span>' + chatBadge + '</button>';
          }
        });
        
        html += '</div>';
      });
      
      document.getElementById('nav').innerHTML = html;
      setupNavTooltips();
      setupMobileNavTouch();
    }
    
    // Setup mobile touch handling for nav items
    function setupMobileNavTouch() {
      if (window.innerWidth > 768) return;
      
      document.querySelectorAll('.sidebar .nav-item').forEach(item => {
        // Add touch handler with capture to ensure it fires
        item.ontouchend = function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          // Get the page from onclick attribute
          const onclick = this.getAttribute('onclick');
          if (onclick) {
            // Extract page name from navigate('pagename') or toggleMenu('menuname')
            const navigateMatch = onclick.match(/navigate\(['"]([^'"]+)['"]\)/);
            const toggleMatch = onclick.match(/toggleMenu\(['"]([^'"]+)['"]\)/);
            
            if (navigateMatch) {
              navigate(navigateMatch[1]);
            } else if (toggleMatch) {
              toggleMenu(toggleMatch[1]);
            }
          }
          return false;
        };
      });
    }
    
    function handleNavTouch(e) {
      // Deprecated - using ontouchend directly now
    }
    
    // Tooltip element
    let navTooltip = null;
    
    function setupNavTooltips() {
      // Create tooltip element if it doesn't exist
      if (!navTooltip) {
        navTooltip = document.createElement('div');
        navTooltip.className = 'nav-tooltip';
        document.body.appendChild(navTooltip);
      }
      
      // Add event listeners to nav items
      document.querySelectorAll('.sidebar .nav-item').forEach(item => {
        item.addEventListener('mouseenter', showNavTooltip);
        item.addEventListener('mouseleave', hideNavTooltip);
      });
    }
    
    function showNavTooltip(e) {
      const sidebar = document.getElementById('sidebar');
      if (!sidebar.classList.contains('collapsed')) return;
      
      const text = e.currentTarget.getAttribute('data-tooltip');
      if (!text) return;
      
      const rect = e.currentTarget.getBoundingClientRect();
      navTooltip.textContent = text;
      navTooltip.style.left = (rect.right + 12) + 'px';
      navTooltip.style.top = (rect.top + rect.height / 2) + 'px';
      navTooltip.style.transform = 'translateY(-50%)';
      navTooltip.classList.add('visible');
    }
    
    function hideNavTooltip() {
      if (navTooltip) {
        navTooltip.classList.remove('visible');
      }
    }
    
    function toggleMenu(menuId) {
      expandedMenus[menuId] = !expandedMenus[menuId];
      renderNav();
    }

    function navigate(page) {
      // Cleanup live map if navigating away
      if (currentPage === 'live_map' && page !== 'live_map') {
        cleanupLiveMap();
      }
      // Cleanup chat if navigating away
      if (currentPage === 'team_chat' && page !== 'team_chat') {
        cleanupChat();
      }
      // Check if page is restricted to admin/manager only
      if (restrictedPages.includes(page)) {
        const isAdminOrManager = currentUser.role === 'ADMIN' || currentUser.role === 'MANAGER';
        if (!isAdminOrManager) {
          showToast('Access denied. This section is only available to Admins and Managers.', 'error');
          return;
        }
      }
      currentPage = page;
      // Save current page to localStorage for persistence across refresh
      localStorage.setItem('tms_current_page', page);
      
      // On mobile, add slight delay before closing menu so user sees the selection
      const isMobile = window.innerWidth <= 768;
      if (isMobile) {
        // Immediately render nav to show active state
        renderNav();
        // Small delay then close menu and render page
        setTimeout(() => {
          closeMobileMenu();
          renderPage();
        }, 150);
      } else {
        closeMobileMenu();
        renderNav(); 
        renderPage(); 
      }
    }
    
    function goToPage(page) {
      navigate(page);
    }

    // Generic Modal Helper Functions
    function showModal(modalId, title, bodyContent, footerContent, maxWidth = '600px') {
      // Remove existing modal with same id if any
      const existingModal = document.getElementById(modalId);
      if (existingModal) existingModal.remove();
      
      const m = document.createElement('div');
      m.id = modalId;
      m.className = 'modal-overlay';
      m.onclick = e => { if (e.target === m) closeModal(modalId); };
      m.innerHTML = `
        <div class="modal" style="max-width:${maxWidth}">
          <div class="modal-header">
            <h3>${title}</h3>
            <button class="modal-close" onclick="closeModal('${modalId}')">Ã—</button>
          </div>
          <div class="modal-body">${bodyContent}</div>
          <div class="modal-footer">${footerContent}</div>
        </div>
      `;
      document.body.appendChild(m);
    }
    
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.remove();
    }
    
    function renderPage() {
      // Clear detail view flag when rendering a page (navigating away from detail)
      currentDetailView = null;
      
      const m = document.getElementById('main-content');
      
      // Remove FAB from previous page
      removeFloatingActionButton();
      
      // Handle mini chat visibility
      if (currentPage === 'team_chat') {
        document.body.classList.add('on-team-chat');
        closeMiniChat();
        // Mark all messages as seen when entering team chat
        if (chatMessages.length > 0) {
          lastSeenChatId = Math.max(lastSeenChatId, ...chatMessages.map(m => m.id));
          localStorage.setItem('lastSeenChatId', lastSeenChatId.toString());
          unreadChatCount = 0;
          updateChatBadges();
        }
      } else {
        document.body.classList.remove('on-team-chat');
        initMiniChat();
      }
      
      if (currentPage === 'dashboard') renderDashboard(m);
      else if (currentPage === 'loadboard') renderLoadBoard(m);
      else if (currentPage === 'trips') renderTrips(m);
      else if (currentPage === 'orders') renderOrders(m);
      else if (currentPage === 'drivers') renderDrivers(m);
      else if (currentPage === 'local_drivers') renderLocalDrivers(m);
      else if (currentPage === 'trucks') renderTrucks(m);
      else if (currentPage === 'brokers') renderBrokers(m);
      else if (currentPage === 'dispatchers') renderDispatchers(m);
      else if (currentPage === 'dispatcher_ranking') renderDispatcherRanking(m);
      else if (currentPage === 'fuel') renderFuelTracking(m);
      else if (currentPage === 'ifta') renderIFTA(m);
      else if (currentPage === 'compliance') renderCompliance(m);
      else if (currentPage === 'driver_compliance') { complianceMainTab = 'driver_compliance'; renderCompliance(m); }
      else if (currentPage === 'claims') { dcTab = 'claims'; renderDriverCompliance(m); }
      else if (currentPage === 'payroll') renderPayroll(m);
      else if (currentPage === 'financials') renderConsolidatedFinancials(m);
      else if (currentPage === 'reports') renderReports(m);
      else if (currentPage === 'ai_advisor') renderAIAdvisor(m);
      // Legacy routes redirect to consolidated
      else if (currentPage === 'fixed_costs') { finTab = 'costs'; renderConsolidatedFinancials(m); }
      else if (currentPage === 'variable_costs') { finTab = 'costs'; renderConsolidatedFinancials(m); }
      else if (currentPage === 'financial') { finTab = 'overview'; renderConsolidatedFinancials(m); }
      else if (currentPage === 'profitability') { finTab = 'trips'; renderConsolidatedFinancials(m); }
      else if (currentPage === 'executive_dashboard') { finTab = 'overview'; renderConsolidatedFinancials(m); }
      else if (currentPage === 'maintenance') renderMaintenance(m);
      else if (currentPage === 'tasks') renderTasks(m);
      else if (currentPage === 'settings') renderSettings(m);
      else if (currentPage === 'users') renderUsers(m);
      else if (currentPage === 'activity_log') renderActivityLog(m);
      else if (currentPage === 'live_map') renderLiveMap(m);
      else if (currentPage === 'team_chat') renderTeamChat(m);
      
      // Add FAB for pages that support adding new items (mobile only)
      if (window.innerWidth <= 768) {
        const fabConfig = {
          'trips': { action: () => openTripModal(), icon: 'âž•' },
          'orders': { action: () => openOrderModal(), icon: 'âž•' },
          'drivers': { action: () => openDriverModal(), icon: 'âž•' },
          'trucks': { action: () => openTruckModal(), icon: 'âž•' },
          'tasks': { action: () => openTaskModal(), icon: 'âž•' },
          'maintenance': { action: () => openMaintenanceModal(), icon: 'ðŸ”§' },
          'claims': { action: () => openClaimModal(), icon: 'âž•' },
          'team_chat': null // No FAB for chat
        };
        
        if (fabConfig[currentPage]) {
          addFloatingActionButton(currentPage, fabConfig[currentPage].action, fabConfig[currentPage].icon);
        }
      }
    }

    // Dashboard period filter - defaults to current year
    let dashboardPeriod = 'year';  // 'all', 'year', 'month', 'q1', 'q2', 'q3', 'q4'
    let dashboardYear = new Date().getFullYear();
    let dashboardMonth = new Date().getMonth() + 1;  // 1-12

    function changeDashboardPeriod(period) {
      dashboardPeriod = period;
      renderDashboard(document.getElementById('main-content'));
    }

    function changeDashboardYear(year) {
      dashboardYear = parseInt(year);
      renderDashboard(document.getElementById('main-content'));
    }

    function changeDashboardMonth(month) {
      dashboardMonth = parseInt(month);
      renderDashboard(document.getElementById('main-content'));
    }

    function getTripYear(trip) {
      const dateStr = trip.trip_date || trip.period_start_date || trip.created_at;
      if (!dateStr) return null;
      const date = new Date(dateStr);
      return date.getFullYear();
    }

    function getTripQuarter(trip) {
      const dateStr = trip.trip_date || trip.period_start_date || trip.created_at;
      if (!dateStr) return null;
      const month = new Date(dateStr).getMonth();
      if (month >= 0 && month <= 2) return 1;
      if (month >= 3 && month <= 5) return 2;
      if (month >= 6 && month <= 8) return 3;
      return 4;
    }

    function getTripMonth(trip) {
      const dateStr = trip.trip_date || trip.period_start_date || trip.created_at;
      if (!dateStr) return null;
      return new Date(dateStr).getMonth() + 1;  // 1-12
    }

    function filterTripsByPeriod(trips) {
      return trips.filter(t => {
        if (dashboardPeriod === 'all') return true;
        const tripYear = getTripYear(t);
        if (tripYear !== dashboardYear) return false;
        if (dashboardPeriod === 'year') return true;
        if (dashboardPeriod === 'month') return getTripMonth(t) === dashboardMonth;
        const quarter = getTripQuarter(t);
        if (dashboardPeriod === 'q1') return quarter === 1;
        if (dashboardPeriod === 'q2') return quarter === 2;
        if (dashboardPeriod === 'q3') return quarter === 3;
        if (dashboardPeriod === 'q4') return quarter === 4;
        return true;
      });
    }

    const dashboardMonthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    function getDashboardPeriodLabel() {
      if (dashboardPeriod === 'all') return 'All Time';
      if (dashboardPeriod === 'year') return dashboardYear;
      if (dashboardPeriod === 'month') return dashboardMonthNames[dashboardMonth] + ' ' + dashboardYear;
      if (dashboardPeriod === 'q1') return 'Q1 ' + dashboardYear;
      if (dashboardPeriod === 'q2') return 'Q2 ' + dashboardYear;
      if (dashboardPeriod === 'q3') return 'Q3 ' + dashboardYear;
      if (dashboardPeriod === 'q4') return 'Q4 ' + dashboardYear;
      return dashboardYear;
    }

    function renderDashboard(c) {
      // Filter trips by selected period (year, quarter, or all time)
      const yearTrips = filterTripsByPeriod(appData.trips);
      const yearTripIds = yearTrips.map(t => t.id);

      // Filter orders to match the same period
      const yearOrders = appData.orders.filter(o => {
        if (yearTripIds.includes(o.trip_id)) return true;
        if (!o.trip_id) {
          // Standalone orders - filter by period
          const orderDate = new Date(o.created_at);
          const orderYear = orderDate.getFullYear();
          if (dashboardPeriod === 'all') return true;
          if (orderYear !== dashboardYear) return false;
          if (dashboardPeriod === 'year') return true;
          const month = orderDate.getMonth();
          const quarter = month >= 0 && month <= 2 ? 1 : month >= 3 && month <= 5 ? 2 : month >= 6 && month <= 8 ? 3 : 4;
          if (dashboardPeriod === 'q1') return quarter === 1;
          if (dashboardPeriod === 'q2') return quarter === 2;
          if (dashboardPeriod === 'q3') return quarter === 3;
          if (dashboardPeriod === 'q4') return quarter === 4;
        }
        return false;
      });

      // Calculate all metrics for selected year
      let totalRev = 0, totalProfit = 0, totalExpenses = 0, totalBrokerFees = 0, totalLocalFees = 0, totalDriverCut = 0, totalMiles = 0, totalCars = 0;
      const completedTrips = yearTrips.filter(t => t.status === 'COMPLETED');
      const truckPerf = {};
      const dispPerf = {};

      yearTrips.forEach(t => {
        const f = getTripFin(t.id);
        totalRev += f.loadRevenue;
        totalProfit += f.netProfit;
        totalExpenses += f.totalExpenses;
        totalBrokerFees += f.brokerFee;
        totalLocalFees += f.localFees;
        totalDriverCut += f.driverCut;
        totalMiles += parseFloat(t.miles || 0);
        totalCars += f.vehicleCount;
        
        // Truck performance
        if (t.truck_id) {
          if (!truckPerf[t.truck_id]) truckPerf[t.truck_id] = { trips: 0, rev: 0, profit: 0 };
          truckPerf[t.truck_id].trips++;
          truckPerf[t.truck_id].rev += f.loadRevenue;
          truckPerf[t.truck_id].profit += f.netProfit;
        }
      });
      
      // Dispatcher performance from orders (filtered by year)
      yearOrders.forEach(o => {
        if (o.dispatcher_id) {
          if (!dispPerf[o.dispatcher_id]) dispPerf[o.dispatcher_id] = { cars: 0, rev: 0 };
          dispPerf[o.dispatcher_id].cars++;
          dispPerf[o.dispatcher_id].rev += parseFloat(o.revenue || 0);
        }
      });

      // Find top/bottom performers
      const truckIds = Object.keys(truckPerf);
      let topTruck = null, bottomTruck = null;
      if (truckIds.length > 0) {
        topTruck = truckIds.reduce((a, b) => truckPerf[a].profit > truckPerf[b].profit ? a : b);
        bottomTruck = truckIds.reduce((a, b) => truckPerf[a].profit < truckPerf[b].profit ? a : b);
      }

      const dispIds = Object.keys(dispPerf);
      let topDisp = null, bottomDisp = null;
      if (dispIds.length > 0) {
        topDisp = dispIds.reduce((a, b) => dispPerf[a].cars > dispPerf[b].cars ? a : b);
        bottomDisp = dispIds.reduce((a, b) => dispPerf[a].cars < dispPerf[b].cars ? a : b);
      }

      // Most/Least profitable trips (filtered by year)
      let mostProfTrip = null, leastProfTrip = null, mostProf = -Infinity, leastProf = Infinity;
      yearTrips.forEach(t => {
        const f = getTripFin(t.id);
        if (f.netProfit > mostProf) { mostProf = f.netProfit; mostProfTrip = t; }
        if (f.netProfit < leastProf) { leastProf = f.netProfit; leastProfTrip = t; }
      });

      // COD collections - for split payments, only count cod_amount as COD, not full revenue (filtered by year)
      const codAmount = yearOrders.filter(o => o.payment_type === 'COD').reduce((s, o) => {
        if (parseFloat(o.bill_amount || 0) > 0) {
          return s + parseFloat(o.cod_amount || 0);
        }
        return s + parseFloat(o.revenue || 0);
      }, 0);
      const copAmount = yearOrders.filter(o => o.payment_type === 'COP').reduce((s, o) => {
        if (parseFloat(o.bill_amount || 0) > 0) {
          return s + parseFloat(o.cod_amount || 0);
        }
        return s + parseFloat(o.revenue || 0);
      }, 0);
      const localCodAmount = yearOrders.filter(o => o.payment_type === 'LOCAL_COD').reduce((s, o) => {
        if (parseFloat(o.bill_amount || 0) > 0) {
          return s + parseFloat(o.cod_amount || 0);
        }
        return s + parseFloat(o.revenue || 0);
      }, 0);
      const checkAmount = yearOrders.filter(o => o.payment_type === 'CHECK').reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
      // Bill amount = total revenue minus all cash/check collections
      const billAmount = totalRev - codAmount - copAmount - localCodAmount - checkAmount;
      
      // KPIs
      const profitMargin = totalRev > 0 ? ((totalProfit / totalRev) * 100).toFixed(1) : 0;
      const revenuePerMile = totalMiles > 0 ? (totalRev / totalMiles).toFixed(2) : 0;
      const profitPerMile = totalMiles > 0 ? (totalProfit / totalMiles).toFixed(2) : 0;
      const avgRevPerTrip = yearTrips.length > 0 ? (totalRev / yearTrips.length).toFixed(2) : 0;
      const avgProfitPerTrip = yearTrips.length > 0 ? (totalProfit / yearTrips.length).toFixed(2) : 0;
      const avgPricePerCar = totalCars > 0 ? (totalRev / totalCars).toFixed(2) : 0;

      // Clean gross (revenue - broker fees - local fees)
      const cleanGross = totalRev - totalBrokerFees - totalLocalFees;
      const truckGross = cleanGross - totalDriverCut;

      // Build year selector dropdown
      const currentYear = new Date().getFullYear();
      const availableYears = [...new Set(appData.trips.map(t => getTripYear(t)).filter(y => y))].sort((a, b) => b - a);
      if (!availableYears.includes(currentYear)) availableYears.unshift(currentYear);
      const yearOptions = availableYears.map(y => '<option value="' + y + '"' + (y === dashboardYear ? ' selected' : '') + '>' + y + '</option>').join('');

      // Period selector buttons
      const periodButtons = [
        { value: 'all', label: 'All Time' },
        { value: 'year', label: 'Year' },
        { value: 'month', label: 'Month' },
        { value: 'q1', label: 'Q1' },
        { value: 'q2', label: 'Q2' },
        { value: 'q3', label: 'Q3' },
        { value: 'q4', label: 'Q4' }
      ].map(p => '<button onclick="changeDashboardPeriod(\'' + p.value + '\')" style="padding:6px 12px;border-radius:6px;border:1px solid ' + (dashboardPeriod === p.value ? 'var(--primary)' : 'var(--border)') + ';background:' + (dashboardPeriod === p.value ? 'var(--primary)' : 'var(--bg-secondary)') + ';color:' + (dashboardPeriod === p.value ? 'white' : 'var(--text-primary)') + ';font-size:13px;font-weight:500;cursor:pointer">' + p.label + '</button>').join('');

      // Month selector options
      const monthOptions = dashboardMonthNames.slice(1).map((m, i) => '<option value="' + (i + 1) + '"' + (dashboardMonth === i + 1 ? ' selected' : '') + '>' + m + '</option>').join('');

      c.innerHTML = '<div class="header"><h2>ðŸ“Š Dashboard</h2><div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap"><div style="display:flex;gap:4px">' + periodButtons + '</div>' + (dashboardPeriod === 'month' ? '<select onchange="changeDashboardMonth(this.value)" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);font-weight:600;cursor:pointer">' + monthOptions + '</select>' : '') + (dashboardPeriod !== 'all' ? '<select onchange="changeDashboardYear(this.value)" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);font-weight:600;cursor:pointer">' + yearOptions + '</select>' : '') + '<button class="btn btn-secondary" onclick="showExportMenu()">ðŸ“¥ Export</button><button class="btn btn-secondary" onclick="loadAllData(true).then(()=>renderPage())">ðŸ”„ Refresh</button></div></div>' +

        // Tasks Widget - TOP OF PAGE
        renderTasksWidget() +

        // Recent Trips Table - RIGHT AFTER TASKS (filtered by period)
        '<div class="card" style="margin-bottom:20px"><div class="card-header"><h3>ðŸš› Recent Trips (' + getDashboardPeriodLabel() + ')</h3></div><div class="table-wrapper"><table><thead><tr><th>Trip</th><th>Date</th><th>Driver</th><th>Truck</th><th>Cars</th><th>Revenue</th><th>Profit</th><th>Status</th></tr></thead><tbody>' + (yearTrips.length > 0 ? yearTrips.slice(0, 5).map(t => { const d = appData.drivers.find(x => x.id === t.driver_id); const tr = appData.trucks.find(x => x.id === t.truck_id); const f = getTripFin(t.id); return '<tr style="cursor:pointer" onclick="viewTrip(' + t.id + ')"><td><strong style="color:#3b82f6">' + t.trip_number + '</strong></td><td>' + formatDate(t.trip_date) + '</td><td>' + (d ? d.first_name + ' ' + d.last_name : '-') + '</td><td>' + (tr ? '#' + tr.truck_number : '-') + '</td><td>' + f.vehicleCount + '</td><td class="money">' + formatMoney(f.loadRevenue) + '</td><td class="money ' + (f.netProfit >= 0 ? 'positive' : 'negative') + '">' + formatMoney(f.netProfit) + '</td><td><span class="badge ' + getBadge(t.status) + '">' + t.status + '</span></td></tr>'; }).join('') : '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted)">No trips for ' + getDashboardPeriodLabel() + '</td></tr>') + '</tbody></table></div></div>' +
        
        // Top Stats Row
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:20px">' +
        '<div class="stat-card" style="border-left:4px solid #10b981"><div class="label">Revenue Generated</div><div class="value">' + formatMoney(totalRev) + '</div></div>' +
        '<div class="stat-card" style="border-left:4px solid #ef4444"><div class="label">Direct Trip Expenses</div><div class="value">' + formatMoney(totalBrokerFees + totalLocalFees + totalDriverCut + totalExpenses) + '</div></div>' +
        '<div class="stat-card" style="border-left:4px solid ' + (totalProfit >= 0 ? '#10b981' : '#ef4444') + ';background:' + (totalProfit >= 0 ? '#d1fae5' : '#fee2e2') + '"><div class="label">Net Profit</div><div class="value" style="color:' + (totalProfit >= 0 ? '#047857' : '#dc2626') + '">' + formatMoney(totalProfit) + '</div><div style="font-size:12px;color:' + (totalProfit >= 0 ? '#047857' : '#dc2626') + '">' + profitMargin + '% margin</div></div>' +
        '</div>' +
        
        // === QUICK VIEW - Company Profitability Metrics ===
        (function() {
          // Calculate Quick View metrics (using yearTrips for year-filtered data)
          const monthlyFixedCosts = (appData.fixed_costs || []).reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);
          const periodMonths = Math.max(1, Object.keys(calculateTripVolume(yearTrips).monthlyData).length);
          const totalFixedCosts = monthlyFixedCosts * periodMonths;
          const yearMaintenanceRecords = (appData.maintenance_records || []).filter(m => new Date(m.service_date || m.created_at).getFullYear() === dashboardYear);
          const maintenanceCosts = yearMaintenanceRecords.reduce((s, m) => s + parseFloat(m.total_cost || 0), 0);
          const totalOperatingCosts = totalBrokerFees + totalLocalFees + totalDriverCut + totalExpenses + totalFixedCosts + maintenanceCosts;
          const cpm = totalMiles > 0 ? (totalOperatingCosts / totalMiles) : 0;
          const rpm = totalMiles > 0 ? (totalRev / totalMiles) : 0;
          const marginPerMile = rpm - cpm;
          const breakEvenData = calculateBreakEven();
          const targetVehiclePrice = breakEvenData.profitablePPC || 0;
          const currentAvgPrice = totalCars > 0 ? totalRev / totalCars : 0;
          const priceGap = targetVehiclePrice - currentAvgPrice;

          // Check data quality
          const hasFixedCosts = monthlyFixedCosts > 0;
          const hasTrips = yearTrips.length >= 3;
          const hasMiles = totalMiles > 0;
          const dataQuality = (hasFixedCosts ? 1 : 0) + (hasTrips ? 1 : 0) + (hasMiles ? 1 : 0);
          
          // Warning banner if data incomplete
          const warningBanner = dataQuality < 3 ? 
            '<div style="padding:12px 20px;background:rgba(251,191,36,0.2);border-bottom:1px solid rgba(251,191,36,0.3);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">' +
            '<span style="color:#fcd34d;font-size:12px">âš ï¸ ' + (!hasFixedCosts ? 'No fixed costs entered' : !hasTrips ? 'Need more trip data' : 'Missing miles data') + ' - metrics may be inaccurate</span>' +
            (!hasFixedCosts ? '<button onclick="openSetupWizard()" style="background:#fbbf24;color:#78350f;border:none;padding:6px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer">ðŸ§™â€â™‚ï¸ Setup Wizard</button>' : '') +
            '</div>' : '';
          
          return '<div class="card" style="margin-bottom:20px;background:linear-gradient(135deg,#1e293b,#334155);color:white;overflow:hidden">' +
            '<div style="padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.1)">' +
            '<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">' +
            '<h3 style="margin:0;color:white;font-size:16px">âš¡ Quick View - Company Profitability</h3>' +
            '<div style="display:flex;align-items:center;gap:12px">' +
            '<span style="background:rgba(255,255,255,0.15);padding:4px 10px;border-radius:12px;font-size:11px">' + totalMiles.toLocaleString() + ' miles â€¢ ' + totalCars + ' cars</span>' +
            '<button onclick="openSetupWizard()" style="background:rgba(59,130,246,0.3);color:#93c5fd;border:1px solid rgba(59,130,246,0.5);padding:4px 10px;border-radius:6px;font-size:11px;cursor:pointer">ðŸ§™â€â™‚ï¸ Setup</button>' +
            '</div></div></div>' +
            warningBanner +
            '<div style="display:grid;grid-template-columns:repeat(6,1fr);gap:0">' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1)">' +
            '<div style="font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Cost Per Mile</div>' +
            '<div style="font-size:28px;font-weight:700;color:#f87171">$' + cpm.toFixed(2) + '</div>' +
            '<div style="font-size:10px;color:#94a3b8;margin-top:4px">Operating CPM</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1)">' +
            '<div style="font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Revenue Per Mile</div>' +
            '<div style="font-size:28px;font-weight:700;color:#4ade80">$' + rpm.toFixed(2) + '</div>' +
            '<div style="font-size:10px;color:#94a3b8;margin-top:4px">Gross RPM</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1);background:' + (marginPerMile >= 0 ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)') + '">' +
            '<div style="font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Margin Per Mile</div>' +
            '<div style="font-size:28px;font-weight:700;color:' + (marginPerMile >= 0 ? '#4ade80' : '#f87171') + '">$' + marginPerMile.toFixed(2) + '</div>' +
            '<div style="font-size:10px;color:' + (marginPerMile >= 0 ? '#86efac' : '#fca5a5') + ';margin-top:4px">' + (marginPerMile >= 0 ? 'âœ“ Profitable' : 'âœ— Losing Money') + '</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1)">' +
            '<div style="font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Avg Vehicle Price</div>' +
            '<div style="font-size:28px;font-weight:700;color:#60a5fa">$' + currentAvgPrice.toFixed(0) + '</div>' +
            '<div style="font-size:10px;color:#94a3b8;margin-top:4px">Current Average</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1)">' +
            '<div style="font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Break-Even Price</div>' +
            '<div style="font-size:28px;font-weight:700;color:#a78bfa">$' + targetVehiclePrice.toFixed(0) + '</div>' +
            '<div style="font-size:10px;color:#94a3b8;margin-top:4px">Min per vehicle</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;background:' + (priceGap <= 0 ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)') + '">' +
            '<div style="font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Profit Per Vehicle</div>' +
            '<div style="font-size:28px;font-weight:700;color:' + (priceGap <= 0 ? '#4ade80' : '#f87171') + '">$' + Math.abs(currentAvgPrice - targetVehiclePrice).toFixed(0) + '</div>' +
            '<div style="font-size:10px;color:' + (priceGap <= 0 ? '#86efac' : '#fca5a5') + ';margin-top:4px">' + (priceGap <= 0 ? 'âœ“ Profitable' : 'âœ— Losing $' + Math.abs(priceGap).toFixed(0) + '/car') + '</div>' +
            '</div>' +
            '</div></div>';
        })() +
        
        // Second row - Other Metrics and Expense Breakdown
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px">' +
        
        // Left column - Other Metrics
        '<div class="card" style="padding:20px">' +
        '<h3 style="margin-bottom:16px;color:#0ea5e9;border-bottom:2px solid #0ea5e9;padding-bottom:8px">ðŸ“ˆ OTHER METRICS</h3>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:14px">' +
        '<div><span style="color:#64748b"># of Trucks in Service</span></div><div style="text-align:right;font-weight:600">' + appData.trucks.filter(t => t.status === 'ACTIVE').length + '</div>' +
        '<div><span style="color:#64748b">Total Miles Traveled</span></div><div style="text-align:right;font-weight:600">' + totalMiles.toLocaleString() + '</div>' +
        '<div><span style="color:#64748b"># of Trips</span></div><div style="text-align:right;font-weight:600">' + appData.trips.length + '</div>' +
        '<div><span style="color:#64748b"># of Cars Hauled</span></div><div style="text-align:right;font-weight:600">' + totalCars + '</div>' +
        '</div>' +
        
        // Most/Least Profitable Trips
        '<div style="margin-top:20px;padding:12px;background:#d1fae5;border-radius:8px">' +
        '<div style="font-size:12px;color:#047857">ðŸ† Most Profitable Trip</div>' +
        '<div style="font-size:18px;font-weight:700;color:#047857">' + (mostProfTrip ? mostProfTrip.trip_number : '-') + '</div>' +
        '<div style="font-size:14px;color:#047857">' + formatMoney(mostProf !== -Infinity ? mostProf : 0) + '</div>' +
        '</div>' +
        '<div style="margin-top:12px;padding:12px;background:#fee2e2;border-radius:8px">' +
        '<div style="font-size:12px;color:#dc2626">ðŸ“‰ Least Profitable Trip</div>' +
        '<div style="font-size:18px;font-weight:700;color:#dc2626">' + (leastProfTrip ? leastProfTrip.trip_number : '-') + '</div>' +
        '<div style="font-size:14px;color:#dc2626">' + formatMoney(leastProf !== Infinity ? leastProf : 0) + '</div>' +
        '</div>' +
        '</div>' +
        
        // Right column - Direct Trip Expenses Breakdown
        '<div class="card" style="padding:20px">' +
        '<h3 style="margin-bottom:16px;color:#ef4444;border-bottom:2px solid #ef4444;padding-bottom:8px">ðŸ’¸ DIRECT TRIP EXPENSES</h3>' +
        '<div style="display:flex;flex-direction:column;gap:12px">' +
        '<div style="display:flex;justify-content:space-between;align-items:center"><span>Broker Fees</span><span style="font-weight:600;color:#ef4444">' + formatMoney(totalBrokerFees) + '</span></div>' +
        '<div style="background:#fee2e2;height:8px;border-radius:4px"><div style="background:#ef4444;height:100%;border-radius:4px;width:' + (totalRev > 0 ? (totalBrokerFees/totalRev*100) : 0) + '%"></div></div>' +
        '<div style="display:flex;justify-content:space-between;align-items:center"><span>Local Fees</span><span style="font-weight:600;color:#f59e0b">' + formatMoney(totalLocalFees) + '</span></div>' +
        '<div style="background:#fef3c7;height:8px;border-radius:4px"><div style="background:#f59e0b;height:100%;border-radius:4px;width:' + (totalRev > 0 ? (totalLocalFees/totalRev*100) : 0) + '%"></div></div>' +
        '<div style="display:flex;justify-content:space-between;align-items:center"><span>Driver Cut</span><span style="font-weight:600;color:#8b5cf6">' + formatMoney(totalDriverCut) + '</span></div>' +
        '<div style="background:#ede9fe;height:8px;border-radius:4px"><div style="background:#8b5cf6;height:100%;border-radius:4px;width:' + (totalRev > 0 ? (totalDriverCut/totalRev*100) : 0) + '%"></div></div>' +
        '<div style="display:flex;justify-content:space-between;align-items:center"><span>Trip Expenses</span><span style="font-weight:600;color:#64748b">' + formatMoney(totalExpenses) + '</span></div>' +
        '<div style="background:#e2e8f0;height:8px;border-radius:4px"><div style="background:#64748b;height:100%;border-radius:4px;width:' + (totalRev > 0 ? (totalExpenses/totalRev*100) : 0) + '%"></div></div>' +
        '<div style="border-top:2px solid var(--border);padding-top:12px;margin-top:8px;display:flex;justify-content:space-between;align-items:center"><span style="font-weight:700">Total Direct Trip Expenses</span><span style="font-weight:700;color:#dc2626">' + formatMoney(totalBrokerFees + totalLocalFees + totalDriverCut + totalExpenses) + '</span></div>' +
        '</div>' +
        '</div>' +
        '</div>' +
        
        // Third row - KPIs and Performance
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px">' +
        
        // KPIs
        '<div class="card" style="padding:20px">' +
        '<h3 style="margin-bottom:16px;color:#8b5cf6;border-bottom:2px solid #8b5cf6;padding-bottom:8px">ðŸ“Š KEY PERFORMANCE INDICATORS</h3>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">' +
        '<div style="background:#f8fafc;padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#64748b">Revenue/Mile</div><div style="font-size:18px;font-weight:700;color:#1e293b">$' + revenuePerMile + '</div></div>' +
        '<div style="background:#f8fafc;padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#64748b">Profit/Mile</div><div style="font-size:18px;font-weight:700;color:' + (profitPerMile >= 0 ? '#047857' : '#dc2626') + '">$' + profitPerMile + '</div></div>' +
        '<div style="background:#f8fafc;padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#64748b">Avg Revenue/Trip</div><div style="font-size:18px;font-weight:700;color:#1e293b">$' + parseFloat(avgRevPerTrip).toLocaleString() + '</div></div>' +
        '<div style="background:#f8fafc;padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#64748b">Avg Profit/Trip</div><div style="font-size:18px;font-weight:700;color:' + (avgProfitPerTrip >= 0 ? '#047857' : '#dc2626') + '">$' + parseFloat(avgProfitPerTrip).toLocaleString() + '</div></div>' +
        '<div style="background:#f8fafc;padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#64748b">Avg Price/Car</div><div style="font-size:18px;font-weight:700;color:#1e293b">$' + parseFloat(avgPricePerCar).toLocaleString() + '</div></div>' +
        '<div style="background:#f8fafc;padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#64748b">Truck Gross</div><div style="font-size:18px;font-weight:700;color:#0ea5e9">' + formatMoney(truckGross) + '</div></div>' +
        '</div>' +
        '</div>' +
        
        // Truck & Dispatcher Performance
        '<div class="card" style="padding:20px">' +
        '<h3 style="margin-bottom:16px;color:#10b981;border-bottom:2px solid #10b981;padding-bottom:8px">ðŸ† TOP PERFORMERS</h3>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">' +
        '<div style="background:#d1fae5;padding:16px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#047857">Top Earner Truck</div><div style="font-size:24px;font-weight:700;color:#047857">#' + (topTruck ? appData.trucks.find(t => t.id == topTruck)?.truck_number || '-' : '-') + '</div><div style="font-size:14px;color:#047857">' + (topTruck ? formatMoney(truckPerf[topTruck].profit) : '-') + '</div></div>' +
        '<div style="background:#fee2e2;padding:16px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#dc2626">Lowest Earner Truck</div><div style="font-size:24px;font-weight:700;color:#dc2626">#' + (bottomTruck ? appData.trucks.find(t => t.id == bottomTruck)?.truck_number || '-' : '-') + '</div><div style="font-size:14px;color:#dc2626">' + (bottomTruck ? formatMoney(truckPerf[bottomTruck].profit) : '-') + '</div></div>' +
        '<div style="background:#dbeafe;padding:16px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#1d4ed8">Top Dispatcher</div><div style="font-size:18px;font-weight:700;color:#1d4ed8">' + (topDisp ? appData.dispatchers.find(d => d.id == topDisp)?.name || '-' : '-') + '</div><div style="font-size:14px;color:#1d4ed8">' + (topDisp ? dispPerf[topDisp].cars + ' cars' : '-') + '</div></div>' +
        '<div style="background:#f1f5f9;padding:16px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#64748b">Least Active Dispatcher</div><div style="font-size:18px;font-weight:700;color:#64748b">' + (bottomDisp ? appData.dispatchers.find(d => d.id == bottomDisp)?.name || '-' : '-') + '</div><div style="font-size:14px;color:#64748b">' + (bottomDisp ? dispPerf[bottomDisp].cars + ' cars' : '-') + '</div></div>' +
        '</div>' +
        '</div>' +
        '</div>' +
        
        // Fourth row - Payment Collections
        '<div class="card" style="padding:20px;margin-bottom:20px">' +
        '<h3 style="margin-bottom:16px;color:#0ea5e9;border-bottom:2px solid #0ea5e9;padding-bottom:8px">ðŸ’µ PAYMENT COLLECTION</h3>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px">' +
        '<div style="background:#d1fae5;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#047857">COD Collected</div><div style="font-size:20px;font-weight:700;color:#047857">' + formatMoney(codAmount) + '</div></div>' +
        '<div style="background:#bbf7d0;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#15803d">COP Collected</div><div style="font-size:20px;font-weight:700;color:#15803d">' + formatMoney(copAmount) + '</div></div>' +
        '<div style="background:#fef3c7;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#b45309">Local COD</div><div style="font-size:20px;font-weight:700;color:#b45309">' + formatMoney(localCodAmount) + '</div></div>' +
        '<div style="background:#dbeafe;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#1d4ed8">Check</div><div style="font-size:20px;font-weight:700;color:#1d4ed8">' + formatMoney(checkAmount) + '</div></div>' +
        '<div style="background:#ede9fe;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#7c3aed">Bill (Invoice)</div><div style="font-size:20px;font-weight:700;color:#7c3aed">' + formatMoney(billAmount) + '</div></div>' +
        '</div>' +
        '</div>' +
        
        // Cost Trend Sparklines Section
        (function() {
          // Get last 12 weeks of expense data
          const weeks = [];
          const today = new Date();
          for (let i = 11; i >= 0; i--) {
            const weekEnd = new Date(today);
            weekEnd.setDate(weekEnd.getDate() - (i * 7));
            const weekStart = new Date(weekEnd);
            weekStart.setDate(weekStart.getDate() - 6);
            weeks.push({ start: weekStart, end: weekEnd, label: 'W' + (12 - i) });
          }
          
          // Categories to track
          const categories = ['FUEL', 'TOLLS', 'MAINTENANCE', 'PERMITS', 'PARKING'];
          const categoryColors = { FUEL: '#ef4444', TOLLS: '#f59e0b', MAINTENANCE: '#3b82f6', PERMITS: '#8b5cf6', PARKING: '#10b981' };
          const categoryIcons = { FUEL: 'â›½', TOLLS: 'ðŸ›£ï¸', MAINTENANCE: 'ðŸ”§', PERMITS: 'ðŸ“‹', PARKING: 'ðŸ…¿ï¸' };
          
          // Calculate weekly totals per category
          const weeklyData = {};
          categories.forEach(cat => {
            weeklyData[cat] = weeks.map(w => {
              return appData.expenses
                .filter(e => e.category === cat && e.expense_date)
                .filter(e => {
                  const d = new Date(e.expense_date);
                  return d >= w.start && d <= w.end;
                })
                .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            });
          });
          
          // Calculate totals and trends
          const categoryStats = categories.map(cat => {
            const data = weeklyData[cat];
            const total = data.reduce((s, v) => s + v, 0);
            const recent4 = data.slice(-4).reduce((s, v) => s + v, 0);
            const prev4 = data.slice(-8, -4).reduce((s, v) => s + v, 0);
            const trend = prev4 > 0 ? ((recent4 - prev4) / prev4 * 100) : 0;
            const max = Math.max(...data, 1);
            const avg = total / 12;
            return { cat, data, total, trend, max, avg, color: categoryColors[cat], icon: categoryIcons[cat] };
          });
          
          // Generate SVG sparklines
          const generateSparkline = (data, max, color) => {
            const width = 120;
            const height = 32;
            const padding = 2;
            const points = data.map((v, i) => {
              const x = padding + (i / (data.length - 1)) * (width - 2 * padding);
              const y = height - padding - (v / max) * (height - 2 * padding);
              return x + ',' + y;
            }).join(' ');
            
            // Fill area
            const fillPoints = padding + ',' + (height - padding) + ' ' + points + ' ' + (width - padding) + ',' + (height - padding);
            
            return '<svg width="' + width + '" height="' + height + '" style="display:block">' +
              '<polygon points="' + fillPoints + '" fill="' + color + '" fill-opacity="0.15"/>' +
              '<polyline points="' + points + '" fill="none" stroke="' + color + '" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
              '<circle cx="' + (padding + (11 / 11) * (width - 2 * padding)) + '" cy="' + (height - padding - (data[11] / max) * (height - 2 * padding)) + '" r="3" fill="' + color + '"/>' +
              '</svg>';
          };
          
          return '<div class="card" style="padding:20px;margin-bottom:20px">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">' +
            '<h3 style="margin:0;color:#64748b;border-bottom:2px solid #64748b;padding-bottom:8px">ðŸ“ˆ COST TRENDS (Last 12 Weeks)</h3>' +
            '<div style="font-size:11px;color:#94a3b8">Hover for details</div>' +
            '</div>' +
            '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px">' +
            categoryStats.map(s => {
              const trendIcon = s.trend > 5 ? 'â†‘' : s.trend < -5 ? 'â†“' : 'â†’';
              const trendColor = s.trend > 5 ? '#dc2626' : s.trend < -5 ? '#16a34a' : '#64748b';
              const trendBg = s.trend > 5 ? '#fee2e2' : s.trend < -5 ? '#dcfce7' : '#f1f5f9';
              return '<div style="background:#f8fafc;border-radius:12px;padding:16px;border:1px solid #e2e8f0" title="' + s.cat + ': Last 12 weeks data">' +
                '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">' +
                '<div style="display:flex;align-items:center;gap:8px">' +
                '<span style="font-size:20px">' + s.icon + '</span>' +
                '<span style="font-weight:600;color:#334155">' + s.cat + '</span>' +
                '</div>' +
                '<span style="font-size:11px;padding:4px 8px;border-radius:12px;background:' + trendBg + ';color:' + trendColor + ';font-weight:600">' + trendIcon + ' ' + Math.abs(s.trend).toFixed(0) + '%</span>' +
                '</div>' +
                '<div style="margin-bottom:8px">' + generateSparkline(s.data, s.max, s.color) + '</div>' +
                '<div style="display:flex;justify-content:space-between;font-size:12px">' +
                '<div><span style="color:#94a3b8">Total:</span> <span style="font-weight:600;color:' + s.color + '">' + formatMoney(s.total) + '</span></div>' +
                '<div><span style="color:#94a3b8">Avg/wk:</span> <span style="font-weight:600">' + formatMoney(s.avg) + '</span></div>' +
                '</div>' +
                '</div>';
            }).join('') +
            '</div>' +
            '</div>';
        })();
    }
    
    function renderTasksWidget() {
      const tasks = appData.tasks || [];
      const today = new Date().toISOString().split('T')[0];
      
      // Get today's and overdue tasks
      const todayTasks = tasks.filter(t => t.due_date === today && t.status !== 'COMPLETED');
      const overdueTasks = tasks.filter(t => t.due_date < today && t.status !== 'COMPLETED');
      const urgentTasks = tasks.filter(t => t.priority === 'URGENT' && t.status !== 'COMPLETED');
      
      // Combine and sort: urgent first, then overdue, then today's
      let displayTasks = [...urgentTasks];
      overdueTasks.forEach(t => { if (!displayTasks.find(x => x.id === t.id)) displayTasks.push(t); });
      todayTasks.forEach(t => { if (!displayTasks.find(x => x.id === t.id)) displayTasks.push(t); });
      displayTasks = displayTasks.slice(0, 5); // Limit to 5
      
      const getPriorityIcon = (p) => {
        if (p === 'URGENT') return 'ðŸ”¥';
        if (p === 'HIGH') return 'âš ï¸';
        return '';
      };
      
      const isOverdue = (d) => d < today;
      
      return '<div class="card" style="margin-bottom:20px">' +
        '<div class="card-header" style="display:flex;justify-content:space-between;align-items:center">' +
        '<h3>ðŸ“‹ Today\'s Tasks</h3>' +
        '<div style="display:flex;gap:8px;align-items:center">' +
        (overdueTasks.length > 0 ? '<span class="badge" style="background:#dc2626;color:white">' + overdueTasks.length + ' Overdue</span>' : '') +
        (urgentTasks.length > 0 ? '<span class="badge" style="background:#f59e0b;color:white">' + urgentTasks.length + ' Urgent</span>' : '') +
        '<button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="navigate(\'tasks\')">View All â†’</button>' +
        '</div></div>' +
        (displayTasks.length === 0 ? 
          '<div style="padding:30px;text-align:center;color:#64748b">âœ“ No pending tasks for today!</div>' :
          '<div style="padding:16px">' +
          displayTasks.map(t => {
            const assignee = appData.dispatchers.find(d => d.id === t.assigned_to);
            const bgColor = t.priority === 'URGENT' ? '#fef3c7' : isOverdue(t.due_date) ? '#fee2e2' : '#f8fafc';
            const borderColor = t.priority === 'URGENT' ? '#f59e0b' : isOverdue(t.due_date) ? '#dc2626' : '#e5e7eb';
            
            return '<div style="display:flex;align-items:center;gap:12px;padding:12px;background:' + bgColor + ';border:1px solid ' + borderColor + ';border-radius:8px;margin-bottom:8px">' +
              '<input type="checkbox" style="width:18px;height:18px;cursor:pointer" onchange="quickCompleteTask(' + t.id + ',this.checked)" title="Mark as completed">' +
              '<div style="flex:1">' +
              '<div style="font-weight:600;display:flex;align-items:center;gap:8px">' + getPriorityIcon(t.priority) + t.title + 
              (isOverdue(t.due_date) ? ' <span style="color:#dc2626;font-size:12px;font-weight:400">(OVERDUE)</span>' : '') +
              '</div>' +
              '<div style="font-size:12px;color:#64748b">ðŸ“… ' + formatDate(t.due_date) + (assignee ? ' â€¢ ðŸ‘¤ ' + assignee.name : '') + '</div>' +
              '</div>' +
              '<button class="action-btn edit" onclick="openTaskModal(' + t.id + ')">Edit</button>' +
              '</div>';
          }).join('') +
          '</div>') +
        '</div>';
    }
    
    async function quickCompleteTask(id, complete) {
      try {
        await dbUpdate('tasks', id, { 
          status: complete ? 'COMPLETED' : 'PENDING',
          completed_at: complete ? new Date().toISOString() : null
        });
        showToast(complete ? 'Task completed! âœ“' : 'Task reopened');
        await loadAllData();
        renderDashboard(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    // ============ LOAD BOARD ============
    const loadBoardCategories = [
      { id: 'ny_to_home', name: 'NY to Home', color: '#3b82f6', subs: [
        { id: 'ny_sf', name: 'San Francisco' },
        { id: 'ny_la', name: 'Los Angeles' },
        { id: 'ny_tn', name: 'Tennessee' },
        { id: 'ny_ar', name: 'Arkansas' },
        { id: 'ny_nv', name: 'Nevada' },
        { id: 'ny_ok', name: 'Oklahoma' }
      ]},
      { id: 'home_to_ny', name: 'Home to NY', color: '#8b5cf6', subs: [] },
      { id: 'home_to_ca', name: 'Home to CA', color: '#06b6d4', subs: [
        { id: 'ca_sf', name: 'San Francisco' },
        { id: 'ca_la', name: 'Los Angeles' }
      ]},
      { id: 'ca_to_home', name: 'CA to Home', color: '#10b981', subs: [] },
      { id: 'fl_to_ca', name: 'FL to CA', color: '#f59e0b', subs: [] },
      { id: 'fl_to_home', name: 'FL to Home', color: '#ef4444', subs: [] },
      { id: 'ny_to_fl', name: 'NY to FL', color: '#ec4899', subs: [] }
    ];

    let selectedLoadCategory = 'ny_to_home';
    let selectedLoadSub = null;

    function renderLoadBoard(c) {
      // Get unassigned orders (no trip_id) grouped by load_category
      const unassignedOrders = appData.orders.filter(o => !o.trip_id);
      
      // Count per category
      const categoryCounts = {};
      loadBoardCategories.forEach(cat => {
        categoryCounts[cat.id] = unassignedOrders.filter(o => o.load_category === cat.id).length;
        cat.subs.forEach(sub => {
          categoryCounts[sub.id] = unassignedOrders.filter(o => o.load_category === cat.id && o.load_subcategory === sub.id).length;
        });
      });
      
      // Get current category
      const currentCat = loadBoardCategories.find(cat => cat.id === selectedLoadCategory) || loadBoardCategories[0];
      
      // Filter orders for display
      let displayOrders = unassignedOrders.filter(o => o.load_category === selectedLoadCategory);
      if (selectedLoadSub) {
        displayOrders = displayOrders.filter(o => o.load_subcategory === selectedLoadSub);
      }
      
      // Total revenue
      const totalRevenue = displayOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
      
      c.innerHTML = '<div class="header"><h2>ðŸ“‹ Future Cars</h2><div style="display:flex;gap:8px"><button class="btn btn-primary" onclick="openLoadBoardOrder()">+ Add Vehicle</button><button class="btn" style="background:#8b5cf6;color:white" onclick="openImportLoad()">ðŸ“¥ Import Load</button></div></div>' +
        
        // Stats
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:12px 16px"><div class="label">Total Unassigned</div><div class="value">' + unassignedOrders.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:12px 16px"><div class="label">In ' + currentCat.name + '</div><div class="value">' + categoryCounts[currentCat.id] + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:140px;padding:12px 16px"><div class="label">Revenue (Displayed)</div><div class="value">' + formatMoney(totalRevenue) + '</div></div>' +
        '</div>' +
        
        // Category tabs
        '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">' +
        loadBoardCategories.map(cat => {
          const isActive = cat.id === selectedLoadCategory;
          const inactiveBg = isDarkTheme ? '#1e293b' : 'white';
          return '<button onclick="selectedLoadCategory=\'' + cat.id + '\';selectedLoadSub=null;renderLoadBoard(document.getElementById(\'main-content\'))" style="padding:10px 16px;border:2px solid ' + cat.color + ';background:' + (isActive ? cat.color : inactiveBg) + ';color:' + (isActive ? 'white' : cat.color) + ';border-radius:8px;cursor:pointer;font-weight:600">' + cat.name + ' (' + categoryCounts[cat.id] + ')</button>';
        }).join('') +
        '</div>' +
        
        // Subcategory tabs (if any)
        (currentCat.subs.length > 0 ? '<div style="display:flex;gap:8px;margin-bottom:16px;padding-left:20px;flex-wrap:wrap">' +
        '<button onclick="selectedLoadSub=null;renderLoadBoard(document.getElementById(\'main-content\'))" style="padding:6px 12px;border:1px solid ' + (isDarkTheme ? '#475569' : '#cbd5e1') + ';background:' + (!selectedLoadSub ? '#1e40af' : (isDarkTheme ? '#1e293b' : 'white')) + ';color:' + (!selectedLoadSub ? 'white' : (isDarkTheme ? '#94a3b8' : '#475569')) + ';border-radius:6px;cursor:pointer;font-size:13px">All</button>' +
        currentCat.subs.map(sub => {
          const isActive = sub.id === selectedLoadSub;
          return '<button onclick="selectedLoadSub=\'' + sub.id + '\';renderLoadBoard(document.getElementById(\'main-content\'))" style="padding:6px 12px;border:1px solid ' + (isDarkTheme ? '#475569' : '#cbd5e1') + ';background:' + (isActive ? '#1e40af' : (isDarkTheme ? '#1e293b' : 'white')) + ';color:' + (isActive ? 'white' : (isDarkTheme ? '#94a3b8' : '#475569')) + ';border-radius:6px;cursor:pointer;font-size:13px">' + sub.name + ' (' + categoryCounts[sub.id] + ')</button>';
        }).join('') +
        '</div>' : '') +
        
        // Orders table
        '<div class="card"><div class="card-header" style="background:' + currentCat.color + ';color:white;border-radius:8px 8px 0 0"><h3 style="margin:0">' + currentCat.name + (selectedLoadSub ? ' â†’ ' + currentCat.subs.find(s => s.id === selectedLoadSub)?.name : '') + '</h3></div>' +
        (displayOrders.length === 0 ? '<div style="padding:40px;text-align:center;color:#64748b">No vehicles in this category</div>' :
        '<div class="table-wrapper"><table><thead><tr><th>Order</th><th>Broker</th><th>Vehicle</th><th>Origin</th><th>ðŸ“žP</th><th>Destination</th><th>ðŸ“žD</th><th>Pick-Up</th><th>Delivery</th><th>Payment</th><th>Broker Fee</th><th>Local Fee</th><th>Revenue</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        displayOrders.map(o => {
          const noteHtml = o.dispatcher_notes ? '<tr style="background:#fef3c7"><td colspan="14" style="padding:8px 16px;font-size:13px"><span style="font-weight:600;color:#92400e">ðŸ“ Note:</span> ' + o.dispatcher_notes + '</td></tr>' : '';
          const pickupPhoneDisplay = o.pickup_phone ? '<a href="tel:' + o.pickup_phone + '" style="color:#3b82f6" title="' + o.pickup_phone + '">ðŸ“ž</a>' : '-';
          const deliveryPhoneDisplay = o.delivery_phone ? '<a href="tel:' + o.delivery_phone + '" style="color:#10b981" title="' + o.delivery_phone + '">ðŸ“ž</a>' : '-';
          return '<tr><td><strong>' + o.order_number + '</strong></td><td>' + (o.broker_name || '-') + '</td><td>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</td><td title="' + (o.pickup_full_address || o.origin || '') + '">' + (o.origin || '-') + '</td><td>' + pickupPhoneDisplay + '</td><td title="' + (o.delivery_full_address || o.destination || '') + '">' + (o.destination || '-') + '</td><td>' + deliveryPhoneDisplay + '</td><td>' + (o.pickup_date ? formatDate(o.pickup_date) : '-') + '</td><td>' + (o.dropoff_date ? formatDate(o.dropoff_date) : '-') + '</td><td><span class="badge badge-blue">' + (o.payment_type || '-') + '</span></td><td class="money negative">' + formatMoney(o.broker_fee || 0) + '</td><td class="money negative">' + formatMoney(o.local_fee || 0) + '</td><td class="money">' + formatMoney(o.revenue) + '</td><td class="sticky-col"><div class="actions">' + (o.dispatcher_notes ? '<button class="action-btn" style="background:#fef3c7;color:#92400e" title="' + o.dispatcher_notes.replace(/"/g, '&quot;') + '">ðŸ“</button>' : '') + '<button class="action-btn view" onclick="openAssignToTrip(' + o.id + ')">Assign</button><button class="action-btn edit" onclick="openLoadBoardOrder(' + o.id + ')">Edit</button><button class="action-btn delete" onclick="deleteLoadBoardOrder(' + o.id + ')">Del</button></div></td></tr>' + noteHtml;
        }).join('') +
        '</tbody></table></div>') +
        '</div>';
    }

    function openLoadBoardOrder(id = null) {
      const o = id ? appData.orders.find(x => x.id === id) : null;
      vehicleList = [];
      
      // Find dispatcher matching current user
      let userDispatcher = appData.dispatchers.find(d => d.user_id === currentUser.id);
      if (!userDispatcher) {
        userDispatcher = appData.dispatchers.find(d => d.email && d.email.toLowerCase() === currentUser.email.toLowerCase());
      }
      if (!userDispatcher) {
        const fullName = (currentUser.first_name + ' ' + currentUser.last_name).toLowerCase();
        userDispatcher = appData.dispatchers.find(d => d.name && d.name.toLowerCase() === fullName);
      }
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:700px;max-height:90vh;display:flex;flex-direction:column"><div class="modal-header"><h3>' + (o ? 'Edit' : 'Add') + ' Vehicle to Future Cars</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body" style="overflow-y:auto;flex:1">' +
        
        // Category Selection
        '<div class="form-row"><div class="form-group"><label>Category *</label><select id="lbCategory" onchange="toggleLoadBoardSub()" style="border:2px solid #22c55e;font-weight:600">' + loadBoardCategories.map(cat => '<option value="' + cat.id + '"' + (o?.load_category === cat.id ? ' selected' : '') + '>' + cat.name + '</option>').join('') + '</select></div><div class="form-group" id="lbSubGroup" style="display:none"><label>Sub-Category</label><select id="lbSubCategory"></select></div></div>' +
        
        // Order # and Broker
        '<div class="form-row"><div class="form-group"><label>Order #</label><input id="lbOrderNum" value="' + (o?.order_number || 'ORD-' + Date.now().toString().slice(-4)) + '"></div><div class="form-group" style="position:relative"><label>Broker</label><input type="text" id="lbBrokerInput" placeholder="Start typing broker..." value="' + (o?.broker_name || '') + '" autocomplete="off"><input type="hidden" id="lbBrokerId" value="' + (o?.broker_id || '') + '"></div></div>' +
        '<div id="lbNewBrokerSection" style="display:none;background:#f0fdf4;padding:12px;border-radius:8px;margin-bottom:12px;border:1px solid #bbf7d0"><div class="form-group" style="margin-bottom:0"><label>New Broker Name *</label><input id="lbNewBrokerName" placeholder="Enter broker name"></div></div>' +
        
        // Vehicle Info Section with separate Year, Make, Model
        '<div style="background:#f8fafc;padding:12px;border-radius:8px;margin-bottom:16px">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><label style="font-weight:600;margin:0">ðŸš— Vehicle Info</label></div>' +
        '<div class="form-row" style="gap:12px;align-items:flex-end">' +
        '<div class="form-group" style="margin-bottom:0;flex:0 0 100px;position:relative"><label>Year</label><input type="text" id="lbYear" value="' + (o?.vehicle_year || new Date().getFullYear()) + '" placeholder="Year" autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>Make</label><input type="text" id="lbMake" value="' + (o?.vehicle_make || '') + '" placeholder="Start typing make..." autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>Model</label><input type="text" id="lbModel" value="' + (o?.vehicle_model || '') + '" placeholder="Start typing model..." autocomplete="off"></div>' +
        (!o ? '<button type="button" class="btn btn-secondary" onclick="addAnotherVehicleLB()" style="height:42px;white-space:nowrap">+ Add Another</button>' : '') + '</div>' +
        
        // Vehicle List (shows when multiple vehicles added) - only for new
        (!o ? '<div id="lbVehicleListSection" style="margin-top:12px;display:none"><div id="lbVehicleListItems"></div></div>' : '') + '</div>' +
        
        // Pickup Section
        '<div style="background:#dbeafe;padding:12px;border-radius:8px;margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px">ðŸ“ PICKUP</label>' +
        '<div class="form-row" style="gap:12px">' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>City/State</label><input type="text" id="lbOrigin" value="' + (o?.origin || '') + '" placeholder="Start typing city..." autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:0 0 140px"><label>ðŸ“ž Phone</label><input type="tel" id="lbPickupPhone" value="' + (o?.pickup_phone || '') + '" placeholder="(555) 123-4567"></div></div>' +
        '<div class="form-group" style="margin-bottom:0;margin-top:8px;position:relative"><label>Full Address</label><input type="text" id="lbPickupFullAddress" value="' + (o?.pickup_full_address || '') + '" placeholder="Full street address" autocomplete="off"></div></div>' +
        
        // Delivery Section
        '<div style="background:#d1fae5;padding:12px;border-radius:8px;margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px">ðŸ DELIVERY</label>' +
        '<div class="form-row" style="gap:12px">' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>City/State</label><input type="text" id="lbDest" value="' + (o?.destination || '') + '" placeholder="Start typing city..." autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:0 0 140px"><label>ðŸ“ž Phone</label><input type="tel" id="lbDeliveryPhone" value="' + (o?.delivery_phone || '') + '" placeholder="(555) 123-4567"></div></div>' +
        '<div class="form-group" style="margin-bottom:0;margin-top:8px;position:relative"><label>Full Address</label><input type="text" id="lbDeliveryFullAddress" value="' + (o?.delivery_full_address || '') + '" placeholder="Full street address" autocomplete="off"></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Pick-Up Date</label><input type="date" id="lbPickup" value="' + (o?.pickup_date || '') + '"></div><div class="form-group"><label>Drop-Off Date</label><input type="date" id="lbDropoff" value="' + (o?.dropoff_date || '') + '"></div></div>' +
        
        // Payment Section with Split Payment
        '<div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:16px"><label style="font-weight:600;margin-bottom:8px;display:block">ðŸ’° Payment</label>' +
        '<div class="form-row" style="gap:12px"><div class="form-group" style="margin-bottom:0"><label>Total Revenue $</label><input type="number" id="lbRevenue" value="' + (o?.revenue || '') + '" onchange="updateLBPaymentSplit()"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label>Payment Type</label><select id="lbPayment" onchange="toggleLBSplitPayment()"><option value="BILL"' + (o?.payment_type === 'BILL' ? ' selected' : '') + '>BILL (Invoice)</option><option value="COD"' + (o?.payment_type === 'COD' ? ' selected' : '') + '>COD (Cash on Delivery)</option><option value="COP"' + (o?.payment_type === 'COP' ? ' selected' : '') + '>COP (Cash on Pickup)</option><option value="LOCAL_COD"' + (o?.payment_type === 'LOCAL_COD' ? ' selected' : '') + '>LOCAL_COD (Local Driver)</option><option value="CHECK"' + (o?.payment_type === 'CHECK' ? ' selected' : '') + '>CHECK</option><option value="SPLIT"' + (o?.payment_type === 'SPLIT' ? ' selected' : '') + '>SPLIT (Multiple)</option></select></div></div>' +
        '<div id="lbSplitPaymentSection" style="display:' + (o?.payment_type === 'SPLIT' ? 'block' : 'none') + ';margin-top:12px;padding-top:12px;border-top:1px dashed #f59e0b">' +
        '<div class="form-row" style="grid-template-columns:1fr 1fr 1fr;gap:12px">' +
        '<div class="form-group" style="margin-bottom:0"><label>COD/COP Amount $</label><input type="number" id="lbSplitCodAmount" value="' + (o?.cod_amount || 0) + '" onchange="updateLBSplitBill()"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label>Bill Amount $</label><input type="number" id="lbSplitBillAmount" value="' + (o?.bill_amount || 0) + '" readonly style="background:#f1f5f9"></div>' +
        '</div></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Broker Fee $</label><input type="number" id="lbBrokerFee" value="' + (o?.broker_fee || 0) + '"></div><div class="form-group"><label>Local Fee $</label><input type="number" id="lbLocalFee" value="' + (o?.local_fee || 0) + '"></div></div>' +
        '<div class="form-group"><label>ðŸ“ Notes for Dispatchers</label><textarea id="lbNotes" rows="2" placeholder="Add notes visible to all dispatchers..." style="resize:vertical">' + (o?.dispatcher_notes || '') + '</textarea></div>' +
        '<div class="form-group"><label>Booked By</label>' + 
        (currentUser.role === 'ADMIN' || currentUser.role === 'MANAGER' ? 
          '<select id="lbDispatcher"><option value="">Select Dispatcher</option>' + appData.dispatchers.map(d => '<option value="' + d.id + '"' + ((o?.dispatcher_id === d.id || (!o && userDispatcher && userDispatcher.id === d.id)) ? ' selected' : '') + '>' + d.name + '</option>').join('') + '</select>' :
          '<input type="text" id="lbDispatcherName" value="' + (userDispatcher ? userDispatcher.name : currentUser.first_name + ' ' + currentUser.last_name) + '" readonly style="background:#f1f5f9;cursor:not-allowed"><input type="hidden" id="lbDispatcher" value="' + (userDispatcher ? userDispatcher.id : '') + '">'
        ) + '</div>' +
        
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveLoadBoardOrder(' + id + ')">' + (o ? 'Update' : 'Save') + '</button></div></div>';
      document.body.appendChild(m);
      
      // Setup broker autocomplete
      setupBrokerAutocomplete('lbBrokerInput');
      
      // Setup location autocomplete
      setupLocationAutocomplete('lbOrigin');
      setupLocationAutocomplete('lbDest');
      
      // Setup address autocomplete
      setupAddressAutocomplete('lbPickupFullAddress');
      setupAddressAutocomplete('lbDeliveryFullAddress');
      
      // Setup year autocomplete
      setupYearAutocomplete('lbYear');
      
      // Setup make autocomplete
      setupMakeAutocomplete('lbMake');
      
      // Setup model autocomplete (depends on make)
      setupModelAutocomplete('lbModel');
      
      // Initialize subcategory and set existing value if editing
      toggleLoadBoardSub();
      if (o?.load_subcategory) {
        setTimeout(() => {
          const subSelect = document.getElementById('lbSubCategory');
          if (subSelect) subSelect.value = o.load_subcategory;
        }, 100);
      }
    }
    
    // Vehicle list for Future Cars (multiple vehicles)
    let lbVehicleList = [];
    
    function addAnotherVehicleLB() {
      const year = document.getElementById('lbYear').value;
      const make = document.getElementById('lbMake').value;
      const model = document.getElementById('lbModel').value;
      
      if (!make || !model) {
        showToast('Please enter make and model first', 'error');
        return;
      }
      
      lbVehicleList.push({ year, make, model });
      updateLBVehicleListDisplay();
      
      // Clear inputs for next vehicle
      document.getElementById('lbYear').value = new Date().getFullYear();
      document.getElementById('lbMake').value = '';
      document.getElementById('lbModel').value = '';
      document.getElementById('lbMake').focus();
    }
    
    function updateLBVehicleListDisplay() {
      const section = document.getElementById('lbVehicleListSection');
      const container = document.getElementById('lbVehicleListItems');
      
      if (lbVehicleList.length === 0) {
        section.style.display = 'none';
        return;
      }
      
      section.style.display = 'block';
      const itemBg = isDarkTheme ? '#1e293b' : 'white';
      const itemBorder = isDarkTheme ? '#475569' : '#e2e8f0';
      container.innerHTML = '<div style="font-size:12px;color:#64748b;margin-bottom:8px">' + lbVehicleList.length + ' vehicle(s) added:</div>' +
        lbVehicleList.map((v, i) => '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:' + itemBg + ';border-radius:6px;margin-bottom:4px;border:1px solid ' + itemBorder + '">' +
          '<span style="font-weight:500">' + v.year + ' ' + v.make + ' ' + v.model + '</span>' +
          '<button onclick="removeLBVehicle(' + i + ')" style="background:#fee2e2;color:#dc2626;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px">âœ•</button></div>').join('');
    }
    
    function removeLBVehicle(index) {
      lbVehicleList.splice(index, 1);
      updateLBVehicleListDisplay();
    }
    
    function toggleLBSplitPayment() {
      const payType = document.getElementById('lbPayment').value;
      document.getElementById('lbSplitPaymentSection').style.display = payType === 'SPLIT' ? 'block' : 'none';
    }
    
    function updateLBPaymentSplit() {
      const total = parseFloat(document.getElementById('lbRevenue').value) || 0;
      const codAmount = parseFloat(document.getElementById('lbSplitCodAmount').value) || 0;
      document.getElementById('lbSplitBillAmount').value = Math.max(0, total - codAmount);
    }
    
    function updateLBSplitBill() {
      updateLBPaymentSplit();
    }

    function toggleLoadBoardSub() {
      const catSelect = document.getElementById('lbCategory');
      const subGroup = document.getElementById('lbSubGroup');
      const subSelect = document.getElementById('lbSubCategory');
      
      const selectedCat = loadBoardCategories.find(c => c.id === catSelect.value);
      
      if (selectedCat && selectedCat.subs.length > 0) {
        subGroup.style.display = 'block';
        subSelect.innerHTML = '<option value="">Select...</option>' + selectedCat.subs.map(s => '<option value="' + s.id + '">' + s.name + '</option>').join('');
      } else {
        subGroup.style.display = 'none';
        subSelect.innerHTML = '';
      }
    }

    async function saveLoadBoardOrder(id) {
      const loadCategory = document.getElementById('lbCategory').value;
      if (!loadCategory) { showToast('Please select a category', 'error'); return; }
      
      const subSelect = document.getElementById('lbSubCategory');
      const loadSubcategory = subSelect && subSelect.value ? subSelect.value : null;
      
      // Handle broker from autocomplete
      let brokerId = document.getElementById('lbBrokerId').value;
      let brokerName = document.getElementById('lbBrokerInput').value;
      
      // Check if we need to create a new broker
      if (brokerName && !brokerId) {
        const existingBroker = appData.brokers.find(b => b.name.toLowerCase() === brokerName.toLowerCase());
        if (existingBroker) {
          brokerId = existingBroker.id;
        } else {
          // Check if new broker section is visible
          const newBrokerName = document.getElementById('lbNewBrokerName')?.value?.trim();
          if (newBrokerName) {
            try {
              const newBroker = await dbInsert('brokers', { name: newBrokerName });
              brokerId = newBroker.id;
              brokerName = newBrokerName;
            } catch (e) { showToast('Failed to create broker', 'error'); return; }
          }
        }
      }
      
      // Get payment split data
      const paymentType = document.getElementById('lbPayment').value;
      const codAmount = paymentType === 'SPLIT' ? parseFloat(document.getElementById('lbSplitCodAmount').value) || 0 : null;
      const billAmount = paymentType === 'SPLIT' ? parseFloat(document.getElementById('lbSplitBillAmount').value) || 0 : null;
      
      // Get current vehicle from form
      const currentYear = document.getElementById('lbYear').value;
      const currentMake = document.getElementById('lbMake').value;
      const currentModel = document.getElementById('lbModel').value;
      
      // Build vehicles list - either the list or single vehicle
      let vehiclesToSave = [];
      if (lbVehicleList && lbVehicleList.length > 0) {
        vehiclesToSave = [...lbVehicleList];
        // Add current vehicle if filled
        if (currentMake && currentModel) {
          vehiclesToSave.push({ year: currentYear, make: currentMake, model: currentModel });
        }
      } else {
        if (!currentMake || !currentModel) {
          showToast('Please enter vehicle make and model', 'error');
          return;
        }
        vehiclesToSave.push({ year: currentYear, make: currentMake, model: currentModel });
      }
      
      const baseData = {
        order_number: document.getElementById('lbOrderNum').value,
        broker_id: brokerId ? parseInt(brokerId) : null,
        broker_name: brokerName || null,
        origin: document.getElementById('lbOrigin').value,
        destination: document.getElementById('lbDest').value,
        pickup_phone: document.getElementById('lbPickupPhone')?.value || null,
        delivery_phone: document.getElementById('lbDeliveryPhone')?.value || null,
        pickup_full_address: document.getElementById('lbPickupFullAddress')?.value || null,
        delivery_full_address: document.getElementById('lbDeliveryFullAddress')?.value || null,
        pickup_date: document.getElementById('lbPickup').value || null,
        dropoff_date: document.getElementById('lbDropoff').value || null,
        revenue: parseFloat(document.getElementById('lbRevenue').value) || 0,
        broker_fee: parseFloat(document.getElementById('lbBrokerFee').value) || 0,
        local_fee: parseFloat(document.getElementById('lbLocalFee').value) || 0,
        payment_type: paymentType,
        cod_amount: codAmount,
        bill_amount: billAmount,
        load_category: loadCategory,
        load_subcategory: loadSubcategory,
        dispatcher_id: document.getElementById('lbDispatcher').value ? parseInt(document.getElementById('lbDispatcher').value) : null,
        dispatcher_notes: document.getElementById('lbNotes').value || null,
        trip_id: null,
        status: 'PENDING'
      };
      
      try {
        if (id) {
          // Editing single vehicle
          const data = { ...baseData, vehicle_year: parseInt(vehiclesToSave[0].year), vehicle_make: vehiclesToSave[0].make, vehicle_model: vehiclesToSave[0].model };
          await dbUpdate('orders', id, data);
          showToast('Vehicle updated!');
        } else {
          // Creating new - possibly multiple vehicles
          // Revenue/fees apply to ORDER as whole, stored only on FIRST vehicle
          const orderGroupId = baseData.order_number;
          
          for (let i = 0; i < vehiclesToSave.length; i++) {
            const v = vehiclesToSave[i];
            const data = { 
              ...baseData, 
              vehicle_year: parseInt(v.year), 
              vehicle_make: v.make, 
              vehicle_model: v.model,
              order_number: vehiclesToSave.length > 1 ? baseData.order_number + '-' + (i + 1) : baseData.order_number,
              order_group_id: orderGroupId,
              // Only first vehicle gets revenue/fees
              revenue: i === 0 ? baseData.revenue : 0,
              broker_fee: i === 0 ? baseData.broker_fee : 0,
              local_fee: i === 0 ? baseData.local_fee : 0,
              cod_amount: i === 0 ? baseData.cod_amount : 0,
              bill_amount: i === 0 ? baseData.bill_amount : 0
            };
            await dbInsert('orders', data);
          }
          const totalRev = baseData.revenue || 0;
          showToast(vehiclesToSave.length > 1 ? vehiclesToSave.length + ' vehicles added! Order total: $' + totalRev : 'Vehicle saved!');
        }
        
        // Reset vehicle list
        lbVehicleList = [];
        
        document.querySelector('.modal-overlay').remove();
        await loadAllData();
        renderLoadBoard(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteLoadBoardOrder(id) {
      if (!confirm('Delete this vehicle?')) return;
      await dbDelete('orders', id);
      showToast('Deleted');
      await loadAllData();
      renderLoadBoard(document.getElementById('main-content'));
    }

    // ============ IMPORT LOAD FUNCTION ============
    function openImportLoad() {
      const m = document.createElement('div'); 
      m.className = 'modal-overlay'; 
      m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:800px;max-height:95vh;display:flex;flex-direction:column"><div class="modal-header" style="background:#8b5cf6;color:white"><h3 style="margin:0">ðŸ“¥ Import Load from Rate Confirmation</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()" style="color:white">Ã—</button></div><div class="modal-body" style="overflow-y:auto;flex:1;padding:20px">' +
        
        // Step 1: Paste Rate Confirmation
        '<div id="importStep1">' +
        '<div style="background:#f3e8ff;padding:16px;border-radius:8px;margin-bottom:16px">' +
        '<div style="font-weight:600;color:#7c3aed;margin-bottom:8px">Step 1: Paste Rate Confirmation</div>' +
        '<div style="color:#6b7280;font-size:13px">Copy the text from your rate confirmation email or document and paste it below. AI will extract all vehicle and order information.</div></div>' +
        '<div class="form-group"><textarea id="importRateText" rows="10" placeholder="Paste rate confirmation text here...\n\nExample:\nOrder #12345\nBroker: ABC Transport\n2024 BMW X5\nPickup: New York, NY\nDelivery: Los Angeles, CA\nRate: $1,200\n..." style="resize:vertical;width:100%;font-family:monospace;font-size:13px"></textarea></div>' +
        '<button class="btn" style="background:#8b5cf6;color:white;width:100%" onclick="extractLoadInfo()">ðŸ¤– Extract Information</button>' +
        '</div>' +
        
        // Step 2: Preview & Category (hidden initially)
        '<div id="importStep2" style="display:none">' +
        '<div style="background:#d1fae5;padding:16px;border-radius:8px;margin-bottom:16px">' +
        '<div style="font-weight:600;color:#059669;margin-bottom:8px">âœ… Step 2: Review & Assign Category</div>' +
        '<div style="color:#6b7280;font-size:13px">Review the extracted information, select the correct category, and adjust any fields if needed.</div></div>' +
        
        // Category Selection
        '<div style="background:#fef3c7;padding:16px;border-radius:8px;margin-bottom:16px">' +
        '<div class="form-row"><div class="form-group" style="margin-bottom:0"><label style="font-weight:600">ðŸ“ Category *</label><select id="importCategory" onchange="toggleImportSubcategory()" style="border:2px solid #f59e0b;font-weight:600">' + loadBoardCategories.map(cat => '<option value="' + cat.id + '">' + cat.name + '</option>').join('') + '</select></div>' +
        '<div class="form-group" style="margin-bottom:0" id="importSubGroup"><label style="font-weight:600">Sub-Category</label><select id="importSubCategory"></select></div></div></div>' +
        
        // Extracted Info Preview
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">' +
        
        // Left Column - Order & Vehicle
        '<div>' +
        '<div style="background:#f8fafc;padding:12px;border-radius:8px;margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px">ðŸ“‹ Order Info</label>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Order #</label><input type="text" id="importOrderNum" style="font-size:14px"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Broker</label><input type="text" id="importBroker" style="font-size:14px"></div></div>' +
        
        '<div style="background:#f8fafc;padding:12px;border-radius:8px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px">ðŸš— Vehicle</label>' +
        '<div class="form-row" style="gap:8px"><div class="form-group" style="margin-bottom:8px;flex:0 0 80px"><label style="font-size:12px">Year</label><input type="text" id="importYear" style="font-size:14px"></div>' +
        '<div class="form-group" style="margin-bottom:8px;flex:1"><label style="font-size:12px">Make</label><input type="text" id="importMake" style="font-size:14px"></div></div>' +
        '<div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Model</label><input type="text" id="importModel" style="font-size:14px"></div></div>' +
        '</div>' +
        
        // Right Column - Locations & Payment
        '<div>' +
        '<div style="background:#dbeafe;padding:12px;border-radius:8px;margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px">ðŸ“ Pickup</label>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">City, State</label><input type="text" id="importOrigin" style="font-size:14px"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Phone</label><input type="text" id="importPickupPhone" style="font-size:14px"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Date</label><input type="date" id="importPickupDate" style="font-size:14px"></div></div>' +
        
        '<div style="background:#d1fae5;padding:12px;border-radius:8px;margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px">ðŸ Delivery</label>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">City, State</label><input type="text" id="importDestination" style="font-size:14px"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Phone</label><input type="text" id="importDeliveryPhone" style="font-size:14px"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Date</label><input type="date" id="importDeliveryDate" style="font-size:14px"></div></div>' +
        '</div></div>' +
        
        // Payment Row
        '<div style="background:#fef3c7;padding:12px;border-radius:8px;margin-top:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px">ðŸ’° Payment</label>' +
        '<div class="form-row" style="gap:12px">' +
        '<div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Revenue $</label><input type="number" id="importRevenue" style="font-size:14px"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Payment Type</label><select id="importPaymentType" style="font-size:14px"><option value="BILL">BILL</option><option value="COD">COD</option><option value="COP">COP</option><option value="LOCAL_COD">LOCAL_COD</option><option value="CHECK">CHECK</option><option value="SPLIT">SPLIT</option></select></div>' +
        '<div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Broker Fee $</label><input type="number" id="importBrokerFee" value="0" style="font-size:14px"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Local Fee $</label><input type="number" id="importLocalFee" value="0" style="font-size:14px"></div>' +
        '</div></div>' +
        
        // Notes
        '<div class="form-group" style="margin-top:12px"><label style="font-size:12px">ðŸ“ Notes</label><textarea id="importNotes" rows="2" style="font-size:14px"></textarea></div>' +
        
        // Back button
        '<button class="btn btn-secondary" style="margin-top:12px" onclick="document.getElementById(\'importStep1\').style.display=\'block\';document.getElementById(\'importStep2\').style.display=\'none\'">â† Back to Edit Text</button>' +
        '</div>' +
        
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn" style="background:#8b5cf6;color:white" id="importSaveBtn" onclick="saveImportedLoad()" disabled>Import to Future Cars</button></div></div>';
      document.body.appendChild(m);
      toggleImportSubcategory();
    }

    function toggleImportSubcategory() {
      const catSelect = document.getElementById('importCategory');
      const subGroup = document.getElementById('importSubGroup');
      const subSelect = document.getElementById('importSubCategory');
      const cat = loadBoardCategories.find(c => c.id === catSelect.value);
      
      if (cat && cat.subs && cat.subs.length > 0) {
        subGroup.style.display = 'block';
        subSelect.innerHTML = '<option value="">-- None --</option>' + cat.subs.map(s => '<option value="' + s.id + '">' + s.name + '</option>').join('');
      } else {
        subGroup.style.display = 'none';
        subSelect.innerHTML = '';
      }
    }

    async function extractLoadInfo() {
      const rateText = document.getElementById('importRateText').value.trim();
      if (!rateText) {
        showToast('Please paste the rate confirmation text', 'error');
        return;
      }
      
      // Show loading state
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = 'ðŸ”„ Extracting...';
      btn.disabled = true;
      
      try {
        // Call Anthropic API to extract information
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': ANTHROPIC_API_KEY,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1024,
            messages: [{
              role: 'user',
              content: `Extract the following information from this rate confirmation. Return ONLY a JSON object with these exact fields (use null for missing values):

{
  "order_number": "string or null",
  "broker_name": "string or null", 
  "vehicle_year": "number or null",
  "vehicle_make": "string or null",
  "vehicle_model": "string or null",
  "origin_city_state": "string like 'New York, NY' or null",
  "destination_city_state": "string like 'Los Angeles, CA' or null",
  "pickup_phone": "string or null",
  "delivery_phone": "string or null",
  "pickup_date": "string in YYYY-MM-DD format or null",
  "delivery_date": "string in YYYY-MM-DD format or null",
  "revenue": "number or null",
  "payment_type": "BILL or COD or COP or LOCAL_COD or CHECK or null",
  "broker_fee": "number or null",
  "notes": "string with special instructions or null"
}

Rate Confirmation Text:
${rateText}`
            }]
          })
        });
        
        if (!response.ok) {
          throw new Error('API request failed');
        }
        
        const data = await response.json();
        const content = data.content[0].text;
        
        // Parse JSON from response
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (!jsonMatch) {
          throw new Error('Could not parse response');
        }
        
        const extracted = JSON.parse(jsonMatch[0]);
        
        // Populate form fields
        document.getElementById('importOrderNum').value = extracted.order_number || 'ORD-' + Date.now().toString().slice(-4);
        document.getElementById('importBroker').value = extracted.broker_name || '';
        document.getElementById('importYear').value = extracted.vehicle_year || new Date().getFullYear();
        document.getElementById('importMake').value = extracted.vehicle_make || '';
        document.getElementById('importModel').value = extracted.vehicle_model || '';
        document.getElementById('importOrigin').value = extracted.origin_city_state || '';
        document.getElementById('importDestination').value = extracted.destination_city_state || '';
        document.getElementById('importPickupPhone').value = extracted.pickup_phone || '';
        document.getElementById('importDeliveryPhone').value = extracted.delivery_phone || '';
        document.getElementById('importPickupDate').value = extracted.pickup_date || '';
        document.getElementById('importDeliveryDate').value = extracted.delivery_date || '';
        document.getElementById('importRevenue').value = extracted.revenue || '';
        const validPaymentTypes = ['BILL', 'COD', 'COP', 'LOCAL_COD', 'CHECK', 'SPLIT'];
        const extractedPayment = extracted.payment_type?.toUpperCase();
        document.getElementById('importPaymentType').value = validPaymentTypes.includes(extractedPayment) ? extractedPayment : 'BILL';
        document.getElementById('importBrokerFee').value = extracted.broker_fee || 0;
        document.getElementById('importNotes').value = extracted.notes || '';
        
        // Show step 2
        document.getElementById('importStep1').style.display = 'none';
        document.getElementById('importStep2').style.display = 'block';
        document.getElementById('importSaveBtn').disabled = false;
        
        showToast('Information extracted! Please review and select category.');
        
      } catch (e) {
        console.error('Extraction error:', e);
        showToast('Failed to extract: ' + e.message, 'error');
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    async function saveImportedLoad() {
      const category = document.getElementById('importCategory').value;
      const subcategory = document.getElementById('importSubCategory')?.value || null;
      
      // Find dispatcher for current user
      let userDispatcher = appData.dispatchers.find(d => d.user_id === currentUser.id);
      if (!userDispatcher) {
        userDispatcher = appData.dispatchers.find(d => d.email && d.email.toLowerCase() === currentUser.email.toLowerCase());
      }
      
      // Validate payment type
      const validPaymentTypes = ['BILL', 'COD', 'COP', 'LOCAL_COD', 'CHECK', 'SPLIT'];
      const selectedPayment = document.getElementById('importPaymentType').value;
      const paymentType = validPaymentTypes.includes(selectedPayment) ? selectedPayment : 'BILL';
      
      const orderData = {
        order_number: document.getElementById('importOrderNum').value || 'ORD-' + Date.now().toString().slice(-4),
        broker_name: document.getElementById('importBroker').value || null,
        vehicle_year: parseInt(document.getElementById('importYear').value) || new Date().getFullYear(),
        vehicle_make: document.getElementById('importMake').value || '',
        vehicle_model: document.getElementById('importModel').value || '',
        origin: document.getElementById('importOrigin').value || '',
        destination: document.getElementById('importDestination').value || '',
        pickup_phone: document.getElementById('importPickupPhone').value || null,
        delivery_phone: document.getElementById('importDeliveryPhone').value || null,
        pickup_date: document.getElementById('importPickupDate').value || null,
        dropoff_date: document.getElementById('importDeliveryDate').value || null,
        revenue: parseFloat(document.getElementById('importRevenue').value) || 0,
        payment_type: paymentType,
        broker_fee: parseFloat(document.getElementById('importBrokerFee').value) || 0,
        local_fee: parseFloat(document.getElementById('importLocalFee').value) || 0,
        dispatcher_notes: document.getElementById('importNotes').value || null,
        load_category: category,
        load_subcategory: subcategory,
        status: 'PENDING',
        trip_id: null,
        dispatcher_id: userDispatcher?.id || null
      };
      
      try {
        await dbInsert('orders', orderData);
        await logActivity('LOAD_IMPORTED', { order_number: orderData.order_number, category: category, vehicle: orderData.vehicle_year + ' ' + orderData.vehicle_make + ' ' + orderData.vehicle_model });
        document.querySelector('.modal-overlay').remove();
        showToast('âœ… Load imported to ' + loadBoardCategories.find(c => c.id === category)?.name + '!');
        await loadAllData();
        
        // Switch to the imported category
        selectedLoadCategory = category;
        selectedLoadSub = subcategory;
        renderLoadBoard(document.getElementById('main-content'));
      } catch (e) {
        showToast('Failed to import: ' + e.message, 'error');
      }
    }

    function openAssignToTrip(orderId) {
      const o = appData.orders.find(x => x.id === orderId);
      const isHomeToNY = o.load_category === 'home_to_ny';
      
      // Build direction options
      const directionOptions = vehicleDirections.map(d => 
        '<option value="' + d.id + '"' + (o.vehicle_direction === d.id ? ' selected' : '') + '>' + d.label + '</option>'
      ).join('');
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3>Assign Vehicle</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body">' +
        '<div style="background:#f1f5f9;padding:12px;border-radius:8px;margin-bottom:16px"><strong>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</strong><br><span style="color:#64748b">' + o.origin + ' â†’ ' + o.destination + '</span></div>' +
        
        // Assignment type tabs (only show for Home to NY)
        (isHomeToNY ? '<div style="display:flex;gap:8px;margin-bottom:16px">' +
        '<button id="assignTypeTrip" onclick="toggleAssignType(\'trip\')" style="flex:1;padding:12px;border:2px solid #3b82f6;background:#3b82f6;color:white;border-radius:8px;font-weight:600;cursor:pointer">ðŸš› Assign to Trip</button>' +
        '<button id="assignTypeLocal" onclick="toggleAssignType(\'local\')" style="flex:1;padding:12px;border:2px solid #8b5cf6;background:white;color:#8b5cf6;border-radius:8px;font-weight:600;cursor:pointer">ðŸš— Assign to Local Driver</button>' +
        '</div>' : '') +
        
        // Trip selection (shown by default)
        '<div id="tripAssignSection">' +
        // Direction selection (NEW)
        '<div class="form-group"><label>ðŸ§­ Vehicle Direction</label><select id="assignDirectionSelect" style="border-color:#f59e0b">' +
        '<option value="">-- Select Direction --</option>' + directionOptions + '</select>' +
        '<p style="font-size:11px;color:#64748b;margin-top:4px">Choose the route direction for this vehicle</p></div>' +
        // Trip selection
        '<div class="form-group"><label>Select Trip</label><select id="assignTripSelect"><option value="">Select a trip...</option>' + 
        appData.trips.filter(t => t.status !== 'COMPLETED').map(t => {
          const truck = appData.trucks.find(tr => tr.id === t.truck_id);
          const driver = appData.drivers.find(d => d.id === t.driver_id);
          const orderCount = appData.orders.filter(ord => ord.trip_id === t.id).length;
          return '<option value="' + t.id + '">' + t.trip_number + ' - ' + (truck ? 'Truck #' + truck.truck_number : 'No truck') + ' - ' + (driver ? driver.first_name : 'No driver') + ' (' + orderCount + ' cars)</option>';
        }).join('') + '</select></div>' +
        '</div>' +
        
        // Local Driver selection (hidden by default, only for Home to NY)
        (isHomeToNY ? '<div id="localAssignSection" style="display:none">' +
        '<div class="form-group"><label>Select Local Driver</label><select id="assignLocalSelect"><option value="">Select a local driver...</option>' + 
        (appData.local_drivers || []).map(ld => {
          const assignedCount = appData.orders.filter(ord => ord.local_driver_id === ld.id && !ord.trip_id).length;
          return '<option value="' + ld.id + '">' + ld.name + (ld.phone ? ' (' + ld.phone + ')' : '') + ' - ' + assignedCount + ' cars assigned</option>';
        }).join('') + '</select></div>' +
        '<div class="form-group"><label>Local Driver Fee $ <span style="color:#64748b;font-weight:normal">(optional)</span></label><input type="number" id="localDriverFee" value="' + (o.local_fee || 0) + '" placeholder="0"></div>' +
        '</div>' : '') +
        
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" id="assignBtn" onclick="assignOrderToTrip(' + orderId + ')">Assign to Trip</button></div></div>';
      document.body.appendChild(m);
    }
    
    let currentAssignType = 'trip';
    
    function toggleAssignType(type) {
      currentAssignType = type;
      const tripBtn = document.getElementById('assignTypeTrip');
      const localBtn = document.getElementById('assignTypeLocal');
      const tripSection = document.getElementById('tripAssignSection');
      const localSection = document.getElementById('localAssignSection');
      const assignBtn = document.getElementById('assignBtn');
      
      if (type === 'trip') {
        tripBtn.style.background = '#3b82f6';
        tripBtn.style.color = 'white';
        localBtn.style.background = 'white';
        localBtn.style.color = '#8b5cf6';
        tripSection.style.display = 'block';
        localSection.style.display = 'none';
        assignBtn.textContent = 'Assign to Trip';
        assignBtn.onclick = () => assignOrderToTrip(parseInt(assignBtn.closest('.modal').querySelector('[onclick*="assignOrderToTrip"]')?.getAttribute('onclick')?.match(/\d+/)?.[0]));
      } else {
        tripBtn.style.background = 'white';
        tripBtn.style.color = '#3b82f6';
        localBtn.style.background = '#8b5cf6';
        localBtn.style.color = 'white';
        tripSection.style.display = 'none';
        localSection.style.display = 'block';
        assignBtn.textContent = 'Assign to Local Driver';
      }
    }

    async function assignOrderToTrip(orderId) {
      if (currentAssignType === 'local') {
        // Assign to Local Driver
        const localDriverId = parseInt(document.getElementById('assignLocalSelect').value);
        const localFee = parseFloat(document.getElementById('localDriverFee').value) || 0;
        
        if (!localDriverId) { showToast('Please select a local driver', 'error'); return; }
        
        try {
          await dbUpdate('orders', orderId, { 
            local_driver_id: localDriverId, 
            local_fee: localFee,
            load_category: null, 
            load_subcategory: null 
          });
          document.querySelector('.modal-overlay').remove();
          showToast('Vehicle assigned to local driver!');
          await loadAllData(true);
          renderLoadBoard(document.getElementById('main-content'));
        } catch (e) { showToast(e.message, 'error'); }
      } else {
        // Assign to Trip (original behavior)
        const tripId = parseInt(document.getElementById('assignTripSelect').value);
        const direction = document.getElementById('assignDirectionSelect')?.value || null;
        
        if (!tripId) { showToast('Please select a trip', 'error'); return; }
        if (!direction) { showToast('Please select a vehicle direction', 'error'); return; }
        
        try {
          await dbUpdate('orders', orderId, { 
            trip_id: tripId, 
            vehicle_direction: direction,
            load_category: null, 
            load_subcategory: null, 
            local_driver_id: null 
          });
          document.querySelector('.modal-overlay').remove();
          showToast('Vehicle assigned to trip!');
          await loadAllData(true);
          renderLoadBoard(document.getElementById('main-content'));
        } catch (e) { showToast(e.message, 'error'); }
      }
      
      // Reset for next time
      currentAssignType = 'trip';
    }

    let selectedTruckTab = null;

    function renderTrips(c) {
      // Clear detail view flag when going back to trips list
      currentDetailView = null;
      
      // Get trucks that have trips or are active
      const trucksWithTrips = appData.trucks.filter(t => t.status === 'ACTIVE' || appData.trips.some(tr => tr.truck_id === t.id)).sort((a,b) => String(a.truck_number).localeCompare(String(b.truck_number)));
      
      // If no truck selected, select first one
      if (!selectedTruckTab && trucksWithTrips.length > 0) {
        selectedTruckTab = trucksWithTrips[0].id;
      }
      
      // Get trips for selected truck
      const truckTrips = selectedTruckTab ? appData.trips.filter(t => t.truck_id === selectedTruckTab).sort((a,b) => new Date(b.trip_date) - new Date(a.trip_date)) : [];
      const selectedTruck = appData.trucks.find(t => t.id === selectedTruckTab);
      
      // Build truck tabs
      const truckTabs = trucksWithTrips.map(t => {
        const tripCount = appData.trips.filter(tr => tr.truck_id === t.id).length;
        const isActive = t.id === selectedTruckTab;
        const inactiveBg = isDarkTheme ? '#1e293b' : 'white';
        const inactiveColor = isDarkTheme ? '#94a3b8' : '#475569';
        const inactiveBorder = isDarkTheme ? '#475569' : '#e2e8f0';
        const badgeBg = isActive ? 'rgba(255,255,255,0.2)' : (isDarkTheme ? '#334155' : '#e2e8f0');
        return '<button class="truck-tab" onclick="selectedTruckTab=' + t.id + ';renderTrips(document.getElementById(\'main-content\'))" style="padding:10px 16px;border:2px solid ' + (isActive ? '#1e40af' : inactiveBorder) + ';cursor:pointer;font-weight:600;border-radius:8px;margin:4px;transition:all 0.2s;background:' + (isActive ? '#1e40af' : inactiveBg) + ';color:' + (isActive ? 'white' : inactiveColor) + '">ðŸš› ' + t.truck_number + ' <span style="background:' + badgeBg + ';padding:2px 8px;border-radius:12px;font-size:12px;margin-left:4px">' + tripCount + '</span></button>';
      }).join('');
      
      // Build trip rows
      let tripRows = '';
      truckTrips.forEach(trip => {
        const orders = appData.orders.filter(o => o.trip_id === trip.id);
        const driver = appData.drivers.find(d => d.id === trip.driver_id);
        const driverName = driver ? driver.first_name + ' ' + driver.last_name : '-';
        const f = getTripFin(trip.id);
        const completeBtn = trip.status !== 'COMPLETED' ? '<button class="action-btn" style="background:#10b981;color:white" onclick="event.stopPropagation();markTripCompleted(' + trip.id + ',true)">âœ“</button>' : '';
        
        tripRows += '<tr><td><strong>' + trip.trip_number + '</strong></td><td>' + formatDate(trip.trip_date) + '</td><td>' + orders.length + '</td><td>' + driverName + '</td><td class="money">' + formatMoney(f.loadRevenue) + '</td><td><span class="badge ' + getBadge(trip.status) + '">' + trip.status + '</span></td><td class="sticky-col"><div class="actions">' + completeBtn + '<button class="action-btn view" onclick="viewTrip(' + trip.id + ')">View</button><button class="action-btn edit" onclick="openTripModal(' + trip.id + ')">Edit</button><button class="action-btn delete" onclick="deleteTrip(' + trip.id + ')">Del</button></div></td></tr>';
      });
      
      c.innerHTML = '<div class="header"><h2>ðŸš› Trips by Truck</h2><button class="btn btn-primary" onclick="openTripModal()">+ New Trip</button></div>' +
        '<div style="display:flex;flex-wrap:wrap;margin-bottom:16px">' + truckTabs + '</div>' +
        '<div class="card"><div style="padding:16px;background:#f8fafc;border-bottom:1px solid #e2e8f0"><div><strong style="font-size:18px">TRUCK ' + (selectedTruck ? selectedTruck.truck_number : '-') + '</strong><span style="color:#64748b;margin-left:12px">' + truckTrips.length + ' trips | Home: Fairless Hills, PA</span></div></div><div class="table-wrapper"><table><thead><tr><th>Trip #</th><th>Date</th><th>Cars</th><th>Driver</th><th>Revenue</th><th>Status</th><th class="sticky-col">Actions</th></tr></thead><tbody>' + 
        (tripRows || '<tr><td colspan="7" style="text-align:center;padding:40px">No trips for this truck yet</td></tr>') + 
        '</tbody></table></div></div>';
    }

    function openTripModal(id = null) {
      const t = id ? appData.trips.find(x => x.id === id) : null;
      // Track editing start time for conflict detection
      if (t) startEditing('trips', id, t.updated_at);
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) { clearEditing('trips', id); m.remove(); } };
      const today = new Date().toISOString().split('T')[0];
      const periodStart = t?.period_start_date || t?.trip_date || today;
      const periodEnd = t?.period_end_date || '';
      m.innerHTML = '<div class="modal"><div class="modal-header"><h3>' + (t ? 'Edit' : 'New') + ' Trip</h3><button class="modal-close" onclick="clearEditing(\'trips\',' + id + ');this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body"><div class="form-row"><div class="form-group"><label>Truck (select first)</label><select id="tripTruck" onchange="updateTripNumber(' + id + ')"><option value="">Select Truck</option>' + appData.trucks.filter(x => x.status === 'ACTIVE').map(x => '<option value="' + x.id + '" data-num="' + x.truck_number + '"' + (t?.truck_id === x.id ? ' selected' : '') + '>#' + x.truck_number + '</option>').join('') + '</select></div><div class="form-group"><label>Trip Number</label><input id="tripNumber" value="' + (t?.trip_number || '') + '" readonly style="background:#f1f5f9"></div></div><div class="form-row"><div class="form-group"><label>Date</label><input type="date" id="tripDate" value="' + (t?.trip_date || today) + '"></div><div class="form-group"><label>Status</label><select id="tripStatus"><option value="PLANNED"' + (t?.status === 'PLANNED' ? ' selected' : '') + '>Planned</option><option value="IN_PROGRESS"' + (t?.status === 'IN_PROGRESS' ? ' selected' : '') + '>In Progress</option><option value="COMPLETED"' + (t?.status === 'COMPLETED' ? ' selected' : '') + '>Completed</option></select></div></div><div class="form-row"><div class="form-group"><label>Driver</label><select id="tripDriver" onchange="updateDriverCut()"><option value="">Select</option>' + appData.drivers.filter(d => d.status === 'ACTIVE').map(d => '<option value="' + d.id + '" data-cut="' + (d.cut_percent || 32) + '"' + (t?.driver_id === d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('') + '</select></div><div class="form-group"><label>Driver Cut %</label><input type="number" id="tripCut" value="' + (t?.driver_cut_percent || 32) + '"></div></div><div style="border-top:1px solid #e2e8f0;margin:16px 0;padding-top:16px"><div style="font-weight:600;color:#475569;margin-bottom:12px">ðŸ“… Pay Period</div><div class="form-row"><div class="form-group"><label>Period Start</label><input type="date" id="tripPeriodStart" value="' + periodStart + '"></div><div class="form-group"><label>Period End</label><input type="date" id="tripPeriodEnd" value="' + periodEnd + '" placeholder="Set when completed"></div></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="clearEditing(\'trips\',' + id + ');this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveTrip(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
      if (!id && t === null) { document.getElementById('tripNumber').value = ''; }
      else if (t?.truck_id) { updateTripNumber(id); }
    }
    
    function updateDriverCut() {
      const driverSelect = document.getElementById('tripDriver');
      const cutInput = document.getElementById('tripCut');
      const selectedOption = driverSelect.options[driverSelect.selectedIndex];
      
      if (selectedOption && selectedOption.value) {
        const driverCut = selectedOption.getAttribute('data-cut');
        if (driverCut) {
          cutInput.value = driverCut;
        }
      }
    }

    function getNextTripNumberForTruck(truckId, excludeTripId = null) {
      const truck = appData.trucks.find(t => t.id === truckId);
      if (!truck) return '';
      const truckNum = truck.truck_number;
      const currentYear = new Date().getFullYear();
      
      // Find all trips for this truck in the current year and extract their sequence numbers
      const truckTrips = appData.trips.filter(t => t.truck_id === truckId && t.id !== excludeTripId);
      let maxSeq = 0;
      
      truckTrips.forEach(trip => {
        // Parse trip number like "TRIP 5 - 77 - 2025" to get sequence 5
        const match = trip.trip_number.match(/TRIP\s*(\d+)\s*-\s*(\d+)\s*-\s*(\d{4})/i);
        if (match) {
          const seq = parseInt(match[1]);
          const year = parseInt(match[3]);
          // Only count trips from current year
          if (year === currentYear && seq > maxSeq) maxSeq = seq;
        }
      });
      
      return 'TRIP ' + (maxSeq + 1) + ' - ' + truckNum + ' - ' + currentYear;
    }

    function updateTripNumber(editingTripId) {
      const truckSelect = document.getElementById('tripTruck');
      const tripNumberInput = document.getElementById('tripNumber');
      const truckId = parseInt(truckSelect.value);
      
      if (!truckId) {
        tripNumberInput.value = '';
        return;
      }
      
      // If editing existing trip with same truck, keep the number
      if (editingTripId) {
        const existingTrip = appData.trips.find(t => t.id === editingTripId);
        if (existingTrip && existingTrip.truck_id === truckId) {
          tripNumberInput.value = existingTrip.trip_number;
          return;
        }
      }
      
      tripNumberInput.value = getNextTripNumberForTruck(truckId, editingTripId);
    }

    async function saveTrip(id) {
      const truckId = parseInt(document.getElementById('tripTruck').value) || null;
      if (!truckId) { showToast('Please select a truck first', 'error'); return; }
      const periodStart = document.getElementById('tripPeriodStart').value || null;
      const periodEnd = document.getElementById('tripPeriodEnd').value || null;
      const newStatus = document.getElementById('tripStatus').value;
      const data = { trip_number: document.getElementById('tripNumber').value, trip_date: document.getElementById('tripDate').value, trip_type: 'STANDARD', status: newStatus, driver_id: parseInt(document.getElementById('tripDriver').value) || null, truck_id: truckId, driver_cut_percent: parseFloat(document.getElementById('tripCut').value) || 32, period_start_date: periodStart, period_end_date: periodEnd };
      try { 
        if (id) { 
          await dbUpdate('trips', id, data); 
          await logActivity('TRIP_UPDATED', { trip_id: id, trip_number: data.trip_number, truck_id: truckId, changes: data });
          showToast('Saved!');
        } else { 
          // For new trips, set period_start_date to today if not set
          if (!data.period_start_date) data.period_start_date = new Date().toISOString().split('T')[0];
          const newTrip = await dbInsert('trips', data); 
          await logActivity('TRIP_CREATED', { trip_id: newTrip.id, trip_number: data.trip_number, truck_id: truckId, data: data });
          showToast('Saved!');
        } 
        document.querySelector('.modal-overlay').remove(); await loadAllData(true); renderTrips(document.getElementById('main-content')); 
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteTrip(id) { 
      if (!confirm('Delete this trip?')) return; 
      const trip = appData.trips.find(t => t.id === id);
      await dbDelete('trips', id); 
      await logActivity('TRIP_DELETED', { trip_id: id, trip_number: trip?.trip_number });
      showToast('Deleted'); await loadAllData(true); renderTrips(document.getElementById('main-content')); 
    }

    // Vehicle directions for trips
    const vehicleDirections = [
      { id: 'HOME_TO_CA', label: 'HOME TO CA', color: '#22c55e' },
      { id: 'CA_TO_HOME', label: 'CA TO HOME', color: '#22c55e' },
      { id: 'HOME_TO_FL', label: 'HOME TO FL', color: '#3b82f6' },
      { id: 'FL_TO_HOME', label: 'FL TO HOME', color: '#3b82f6' },
      { id: 'FL_TO_CA', label: 'FL TO CA', color: '#f59e0b' },
      { id: 'CA_TO_FL', label: 'CA TO FL', color: '#f59e0b' }
    ];

    // Vehicle Years (1920 to current year + 1)
    const vehicleYears = [];
    for (let y = new Date().getFullYear() + 1; y >= 1920; y--) { vehicleYears.push(y); }
    
    // Vehicle Makes and Models (including classic/vintage from 1920s+)
    const vehicleMakes = {
      'Acura': ['ILX', 'Integra', 'MDX', 'NSX', 'RDX', 'RLX', 'TLX', 'TSX', 'ZDX', 'Legend', 'Vigor', 'CL', 'RL', 'RSX', 'SLX'],
      'Alfa Romeo': ['4C', 'Giulia', 'Stelvio', 'Tonale', 'Spider', 'GTV', '164', '156', '147', '159', 'Giulietta', 'MiTo', '8C Competizione', '33 Stradale', 'Montreal', '1750', '2000'],
      'AMC': ['Javelin', 'AMX', 'Gremlin', 'Pacer', 'Hornet', 'Matador', 'Ambassador', 'Rebel', 'Marlin', 'Rambler', 'Eagle'],
      'Aston Martin': ['DB11', 'DB12', 'DBX', 'DBS', 'Vantage', 'Vanquish', 'DB9', 'DB7', 'DB6', 'DB5', 'DB4', 'DB2', 'V8 Vantage', 'Virage', 'Lagonda', 'Rapide'],
      'Auburn': ['8-115', '851', '852', 'Speedster', '12-161', '8-100', 'Cabin Speedster', '120', '653'],
      'Audi': ['A3', 'A4', 'A5', 'A6', 'A7', 'A8', 'e-tron', 'e-tron GT', 'Q3', 'Q4', 'Q5', 'Q7', 'Q8', 'R8', 'RS3', 'RS5', 'RS6', 'RS7', 'S3', 'S4', 'S5', 'S6', 'S7', 'S8', 'SQ5', 'SQ7', 'SQ8', 'TT', '100', '200', '80', '90', '4000', '5000', 'Coupe GT', 'Quattro'],
      'Austin': ['Mini', 'Healey', 'A40', 'A30', 'A35', 'Cambridge', 'Westminster', 'Princess', 'Allegro', 'Maxi', 'Metro', '1100', '1300', '1800', 'Seven', 'Sheerline'],
      'Austin-Healey': ['100', '100-6', '3000', 'Sprite'],
      'Bentley': ['Bentayga', 'Continental GT', 'Flying Spur', 'Mulsanne', 'Arnage', 'Azure', 'Brooklands', 'Continental R', 'Continental T', 'Eight', 'Turbo R', 'Speed Six', 'Mark VI', 'R-Type', 'S1', 'S2', 'S3', 'T1', 'T2'],
      'BMW': ['2 Series', '3 Series', '4 Series', '5 Series', '6 Series', '7 Series', '8 Series', 'i3', 'i4', 'i5', 'i7', 'iX', 'M2', 'M3', 'M4', 'M5', 'M8', 'X1', 'X2', 'X3', 'X4', 'X5', 'X6', 'X7', 'XM', 'Z4', 'Z3', 'Z8', '1 Series', '2002', '1600', '1602', '3.0 CS', '3.0 CSL', '507', '503', '502', '501', '327', '328', '326', 'Isetta', 'M1', 'E9', 'E30', 'E36', 'E46', 'E39', 'E60'],
      'Buick': ['Enclave', 'Encore', 'Encore GX', 'Envision', 'LaCrosse', 'Regal', 'Century', 'LeSabre', 'Park Avenue', 'Riviera', 'Skylark', 'Electra', 'Wildcat', 'Roadmaster', 'Super', 'Special', 'Limited', 'Reatta', 'Grand National', 'GNX', 'GSX', 'Centurion'],
      'Cadillac': ['ATS', 'CT4', 'CT5', 'CT6', 'CTS', 'Escalade', 'Escalade ESV', 'Lyriq', 'XT4', 'XT5', 'XT6', 'DeVille', 'Eldorado', 'Fleetwood', 'Seville', 'Allante', 'Cimarron', 'Catera', 'XLR', 'STS', 'DTS', 'Series 62', 'Series 60', 'Series 61', 'Series 75', 'LaSalle', 'V-16', 'V-12', 'V-8'],
      'Chevrolet': ['Blazer', 'Bolt EUV', 'Bolt EV', 'Camaro', 'Colorado', 'Corvette', 'Equinox', 'Express', 'Impala', 'Malibu', 'Silverado 1500', 'Silverado 2500HD', 'Silverado 3500HD', 'Spark', 'Suburban', 'Tahoe', 'Trailblazer', 'Traverse', 'Trax', 'Chevelle', 'Nova', 'Monte Carlo', 'El Camino', 'Caprice', 'Bel Air', 'Biscayne', 'Nomad', 'Delray', 'Lumina', 'Celebrity', 'Cavalier', 'Beretta', 'Corsica', 'Citation', 'Monza', 'Vega', 'Chevette', 'Sprint', 'Spectrum', 'SSR', 'HHR', 'Cobalt', 'Cruze', 'Sonic', 'Aveo', 'Master', 'Standard Six', 'Confederate', 'Independence', 'Eagle', 'Mercury', 'Superior', 'Fleetline', 'Stylemaster', 'Special Deluxe', '150', '210', '3100', 'Apache', 'Task Force', 'C10', 'C20', 'K5', 'K10', 'S10', 'LUV', 'Astro', 'Venture', 'Uplander'],
      'Chrysler': ['300', 'Pacifica', 'Voyager', 'Town & Country', 'PT Cruiser', 'Sebring', 'Crossfire', 'LHS', 'Concorde', 'New Yorker', 'Fifth Avenue', 'Imperial', 'Newport', 'Cordoba', 'LeBaron', 'Laser', 'Conquest', 'TC by Maserati', 'Airflow', 'Airstream', 'Royal', 'Windsor', 'Saratoga', 'Crown Imperial', 'C-300', '300 Letter Series'],
      'Cord': ['L-29', '810', '812', 'Sportsman', 'Phaeton', 'Brougham', 'Sedan', 'Convertible'],
      'Datsun': ['240Z', '260Z', '280Z', '280ZX', '510', '610', '710', '810', '1200', '1600', 'B210', 'F10', '200SX', '310', 'Roadster', 'Fairlady', '411', '520', '521', '620', '720', 'Bluebird'],
      'DeLorean': ['DMC-12'],
      'DeSoto': ['Adventurer', 'Firesweep', 'Fireflite', 'Firedome', 'Powermaster', 'Deluxe', 'Custom', 'Airflow', 'Airstream', 'S-6', 'S-7', 'S-8', 'S-10', 'S-11'],
      'Dodge': ['Challenger', 'Charger', 'Durango', 'Grand Caravan', 'Hornet', 'Journey', 'Viper', 'Dart', 'Neon', 'Avenger', 'Intrepid', 'Stratus', 'Stealth', 'Daytona', 'Omni', 'Colt', 'Lancer', 'Mirada', 'Diplomat', 'Monaco', 'Polara', 'Coronet', 'Super Bee', 'Demon', 'Swinger', 'Custom 880', 'Aspen', 'St. Regis', 'Magnum', 'Spirit', 'Shadow', 'Dynasty', 'Aries', 'Caliber', 'Nitro', 'Ram', 'Dakota', 'Power Wagon', 'D100', 'D150', 'W100', 'W150', 'Ramcharger', 'Warlock', 'Li\'l Red Express'],
      'Duesenberg': ['Model J', 'Model SJ', 'Model X', 'Model A', 'SSJ', 'JN', 'Mormon Meteor'],
      'Edsel': ['Citation', 'Corsair', 'Pacer', 'Ranger', 'Bermuda', 'Roundup', 'Villager'],
      'Ferrari': ['296 GTB', '488', '812', 'F8', 'Portofino', 'Purosangue', 'Roma', 'SF90', '458', '488', 'California', 'LaFerrari', 'Enzo', 'F40', 'F50', 'Testarossa', '308', '328', '348', '355', '360', 'F430', '512', '550', '575', '599', '612', 'FF', 'GTC4Lusso', 'Mondial', '250', '275', '330', '365', 'Daytona', 'Dino', '166', '195', '212', '225', '250 GT', '250 GTO'],
      'Fiat': ['500', '500L', '500X', '124 Spider', 'Spider 2000', 'X1/9', '128', '131', '850', 'Strada', 'Brava', 'Punto', 'Panda', 'Uno', 'Tipo', 'Croma', 'Multipla', 'Stilo', 'Bravo', 'Linea', 'Doblo', 'Ducato', 'Topolino'],
      'Ford': ['Bronco', 'Bronco Sport', 'E-Series', 'EcoSport', 'Edge', 'Escape', 'Expedition', 'Explorer', 'F-150', 'F-150 Lightning', 'F-250', 'F-350', 'Fiesta', 'Flex', 'Focus', 'Fusion', 'Maverick', 'Mustang', 'Mustang Mach-E', 'Ranger', 'Taurus', 'Transit', 'Transit Connect', 'Thunderbird', 'Crown Victoria', 'LTD', 'Fairlane', 'Galaxie', 'Torino', 'Gran Torino', 'Pinto', 'Maverick', 'Granada', 'Elite', 'Tempo', 'Contour', 'Five Hundred', 'Freestyle', 'Probe', 'Festiva', 'Aspire', 'EXP', 'Escort', 'ZX2', 'Focus', 'C-Max', 'GT', 'GT40', 'Model T', 'Model A', 'Model B', 'Model 18', 'Model 40', 'Model 48', 'Model 68', 'Model 78', 'Model 81A', 'Deluxe', 'Super Deluxe', 'Custom', 'Customline', 'Mainline', 'Crestline', 'Sunliner', 'Skyliner', 'Starliner', 'Victoria', 'Ranchero', 'Falcon', 'Comet', 'Fairmont', 'Festiva', 'Courier', 'Club Wagon'],
      'Genesis': ['G70', 'G80', 'G90', 'GV60', 'GV70', 'GV80'],
      'GMC': ['Acadia', 'Canyon', 'Hummer EV', 'Sierra 1500', 'Sierra 2500HD', 'Sierra 3500HD', 'Terrain', 'Yukon', 'Yukon XL', 'Jimmy', 'Envoy', 'Safari', 'Sonoma', 'Syclone', 'Typhoon', 'C/K Series', 'S-15', 'Caballero', 'Sprint'],
      'Honda': ['Accord', 'Civic', 'CR-V', 'CR-Z', 'Fit', 'HR-V', 'Insight', 'Odyssey', 'Passport', 'Pilot', 'Prologue', 'Ridgeline', 'Prelude', 'CRX', 'del Sol', 'S2000', 'Element', 'Crosstour', 'FCX Clarity'],
      'Hudson': ['Hornet', 'Wasp', 'Jet', 'Commodore', 'Super Six', 'Pacemaker', 'Hollywood', 'Italia', 'Terraplane', 'Essex', 'Greater Eight', 'Eight', 'Six'],
      'Hummer': ['H1', 'H2', 'H3', 'H3T'],
      'Hyundai': ['Accent', 'Elantra', 'Ioniq', 'Ioniq 5', 'Ioniq 6', 'Kona', 'Nexo', 'Palisade', 'Santa Cruz', 'Santa Fe', 'Sonata', 'Tucson', 'Veloster', 'Venue', 'Genesis Coupe', 'Azera', 'Equus', 'XG350', 'Tiburon', 'Excel', 'Scoupe'],
      'Imperial': ['Crown', 'LeBaron', 'Custom', 'Southampton', 'Ghia'],
      'Infiniti': ['Q50', 'Q60', 'QX50', 'QX55', 'QX60', 'QX80', 'G35', 'G37', 'M35', 'M45', 'FX35', 'FX45', 'QX4', 'QX56', 'J30', 'I30', 'I35', 'Q45', 'EX35'],
      'International': ['Scout', 'Scout II', 'Travelall', 'Harvester'],
      'Isuzu': ['Trooper', 'Rodeo', 'Amigo', 'VehiCROSS', 'Axiom', 'Ascender', 'Hombre', 'i-Series', 'Impulse', 'Stylus', 'I-Mark'],
      'Jaguar': ['E-PACE', 'F-PACE', 'F-TYPE', 'I-PACE', 'XE', 'XF', 'XJ', 'XK', 'XKR', 'XJR', 'S-Type', 'X-Type', 'XJS', 'XJ6', 'XJ12', 'E-Type', 'D-Type', 'C-Type', 'Mark 2', 'Mark VII', 'Mark VIII', 'Mark IX', 'Mark X', 'XK120', 'XK140', 'XK150', 'SS100', 'SS1', 'SS Jaguar'],
      'Jeep': ['Cherokee', 'Compass', 'Gladiator', 'Grand Cherokee', 'Grand Cherokee L', 'Grand Wagoneer', 'Renegade', 'Wagoneer', 'Wrangler', 'Liberty', 'Commander', 'Patriot', 'Grand Wagoneer', 'Wagoneer', 'CJ-5', 'CJ-7', 'CJ-8', 'Willys', 'Jeepster', 'Commando', 'J-10', 'J-20', 'Honcho', 'Scrambler', 'Comanche'],
      'Kaiser': ['Manhattan', 'Carolina', 'Virginian', 'Dragon', 'Traveler', 'Special', 'Deluxe', 'Darrin'],
      'Kia': ['Carnival', 'EV6', 'EV9', 'Forte', 'K5', 'Niro', 'Rio', 'Seltos', 'Sorento', 'Soul', 'Sportage', 'Stinger', 'Telluride', 'Optima', 'Cadenza', 'K900', 'Amanti', 'Spectra', 'Sephia', 'Sedona', 'Borrego', 'Rondo'],
      'Lamborghini': ['Aventador', 'Huracan', 'Revuelto', 'Urus', 'Gallardo', 'Murcielago', 'Diablo', 'Countach', 'Miura', 'Espada', 'Jarama', 'Islero', 'Urraco', 'Silhouette', 'Jalpa', 'LM002', '350 GT', '400 GT'],
      'Land Rover': ['Defender', 'Discovery', 'Discovery Sport', 'Range Rover', 'Range Rover Evoque', 'Range Rover Sport', 'Range Rover Velar', 'Freelander', 'LR2', 'LR3', 'LR4', 'Series I', 'Series II', 'Series III'],
      'LaSalle': ['Series 303', 'Series 328', 'Series 340', 'Series 345', 'Series 350', 'Series 37-50', 'Series 38-50', 'Series 39-50', 'Series 40-50', 'Series 40-52'],
      'Lexus': ['ES', 'GS', 'GX', 'IS', 'LC', 'LS', 'LX', 'NX', 'RC', 'RX', 'RZ', 'TX', 'UX', 'CT', 'HS', 'LFA', 'SC'],
      'Lincoln': ['Aviator', 'Continental', 'Corsair', 'MKZ', 'Nautilus', 'Navigator', 'MKC', 'MKS', 'MKT', 'MKX', 'Town Car', 'LS', 'Mark VIII', 'Mark VII', 'Mark VI', 'Mark V', 'Mark IV', 'Mark III', 'Mark II', 'Continental Mark Series', 'Capri', 'Versailles', 'Premier', 'Blackwood', 'Zephyr', 'Cosmopolitan', 'Custom', 'K-Series'],
      'Lotus': ['Elise', 'Evora', 'Exige', 'Emira', 'Esprit', 'Europa', 'Elan', 'Elite', 'Eclat', 'Seven', 'Eleven', 'Carlton'],
      'Lucid': ['Air'],
      'Maserati': ['Ghibli', 'GranTurismo', 'Grecale', 'Levante', 'MC20', 'Quattroporte', 'GranCabrio', 'Coupe', 'Spyder', 'MC12', '3200 GT', 'Biturbo', 'Merak', 'Bora', 'Khamsin', 'Indy', 'Mexico', 'Mistral', 'Sebring', '3500 GT', '5000 GT', 'A6'],
      'Mazda': ['CX-3', 'CX-30', 'CX-5', 'CX-50', 'CX-9', 'CX-90', 'Mazda3', 'Mazda6', 'MX-30', 'MX-5 Miata', 'RX-7', 'RX-8', '323', '626', '929', 'Millenia', 'MPV', 'Tribute', 'CX-7', 'B-Series', 'Navajo', 'Protege', 'MX-3', 'MX-6', 'Cosmo'],
      'McLaren': ['720S', '750S', 'Artura', 'GT', '570S', '600LT', '650S', '675LT', '12C', 'P1', 'Senna', 'Speedtail', 'Elva', 'F1'],
      'Mercedes-Benz': ['A-Class', 'AMG GT', 'C-Class', 'CLA', 'CLS', 'E-Class', 'EQB', 'EQE', 'EQS', 'G-Class', 'GLA', 'GLB', 'GLC', 'GLE', 'GLS', 'Maybach', 'S-Class', 'SL', 'Sprinter', 'SLK', 'SLC', 'SLR McLaren', 'SLS AMG', 'CLK', 'ML', 'GL', 'GLK', 'R-Class', '190', '200', '220', '230', '240', '250', '260', '280', '300', '320', '350', '380', '400', '420', '450', '500', '560', '600', '107', '108', '109', '114', '115', '116', '123', '124', '126', '129', '140', '170', '180', '220 Ponton', '300 Adenauer', 'Gullwing', '300SL', '190SL', '230SL', '250SL', '280SL', '350SL', '450SL', '500SL', '560SL'],
      'Mercury': ['Grand Marquis', 'Cougar', 'Mountaineer', 'Mariner', 'Milan', 'Marauder', 'Sable', 'Tracer', 'Mystique', 'Villager', 'Monterey', 'Colony Park', 'Marquis', 'Montego', 'Comet', 'Capri', 'Bobcat', 'Lynx', 'Topaz', 'Zephyr', 'Monarch', 'Cyclone', 'Park Lane', 'Breezeway', 'Eight', 'Custom'],
      'MG': ['MGA', 'MGB', 'MGB GT', 'MGC', 'Midget', 'TD', 'TF', 'TC', 'TA', 'TB', 'PA', 'PB', 'J2', 'K3', 'Magnette', 'ZA', 'ZB'],
      'Mini': ['Clubman', 'Convertible', 'Cooper', 'Countryman', 'Hardtop', 'Paceman', 'Roadster', 'Coupe', 'Classic Mini'],
      'Mitsubishi': ['Eclipse Cross', 'Mirage', 'Outlander', 'Outlander Sport', 'Eclipse', 'Galant', 'Lancer', 'Diamante', 'Montero', '3000GT', 'Starion', 'Cordia', 'Tredia', 'Sigma', 'Expo', 'Precis', 'Mighty Max', 'Raider', 'Endeavor', 'i-MiEV'],
      'Nash': ['Ambassador', 'Statesman', 'Rambler', 'Metropolitan', 'Airflyte', '600', 'Lafayette', 'Advanced Six', 'Special Six', 'Standard Six', 'Big Six', 'Eight', 'Twin Ignition Six'],
      'Nissan': ['370Z', 'Altima', 'Armada', 'Ariya', 'Frontier', 'GT-R', 'Kicks', 'Leaf', 'Maxima', 'Murano', 'Pathfinder', 'Rogue', 'Sentra', 'Titan', 'Versa', 'Z', '300ZX', '350Z', '240SX', 'Silvia', 'Pulsar', 'NX', 'Stanza', '200SX', 'Axxess', 'Quest', 'Xterra', 'Juke', 'Cube'],
      'Oldsmobile': ['Cutlass', '442', 'Toronado', '98', '88', 'Delta 88', 'Ninety-Eight', 'Starfire', 'F-85', 'Vista Cruiser', 'Custom Cruiser', 'Omega', 'Firenza', 'Calais', 'Achieva', 'Alero', 'Aurora', 'Intrigue', 'Bravada', 'Silhouette', 'Curved Dash', 'Six', 'Eight', 'Rocket'],
      'Opel': ['GT', 'Kadett', 'Manta', 'Ascona', 'Rekord', 'Commodore', 'Admiral', 'Diplomat', 'KapitÃ¤n'],
      'Packard': ['Clipper', 'Caribbean', 'Patrician', 'Cavalier', '400', 'Hawk', 'Super Eight', 'One-Twenty', 'One-Ten', 'Twelve', 'Standard Eight', 'Custom Eight', 'Deluxe Eight', 'Senior', 'Light Eight', 'Single Six', 'Twin Six'],
      'Pierce-Arrow': ['Series 80', 'Series 81', 'Series 836', 'Series 1240', 'Series 1245', 'Model 48', 'Model 66', 'Model 38', 'Model 36', 'Model 33'],
      'Plymouth': ['Barracuda', 'Road Runner', 'GTX', 'Satellite', 'Belvedere', 'Fury', 'Valiant', 'Duster', 'Cuda', 'Superbird', 'Prowler', 'Neon', 'Breeze', 'Acclaim', 'Sundance', 'Laser', 'Horizon', 'TC3', 'Sapporo', 'Champ', 'Turismo', 'Reliant', 'Caravelle', 'Gran Fury', 'Volare', 'Trail Duster', 'Voyager', 'Colt', 'Cricket', 'Arrow', 'Scamp', 'Special Deluxe', 'Deluxe', 'Cranbrook', 'Cambridge', 'Savoy', 'Plaza', 'Sport Fury', 'Suburban'],
      'Polestar': ['1', '2', '3'],
      'Pontiac': ['GTO', 'Firebird', 'Trans Am', 'Grand Prix', 'Bonneville', 'Catalina', 'LeMans', 'Tempest', 'Grand Am', 'Sunfire', 'Sunbird', 'Fiero', 'Grand Safari', '6000', 'Phoenix', 'J2000', 'Solstice', 'G8', 'G6', 'G5', 'G3', 'Vibe', 'Torrent', 'Montana', 'Aztek', 'Star Chief', 'Chieftain', 'Streamliner', 'Torpedo', 'Executive', 'Ventura', 'Astre'],
      'Porsche': ['718 Boxster', '718 Cayman', '911', 'Cayenne', 'Macan', 'Panamera', 'Taycan', '928', '944', '968', '924', '914', '912', '356', '550 Spyder', '959', 'Carrera GT', '918 Spyder', 'Boxster', 'Cayman'],
      'Ram': ['1500', '2500', '3500', 'ProMaster', 'ProMaster City'],
      'Renault': ['Alliance', 'Encore', 'Fuego', 'Le Car', 'Medallion', 'Premier', 'Dauphine', 'Caravelle', 'Gordini', 'R5 Turbo', 'R8', 'R10', 'R12', 'R15', 'R16', 'R17', 'R18'],
      'REO': ['Flying Cloud', 'Royale', 'Wolverine', 'Speed Wagon', 'Six', 'Eight', 'Gold Comet'],
      'Rivian': ['R1S', 'R1T'],
      'Rolls-Royce': ['Cullinan', 'Dawn', 'Ghost', 'Phantom', 'Spectre', 'Wraith', 'Silver Shadow', 'Silver Spirit', 'Silver Spur', 'Silver Seraph', 'Corniche', 'Camargue', 'Silver Cloud', 'Silver Dawn', 'Silver Wraith', 'Phantom I', 'Phantom II', 'Phantom III', 'Phantom IV', 'Phantom V', 'Phantom VI', 'Twenty', 'Springfield', 'Park Ward'],
      'Saab': ['900', '9000', '9-3', '9-5', '9-7X', '9-2X', '92', '93', '95', '96', '97', '99', 'Sonett'],
      'Saturn': ['S-Series', 'L-Series', 'Ion', 'Vue', 'Relay', 'Sky', 'Aura', 'Outlook', 'SC', 'SL', 'SW'],
      'Scion': ['tC', 'xA', 'xB', 'xD', 'FR-S', 'iA', 'iM', 'iQ'],
      'Shelby': ['GT350', 'GT500', 'GT40', 'Cobra', 'Series 1', 'Daytona Coupe'],
      'Studebaker': ['Avanti', 'Hawk', 'Lark', 'Champion', 'Commander', 'President', 'Dictator', 'Land Cruiser', 'Starlight', 'Starliner', 'Golden Hawk', 'Sky Hawk', 'Power Hawk', 'Flight Hawk', 'Silver Hawk', 'Gran Turismo Hawk', 'Champ', 'Transtar', 'Scotsman', 'Wagonaire'],
      'Subaru': ['Ascent', 'BRZ', 'Crosstrek', 'Forester', 'Impreza', 'Legacy', 'Outback', 'Solterra', 'WRX', 'STI', 'SVX', 'Baja', 'Tribeca', 'XT', 'GL', 'DL', 'Justy', 'Loyale', '360', 'Leone', 'BRAT'],
      'Sunbeam': ['Tiger', 'Alpine', 'Rapier', 'Imp', 'Talbot', 'Avenger'],
      'Tesla': ['Cybertruck', 'Model 3', 'Model S', 'Model X', 'Model Y', 'Roadster'],
      'Toyota': ['4Runner', '86', 'Avalon', 'bZ4X', 'Camry', 'C-HR', 'Corolla', 'Corolla Cross', 'Crown', 'GR Supra', 'Grand Highlander', 'Highlander', 'Land Cruiser', 'Mirai', 'Prius', 'RAV4', 'Sequoia', 'Sienna', 'Tacoma', 'Tundra', 'Venza', 'Supra', 'MR2', 'Celica', 'Matrix', 'Yaris', 'Echo', 'Tercel', 'Paseo', 'Cressida', 'Corona', 'Starlet', 'Previa', 'Van', 'T100', 'Pickup', 'FJ Cruiser', 'Solara', 'Avalon', '2000GT'],
      'Triumph': ['TR2', 'TR3', 'TR4', 'TR5', 'TR6', 'TR7', 'TR8', 'Spitfire', 'GT6', 'Stag', 'Herald', 'Vitesse', 'Dolomite', '2000', '2500', '1800', 'Acclaim'],
      'Tucker': ['48'],
      'Volkswagen': ['Arteon', 'Atlas', 'Atlas Cross Sport', 'Beetle', 'Golf', 'GTI', 'ID.4', 'Jetta', 'Passat', 'Taos', 'Tiguan', 'CC', 'Eos', 'Touareg', 'Routan', 'Rabbit', 'Fox', 'Corrado', 'Scirocco', 'Cabriolet', 'Karmann Ghia', 'Thing', 'Bus', 'Van', 'Type 1', 'Type 2', 'Type 3', 'Type 4', 'Squareback', 'Fastback', 'Dasher', 'Quantum', 'Super Beetle', 'Phaeton'],
      'Volvo': ['C40', 'S60', 'S90', 'V60', 'V90', 'XC40', 'XC60', 'XC90', 'C30', 'C70', 'S40', 'S70', 'S80', 'V40', 'V50', 'V70', 'XC70', '240', '260', '740', '760', '780', '850', '940', '960', '1800', 'P1800', 'Amazon', 'PV444', 'PV544', 'PV', '120', '140', '164', '240 Turbo', 'Bertone Coupe'],
      'Willys': ['Jeep', 'Jeepster', 'Station Wagon', 'Pickup', 'Panel', 'Knight', 'Whippet', 'Overland', 'Americar']
    };
    
    // Build flat list of all vehicle makes and models for autocomplete
    const allVehiclesFlat = [];
    Object.keys(vehicleMakes).forEach(make => {
      allVehiclesFlat.push(make); // Add make by itself
      vehicleMakes[make].forEach(model => {
        allVehiclesFlat.push(make + ' ' + model);
      });
    });
    allVehiclesFlat.sort();
    
    function setupVehicleAutocomplete(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      
      let dropdown = document.getElementById(inputId + '-dropdown');
      if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = inputId + '-dropdown';
        const dropBg = isDarkTheme ? '#1e293b' : 'white';
        const dropBorder = isDarkTheme ? '#475569' : '#d1d5db';
        dropdown.style.cssText = 'position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:' + dropBg + ';border:1px solid ' + dropBorder + ';border-top:none;border-radius:0 0 8px 8px;z-index:1000;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.1)';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(dropdown);
      }
      
      input.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        if (val.length < 1) {
          dropdown.style.display = 'none';
          return;
        }
        
        const matches = allVehiclesFlat.filter(v => v.toLowerCase().includes(val)).slice(0, 20);
        
        if (matches.length === 0) {
          dropdown.style.display = 'none';
          return;
        }
        
        dropdown.innerHTML = matches.map(m => {
          const highlighted = m.replace(new RegExp('(' + val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi'), '<strong>$1</strong>');
          return '<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9;font-size:14px" onmouseover="this.style.background=\'#f1f5f9\'" onmouseout="this.style.background=\'white\'" onclick="selectVehicle(\'' + inputId + '\', \'' + m.replace(/'/g, "\\'") + '\')">' + highlighted + '</div>';
        }).join('');
        dropdown.style.display = 'block';
      });
      
      input.addEventListener('blur', function() {
        setTimeout(() => { dropdown.style.display = 'none'; }, 200);
      });
      
      input.addEventListener('focus', function() {
        if (this.value.length >= 1) {
          this.dispatchEvent(new Event('input'));
        }
      });
    }
    
    function selectVehicle(inputId, value) {
      document.getElementById(inputId).value = value;
      document.getElementById(inputId + '-dropdown').style.display = 'none';
    }
    
    // US States
    const usStates = [
      { abbr: 'AL', name: 'Alabama' }, { abbr: 'AK', name: 'Alaska' }, { abbr: 'AZ', name: 'Arizona' },
      { abbr: 'AR', name: 'Arkansas' }, { abbr: 'CA', name: 'California' }, { abbr: 'CO', name: 'Colorado' },
      { abbr: 'CT', name: 'Connecticut' }, { abbr: 'DE', name: 'Delaware' }, { abbr: 'FL', name: 'Florida' },
      { abbr: 'GA', name: 'Georgia' }, { abbr: 'HI', name: 'Hawaii' }, { abbr: 'ID', name: 'Idaho' },
      { abbr: 'IL', name: 'Illinois' }, { abbr: 'IN', name: 'Indiana' }, { abbr: 'IA', name: 'Iowa' },
      { abbr: 'KS', name: 'Kansas' }, { abbr: 'KY', name: 'Kentucky' }, { abbr: 'LA', name: 'Louisiana' },
      { abbr: 'ME', name: 'Maine' }, { abbr: 'MD', name: 'Maryland' }, { abbr: 'MA', name: 'Massachusetts' },
      { abbr: 'MI', name: 'Michigan' }, { abbr: 'MN', name: 'Minnesota' }, { abbr: 'MS', name: 'Mississippi' },
      { abbr: 'MO', name: 'Missouri' }, { abbr: 'MT', name: 'Montana' }, { abbr: 'NE', name: 'Nebraska' },
      { abbr: 'NV', name: 'Nevada' }, { abbr: 'NH', name: 'New Hampshire' }, { abbr: 'NJ', name: 'New Jersey' },
      { abbr: 'NM', name: 'New Mexico' }, { abbr: 'NY', name: 'New York' }, { abbr: 'NC', name: 'North Carolina' },
      { abbr: 'ND', name: 'North Dakota' }, { abbr: 'OH', name: 'Ohio' }, { abbr: 'OK', name: 'Oklahoma' },
      { abbr: 'OR', name: 'Oregon' }, { abbr: 'PA', name: 'Pennsylvania' }, { abbr: 'RI', name: 'Rhode Island' },
      { abbr: 'SC', name: 'South Carolina' }, { abbr: 'SD', name: 'South Dakota' }, { abbr: 'TN', name: 'Tennessee' },
      { abbr: 'TX', name: 'Texas' }, { abbr: 'UT', name: 'Utah' }, { abbr: 'VT', name: 'Vermont' },
      { abbr: 'VA', name: 'Virginia' }, { abbr: 'WA', name: 'Washington' }, { abbr: 'WV', name: 'West Virginia' },
      { abbr: 'WI', name: 'Wisconsin' }, { abbr: 'WY', name: 'Wyoming' }, { abbr: 'DC', name: 'Washington DC' }
    ];
    
    // Major US Cities by State (most common for auto transport)
    const usCities = {
      'AL': ['Birmingham', 'Montgomery', 'Mobile', 'Huntsville', 'Tuscaloosa'],
      'AK': ['Anchorage', 'Fairbanks', 'Juneau'],
      'AZ': ['Phoenix', 'Tucson', 'Mesa', 'Scottsdale', 'Chandler', 'Gilbert', 'Tempe', 'Glendale', 'Peoria'],
      'AR': ['Little Rock', 'Fort Smith', 'Fayetteville', 'Springdale'],
      'CA': ['Los Angeles', 'San Diego', 'San Jose', 'San Francisco', 'Fresno', 'Sacramento', 'Long Beach', 'Oakland', 'Bakersfield', 'Anaheim', 'Santa Ana', 'Riverside', 'Stockton', 'Irvine', 'Chula Vista', 'Fremont', 'San Bernardino', 'Modesto', 'Fontana', 'Moreno Valley', 'Glendale', 'Huntington Beach', 'Santa Clarita', 'Garden Grove', 'Oceanside', 'Rancho Cucamonga', 'Ontario', 'Santa Rosa', 'Elk Grove', 'Corona', 'Lancaster', 'Palmdale', 'Salinas', 'Pomona', 'Hayward', 'Escondido', 'Sunnyvale', 'Torrance', 'Pasadena', 'Orange', 'Fullerton', 'Thousand Oaks', 'Roseville', 'Concord', 'Simi Valley', 'Santa Clara', 'Victorville', 'Vallejo', 'Berkeley', 'El Monte', 'Downey', 'Costa Mesa', 'Inglewood', 'Carlsbad', 'Fairfield', 'Ventura', 'Temecula', 'Antioch', 'Murrieta', 'Richmond', 'Norwalk', 'Burbank', 'El Cajon', 'Daly City', 'Rialto', 'West Covina', 'Clovis', 'Compton', 'Jurupa Valley', 'Vista', 'South Gate', 'Mission Viejo', 'Vacaville', 'Carson', 'Hesperia', 'Santa Maria', 'Redding', 'Westminster', 'Santa Monica', 'Chico', 'Newport Beach', 'San Leandro', 'San Marcos', 'Whittier', 'Hawthorne', 'Citrus Heights', 'Alhambra', 'Tracy', 'Livermore', 'Buena Park', 'Menifee', 'Hemet', 'Lakewood', 'Merced', 'Chino', 'Indio', 'Redwood City', 'Lake Forest', 'Napa', 'Tustin', 'Bellflower', 'Mountain View', 'Chino Hills', 'Baldwin Park', 'Alameda', 'Upland', 'San Ramon', 'Folsom', 'Pleasanton', 'Lynwood', 'Union City', 'Apple Valley', 'Redlands', 'Turlock', 'Perris', 'Manteca', 'Milpitas', 'Redondo Beach', 'Davis'],
      'CO': ['Denver', 'Colorado Springs', 'Aurora', 'Fort Collins', 'Lakewood', 'Thornton', 'Arvada', 'Westminster', 'Pueblo', 'Boulder'],
      'CT': ['Bridgeport', 'New Haven', 'Stamford', 'Hartford', 'Waterbury', 'Norwalk', 'Danbury'],
      'DE': ['Wilmington', 'Dover', 'Newark'],
      'FL': ['Jacksonville', 'Miami', 'Tampa', 'Orlando', 'St. Petersburg', 'Hialeah', 'Port St. Lucie', 'Cape Coral', 'Tallahassee', 'Fort Lauderdale', 'Pembroke Pines', 'Hollywood', 'Gainesville', 'Miramar', 'Coral Springs', 'Palm Bay', 'West Palm Beach', 'Clearwater', 'Lakeland', 'Pompano Beach', 'Davie', 'Miami Gardens', 'Sunrise', 'Boca Raton', 'Deltona', 'Plantation', 'Fort Myers', 'Palm Coast', 'Deerfield Beach', 'Melbourne', 'Boynton Beach', 'Lauderhill', 'Weston', 'Kissimmee', 'Homestead', 'Delray Beach', 'Tamarac', 'Daytona Beach', 'Wellington', 'North Port', 'Jupiter', 'Ocala', 'Port Orange', 'Margate', 'Coconut Creek', 'Sanford', 'Sarasota', 'Pensacola', 'Bradenton', 'Palm Beach Gardens', 'Pinellas Park', 'Coral Gables', 'Doral', 'Bonita Springs', 'Apopka', 'Titusville', 'North Miami', 'Oakland Park', 'Fort Pierce', 'North Miami Beach', 'North Lauderdale', 'Cutler Bay', 'Altamonte Springs', 'St. Cloud', 'Greenacres', 'Ormond Beach', 'Ocoee', 'Hallandale Beach', 'Winter Garden', 'Aventura'],
      'GA': ['Atlanta', 'Augusta', 'Columbus', 'Macon', 'Savannah', 'Athens', 'Sandy Springs', 'Roswell', 'Johns Creek', 'Albany', 'Warner Robins', 'Alpharetta', 'Marietta', 'Valdosta', 'Smyrna', 'Dunwoody'],
      'HI': ['Honolulu', 'Pearl City', 'Hilo', 'Kailua', 'Waipahu'],
      'ID': ['Boise', 'Meridian', 'Nampa', 'Idaho Falls', 'Pocatello'],
      'IL': ['Chicago', 'Aurora', 'Rockford', 'Joliet', 'Naperville', 'Springfield', 'Peoria', 'Elgin', 'Waukegan', 'Champaign', 'Bloomington', 'Decatur', 'Evanston', 'Schaumburg', 'Bolingbrook', 'Palatine', 'Skokie', 'Des Plaines', 'Orland Park', 'Tinley Park', 'Oak Lawn', 'Berwyn', 'Mount Prospect', 'Normal', 'Wheaton', 'Hoffman Estates', 'Oak Park', 'Downers Grove', 'Elmhurst', 'Glenview', 'DeKalb', 'Lombard', 'Belleville', 'Moline', 'Buffalo Grove', 'Bartlett', 'Urbana', 'Crystal Lake', 'Quincy', 'Streamwood', 'Carol Stream', 'Romeoville', 'Plainfield', 'Hanover Park', 'Carpentersville', 'Wheeling', 'Park Ridge', 'Addison', 'Calumet City'],
      'IN': ['Indianapolis', 'Fort Wayne', 'Evansville', 'South Bend', 'Carmel', 'Fishers', 'Bloomington', 'Hammond', 'Gary', 'Lafayette', 'Muncie', 'Terre Haute', 'Kokomo', 'Noblesville', 'Anderson', 'Greenwood', 'Elkhart', 'Mishawaka', 'Lawrence', 'Jeffersonville', 'Columbus', 'Portage'],
      'IA': ['Des Moines', 'Cedar Rapids', 'Davenport', 'Sioux City', 'Iowa City', 'Waterloo', 'Ames', 'West Des Moines', 'Council Bluffs', 'Ankeny', 'Dubuque', 'Urbandale', 'Cedar Falls'],
      'KS': ['Wichita', 'Overland Park', 'Kansas City', 'Olathe', 'Topeka', 'Lawrence', 'Shawnee', 'Manhattan', 'Lenexa', 'Salina', 'Hutchinson'],
      'KY': ['Louisville', 'Lexington', 'Bowling Green', 'Owensboro', 'Covington', 'Richmond', 'Georgetown', 'Florence', 'Hopkinsville', 'Nicholasville', 'Elizabethtown'],
      'LA': ['New Orleans', 'Baton Rouge', 'Shreveport', 'Lafayette', 'Lake Charles', 'Kenner', 'Bossier City', 'Monroe', 'Alexandria'],
      'ME': ['Portland', 'Lewiston', 'Bangor', 'South Portland', 'Auburn'],
      'MD': ['Baltimore', 'Frederick', 'Rockville', 'Gaithersburg', 'Bowie', 'Hagerstown', 'Annapolis', 'College Park', 'Salisbury', 'Laurel'],
      'MA': ['Boston', 'Worcester', 'Springfield', 'Lowell', 'Cambridge', 'New Bedford', 'Brockton', 'Quincy', 'Lynn', 'Fall River', 'Newton', 'Lawrence', 'Somerville', 'Framingham', 'Haverhill', 'Waltham', 'Malden', 'Brookline', 'Plymouth', 'Medford', 'Taunton', 'Chicopee', 'Weymouth', 'Revere', 'Peabody'],
      'MI': ['Detroit', 'Grand Rapids', 'Warren', 'Sterling Heights', 'Ann Arbor', 'Lansing', 'Flint', 'Dearborn', 'Livonia', 'Troy', 'Westland', 'Farmington Hills', 'Kalamazoo', 'Wyoming', 'Southfield', 'Rochester Hills', 'Taylor', 'Pontiac', 'St. Clair Shores', 'Royal Oak', 'Novi', 'Dearborn Heights', 'Battle Creek', 'Saginaw', 'Kentwood', 'East Lansing', 'Roseville', 'Portage', 'Midland', 'Lincoln Park'],
      'MN': ['Minneapolis', 'St. Paul', 'Rochester', 'Duluth', 'Bloomington', 'Brooklyn Park', 'Plymouth', 'St. Cloud', 'Eagan', 'Woodbury', 'Maple Grove', 'Eden Prairie', 'Coon Rapids', 'Burnsville', 'Blaine', 'Lakeville', 'Minnetonka', 'Apple Valley', 'Edina', 'St. Louis Park', 'Mankato', 'Maplewood', 'Moorhead', 'Shakopee'],
      'MS': ['Jackson', 'Gulfport', 'Southaven', 'Hattiesburg', 'Biloxi', 'Meridian', 'Tupelo', 'Greenville', 'Olive Branch', 'Horn Lake'],
      'MO': ['Kansas City', 'St. Louis', 'Springfield', 'Independence', 'Columbia', "Lee's Summit", "O'Fallon", 'St. Joseph', 'St. Charles', 'St. Peters', 'Blue Springs', 'Florissant', 'Joplin', 'Chesterfield', 'Jefferson City', 'Cape Girardeau'],
      'MT': ['Billings', 'Missoula', 'Great Falls', 'Bozeman', 'Butte', 'Helena'],
      'NE': ['Omaha', 'Lincoln', 'Bellevue', 'Grand Island', 'Kearney', 'Fremont', 'Hastings', 'Norfolk', 'North Platte', 'Papillion'],
      'NV': ['Las Vegas', 'Henderson', 'Reno', 'North Las Vegas', 'Sparks', 'Carson City', 'Fernley', 'Elko', 'Mesquite', 'Boulder City'],
      'NH': ['Manchester', 'Nashua', 'Concord', 'Derry', 'Dover', 'Rochester', 'Salem', 'Merrimack', 'Hudson', 'Londonderry'],
      'NJ': ['Newark', 'Jersey City', 'Paterson', 'Elizabeth', 'Edison', 'Woodbridge', 'Lakewood', 'Toms River', 'Hamilton', 'Trenton', 'Clifton', 'Camden', 'Brick', 'Cherry Hill', 'Passaic', 'Middletown', 'Union City', 'Old Bridge', 'Gloucester', 'East Orange', 'Bayonne', 'Franklin', 'North Bergen', 'Vineland', 'Union', 'Piscataway', 'New Brunswick', 'Jackson', 'Wayne', 'Irvington', 'Parsippany', 'Howell', 'Perth Amboy', 'Hoboken', 'Plainfield', 'West New York', 'Washington', 'East Brunswick', 'Bloomfield', 'West Orange', 'Evesham', 'Bridgewater', 'South Brunswick', 'Egg Harbor', 'Manchester', 'Hackensack', 'Sayreville', 'Mount Laurel', 'Berkeley', 'North Brunswick', 'Kearny', 'Linden', 'Marlboro', 'Teaneck', 'Atlantic City', 'Secaucus', 'Monroe', 'Rahway', 'Bergenfield', 'Paramus', 'Livingston', 'Nutley', 'Fort Lee', 'Englewood', 'Garfield', 'Lodi', 'Orange', 'Belleville', 'Fair Lawn', 'Long Branch', 'Westfield', 'Millville', 'Montclair', 'Summit', 'Maplewood', 'South Orange', 'Morristown', 'Red Bank', 'Princeton', 'Freehold', 'Asbury Park', 'Point Pleasant', 'Somerville', 'Metuchen', 'Cranford', 'Hillside', 'Roselle', 'Clark', 'Scotch Plains', 'Fanwood'],
      'NM': ['Albuquerque', 'Las Cruces', 'Rio Rancho', 'Santa Fe', 'Roswell', 'Farmington', 'Clovis'],
      'NY': ['New York', 'Buffalo', 'Rochester', 'Yonkers', 'Syracuse', 'Albany', 'New Rochelle', 'Mount Vernon', 'Schenectady', 'Utica', 'White Plains', 'Hempstead', 'Troy', 'Niagara Falls', 'Binghamton', 'Freeport', 'Valley Stream', 'Long Beach', 'Spring Valley', 'Rome', 'Ithaca', 'Poughkeepsie', 'Elmira', 'Lindenhurst', 'Auburn', 'Watertown', 'Glen Cove', 'Saratoga Springs', 'Jamestown', 'Harrison', 'Ossining', 'Peekskill', 'Kingston', 'Middletown', 'Newburgh', 'Port Chester', 'Mamaroneck', 'Rye', 'Larchmont', 'Tarrytown', 'Sleepy Hollow', 'Dobbs Ferry', 'Eastchester', 'Scarsdale', 'Bronxville', 'Pelham', 'Tuckahoe', 'Croton-on-Hudson', 'Pleasantville', 'Chappaqua', 'Bedford', 'Katonah', 'Armonk', 'Mount Kisco', 'Yorktown Heights', 'Carmel', 'Brewster', 'Mahopac', 'Cortlandt', 'Verplanck', 'Buchanan', 'Haverstraw', 'Nyack', 'Pearl River', 'Nanuet', 'Suffern', 'Monsey', 'New City', 'Stony Point', 'West Haverstraw', 'Congers', 'Valley Cottage', 'Orangeburg', 'Blauvelt', 'Tappan', 'Piermont', 'Brooklyn', 'Queens', 'Bronx', 'Staten Island', 'Manhattan', 'Astoria', 'Flushing', 'Jamaica', 'Bayside', 'Forest Hills', 'Woodside', 'Jackson Heights', 'Corona', 'Elmhurst', 'Rego Park', 'Ridgewood', 'Fresh Meadows', 'Whitestone', 'College Point', 'Little Neck', 'Douglaston', 'Hollis', 'St. Albans', 'Cambria Heights', 'Springfield Gardens', 'Laurelton', 'Rosedale', 'Far Rockaway', 'Rockaway Beach', 'Howard Beach', 'Ozone Park', 'Richmond Hill', 'South Ozone Park', 'Woodhaven', 'Kew Gardens', 'Long Island City', 'Sunnyside', 'Maspeth', 'Middle Village', 'Glendale', 'Bay Ridge', 'Bensonhurst', 'Borough Park', 'Flatbush', 'Flatlands', 'Canarsie', 'East New York', 'Brownsville', 'Bushwick', 'Williamsburg', 'Greenpoint', 'Bedford-Stuyvesant', 'Crown Heights', 'Park Slope', 'Cobble Hill', 'Brooklyn Heights', 'DUMBO', 'Red Hook', 'Sunset Park', 'Dyker Heights', 'Gravesend', 'Sheepshead Bay', 'Brighton Beach', 'Coney Island', 'Marine Park', 'Mill Basin', 'Garden City', 'Mineola', 'Westbury', 'Carle Place', 'Hicksville', 'Jericho', 'Syosset', 'Oyster Bay', 'Plainview', 'Woodbury', 'Melville', 'Huntington', 'Huntington Station', 'Cold Spring Harbor', 'Northport', 'Commack', 'Kings Park', 'Smithtown', 'St. James', 'Setauket', 'Port Jefferson', 'Mount Sinai', 'Miller Place', 'Sound Beach', 'Rocky Point', 'Shoreham', 'Wading River', 'Riverhead', 'Calverton', 'Manorville', 'Eastport', 'Center Moriches', 'Moriches', 'Shirley', 'Mastic', 'Mastic Beach', 'East Moriches', 'Westhampton', 'Westhampton Beach', 'Quogue', 'Hampton Bays', 'Southampton', 'Bridgehampton', 'Sag Harbor', 'East Hampton', 'Amagansett', 'Montauk', 'Greenport', 'Southold', 'Mattituck', 'Cutchogue', 'Peconic', 'Aquebogue', 'Jamesport', 'Laurel', 'New Suffolk', 'Orient', 'East Marion', 'Shelter Island', 'Massapequa', 'Massapequa Park', 'Amityville', 'Copiague', 'Lindenhurst', 'Babylon', 'West Babylon', 'North Babylon', 'West Islip', 'Bay Shore', 'Islip', 'Islip Terrace', 'East Islip', 'Great River', 'Oakdale', 'Sayville', 'Bayport', 'Blue Point', 'Patchogue', 'Bellport', 'Brookhaven', 'Medford', 'Farmingville', 'Selden', 'Centereach', 'Lake Grove', 'Holbrook', 'Ronkonkoma', 'Lake Ronkonkoma', 'Bohemia', 'Hauppauge', 'Islandia', 'Central Islip', 'Brentwood', 'Bay Shore', 'Deer Park', 'Wyandanch', 'Wheatley Heights', 'Dix Hills', 'East Northport', 'Greenlawn', 'Elwood', 'Plainedge', 'Bethpage', 'Farmingdale', 'East Farmingdale', 'Levittown', 'Wantagh', 'Seaford', 'Bellmore', 'Merrick', 'Roosevelt', 'Uniondale', 'East Meadow', 'North Merrick', 'North Bellmore', 'North Massapequa', 'Oceanside', 'Rockville Centre', 'Baldwin', 'Freeport', 'Franklin Square', 'Malverne', 'Lynbrook', 'East Rockaway', 'Hewlett', 'Woodmere', 'Cedarhurst', 'Lawrence', 'Inwood', 'Atlantic Beach', 'Lido Beach', 'Point Lookout', 'Island Park', 'Elmont', 'Floral Park', 'New Hyde Park', 'Stewart Manor', 'Garden City Park', 'Herricks', 'Manhasset', 'Great Neck', 'Port Washington', 'Roslyn', 'Roslyn Heights', 'Albertson', 'Williston Park', 'East Williston', 'Muttontown', 'Brookville', 'Old Westbury', 'Glen Head', 'Sea Cliff', 'Locust Valley', 'Bayville', 'Mill Neck', 'Lattingtown', 'Centre Island', 'Cove Neck'],
      'NC': ['Charlotte', 'Raleigh', 'Greensboro', 'Durham', 'Winston-Salem', 'Fayetteville', 'Cary', 'Wilmington', 'High Point', 'Greenville', 'Asheville', 'Concord', 'Gastonia', 'Jacksonville', 'Chapel Hill', 'Rocky Mount', 'Burlington', 'Huntersville', 'Kannapolis', 'Apex', 'Hickory', 'Goldsboro'],
      'ND': ['Fargo', 'Bismarck', 'Grand Forks', 'Minot', 'West Fargo', 'Williston', 'Dickinson', 'Mandan'],
      'OH': ['Columbus', 'Cleveland', 'Cincinnati', 'Toledo', 'Akron', 'Dayton', 'Parma', 'Canton', 'Youngstown', 'Lorain', 'Hamilton', 'Springfield', 'Kettering', 'Elyria', 'Lakewood', 'Cuyahoga Falls', 'Middletown', 'Euclid', 'Newark', 'Mansfield', 'Mentor', 'Beavercreek', 'Cleveland Heights', 'Strongsville', 'Dublin', 'Fairfield', 'Findlay', 'Warren', 'Lancaster', 'Lima', 'Huber Heights', 'Westerville', 'Marion', 'Grove City'],
      'OK': ['Oklahoma City', 'Tulsa', 'Norman', 'Broken Arrow', 'Lawton', 'Edmond', 'Moore', 'Midwest City', 'Enid', 'Stillwater', 'Muskogee'],
      'OR': ['Portland', 'Eugene', 'Salem', 'Gresham', 'Hillsboro', 'Beaverton', 'Bend', 'Medford', 'Springfield', 'Corvallis', 'Albany', 'Tigard', 'Lake Oswego', 'Keizer'],
      'PA': ['Philadelphia', 'Pittsburgh', 'Allentown', 'Reading', 'Scranton', 'Bethlehem', 'Lancaster', 'Harrisburg', 'Altoona', 'Erie', 'York', 'Wilkes-Barre', 'Chester', 'Williamsport', 'Easton', 'Lebanon', 'Hazleton', 'New Castle', 'Johnstown', 'McKeesport', 'Hermitage', 'Greensburg', 'Pottsville', 'Sharon', 'Fairless Hills', 'Levittown', 'Bensalem', 'Bristol', 'Morrisville', 'Langhorne', 'Newtown', 'Doylestown', 'Quakertown', 'Warminster', 'Willow Grove', 'Jenkintown', 'Abington', 'Norristown', 'King of Prussia', 'Conshohocken', 'Lansdale', 'Hatboro', 'Ambler', 'Blue Bell', 'Plymouth Meeting', 'Collegeville', 'Pottstown', 'West Chester', 'Malvern', 'Exton', 'Downingtown', 'Coatesville', 'Phoenixville', 'Media', 'Springfield', 'Broomall', 'Drexel Hill', 'Havertown', 'Upper Darby', 'Darby', 'Collingdale', 'Yeadon', 'Lansdowne', 'Clifton Heights', 'Ridley Park', 'Folsom', 'Sharon Hill', 'Glenolden', 'Prospect Park', 'Norwood', 'Tinicum', 'Essington', 'Eddystone', 'Marcus Hook', 'Trainer', 'Boothwyn', 'Aston', 'Brookhaven', 'Glen Mills', 'Concordville', 'Chadds Ford', 'Kennett Square', 'Oxford', 'Parkesburg', 'Atglen', 'Christiana', 'Gap', 'Strasburg', 'Paradise', 'Bird-in-Hand', 'Intercourse', 'Ephrata', 'Lititz', 'Manheim', 'Mount Joy', 'Elizabethtown', 'Hershey', 'Hummelstown', 'Palmyra', 'Annville', 'Cleona', 'Myerstown', 'Womelsdorf', 'Robesonia', 'Wernersville', 'Sinking Spring', 'Wyomissing', 'Shillington', 'Mohnton', 'Birdsboro', 'Boyertown', 'Gilbertsville', 'Sassamansville', 'Red Hill', 'Pennsburg', 'East Greenville', 'Souderton', 'Telford', 'Sellersville', 'Perkasie', 'Dublin', 'Bedminster', 'Plumsteadville', 'Pipersville', 'Point Pleasant', 'Erwinna', 'Upper Black Eddy', 'Riegelsville', 'Easton', 'Nazareth', 'Bath', 'Wind Gap', 'Pen Argyl', 'Bangor', 'Stroudsburg', 'East Stroudsburg', 'Tannersville', 'Mount Pocono', 'Pocono Summit', 'Tobyhanna', 'Blakeslee', 'Jim Thorpe', 'Lehighton', 'Palmerton', 'Slatington', 'Walnutport', 'Northampton', 'Catasauqua', 'Whitehall', 'Coplay', 'Egypt', 'Macungie', 'Emmaus', 'Alburtis', 'Kutztown', 'Topton', 'Fleetwood'],
      'RI': ['Providence', 'Warwick', 'Cranston', 'Pawtucket', 'East Providence', 'Woonsocket', 'Coventry', 'Cumberland', 'North Providence', 'South Kingstown'],
      'SC': ['Charleston', 'Columbia', 'North Charleston', 'Mount Pleasant', 'Rock Hill', 'Greenville', 'Summerville', 'Sumter', 'Goose Creek', 'Hilton Head Island', 'Florence', 'Spartanburg', 'Myrtle Beach', 'Aiken', 'Anderson'],
      'SD': ['Sioux Falls', 'Rapid City', 'Aberdeen', 'Brookings', 'Watertown', 'Mitchell', 'Yankton', 'Pierre', 'Huron'],
      'TN': ['Nashville', 'Memphis', 'Knoxville', 'Chattanooga', 'Clarksville', 'Murfreesboro', 'Franklin', 'Jackson', 'Johnson City', 'Bartlett', 'Hendersonville', 'Kingsport', 'Collierville', 'Smyrna', 'Cleveland', 'Brentwood', 'Germantown', 'Columbia'],
      'TX': ['Houston', 'San Antonio', 'Dallas', 'Austin', 'Fort Worth', 'El Paso', 'Arlington', 'Corpus Christi', 'Plano', 'Laredo', 'Lubbock', 'Garland', 'Irving', 'Amarillo', 'Grand Prairie', 'Brownsville', 'McKinney', 'Frisco', 'Pasadena', 'Mesquite', 'Killeen', 'McAllen', 'Waco', 'Denton', 'Carrollton', 'Midland', 'Abilene', 'Beaumont', 'Round Rock', 'Odessa', 'Wichita Falls', 'Richardson', 'Lewisville', 'Tyler', 'College Station', 'Pearland', 'San Angelo', 'Allen', 'League City', 'Sugar Land', 'Longview', 'Edinburg', 'Mission', 'Bryan', 'Baytown', 'Pharr', 'Temple', 'Missouri City', 'Flower Mound', 'Harlingen', 'North Richland Hills', 'Victoria', 'Conroe', 'New Braunfels', 'Mansfield', 'Cedar Park', 'Rowlett', 'Port Arthur', 'Euless', 'Georgetown', 'Pflugerville', 'DeSoto', 'San Marcos', 'Grapevine', 'Bedford', 'Galveston', 'Cedar Hill', 'Texas City', 'Wylie', 'Haltom City', 'Keller', 'Coppell', 'Rockwall', 'Huntsville', 'Duncanville', 'Sherman', 'The Colony', 'Burleson', 'Hurst', 'Lancaster', 'Texarkana', 'Friendswood', 'Weslaco'],
      'UT': ['Salt Lake City', 'West Valley City', 'Provo', 'West Jordan', 'Orem', 'Sandy', 'Ogden', 'St. George', 'Layton', 'Taylorsville', 'South Jordan', 'Lehi', 'Logan', 'Murray', 'Draper', 'Bountiful', 'Riverton', 'Herriman', 'Spanish Fork', 'Roy', 'Pleasant Grove', 'Kearns', 'Tooele', 'Cottonwood Heights', 'Springville', 'Cedar City', 'Midvale', 'Kaysville', 'Holladay', 'American Fork'],
      'VT': ['Burlington', 'South Burlington', 'Rutland', 'Barre', 'Montpelier', 'Winooski', 'St. Albans', 'Newport', 'Vergennes'],
      'VA': ['Virginia Beach', 'Norfolk', 'Chesapeake', 'Richmond', 'Newport News', 'Alexandria', 'Hampton', 'Roanoke', 'Portsmouth', 'Suffolk', 'Lynchburg', 'Harrisonburg', 'Leesburg', 'Charlottesville', 'Danville', 'Blacksburg', 'Manassas'],
      'WA': ['Seattle', 'Spokane', 'Tacoma', 'Vancouver', 'Bellevue', 'Kent', 'Everett', 'Renton', 'Spokane Valley', 'Federal Way', 'Yakima', 'Kirkland', 'Bellingham', 'Kennewick', 'Auburn', 'Pasco', 'Marysville', 'Lakewood', 'Redmond', 'Shoreline', 'Richland', 'Sammamish', 'Burien', 'Olympia', 'Lacey', 'Edmonds', 'Bremerton', 'Puyallup'],
      'WV': ['Charleston', 'Huntington', 'Morgantown', 'Parkersburg', 'Wheeling', 'Weirton', 'Fairmont', 'Martinsburg', 'Beckley', 'Clarksburg'],
      'WI': ['Milwaukee', 'Madison', 'Green Bay', 'Kenosha', 'Racine', 'Appleton', 'Waukesha', 'Eau Claire', 'Oshkosh', 'Janesville', 'West Allis', 'La Crosse', 'Sheboygan', 'Wauwatosa', 'Fond du Lac', 'New Berlin', 'Wausau', 'Brookfield', 'Greenfield', 'Beloit', 'Menomonee Falls', 'Franklin', 'Oak Creek', 'Manitowoc', 'West Bend', 'Sun Prairie', 'Superior', 'Stevens Point', 'Neenah'],
      'WY': ['Cheyenne', 'Casper', 'Laramie', 'Gillette', 'Rock Springs', 'Sheridan', 'Green River', 'Evanston', 'Riverton', 'Cody'],
      'DC': ['Washington']
    };

    function updateModels() {
      const makeSelect = document.getElementById('vehMake');
      const modelSelect = document.getElementById('vehModel');
      const selectedMake = makeSelect.value;
      
      modelSelect.innerHTML = '<option value="">Select Model</option>';
      if (selectedMake && vehicleMakes[selectedMake]) {
        vehicleMakes[selectedMake].forEach(model => {
          modelSelect.innerHTML += '<option value="' + model + '">' + model + '</option>';
        });
      }
    }
    
    // Build flat list of all cities for autocomplete
    const allCitiesFlat = [];
    Object.keys(usCities).forEach(state => {
      usCities[state].forEach(city => {
        allCitiesFlat.push(city + ', ' + state);
      });
    });
    allCitiesFlat.sort();
    
    function setupLocationAutocomplete(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      
      // Create dropdown container
      let dropdown = document.getElementById(inputId + '-dropdown');
      if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = inputId + '-dropdown';
        const dropBg = isDarkTheme ? '#1e293b' : 'white';
        const dropBorder = isDarkTheme ? '#475569' : '#d1d5db';
        dropdown.style.cssText = 'position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:' + dropBg + ';border:1px solid ' + dropBorder + ';border-top:none;border-radius:0 0 8px 8px;z-index:1000;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.1)';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(dropdown);
      }
      
      const hoverBg = isDarkTheme ? '#334155' : '#f1f5f9';
      const normalBg = isDarkTheme ? '#1e293b' : 'white';
      const borderColor = isDarkTheme ? '#475569' : '#f1f5f9';
      
      input.addEventListener('input', function() {
        const val = this.value.toLowerCase().trim();
        if (val.length < 1) {
          dropdown.style.display = 'none';
          return;
        }
        
        // Prioritize starts-with matches
        const startsWithMatches = allCitiesFlat.filter(c => c.toLowerCase().startsWith(val));
        const containsMatches = allCitiesFlat.filter(c => c.toLowerCase().includes(val) && !c.toLowerCase().startsWith(val));
        const matches = startsWithMatches.concat(containsMatches).slice(0, 15);
        
        if (matches.length === 0) {
          dropdown.style.display = 'none';
          return;
        }
        
        dropdown.innerHTML = matches.map(m => {
          const highlighted = m.replace(new RegExp('(' + val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi'), '<strong>$1</strong>');
          return '<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid ' + borderColor + ';font-size:14px" onmouseover="this.style.background=\'' + hoverBg + '\'" onmouseout="this.style.background=\'' + normalBg + '\'" onclick="selectLocation(\'' + inputId + '\', \'' + m.replace(/'/g, "\\'") + '\')">' + highlighted + '</div>';
        }).join('');
        dropdown.style.display = 'block';
      });
      
      input.addEventListener('blur', function() {
        setTimeout(() => { dropdown.style.display = 'none'; }, 200);
      });
      
      input.addEventListener('focus', function() {
        if (this.value.length >= 1) {
          this.dispatchEvent(new Event('input'));
        }
      });
    }
    
    function selectLocation(inputId, value) {
      document.getElementById(inputId).value = value;
      document.getElementById(inputId + '-dropdown').style.display = 'none';
    }
    
    // Address autocomplete - combines street addresses with city database
    function setupAddressAutocomplete(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      
      // Create dropdown container
      let dropdown = document.getElementById(inputId + '-dropdown');
      if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = inputId + '-dropdown';
        const dropBg = isDarkTheme ? '#1e293b' : 'white';
        const dropBorder = isDarkTheme ? '#475569' : '#d1d5db';
        dropdown.style.cssText = 'position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:' + dropBg + ';border:1px solid ' + dropBorder + ';border-top:none;border-radius:0 0 8px 8px;z-index:1000;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.1)';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(dropdown);
      }
      
      const hoverBg = isDarkTheme ? '#334155' : '#f1f5f9';
      const normalBg = isDarkTheme ? '#1e293b' : 'white';
      const borderColor = isDarkTheme ? '#475569' : '#f1f5f9';
      
      input.addEventListener('input', function() {
        const val = this.value.toLowerCase().trim();
        if (val.length < 2) {
          dropdown.style.display = 'none';
          return;
        }
        
        // Check if user typed a city/state - suggest formatting it
        const cityMatches = allCitiesFlat.filter(c => c.toLowerCase().includes(val)).slice(0, 8);
        
        if (cityMatches.length === 0) {
          dropdown.style.display = 'none';
          return;
        }
        
        dropdown.innerHTML = cityMatches.map(m => {
          const highlighted = m.replace(new RegExp('(' + val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi'), '<strong>$1</strong>');
          return '<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid ' + borderColor + ';font-size:14px" onmouseover="this.style.background=\'' + hoverBg + '\'" onmouseout="this.style.background=\'' + normalBg + '\'" onclick="selectAddress(\'' + inputId + '\', \'' + m.replace(/'/g, "\\'") + '\')">' + highlighted + '</div>';
        }).join('');
        dropdown.style.display = 'block';
      });
      
      input.addEventListener('blur', function() {
        setTimeout(() => { dropdown.style.display = 'none'; }, 200);
      });
      
      input.addEventListener('focus', function() {
        if (this.value.length >= 2) {
          this.dispatchEvent(new Event('input'));
        }
      });
    }
    
    function selectAddress(inputId, cityState) {
      const input = document.getElementById(inputId);
      const currentVal = input.value.trim();
      
      // If user already typed street address, append city/state
      // Otherwise just set the city/state
      if (currentVal && !allCitiesFlat.some(c => currentVal.toLowerCase().includes(c.toLowerCase().split(',')[0]))) {
        // Has content but no recognized city - append city/state
        input.value = currentVal + ', ' + cityState;
      } else {
        input.value = cityState;
      }
      document.getElementById(inputId + '-dropdown').style.display = 'none';
    }
    
    function updateCities(prefix) {
      const stateSelect = document.getElementById(prefix + 'State');
      const citySelect = document.getElementById(prefix + 'City');
      const selectedState = stateSelect.value;
      
      citySelect.innerHTML = '<option value="">Select City</option>';
      if (selectedState && usCities[selectedState]) {
        usCities[selectedState].forEach(city => {
          citySelect.innerHTML += '<option value="' + city + '">' + city + '</option>';
        });
      }
    }
    
    function formatLocation(prefix) {
      const city = document.getElementById(prefix + 'City').value;
      const state = document.getElementById(prefix + 'State').value;
      return city && state ? city + ', ' + state : '';
    }

    function viewTrip(id) {
      // Mark that we're viewing a trip detail (prevents background re-renders from kicking us out)
      currentDetailView = { type: 'trip', id: id };
      
      const t = appData.trips.find(x => x.id === id);
      const d = appData.drivers.find(x => x.id === t.driver_id);
      const tr = appData.trucks.find(x => x.id === t.truck_id);
      const orders = appData.orders.filter(o => o.trip_id === id);
      const expenses = appData.expenses.filter(e => e.trip_id === id);
      const f = getTripFin(id);
      
      // Group orders by vehicle_direction
      const ordersByDirection = {};
      vehicleDirections.forEach(dir => {
        ordersByDirection[dir.id] = orders.filter(o => o.vehicle_direction === dir.id);
      });
      const unassignedOrders = orders.filter(o => !o.vehicle_direction);
      
      // Build vehicle sections by direction
      let vehicleSections = '';
      
      vehicleDirections.forEach(dir => {
        const dirOrders = ordersByDirection[dir.id];
        if (dirOrders.length === 0) return;
        
        const dirRevenue = dirOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
        const dirBrokerFee = dirOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
        const dirLocalFee = dirOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
        const dirCleanRevenue = dirRevenue - dirBrokerFee - dirLocalFee;
        
        vehicleSections += '<div style="background:' + dir.color + ';color:white;padding:12px 16px;font-weight:700;margin-top:16px;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center"><span>' + dir.label + ' (' + dirOrders.length + ' cars)</span><span>Revenue: ' + formatMoney(dirRevenue) + ' | Clean Revenue: ' + formatMoney(dirCleanRevenue) + '</span></div>' +
          '<div class="table-wrapper" style="border:2px solid ' + dir.color + ';border-top:none;border-radius:0 0 8px 8px;margin-bottom:8px"><table><thead><tr><th>Order</th><th>Broker</th><th>Vehicle</th><th>Origin</th><th>ðŸ“žP</th><th>Destination</th><th>ðŸ“žD</th><th>Pick-Up</th><th>Delivery</th><th>Payment</th><th>Broker Fee</th><th>Local Fee</th><th>Revenue</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
          dirOrders.map(o => {
            const noteHtml = o.dispatcher_notes ? '<tr style="background:#fef3c7"><td colspan="14" style="padding:8px 16px;font-size:13px"><span style="font-weight:600;color:#92400e">ðŸ“ Note:</span> ' + o.dispatcher_notes + '</td></tr>' : '';
            const pickupPhoneDisplay = o.pickup_phone ? '<a href="tel:' + o.pickup_phone + '" style="color:#3b82f6" title="' + o.pickup_phone + '">ðŸ“ž</a>' : '-';
            const deliveryPhoneDisplay = o.delivery_phone ? '<a href="tel:' + o.delivery_phone + '" style="color:#10b981" title="' + o.delivery_phone + '">ðŸ“ž</a>' : '-';
            // Payment status with driver collection indicator
            const isCashPayment = ['COD', 'COP', 'LOCAL_COD'].includes(o.payment_type);
            const isCollected = o.driver_paid_status === 'PAID';
            const collectedBadge = isCashPayment ? (isCollected ? '<span class="badge" style="background:#22c55e;color:white;margin-left:4px" title="Driver collected $' + (o.driver_paid_amount || 0) + ' via ' + (o.driver_paid_method || 'N/A') + '">âœ“ $' + (o.driver_paid_amount || 0) + '</span>' : '<span class="badge" style="background:#f59e0b;color:white;margin-left:4px">â³ Pending</span>') : '';
            return '<tr><td><strong>' + o.order_number + '</strong></td><td>' + (o.broker_name || '-') + '</td><td>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</td><td title="' + (o.pickup_full_address || o.origin || '') + '">' + (o.origin || '-') + '</td><td>' + pickupPhoneDisplay + '</td><td title="' + (o.delivery_full_address || o.destination || '') + '">' + (o.destination || '-') + '</td><td>' + deliveryPhoneDisplay + '</td><td>' + (o.pickup_date ? formatDate(o.pickup_date) : '-') + '</td><td>' + (o.dropoff_date ? formatDate(o.dropoff_date) : '-') + '</td><td><span class="badge badge-blue">' + (o.payment_type || '-') + '</span>' + collectedBadge + '</td><td class="money negative">' + formatMoney(o.broker_fee || 0) + '</td><td class="money negative">' + formatMoney(o.local_fee || 0) + '</td><td class="money">' + formatMoney(o.revenue) + '</td><td class="sticky-col"><div class="actions">' + (o.dispatcher_notes ? '<button class="action-btn" style="background:#fef3c7;color:#92400e" title="' + o.dispatcher_notes.replace(/"/g, '&quot;') + '">ðŸ“</button>' : '') + '<button class="action-btn edit" onclick="openEditVehicle(' + o.id + ',' + id + ')">Edit</button><button class="action-btn delete" onclick="removeOrder(' + o.id + ',' + id + ')">Del</button></div></td></tr>' + noteHtml;
          }).join('') +
          '<tr style="background:#f8fafc;font-weight:600"><td colspan="10" style="text-align:right">Subtotal:</td><td class="money negative">' + formatMoney(dirBrokerFee) + '</td><td class="money negative">' + formatMoney(dirLocalFee) + '</td><td class="money">' + formatMoney(dirRevenue) + '</td><td class="sticky-col"></td></tr>' +
          '</tbody></table></div>';
      });
      
      // Add unassigned orders section if any
      if (unassignedOrders.length > 0) {
        const unassignedRevenue = unassignedOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
        const unassignedBrokerFee = unassignedOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
        const unassignedLocalFee = unassignedOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
        const unassignedCleanRevenue = unassignedRevenue - unassignedBrokerFee - unassignedLocalFee;
        
        vehicleSections += '<div style="background:#6b7280;color:white;padding:12px 16px;font-weight:700;margin-top:16px;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center"><span>UNASSIGNED DIRECTION (' + unassignedOrders.length + ' cars)</span><span>Revenue: ' + formatMoney(unassignedRevenue) + ' | Clean Revenue: ' + formatMoney(unassignedCleanRevenue) + '</span></div>' +
          '<div class="table-wrapper" style="border:2px solid #6b7280;border-top:none;border-radius:0 0 8px 8px"><table><thead><tr><th>Order</th><th>Broker</th><th>Vehicle</th><th>Origin</th><th>ðŸ“žP</th><th>Destination</th><th>ðŸ“žD</th><th>Pick-Up</th><th>Delivery</th><th>Payment</th><th>Broker Fee</th><th>Local Fee</th><th>Revenue</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
          unassignedOrders.map(o => {
            const noteHtml = o.dispatcher_notes ? '<tr style="background:#fef3c7"><td colspan="14" style="padding:8px 16px;font-size:13px"><span style="font-weight:600;color:#92400e">ðŸ“ Note:</span> ' + o.dispatcher_notes + '</td></tr>' : '';
            const pickupPhoneDisplay = o.pickup_phone ? '<a href="tel:' + o.pickup_phone + '" style="color:#3b82f6" title="' + o.pickup_phone + '">ðŸ“ž</a>' : '-';
            const deliveryPhoneDisplay = o.delivery_phone ? '<a href="tel:' + o.delivery_phone + '" style="color:#10b981" title="' + o.delivery_phone + '">ðŸ“ž</a>' : '-';
            // Payment status with driver collection indicator
            const isCashPayment = ['COD', 'COP', 'LOCAL_COD'].includes(o.payment_type);
            const isCollected = o.driver_paid_status === 'PAID';
            const collectedBadge = isCashPayment ? (isCollected ? '<span class="badge" style="background:#22c55e;color:white;margin-left:4px" title="Driver collected $' + (o.driver_paid_amount || 0) + ' via ' + (o.driver_paid_method || 'N/A') + '">âœ“ $' + (o.driver_paid_amount || 0) + '</span>' : '<span class="badge" style="background:#f59e0b;color:white;margin-left:4px">â³ Pending</span>') : '';
            return '<tr><td><strong>' + o.order_number + '</strong></td><td>' + (o.broker_name || '-') + '</td><td>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</td><td title="' + (o.pickup_full_address || o.origin || '') + '">' + (o.origin || '-') + '</td><td>' + pickupPhoneDisplay + '</td><td title="' + (o.delivery_full_address || o.destination || '') + '">' + (o.destination || '-') + '</td><td>' + deliveryPhoneDisplay + '</td><td>' + (o.pickup_date ? formatDate(o.pickup_date) : '-') + '</td><td>' + (o.dropoff_date ? formatDate(o.dropoff_date) : '-') + '</td><td><span class="badge badge-blue">' + (o.payment_type || '-') + '</span>' + collectedBadge + '</td><td class="money negative">' + formatMoney(o.broker_fee || 0) + '</td><td class="money negative">' + formatMoney(o.local_fee || 0) + '</td><td class="money">' + formatMoney(o.revenue) + '</td><td class="sticky-col"><div class="actions">' + (o.dispatcher_notes ? '<button class="action-btn" style="background:#fef3c7;color:#92400e" title="' + o.dispatcher_notes.replace(/"/g, '&quot;') + '">ðŸ“</button>' : '') + '<button class="action-btn edit" onclick="openEditVehicle(' + o.id + ',' + id + ')">Edit</button><button class="action-btn delete" onclick="removeOrder(' + o.id + ',' + id + ')">Del</button></div></td></tr>' + noteHtml;
          }).join('') +
          '</tbody></table></div>';
      }
      
      const cleanRevenue = f.loadRevenue - f.brokerFee - f.localFees;
      const payPeriodText = (t.period_start_date ? formatDate(t.period_start_date) : '-') + ' â†’ ' + (t.period_end_date ? formatDate(t.period_end_date) : 'In Progress');
      
      // Get pricing guidance for dispatchers
      const pricingGuidance = getDispatcherPricingGuidance(id);
      const pricingWidget = pricingGuidance ? `
        <div style="background:linear-gradient(135deg,${pricingGuidance.statusColor}15,${pricingGuidance.statusColor}05);border:2px solid ${pricingGuidance.statusColor}40;border-radius:16px;padding:20px;margin-bottom:20px">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;margin-bottom:16px">
            <div>
              <div style="font-size:12px;color:${pricingGuidance.statusColor};font-weight:600;text-transform:uppercase;letter-spacing:0.5px">Trip Status</div>
              <div style="font-size:24px;font-weight:800;color:${pricingGuidance.statusColor}">${pricingGuidance.tripStatus.replace('_', ' ')}</div>
              <div style="font-size:13px;color:var(--text-secondary);margin-top:4px">${pricingGuidance.statusMessage}</div>
            </div>
            <div style="display:flex;gap:16px;flex-wrap:wrap">
              <div style="text-align:center;background:var(--bg-secondary);padding:12px 16px;border-radius:12px;min-width:100px">
                <div style="font-size:10px;color:var(--text-muted);font-weight:600">LOADED</div>
                <div style="font-size:24px;font-weight:800;color:var(--text-primary)">${pricingGuidance.currentCars}/${pricingGuidance.maxCapacity}</div>
                <div style="font-size:11px;color:var(--text-muted)">${pricingGuidance.remainingSlots} slots left</div>
              </div>
              <div style="text-align:center;background:var(--bg-secondary);padding:12px 16px;border-radius:12px;min-width:100px">
                <div style="font-size:10px;color:var(--text-muted);font-weight:600">CURRENT PPC</div>
                <div style="font-size:24px;font-weight:800;color:${pricingGuidance.currentPPC >= pricingGuidance.pricing.target ? '#22c55e' : '#f59e0b'}">${formatMoney(pricingGuidance.currentPPC)}</div>
                <div style="font-size:11px;color:var(--text-muted)">avg per car</div>
              </div>
              <div style="text-align:center;background:var(--bg-secondary);padding:12px 16px;border-radius:12px;min-width:100px">
                <div style="font-size:10px;color:var(--text-muted);font-weight:600">TRIP PROFIT</div>
                <div style="font-size:24px;font-weight:800;color:${pricingGuidance.currentProfit >= 0 ? '#22c55e' : '#ef4444'}">${formatMoney(pricingGuidance.currentProfit)}</div>
                <div style="font-size:11px;color:var(--text-muted)">current</div>
              </div>
            </div>
          </div>
          
          <div style="background:var(--bg-secondary);border-radius:12px;padding:16px">
            <div style="font-size:13px;font-weight:700;color:var(--text-primary);margin-bottom:12px">ðŸ’° DISPATCHER PRICING GUIDANCE</div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px">
              <div style="background:#fee2e2;padding:12px;border-radius:8px;text-align:center">
                <div style="font-size:10px;color:#991b1b;font-weight:600">MINIMUM PPC</div>
                <div style="font-size:20px;font-weight:800;color:#dc2626">${formatMoney(pricingGuidance.pricing.minimum)}</div>
                <div style="font-size:10px;color:#991b1b">Break-even</div>
              </div>
              <div style="background:#dcfce7;padding:12px;border-radius:8px;text-align:center;border:2px solid #22c55e">
                <div style="font-size:10px;color:#166534;font-weight:600">TARGET PPC</div>
                <div style="font-size:20px;font-weight:800;color:#16a34a">${formatMoney(pricingGuidance.pricing.target)}</div>
                <div style="font-size:10px;color:#166534">Profitable</div>
              </div>
              <div style="background:#dbeafe;padding:12px;border-radius:8px;text-align:center">
                <div style="font-size:10px;color:#1e40af;font-weight:600">MARKET AVG</div>
                <div style="font-size:20px;font-weight:800;color:#2563eb">${formatMoney(pricingGuidance.pricing.marketAvg)}</div>
                <div style="font-size:10px;color:#1e40af">Historical</div>
              </div>
              ${pricingGuidance.remainingSlots > 0 ? `
              <div style="background:#fef3c7;padding:12px;border-radius:8px;text-align:center">
                <div style="font-size:10px;color:#92400e;font-weight:600">NEED FOR REMAINING</div>
                <div style="font-size:20px;font-weight:800;color:#d97706">${formatMoney(pricingGuidance.pricing.recommendedForRemaining)}</div>
                <div style="font-size:10px;color:#92400e">${pricingGuidance.remainingSlots} cars @ this price</div>
              </div>
              ` : ''}
            </div>
            <div style="margin-top:12px;padding:10px;background:var(--bg-tertiary);border-radius:8px;font-size:12px;color:var(--text-secondary)">
              <strong>ðŸ’¡ Tip:</strong> Fixed cost allocation per trip: ${formatMoney(pricingGuidance.breakEvenInfo.fixedCostAllocation)}. 
              Truck gross ratio: ${(pricingGuidance.breakEvenInfo.truckGrossRatio * 100).toFixed(1)}% of revenue stays after fees and driver cut.
            </div>
          </div>
        </div>
      ` : '';
      
      const c = document.getElementById('main-content');
      c.innerHTML = '<div class="header"><div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap"><button class="btn btn-secondary" onclick="renderTrips(document.getElementById(\'main-content\'))">â† Back</button><h2>' + t.trip_number + '</h2><span class="badge ' + getBadge(t.status) + '">' + t.status + '</span>' + (t.status !== 'COMPLETED' ? '<button class="btn btn-primary" style="background:#10b981" onclick="markTripCompleted(' + id + ')">âœ“ Mark Completed</button>' : '<span style="color:#10b981;font-weight:600">âœ“ Trip Completed</span>') + '</div><div style="display:flex;gap:12px"><button class="btn btn-primary" onclick="openAddVehicle(' + id + ')">+ Add Vehicle</button><button class="btn btn-secondary" onclick="openAddExpense(' + id + ')">+ Expense</button><button class="btn btn-secondary" onclick="openRouteSequence(' + id + ')">ðŸ—ºï¸ Route Sequence</button></div></div>' +
        
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px"><div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Date</div><div class="value" style="font-size:16px">' + formatDate(t.trip_date) + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:150px;padding:12px 16px;background:#f3e8ff;cursor:pointer" onclick="openTripModal(' + id + ')"><div class="label">ðŸ“… Pay Period âœï¸</div><div class="value" style="font-size:12px;color:#7c3aed">' + payPeriodText + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:12px 16px;cursor:pointer" onclick="openAssignDriver(' + id + ')"><div class="label">Driver âœï¸</div><div class="value" style="font-size:14px">' + (d ? d.first_name + ' ' + d.last_name : 'Not Assigned') + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:80px;padding:12px 16px;cursor:pointer" onclick="openAssignTruck(' + id + ')"><div class="label">Truck âœï¸</div><div class="value" style="font-size:16px">' + (tr ? '#' + tr.truck_number : '-') + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:70px;padding:12px 16px"><div class="label">Cars</div><div class="value" style="font-size:16px">' + orders.length + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px"><div class="label">Broker Fees</div><div class="value" style="font-size:14px;color:#ef4444">' + formatMoney(f.brokerFee) + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px"><div class="label">Local Fees</div><div class="value" style="font-size:14px;color:#ef4444">' + formatMoney(f.localFees) + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px"><div class="label">Revenue</div><div class="value" style="font-size:14px">' + formatMoney(f.loadRevenue) + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px;background:#dbeafe"><div class="label">Clean Revenue</div><div class="value" style="font-size:14px;color:#1d4ed8">' + formatMoney(cleanRevenue) + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px;background:' + (f.netProfit >= 0 ? '#d1fae5' : '#fee2e2') + '"><div class="label">Net Profit</div><div class="value" style="font-size:14px">' + formatMoney(f.netProfit) + '</div></div></div>' +
        
        pricingWidget +
        
        '<div class="card"><div class="card-header"><h3>ðŸš— Vehicles by Direction (' + orders.length + ' total)</h3></div>' +
        (orders.length === 0 ? '<div style="padding:40px;text-align:center">No vehicles yet. Click "+ Add Vehicle" to add cars to this trip.</div>' : '<div style="padding:16px">' + vehicleSections + '</div>') +
        '</div>' +
        
        '<div class="card"><div class="card-header"><h3>ðŸ’¸ Expenses (' + expenses.length + ')</h3><button class="btn btn-primary btn-sm" onclick="openAddExpense(' + id + ')">+ Add Expense</button></div>' + (expenses.length === 0 ? '<div style="padding:40px;text-align:center">No expenses yet. Click "+ Add Expense" to record expenses.</div>' : '<div class="table-wrapper"><table><thead><tr><th>Category</th><th>Description</th><th>Amount</th><th>Actions</th></tr></thead><tbody>' + expenses.map(e => '<tr><td><span class="badge badge-blue">' + e.category + '</span></td><td>' + (e.description || '-') + '</td><td class="money negative">' + formatMoney(e.amount) + '</td><td><button class="action-btn delete" onclick="deleteExpense(' + e.id + ',' + id + ')">Delete</button></td></tr>').join('') + '</tbody></table></div>') + '</div>' +
        
        '<div class="card"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center"><h3>ðŸ›£ï¸ Trip Miles</h3><button class="btn btn-secondary btn-sm" onclick="openEditMiles(' + id + ')">âœï¸ Edit Miles</button></div><div style="padding:20px;display:flex;align-items:center;gap:20px"><div style="font-size:32px;font-weight:700;color:#1e40af">' + (t.miles || 0).toLocaleString() + '</div><div style="color:#64748b">miles</div></div></div>';
    }

    function openEditMiles(tripId) {
      const t = appData.trips.find(x => x.id === tripId);
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:350px"><div class="modal-header"><h3>ðŸ›£ï¸ Edit Trip Miles</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body"><div class="form-group"><label>Total Miles for this Trip</label><input type="number" id="editTripMiles" value="' + (t.miles || 0) + '" placeholder="e.g., 2800"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveTripMiles(' + tripId + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    async function saveTripMiles(tripId) {
      const miles = parseFloat(document.getElementById('editTripMiles').value) || 0;
      try { await dbUpdate('trips', tripId, { miles }); document.querySelector('.modal-overlay').remove(); showToast('Miles updated!'); await loadAllData(true); viewTrip(tripId); } catch (e) { showToast(e.message, 'error'); }
    }

    // ============ ROUTE SEQUENCE FUNCTIONS ============

    // Store current trip ID for route sequence operations
    let routeSequenceTripId = null;

    function openRouteSequence(tripId) {
      routeSequenceTripId = tripId;
      const trip = appData.trips.find(t => t.id === tripId);
      const tripOrders = appData.orders.filter(o => o.trip_id === tripId);

      if (tripOrders.length === 0) {
        showToast('No vehicles in this trip to sequence', 'warning');
        return;
      }

      // Create array of stops
      // If local_fee > 0, skip PICKUP (local driver already brought vehicle to terminal)
      // Only show DELIVERY for those vehicles
      let stops = [];
      tripOrders.forEach(order => {
        const hasLocalFee = parseFloat(order.local_fee || 0) > 0;

        // Only add PICKUP if no local fee (semi driver picks up themselves)
        if (!hasLocalFee) {
          stops.push({
            orderId: order.id,
            type: 'PICKUP',
            location: order.origin || 'Unknown',
            vehicle: (order.vehicle_year || '') + ' ' + (order.vehicle_make || '') + ' ' + (order.vehicle_model || ''),
            currentSequence: order.pickup_sequence
          });
        }

        // Always add DELIVERY
        stops.push({
          orderId: order.id,
          type: 'DELIVERY',
          location: order.destination || 'Unknown',
          vehicle: (order.vehicle_year || '') + ' ' + (order.vehicle_make || '') + ' ' + (order.vehicle_model || ''),
          currentSequence: order.delivery_sequence,
          isTerminalPickup: hasLocalFee  // Flag to indicate this was a terminal pickup
        });
      });

      // Sort by existing sequence (if set) or by order added
      stops.sort((a, b) => {
        const seqA = a.currentSequence || 999;
        const seqB = b.currentSequence || 999;
        return seqA - seqB;
      });

      // Render modal with sortable list
      const m = document.createElement('div');
      m.className = 'modal-overlay';
      m.onclick = e => { if (e.target === m) m.remove(); };

      m.innerHTML = '<div class="modal" style="max-width:700px;max-height:90vh;display:flex;flex-direction:column">' +
        '<div class="modal-header"><h3>ðŸ—ºï¸ Route Sequence</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div>' +
        '<div class="modal-body" style="overflow-y:auto;flex:1;padding:16px">' +
        '<div style="margin-bottom:16px;display:flex;gap:8px;flex-wrap:wrap">' +
        '<button class="btn btn-secondary" onclick="autoFillSequence()">ðŸ§­ Auto-Sort (Eastâ†’West)</button>' +
        '<button class="btn btn-secondary" onclick="clearSequence()">ðŸ—‘ï¸ Clear Sequence</button>' +
        '</div>' +
        '<p style="font-size:13px;color:var(--text-muted);margin-bottom:12px">Drag or use arrows to reorder stops. Pickup must come before delivery for each vehicle.</p>' +
        '<div id="sequenceList" class="sequence-container">' + renderSequenceList(stops) + '</div>' +
        '</div>' +
        '<div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveRouteSequence()">Save Sequence</button></div>' +
        '</div>';

      document.body.appendChild(m);

      // Validate initial state
      validateSequence();
    }

    function renderSequenceList(stops) {
      return stops.map((stop, index) => {
        const bgColor = stop.type === 'PICKUP' ? 'rgba(34,197,94,0.15)' : 'rgba(249,115,22,0.15)';
        const borderColor = stop.type === 'PICKUP' ? '#22c55e' : '#f97316';
        const typeLabel = stop.type === 'PICKUP' ? 'ðŸ“¦ PICKUP' : 'ðŸ DELIVERY';

        return '<div class="sequence-item" data-order-id="' + stop.orderId + '" data-type="' + stop.type + '" ' +
          'style="background:' + bgColor + ';border-left:4px solid ' + borderColor + ';padding:12px 16px;margin-bottom:8px;border-radius:8px;display:flex;align-items:center;gap:12px">' +
          '<span class="drag-handle" style="color:var(--text-muted);font-size:18px;cursor:grab">â˜°</span>' +
          '<span class="sequence-number" style="font-weight:700;font-size:18px;min-width:30px">' + (index + 1) + '.</span>' +
          '<div style="flex:1">' +
          '<div style="font-weight:600;color:' + borderColor + '">' + typeLabel + '</div>' +
          '<div style="font-size:15px;font-weight:500;color:var(--text-primary)">' + stop.vehicle.trim() + '</div>' +
          '<div style="font-size:13px;color:var(--text-muted)">ðŸ“ ' + stop.location + '</div>' +
          '</div>' +
          '<div style="display:flex;flex-direction:column;gap:4px">' +
          '<button onclick="moveSequenceItem(this, -1)" class="btn btn-secondary" style="padding:4px 8px;font-size:14px;min-width:32px">â–²</button>' +
          '<button onclick="moveSequenceItem(this, 1)" class="btn btn-secondary" style="padding:4px 8px;font-size:14px;min-width:32px">â–¼</button>' +
          '</div>' +
          '</div>';
      }).join('');
    }

    function moveSequenceItem(btn, direction) {
      const item = btn.closest('.sequence-item');
      const container = document.getElementById('sequenceList');
      const items = Array.from(container.children);
      const currentIndex = items.indexOf(item);
      const newIndex = currentIndex + direction;

      if (newIndex < 0 || newIndex >= items.length) return;

      // Swap elements
      if (direction === -1) {
        container.insertBefore(item, items[newIndex]);
      } else {
        container.insertBefore(items[newIndex], item);
      }

      // Update sequence numbers
      updateSequenceNumbers();

      // Validate pickup before delivery
      validateSequence();
    }

    function updateSequenceNumbers() {
      const items = document.querySelectorAll('#sequenceList .sequence-item');
      items.forEach((item, index) => {
        item.querySelector('.sequence-number').textContent = (index + 1) + '.';
      });
    }

    function validateSequence() {
      const items = Array.from(document.querySelectorAll('#sequenceList .sequence-item'));
      const orderPositions = {};
      let errors = [];

      items.forEach((item, index) => {
        const orderId = item.dataset.orderId;
        const type = item.dataset.type;

        if (!orderPositions[orderId]) {
          orderPositions[orderId] = {};
        }
        orderPositions[orderId][type] = index;
      });

      // Check each order: pickup must come before delivery
      // Skip orders that only have DELIVERY (terminal pickups with local_fee > 0)
      Object.keys(orderPositions).forEach(orderId => {
        const pos = orderPositions[orderId];
        // Only validate if order has BOTH pickup and delivery
        if (pos.PICKUP !== undefined && pos.DELIVERY !== undefined) {
          if (pos.PICKUP >= pos.DELIVERY) {
            errors.push(orderId);
          }
        }
      });

      // Update visual indicators
      items.forEach(item => {
        const orderId = item.dataset.orderId;
        if (errors.includes(orderId)) {
          item.style.boxShadow = '0 0 0 2px #ef4444';
        } else {
          item.style.boxShadow = 'none';
        }
      });

      if (errors.length > 0) {
        showToast('âš ï¸ Pickup must come before delivery for each vehicle', 'warning');
        return false;
      }
      return true;
    }

    async function saveRouteSequence() {
      // Validate first
      if (!validateSequence()) {
        return;
      }

      const items = Array.from(document.querySelectorAll('#sequenceList .sequence-item'));
      const updates = {};

      // Build update map: orderId -> {pickup_sequence, delivery_sequence}
      items.forEach((item, index) => {
        const orderId = item.dataset.orderId;
        const type = item.dataset.type;
        const sequence = index + 1; // 1-based

        if (!updates[orderId]) {
          // Initialize with null for pickup (in case it's a terminal pickup with no pickup stop)
          updates[orderId] = { pickup_sequence: null };
        }

        if (type === 'PICKUP') {
          updates[orderId].pickup_sequence = sequence;
        } else {
          updates[orderId].delivery_sequence = sequence;
        }
      });

      // Update each order in database
      try {
        for (const [orderId, data] of Object.entries(updates)) {
          await dbUpdate('orders', parseInt(orderId), data, true); // Skip conflict check
        }

        showToast('âœ… Route sequence saved!', 'success');
        document.querySelector('.modal-overlay').remove();
        await loadAllData(true);
        viewTrip(routeSequenceTripId);
      } catch (e) {
        showToast('âŒ Failed to save sequence: ' + e.message, 'error');
      }
    }

    async function clearSequence() {
      if (!confirm('Clear route sequence? The Driver App will use its own algorithm instead.')) return;

      const tripOrders = appData.orders.filter(o => o.trip_id === routeSequenceTripId);

      try {
        for (const order of tripOrders) {
          await dbUpdate('orders', order.id, {
            pickup_sequence: null,
            delivery_sequence: null
          }, true); // Skip conflict check
        }

        showToast('Sequence cleared', 'info');
        document.querySelector('.modal-overlay').remove();
        await loadAllData(true);
        viewTrip(routeSequenceTripId);
      } catch (e) {
        showToast('Failed to clear sequence: ' + e.message, 'error');
      }
    }

    function autoFillSequence() {
      // Simple east-to-west sort based on state abbreviations
      const stateOrder = {
        'ME':1,'NH':2,'VT':3,'MA':4,'RI':5,'CT':6,'NY':7,'NJ':8,'PA':9,'DE':10,
        'MD':11,'VA':12,'WV':13,'NC':14,'SC':15,'GA':16,'FL':17,'OH':18,'MI':19,
        'IN':20,'IL':21,'WI':22,'MN':23,'IA':24,'MO':25,'KY':26,'TN':27,'AL':28,
        'MS':29,'AR':30,'LA':31,'TX':32,'OK':33,'KS':34,'NE':35,'SD':36,'ND':37,
        'MT':38,'WY':39,'CO':40,'NM':41,'AZ':42,'UT':43,'NV':44,'ID':45,'WA':46,
        'OR':47,'CA':48,'AK':49,'HI':50
      };

      const container = document.getElementById('sequenceList');
      const items = Array.from(container.children);

      // Extract state from location and sort
      items.sort((a, b) => {
        const locA = a.querySelector('[style*="ðŸ“"]')?.textContent || '';
        const locB = b.querySelector('[style*="ðŸ“"]')?.textContent || '';
        const stateA = locA.match(/,\s*([A-Z]{2})/)?.[1] || 'ZZ';
        const stateB = locB.match(/,\s*([A-Z]{2})/)?.[1] || 'ZZ';
        return (stateOrder[stateA] || 50) - (stateOrder[stateB] || 50);
      });

      // Re-append in sorted order
      items.forEach(item => container.appendChild(item));
      updateSequenceNumbers();
      validateSequence();

      showToast('Sorted east to west by state', 'info');
    }

    async function markTripCompleted(tripId, fromList = false) {
      if (!confirm('Mark this trip as completed?')) return;
      try {
        const trip = appData.trips.find(t => t.id === tripId);
        const today = new Date().toISOString().split('T')[0];
        const updateData = { status: 'COMPLETED' };
        // Set period_end_date to today if not already set
        if (!trip.period_end_date) {
          updateData.period_end_date = today;
        }
        await dbUpdate('trips', tripId, updateData);
        
        showToast('Trip marked as completed!');
        
        await loadAllData(true);
        // If called from list, refresh list; otherwise show trip detail
        if (fromList || !document.querySelector('.header h2')?.textContent?.includes('TRIP')) {
          renderTrips(document.getElementById('main-content'));
        } else {
          viewTrip(tripId);
        }
      } catch (e) { showToast('Failed to update', 'error'); }
    }

    function openAssignDriver(tripId) {
      const t = appData.trips.find(x => x.id === tripId);
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:400px"><div class="modal-header"><h3>Assign Driver</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body"><div class="form-group"><label>Driver</label><select id="assignDriver" onchange="updateAssignDriverCut()"><option value="">Select</option>' + appData.drivers.filter(d => d.status === 'ACTIVE').map(d => '<option value="' + d.id + '" data-cut="' + (d.cut_percent || 32) + '"' + (t.driver_id === d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('') + '</select></div><div class="form-group"><label>Driver Cut %</label><input type="number" id="assignCut" value="' + (t.driver_cut_percent || 32) + '"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="assignDriver(' + tripId + ')">Assign</button></div></div>';
      document.body.appendChild(m);
    }
    
    function updateAssignDriverCut() {
      const driverSelect = document.getElementById('assignDriver');
      const cutInput = document.getElementById('assignCut');
      const selectedOption = driverSelect.options[driverSelect.selectedIndex];
      
      if (selectedOption && selectedOption.value) {
        const driverCut = selectedOption.getAttribute('data-cut');
        if (driverCut) {
          cutInput.value = driverCut;
        }
      }
    }

    async function assignDriver(tripId) {
      await dbUpdate('trips', tripId, { driver_id: parseInt(document.getElementById('assignDriver').value) || null, driver_cut_percent: parseFloat(document.getElementById('assignCut').value) || 32 });
      document.querySelector('.modal-overlay').remove(); showToast('Driver assigned'); await loadAllData(true); viewTrip(tripId);
    }

    function openAssignTruck(tripId) {
      const t = appData.trips.find(x => x.id === tripId);
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:400px"><div class="modal-header"><h3>Assign Truck</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body"><div class="form-group"><label>Truck</label><select id="assignTruck"><option value="">Select</option>' + appData.trucks.filter(x => x.status === 'ACTIVE').map(x => '<option value="' + x.id + '"' + (t.truck_id === x.id ? ' selected' : '') + '>#' + x.truck_number + ' - ' + x.truck_type + '</option>').join('') + '</select></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="assignTruck(' + tripId + ')">Assign</button></div></div>';
      document.body.appendChild(m);
    }

    async function assignTruck(tripId) {
      await dbUpdate('trips', tripId, { truck_id: parseInt(document.getElementById('assignTruck').value) || null });
      document.querySelector('.modal-overlay').remove(); showToast('Truck assigned'); await loadAllData(true); viewTrip(tripId);
    }

    // Vehicle list for multi-vehicle orders
    let vehicleList = [];
    
    function openAddVehicle(tripId) {
      vehicleList = [];
      
      // Find dispatcher matching current user by user_id OR by email/name
      let userDispatcher = appData.dispatchers.find(d => d.user_id === currentUser.id);
      if (!userDispatcher) {
        userDispatcher = appData.dispatchers.find(d => d.email && d.email.toLowerCase() === currentUser.email.toLowerCase());
      }
      if (!userDispatcher) {
        const fullName = (currentUser.first_name + ' ' + currentUser.last_name).toLowerCase();
        userDispatcher = appData.dispatchers.find(d => d.name && d.name.toLowerCase() === fullName);
      }
      
      const directionOptions = vehicleDirections.map(d => '<option value="' + d.id + '">' + d.label + '</option>').join('');
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:750px;max-height:90vh;display:flex;flex-direction:column"><div class="modal-header"><h3>Add Vehicle</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body" style="overflow-y:auto;flex:1">' +
        '<div class="form-group"><label>Vehicle Direction *</label><select id="orderDirection" style="border:2px solid #22c55e;font-weight:600">' + directionOptions + '</select></div>' +
        '<div class="form-row"><div class="form-group"><label>Order #</label><input id="orderNum" value="ORD-' + Date.now().toString().slice(-4) + '"></div><div class="form-group" style="position:relative"><label>Broker</label><input type="text" id="orderBrokerInput" placeholder="Start typing broker..." autocomplete="off"><input type="hidden" id="orderBrokerId"></div></div>' +
        '<div id="newBrokerSection" style="display:none;background:#f0fdf4;padding:12px;border-radius:8px;margin-bottom:12px;border:1px solid #bbf7d0"><div class="form-group" style="margin-bottom:0"><label>New Broker Name *</label><input id="newBrokerName" placeholder="Enter broker name"></div></div>' +
        
        // Vehicle Info Section with separate Year, Make, Model
        '<div style="background:#f8fafc;padding:12px;border-radius:8px;margin-bottom:16px">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><label style="font-weight:600;margin:0">ðŸš— Vehicle Info</label></div>' +
        '<div class="form-row" style="gap:12px;align-items:flex-end">' +
        '<div class="form-group" style="margin-bottom:0;flex:0 0 100px;position:relative"><label>Year</label><input type="text" id="vehYear" value="' + new Date().getFullYear() + '" placeholder="Year" autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>Make</label><input type="text" id="vehMake" placeholder="Start typing make..." autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>Model</label><input type="text" id="vehModel" placeholder="Start typing model..." autocomplete="off"></div>' +
        '<button type="button" class="btn btn-secondary" onclick="addAnotherVehicle()" style="height:42px;white-space:nowrap">+ Add Another</button></div>' +
        
        // Vehicle List (shows when multiple vehicles added)
        '<div id="vehicleListSection" style="margin-top:12px;display:none">' +
        '<div id="vehicleListItems"></div>' +
        '</div></div>' +
        
        // Pickup Section (Origin + Address + Phone)
        '<div style="background:#dbeafe;padding:12px;border-radius:8px;margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px">ðŸ“ PICKUP</label>' +
        '<div class="form-row" style="gap:12px">' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>City/State</label><input type="text" id="orderOrigin" placeholder="Start typing city..." autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:0 0 140px"><label>ðŸ“ž Phone</label><input type="tel" id="pickupPhone" placeholder="(555) 123-4567"></div></div>' +
        '<div class="form-group" style="margin-bottom:0;margin-top:8px;position:relative"><label>Full Address</label><input type="text" id="pickupFullAddress" placeholder="Start typing full address..." autocomplete="off"></div></div>' +
        
        // Delivery Section (Destination + Address + Phone)
        '<div style="background:#d1fae5;padding:12px;border-radius:8px;margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px">ðŸ DELIVERY</label>' +
        '<div class="form-row" style="gap:12px">' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>City/State</label><input type="text" id="orderDest" placeholder="Start typing city..." autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:0 0 140px"><label>ðŸ“ž Phone</label><input type="tel" id="deliveryPhone" placeholder="(555) 123-4567"></div></div>' +
        '<div class="form-group" style="margin-bottom:0;margin-top:8px;position:relative"><label>Full Address</label><input type="text" id="deliveryFullAddress" placeholder="Start typing full address..." autocomplete="off"></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Pick-Up Date</label><input type="date" id="orderPickup" value="' + new Date().toISOString().split('T')[0] + '"></div><div class="form-group"><label>Drop-Off Date</label><input type="date" id="orderDropoff"></div></div>' +
        
        // Payment Section with Split Payment
        '<div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:16px"><label style="font-weight:600;margin-bottom:8px;display:block">ðŸ’° Payment (Total for ALL vehicles)</label>' +
        '<div class="form-row" style="gap:12px"><div class="form-group" style="margin-bottom:0"><label>Total Revenue $</label><input type="number" id="orderRev" onchange="updatePaymentSplit()"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label>Payment Type</label><select id="orderPay" onchange="toggleSplitPayment()"><option value="BILL">BILL (Invoice)</option><option value="COD">COD (Cash on Delivery)</option><option value="COP">COP (Cash on Pickup)</option><option value="LOCAL_COD">LOCAL_COD (Local Driver)</option><option value="CHECK">CHECK</option><option value="SPLIT">SPLIT (Multiple)</option></select></div></div>' +
        '<div id="splitPaymentSection" style="display:none;margin-top:12px;padding-top:12px;border-top:1px dashed #f59e0b">' +
        '<div class="form-row" style="grid-template-columns:1fr 1fr 1fr;gap:12px">' +
        '<div class="form-group" style="margin-bottom:0"><label>COD/COP Amount $</label><input type="number" id="splitCodAmount" value="0" onchange="updateSplitBill()"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label>Bill Amount $</label><input type="number" id="splitBillAmount" value="0" readonly style="background:#f1f5f9"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label>COD/COP Type</label><select id="splitCodType"><option value="COD">COD</option><option value="COP">COP</option><option value="LOCAL_COD">LOCAL_COD</option></select></div></div></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Broker Fee $</label><input type="number" id="orderBrokerFee" value="0"></div><div class="form-group"><label>Local Fee $</label><input type="number" id="orderFee" value="0"></div></div>' +
        '<div class="form-group"><label>ðŸ“ Notes for Dispatchers</label><textarea id="orderNotes" rows="2" placeholder="Add notes visible to all dispatchers..." style="resize:vertical"></textarea></div>' +
        '<div class="form-row"><div class="form-group"><label>Status</label><select id="orderStatus"><option>PENDING</option><option>IN_TRANSIT</option><option>DELIVERED</option></select></div><div class="form-group"><label>Booked By</label>' +
        (currentUser.role === 'ADMIN' || currentUser.role === 'MANAGER' ?
          '<select id="orderDispatcher"><option value="">Select Dispatcher</option>' + appData.dispatchers.map(d => '<option value="' + d.id + '"' + (userDispatcher && userDispatcher.id === d.id ? ' selected' : '') + '>' + d.name + '</option>').join('') + '</select>' :
          '<input type="text" value="' + (userDispatcher ? userDispatcher.name : currentUser.first_name + ' ' + currentUser.last_name) + '" readonly style="background:#f1f5f9;cursor:not-allowed"><input type="hidden" id="orderDispatcher" value="' + (userDispatcher ? userDispatcher.id : '') + '">'
        ) + '</div></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveVehicle(' + tripId + ')">Save</button></div></div>';
      document.body.appendChild(m);
      
      // Setup broker autocomplete
      setupBrokerAutocomplete('orderBrokerInput');
      
      // Setup location autocomplete for city/state
      setupLocationAutocomplete('orderOrigin');
      setupLocationAutocomplete('orderDest');
      
      // Setup address autocomplete for full addresses
      setupAddressAutocomplete('pickupFullAddress');
      setupAddressAutocomplete('deliveryFullAddress');
      
      // Setup year autocomplete
      setupYearAutocomplete('vehYear');
      
      // Setup make autocomplete
      setupMakeAutocomplete('vehMake');
      
      // Setup model autocomplete (depends on make)
      setupModelAutocomplete('vehModel');
    }
    
    function setupBrokerAutocomplete(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      
      let dropdown = document.getElementById(inputId + '-dropdown');
      if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = inputId + '-dropdown';
        const dropBg = isDarkTheme ? '#1e293b' : 'white';
        const dropBorder = isDarkTheme ? '#475569' : '#d1d5db';
        dropdown.style.cssText = 'position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:' + dropBg + ';border:1px solid ' + dropBorder + ';border-top:none;border-radius:0 0 8px 8px;z-index:1000;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.1)';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(dropdown);
      }
      
      input.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        const brokers = appData.brokers || [];
        
        let matches = [];
        if (val.length >= 1) {
          matches = brokers.filter(b => b.name.toLowerCase().includes(val)).slice(0, 10);
        }
        
        // Always add "Add New Broker" option
        const showNew = val.length >= 2 && !brokers.some(b => b.name.toLowerCase() === val);
        
        if (matches.length === 0 && !showNew) {
          dropdown.style.display = 'none';
          return;
        }
        
        dropdown.innerHTML = matches.map(b => {
          const highlighted = b.name.replace(new RegExp('(' + val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi'), '<strong>$1</strong>');
          return '<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9;font-size:14px" onmouseover="this.style.background=\'#f1f5f9\'" onmouseout="this.style.background=\'white\'" onclick="selectBroker(\'' + inputId + '\', ' + b.id + ', \'' + b.name.replace(/'/g, "\\'") + '\')">' + highlighted + '</div>';
        }).join('');
        
        if (showNew) {
          dropdown.innerHTML += '<div style="padding:10px 12px;cursor:pointer;background:#f0fdf4;color:#16a34a;font-weight:600;font-size:14px" onmouseover="this.style.background=\'#dcfce7\'" onmouseout="this.style.background=\'#f0fdf4\'" onclick="showNewBrokerField()">+ Add New Broker: "' + input.value + '"</div>';
        }
        
        dropdown.style.display = 'block';
      });
      
      input.addEventListener('blur', function() {
        setTimeout(() => { dropdown.style.display = 'none'; }, 200);
      });
    }
    
    function selectBroker(inputId, brokerId, brokerName) {
      document.getElementById(inputId).value = brokerName;
      document.getElementById('orderBrokerId').value = brokerId;
      document.getElementById(inputId + '-dropdown').style.display = 'none';
      document.getElementById('newBrokerSection').style.display = 'none';
    }
    
    function showNewBrokerField() {
      document.getElementById('newBrokerSection').style.display = 'block';
      document.getElementById('newBrokerName').value = document.getElementById('orderBrokerInput').value;
      document.getElementById('orderBrokerId').value = '__NEW__';
    }
    
    function setupYearAutocomplete(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      
      let dropdown = document.getElementById(inputId + '-dropdown');
      if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = inputId + '-dropdown';
        const dropBg = isDarkTheme ? '#1e293b' : 'white';
        const dropBorder = isDarkTheme ? '#475569' : '#d1d5db';
        dropdown.style.cssText = 'position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:' + dropBg + ';border:1px solid ' + dropBorder + ';border-top:none;border-radius:0 0 8px 8px;z-index:1000;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.1)';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(dropdown);
      }
      
      input.addEventListener('input', function() {
        const val = this.value;
        if (val.length < 2) {
          dropdown.style.display = 'none';
          return;
        }
        
        const matches = vehicleYears.filter(y => y.toString().includes(val)).slice(0, 15);
        
        if (matches.length === 0) {
          dropdown.style.display = 'none';
          return;
        }
        
        dropdown.innerHTML = matches.map(y => {
          return '<div style="padding:8px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9;font-size:14px" onmouseover="this.style.background=\'#f1f5f9\'" onmouseout="this.style.background=\'white\'" onclick="document.getElementById(\'' + inputId + '\').value=\'' + y + '\';this.parentElement.style.display=\'none\'">' + y + '</div>';
        }).join('');
        dropdown.style.display = 'block';
      });
      
      input.addEventListener('blur', function() {
        setTimeout(() => { dropdown.style.display = 'none'; }, 200);
      });
    }
    
    function setupMakeAutocomplete(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      
      const allMakes = Object.keys(vehicleMakes).sort();
      
      let dropdown = document.getElementById(inputId + '-dropdown');
      if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = inputId + '-dropdown';
        const dropBg = isDarkTheme ? '#1e293b' : 'white';
        const dropBorder = isDarkTheme ? '#475569' : '#d1d5db';
        dropdown.style.cssText = 'position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:' + dropBg + ';border:1px solid ' + dropBorder + ';border-top:none;border-radius:0 0 8px 8px;z-index:1000;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.1)';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(dropdown);
      }
      
      // Determine the corresponding model input ID
      const modelInputId = inputId.replace('Make', 'Model');
      
      input.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        
        // Show dropdown on focus with some content even without typing
        const matches = val.length < 1 
          ? allMakes.slice(0, 15) 
          : allMakes.filter(m => m.toLowerCase().startsWith(val)).concat(
              allMakes.filter(m => m.toLowerCase().includes(val) && !m.toLowerCase().startsWith(val))
            ).slice(0, 15);
        
        if (matches.length === 0) {
          dropdown.style.display = 'none';
          return;
        }
        
        const hoverBg = isDarkTheme ? '#334155' : '#f1f5f9';
        const normalBg = isDarkTheme ? '#1e293b' : 'white';
        
        dropdown.innerHTML = matches.map(m => {
          const highlighted = val.length > 0 ? m.replace(new RegExp('(' + val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi'), '<strong>$1</strong>') : m;
          return '<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid ' + (isDarkTheme ? '#475569' : '#f1f5f9') + ';font-size:14px" onmouseover="this.style.background=\'' + hoverBg + '\'" onmouseout="this.style.background=\'' + normalBg + '\'" onclick="selectMakeFor(\'' + inputId + '\', \'' + modelInputId + '\', \'' + m.replace(/'/g, "\\'") + '\')">' + highlighted + '</div>';
        }).join('');
        dropdown.style.display = 'block';
      });
      
      input.addEventListener('focus', function() {
        this.dispatchEvent(new Event('input'));
      });
      
      input.addEventListener('blur', function() {
        setTimeout(() => { dropdown.style.display = 'none'; }, 200);
      });
    }
    
    function selectMakeFor(makeInputId, modelInputId, make) {
      document.getElementById(makeInputId).value = make;
      document.getElementById(makeInputId + '-dropdown').style.display = 'none';
      // Clear and focus model field
      const modelInput = document.getElementById(modelInputId);
      if (modelInput) {
        modelInput.value = '';
        modelInput.focus();
      }
    }
    
    // Keep old function for backward compatibility
    function selectMake(make) {
      selectMakeFor('vehMake', 'vehModel', make);
    }
    
    function setupModelAutocomplete(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      
      // Determine the corresponding make input ID
      const makeInputId = inputId.replace('Model', 'Make');
      
      let dropdown = document.getElementById(inputId + '-dropdown');
      if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = inputId + '-dropdown';
        const dropBg = isDarkTheme ? '#1e293b' : 'white';
        const dropBorder = isDarkTheme ? '#475569' : '#d1d5db';
        dropdown.style.cssText = 'position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:' + dropBg + ';border:1px solid ' + dropBorder + ';border-top:none;border-radius:0 0 8px 8px;z-index:1000;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.1)';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(dropdown);
      }
      
      const hoverBg = isDarkTheme ? '#334155' : '#f1f5f9';
      const normalBg = isDarkTheme ? '#1e293b' : 'white';
      const borderColor = isDarkTheme ? '#475569' : '#f1f5f9';
      
      input.addEventListener('input', function() {
        const makeInput = document.getElementById(makeInputId);
        const make = makeInput ? makeInput.value : '';
        const val = this.value.toLowerCase();
        
        let models = [];
        if (make && vehicleMakes[make]) {
          models = vehicleMakes[make];
        } else {
          // If no make selected, search all models
          Object.values(vehicleMakes).forEach(m => models = models.concat(m));
          models = [...new Set(models)].sort();
        }
        
        // Show models even with no input if make is selected
        let matches;
        if (val.length < 1) {
          if (make && vehicleMakes[make]) {
            matches = vehicleMakes[make].slice(0, 15);
          } else {
            dropdown.style.display = 'none';
            return;
          }
        } else {
          // Prioritize starts-with matches
          matches = models.filter(m => m.toLowerCase().startsWith(val)).concat(
            models.filter(m => m.toLowerCase().includes(val) && !m.toLowerCase().startsWith(val))
          ).slice(0, 15);
        }
        
        if (matches.length === 0) {
          dropdown.style.display = 'none';
          return;
        }
        
        dropdown.innerHTML = matches.map(m => {
          const highlighted = val.length > 0 ? m.replace(new RegExp('(' + val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi'), '<strong>$1</strong>') : m;
          return '<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid ' + borderColor + ';font-size:14px" onmouseover="this.style.background=\'' + hoverBg + '\'" onmouseout="this.style.background=\'' + normalBg + '\'" onclick="document.getElementById(\'' + inputId + '\').value=\'' + m.replace(/'/g, "\\'") + '\';this.parentElement.style.display=\'none\'">' + highlighted + '</div>';
        }).join('');
        dropdown.style.display = 'block';
      });
      
      input.addEventListener('focus', function() {
        this.dispatchEvent(new Event('input'));
      });
      
      input.addEventListener('blur', function() {
        setTimeout(() => { dropdown.style.display = 'none'; }, 200);
      });
    }
    
    function addAnotherVehicle() {
      const year = document.getElementById('vehYear').value;
      const make = document.getElementById('vehMake').value.trim();
      const model = document.getElementById('vehModel').value.trim();
      
      if (!make) {
        showToast('Please enter vehicle make first', 'error');
        return;
      }
      
      vehicleList.push({
        year: parseInt(year) || new Date().getFullYear(),
        make: make,
        model: model,
        makeModel: make + (model ? ' ' + model : '')
      });
      
      // Clear input for next vehicle
      document.getElementById('vehMake').value = '';
      document.getElementById('vehModel').value = '';
      document.getElementById('vehYear').value = new Date().getFullYear();
      
      updateVehicleListDisplay();
      showToast('Vehicle added - add more or click Save');
    }
    
    function removeVehicleFromList(index) {
      vehicleList.splice(index, 1);
      updateVehicleListDisplay();
    }
    
    function updateVehicleListDisplay() {
      const section = document.getElementById('vehicleListSection');
      const container = document.getElementById('vehicleListItems');
      
      if (!container) return;
      
      if (vehicleList.length === 0) {
        section.style.display = 'none';
        return;
      }
      
      section.style.display = 'block';
      
      container.innerHTML = '<div style="background:#e0e7ff;padding:8px 12px;border-radius:6px;margin-bottom:8px;font-weight:600;font-size:13px;color:#4338ca">ðŸ“¦ Vehicles in this order: ' + vehicleList.length + '</div>' +
        vehicleList.map((v, i) => {
        return '<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:white;border-radius:6px;margin-bottom:6px;border:1px solid #e2e8f0">' +
          '<div style="display:flex;align-items:center;gap:10px">' +
          '<span style="background:#6366f1;color:white;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:11px">' + (i + 1) + '</span>' +
          '<span style="font-size:13px"><strong>' + v.year + ' ' + v.makeModel + '</strong></span></div>' +
          '<button onclick="removeVehicleFromList(' + i + ')" style="background:#fee2e2;color:#dc2626;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px">âœ•</button></div>';
      }).join('');
    }
    
    function toggleSplitPayment() {
      const payType = document.getElementById('orderPay').value;
      const splitSection = document.getElementById('splitPaymentSection');
      if (payType === 'SPLIT') {
        splitSection.style.display = 'block';
        updatePaymentSplit();
      } else {
        splitSection.style.display = 'none';
      }
    }
    
    function updatePaymentSplit() {
      const totalRev = parseFloat(document.getElementById('orderRev').value) || 0;
      const codAmount = parseFloat(document.getElementById('splitCodAmount')?.value) || 0;
      const billAmountEl = document.getElementById('splitBillAmount');
      if (billAmountEl) {
        billAmountEl.value = Math.max(0, totalRev - codAmount);
      }
    }
    
    function updateSplitBill() {
      const totalRev = parseFloat(document.getElementById('orderRev').value) || 0;
      const codAmount = parseFloat(document.getElementById('splitCodAmount').value) || 0;
      document.getElementById('splitBillAmount').value = Math.max(0, totalRev - codAmount);
    }

    async function saveVehicle(tripId) {
      let brokerId = null;
      let brokerName = null;
      
      const brokerIdField = document.getElementById('orderBrokerId');
      const brokerInputField = document.getElementById('orderBrokerInput');
      
      // Check if adding new broker
      if (brokerIdField.value === '__NEW__') {
        const newName = document.getElementById('newBrokerName').value.trim();
        if (!newName) {
          showToast('Please enter broker name', 'error');
          return;
        }
        
        // Create new broker
        try {
          const newBroker = await dbInsert('brokers', { name: newName });
          brokerId = newBroker.id;
          brokerName = newName;
          showToast('Broker "' + newName + '" added!');
          // Reload brokers
          appData.brokers = await dbFetch('brokers', { order: 'name' });
        } catch (e) {
          showToast('Failed to create broker: ' + e.message, 'error');
          return;
        }
      } else if (brokerIdField.value) {
        brokerId = parseInt(brokerIdField.value) || null;
        const broker = brokerId ? appData.brokers.find(b => b.id === brokerId) : null;
        brokerName = broker ? broker.name : null;
      } else if (brokerInputField.value.trim()) {
        // User typed a name but didn't select - try to find match or create new
        const typedName = brokerInputField.value.trim();
        const existingBroker = appData.brokers.find(b => b.name.toLowerCase() === typedName.toLowerCase());
        if (existingBroker) {
          brokerId = existingBroker.id;
          brokerName = existingBroker.name;
        } else {
          // Create new broker
          try {
            const newBroker = await dbInsert('brokers', { name: typedName });
            brokerId = newBroker.id;
            brokerName = typedName;
            showToast('Broker "' + typedName + '" added!');
            appData.brokers = await dbFetch('brokers', { order: 'name' });
          } catch (e) {
            showToast('Failed to create broker: ' + e.message, 'error');
            return;
          }
        }
      }
      
      // Get shared order info
      const orderNum = document.getElementById('orderNum').value;
      const origin = document.getElementById('orderOrigin').value;
      const destination = document.getElementById('orderDest').value;
      const pickupDate = document.getElementById('orderPickup').value || null;
      const dropoffDate = document.getElementById('orderDropoff').value || null;
      const brokerFee = parseFloat(document.getElementById('orderBrokerFee').value) || 0;
      const localFee = parseFloat(document.getElementById('orderFee').value) || 0;
      const status = document.getElementById('orderStatus').value;
      const dispatcherId = parseInt(document.getElementById('orderDispatcher').value) || null;
      const direction = document.getElementById('orderDirection').value;
      const dispatcherNotes = document.getElementById('orderNotes').value || null;
      
      // Get phone numbers and full addresses
      const pickupPhone = document.getElementById('pickupPhone')?.value || null;
      const deliveryPhone = document.getElementById('deliveryPhone')?.value || null;
      const pickupFullAddress = document.getElementById('pickupFullAddress')?.value || null;
      const deliveryFullAddress = document.getElementById('deliveryFullAddress')?.value || null;
      
      // Handle payment type (including split)
      let paymentType = document.getElementById('orderPay').value;
      let codAmount = 0;
      let billAmount = 0;
      const totalRevenue = parseFloat(document.getElementById('orderRev').value) || 0;
      
      if (paymentType === 'SPLIT') {
        codAmount = parseFloat(document.getElementById('splitCodAmount').value) || 0;
        billAmount = totalRevenue - codAmount;
        const codType = document.getElementById('splitCodType').value;
        paymentType = codType; // Store as COD or COP, the split amounts tell the story
      }
      
      // Check if there's a current vehicle in the form that hasn't been added to list
      const currentMake = document.getElementById('vehMake').value.trim();
      const currentModel = document.getElementById('vehModel').value.trim();
      
      if (currentMake) {
        // Add the current form vehicle to list
        const year = document.getElementById('vehYear').value;
        
        vehicleList.push({
          year: parseInt(year) || new Date().getFullYear(),
          make: currentMake,
          model: currentModel,
          makeModel: currentMake + (currentModel ? ' ' + currentModel : '')
        });
      }
      
      // Validate we have at least one vehicle
      if (vehicleList.length === 0) {
        showToast('Please enter vehicle info', 'error');
        return;
      }
      
      try {
        const vehicleCount = vehicleList.length;
        const orderGroupId = orderNum; // Group all vehicles under same order number
        
        // Revenue/fees apply to the ORDER as a whole, stored on first vehicle only
        // This ensures total order revenue is NOT multiplied by vehicle count
        
        // Save each vehicle - revenue/fees only on FIRST vehicle (shared for entire order)
        for (let i = 0; i < vehicleCount; i++) {
          const v = vehicleList[i];
          const vehicleOrderNum = vehicleCount > 1 ? orderNum + '-' + (i + 1) : orderNum;
          
          const data = {
            trip_id: tripId,
            order_number: vehicleOrderNum,
            order_group_id: orderGroupId,
            broker_id: brokerId,
            broker_name: brokerName,
            vehicle_year: v.year,
            vehicle_make: v.make,
            vehicle_model: v.model,
            origin: origin,
            destination: destination,
            pickup_date: pickupDate,
            dropoff_date: dropoffDate,
            pickup_phone: pickupPhone,
            delivery_phone: deliveryPhone,
            pickup_full_address: pickupFullAddress,
            delivery_full_address: deliveryFullAddress,
            revenue: i === 0 ? totalRevenue : 0, // Only first vehicle gets total order revenue
            broker_fee: i === 0 ? brokerFee : 0, // Only first vehicle gets broker fee
            local_fee: i === 0 ? localFee : 0, // Only first vehicle gets local fee
            payment_type: paymentType,
            cod_amount: i === 0 ? codAmount : 0,
            bill_amount: i === 0 ? billAmount : 0,
            status: status,
            dispatcher_id: dispatcherId,
            vehicle_direction: direction,
            dispatcher_notes: dispatcherNotes
          };
          
          const newOrder = await dbInsert('orders', data);
          await logActivity('VEHICLE_ADDED', { 
            order_id: newOrder.id, 
            trip_id: tripId, 
            vehicle: v.year + ' ' + v.make + ' ' + v.model, 
            origin: origin, 
            destination: destination, 
            revenue: i === 0 ? totalRevenue : 0,
            broker: brokerName 
          });
        }
        
        document.querySelector('.modal-overlay').remove();
        showToast(vehicleCount + ' vehicle' + (vehicleCount > 1 ? 's' : '') + ' added! Order total: $' + totalRevenue);
        vehicleList = [];
        await loadAllData(true); // Force refresh to get new orders
        viewTrip(tripId);
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    async function removeOrder(orderId, tripId) { 
      if (!confirm('Remove?')) return; 
      const order = appData.orders.find(o => o.id === orderId);
      await dbUpdate('orders', orderId, { trip_id: null }); 
      await logActivity('VEHICLE_REMOVED_FROM_TRIP', { order_id: orderId, trip_id: tripId, vehicle: order?.vehicle_year + ' ' + order?.vehicle_make + ' ' + order?.vehicle_model });
      showToast('Removed'); await loadAllData(true); viewTrip(tripId); 
    }

    function openEditVehicle(orderId, tripId) {
      const o = appData.orders.find(x => x.id === orderId);
      const brokerOptions = (appData.brokers || []).map(b => '<option value="' + b.id + '"' + (o.broker_id === b.id ? ' selected' : '') + '>' + b.name + '</option>').join('');
      const directionOptions = vehicleDirections.map(d => '<option value="' + d.id + '"' + (o.vehicle_direction === d.id ? ' selected' : '') + '>' + d.label + '</option>').join('');
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      const currentDispatcher = appData.dispatchers.find(d => d.id === o.dispatcher_id);
      const dispatcherField = (currentUser.role === 'ADMIN' || currentUser.role === 'MANAGER') ?
        '<select id="editOrderDispatcher"><option value="">Select Dispatcher</option>' + appData.dispatchers.map(d => '<option value="' + d.id + '"' + (o.dispatcher_id === d.id ? ' selected' : '') + '>' + d.name + '</option>').join('') + '</select>' :
        '<input type="text" value="' + (currentDispatcher ? currentDispatcher.name : '-') + '" readonly style="background:#f1f5f9;cursor:not-allowed"><input type="hidden" id="editOrderDispatcher" value="' + (o.dispatcher_id || '') + '">';
      m.innerHTML = '<div class="modal" style="max-width:700px;max-height:90vh;display:flex;flex-direction:column"><div class="modal-header"><h3>Edit Vehicle</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body" style="overflow-y:auto;flex:1">' +
        '<div class="form-group"><label>Vehicle Direction *</label><select id="editOrderDirection" style="border:2px solid #22c55e;font-weight:600">' + directionOptions + '</select></div>' +
        '<div class="form-row"><div class="form-group"><label>Order #</label><input id="editOrderNum" value="' + o.order_number + '"></div><div class="form-group"><label>Broker</label><select id="editOrderBroker"><option value="">Select Broker</option>' + brokerOptions + '<option value="__NEW__">+ Add New Broker</option></select></div></div>' +
        '<div id="editNewBrokerSection" style="display:none;background:#f0fdf4;padding:12px;border-radius:8px;margin-bottom:12px;border:1px solid #bbf7d0"><div class="form-group" style="margin-bottom:0"><label>New Broker Name *</label><input id="editNewBrokerName" placeholder="Enter broker name"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Year</label><input type="number" id="editVehYear" value="' + o.vehicle_year + '"></div><div class="form-group"><label>Make</label><input id="editVehMake" value="' + o.vehicle_make + '"></div></div>' +
        '<div class="form-group"><label>Model</label><input id="editVehModel" value="' + o.vehicle_model + '"></div>' +
        
        // Pickup Section
        '<div style="background:#dbeafe;padding:12px;border-radius:8px;margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px">ðŸ“ PICKUP</label>' +
        '<div class="form-row" style="gap:12px">' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>City/State</label><input type="text" id="editOrderOrigin" value="' + (o.origin || '') + '" placeholder="City, State" autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:0 0 140px"><label>ðŸ“ž Phone</label><input type="tel" id="editPickupPhone" value="' + (o.pickup_phone || '') + '" placeholder="(555) 123-4567"></div></div>' +
        '<div class="form-group" style="margin-bottom:0;margin-top:8px;position:relative"><label>Full Address</label><input type="text" id="editPickupFullAddress" value="' + (o.pickup_full_address || '') + '" placeholder="Full street address" autocomplete="off"></div></div>' +
        
        // Delivery Section
        '<div style="background:#d1fae5;padding:12px;border-radius:8px;margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px">ðŸ DELIVERY</label>' +
        '<div class="form-row" style="gap:12px">' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>City/State</label><input type="text" id="editOrderDest" value="' + (o.destination || '') + '" placeholder="City, State" autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:0 0 140px"><label>ðŸ“ž Phone</label><input type="tel" id="editDeliveryPhone" value="' + (o.delivery_phone || '') + '" placeholder="(555) 123-4567"></div></div>' +
        '<div class="form-group" style="margin-bottom:0;margin-top:8px;position:relative"><label>Full Address</label><input type="text" id="editDeliveryFullAddress" value="' + (o.delivery_full_address || '') + '" placeholder="Full street address" autocomplete="off"></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Pick-Up Date</label><input type="date" id="editOrderPickup" value="' + (o.pickup_date || '') + '"></div><div class="form-group"><label>Drop-Off Date</label><input type="date" id="editOrderDropoff" value="' + (o.dropoff_date || '') + '"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Revenue $</label><input type="number" id="editOrderRev" value="' + o.revenue + '"></div><div class="form-group"><label>Broker Fee $</label><input type="number" id="editOrderBrokerFee" value="' + (o.broker_fee || 0) + '"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Local Fee $</label><input type="number" id="editOrderFee" value="' + (o.local_fee || 0) + '"></div><div class="form-group"><label>Payment</label><select id="editOrderPay"><option' + (o.payment_type === 'BILL' ? ' selected' : '') + '>BILL</option><option' + (o.payment_type === 'COD' ? ' selected' : '') + '>COD</option><option' + (o.payment_type === 'COP' ? ' selected' : '') + '>COP</option><option' + (o.payment_type === 'CHECK' ? ' selected' : '') + '>CHECK</option><option' + (o.payment_type === 'LOCAL_COD' ? ' selected' : '') + '>LOCAL_COD</option></select></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Status</label><select id="editOrderStatus"><option' + (o.status === 'PENDING' ? ' selected' : '') + '>PENDING</option><option' + (o.status === 'IN_TRANSIT' ? ' selected' : '') + '>IN_TRANSIT</option><option' + (o.status === 'DELIVERED' ? ' selected' : '') + '>DELIVERED</option></select></div><div class="form-group"><label>Booked By</label>' + dispatcherField + '</div></div>' +
        '<div class="form-group"><label>ðŸ“ Notes for Dispatchers</label><textarea id="editOrderNotes" rows="2" placeholder="Add notes visible to all dispatchers..." style="resize:vertical">' + (o.dispatcher_notes || '') + '</textarea></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="updateVehicle(' + orderId + ',' + tripId + ')">Save</button></div></div>';
      document.body.appendChild(m);
      
      // Setup location autocomplete
      setupLocationAutocomplete('editOrderOrigin');
      setupLocationAutocomplete('editOrderDest');
      setupAddressAutocomplete('editPickupFullAddress');
      setupAddressAutocomplete('editDeliveryFullAddress');
      
      // Handle broker selection change
      document.getElementById('editOrderBroker').addEventListener('change', function() {
        const newBrokerSection = document.getElementById('editNewBrokerSection');
        if (this.value === '__NEW__') {
          newBrokerSection.style.display = 'block';
        } else {
          newBrokerSection.style.display = 'none';
        }
      });
    }

    async function updateVehicle(orderId, tripId) {
      let brokerId = null;
      let brokerName = null;
      
      const brokerSelect = document.getElementById('editOrderBroker');
      
      // Check if adding new broker
      if (brokerSelect.value === '__NEW__') {
        const newName = document.getElementById('editNewBrokerName').value.trim();
        if (!newName) {
          showToast('Please enter broker name', 'error');
          return;
        }
        
        // Create new broker
        try {
          const newBroker = await dbInsert('brokers', { name: newName });
          brokerId = newBroker.id;
          brokerName = newName;
          showToast('Broker "' + newName + '" added!');
        } catch (e) {
          showToast('Failed to create broker: ' + e.message, 'error');
          return;
        }
      } else {
        brokerId = parseInt(brokerSelect.value) || null;
        const broker = brokerId ? appData.brokers.find(b => b.id === brokerId) : null;
        brokerName = broker ? broker.name : null;
      }
      
      const data = { 
        order_number: document.getElementById('editOrderNum').value, 
        broker_id: brokerId, 
        broker_name: brokerName, 
        vehicle_year: parseInt(document.getElementById('editVehYear').value), 
        vehicle_make: document.getElementById('editVehMake').value, 
        vehicle_model: document.getElementById('editVehModel').value, 
        origin: document.getElementById('editOrderOrigin').value, 
        destination: document.getElementById('editOrderDest').value, 
        pickup_phone: document.getElementById('editPickupPhone')?.value || null,
        delivery_phone: document.getElementById('editDeliveryPhone')?.value || null,
        pickup_full_address: document.getElementById('editPickupFullAddress')?.value || null,
        delivery_full_address: document.getElementById('editDeliveryFullAddress')?.value || null,
        pickup_date: document.getElementById('editOrderPickup').value || null, 
        dropoff_date: document.getElementById('editOrderDropoff').value || null, 
        revenue: parseFloat(document.getElementById('editOrderRev').value) || 0, 
        broker_fee: parseFloat(document.getElementById('editOrderBrokerFee').value) || 0, 
        local_fee: parseFloat(document.getElementById('editOrderFee').value) || 0, 
        payment_type: document.getElementById('editOrderPay').value, 
        status: document.getElementById('editOrderStatus').value, 
        dispatcher_id: parseInt(document.getElementById('editOrderDispatcher').value) || null, 
        vehicle_direction: document.getElementById('editOrderDirection').value, 
        dispatcher_notes: document.getElementById('editOrderNotes').value || null 
      };
      try { 
        await dbUpdate('orders', orderId, data); 
        await logActivity('VEHICLE_UPDATED', { order_id: orderId, trip_id: tripId, vehicle: data.vehicle_year + ' ' + data.vehicle_make + ' ' + data.vehicle_model, revenue: data.revenue, status: data.status });
        document.querySelector('.modal-overlay').remove(); showToast('Vehicle updated'); await loadAllData(true); viewTrip(tripId); 
      } catch (e) { showToast('Update failed: ' + e.message, 'error'); console.error(e); }
    }

    function openAddExpense(tripId) {
      const m = document.createElement('div'); 
      m.className = 'modal-overlay'; 
      m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:450px"><div class="modal-header"><h3>Add Expense</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body"><div class="form-row"><div class="form-group"><label>Category</label><select id="expCat"><option>FUEL</option><option>TOLLS</option><option>PERMITS</option><option>PARKING</option><option>MAINTENANCE</option><option>OTHER</option></select></div><div class="form-group"><label>Amount $</label><input type="number" id="expAmt" step="0.01" placeholder="0.00"></div></div><div class="form-group"><label>Description</label><input id="expDesc" placeholder="e.g., Diesel - Newark"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveExpense(' + tripId + ')">Add Expense</button></div></div>';
      document.body.appendChild(m);
    }

    function previewExpenseReceipt(input) {
      const preview = document.getElementById('expReceiptPreview');
      if (input.files && input.files[0]) {
        const file = input.files[0];
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = e => {
            preview.innerHTML = '<img src="' + e.target.result + '" style="max-width:100%;max-height:150px;border-radius:8px;border:1px solid var(--border)">';
          };
          reader.readAsDataURL(file);
        } else {
          preview.innerHTML = '<div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;display:flex;align-items:center;gap:8px"><span>ðŸ“„</span> ' + file.name + '</div>';
        }
      } else {
        preview.innerHTML = '';
      }
    }

    async function saveExpense(tripId) {
      // Get form values
      const amtValue = document.getElementById('expAmt')?.value;
      const amount = parseFloat(amtValue) || 0;
      
      // Validate amount
      if (amount <= 0) {
        showToast('Please enter a valid amount', 'error');
        return;
      }
      
      // Show saving indicator
      showToast('Saving expense...');
      
      try {
        const expenseData = { 
          trip_id: tripId, 
          category: document.getElementById('expCat')?.value || 'OTHER', 
          amount: amount, 
          description: document.getElementById('expDesc')?.value || null, 
          expense_date: new Date().toISOString().split('T')[0]
        };
        
        const newExpense = await dbInsert('expenses', expenseData);
        await logActivity('EXPENSE_CREATED', { expense_id: newExpense.id, trip_id: tripId, category: expenseData.category, amount: expenseData.amount });
        
        // Close modal
        document.querySelector('.modal-overlay')?.remove();
        
        showToast('Expense added!'); 
        await loadAllData(true); 
        viewTrip(tripId);
      } catch (e) {
        console.error('Save expense error:', e);
        showToast('Error: ' + (e.message || 'Could not save expense'), 'error');
      }
    }

    async function deleteExpense(id, tripId) { 
      if (!confirm('Delete?')) return; 
      const expense = appData.expenses.find(e => e.id === id);
      await dbDelete('expenses', id); 
      await logActivity('EXPENSE_DELETED', { expense_id: id, trip_id: tripId, category: expense?.category, amount: expense?.amount });
      showToast('Deleted'); await loadAllData(true); viewTrip(tripId); 
    }

    let selectedOrders = [];

    let ordersFilter = { search: '', status: 'all', broker: 'all' };
    
    // Debounced search functions
    const debouncedOrderSearch = debounce((value) => {
      ordersFilter.search = value;
      renderOrders(document.getElementById('main-content'));
    }, 300);
    
    const debouncedTripSearch = debounce((value) => {
      tripsSearch = value;
      renderTrips(document.getElementById('main-content'));
    }, 300);
    
    const debouncedMaintenanceSearch = debounce((value) => {
      maintenanceSearch = value;
      renderMaintenance(document.getElementById('main-content'));
    }, 300);
    
    let tripsSearch = '';
    let maintenanceSearch = '';
    
    function renderOrders(c) {
      selectedOrders = [];
      
      // Sort orders by ID descending (newest first)
      let filteredOrders = [...appData.orders].sort((a, b) => b.id - a.id);
      
      // Apply search filter
      if (ordersFilter.search) {
        const searchLower = ordersFilter.search.toLowerCase();
        filteredOrders = filteredOrders.filter(o => 
          (o.order_number && o.order_number.toLowerCase().includes(searchLower)) ||
          (o.broker_name && o.broker_name.toLowerCase().includes(searchLower)) ||
          (o.vehicle_make && o.vehicle_make.toLowerCase().includes(searchLower)) ||
          (o.vehicle_model && o.vehicle_model.toLowerCase().includes(searchLower))
        );
      }
      
      // Apply status filter
      if (ordersFilter.status !== 'all') {
        filteredOrders = filteredOrders.filter(o => o.status === ordersFilter.status);
      }
      
      // Apply broker filter
      if (ordersFilter.broker !== 'all') {
        filteredOrders = filteredOrders.filter(o => o.broker_name === ordersFilter.broker);
      }
      
      // Get unique brokers for filter
      const uniqueBrokers = [...new Set(appData.orders.map(o => o.broker_name).filter(b => b))];
      const brokerOptions = uniqueBrokers.map(b => '<option value="' + b + '"' + (ordersFilter.broker === b ? ' selected' : '') + '>' + b + '</option>').join('');
      
      c.innerHTML = '<div class="header"><h2>Vehicles / Orders</h2><div style="display:flex;gap:12px"><button class="btn btn-secondary" onclick="exportOrders()">ðŸ“¥ ' + 'Export' + '</button><button class="btn btn-primary" onclick="openOrderModal()">+ New Order</button><button class="btn btn-secondary" id="bulkDeleteBtn" style="display:none;background:#fee2e2;color:#dc2626;border-color:#fecaca" onclick="bulkDeleteOrders()">ðŸ—‘ï¸ Delete Selected (<span id="selectedCount">0</span>)</button></div></div>' +
        
        // Search and Filters
        '<div style="display:flex;gap:16px;margin-bottom:20px;flex-wrap:wrap;align-items:center;background:#f8fafc;padding:16px;border-radius:8px">' +
        '<div style="flex:1;min-width:200px"><input type="text" id="orderSearch" placeholder="ðŸ” Search by Order ID, Broker, or Vehicle..." value="' + ordersFilter.search + '" oninput="debouncedOrderSearch(this.value)" style="width:100%;padding:10px 14px;border:1px solid #e2e8f0;border-radius:6px;font-size:14px"></div>' +
        '<div style="display:flex;align-items:center;gap:8px"><label style="font-weight:600;color:#475569">Status:</label><select onchange="ordersFilter.status=this.value;renderOrders(document.getElementById(\'main-content\'))" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:14px"><option value="all"' + (ordersFilter.status === 'all' ? ' selected' : '') + '>All</option><option value="PENDING"' + (ordersFilter.status === 'PENDING' ? ' selected' : '') + '>Pending</option><option value="IN_TRANSIT"' + (ordersFilter.status === 'IN_TRANSIT' ? ' selected' : '') + '>In Transit</option><option value="DELIVERED"' + (ordersFilter.status === 'DELIVERED' ? ' selected' : '') + '>Delivered</option></select></div>' +
        '<div style="display:flex;align-items:center;gap:8px"><label style="font-weight:600;color:#475569">Broker:</label><select onchange="ordersFilter.broker=this.value;renderOrders(document.getElementById(\'main-content\'))" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:14px"><option value="all"' + (ordersFilter.broker === 'all' ? ' selected' : '') + '>All Brokers</option>' + brokerOptions + '</select></div>' +
        '<button class="btn btn-secondary" style="padding:8px 16px" onclick="ordersFilter={search:\'\',status:\'all\',broker:\'all\'};renderOrders(document.getElementById(\'main-content\'))">Clear</button>' +
        '<span style="color:#64748b;font-size:13px">Showing ' + filteredOrders.length + ' of ' + appData.orders.length + '</span>' +
        '</div>' +
        
        '<div class="card"><div class="table-wrapper"><table><thead><tr><th style="width:40px"><input type="checkbox" id="selectAllOrders" onchange="toggleSelectAllOrders(this.checked)"></th><th>Order</th><th>Trip</th><th>Driver</th><th>Broker</th><th>Vehicle</th><th>Origin</th><th>Destination</th><th>ðŸ“ž</th><th>Pick-Up</th><th>Delivery</th><th>Payment</th><th>Broker Fee</th><th>Local Fee</th><th>Revenue</th><th>Status</th><th class="sticky-col">Actions</th></tr></thead><tbody>' + 
        (filteredOrders.length === 0 ? '<tr><td colspan="18" style="text-align:center;padding:40px">No orders found</td></tr>' : 
        filteredOrders.map(o => { 
          const t = appData.trips.find(x => x.id === o.trip_id);
          const driver = t ? appData.drivers.find(d => d.id === t.driver_id) : null;
          const driverName = driver ? driver.first_name.charAt(0) + '. ' + driver.last_name : '-';
          const phoneInfo = (o.pickup_phone || o.delivery_phone) ? '<span title="P: ' + (o.pickup_phone || '-') + '&#10;D: ' + (o.delivery_phone || '-') + '" style="cursor:help">ðŸ“ž</span>' : '-';
          const noteHtml = o.dispatcher_notes ? '<tr style="background:#fef3c7"><td></td><td colspan="17" style="padding:8px 16px;font-size:13px"><span style="font-weight:600;color:#92400e">ðŸ“ Note:</span> ' + o.dispatcher_notes + '</td></tr>' : '';
          return '<tr><td><input type="checkbox" class="order-checkbox" data-id="' + o.id + '" onchange="toggleOrderSelection(' + o.id + ')"></td><td><strong>' + o.order_number + '</strong></td><td>' + (t ? '<span class="badge badge-purple">' + t.trip_number + '</span>' : '<span style="color:#94a3b8">Unassigned</span>') + '</td><td>' + (driver ? '<span class="badge badge-green">' + driverName + '</span>' : '<span style="color:#94a3b8">-</span>') + '</td><td>' + (o.broker_name || '-') + '</td><td>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</td><td title="' + (o.pickup_full_address || o.origin || '') + '">' + (o.origin || '-') + '</td><td title="' + (o.delivery_full_address || o.destination || '') + '">' + (o.destination || '-') + '</td><td>' + phoneInfo + '</td><td>' + (o.pickup_date ? formatDate(o.pickup_date) : '-') + '</td><td>' + (o.dropoff_date ? formatDate(o.dropoff_date) : '-') + '</td><td><span class="badge badge-blue">' + (o.payment_type || '-') + '</span></td><td class="money negative">' + formatMoney(o.broker_fee || 0) + '</td><td class="money negative">' + formatMoney(o.local_fee || 0) + '</td><td class="money">' + formatMoney(o.revenue) + '</td><td><span class="badge ' + getBadge(o.status) + '">' + o.status + '</span></td><td class="sticky-col"><div class="actions">' + (o.dispatcher_notes ? '<button class="action-btn" style="background:#fef3c7;color:#92400e" title="' + o.dispatcher_notes.replace(/"/g, '&quot;') + '">ðŸ“</button>' : '') + '<button class="action-btn edit" onclick="openOrderModal(' + o.id + ')">Edit</button><button class="action-btn delete" onclick="deleteOrder(' + o.id + ')">Del</button></div></td></tr>' + noteHtml; 
        }).join('')) + 
        '</tbody></table></div></div>';
    }

    function toggleSelectAllOrders(checked) {
      const checkboxes = document.querySelectorAll('.order-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = checked;
        const id = parseInt(cb.dataset.id);
        if (checked) {
          if (!selectedOrders.includes(id)) selectedOrders.push(id);
        } else {
          selectedOrders = [];
        }
      });
      updateBulkDeleteBtn();
    }

    function toggleOrderSelection(orderId) {
      const idx = selectedOrders.indexOf(orderId);
      if (idx > -1) {
        selectedOrders.splice(idx, 1);
      } else {
        selectedOrders.push(orderId);
      }
      
      // Update select all checkbox
      const checkboxes = document.querySelectorAll('.order-checkbox');
      const selectAll = document.getElementById('selectAllOrders');
      selectAll.checked = selectedOrders.length === checkboxes.length && checkboxes.length > 0;
      
      updateBulkDeleteBtn();
    }

    function updateBulkDeleteBtn() {
      const btn = document.getElementById('bulkDeleteBtn');
      const count = document.getElementById('selectedCount');
      if (selectedOrders.length > 0) {
        btn.style.display = 'inline-block';
        count.textContent = selectedOrders.length;
      } else {
        btn.style.display = 'none';
      }
    }

    async function bulkDeleteOrders() {
      if (selectedOrders.length === 0) return;
      
      if (!confirm('Delete ' + selectedOrders.length + ' selected order(s)?\n\nThis cannot be undone!')) return;
      
      showToast('Deleting ' + selectedOrders.length + ' orders...');
      
      let deleted = 0;
      for (const id of selectedOrders) {
        try {
          await dbDelete('orders', id);
          deleted++;
        } catch (e) {
          console.error('Failed to delete order', id, e);
        }
      }
      
      selectedOrders = [];
      showToast('Deleted ' + deleted + ' orders');
      await loadAllData(true);
      renderOrders(document.getElementById('main-content'));
    }

    function openOrderModal(id = null) {
      const o = id ? appData.orders.find(x => x.id === id) : null;
      // Track editing start time for conflict detection
      if (o) startEditing('orders', id, o.updated_at);
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) { clearEditing('orders', id); m.remove(); } };
      m.innerHTML = '<div class="modal"><div class="modal-header"><h3>' + (o ? 'Edit' : 'New') + ' Order</h3><button class="modal-close" onclick="clearEditing(\'orders\',' + id + ');this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body"><div class="form-row"><div class="form-group"><label>Order #</label><input id="orderNum" value="' + (o?.order_number || 'ORD-' + Date.now().toString().slice(-4)) + '"></div><div class="form-group"><label>Trip</label><select id="orderTrip"><option value="">Unassigned</option>' + appData.trips.map(t => '<option value="' + t.id + '"' + (o?.trip_id === t.id ? ' selected' : '') + '>' + t.trip_number + '</option>').join('') + '</select></div></div><div class="form-group"><label>Broker</label><input id="orderBroker" value="' + (o?.broker_name || '') + '"></div><div class="form-row"><div class="form-group"><label>Year</label><input type="number" id="vehYear" value="' + (o?.vehicle_year || 2024) + '"></div><div class="form-group"><label>Make</label><input id="vehMake" value="' + (o?.vehicle_make || '') + '"></div></div><div class="form-group"><label>Model</label><input id="vehModel" value="' + (o?.vehicle_model || '') + '"></div><div class="form-row"><div class="form-group"><label>Origin</label><input id="orderOrigin" value="' + (o?.origin || '') + '"></div><div class="form-group"><label>Destination</label><input id="orderDest" value="' + (o?.destination || '') + '"></div></div><div class="form-row"><div class="form-group"><label>Revenue $</label><input type="number" id="orderRev" value="' + (o?.revenue || '') + '"></div><div class="form-group"><label>Local Fee $</label><input type="number" id="orderFee" value="' + (o?.local_fee || 0) + '"></div></div><div class="form-row"><div class="form-group"><label>Payment</label><select id="orderPay"><option' + (o?.payment_type === 'BILL' ? ' selected' : '') + '>BILL</option><option' + (o?.payment_type === 'COD' ? ' selected' : '') + '>COD</option><option' + (o?.payment_type === 'COP' ? ' selected' : '') + '>COP</option><option' + (o?.payment_type === 'CHECK' ? ' selected' : '') + '>CHECK</option><option' + (o?.payment_type === 'LOCAL_COD' ? ' selected' : '') + '>LOCAL_COD</option></select></div><div class="form-group"><label>Status</label><select id="orderStatus"><option' + (o?.status === 'PENDING' ? ' selected' : '') + '>PENDING</option><option' + (o?.status === 'IN_TRANSIT' ? ' selected' : '') + '>IN_TRANSIT</option><option' + (o?.status === 'DELIVERED' ? ' selected' : '') + '>DELIVERED</option></select></div></div><div class="form-group"><label>ðŸ“ Notes for Dispatchers</label><textarea id="orderNotes" rows="2" placeholder="Add notes visible to all dispatchers..." style="resize:vertical">' + (o?.dispatcher_notes || '') + '</textarea></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="clearEditing(\'orders\',' + id + ');this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveOrder(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    async function saveOrder(id) {
      const data = { order_number: document.getElementById('orderNum').value, trip_id: parseInt(document.getElementById('orderTrip').value) || null, broker_name: document.getElementById('orderBroker').value || null, vehicle_year: parseInt(document.getElementById('vehYear').value), vehicle_make: document.getElementById('vehMake').value, vehicle_model: document.getElementById('vehModel').value, origin: document.getElementById('orderOrigin').value, destination: document.getElementById('orderDest').value, revenue: parseFloat(document.getElementById('orderRev').value) || 0, local_fee: parseFloat(document.getElementById('orderFee').value) || 0, payment_type: document.getElementById('orderPay').value, status: document.getElementById('orderStatus').value, dispatcher_notes: document.getElementById('orderNotes').value || null };
      try { 
        if (id) { 
          await dbUpdate('orders', id, data); 
          await logActivity('ORDER_UPDATED', { order_id: id, order_number: data.order_number, vehicle: data.vehicle_year + ' ' + data.vehicle_make + ' ' + data.vehicle_model, revenue: data.revenue });
        } else { 
          const newOrder = await dbInsert('orders', data); 
          await logActivity('ORDER_CREATED', { order_id: newOrder.id, order_number: data.order_number, vehicle: data.vehicle_year + ' ' + data.vehicle_make + ' ' + data.vehicle_model, revenue: data.revenue });
        } 
        document.querySelector('.modal-overlay').remove(); showToast('Saved!'); await loadAllData(true); renderOrders(document.getElementById('main-content')); 
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteOrder(id) { 
      if (!confirm('Delete?')) return; 
      const order = appData.orders.find(o => o.id === id);
      await dbDelete('orders', id); 
      await logActivity('ORDER_DELETED', { order_id: id, order_number: order?.order_number });
      showToast('Deleted'); await loadAllData(true); renderOrders(document.getElementById('main-content')); 
    }

    function renderDrivers(c) {
      // Clear detail view flag when going back to drivers list
      currentDetailView = null;
      
      // Check for document expiration alerts
      const today = new Date();
      const alerts = [];
      appData.drivers.forEach(d => {
        const driverFiles = (appData.driver_files || []).filter(f => f.driver_id === d.id && f.expiration_date);
        driverFiles.forEach(f => {
          const expDate = new Date(f.expiration_date);
          const daysUntil = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
          if (daysUntil <= 7 && daysUntil >= 0) {
            alerts.push({ driver: d.first_name + ' ' + d.last_name, doc: f.file_type, days: daysUntil, expired: false });
          } else if (daysUntil < 0) {
            alerts.push({ driver: d.first_name + ' ' + d.last_name, doc: f.file_type, days: Math.abs(daysUntil), expired: true });
          }
        });
      });
      
      const alertsHtml = alerts.length > 0 ? '<div style="background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:16px;margin-bottom:24px"><strong style="color:#dc2626">âš ï¸ Document Expiration Alerts</strong><div style="margin-top:12px">' + alerts.map(a => '<div style="padding:8px;background:white;border-radius:4px;margin-top:8px;display:flex;justify-content:space-between;align-items:center"><span><strong>' + a.driver + '</strong> - ' + a.doc + '</span><span class="badge ' + (a.expired ? 'badge-red' : 'badge-amber') + '">' + (a.expired ? 'EXPIRED ' + a.days + ' days ago' : a.days === 0 ? 'EXPIRES TODAY' : 'Expires in ' + a.days + ' days') + '</span></div>').join('') + '</div></div>' : '';
      
      c.innerHTML = '<div class="header"><h2>ðŸ‘¥ Drivers</h2><button class="btn btn-primary" onclick="openDriverModal()">+ New Driver</button></div>' + alertsHtml + '<div class="drivers-grid">' + (appData.drivers.length === 0 ? '<div style="text-align:center;padding:60px;grid-column:1/-1">No drivers yet</div>' : appData.drivers.map(d => { 
        const trips = appData.trips.filter(t => t.driver_id === d.id); 
        let earn = 0; 
        trips.forEach(t => earn += getTripFin(t.id).driverCut); 
        const driverFiles = (appData.driver_files || []).filter(f => f.driver_id === d.id);
        const qualFiles = driverFiles.filter(f => f.category === 'QUALIFICATION').length;
        const persFiles = driverFiles.filter(f => f.category === 'PERSONAL').length;
        const expiredCount = driverFiles.filter(f => f.expiration_date && new Date(f.expiration_date) < today).length;
        const openTickets = (appData.tickets || []).filter(t => t.driver_id === d.id && !['RESOLVED', 'DISMISSED'].includes(t.status)).length;
        const openViolations = (appData.violations || []).filter(v => v.driver_id === d.id && !['RESOLVED', 'DISMISSED'].includes(v.status)).length;
        const openClaims = (appData.claims || []).filter(c => c.driver_id === d.id && !['SETTLED', 'DENIED'].includes(c.status)).length;
        
        return '<div class="driver-card"><div style="display:flex;align-items:center;gap:12px;margin-bottom:16px"><div class="driver-avatar">' + d.first_name[0] + d.last_name[0] + '</div><div><h4 style="margin:0">' + d.first_name + ' ' + d.last_name + '</h4><p style="color:#64748b;font-size:12px;margin:0">' + d.cut_percent + '% cut</p></div><span class="badge ' + getBadge(d.status) + '" style="margin-left:auto">' + d.status + '</span></div><p style="color:#64748b;font-size:13px">ðŸ“ž ' + d.phone + '</p>' + (d.email ? '<p style="color:#64748b;font-size:13px">ðŸ“§ ' + d.email + '</p>' : '') + '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px"><span style="font-size:11px;background:#dbeafe;color:#1d4ed8;padding:4px 8px;border-radius:4px">ðŸ“ ' + qualFiles + ' Qual</span><span style="font-size:11px;background:#f3e8ff;color:#7c3aed;padding:4px 8px;border-radius:4px">ðŸ”’ ' + persFiles + ' Pers</span>' + (expiredCount > 0 ? '<span style="font-size:11px;background:#fee2e2;color:#dc2626;padding:4px 8px;border-radius:4px">âš ï¸ ' + expiredCount + ' Exp</span>' : '') + (openTickets > 0 ? '<span style="font-size:11px;background:#fef3c7;color:#d97706;padding:4px 8px;border-radius:4px">ðŸŽ« ' + openTickets + '</span>' : '') + (openViolations > 0 ? '<span style="font-size:11px;background:#fce7f3;color:#be185d;padding:4px 8px;border-radius:4px">âš ï¸ ' + openViolations + '</span>' : '') + (openClaims > 0 ? '<span style="font-size:11px;background:#fed7aa;color:#c2410c;padding:4px 8px;border-radius:4px">ðŸ’¥ ' + openClaims + '</span>' : '') + '</div><div style="display:flex;justify-content:space-between;margin-top:16px;padding-top:16px;border-top:1px solid #f1f5f9"><div><div style="font-size:18px;font-weight:700">' + trips.length + '</div><div style="font-size:11px;color:#64748b">Trips</div></div><div><div style="font-size:18px;font-weight:700;color:#10b981">' + formatMoney(earn) + '</div><div style="font-size:11px;color:#64748b">Earnings</div></div><div class="actions"><button class="action-btn view" onclick="viewDriverProfile(' + d.id + ')">View</button><button class="action-btn edit" onclick="openDriverModal(' + d.id + ')">Edit</button></div></div></div>'; 
      }).join('')) + '</div>';
    }

    function viewDriverProfile(driverId) {
      // Mark that we're viewing a driver detail (prevents background re-renders)
      currentDetailView = { type: 'driver', id: driverId };
      
      const d = appData.drivers.find(x => x.id === driverId);
      const trips = appData.trips.filter(t => t.driver_id === driverId);
      let earn = 0; trips.forEach(t => earn += getTripFin(t.id).driverCut);
      const driverFiles = (appData.driver_files || []).filter(f => f.driver_id === driverId);
      const qualFiles = driverFiles.filter(f => f.category === 'QUALIFICATION');
      const persFiles = driverFiles.filter(f => f.category === 'PERSONAL');
      const customFiles = driverFiles.filter(f => f.category === 'CUSTOM');
      const today = new Date();
      
      const qualFileTypes = [
        { type: 'CDL', hasExpiry: true },
        { type: 'MEDICAL_CARD', hasExpiry: true },
        { type: 'MEDICAL_EXAMINER_VERIFICATION', hasExpiry: false },
        { type: 'MVR', hasExpiry: true },
        { type: 'PSP_REPORT', hasExpiry: true },
        { type: 'EMPLOYMENT_VERIFICATION', hasExpiry: false },
        { type: 'APPLICATION_OF_EMPLOYMENT', hasExpiry: false },
        { type: 'CLEARING_HOUSE_QUERY', hasExpiry: false },
        { type: 'DRUG_TEST_RESULT', hasExpiry: false },
        { type: 'CHAIN_OF_CUSTODY', hasExpiry: false }
      ];
      
      const persFileTypes = ['SSN', 'BANKING_INFO', 'W9'];
      
      // Get unique custom folder names
      const customFolders = [...new Set(customFiles.map(f => f.folder_name || 'Uncategorized'))];
      
      const formatFileType = (t) => t.replace(/_/g, ' ');
      
      const getExpiryBadge = (file) => {
        if (!file || !file.expiration_date) return '';
        const expDate = new Date(file.expiration_date);
        const daysUntil = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
        if (daysUntil < 0) return '<span class="badge badge-red">EXPIRED</span>';
        if (daysUntil === 0) return '<span class="badge badge-red">EXPIRES TODAY</span>';
        if (daysUntil <= 3) return '<span class="badge badge-red">Expires in ' + daysUntil + 'd</span>';
        if (daysUntil <= 7) return '<span class="badge badge-amber">Expires in ' + daysUntil + 'd</span>';
        return '<span class="badge badge-green">Valid until ' + formatDate(file.expiration_date) + '</span>';
      };
      
      const c = document.getElementById('main-content');
      c.innerHTML = '<div class="header"><div style="display:flex;align-items:center;gap:16px"><button class="btn btn-secondary" onclick="renderDrivers(document.getElementById(\'main-content\'))">â† Back</button><div class="driver-avatar" style="width:50px;height:50px;font-size:20px">' + d.first_name[0] + d.last_name[0] + '</div><div><h2 style="margin:0">' + d.first_name + ' ' + d.last_name + '</h2><p style="margin:0;color:#64748b">' + d.phone + (d.email ? ' | ' + d.email : '') + '</p></div><span class="badge ' + getBadge(d.status) + '">' + d.status + '</span></div><button class="btn btn-primary" onclick="openDriverModal(' + driverId + ')">âœï¸ Edit Driver</button></div>' +
        
        // Stats
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px"><div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Driver Cut</div><div class="value">' + d.cut_percent + '%</div></div><div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Total Trips</div><div class="value">' + trips.length + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:12px 16px;background:#d1fae5"><div class="label">Total Earnings</div><div class="value" style="color:#059669">' + formatMoney(earn) + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:12px 16px"><div class="label">Qualification Files</div><div class="value">' + qualFiles.length + '/10</div></div><div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Personal Files</div><div class="value">' + persFiles.length + '/3</div></div><div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px;background:#dbeafe"><div class="label">Custom Folders</div><div class="value" style="color:#1d4ed8">' + customFolders.length + '</div></div></div>' +
        
        // Qualification Files Section
        '<div class="card" style="margin-bottom:24px"><div class="card-header" style="background:#1e40af;color:white;border-radius:8px 8px 0 0"><h3 style="margin:0">ðŸ“ Driver Qualification Files (DQ Files)</h3></div><div class="table-wrapper"><table><thead><tr><th>Document Type</th><th>Status</th><th>Expiration</th><th>Uploaded</th><th>Actions</th></tr></thead><tbody>' +
        qualFileTypes.map(ft => {
          const file = qualFiles.find(f => f.file_type === ft.type);
          return '<tr><td><strong>' + formatFileType(ft.type) + '</strong></td><td>' + (file ? '<span class="badge badge-green">âœ“ Uploaded</span>' : '<span class="badge badge-gray">Missing</span>') + '</td><td>' + (ft.hasExpiry ? (file ? getExpiryBadge(file) : '<span style="color:#64748b">-</span>') : '<span style="color:#64748b">N/A</span>') + '</td><td>' + (file ? formatDate(file.created_at) : '-') + '</td><td><div class="actions">' + (file ? '<button class="action-btn view" onclick="viewFile(' + file.id + ')">View</button><button class="action-btn delete" onclick="deleteDriverFile(' + file.id + ',' + driverId + ')">Del</button>' : '<button class="action-btn edit" onclick="openUploadFileModal(' + driverId + ',\'' + ft.type + '\',\'QUALIFICATION\',' + ft.hasExpiry + ')">Upload</button>') + '</div></td></tr>';
        }).join('') +
        '</tbody></table></div></div>' +
        
        // Personal Files Section
        '<div class="card" style="margin-bottom:24px"><div class="card-header" style="background:#7c3aed;color:white;border-radius:8px 8px 0 0"><h3 style="margin:0">ðŸ”’ Driver Personal Files</h3></div><div class="table-wrapper"><table><thead><tr><th>Document Type</th><th>Status</th><th>Uploaded</th><th>Actions</th></tr></thead><tbody>' +
        persFileTypes.map(ft => {
          const file = persFiles.find(f => f.file_type === ft);
          return '<tr><td><strong>' + formatFileType(ft) + '</strong></td><td>' + (file ? '<span class="badge badge-green">âœ“ Uploaded</span>' : '<span class="badge badge-gray">Missing</span>') + '</td><td>' + (file ? formatDate(file.created_at) : '-') + '</td><td><div class="actions">' + (file ? '<button class="action-btn view" onclick="viewFile(' + file.id + ')">View</button><button class="action-btn delete" onclick="deleteDriverFile(' + file.id + ',' + driverId + ')">Del</button>' : '<button class="action-btn edit" onclick="openUploadFileModal(' + driverId + ',\'' + ft + '\',\'PERSONAL\',false)">Upload</button>') + '</div></td></tr>';
        }).join('') +
        '</tbody></table></div></div>' +
        
        // Custom Folders Section
        '<div class="card"><div class="card-header" style="background:#0891b2;color:white;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0">ðŸ“‚ Custom Folders</h3><button class="btn" style="background:white;color:#0891b2;padding:6px 12px;font-size:13px" onclick="openCustomFolderModal(' + driverId + ',\'driver\')">+ New Folder</button></div>' +
        (customFolders.length === 0 ? '<div style="padding:40px;text-align:center;color:#64748b">No custom folders yet. Click "+ New Folder" to create one.</div>' :
        '<div style="padding:16px">' +
        customFolders.map(folder => {
          const folderFiles = customFiles.filter(f => (f.folder_name || 'Uncategorized') === folder);
          return '<div style="margin-bottom:16px;border:1px solid #e5e7eb;border-radius:8px"><div style="background:#f0f9ff;padding:12px 16px;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center"><strong>ðŸ“ ' + folder + ' (' + folderFiles.length + ' files)</strong><button class="action-btn edit" onclick="openCustomFileUpload(' + driverId + ',\'' + folder.replace(/'/g, "\\'") + '\',\'driver\')">+ Add File</button></div>' +
            '<div class="table-wrapper"><table><thead><tr><th>File Name</th><th>Type</th><th>Uploaded</th><th>Notes</th><th>Actions</th></tr></thead><tbody>' +
            folderFiles.map(f => '<tr><td>' + f.file_name + '</td><td>' + (f.file_type || '-') + '</td><td>' + formatDate(f.created_at) + '</td><td>' + (f.notes || '-') + '</td><td><div class="actions"><button class="action-btn view" onclick="viewFile(' + f.id + ')">View</button><button class="action-btn delete" onclick="deleteDriverFile(' + f.id + ',' + driverId + ')">Del</button></div></td></tr>').join('') +
            '</tbody></table></div></div>';
        }).join('') +
        '</div>') +
        '</div>' +
        
        // Tickets & Violations Section
        renderDriverTicketsViolationsSection(driverId);
    }
    
    function renderDriverTicketsViolationsSection(driverId) {
      const driverTickets = (appData.tickets || []).filter(t => t.driver_id === driverId);
      const driverViolations = (appData.violations || []).filter(v => v.driver_id === driverId);
      const driverClaims = (appData.claims || []).filter(c => c.driver_id === driverId);
      const openTickets = driverTickets.filter(t => !['RESOLVED', 'DISMISSED'].includes(t.status)).length;
      const openViolations = driverViolations.filter(v => !['RESOLVED', 'DISMISSED'].includes(v.status)).length;
      const openClaims = driverClaims.filter(c => !['SETTLED', 'DENIED'].includes(c.status)).length;
      const driverFaultPaid = driverClaims.filter(c => c.fault_party === 'DRIVER' && c.status === 'SETTLED')
        .reduce((s, c) => s + parseFloat(c.settlement_amount || c.claim_amount || 0), 0);
      
      return '<div class="card" style="margin-top:24px"><div class="card-header" style="background:#dc2626;color:white;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0">ðŸŽ« Compliance Record</h3><div style="display:flex;gap:8px"><button class="btn" style="background:white;color:#dc2626;padding:6px 12px;font-size:13px" onclick="openTicketModal(null,' + driverId + ')">+ Ticket</button><button class="btn" style="background:white;color:#8b5cf6;padding:6px 12px;font-size:13px" onclick="openViolationModal(null,' + driverId + ')">+ Violation</button><button class="btn" style="background:white;color:#f59e0b;padding:6px 12px;font-size:13px" onclick="openClaimModalForDriver(' + driverId + ')">+ Claim</button></div></div>' +
        
        // Summary badges
        '<div style="padding:16px;background:var(--bg-darker);display:flex;gap:16px;flex-wrap:wrap">' +
        '<div style="display:flex;align-items:center;gap:8px"><span style="font-weight:600">Tickets:</span><span class="badge badge-red">' + openTickets + ' Open</span><span class="badge badge-green">' + (driverTickets.length - openTickets) + ' Closed</span></div>' +
        '<div style="display:flex;align-items:center;gap:8px"><span style="font-weight:600">Violations:</span><span class="badge" style="background:#8b5cf6;color:white">' + openViolations + ' Open</span><span class="badge badge-blue">' + (driverViolations.length - openViolations) + ' Closed</span></div>' +
        '<div style="display:flex;align-items:center;gap:8px"><span style="font-weight:600">Claims:</span><span class="badge badge-amber">' + openClaims + ' Open</span><span class="badge badge-gray">' + (driverClaims.length - openClaims) + ' Closed</span></div>' +
        (driverFaultPaid > 0 ? '<div style="display:flex;align-items:center;gap:8px;margin-left:auto"><span class="badge badge-red" style="font-size:12px">ðŸ’° Driver Fault Paid: ' + formatMoney(driverFaultPaid) + '</span></div>' : '') +
        '</div>' +
        
        // Tickets table
        (driverTickets.length > 0 ? '<div style="padding:16px;border-bottom:1px solid var(--border)"><h4 style="margin:0 0 12px">ðŸŽ« Tickets (' + driverTickets.length + ')</h4>' +
        '<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Description</th><th>Status</th><th>Court Date</th><th>Decision</th><th>Actions</th></tr></thead><tbody>' +
        driverTickets.sort((a, b) => (b.ticket_date || '').localeCompare(a.ticket_date || '')).map(t => 
          '<tr><td>' + (t.ticket_date ? formatDate(t.ticket_date) : '-') + '</td>' +
          '<td style="max-width:200px">' + (t.ticket_description || '-') + '</td>' +
          '<td>' + getTicketStatusBadge(t.status) + '</td>' +
          '<td>' + (t.court_date ? formatDate(t.court_date) : '-') + '</td>' +
          '<td>' + (t.court_decision ? getCourtDecisionBadge(t.court_decision) : '-') + '</td>' +
          '<td><div class="actions"><button class="action-btn edit" onclick="openTicketModal(' + t.id + ')">Edit</button></div></td></tr>'
        ).join('') +
        '</tbody></table></div></div>' : '<div style="padding:16px;border-bottom:1px solid var(--border);color:var(--text-muted)">No tickets on record âœ“</div>') +
        
        // Violations table
        (driverViolations.length > 0 ? '<div style="padding:16px;border-bottom:1px solid var(--border)"><h4 style="margin:0 0 12px">âš ï¸ Violations (' + driverViolations.length + ')</h4>' +
        '<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Type</th><th>Description</th><th>Severity</th><th>Status</th><th>Actions</th></tr></thead><tbody>' +
        driverViolations.sort((a, b) => (b.violation_date || '').localeCompare(a.violation_date || '')).map(v => 
          '<tr><td>' + (v.violation_date ? formatDate(v.violation_date) : '-') + '</td>' +
          '<td>' + getViolationTypeBadge(v.violation_type) + '</td>' +
          '<td style="max-width:200px">' + (v.description || '-') + '</td>' +
          '<td>' + getSeverityBadge(v.severity) + '</td>' +
          '<td>' + getViolationStatusBadge(v.status) + '</td>' +
          '<td><div class="actions"><button class="action-btn edit" onclick="openViolationModal(' + v.id + ')">Edit</button></div></td></tr>'
        ).join('') +
        '</tbody></table></div></div>' : '<div style="padding:16px;border-bottom:1px solid var(--border);color:var(--text-muted)">No violations on record âœ“</div>') +
        
        // Claims table
        (driverClaims.length > 0 ? '<div style="padding:16px"><h4 style="margin:0 0 12px">ðŸ’¥ Claims (' + driverClaims.length + ')</h4>' +
        '<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Type</th><th>Fault</th><th>Amount</th><th>Status</th><th>Actions</th></tr></thead><tbody>' +
        driverClaims.sort((a, b) => (b.incident_date || '').localeCompare(a.incident_date || '')).map(c => 
          '<tr><td>' + (c.incident_date ? formatDate(c.incident_date) : '-') + '</td>' +
          '<td>' + (c.damage_type || '-') + '</td>' +
          '<td>' + getFaultBadge(c.fault_party) + '</td>' +
          '<td class="money">' + formatMoney(c.claim_amount) + '</td>' +
          '<td>' + getClaimStatusBadge(c.status) + '</td>' +
          '<td><div class="actions"><button class="action-btn view" onclick="viewClaim(' + c.id + ')">View</button><button class="action-btn edit" onclick="openClaimModal(' + c.id + ')">Edit</button></div></td></tr>'
        ).join('') +
        '</tbody></table></div></div>' : '<div style="padding:16px;color:var(--text-muted)">No claims on record âœ“</div>') +
        
        '</div>';
    }
    
    function openClaimModalForDriver(driverId) {
      // Pre-select driver when opening claim modal from driver profile
      openClaimModal();
      setTimeout(() => {
        const driverSelect = document.querySelector('select[name="driver_id"]');
        if (driverSelect) driverSelect.value = driverId;
      }, 100);
    }

    function openUploadFileModal(driverId, fileType, category, hasExpiry) {
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:450px"><div class="modal-header"><h3>ðŸ“¤ Upload ' + fileType.replace(/_/g, ' ') + '</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body">' +
        '<div class="form-group"><label>File (PDF, Image, etc.)</label><input type="file" id="fileUpload" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"></div>' +
        '<div class="form-group"><label>Notes (Optional)</label><input id="fileNotes" placeholder="Any additional notes..."></div>' +
        (hasExpiry ? '<div class="form-group"><label>Expiration Date</label><input type="date" id="fileExpiry"></div><div style="background:#fef3c7;padding:12px;border-radius:8px;font-size:13px;color:#92400e">âš ï¸ You will receive reminders at 7 days, 3 days, 1 day, and on expiration date.</div>' : '') +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="uploadDriverFile(' + driverId + ',\'' + fileType + '\',\'' + category + '\',' + hasExpiry + ')">Upload</button></div></div>';
      document.body.appendChild(m);
    }

    async function uploadDriverFile(driverId, fileType, category, hasExpiry) {
      const fileInput = document.getElementById('fileUpload');
      const notes = document.getElementById('fileNotes').value;
      const expiry = hasExpiry ? document.getElementById('fileExpiry').value : null;
      
      if (!fileInput.files || fileInput.files.length === 0) {
        showToast('Please select a file', 'error');
        return;
      }
      
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      reader.onload = async function(e) {
        const fileData = e.target.result; // Base64 data
        
        const data = {
          driver_id: driverId,
          file_type: fileType,
          category: category,
          file_name: file.name,
          file_data: fileData,
          notes: notes || null,
          expiration_date: expiry || null
        };
        
        try {
          await dbInsert('driver_files', data);
          document.querySelector('.modal-overlay').remove();
          showToast('File uploaded successfully!');
          await loadAllData();
          viewDriverProfile(driverId);
        } catch (e) {
          showToast('Upload failed: ' + e.message, 'error');
        }
      };
      
      reader.readAsDataURL(file);
    }

    function viewFile(fileId) {
      const file = appData.driver_files.find(f => f.id === fileId);
      if (!file || !file.file_data) {
        showToast('File not found', 'error');
        return;
      }
      
      // Open file in new tab
      const win = window.open();
      if (file.file_data.startsWith('data:application/pdf') || file.file_data.startsWith('data:image')) {
        win.document.write('<iframe src="' + file.file_data + '" style="width:100%;height:100%;border:none"></iframe>');
      } else {
        // For other files, create download link
        win.document.write('<html><body><h2>' + file.file_name + '</h2><p>File type: ' + file.file_type.replace(/_/g, ' ') + '</p><p>Notes: ' + (file.notes || 'None') + '</p><a href="' + file.file_data + '" download="' + file.file_name + '">Download File</a></body></html>');
      }
    }

    async function deleteDriverFile(fileId, driverId) {
      if (!confirm('Delete this file?')) return;
      try {
        await dbDelete('driver_files', fileId);
        showToast('File deleted');
        await loadAllData();
        viewDriverProfile(driverId);
      } catch (e) {
        showToast('Delete failed: ' + e.message, 'error');
      }
    }
    
    function openCustomFolderModal(entityId, entityType) {
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:400px"><div class="modal-header"><h3>ðŸ“‚ Create New Folder</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body">' +
        '<div class="form-group"><label>Folder Name *</label><input id="folderName" placeholder="e.g., Training Records, Contracts, etc."></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="createCustomFolder(' + entityId + ',\'' + entityType + '\')">Create & Add File</button></div></div>';
      document.body.appendChild(m);
    }
    
    function createCustomFolder(entityId, entityType) {
      const folderName = document.getElementById('folderName').value.trim();
      if (!folderName) { showToast('Please enter folder name', 'error'); return; }
      document.querySelector('.modal-overlay').remove();
      openCustomFileUpload(entityId, folderName, entityType);
    }
    
    function openCustomFileUpload(entityId, folderName, entityType) {
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:450px"><div class="modal-header"><h3>ðŸ“¤ Upload to "' + folderName + '"</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body">' +
        '<div class="form-group"><label>File *</label><input type="file" id="customFileUpload" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.txt"></div>' +
        '<div class="form-group"><label>File Type/Label</label><input id="customFileType" placeholder="e.g., Certificate, Agreement, Report"></div>' +
        '<div class="form-group"><label>Notes (Optional)</label><input id="customFileNotes" placeholder="Any additional notes..."></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="uploadCustomFile(' + entityId + ',\'' + folderName.replace(/'/g, "\\'") + '\',\'' + entityType + '\')">Upload</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function uploadCustomFile(entityId, folderName, entityType) {
      const fileInput = document.getElementById('customFileUpload');
      const fileType = document.getElementById('customFileType').value || 'Custom';
      const notes = document.getElementById('customFileNotes').value;
      
      if (!fileInput.files || fileInput.files.length === 0) {
        showToast('Please select a file', 'error');
        return;
      }
      
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      reader.onload = async function(e) {
        const fileData = e.target.result;
        
        const data = {
          file_type: fileType,
          category: 'CUSTOM',
          folder_name: folderName,
          file_name: file.name,
          file_data: fileData,
          notes: notes || null
        };
        
        if (entityType === 'driver') {
          data.driver_id = entityId;
        } else {
          data.truck_id = entityId;
        }
        
        try {
          const table = entityType === 'driver' ? 'driver_files' : 'truck_files';
          await dbInsert(table, data);
          document.querySelector('.modal-overlay').remove();
          showToast('File uploaded successfully!');
          await loadAllData();
          if (entityType === 'driver') {
            viewDriverProfile(entityId);
          } else {
            viewTruckProfile(entityId);
          }
        } catch (e) {
          showToast('Upload failed: ' + e.message, 'error');
        }
      };
      
      reader.readAsDataURL(file);
    }

    function openDriverModal(id = null) {
      const d = id ? appData.drivers.find(x => x.id === id) : null;
      const states = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];
      const stateOpts = states.map(s => '<option value="' + s + '"' + (d?.cdl_state === s ? ' selected' : '') + '>' + s + '</option>').join('');
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:700px"><div class="modal-header"><h3>' + (d ? 'Edit' : 'New') + ' Driver</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body" style="max-height:75vh;overflow-y:auto">' +
        
        // Basic Info Section
        '<h4 style="margin:0 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)">ðŸ‘¤ Basic Information</h4>' +
        '<div class="form-row"><div class="form-group"><label>First Name *</label><input id="dFirst" value="' + (d?.first_name || '') + '"></div><div class="form-group"><label>Last Name *</label><input id="dLast" value="' + (d?.last_name || '') + '"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Phone</label><input id="dPhone" value="' + (d?.phone || '') + '" placeholder="(555) 123-4567"></div><div class="form-group"><label>Email</label><input type="email" id="dEmail" value="' + (d?.email || '') + '" placeholder="driver@email.com"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Date of Birth</label><input type="date" id="dDOB" value="' + (d?.date_of_birth || '') + '"></div><div class="form-group"><label>EIN or SSN #</label><input id="dSSN" value="' + (d?.ssn_ein || '') + '" placeholder="XXX-XX-XXXX"></div></div>' +
        
        // Employment Section
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)">ðŸ“‹ Employment</h4>' +
        '<div class="form-row"><div class="form-group"><label>Hire Date</label><input type="date" id="dHireDate" value="' + (d?.hire_date || '') + '"></div><div class="form-group"><label>Termination Date</label><input type="date" id="dTermDate" value="' + (d?.termination_date || '') + '"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Cut %</label><input type="number" id="dCut" value="' + (d?.cut_percent || 32) + '" step="0.5"></div><div class="form-group"><label>Status</label><select id="dStatus"><option value="ACTIVE"' + (d?.status === 'ACTIVE' ? ' selected' : '') + '>ACTIVE</option><option value="INACTIVE"' + (d?.status === 'INACTIVE' ? ' selected' : '') + '>INACTIVE</option><option value="ON_LEAVE"' + (d?.status === 'ON_LEAVE' ? ' selected' : '') + '>ON LEAVE</option><option value="TERMINATED"' + (d?.status === 'TERMINATED' ? ' selected' : '') + '>TERMINATED</option></select></div></div>' +
        
        // CDL Section
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)">ðŸªª CDL Information</h4>' +
        '<div class="form-row"><div class="form-group"><label>CDL Number</label><input id="dCDL" value="' + (d?.cdl_number || '') + '" placeholder="License number"></div><div class="form-group"><label>CDL State</label><select id="dCDLState"><option value="">Select State</option>' + stateOpts + '</select></div></div>' +
        '<div class="form-row"><div class="form-group"><label>CDL Endorsements</label><input id="dEndorsements" value="' + (d?.cdl_endorsements || '') + '" placeholder="e.g., H, N, T, P, S, X"></div><div class="form-group"><label>CDL Restrictions</label><input id="dRestrictions" value="' + (d?.cdl_restrictions || '') + '" placeholder="e.g., L, Z, E, O, M, N, V"></div></div>' +
        
        // Banking Section
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)">ðŸ¦ Banking Information</h4>' +
        '<div class="form-group"><label>Bank Name</label><input id="dBankName" value="' + (d?.bank_name || '') + '" placeholder="e.g., Chase, Bank of America"></div>' +
        '<div class="form-row"><div class="form-group"><label>Account Number</label><input id="dAccountNum" value="' + (d?.account_number || '') + '" placeholder="Account #"></div><div class="form-group"><label>Routing Number</label><input id="dRoutingNum" value="' + (d?.routing_number || '') + '" placeholder="9 digit routing #"></div></div>' +
        
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveDriver(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    async function saveDriver(id) {
      const data = { 
        first_name: document.getElementById('dFirst').value, 
        last_name: document.getElementById('dLast').value, 
        phone: document.getElementById('dPhone').value, 
        email: document.getElementById('dEmail').value || null, 
        date_of_birth: document.getElementById('dDOB').value || null,
        ssn_ein: document.getElementById('dSSN').value || null,
        hire_date: document.getElementById('dHireDate').value || null,
        termination_date: document.getElementById('dTermDate').value || null,
        cut_percent: parseFloat(document.getElementById('dCut').value) || 32, 
        status: document.getElementById('dStatus').value,
        cdl_number: document.getElementById('dCDL').value || null,
        cdl_state: document.getElementById('dCDLState').value || null,
        cdl_endorsements: document.getElementById('dEndorsements').value || null,
        cdl_restrictions: document.getElementById('dRestrictions').value || null,
        bank_name: document.getElementById('dBankName').value || null,
        account_number: document.getElementById('dAccountNum').value || null,
        routing_number: document.getElementById('dRoutingNum').value || null
      };
      try { 
        if (id) { 
          await dbUpdate('drivers', id, data); 
          await logActivity('DRIVER_UPDATED', { driver_id: id, driver_name: data.first_name + ' ' + data.last_name, changes: data });
        } else { 
          const newDriver = await dbInsert('drivers', data); 
          await logActivity('DRIVER_CREATED', { driver_id: newDriver.id, driver_name: data.first_name + ' ' + data.last_name, data: data });
        } 
        document.querySelector('.modal-overlay').remove(); showToast('Saved!'); await loadAllData(); renderDrivers(document.getElementById('main-content')); 
      } catch (e) { showToast(e.message, 'error'); }
    }

    function renderTrucks(c) {
      // Clear detail view flag when going back to trucks list
      currentDetailView = null;
      const today = new Date().toISOString().split('T')[0];
      
      c.innerHTML = '<div class="header"><h2>ðŸšš Fleet</h2><button class="btn btn-primary" onclick="openTruckModal()">+ New Unit</button></div>' +
        '<div class="card"><div class="table-wrapper"><table><thead><tr><th>Unit #</th><th>Type</th><th>Year/Make/Model</th><th>VIN</th><th>Plate</th><th>Ownership</th><th>Compliance</th><th>Status</th><th class="sticky-col">Actions</th></tr></thead><tbody>' + 
        (appData.trucks.length === 0 ? '<tr><td colspan="9" style="text-align:center;padding:40px">No trucks yet</td></tr>' : 
        appData.trucks.map(t => {
          const yearMakeModel = [t.year, t.make, t.model].filter(Boolean).join(' ') || '-';
          const cabCardExpired = t.cab_card_exp && t.cab_card_exp < today;
          const annualExpired = t.annual_insp_exp && t.annual_insp_exp < today;
          const complianceIssues = (cabCardExpired ? 1 : 0) + (annualExpired ? 1 : 0) + (!t.is_2290_paid ? 1 : 0) + (!t.has_ifta_decal ? 1 : 0);
          
          return '<tr>' +
            '<td><strong>#' + t.truck_number + '</strong>' + (t.vehicle_type === 'TRAILER' ? '<br><span class="badge badge-gray" style="font-size:10px">TRAILER</span>' : '') + '</td>' +
            '<td>' + (t.truck_type || '-') + '<br><span style="font-size:11px;color:var(--text-muted)">' + (t.capacity || 0) + ' cars</span></td>' +
            '<td style="font-size:12px">' + yearMakeModel + (t.color ? '<br><span style="color:var(--text-muted)">' + t.color + '</span>' : '') + '</td>' +
            '<td style="font-size:11px;font-family:monospace">' + (t.vin ? t.vin.slice(-6) : '-') + '</td>' +
            '<td>' + (t.license_plate || '-') + (t.plate_state ? '<br><span class="badge badge-blue" style="font-size:10px">' + t.plate_state + '</span>' : '') + '</td>' +
            '<td><span class="badge ' + (t.ownership === 'OWNED' ? 'badge-green' : t.ownership === 'LEASED' ? 'badge-amber' : 'badge-blue') + '">' + (t.ownership || 'OWNED') + '</span></td>' +
            '<td>' + (complianceIssues === 0 ? '<span class="badge badge-green">âœ“ OK</span>' : '<span class="badge badge-red">' + complianceIssues + ' Issues</span>') + '</td>' +
            '<td><span class="badge ' + getBadge(t.status) + '">' + t.status + '</span></td>' +
            '<td class="sticky-col"><div class="actions"><button class="action-btn view" onclick="viewTruckCompliance(' + t.id + ')">Files</button><button class="action-btn edit" onclick="openTruckModal(' + t.id + ')">Edit</button><button class="action-btn delete" onclick="deleteTruck(' + t.id + ')">Del</button></div></td>' +
            '</tr>';
        }).join('')) + 
        '</tbody></table></div></div>';
    }

    function openTruckModal(id = null) {
      const t = id ? appData.trucks.find(x => x.id === id) : null;
      const states = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];
      const stateOpts = states.map(s => '<option value="' + s + '"' + (t?.plate_state === s ? ' selected' : '') + '>' + s + '</option>').join('');
      const currentYear = new Date().getFullYear();
      const years = [];
      for (let y = currentYear + 1; y >= 1990; y--) years.push(y);
      const yearOpts = years.map(y => '<option value="' + y + '"' + (t?.year == y ? ' selected' : '') + '>' + y + '</option>').join('');
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:750px"><div class="modal-header"><h3>' + (t ? 'Edit' : 'New') + ' Truck</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body" style="max-height:75vh;overflow-y:auto">' +
        
        // Basic Info
        '<h4 style="margin:0 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)">ðŸšš Basic Information</h4>' +
        '<div class="form-row"><div class="form-group"><label>Unit # *</label><input type="text" id="tNum" value="' + (t?.truck_number || '') + '" placeholder="e.g., 101"></div><div class="form-group"><label>Vehicle Type *</label><select id="tVehicleType"><option value="TRUCK"' + (t?.vehicle_type === 'TRUCK' ? ' selected' : '') + '>Truck</option><option value="TRAILER"' + (t?.vehicle_type === 'TRAILER' ? ' selected' : '') + '>Trailer</option></select></div><div class="form-group"><label>Hauler Type</label><select id="tType"><option value="7-Car Hauler"' + (t?.truck_type === '7-Car Hauler' ? ' selected' : '') + '>7-Car Hauler</option><option value="8-Car Hauler"' + (t?.truck_type === '8-Car Hauler' || !t ? ' selected' : '') + '>8-Car Hauler</option><option value="9-Car Hauler"' + (t?.truck_type === '9-Car Hauler' ? ' selected' : '') + '>9-Car Hauler</option><option value="Flatbed"' + (t?.truck_type === 'Flatbed' ? ' selected' : '') + '>Flatbed</option><option value="Enclosed"' + (t?.truck_type === 'Enclosed' ? ' selected' : '') + '>Enclosed</option></select></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Capacity (Cars)</label><input type="number" id="tCap" value="' + (t?.capacity || 8) + '"></div><div class="form-group"><label>Status</label><select id="tStatus"><option value="ACTIVE"' + (t?.status === 'ACTIVE' ? ' selected' : '') + '>ACTIVE</option><option value="INACTIVE"' + (t?.status === 'INACTIVE' ? ' selected' : '') + '>INACTIVE</option><option value="MAINTENANCE"' + (t?.status === 'MAINTENANCE' ? ' selected' : '') + '>MAINTENANCE</option><option value="SOLD"' + (t?.status === 'SOLD' ? ' selected' : '') + '>SOLD</option></select></div></div>' +
        
        // Vehicle Details
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)">ðŸ“‹ Vehicle Details</h4>' +
        '<div class="form-row"><div class="form-group"><label>Year</label><select id="tYear"><option value="">Select Year</option>' + yearOpts + '</select></div><div class="form-group"><label>Make</label><input id="tMake" value="' + (t?.make || '') + '" placeholder="e.g., Peterbilt, Freightliner"></div><div class="form-group"><label>Model</label><input id="tModel" value="' + (t?.model || '') + '" placeholder="e.g., 389, Cascadia"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Color</label><input id="tColor" value="' + (t?.color || '') + '" placeholder="e.g., White, Blue"></div><div class="form-group"><label>VIN</label><input id="tVIN" value="' + (t?.vin || '') + '" placeholder="17 character VIN" maxlength="17"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>GVWR (lbs)</label><input type="number" id="tGVWR" value="' + (t?.gvwr || '') + '" placeholder="e.g., 80000"></div><div class="form-group"><label>Tire Size</label><input id="tTireSize" value="' + (t?.tire_size || '') + '" placeholder="e.g., 295/75R22.5"></div></div>' +
        
        // Registration
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)">ðŸªª Registration</h4>' +
        '<div class="form-row"><div class="form-group"><label>Plate Number</label><input id="tPlate" value="' + (t?.license_plate || '') + '" placeholder="License plate"></div><div class="form-group"><label>Plate State</label><select id="tPlateState"><option value="">Select State</option>' + stateOpts + '</select></div></div>' +
        
        // Fleet Dates
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)">ðŸ“… Fleet Dates</h4>' +
        '<div class="form-row"><div class="form-group"><label>Date Added to Fleet</label><input type="date" id="tDateAdded" value="' + (t?.date_added || '') + '"></div><div class="form-group"><label>Date Removed from Fleet</label><input type="date" id="tDateRemoved" value="' + (t?.date_removed || '') + '"></div></div>' +
        
        // Compliance Dates
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)">ðŸ“‹ Compliance</h4>' +
        '<div class="form-row"><div class="form-group"><label>Cab Card Expiration</label><input type="date" id="tCabCardExp" value="' + (t?.cab_card_exp || '') + '"></div><div class="form-group"><label>Annual Inspection Exp</label><input type="date" id="tAnnualInspExp" value="' + (t?.annual_insp_exp || '') + '"></div></div>' +
        
        // Ownership & Financial
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)">ðŸ’° Ownership & Financial</h4>' +
        '<div class="form-row"><div class="form-group"><label>Ownership</label><select id="tOwnership"><option value="OWNED"' + (t?.ownership === 'OWNED' || !t ? ' selected' : '') + '>Owned</option><option value="LEASED"' + (t?.ownership === 'LEASED' ? ' selected' : '') + '>Leased</option><option value="FINANCED"' + (t?.ownership === 'FINANCED' ? ' selected' : '') + '>Financed</option></select></div><div class="form-group"><label>Market Value ($)</label><input type="number" id="tMarketValue" value="' + (t?.market_value || '') + '" placeholder="0.00" step="0.01"></div></div>' +
        
        // Compliance Checkboxes
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)">âœ… Compliance Status</h4>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">' +
        '<label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="t2290Paid"' + (t?.is_2290_paid ? ' checked' : '') + '> 2290 Paid (Y' + currentYear + ')</label>' +
        '<label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="tIFTADecal"' + (t?.has_ifta_decal ? ' checked' : '') + '> IFTA Decal</label>' +
        '<label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="tInspectorQual"' + (t?.inspector_qual_uploaded ? ' checked' : '') + '> Inspector Qualification Uploaded</label>' +
        '</div>' +
        
        // Notes
        '<div class="form-group" style="margin-top:16px"><label>Notes</label><textarea id="tNotes" rows="2" placeholder="Additional notes...">' + (t?.notes || '') + '</textarea></div>' +
        
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveTruck(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    async function saveTruck(id) {
      const data = { 
        truck_number: document.getElementById('tNum').value.trim(), 
        vehicle_type: document.getElementById('tVehicleType').value,
        truck_type: document.getElementById('tType').value, 
        capacity: parseInt(document.getElementById('tCap').value) || 8, 
        status: document.getElementById('tStatus').value,
        year: document.getElementById('tYear').value ? parseInt(document.getElementById('tYear').value) : null,
        make: document.getElementById('tMake').value || null,
        model: document.getElementById('tModel').value || null,
        color: document.getElementById('tColor').value || null,
        vin: document.getElementById('tVIN').value || null,
        gvwr: document.getElementById('tGVWR').value ? parseInt(document.getElementById('tGVWR').value) : null,
        tire_size: document.getElementById('tTireSize').value || null,
        license_plate: document.getElementById('tPlate').value || null,
        plate_state: document.getElementById('tPlateState').value || null,
        date_added: document.getElementById('tDateAdded').value || null,
        date_removed: document.getElementById('tDateRemoved').value || null,
        cab_card_exp: document.getElementById('tCabCardExp').value || null,
        annual_insp_exp: document.getElementById('tAnnualInspExp').value || null,
        ownership: document.getElementById('tOwnership').value,
        market_value: document.getElementById('tMarketValue').value ? parseFloat(document.getElementById('tMarketValue').value) : null,
        is_2290_paid: document.getElementById('t2290Paid').checked,
        has_ifta_decal: document.getElementById('tIFTADecal').checked,
        inspector_qual_uploaded: document.getElementById('tInspectorQual').checked,
        notes: document.getElementById('tNotes').value || null
      };
      if (!data.truck_number) { showToast('Unit # is required', 'error'); return; }
      try { 
        if (id) { 
          await dbUpdate('trucks', id, data); 
          await logActivity('TRUCK_UPDATED', { truck_id: id, truck_number: data.truck_number, changes: data });
        } else { 
          const newTruck = await dbInsert('trucks', data); 
          await logActivity('TRUCK_CREATED', { truck_id: newTruck.id, truck_number: data.truck_number, data: data });
        } 
        document.querySelector('.modal-overlay').remove(); showToast('Saved!'); await loadAllData(); renderTrucks(document.getElementById('main-content')); 
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteTruck(id) { 
      if (!confirm('Delete?')) return; 
      const truck = appData.trucks.find(t => t.id === id);
      await dbDelete('trucks', id); 
      await logActivity('TRUCK_DELETED', { truck_id: id, truck_number: truck?.truck_number });
      showToast('Deleted'); await loadAllData(); renderTrucks(document.getElementById('main-content')); 
    }

    // ============ LOCAL DRIVERS SECTION ============
    // Helper function to check if destination is in NY/NJ/PA
    function isLocalDeliveryState(destination) {
      if (!destination) return false;
      const dest = destination.toUpperCase();
      // Check for state abbreviations or full names
      return dest.includes(', NY') || dest.includes(', NJ') || dest.includes(', PA') ||
             dest.includes('NEW YORK') || dest.includes('NEW JERSEY') || dest.includes('PENNSYLVANIA') ||
             dest.endsWith(' NY') || dest.endsWith(' NJ') || dest.endsWith(' PA');
    }

    function renderLocalDrivers(c) {
      // Get completed trip IDs
      const completedTripIds = appData.trips.filter(t => t.status === 'COMPLETED').map(t => t.id);
      
      // Pending local delivery: trip is COMPLETED, destination is NY/NJ/PA, has local_fee > 0, not assigned, not marked as "not for local"
      const pendingLocalDelivery = appData.orders.filter(o => 
        completedTripIds.includes(o.trip_id) &&
        parseFloat(o.local_fee || 0) > 0 &&
        isLocalDeliveryState(o.destination) &&
        !o.local_driver_id &&
        !o.not_for_local_delivery
      );
      
      // Pending local pickup: cars in Load Board with "NY to Home" or "NY to FL" category, not assigned to local driver, not marked as "not for local"
      const pendingLocalPickup = appData.orders.filter(o => 
        (o.load_category === 'ny_to_home' || o.load_category === 'ny_to_fl') &&
        !o.local_driver_id &&
        !o.not_for_local_delivery
      );
      
      const assignedToLocal = appData.orders.filter(o => o.local_driver_id);
      
      // Calculate stats per local driver
      const localDriverStats = (appData.local_drivers || []).map(ld => {
        const driverOrders = appData.orders.filter(o => o.local_driver_id === ld.id);
        const completedOrders = driverOrders.filter(o => o.local_delivery_status === 'DELIVERED');
        const pendingOrders = driverOrders.filter(o => o.local_delivery_status !== 'DELIVERED');
        const totalEarnings = driverOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
        return { ...ld, totalOrders: driverOrders.length, completedOrders: completedOrders.length, pendingOrders: pendingOrders.length, totalEarnings };
      });
      
      const totalPendingDeliveryFees = pendingLocalDelivery.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
      const totalPendingPickupFees = pendingLocalPickup.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
      const totalPendingDeliveryRevenue = pendingLocalDelivery.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
      const totalPendingPickupRevenue = pendingLocalPickup.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
      
      c.innerHTML = '<div class="header"><h2>ðŸš™ Local Drivers</h2><button class="btn btn-primary" onclick="openLocalDriverModal()">+ Add Local Driver</button></div>' +
        
        // Stats
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px"><div class="label">Local Drivers</div><div class="value">' + (appData.local_drivers || []).length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:12px 16px;background:#dbeafe"><div class="label">Pending Pickup</div><div class="value" style="color:#1d4ed8">' + pendingLocalPickup.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:12px 16px;background:#fef3c7"><div class="label">Pending Delivery</div><div class="value" style="color:#92400e">' + pendingLocalDelivery.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:130px;padding:12px 16px"><div class="label">Total Pending Fees</div><div class="value" style="color:#ef4444">' + formatMoney(totalPendingDeliveryFees + totalPendingPickupFees) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:140px;padding:12px 16px;background:#d1fae5"><div class="label">Total Delivery Revenue</div><div class="value" style="color:#059669">' + formatMoney(totalPendingDeliveryRevenue) + '</div></div>' +
        '</div>' +
        
        // Local Drivers List
        '<div class="card" style="margin-bottom:24px"><div class="card-header"><h3>ðŸ‘¤ Local Drivers</h3></div>' +
        ((appData.local_drivers || []).length === 0 ? '<div style="padding:40px;text-align:center;color:#64748b">No local drivers yet. Add your first local driver!</div>' :
        '<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Phone</th><th>Area</th><th>Total Jobs</th><th>Pending</th><th>Total Earnings</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        localDriverStats.map(ld => '<tr><td><strong>' + ld.name + '</strong></td><td>' + (ld.phone || '-') + '</td><td>' + (ld.service_area || '-') + '</td><td>' + ld.totalOrders + '</td><td>' + ld.pendingOrders + '</td><td class="money">' + formatMoney(ld.totalEarnings) + '</td><td class="sticky-col"><div class="actions"><button class="action-btn view" onclick="viewLocalDriverDetails(' + ld.id + ')">View</button><button class="action-btn edit" onclick="openLocalDriverModal(' + ld.id + ')">Edit</button><button class="action-btn delete" onclick="deleteLocalDriver(' + ld.id + ')">Del</button></div></td></tr>').join('') +
        '</tbody></table></div>') +
        '</div>' +
        
        // Pending Local Pickup (from Load Board NY to Home)
        '<div class="card" style="margin-bottom:24px"><div class="card-header" style="background:#3b82f6;color:white;border-radius:8px 8px 0 0"><h3 style="margin:0">ðŸŸ¡ Pending Local Pickup (' + pendingLocalPickup.length + ')</h3></div>' +
        '<div style="padding:12px;background:#dbeafe;border-bottom:1px solid #93c5fd;font-size:13px;color:#1d4ed8">Cars from <strong>Load Board â†’ NY to Home</strong> that need pickup from NY/NJ to terminal. <span style="margin-left:12px">ðŸ”µ Pending | ðŸŸ  Scheduled | ðŸŸ¡ Confirmed | ðŸŸ¢ Ready | ðŸ”´ Issue</span></div>' +
        (pendingLocalPickup.length === 0 ? '<div style="padding:40px;text-align:center;color:#64748b">No cars pending local pickup</div>' :
        '<div class="table-wrapper"><table><thead><tr><th>Status</th><th>Order</th><th>Broker</th><th>Vehicle</th><th>Origin</th><th>ðŸ“žP</th><th>Destination</th><th>Pick-Up</th><th>Delivery</th><th>Payment</th><th>Broker Fee</th><th>Local Fee</th><th>Revenue</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        pendingLocalPickup.map(o => {
          const confirmStatus = o.local_confirmation_status || 'pending';
          const rowColors = { pending: '#dbeafe', scheduled: '#ffedd5', confirmed: '#fef9c3', ready: '#dcfce7', issue: '#fee2e2' };
          const statusIcons = { pending: 'ðŸ”µ', scheduled: 'ðŸŸ ', confirmed: 'ðŸŸ¡', ready: 'ðŸŸ¢', issue: 'ðŸ”´' };
          const rowColor = rowColors[confirmStatus] || '#dbeafe';
          const statusIcon = statusIcons[confirmStatus] || 'ðŸ”µ';
          const pickupPhoneDisplay = o.pickup_phone ? '<a href="tel:' + o.pickup_phone + '" style="color:#3b82f6" title="' + o.pickup_phone + '">ðŸ“ž</a>' : '-';
          const noteBtn = o.local_notes ? 
            '<button class="action-btn" style="background:#a855f7;color:white" onclick="openLocalNote(' + o.id + ')" title="' + o.local_notes.replace(/"/g, '&quot;').replace(/\n/g, ' ') + '">ðŸ“</button>' : 
            '<button class="action-btn" style="background:#e9d5ff;color:#7c3aed" onclick="openLocalNote(' + o.id + ')" title="Add note">ðŸ“+</button>';
          const noteHtml = o.local_notes ? '<tr style="background:#f3e8ff"><td colspan="14" style="padding:8px 16px;font-size:13px"><span style="font-weight:600;color:#7c3aed">ðŸ“ Local Note:</span> ' + o.local_notes + '</td></tr>' : '';
          return '<tr style="background:' + rowColor + '"><td style="text-align:center"><button onclick="cycleConfirmationStatus(' + o.id + ')" style="background:none;border:none;font-size:18px;cursor:pointer" title="Click to change status">' + statusIcon + '</button></td><td><strong>' + o.order_number + '</strong></td><td>' + (o.broker_name || '-') + '</td><td>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</td><td title="' + (o.pickup_full_address || o.origin || '') + '">' + (o.origin || '-') + '</td><td>' + pickupPhoneDisplay + '</td><td title="' + (o.delivery_full_address || o.destination || '') + '">' + (o.destination || '-') + '</td><td>' + (o.pickup_date ? formatDate(o.pickup_date) : '-') + '</td><td>' + (o.dropoff_date ? formatDate(o.dropoff_date) : '-') + '</td><td><span class="badge badge-blue">' + (o.payment_type || '-') + '</span></td><td class="money negative">' + formatMoney(o.broker_fee || 0) + '</td><td class="money negative">' + formatMoney(o.local_fee || 0) + '</td><td class="money">' + formatMoney(o.revenue || 0) + '</td><td class="sticky-col"><div class="actions">' + noteBtn + '<button class="action-btn" style="background:#10b981;color:white" onclick="openAssignLocalDriver(' + o.id + ',\'pickup\')">Assign</button><button class="action-btn" style="background:#6b7280;color:white" onclick="markNotForLocalDelivery(' + o.id + ')">Not Local</button></div></td></tr>' + noteHtml;
        }).join('') +
        '</tbody></table></div>') +
        '</div>' +
        
        // Pending Local Delivery (from completed trips)
        '<div class="card"><div class="card-header" style="background:#f59e0b;color:white;border-radius:8px 8px 0 0"><h3 style="margin:0">ðŸ“¦ Pending Local Delivery (' + pendingLocalDelivery.length + ')</h3></div>' +
        '<div style="padding:12px;background:#fffbeb;border-bottom:1px solid #fde68a;font-size:13px;color:#92400e">Cars from <strong>COMPLETED</strong> trips with destinations in <strong>NY, NJ, or PA</strong>. <span style="margin-left:12px">ðŸ”µ Pending | ðŸŸ  Scheduled | ðŸŸ¡ Confirmed | ðŸŸ¢ Ready | ðŸ”´ Issue</span></div>' +
        (pendingLocalDelivery.length === 0 ? '<div style="padding:40px;text-align:center;color:#64748b">No orders pending local delivery</div>' :
        '<div class="table-wrapper"><table><thead><tr><th>Status</th><th>Order</th><th>Broker</th><th>Vehicle</th><th>Origin</th><th>Destination</th><th>ðŸ“žD</th><th>Pick-Up</th><th>Delivery</th><th>Payment</th><th>Broker Fee</th><th>Local Fee</th><th>Revenue</th><th>Trip</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        pendingLocalDelivery.map(o => {
          const trip = appData.trips.find(t => t.id === o.trip_id);
          const confirmStatus = o.local_confirmation_status || 'pending';
          const rowColors = { pending: '#dbeafe', scheduled: '#ffedd5', confirmed: '#fef9c3', ready: '#dcfce7', issue: '#fee2e2' };
          const statusIcons = { pending: 'ðŸ”µ', scheduled: 'ðŸŸ ', confirmed: 'ðŸŸ¡', ready: 'ðŸŸ¢', issue: 'ðŸ”´' };
          const rowColor = rowColors[confirmStatus] || '#dbeafe';
          const statusIcon = statusIcons[confirmStatus] || 'ðŸ”µ';
          const deliveryPhoneDisplay = o.delivery_phone ? '<a href="tel:' + o.delivery_phone + '" style="color:#10b981" title="' + o.delivery_phone + '">ðŸ“ž</a>' : '-';
          const noteBtn = o.local_notes ? 
            '<button class="action-btn" style="background:#a855f7;color:white" onclick="openLocalNote(' + o.id + ')" title="' + o.local_notes.replace(/"/g, '&quot;').replace(/\n/g, ' ') + '">ðŸ“</button>' : 
            '<button class="action-btn" style="background:#e9d5ff;color:#7c3aed" onclick="openLocalNote(' + o.id + ')" title="Add note">ðŸ“+</button>';
          const noteHtml = o.local_notes ? '<tr style="background:#f3e8ff"><td colspan="15" style="padding:8px 16px;font-size:13px"><span style="font-weight:600;color:#7c3aed">ðŸ“ Local Note:</span> ' + o.local_notes + '</td></tr>' : '';
          return '<tr style="background:' + rowColor + '"><td style="text-align:center"><button onclick="cycleConfirmationStatus(' + o.id + ')" style="background:none;border:none;font-size:18px;cursor:pointer" title="Click to change status">' + statusIcon + '</button></td><td><strong>' + o.order_number + '</strong></td><td>' + (o.broker_name || '-') + '</td><td>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</td><td title="' + (o.pickup_full_address || o.origin || '') + '">' + (o.origin || '-') + '</td><td title="' + (o.delivery_full_address || o.destination || '') + '">' + o.destination + '</td><td>' + deliveryPhoneDisplay + '</td><td>' + (o.pickup_date ? formatDate(o.pickup_date) : '-') + '</td><td>' + (o.dropoff_date ? formatDate(o.dropoff_date) : '-') + '</td><td><span class="badge badge-blue">' + (o.payment_type || '-') + '</span></td><td class="money negative">' + formatMoney(o.broker_fee || 0) + '</td><td class="money negative">' + formatMoney(o.local_fee) + '</td><td class="money">' + formatMoney(o.revenue || 0) + '</td><td>' + (trip ? trip.trip_number : '-') + '</td><td class="sticky-col"><div class="actions">' + noteBtn + '<button class="action-btn" style="background:#10b981;color:white" onclick="openAssignLocalDriver(' + o.id + ',\'delivery\')">Assign</button><button class="action-btn" style="background:#6b7280;color:white" onclick="markNotForLocalDelivery(' + o.id + ')">Not Local</button></div></td></tr>' + noteHtml;
        }).join('') +
        '</tbody></table></div>') +
        '</div>';
    }

    function openLocalDriverModal(id = null) {
      const ld = id ? (appData.local_drivers || []).find(x => x.id === id) : null;
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:450px"><div class="modal-header"><h3>' + (ld ? 'Edit' : 'Add') + ' Local Driver</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body">' +
        '<div class="form-group"><label>Name *</label><input id="ldName" value="' + (ld?.name || '') + '" placeholder="Driver name"></div>' +
        '<div class="form-row"><div class="form-group"><label>Phone</label><input id="ldPhone" value="' + (ld?.phone || '') + '" placeholder="(555) 123-4567"></div><div class="form-group"><label>Service Area</label><input id="ldArea" value="' + (ld?.service_area || '') + '" placeholder="e.g., NY/NJ"></div></div>' +
        '<div class="form-group"><label>Notes</label><textarea id="ldNotes" rows="2" placeholder="Any notes...">' + (ld?.notes || '') + '</textarea></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveLocalDriver(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    async function saveLocalDriver(id) {
      const name = document.getElementById('ldName').value.trim();
      if (!name) { showToast('Name is required', 'error'); return; }
      
      const data = {
        name: name,
        phone: document.getElementById('ldPhone').value || null,
        service_area: document.getElementById('ldArea').value || null,
        notes: document.getElementById('ldNotes').value || null
      };
      
      try {
        if (id) {
          await dbUpdate('local_drivers', id, data);
          await logActivity('LOCAL_DRIVER_UPDATED', { local_driver_id: id, driver_name: name });
        } else {
          const newDriver = await dbInsert('local_drivers', data);
          await logActivity('LOCAL_DRIVER_CREATED', { local_driver_id: newDriver.id, driver_name: name, service_area: data.service_area });
        }
        document.querySelector('.modal-overlay').remove();
        showToast('Local driver saved!');
        await loadAllData();
        renderLocalDrivers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteLocalDriver(id) {
      if (!confirm('Delete this local driver?')) return;
      try {
        const driver = (appData.local_drivers || []).find(d => d.id === id);
        await dbDelete('local_drivers', id);
        await logActivity('LOCAL_DRIVER_DELETED', { local_driver_id: id, driver_name: driver?.name });
        showToast('Deleted');
        await loadAllData();
        renderLocalDrivers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    // Cycle through confirmation statuses: pending (blue) -> scheduled (orange) -> confirmed (yellow) -> ready (green) -> issue (red) -> pending
    async function cycleConfirmationStatus(orderId) {
      const order = appData.orders.find(o => o.id === orderId);
      if (!order) return;
      
      const currentStatus = order.local_confirmation_status || 'pending';
      let newStatus;
      
      // Cycle: pending -> scheduled -> confirmed -> ready -> issue -> pending
      if (currentStatus === 'pending') {
        newStatus = 'scheduled';
      } else if (currentStatus === 'scheduled') {
        newStatus = 'confirmed';
      } else if (currentStatus === 'confirmed') {
        newStatus = 'ready';
      } else if (currentStatus === 'ready') {
        newStatus = 'issue';
      } else {
        newStatus = 'pending';
      }
      
      try {
        await dbUpdate('orders', orderId, { local_confirmation_status: newStatus });
        
        // Update local data
        order.local_confirmation_status = newStatus;
        
        const statusLabels = { pending: 'Pending', scheduled: 'Scheduled', confirmed: 'Confirmed', ready: 'Ready', issue: 'Issue' };
        showToast('Status changed to: ' + statusLabels[newStatus]);
        
        // Re-render the page
        renderLocalDrivers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    // Quick note for Local Drivers page
    function openLocalNote(orderId) {
      const o = appData.orders.find(x => x.id === orderId);
      if (!o) return;
      
      const m = document.createElement('div'); 
      m.className = 'modal-overlay'; 
      m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header" style="background:#a855f7;color:white"><h3 style="margin:0">ðŸ“ Local Note</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()" style="color:white">Ã—</button></div><div class="modal-body">' +
        '<div style="background:#f3e8ff;padding:12px;border-radius:8px;margin-bottom:16px">' +
        '<strong>' + o.order_number + '</strong> - ' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + 
        '<br><span style="color:#7c3aed">' + (o.origin || '-') + ' â†’ ' + (o.destination || '-') + '</span></div>' +
        '<div class="form-group"><label>Note</label><textarea id="localNoteText" rows="4" placeholder="Add note about this vehicle..." style="resize:vertical;width:100%">' + (o.local_notes || '') + '</textarea></div>' +
        '</div><div class="modal-footer">' +
        (o.local_notes ? '<button class="btn" style="background:#fee2e2;color:#dc2626;border:1px solid #fecaca;margin-right:auto" onclick="clearLocalNote(' + orderId + ')">Clear Note</button>' : '') +
        '<button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button>' +
        '<button class="btn" style="background:#a855f7;color:white" onclick="saveLocalNote(' + orderId + ')">Save Note</button></div></div>';
      document.body.appendChild(m);
      
      // Focus on textarea
      setTimeout(() => document.getElementById('localNoteText')?.focus(), 100);
    }

    async function saveLocalNote(orderId) {
      const noteText = document.getElementById('localNoteText').value.trim();
      
      try {
        await dbUpdate('orders', orderId, { local_notes: noteText || null });
        
        // Update local data
        const order = appData.orders.find(o => o.id === orderId);
        if (order) order.local_notes = noteText || null;
        
        document.querySelector('.modal-overlay').remove();
        showToast(noteText ? 'Note saved!' : 'Note cleared');
        renderLocalDrivers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function clearLocalNote(orderId) {
      if (!confirm('Clear this note?')) return;
      
      try {
        await dbUpdate('orders', orderId, { local_notes: null });
        
        // Update local data
        const order = appData.orders.find(o => o.id === orderId);
        if (order) order.local_notes = null;
        
        document.querySelector('.modal-overlay').remove();
        showToast('Note cleared');
        renderLocalDrivers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function markNotForLocalDelivery(orderId) {
      if (!confirm('Mark this order as NOT for local delivery? It will be removed from the pending list.')) return;
      try {
        await dbUpdate('orders', orderId, { not_for_local_delivery: true });
        showToast('Marked as not for local delivery');
        await loadAllData();
        renderLocalDrivers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    function openAssignLocalDriver(orderId, type = null) {
      const o = appData.orders.find(x => x.id === orderId);
      const isPickup = type === 'pickup';
      const isDelivery = type === 'delivery';
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:450px"><div class="modal-header"><h3>Assign Local Driver</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body">' +
        '<div style="background:#f1f5f9;padding:12px;border-radius:8px;margin-bottom:16px"><strong>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</strong><br><span style="color:#64748b">' + (o.origin || '-') + ' â†’ ' + (o.destination || '-') + '</span><br><span style="color:#10b981;font-weight:600">Local Fee: ' + formatMoney(o.local_fee || 0) + '</span></div>' +
        '<div class="form-group"><label>Local Driver *</label><select id="selectLocalDriver"><option value="">Select local driver...</option>' + 
        (appData.local_drivers || []).map(ld => '<option value="' + ld.id + '">' + ld.name + (ld.service_area ? ' (' + ld.service_area + ')' : '') + '</option>').join('') +
        '</select></div>' +
        '<div class="form-group"><label>Job Type *</label><select id="selectLocalType"><option value="TO_TERMINAL"' + (isPickup ? ' selected' : '') + '>ðŸŸ¡ Pickup: NY/NJ â†’ Terminal</option><option value="FROM_TERMINAL"' + (isDelivery ? ' selected' : '') + '>ðŸ“¦ Delivery: Terminal â†’ NY/NJ/PA</option></select></div>' +
        '<div class="form-group"><label>Assigned Date</label><input type="date" id="localAssignedDate" value="' + new Date().toISOString().split('T')[0] + '"></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="assignLocalDriverToOrder(' + orderId + ')">Assign</button></div></div>';
      document.body.appendChild(m);
    }

    async function assignLocalDriverToOrder(orderId) {
      const localDriverId = parseInt(document.getElementById('selectLocalDriver').value);
      if (!localDriverId) { showToast('Please select a local driver', 'error'); return; }
      
      const localType = document.getElementById('selectLocalType').value;
      const assignedDate = document.getElementById('localAssignedDate').value;
      
      try {
        await dbUpdate('orders', orderId, { 
          local_driver_id: localDriverId, 
          local_delivery_status: 'ASSIGNED',
          local_delivery_type: localType,
          local_assigned_date: assignedDate || new Date().toISOString().split('T')[0]
        });
        document.querySelector('.modal-overlay').remove();
        showToast('Local driver assigned!');
        await loadAllData();
        renderLocalDrivers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    function viewLocalDriverDetails(localDriverId) {
      const ld = (appData.local_drivers || []).find(x => x.id === localDriverId);
      const driverOrders = appData.orders.filter(o => o.local_driver_id === localDriverId);
      const totalEarnings = driverOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
      const pendingOrders = driverOrders.filter(o => o.local_delivery_status !== 'DELIVERED');
      const completedOrders = driverOrders.filter(o => o.local_delivery_status === 'DELIVERED');
      const toTerminalOrders = driverOrders.filter(o => o.local_delivery_type === 'TO_TERMINAL');
      const fromTerminalOrders = driverOrders.filter(o => o.local_delivery_type === 'FROM_TERMINAL');
      
      const getTypeBadge = (type) => {
        if (type === 'TO_TERMINAL') return '<span class="badge" style="background:#fef3c7;color:#92400e">ðŸŸ¡ Pickup</span>';
        if (type === 'FROM_TERMINAL') return '<span class="badge" style="background:#e5e7eb;color:#374151">ðŸ”˜ Delivery</span>';
        return '<span class="badge badge-gray">-</span>';
      };
      
      const c = document.getElementById('main-content');
      c.innerHTML = '<div class="header"><div style="display:flex;align-items:center;gap:16px"><button class="btn btn-secondary" onclick="renderLocalDrivers(document.getElementById(\'main-content\'))">â† Back</button><h2>ðŸš™ ' + ld.name + '</h2></div></div>' +
        
        // Stats
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px"><div class="label">Total Deliveries</div><div class="value">' + driverOrders.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Completed</div><div class="value" style="color:#10b981">' + completedOrders.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px"><div class="label">Pending</div><div class="value" style="color:#f59e0b">' + pendingOrders.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px;background:#fef3c7"><div class="label">ðŸŸ¡ Pickups</div><div class="value">' + toTerminalOrders.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px;background:#e5e7eb"><div class="label">ðŸ”˜ Deliveries</div><div class="value">' + fromTerminalOrders.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px;background:#d1fae5"><div class="label">Total Earnings</div><div class="value" style="color:#059669">' + formatMoney(totalEarnings) + '</div></div>' +
        '</div>' +
        
        // Driver Info
        '<div class="card" style="margin-bottom:24px;padding:20px"><div style="display:flex;gap:24px;flex-wrap:wrap">' +
        '<div><span style="color:#64748b">Phone:</span> <strong>' + (ld.phone || '-') + '</strong></div>' +
        '<div><span style="color:#64748b">Service Area:</span> <strong>' + (ld.service_area || '-') + '</strong></div>' +
        (ld.notes ? '<div style="width:100%"><span style="color:#64748b">Notes:</span> ' + ld.notes + '</div>' : '') +
        '</div></div>' +
        
        // Assigned Orders
        '<div class="card"><div class="card-header"><h3>ðŸ“¦ Assigned Orders</h3></div>' +
        '<div style="padding:12px;background:#f8fafc;border-bottom:1px solid #e2e8f0;font-size:13px;color:#475569">ðŸ”µ Pending | ðŸŸ  Scheduled | ðŸŸ¡ Confirmed | ðŸŸ¢ Ready | ðŸ”´ Issue</div>' +
        (driverOrders.length === 0 ? '<div style="padding:40px;text-align:center;color:#64748b">No orders assigned yet</div>' :
        '<div class="table-wrapper"><table><thead><tr><th>Status</th><th>Order</th><th>Broker</th><th>Vehicle</th><th>Origin</th><th>ðŸ“žP</th><th>Destination</th><th>ðŸ“žD</th><th>Type</th><th>Broker Fee</th><th>Local Fee</th><th>Revenue</th><th>Delivery</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        driverOrders.map(o => {
          const confirmStatus = o.local_confirmation_status || 'pending';
          const rowColors = { pending: '#dbeafe', scheduled: '#ffedd5', confirmed: '#fef9c3', ready: '#dcfce7', issue: '#fee2e2' };
          const statusIcons = { pending: 'ðŸ”µ', scheduled: 'ðŸŸ ', confirmed: 'ðŸŸ¡', ready: 'ðŸŸ¢', issue: 'ðŸ”´' };
          const rowColor = rowColors[confirmStatus] || '#dbeafe';
          const statusIcon = statusIcons[confirmStatus] || 'ðŸ”µ';
          const pickupPhoneDisplay = o.pickup_phone ? '<a href="tel:' + o.pickup_phone + '" style="color:#3b82f6" title="' + o.pickup_phone + '">ðŸ“ž</a>' : '-';
          const deliveryPhoneDisplay = o.delivery_phone ? '<a href="tel:' + o.delivery_phone + '" style="color:#10b981" title="' + o.delivery_phone + '">ðŸ“ž</a>' : '-';
          const noteBtn = o.local_notes ? 
            '<button class="action-btn" style="background:#a855f7;color:white" onclick="openLocalNoteFromDriver(' + o.id + ',' + localDriverId + ')" title="' + o.local_notes.replace(/"/g, '&quot;').replace(/\n/g, ' ') + '">ðŸ“</button>' : 
            '<button class="action-btn" style="background:#e9d5ff;color:#7c3aed" onclick="openLocalNoteFromDriver(' + o.id + ',' + localDriverId + ')" title="Add note">ðŸ“+</button>';
          const noteHtml = o.local_notes ? '<tr style="background:#f3e8ff"><td colspan="14" style="padding:8px 16px;font-size:13px"><span style="font-weight:600;color:#7c3aed">ðŸ“ Local Note:</span> ' + o.local_notes + '</td></tr>' : '';
          return '<tr style="background:' + rowColor + '"><td style="text-align:center"><button onclick="cycleConfirmationStatusFromDriver(' + o.id + ',' + localDriverId + ')" style="background:none;border:none;font-size:18px;cursor:pointer" title="Click to change status">' + statusIcon + '</button></td><td><strong>' + o.order_number + '</strong></td><td>' + (o.broker_name || '-') + '</td><td>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</td><td title="' + (o.pickup_full_address || o.origin || '') + '">' + (o.origin || '-') + '</td><td>' + pickupPhoneDisplay + '</td><td title="' + (o.delivery_full_address || o.destination || '') + '">' + (o.destination || '-') + '</td><td>' + deliveryPhoneDisplay + '</td><td>' + getTypeBadge(o.local_delivery_type) + '</td><td class="money negative">' + formatMoney(o.broker_fee || 0) + '</td><td class="money negative">' + formatMoney(o.local_fee || 0) + '</td><td class="money">' + formatMoney(o.revenue || 0) + '</td><td><span class="badge ' + (o.local_delivery_status === 'DELIVERED' ? 'badge-green' : 'badge-amber') + '">' + (o.local_delivery_status || 'ASSIGNED') + '</span></td><td class="sticky-col"><div class="actions">' + noteBtn + (o.local_delivery_status !== 'DELIVERED' ? '<button class="action-btn edit" style="background:#10b981;color:white" onclick="markLocalDelivered(' + o.id + ',' + localDriverId + ')">âœ“</button>' : '') + '<button class="action-btn delete" onclick="unassignLocalDriver(' + o.id + ',' + localDriverId + ')">âœ—</button></div></td></tr>' + noteHtml;
        }).join('') +
        '</tbody></table></div>') +
        '</div>';
    }

    async function markLocalDelivered(orderId, localDriverId) {
      try {
        await dbUpdate('orders', orderId, { local_delivery_status: 'DELIVERED' });
        showToast('Marked as delivered!');
        await loadAllData();
        viewLocalDriverDetails(localDriverId);
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function unassignLocalDriver(orderId, localDriverId) {
      if (!confirm('Unassign this order from local driver?')) return;
      try {
        await dbUpdate('orders', orderId, { local_driver_id: null, local_delivery_status: null });
        showToast('Unassigned');
        await loadAllData();
        viewLocalDriverDetails(localDriverId);
      } catch (e) { showToast(e.message, 'error'); }
    }

    // Cycle confirmation status from driver details view
    async function cycleConfirmationStatusFromDriver(orderId, localDriverId) {
      const order = appData.orders.find(o => o.id === orderId);
      if (!order) return;
      
      const currentStatus = order.local_confirmation_status || 'pending';
      let newStatus;
      
      if (currentStatus === 'pending') newStatus = 'scheduled';
      else if (currentStatus === 'scheduled') newStatus = 'confirmed';
      else if (currentStatus === 'confirmed') newStatus = 'ready';
      else if (currentStatus === 'ready') newStatus = 'issue';
      else newStatus = 'pending';
      
      try {
        await dbUpdate('orders', orderId, { local_confirmation_status: newStatus });
        order.local_confirmation_status = newStatus;
        const statusLabels = { pending: 'Pending', scheduled: 'Scheduled', confirmed: 'Confirmed', ready: 'Ready', issue: 'Issue' };
        showToast('Status changed to: ' + statusLabels[newStatus]);
        viewLocalDriverDetails(localDriverId);
      } catch (e) { showToast(e.message, 'error'); }
    }

    // Open local note from driver details view
    function openLocalNoteFromDriver(orderId, localDriverId) {
      const o = appData.orders.find(x => x.id === orderId);
      if (!o) return;
      
      const m = document.createElement('div'); 
      m.className = 'modal-overlay'; 
      m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header" style="background:#a855f7;color:white"><h3 style="margin:0">ðŸ“ Local Note</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()" style="color:white">Ã—</button></div><div class="modal-body">' +
        '<div style="background:#f3e8ff;padding:12px;border-radius:8px;margin-bottom:16px">' +
        '<strong>' + o.order_number + '</strong> - ' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + 
        '<br><span style="color:#7c3aed">' + (o.origin || '-') + ' â†’ ' + (o.destination || '-') + '</span></div>' +
        '<div class="form-group"><label>Note</label><textarea id="localNoteText" rows="4" placeholder="Add note about this vehicle..." style="resize:vertical;width:100%">' + (o.local_notes || '') + '</textarea></div>' +
        '</div><div class="modal-footer">' +
        (o.local_notes ? '<button class="btn" style="background:#fee2e2;color:#dc2626;border:1px solid #fecaca;margin-right:auto" onclick="clearLocalNoteFromDriver(' + orderId + ',' + localDriverId + ')">Clear Note</button>' : '') +
        '<button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button>' +
        '<button class="btn" style="background:#a855f7;color:white" onclick="saveLocalNoteFromDriver(' + orderId + ',' + localDriverId + ')">Save Note</button></div></div>';
      document.body.appendChild(m);
      setTimeout(() => document.getElementById('localNoteText')?.focus(), 100);
    }

    async function saveLocalNoteFromDriver(orderId, localDriverId) {
      const noteText = document.getElementById('localNoteText').value.trim();
      try {
        await dbUpdate('orders', orderId, { local_notes: noteText || null });
        const order = appData.orders.find(o => o.id === orderId);
        if (order) order.local_notes = noteText || null;
        document.querySelector('.modal-overlay').remove();
        showToast(noteText ? 'Note saved!' : 'Note cleared');
        viewLocalDriverDetails(localDriverId);
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function clearLocalNoteFromDriver(orderId, localDriverId) {
      if (!confirm('Clear this note?')) return;
      try {
        await dbUpdate('orders', orderId, { local_notes: null });
        const order = appData.orders.find(o => o.id === orderId);
        if (order) order.local_notes = null;
        document.querySelector('.modal-overlay').remove();
        showToast('Note cleared');
        viewLocalDriverDetails(localDriverId);
      } catch (e) { showToast(e.message, 'error'); }
    }

    // ============ BROKERS SECTION ============
    function renderBrokers(c) {
      // Calculate comprehensive stats per broker
      const brokerStats = (appData.brokers || []).map(b => {
        const brokerOrders = appData.orders.filter(o => o.broker_id === b.id);
        const totalRevenue = brokerOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
        const totalBrokerFee = brokerOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
        const avgRevenue = brokerOrders.length > 0 ? totalRevenue / brokerOrders.length : 0;
        const avgBrokerFee = brokerOrders.length > 0 ? totalBrokerFee / brokerOrders.length : 0;
        const feePercent = totalRevenue > 0 ? (totalBrokerFee / totalRevenue * 100) : 0;
        
        // Calculate profit (revenue - broker fees - estimated driver cut 32%)
        const cleanRevenue = totalRevenue - totalBrokerFee;
        const estimatedDriverCut = cleanRevenue * 0.32;
        const estimatedProfit = cleanRevenue - estimatedDriverCut;
        const profitPerLoad = brokerOrders.length > 0 ? estimatedProfit / brokerOrders.length : 0;
        
        // Get unique trips for this broker
        const tripIds = [...new Set(brokerOrders.filter(o => o.trip_id).map(o => o.trip_id))];
        
        // Find most recent order date
        const orderDates = brokerOrders.filter(o => o.pickup_date).map(o => new Date(o.pickup_date));
        const lastOrderDate = orderDates.length > 0 ? new Date(Math.max(...orderDates)) : null;
        const daysSinceLastOrder = lastOrderDate ? Math.floor((new Date() - lastOrderDate) / (1000 * 60 * 60 * 24)) : null;
        
        // Calculate load frequency (orders per month)
        const firstOrderDate = orderDates.length > 0 ? new Date(Math.min(...orderDates)) : null;
        let ordersPerMonth = 0;
        if (firstOrderDate && brokerOrders.length > 1) {
          const monthsActive = Math.max(1, (new Date() - firstOrderDate) / (1000 * 60 * 60 * 24 * 30));
          ordersPerMonth = brokerOrders.length / monthsActive;
        }
        
        // Reliability score (based on fee consistency and volume)
        let reliabilityScore = 0;
        if (brokerOrders.length >= 10) reliabilityScore += 30;
        else if (brokerOrders.length >= 5) reliabilityScore += 20;
        else if (brokerOrders.length >= 1) reliabilityScore += 10;
        if (feePercent <= 8) reliabilityScore += 30;
        else if (feePercent <= 12) reliabilityScore += 20;
        else if (feePercent <= 15) reliabilityScore += 10;
        if (profitPerLoad >= 500) reliabilityScore += 40;
        else if (profitPerLoad >= 300) reliabilityScore += 30;
        else if (profitPerLoad >= 100) reliabilityScore += 20;
        else if (profitPerLoad > 0) reliabilityScore += 10;
        
        return { 
          ...b, 
          orderCount: brokerOrders.length, 
          tripCount: tripIds.length,
          totalRevenue, 
          totalBrokerFee,
          avgRevenue,
          avgBrokerFee,
          feePercent,
          cleanRevenue,
          estimatedProfit,
          profitPerLoad,
          lastOrderDate,
          daysSinceLastOrder,
          ordersPerMonth,
          reliabilityScore
        };
      }).sort((a, b) => b.estimatedProfit - a.estimatedProfit); // Sort by profit
      
      // Calculate totals for summary
      const totalBrokersRevenue = brokerStats.reduce((s, b) => s + b.totalRevenue, 0);
      const totalBrokersFees = brokerStats.reduce((s, b) => s + b.totalBrokerFee, 0);
      const totalBrokersProfit = brokerStats.reduce((s, b) => s + b.estimatedProfit, 0);
      const avgFeePercent = totalBrokersRevenue > 0 ? (totalBrokersFees / totalBrokersRevenue * 100) : 0;
      
      const getScoreColor = (score) => {
        if (score >= 80) return '#16a34a';
        if (score >= 60) return '#2563eb';
        if (score >= 40) return '#f59e0b';
        return '#dc2626';
      };
      
      const getScoreLabel = (score) => {
        if (score >= 80) return 'Excellent';
        if (score >= 60) return 'Good';
        if (score >= 40) return 'Fair';
        return 'New';
      };
      
      const getActivityStatus = (days) => {
        if (days === null) return { label: 'No orders', color: '#94a3b8', bg: '#f1f5f9' };
        if (days <= 7) return { label: 'Active', color: '#16a34a', bg: '#dcfce7' };
        if (days <= 30) return { label: 'Recent', color: '#2563eb', bg: '#dbeafe' };
        if (days <= 90) return { label: 'Inactive', color: '#f59e0b', bg: '#fef3c7' };
        return { label: 'Dormant', color: '#dc2626', bg: '#fee2e2' };
      };
      
      c.innerHTML = '<div class="header"><h2>ðŸ¢ Brokers</h2><div style="display:flex;gap:12px"><button class="btn btn-primary" onclick="openBrokerModal()">+ New Broker</button></div></div>' +
        
        // Summary Cards
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px">' +
        '<div style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;padding:20px;border-radius:12px;text-align:center">' +
        '<div style="font-size:12px;opacity:0.9">Total Brokers</div>' +
        '<div style="font-size:32px;font-weight:800">' + brokerStats.length + '</div></div>' +
        '<div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:12px;text-align:center">' +
        '<div style="font-size:12px;opacity:0.9">Total Revenue</div>' +
        '<div style="font-size:24px;font-weight:800">' + formatMoney(totalBrokersRevenue) + '</div></div>' +
        '<div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:white;padding:20px;border-radius:12px;text-align:center">' +
        '<div style="font-size:12px;opacity:0.9">Avg Fee %</div>' +
        '<div style="font-size:32px;font-weight:800">' + avgFeePercent.toFixed(1) + '%</div></div>' +
        '<div style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:white;padding:20px;border-radius:12px;text-align:center">' +
        '<div style="font-size:12px;opacity:0.9">Est. Total Profit</div>' +
        '<div style="font-size:24px;font-weight:800">' + formatMoney(totalBrokersProfit) + '</div></div>' +
        '</div>' +
        
        // Broker Cards Grid
        '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:20px">' +
        (brokerStats.length === 0 ? '<div style="grid-column:1/-1;text-align:center;padding:60px;background:#f8fafc;border-radius:12px">No brokers yet. Add your first broker!</div>' :
        brokerStats.map((b, idx) => {
          const activity = getActivityStatus(b.daysSinceLastOrder);
          const scoreColor = getScoreColor(b.reliabilityScore);
          const scoreLabel = getScoreLabel(b.reliabilityScore);
          const rankBadge = idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : idx === 2 ? 'ðŸ¥‰' : '';
          
          return '<div class="card" style="padding:0;overflow:hidden;transition:transform 0.2s,box-shadow 0.2s" onmouseover="this.style.transform=\'translateY(-4px)\';this.style.boxShadow=\'0 8px 25px rgba(0,0,0,0.15)\'" onmouseout="this.style.transform=\'none\';this.style.boxShadow=\'var(--shadow)\'">' +
            // Header
            '<div style="background:linear-gradient(135deg,#1e293b,#334155);color:white;padding:16px 20px;display:flex;justify-content:space-between;align-items:center">' +
            '<div style="display:flex;align-items:center;gap:12px">' +
            (rankBadge ? '<span style="font-size:24px">' + rankBadge + '</span>' : '') +
            '<div><div style="font-size:18px;font-weight:700">' + b.name + '</div>' +
            '<div style="font-size:12px;opacity:0.8">' + b.orderCount + ' loads â€¢ ' + b.tripCount + ' trips</div></div></div>' +
            '<div style="text-align:right">' +
            '<div style="font-size:11px;padding:4px 10px;border-radius:12px;background:' + activity.bg + ';color:' + activity.color + ';font-weight:600">' + activity.label + '</div>' +
            '</div></div>' +
            
            // Score Bar
            '<div style="padding:12px 20px;background:#f8fafc;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;gap:12px">' +
            '<div style="flex:1">' +
            '<div style="display:flex;justify-content:space-between;margin-bottom:4px">' +
            '<span style="font-size:11px;color:#64748b">Reliability Score</span>' +
            '<span style="font-size:11px;font-weight:600;color:' + scoreColor + '">' + scoreLabel + ' (' + b.reliabilityScore + '/100)</span></div>' +
            '<div style="height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden">' +
            '<div style="height:100%;width:' + b.reliabilityScore + '%;background:' + scoreColor + ';border-radius:4px;transition:width 0.3s"></div></div></div></div>' +
            
            // Stats Grid
            '<div style="padding:16px 20px">' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">' +
            
            // Avg Rate
            '<div style="background:#dbeafe;padding:12px;border-radius:8px">' +
            '<div style="font-size:10px;color:#1d4ed8;text-transform:uppercase;letter-spacing:0.5px">Avg Rate/Load</div>' +
            '<div style="font-size:20px;font-weight:700;color:#1e40af">' + formatMoney(b.avgRevenue) + '</div></div>' +
            
            // Avg Fee
            '<div style="background:#fef3c7;padding:12px;border-radius:8px">' +
            '<div style="font-size:10px;color:#b45309;text-transform:uppercase;letter-spacing:0.5px">Avg Fee</div>' +
            '<div style="font-size:20px;font-weight:700;color:#d97706">' + formatMoney(b.avgBrokerFee) + ' <span style="font-size:12px;font-weight:500">(' + b.feePercent.toFixed(1) + '%)</span></div></div>' +
            
            // Profit/Load
            '<div style="background:' + (b.profitPerLoad >= 0 ? '#dcfce7' : '#fee2e2') + ';padding:12px;border-radius:8px">' +
            '<div style="font-size:10px;color:' + (b.profitPerLoad >= 0 ? '#16a34a' : '#dc2626') + ';text-transform:uppercase;letter-spacing:0.5px">Est. Profit/Load</div>' +
            '<div style="font-size:20px;font-weight:700;color:' + (b.profitPerLoad >= 0 ? '#15803d' : '#dc2626') + '">' + formatMoney(b.profitPerLoad) + '</div></div>' +
            
            // Total Revenue
            '<div style="background:#f1f5f9;padding:12px;border-radius:8px">' +
            '<div style="font-size:10px;color:#475569;text-transform:uppercase;letter-spacing:0.5px">Total Revenue</div>' +
            '<div style="font-size:20px;font-weight:700;color:#334155">' + formatMoney(b.totalRevenue) + '</div></div>' +
            
            '</div>' +
            
            // Additional Stats Row
            '<div style="display:flex;justify-content:space-between;padding:12px 0;border-top:1px solid #e2e8f0;font-size:12px;color:#64748b">' +
            '<div><span>ðŸ“Š Loads/Month:</span> <strong style="color:#334155">' + b.ordersPerMonth.toFixed(1) + '</strong></div>' +
            '<div><span>ðŸ’° Total Fees:</span> <strong style="color:#f59e0b">' + formatMoney(b.totalBrokerFee) + '</strong></div>' +
            '</div>' +
            
            // Last Order Info
            (b.lastOrderDate ? '<div style="font-size:11px;color:#94a3b8;text-align:center;padding-top:8px;border-top:1px dashed #e2e8f0">Last order: ' + b.lastOrderDate.toLocaleDateString() + ' (' + b.daysSinceLastOrder + ' days ago)</div>' : '') +
            
            '</div>' +
            
            // Actions Footer
            '<div style="padding:12px 20px;background:#f8fafc;border-top:1px solid #e2e8f0;display:flex;justify-content:flex-end;gap:8px">' +
            '<button class="action-btn edit" onclick="openBrokerModal(' + b.id + ')">Edit</button>' +
            '<button class="action-btn delete" onclick="deleteBroker(' + b.id + ')">Delete</button>' +
            '</div></div>';
        }).join('')) +
        '</div>';
    }

    function openBrokerModal(id = null) {
      const b = id ? appData.brokers.find(x => x.id === id) : null;
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:400px"><div class="modal-header"><h3>' + (b ? 'Edit' : 'New') + ' Broker</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body">' +
        '<div class="form-group"><label>Broker Name</label><input id="brokerName" value="' + (b?.name || '') + '" placeholder="e.g., Central Dispatch"></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveBroker(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    async function saveBroker(id) {
      const name = document.getElementById('brokerName').value;
      if (!name) { showToast('Broker name is required', 'error'); return; }
      
      const data = { name: name };
      
      try {
        if (id) {
          await dbUpdate('brokers', id, data);
          await logActivity('BROKER_UPDATED', { broker_id: id, broker_name: name });
        } else {
          const newBroker = await dbInsert('brokers', data);
          await logActivity('BROKER_CREATED', { broker_id: newBroker.id, broker_name: name });
        }
        document.querySelector('.modal-overlay').remove();
        showToast('Broker saved!');
        await loadAllData();
        renderBrokers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteBroker(id) {
      if (!confirm('Delete this broker?')) return;
      try {
        const broker = appData.brokers.find(b => b.id === id);
        await dbDelete('brokers', id);
        await logActivity('BROKER_DELETED', { broker_id: id, broker_name: broker?.name });
        showToast('Broker deleted');
        await loadAllData();
        renderBrokers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    function renderDispatchers(c) {
      c.innerHTML = '<div class="header"><h2>Dispatchers</h2><button class="btn btn-primary" onclick="openDispModal()">+ New Dispatcher</button></div><div class="card"><div class="table-wrapper"><table><thead><tr><th>Code</th><th>Name</th><th>Cars Booked</th><th>Revenue Generated</th><th>Actions</th></tr></thead><tbody>' + (appData.dispatchers.length === 0 ? '<tr><td colspan="5" style="text-align:center;padding:40px">No dispatchers yet</td></tr>' : appData.dispatchers.map(d => { const dispOrders = appData.orders.filter(o => o.dispatcher_id === d.id); const cars = dispOrders.length; const rev = dispOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0); return '<tr><td><strong>' + d.code + '</strong></td><td>' + d.name + '</td><td>' + cars + '</td><td class="money positive">' + formatMoney(rev) + '</td><td><div class="actions"><button class="action-btn edit" onclick="openDispModal(' + d.id + ')">Edit</button><button class="action-btn delete" onclick="deleteDisp(' + d.id + ')">Del</button></div></td></tr>'; }).join('')) + '</tbody></table></div></div>';
    }

    function openDispModal(id = null) {
      const d = id ? appData.dispatchers.find(x => x.id === id) : null;
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:400px"><div class="modal-header"><h3>' + (d ? 'Edit' : 'New') + ' Dispatcher</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body"><div class="form-group"><label>Code</label><input id="dispCode" value="' + (d?.code || 'D' + (appData.dispatchers.length + 1)) + '"></div><div class="form-group"><label>Name</label><input id="dispName" value="' + (d?.name || '') + '"></div><div class="form-group"><label>Link to User Account</label><select id="dispUser"><option value="">No User Account</option>' + appData.users.map(u => '<option value="' + u.id + '"' + (d?.user_id === u.id ? ' selected' : '') + '>' + u.first_name + ' ' + u.last_name + ' (' + u.email + ')</option>').join('') + '</select></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveDisp(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    async function saveDisp(id) {
      const data = { code: document.getElementById('dispCode').value, name: document.getElementById('dispName').value, user_id: parseInt(document.getElementById('dispUser').value) || null };
      try { 
        if (id) { 
          await dbUpdate('dispatchers', id, data); 
          await logActivity('DISPATCHER_UPDATED', { dispatcher_id: id, dispatcher_name: data.name, dispatcher_code: data.code });
        } else { 
          const newDisp = await dbInsert('dispatchers', data); 
          await logActivity('DISPATCHER_CREATED', { dispatcher_id: newDisp.id, dispatcher_name: data.name, dispatcher_code: data.code });
        } 
        document.querySelector('.modal-overlay').remove(); showToast('Saved!'); await loadAllData(); renderDispatchers(document.getElementById('main-content')); 
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteDisp(id) { 
      if (!confirm('Delete?')) return; 
      const disp = appData.dispatchers.find(d => d.id === id);
      await dbDelete('dispatchers', id); 
      await logActivity('DISPATCHER_DELETED', { dispatcher_id: id, dispatcher_name: disp?.name });
      showToast('Deleted'); await loadAllData(); renderDispatchers(document.getElementById('main-content')); 
    }

    // ============ DISPATCHER RANKING SECTION ============
    let dispRankPeriod = 'month';
    let dispRankMonth = new Date().getMonth() + 1;
    let dispRankYear = new Date().getFullYear();

    function getDispRankDateRange() {
      if (dispRankPeriod === 'all') return { start: null, end: null };
      if (dispRankPeriod === 'month') {
        const start = dispRankYear + '-' + String(dispRankMonth).padStart(2, '0') + '-01';
        const lastDay = new Date(dispRankYear, dispRankMonth, 0).getDate();
        const end = dispRankYear + '-' + String(dispRankMonth).padStart(2, '0') + '-' + lastDay;
        return { start, end };
      } else if (dispRankPeriod === 'q1') {
        return { start: dispRankYear + '-01-01', end: dispRankYear + '-03-31' };
      } else if (dispRankPeriod === 'q2') {
        return { start: dispRankYear + '-04-01', end: dispRankYear + '-06-30' };
      } else if (dispRankPeriod === 'q3') {
        return { start: dispRankYear + '-07-01', end: dispRankYear + '-09-30' };
      } else if (dispRankPeriod === 'q4') {
        return { start: dispRankYear + '-10-01', end: dispRankYear + '-12-31' };
      } else { // year
        return { start: dispRankYear + '-01-01', end: dispRankYear + '-12-31' };
      }
    }

    function getDispRankPeriodLabel() {
      const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      if (dispRankPeriod === 'all') return 'All Time';
      if (dispRankPeriod === 'month') return months[dispRankMonth] + ' ' + dispRankYear;
      if (dispRankPeriod === 'q1') return 'Q1 (Jan-Mar) ' + dispRankYear;
      if (dispRankPeriod === 'q2') return 'Q2 (Apr-Jun) ' + dispRankYear;
      if (dispRankPeriod === 'q3') return 'Q3 (Jul-Sep) ' + dispRankYear;
      if (dispRankPeriod === 'q4') return 'Q4 (Oct-Dec) ' + dispRankYear;
      return 'Year ' + dispRankYear;
    }

    function renderDispatcherRanking(c) {
      const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const range = getDispRankDateRange();
      
      // Filter orders by date range (use pickup_date or created_at)
      let filteredOrders = appData.orders;
      if (range.start && range.end) {
        filteredOrders = appData.orders.filter(o => {
          const orderDate = o.pickup_date || o.created_at?.split('T')[0];
          if (!orderDate) return false;
          return orderDate >= range.start && orderDate <= range.end;
        });
      }
      
      // Calculate stats for each dispatcher
      const dispStats = {};
      appData.dispatchers.forEach(d => {
        dispStats[d.id] = {
          id: d.id,
          name: d.name,
          code: d.code || '-',
          cars: 0,
          revenue: 0,
          brokerFees: 0,
          localFees: 0,
          cleanRevenue: 0,
          avgPricePerCar: 0
        };
      });
      
      // Aggregate orders by dispatcher
      filteredOrders.forEach(o => {
        if (o.dispatcher_id && dispStats[o.dispatcher_id]) {
          const rev = parseFloat(o.revenue || 0);
          const brokerFee = parseFloat(o.broker_fee || 0);
          const localFee = parseFloat(o.local_fee || 0);
          dispStats[o.dispatcher_id].cars++;
          dispStats[o.dispatcher_id].revenue += rev;
          dispStats[o.dispatcher_id].brokerFees += brokerFee;
          dispStats[o.dispatcher_id].localFees += localFee;
          dispStats[o.dispatcher_id].cleanRevenue += (rev - brokerFee - localFee);
        }
      });
      
      // Calculate averages and convert to array
      const dispArray = Object.values(dispStats).map(d => {
        d.avgPricePerCar = d.cars > 0 ? d.revenue / d.cars : 0;
        return d;
      });
      
      // Sort by cars booked (descending) for ranking
      const rankedByCars = [...dispArray].sort((a, b) => b.cars - a.cars);
      const rankedByRevenue = [...dispArray].sort((a, b) => b.revenue - a.revenue);
      const rankedByCleanRevenue = [...dispArray].sort((a, b) => b.cleanRevenue - a.cleanRevenue);
      
      // Totals
      const totalCars = dispArray.reduce((s, d) => s + d.cars, 0);
      const totalRevenue = dispArray.reduce((s, d) => s + d.revenue, 0);
      const totalCleanRevenue = dispArray.reduce((s, d) => s + d.cleanRevenue, 0);
      const avgPriceOverall = totalCars > 0 ? totalRevenue / totalCars : 0;
      
      // Find top performer
      const topDispatcher = rankedByRevenue[0];
      const bottomDispatcher = rankedByRevenue[rankedByRevenue.length - 1];
      
      // Build ranking table rows with medals
      const getMedal = (rank) => {
        if (rank === 0) return '<span style="font-size:20px">ðŸ¥‡</span>';
        if (rank === 1) return '<span style="font-size:20px">ðŸ¥ˆ</span>';
        if (rank === 2) return '<span style="font-size:20px">ðŸ¥‰</span>';
        return '<span style="color:#64748b;font-weight:700">#' + (rank + 1) + '</span>';
      };
      
      const getProgressBar = (value, max, color) => {
        const percent = max > 0 ? (value / max * 100) : 0;
        return '<div style="background:rgba(255,255,255,0.1);border-radius:4px;height:8px;width:100%;min-width:60px"><div style="background:' + color + ';height:100%;border-radius:4px;width:' + percent + '%"></div></div>';
      };
      
      const maxCars = Math.max(...dispArray.map(d => d.cars), 1);
      const maxRevenue = Math.max(...dispArray.map(d => d.revenue), 1);
      
      c.innerHTML = '<div class="header"><h2>ðŸ† Dispatcher Performance Ranking</h2></div>' +
        
        // Period selector
        '<div class="card" style="padding:16px;margin-bottom:24px"><div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">' +
        '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Period</label><select id="dispRankPeriod" onchange="dispRankPeriod=this.value;renderDispatcherRanking(document.getElementById(\'main-content\'))"><option value="all"' + (dispRankPeriod === 'all' ? ' selected' : '') + '>All Time</option><option value="month"' + (dispRankPeriod === 'month' ? ' selected' : '') + '>Monthly</option><option value="q1"' + (dispRankPeriod === 'q1' ? ' selected' : '') + '>Q1 (Jan-Mar)</option><option value="q2"' + (dispRankPeriod === 'q2' ? ' selected' : '') + '>Q2 (Apr-Jun)</option><option value="q3"' + (dispRankPeriod === 'q3' ? ' selected' : '') + '>Q3 (Jul-Sep)</option><option value="q4"' + (dispRankPeriod === 'q4' ? ' selected' : '') + '>Q4 (Oct-Dec)</option><option value="year"' + (dispRankPeriod === 'year' ? ' selected' : '') + '>Full Year</option></select></div>' +
        (dispRankPeriod === 'month' ? '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Month</label><select id="dispRankMonth" onchange="dispRankMonth=parseInt(this.value);renderDispatcherRanking(document.getElementById(\'main-content\'))">' + months.slice(1).map((m, i) => '<option value="' + (i+1) + '"' + (dispRankMonth === i+1 ? ' selected' : '') + '>' + m + '</option>').join('') + '</select></div>' : '') +
        (dispRankPeriod !== 'all' ? '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Year</label><select id="dispRankYear" onchange="dispRankYear=parseInt(this.value);renderDispatcherRanking(document.getElementById(\'main-content\'))"><option value="2024"' + (dispRankYear === 2024 ? ' selected' : '') + '>2024</option><option value="2025"' + (dispRankYear === 2025 ? ' selected' : '') + '>2025</option><option value="2026"' + (dispRankYear === 2026 ? ' selected' : '') + '>2026</option><option value="2027"' + (dispRankYear === 2027 ? ' selected' : '') + '>2027</option></select></div>' : '') +
        '<div style="margin-left:auto;font-size:18px;font-weight:700;color:#1e40af">ðŸ“… ' + getDispRankPeriodLabel() + '</div></div></div>' +
        
        // Summary stats
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:12px 16px"><div class="label">Total Dispatchers</div><div class="value">' + appData.dispatchers.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:12px 16px"><div class="label">Total Cars Booked</div><div class="value">' + totalCars + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px"><div class="label">Total Revenue</div><div class="value">' + formatMoney(totalRevenue) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px;background:rgba(59,130,246,0.15);border:1px solid rgba(59,130,246,0.3)"><div class="label">Clean Revenue</div><div class="value" style="color:#60a5fa">' + formatMoney(totalCleanRevenue) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Avg Price/Car</div><div class="value">' + formatMoney(avgPriceOverall) + '</div></div>' +
        '</div>' +
        
        // Top & Bottom performers cards
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:24px">' +
        '<div class="card" style="padding:20px;border-left:4px solid #10b981">' +
        '<div style="display:flex;align-items:center;gap:12px"><span style="font-size:32px">ðŸ†</span><div><div style="font-size:12px;color:#9ca3af">TOP PERFORMER</div><div style="font-size:24px;font-weight:700;color:#4ade80">' + (topDispatcher?.name || '-') + '</div></div></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px">' +
        '<div style="background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#4ade80">Cars</div><div style="font-size:20px;font-weight:700;color:#4ade80">' + (topDispatcher?.cars || 0) + '</div></div>' +
        '<div style="background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#4ade80">Revenue</div><div style="font-size:20px;font-weight:700;color:#4ade80">' + formatMoney(topDispatcher?.revenue || 0) + '</div></div>' +
        '</div></div>' +
        
        '<div class="card" style="padding:20px;border-left:4px solid #f59e0b">' +
        '<div style="display:flex;align-items:center;gap:12px"><span style="font-size:32px">ðŸ“ˆ</span><div><div style="font-size:12px;color:#9ca3af">NEEDS IMPROVEMENT</div><div style="font-size:24px;font-weight:700;color:#fbbf24">' + (bottomDispatcher?.name || '-') + '</div></div></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px">' +
        '<div style="background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.3);padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#fbbf24">Cars</div><div style="font-size:20px;font-weight:700;color:#fbbf24">' + (bottomDispatcher?.cars || 0) + '</div></div>' +
        '<div style="background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.3);padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#fbbf24">Revenue</div><div style="font-size:20px;font-weight:700;color:#fbbf24">' + formatMoney(bottomDispatcher?.revenue || 0) + '</div></div>' +
        '</div></div>' +
        '</div>' +
        
        // Full ranking table
        '<div class="card"><div class="card-header"><h3>ðŸ“Š Full Ranking (by Revenue)</h3></div><div class="table-wrapper"><table><thead><tr><th style="width:60px">Rank</th><th>Dispatcher</th><th style="text-align:center">Cars Booked</th><th style="text-align:center">Cars Progress</th><th style="text-align:right">Revenue</th><th style="text-align:center">Revenue Progress</th><th style="text-align:right">Broker Fees</th><th style="text-align:right">Local Fees</th><th style="text-align:right">Clean Revenue</th><th style="text-align:right">Avg $/Car</th></tr></thead><tbody>' +
        (rankedByRevenue.length === 0 ? '<tr><td colspan="10" style="text-align:center;padding:40px">No dispatcher data for this period</td></tr>' :
        rankedByRevenue.map((d, i) =>
          '<tr style="' + (i === 0 ? 'background:rgba(34,197,94,0.1)' : i === rankedByRevenue.length - 1 && rankedByRevenue.length > 1 ? 'background:rgba(245,158,11,0.1)' : '') + '">' +
          '<td style="text-align:center">' + getMedal(i) + '</td>' +
          '<td><strong>' + d.name + '</strong><span style="color:#64748b;margin-left:8px;font-size:12px">' + d.code + '</span></td>' +
          '<td style="text-align:center;font-weight:600">' + d.cars + '</td>' +
          '<td>' + getProgressBar(d.cars, maxCars, '#3b82f6') + '</td>' +
          '<td style="text-align:right" class="money">' + formatMoney(d.revenue) + '</td>' +
          '<td>' + getProgressBar(d.revenue, maxRevenue, '#10b981') + '</td>' +
          '<td style="text-align:right" class="money negative">' + formatMoney(d.brokerFees) + '</td>' +
          '<td style="text-align:right" class="money negative">' + formatMoney(d.localFees) + '</td>' +
          '<td style="text-align:right;font-weight:600;color:#1d4ed8">' + formatMoney(d.cleanRevenue) + '</td>' +
          '<td style="text-align:right">' + formatMoney(d.avgPricePerCar) + '</td>' +
          '</tr>'
        ).join('')) +
        '<tr style="background:rgba(255,255,255,0.05);font-weight:700"><td colspan="2" style="text-align:right">TOTALS:</td><td style="text-align:center">' + totalCars + '</td><td></td><td style="text-align:right">' + formatMoney(totalRevenue) + '</td><td></td><td style="text-align:right;color:#f87171">' + formatMoney(dispArray.reduce((s,d) => s + d.brokerFees, 0)) + '</td><td style="text-align:right;color:#f87171">' + formatMoney(dispArray.reduce((s,d) => s + d.localFees, 0)) + '</td><td style="text-align:right;color:#60a5fa">' + formatMoney(totalCleanRevenue) + '</td><td style="text-align:right">' + formatMoney(avgPriceOverall) + '</td></tr>' +
        '</tbody></table></div></div>' +
        
        // Visual comparison cards
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:24px">' +
        
        // Cars leaderboard
        '<div class="card" style="padding:20px"><h3 style="margin-bottom:16px;color:#3b82f6">ðŸš— Cars Booked Leaderboard</h3>' +
        rankedByCards(rankedByRevenue.slice(0, 5).map((d, i) => ({
          rank: i,
          name: d.name,
          value: d.cars,
          label: d.cars + ' cars',
          percent: maxCars > 0 ? (d.cars / maxCars * 100) : 0,
          color: '#3b82f6'
        }))) + '</div>' +
        
        // Revenue leaderboard
        '<div class="card" style="padding:20px"><h3 style="margin-bottom:16px;color:#10b981">ðŸ’° Revenue Leaderboard</h3>' +
        rankedByCards(rankedByRevenue.slice(0, 5).map((d, i) => ({
          rank: i,
          name: d.name,
          value: d.revenue,
          label: formatMoney(d.revenue),
          percent: maxRevenue > 0 ? (d.revenue / maxRevenue * 100) : 0,
          color: '#10b981'
        }))) + '</div>' +
        '</div>';
    }
    
    function rankedByCards(items) {
      const getMedal = (rank) => {
        if (rank === 0) return 'ðŸ¥‡';
        if (rank === 1) return 'ðŸ¥ˆ';
        if (rank === 2) return 'ðŸ¥‰';
        return '#' + (rank + 1);
      };
      
      return items.map(item => 
        '<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">' +
        '<span style="font-size:16px;width:30px">' + getMedal(item.rank) + '</span>' +
        '<div style="flex:1"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-weight:600">' + item.name + '</span><span style="color:#64748b">' + item.label + '</span></div>' +
        '<div style="background:rgba(255,255,255,0.1);border-radius:4px;height:8px"><div style="background:' + item.color + ';height:100%;border-radius:4px;width:' + item.percent + '%"></div></div></div></div>'
      ).join('');
    }

    // ============ FUEL TRACKING SECTION ============
    let fuelPeriod = 'month'; // 'month', 'q1', 'q2', 'q3', 'q4', 'year'
    let fuelAnalyticsTab = 'overview'; // 'overview', 'analytics', 'efficiency', 'prices'
    let fuelMonth = new Date().getMonth() + 1;
    let fuelYear = new Date().getFullYear();

    function getFuelDateRange() {
      if (fuelPeriod === 'month') {
        const start = fuelYear + '-' + String(fuelMonth).padStart(2, '0') + '-01';
        const lastDay = new Date(fuelYear, fuelMonth, 0).getDate();
        const end = fuelYear + '-' + String(fuelMonth).padStart(2, '0') + '-' + lastDay;
        return { start, end };
      } else if (fuelPeriod === 'q1') {
        return { start: fuelYear + '-01-01', end: fuelYear + '-03-31' };
      } else if (fuelPeriod === 'q2') {
        return { start: fuelYear + '-04-01', end: fuelYear + '-06-30' };
      } else if (fuelPeriod === 'q3') {
        return { start: fuelYear + '-07-01', end: fuelYear + '-09-30' };
      } else if (fuelPeriod === 'q4') {
        return { start: fuelYear + '-10-01', end: fuelYear + '-12-31' };
      } else { // year
        return { start: fuelYear + '-01-01', end: fuelYear + '-12-31' };
      }
    }

    function getFuelPeriodLabel() {
      const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      if (fuelPeriod === 'month') return months[fuelMonth] + ' ' + fuelYear;
      if (fuelPeriod === 'q1') return 'Q1 (Jan-Mar) ' + fuelYear;
      if (fuelPeriod === 'q2') return 'Q2 (Apr-Jun) ' + fuelYear;
      if (fuelPeriod === 'q3') return 'Q3 (Jul-Sep) ' + fuelYear;
      if (fuelPeriod === 'q4') return 'Q4 (Oct-Dec) ' + fuelYear;
      return 'Year ' + fuelYear;
    }

    // Fuel tracking filter variables
    let selectedFuelTruck = null;
    let fuelFilterTruck = '';
    let fuelFilterState = '';
    let fuelFilterProduct = '';
    let fuelFilterDriver = '';
    
    function clearFuelFilters() {
      fuelFilterTruck = '';
      fuelFilterState = '';
      fuelFilterProduct = '';
      fuelFilterDriver = '';
      selectedFuelTruck = null;
      renderFuelTracking(document.getElementById('main-content'));
    }
    
    function renderFuelTracking(c) {
      const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const range = getFuelDateRange();
      
      // Get all transactions for the period (before filters) for dropdown options
      const periodTxns = (appData.fuel_transactions || []).filter(t => {
        if (!t.transaction_date) return false;
        const d = t.transaction_date;
        return d >= range.start && d <= range.end;
      });
      
      // Get unique values for filter dropdowns
      const uniqueTrucks = [...new Set(periodTxns.map(t => t.truck_number).filter(Boolean))].sort((a, b) => a - b);
      const uniqueStates = [...new Set(periodTxns.map(t => t.state).filter(Boolean))].sort();
      const uniqueProducts = [...new Set(periodTxns.map(t => t.product).filter(t => t !== 'Txn Fee'))];
      const uniqueDrivers = [...new Set(periodTxns.map(t => t.driver_name).filter(Boolean))].sort();
      
      // Apply all filters
      let filteredTxns = periodTxns;
      
      // Apply truck filter (either from dropdown or drill-down)
      if (selectedFuelTruck) {
        filteredTxns = filteredTxns.filter(t => t.truck_number == selectedFuelTruck);
      } else if (fuelFilterTruck) {
        filteredTxns = filteredTxns.filter(t => t.truck_number == fuelFilterTruck);
      }
      
      // Apply state filter
      if (fuelFilterState) {
        filteredTxns = filteredTxns.filter(t => t.state === fuelFilterState);
      }
      
      // Apply product filter
      if (fuelFilterProduct) {
        filteredTxns = filteredTxns.filter(t => t.product === fuelFilterProduct);
      }
      
      // Apply driver filter
      if (fuelFilterDriver) {
        filteredTxns = filteredTxns.filter(t => t.driver_name === fuelFilterDriver);
      }
      
      // Check if any filters are active
      const hasActiveFilters = fuelFilterTruck || fuelFilterState || fuelFilterProduct || fuelFilterDriver || selectedFuelTruck;
      
      // Calculate stats
      const dieselTxns = filteredTxns.filter(t => t.product === 'ULSD');
      const defTxns = filteredTxns.filter(t => t.product === 'DEF');
      const feeTxns = filteredTxns.filter(t => t.product === 'Txn Fee');
      
      const totalDieselGal = dieselTxns.reduce((s, t) => s + parseFloat(t.gallons || 0), 0);
      const totalDieselCost = dieselTxns.reduce((s, t) => s + parseFloat(t.amount || 0), 0);
      const totalDefGal = defTxns.reduce((s, t) => s + parseFloat(t.gallons || 0), 0);
      const totalDefCost = defTxns.reduce((s, t) => s + parseFloat(t.amount || 0), 0);
      const totalFees = feeTxns.reduce((s, t) => s + parseFloat(t.amount || 0), 0);
      const totalSavings = filteredTxns.reduce((s, t) => s + parseFloat(t.savings || 0), 0);
      const avgPricePerGal = totalDieselGal > 0 ? totalDieselCost / totalDieselGal : 0;
      const avgDiscountPerGal = totalDieselGal > 0 ? (totalSavings / totalDieselGal) * 100 : 0;
      const totalCost = totalDieselCost + totalDefCost + totalFees;
      
      // Calculate miles for the period (from trips)
      let periodMiles = 0;
      const activeTruckFilter = selectedFuelTruck || fuelFilterTruck;
      const periodTrips = activeTruckFilter 
        ? appData.trips.filter(t => {
            const truck = appData.trucks.find(tr => tr.id === t.truck_id);
            return truck && truck.truck_number == activeTruckFilter && t.trip_date >= range.start && t.trip_date <= range.end;
          })
        : appData.trips.filter(t => t.trip_date >= range.start && t.trip_date <= range.end);
      periodMiles = periodTrips.reduce((s, t) => s + parseFloat(t.miles || 0), 0);
      
      const mpg = periodMiles > 0 && totalDieselGal > 0 ? periodMiles / totalDieselGal : 0;
      const costPerMile = periodMiles > 0 ? totalDieselCost / periodMiles : 0;
      const fillUps = dieselTxns.length;
      const avgGallonsPerFillUp = fillUps > 0 ? totalDieselGal / fillUps : 0;
      
      // Group by truck
      const truckStats = {};
      (appData.fuel_transactions || []).filter(t => {
        if (!t.transaction_date) return false;
        const d = t.transaction_date;
        return d >= range.start && d <= range.end;
      }).forEach(t => {
        if (!truckStats[t.truck_number]) truckStats[t.truck_number] = { diesel: 0, def: 0, cost: 0, savings: 0, fillUps: 0 };
        if (t.product === 'ULSD') { 
          truckStats[t.truck_number].diesel += parseFloat(t.gallons || 0); 
          truckStats[t.truck_number].cost += parseFloat(t.amount || 0); 
          truckStats[t.truck_number].fillUps++;
        }
        if (t.product === 'DEF') { 
          truckStats[t.truck_number].def += parseFloat(t.gallons || 0); 
          truckStats[t.truck_number].cost += parseFloat(t.amount || 0); 
        }
        truckStats[t.truck_number].savings += parseFloat(t.savings || 0);
      });
      
      // Calculate miles per truck
      Object.keys(truckStats).forEach(tn => {
        const truck = appData.trucks.find(t => t.truck_number == tn);
        if (truck) {
          const truckTrips = appData.trips.filter(t => t.truck_id === truck.id && t.trip_date >= range.start && t.trip_date <= range.end);
          truckStats[tn].miles = truckTrips.reduce((s, t) => s + parseFloat(t.miles || 0), 0);
          truckStats[tn].mpg = truckStats[tn].miles > 0 && truckStats[tn].diesel > 0 ? truckStats[tn].miles / truckStats[tn].diesel : 0;
          truckStats[tn].costPerMile = truckStats[tn].miles > 0 ? truckStats[tn].cost / truckStats[tn].miles : 0;
        }
      });
      
      // Group by state
      const stateStats = {};
      filteredTxns.filter(t => t.product === 'ULSD').forEach(t => {
        if (!stateStats[t.state]) stateStats[t.state] = { gallons: 0, cost: 0, fillUps: 0 };
        stateStats[t.state].gallons += parseFloat(t.gallons || 0);
        stateStats[t.state].cost += parseFloat(t.amount || 0);
        stateStats[t.state].fillUps++;
      });
      
      // Top locations
      const locationStats = {};
      filteredTxns.filter(t => t.product === 'ULSD').forEach(t => {
        const loc = t.location || 'Unknown';
        if (!locationStats[loc]) locationStats[loc] = { gallons: 0, cost: 0, visits: 0, city: t.city, state: t.state };
        locationStats[loc].gallons += parseFloat(t.gallons || 0);
        locationStats[loc].cost += parseFloat(t.amount || 0);
        locationStats[loc].visits++;
      });
      const topLocations = Object.entries(locationStats)
        .sort((a, b) => b[1].visits - a[1].visits)
        .slice(0, 5);
      
      // Monthly trend (for yearly view)
      const monthlyTrend = {};
      if (fuelPeriod === 'year' || fuelPeriod.startsWith('q')) {
        filteredTxns.filter(t => t.product === 'ULSD').forEach(t => {
          const month = t.transaction_date.substring(0, 7);
          if (!monthlyTrend[month]) monthlyTrend[month] = { gallons: 0, cost: 0, fillUps: 0 };
          monthlyTrend[month].gallons += parseFloat(t.gallons || 0);
          monthlyTrend[month].cost += parseFloat(t.amount || 0);
          monthlyTrend[month].fillUps++;
        });
      }
      
      // Build header with filter indicator
      let filterLabel = '';
      if (selectedFuelTruck) filterLabel = ' - Truck #' + selectedFuelTruck;
      else if (hasActiveFilters) filterLabel = ' (Filtered)';
      
      let headerContent = '<div class="header"><h2>â›½ Fuel Tracking' + filterLabel + '</h2><div style="display:flex;gap:12px">';
      if (selectedFuelTruck) {
        headerContent += '<button class="btn btn-secondary" onclick="selectedFuelTruck=null;renderFuelTracking(document.getElementById(\'main-content\'))">â† Back to All Trucks</button>';
      }
      headerContent += '<button class="btn btn-primary" onclick="openFuelUploadModal()">ðŸ“¤ Upload Fuel Report</button>' + 
        (filteredTxns.length > 0 && !selectedFuelTruck ? '<button class="btn btn-secondary" style="background:#fee2e2;color:#dc2626;border-color:#fecaca" onclick="deletePeriodFuelData()">ðŸ—‘ï¸ Delete Period Data</button>' : '') + 
        '</div></div>';
      
      c.innerHTML = headerContent +
        
        // Period selector and Filters
        '<div class="card" style="padding:16px;margin-bottom:24px">' +
        '<div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin-bottom:16px">' +
        '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Period</label><select id="fuelPeriod" onchange="fuelPeriod=this.value;renderFuelTracking(document.getElementById(\'main-content\'))"><option value="month"' + (fuelPeriod === 'month' ? ' selected' : '') + '>Monthly</option><option value="q1"' + (fuelPeriod === 'q1' ? ' selected' : '') + '>Q1 (Jan-Mar)</option><option value="q2"' + (fuelPeriod === 'q2' ? ' selected' : '') + '>Q2 (Apr-Jun)</option><option value="q3"' + (fuelPeriod === 'q3' ? ' selected' : '') + '>Q3 (Jul-Sep)</option><option value="q4"' + (fuelPeriod === 'q4' ? ' selected' : '') + '>Q4 (Oct-Dec)</option><option value="year"' + (fuelPeriod === 'year' ? ' selected' : '') + '>Full Year</option></select></div>' +
        (fuelPeriod === 'month' ? '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Month</label><select id="fuelMonth" onchange="fuelMonth=parseInt(this.value);renderFuelTracking(document.getElementById(\'main-content\'))">' + months.slice(1).map((m, i) => '<option value="' + (i+1) + '"' + (fuelMonth === i+1 ? ' selected' : '') + '>' + m + '</option>').join('') + '</select></div>' : '') +
        '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Year</label><select id="fuelYear" onchange="fuelYear=parseInt(this.value);renderFuelTracking(document.getElementById(\'main-content\'))"><option value="2024"' + (fuelYear === 2024 ? ' selected' : '') + '>2024</option><option value="2025"' + (fuelYear === 2025 ? ' selected' : '') + '>2025</option><option value="2026"' + (fuelYear === 2026 ? ' selected' : '') + '>2026</option><option value="2027"' + (fuelYear === 2027 ? ' selected' : '') + '>2027</option></select></div>' +
        '<div style="margin-left:auto;font-size:18px;font-weight:700;color:#1e40af">ðŸ“… ' + getFuelPeriodLabel() + '</div></div>' +
        
        // Filter row
        '<div style="display:flex;gap:12px;align-items:end;flex-wrap:wrap;padding-top:16px;border-top:1px solid var(--border)">' +
        '<div style="font-weight:600;color:var(--text-secondary);display:flex;align-items:center;gap:6px"><span>ðŸ”</span> Filters:</div>' +
        '<div class="form-group" style="margin:0;min-width:120px"><label style="margin-bottom:4px;font-size:12px">Truck</label><select onchange="fuelFilterTruck=this.value;selectedFuelTruck=null;renderFuelTracking(document.getElementById(\'main-content\'))" style="padding:6px 10px"><option value="">All Trucks</option>' + 
        uniqueTrucks.map(tn => '<option value="' + tn + '"' + (fuelFilterTruck == tn ? ' selected' : '') + '>#' + tn + '</option>').join('') + '</select></div>' +
        '<div class="form-group" style="margin:0;min-width:100px"><label style="margin-bottom:4px;font-size:12px">State</label><select onchange="fuelFilterState=this.value;renderFuelTracking(document.getElementById(\'main-content\'))" style="padding:6px 10px"><option value="">All States</option>' + 
        uniqueStates.map(st => '<option value="' + st + '"' + (fuelFilterState === st ? ' selected' : '') + '>' + st + '</option>').join('') + '</select></div>' +
        '<div class="form-group" style="margin:0;min-width:100px"><label style="margin-bottom:4px;font-size:12px">Product</label><select onchange="fuelFilterProduct=this.value;renderFuelTracking(document.getElementById(\'main-content\'))" style="padding:6px 10px"><option value="">All Products</option>' + 
        uniqueProducts.map(p => '<option value="' + p + '"' + (fuelFilterProduct === p ? ' selected' : '') + '>' + p + '</option>').join('') + '</select></div>' +
        '<div class="form-group" style="margin:0;min-width:140px"><label style="margin-bottom:4px;font-size:12px">Driver</label><select onchange="fuelFilterDriver=this.value;renderFuelTracking(document.getElementById(\'main-content\'))" style="padding:6px 10px"><option value="">All Drivers</option>' + 
        uniqueDrivers.map(d => '<option value="' + d + '"' + (fuelFilterDriver === d ? ' selected' : '') + '>' + d + '</option>').join('') + '</select></div>' +
        (hasActiveFilters ? '<button class="btn btn-secondary" style="padding:6px 12px;font-size:13px" onclick="clearFuelFilters()">âœ• Clear Filters</button>' : '') +
        '<div style="margin-left:auto;font-size:13px;color:var(--text-muted)">' + filteredTxns.length + ' of ' + periodTxns.length + ' transactions</div>' +
        '</div></div>' +
        
        // Analytics Tabs
        '<div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap">' +
        '<button class="btn ' + (fuelAnalyticsTab === 'overview' ? 'btn-primary' : 'btn-secondary') + '" onclick="fuelAnalyticsTab=\'overview\';renderFuelTracking(document.getElementById(\'main-content\'))">ðŸ“Š Overview</button>' +
        '<button class="btn ' + (fuelAnalyticsTab === 'analytics' ? 'btn-primary' : 'btn-secondary') + '" onclick="fuelAnalyticsTab=\'analytics\';renderFuelTracking(document.getElementById(\'main-content\'))">ðŸ“ˆ Analytics</button>' +
        '<button class="btn ' + (fuelAnalyticsTab === 'efficiency' ? 'btn-primary' : 'btn-secondary') + '" onclick="fuelAnalyticsTab=\'efficiency\';renderFuelTracking(document.getElementById(\'main-content\'))">âš¡ Efficiency</button>' +
        '<button class="btn ' + (fuelAnalyticsTab === 'prices' ? 'btn-primary' : 'btn-secondary') + '" onclick="fuelAnalyticsTab=\'prices\';renderFuelTracking(document.getElementById(\'main-content\'))">ðŸ’° Price Analysis</button>' +
        '</div>' +
        
        // Tab Content
        (fuelAnalyticsTab === 'overview' ? (
        // PRIMARY STATS CARDS - OVERVIEW TAB
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="padding:16px;border-left:4px solid #f59e0b"><div class="label">Total Diesel</div><div class="value" style="font-size:20px">' + totalDieselGal.toFixed(1) + ' gal</div></div>' +
        '<div class="stat-card" style="padding:16px;border-left:4px solid #dc2626"><div class="label">Diesel Cost</div><div class="value" style="font-size:20px;color:#dc2626">' + formatMoney(totalDieselCost) + '</div></div>' +
        '<div class="stat-card" style="padding:16px;border-left:4px solid #6366f1"><div class="label">Avg $/Gallon</div><div class="value" style="font-size:20px">' + formatMoney(avgPricePerGal) + '</div></div>' +
        '<div class="stat-card" style="padding:16px;border-left:4px solid #10b981;background:#d1fae5"><div class="label">Total Savings</div><div class="value" style="font-size:20px;color:#059669">' + formatMoney(totalSavings) + '</div></div>' +
        '<div class="stat-card" style="padding:16px;border-left:4px solid #0ea5e9"><div class="label">Total DEF</div><div class="value" style="font-size:20px">' + totalDefGal.toFixed(1) + ' gal</div></div>' +
        '<div class="stat-card" style="padding:16px;border-left:4px solid #64748b;background:#fee2e2"><div class="label">Total Cost</div><div class="value" style="font-size:20px;color:#dc2626">' + formatMoney(totalCost) + '</div></div>' +
        '</div>' +
        
        // Efficiency metrics
        '<div class="card" style="margin-bottom:24px;padding:20px">' +
        '<h3 style="margin-bottom:16px;color:#8b5cf6;border-bottom:2px solid #8b5cf6;padding-bottom:8px">ðŸ“Š EFFICIENCY METRICS</h3>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px">' +
        '<div style="background:#f8fafc;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#64748b">Miles Traveled</div><div style="font-size:24px;font-weight:700">' + periodMiles.toLocaleString() + '</div></div>' +
        '<div style="background:' + (mpg >= 6 ? '#d1fae5' : mpg >= 5 ? '#fef3c7' : '#fee2e2') + ';padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#64748b">Fuel Economy (MPG)</div><div style="font-size:24px;font-weight:700;color:' + (mpg >= 6 ? '#059669' : mpg >= 5 ? '#d97706' : '#dc2626') + '">' + mpg.toFixed(2) + '</div></div>' +
        '<div style="background:#f8fafc;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#64748b">Cost Per Mile</div><div style="font-size:24px;font-weight:700;color:#dc2626">' + formatMoney(costPerMile) + '</div></div>' +
        '<div style="background:#f8fafc;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#64748b">Fill-Ups</div><div style="font-size:24px;font-weight:700">' + fillUps + '</div></div>' +
        '<div style="background:#f8fafc;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#64748b">Avg Gal/Fill-Up</div><div style="font-size:24px;font-weight:700">' + avgGallonsPerFillUp.toFixed(1) + '</div></div>' +
        '<div style="background:#dbeafe;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#1d4ed8">Avg Discount/Gal</div><div style="font-size:24px;font-weight:700;color:#1d4ed8">' + avgDiscountPerGal.toFixed(1) + 'Â¢</div></div>' +
        '</div></div>' +
        
        // Two column layout for insights
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px;margin-bottom:24px">' +
        
        // By Truck summary (clickable) - only show if not viewing specific truck
        (selectedFuelTruck ? '' : 
        '<div class="card"><div class="card-header"><h3>ðŸšš By Truck (click for details)</h3></div><div class="table-wrapper"><table><thead><tr><th>Truck</th><th>Diesel</th><th>MPG</th><th>$/Mile</th><th>Cost</th></tr></thead><tbody>' +
        (Object.keys(truckStats).length === 0 ? '<tr><td colspan="5" style="text-align:center;padding:20px">No fuel data</td></tr>' :
        Object.keys(truckStats).sort((a, b) => truckStats[b].cost - truckStats[a].cost).map(tn => 
          '<tr style="cursor:pointer" onclick="selectedFuelTruck=\'' + tn + '\';renderFuelTracking(document.getElementById(\'main-content\'))">' +
          '<td><strong style="color:#3b82f6">#' + tn + '</strong></td>' +
          '<td>' + truckStats[tn].diesel.toFixed(0) + ' gal</td>' +
          '<td style="color:' + (truckStats[tn].mpg >= 6 ? '#059669' : truckStats[tn].mpg >= 5 ? '#d97706' : '#dc2626') + ';font-weight:600">' + truckStats[tn].mpg.toFixed(2) + '</td>' +
          '<td class="money">' + formatMoney(truckStats[tn].costPerMile) + '</td>' +
          '<td class="money">' + formatMoney(truckStats[tn].cost) + '</td>' +
          '</tr>'
        ).join('')) +
        '</tbody></table></div></div>') +
        
        // By State
        '<div class="card"><div class="card-header"><h3>ðŸ—ºï¸ By State</h3></div><div class="table-wrapper"><table><thead><tr><th>State</th><th>Gallons</th><th>Avg $/Gal</th><th>Cost</th></tr></thead><tbody>' +
        (Object.keys(stateStats).length === 0 ? '<tr><td colspan="4" style="text-align:center;padding:20px">No data</td></tr>' :
        Object.keys(stateStats).sort((a, b) => stateStats[b].gallons - stateStats[a].gallons).map(st => 
          '<tr><td><strong>' + st + '</strong></td>' +
          '<td>' + stateStats[st].gallons.toFixed(1) + '</td>' +
          '<td class="money">' + formatMoney(stateStats[st].cost / stateStats[st].gallons) + '</td>' +
          '<td class="money">' + formatMoney(stateStats[st].cost) + '</td></tr>'
        ).join('')) +
        '</tbody></table></div></div>' +
        
        // Top Locations
        '<div class="card"><div class="card-header"><h3>ðŸ“ Top Fuel Stops</h3></div><div class="table-wrapper"><table><thead><tr><th>Location</th><th>Visits</th><th>Gallons</th><th>Cost</th></tr></thead><tbody>' +
        (topLocations.length === 0 ? '<tr><td colspan="4" style="text-align:center;padding:20px">No data</td></tr>' :
        topLocations.map(([loc, data]) => 
          '<tr><td><strong>' + loc + '</strong><br><span style="font-size:11px;color:#64748b">' + data.city + ', ' + data.state + '</span></td>' +
          '<td>' + data.visits + '</td>' +
          '<td>' + data.gallons.toFixed(1) + '</td>' +
          '<td class="money">' + formatMoney(data.cost) + '</td></tr>'
        ).join('')) +
        '</tbody></table></div></div>' +
        
        '</div>' +
        
        // Monthly Trend (for quarterly/yearly views)
        (Object.keys(monthlyTrend).length > 1 ? 
        '<div class="card" style="margin-bottom:24px"><div class="card-header"><h3>ðŸ“ˆ Monthly Trend</h3></div><div class="table-wrapper"><table><thead><tr><th>Month</th><th>Fill-Ups</th><th>Gallons</th><th>Cost</th><th>Avg $/Gal</th></tr></thead><tbody>' +
        Object.keys(monthlyTrend).sort().map(month => {
          const data = monthlyTrend[month];
          const avgPrice = data.gallons > 0 ? data.cost / data.gallons : 0;
          return '<tr><td><strong>' + month + '</strong></td>' +
            '<td>' + data.fillUps + '</td>' +
            '<td>' + data.gallons.toFixed(1) + '</td>' +
            '<td class="money">' + formatMoney(data.cost) + '</td>' +
            '<td class="money">' + formatMoney(avgPrice) + '</td></tr>';
        }).join('') +
        '</tbody></table></div></div>' : '') +
        
        // Transactions table
        '<div class="card"><div class="card-header"><h3>ðŸ“‹ Transactions (' + filteredTxns.filter(t => t.product !== 'Txn Fee').length + ')</h3></div><div class="table-wrapper"><table><thead><tr><th>Date</th><th>Truck</th><th>Driver</th><th>Location</th><th>Product</th><th>Gallons</th><th>Amount</th><th>Savings</th></tr></thead><tbody>' +
        (filteredTxns.filter(t => t.product !== 'Txn Fee').length === 0 ? '<tr><td colspan="8" style="text-align:center;padding:40px">No transactions. Upload a fuel report to get started!</td></tr>' :
        filteredTxns.filter(t => t.product !== 'Txn Fee').map(t => '<tr><td>' + formatDate(t.transaction_date) + '</td><td><strong>#' + t.truck_number + '</strong></td><td>' + (t.driver_name || '-') + '</td><td>' + t.city + ', ' + t.state + '<br><span style="font-size:11px;color:#64748b">' + t.location + '</span></td><td><span class="badge ' + (t.product === 'ULSD' ? 'badge-amber' : 'badge-blue') + '">' + t.product + '</span></td><td>' + parseFloat(t.gallons || 0).toFixed(2) + '</td><td class="money">' + formatMoney(t.amount) + '</td><td class="money positive">' + formatMoney(t.savings || 0) + '</td></tr>').join('')) +
        '</tbody></table></div></div>'
        ) : '') + // End overview tab
        
        // ANALYTICS TAB
        (fuelAnalyticsTab === 'analytics' ? renderFuelAnalyticsTab(filteredTxns, periodTxns, truckStats, stateStats, range) : '') +
        
        // EFFICIENCY TAB
        (fuelAnalyticsTab === 'efficiency' ? renderFuelEfficiencyTab(filteredTxns, truckStats, periodMiles, totalDieselGal, mpg) : '') +
        
        // PRICES TAB
        (fuelAnalyticsTab === 'prices' ? renderFuelPricesTab(filteredTxns, stateStats, avgPricePerGal) : '');
    }
    
    // Fuel Analytics Tab
    function renderFuelAnalyticsTab(txns, allTxns, truckStats, stateStats, range) {
      // Calculate trends
      const weeklyData = {};
      txns.filter(t => t.product === 'ULSD').forEach(t => {
        const d = new Date(t.transaction_date);
        const weekStart = new Date(d);
        weekStart.setDate(d.getDate() - d.getDay());
        const key = weekStart.toISOString().split('T')[0];
        if (!weeklyData[key]) weeklyData[key] = { gallons: 0, cost: 0, count: 0 };
        weeklyData[key].gallons += parseFloat(t.gallons || 0);
        weeklyData[key].cost += parseFloat(t.amount || 0);
        weeklyData[key].count++;
      });
      
      const weeks = Object.keys(weeklyData).sort();
      const avgWeeklyGallons = weeks.length > 0 ? weeks.reduce((s, w) => s + weeklyData[w].gallons, 0) / weeks.length : 0;
      const avgWeeklyCost = weeks.length > 0 ? weeks.reduce((s, w) => s + weeklyData[w].cost, 0) / weeks.length : 0;
      
      // Predict next month
      const projectedMonthlyGallons = avgWeeklyGallons * 4.33;
      const projectedMonthlyCost = avgWeeklyCost * 4.33;
      
      // Day of week analysis
      const dayStats = {0:'Sun',1:'Mon',2:'Tue',3:'Wed',4:'Thu',5:'Fri',6:'Sat'};
      const byDay = {};
      txns.filter(t => t.product === 'ULSD').forEach(t => {
        const day = new Date(t.transaction_date).getDay();
        if (!byDay[day]) byDay[day] = { count: 0, gallons: 0, cost: 0 };
        byDay[day].count++;
        byDay[day].gallons += parseFloat(t.gallons || 0);
        byDay[day].cost += parseFloat(t.amount || 0);
      });
      
      // Find anomalies (trucks with significantly different MPG)
      const truckMPGs = Object.values(truckStats).filter(t => t.mpg > 0).map(t => t.mpg);
      const avgMPG = truckMPGs.length > 0 ? truckMPGs.reduce((s, m) => s + m, 0) / truckMPGs.length : 0;
      const anomalies = Object.entries(truckStats).filter(([tn, data]) => data.mpg > 0 && Math.abs(data.mpg - avgMPG) > avgMPG * 0.2);
      
      return '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px">' +
        
        // Forecast Card
        '<div class="card"><div class="card-header"><h3>ðŸ”® Fuel Forecast</h3></div><div style="padding:20px">' +
        '<div style="background:linear-gradient(135deg,#1e3a5f,#164e63);padding:20px;border-radius:12px;color:white;margin-bottom:16px">' +
        '<div style="font-size:13px;opacity:0.8;margin-bottom:4px">Projected Next Month</div>' +
        '<div style="font-size:28px;font-weight:700">' + formatMoney(projectedMonthlyCost) + '</div>' +
        '<div style="font-size:13px;opacity:0.8;margin-top:8px">' + projectedMonthlyGallons.toFixed(0) + ' gallons estimated</div>' +
        '</div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">' +
        '<div style="background:var(--bg-darker);padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:var(--text-muted)">Avg Weekly Cost</div><div style="font-size:18px;font-weight:700">' + formatMoney(avgWeeklyCost) + '</div></div>' +
        '<div style="background:var(--bg-darker);padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:var(--text-muted)">Avg Weekly Gallons</div><div style="font-size:18px;font-weight:700">' + avgWeeklyGallons.toFixed(0) + '</div></div>' +
        '</div></div></div>' +
        
        // Weekly Trend
        '<div class="card"><div class="card-header"><h3>ðŸ“ˆ Weekly Trend</h3></div><div style="padding:20px">' +
        '<div style="display:flex;gap:4px;align-items:flex-end;height:120px;margin-bottom:12px">' +
        weeks.slice(-8).map(function(w) {
          const maxCost = Math.max.apply(null, weeks.map(function(wk) { return weeklyData[wk].cost; }));
          const height = maxCost > 0 ? (weeklyData[w].cost / maxCost) * 100 : 0;
          return '<div style="flex:1;display:flex;flex-direction:column;align-items:center"><div style="background:#3b82f6;width:100%;height:' + height + 'px;border-radius:4px 4px 0 0;min-height:4px"></div><div style="font-size:9px;color:var(--text-muted);margin-top:4px;transform:rotate(-45deg)">' + w.slice(5) + '</div></div>';
        }).join('') +
        '</div></div></div>' +
        
        // Day of Week Analysis
        '<div class="card"><div class="card-header"><h3>ðŸ“… Fill-Up Patterns</h3></div><div style="padding:20px">' +
        '<div style="display:flex;gap:8px">' +
        [0,1,2,3,4,5,6].map(function(d) {
          const data = byDay[d] || { count: 0 };
          const maxCount = Math.max.apply(null, Object.values(byDay).map(function(x) { return x.count || 0; }));
          const height = maxCount > 0 ? (data.count / maxCount) * 60 : 0;
          return '<div style="flex:1;text-align:center"><div style="height:60px;display:flex;align-items:flex-end;justify-content:center"><div style="background:' + (d === 0 || d === 6 ? '#f59e0b' : '#22c55e') + ';width:80%;height:' + height + 'px;border-radius:4px 4px 0 0;min-height:4px"></div></div><div style="font-size:11px;color:var(--text-muted);margin-top:4px">' + dayStats[d] + '</div><div style="font-size:12px;font-weight:600">' + data.count + '</div></div>';
        }).join('') +
        '</div>' +
        '<div style="margin-top:16px;font-size:13px;color:var(--text-muted)">ðŸ’¡ ' + ((byDay[0]?.count || 0) > (byDay[1]?.count || 0) ? 'Consider weekday fill-ups for potential savings' : 'Good job avoiding weekend fill-ups!') + '</div>' +
        '</div></div>' +
        
        // Anomaly Detection
        '<div class="card"><div class="card-header"><h3>ðŸš¨ Anomaly Detection</h3></div><div style="padding:20px">' +
        (anomalies.length === 0 ? '<div style="background:#dcfce7;padding:20px;border-radius:8px;text-align:center"><div style="font-size:24px">âœ…</div><div style="color:#166534;font-weight:600;margin-top:8px">All trucks performing normally</div><div style="font-size:13px;color:#15803d">Average MPG: ' + avgMPG.toFixed(2) + '</div></div>' :
        anomalies.map(function(item) {
          const tn = item[0], data = item[1];
          const diff = ((data.mpg - avgMPG) / avgMPG * 100);
          const isLow = diff < 0;
          return '<div style="display:flex;gap:12px;padding:12px;background:' + (isLow ? '#fee2e2' : '#dcfce7') + ';border-radius:8px;margin-bottom:8px">' +
            '<span style="font-size:20px">' + (isLow ? 'âš ï¸' : 'ðŸŒŸ') + '</span>' +
            '<div><div style="font-weight:600;color:' + (isLow ? '#991b1b' : '#166534') + '">Truck #' + tn + '</div>' +
            '<div style="font-size:12px;color:' + (isLow ? '#b91c1c' : '#15803d') + '">MPG: ' + data.mpg.toFixed(2) + ' (' + (diff > 0 ? '+' : '') + diff.toFixed(0) + '% vs avg)</div>' +
            (isLow ? '<div style="font-size:11px;color:#dc2626;margin-top:4px">Check tire pressure, air filter, or driving habits</div>' : '') +
            '</div></div>';
        }).join('')) +
        '</div></div>' +
        
        '</div>';
    }
    
    // Fuel Efficiency Tab
    function renderFuelEfficiencyTab(txns, truckStats, totalMiles, totalGallons, avgMPG) {
      // Rank trucks by efficiency
      const rankedTrucks = Object.entries(truckStats)
        .filter(function(item) { return item[1].mpg > 0; })
        .sort(function(a, b) { return b[1].mpg - a[1].mpg; });
      
      // Calculate potential savings
      const bestMPG = rankedTrucks.length > 0 ? rankedTrucks[0][1].mpg : 0;
      const potentialSavings = rankedTrucks.reduce(function(total, item) {
        const data = item[1];
        if (data.mpg < bestMPG && data.miles > 0) {
          const gallonsAtBestMPG = data.miles / bestMPG;
          const savedGallons = data.diesel - gallonsAtBestMPG;
          const savedCost = savedGallons * (data.cost / data.diesel);
          return total + Math.max(0, savedCost);
        }
        return total;
      }, 0);
      
      // Driver efficiency
      const driverStats = {};
      txns.filter(function(t) { return t.product === 'ULSD' && t.driver_name; }).forEach(function(t) {
        if (!driverStats[t.driver_name]) driverStats[t.driver_name] = { gallons: 0, cost: 0, fillups: 0 };
        driverStats[t.driver_name].gallons += parseFloat(t.gallons || 0);
        driverStats[t.driver_name].cost += parseFloat(t.amount || 0);
        driverStats[t.driver_name].fillups++;
      });
      
      return '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px">' +
        
        // Efficiency Summary
        '<div class="card"><div class="card-header"><h3>âš¡ Efficiency Summary</h3></div><div style="padding:20px">' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">' +
        '<div style="background:' + (avgMPG >= 6 ? '#dcfce7' : avgMPG >= 5 ? '#fef3c7' : '#fee2e2') + ';padding:20px;border-radius:12px;text-align:center">' +
        '<div style="font-size:12px;color:#64748b">Fleet Average MPG</div>' +
        '<div style="font-size:36px;font-weight:700;color:' + (avgMPG >= 6 ? '#059669' : avgMPG >= 5 ? '#d97706' : '#dc2626') + '">' + avgMPG.toFixed(2) + '</div>' +
        '<div style="font-size:12px;color:#64748b;margin-top:4px">' + (avgMPG >= 6 ? 'ðŸŒŸ Excellent' : avgMPG >= 5 ? 'ðŸ‘ Good' : 'âš ï¸ Needs Work') + '</div>' +
        '</div>' +
        '<div style="background:#dbeafe;padding:20px;border-radius:12px;text-align:center">' +
        '<div style="font-size:12px;color:#1d4ed8">Potential Monthly Savings</div>' +
        '<div style="font-size:36px;font-weight:700;color:#1d4ed8">' + formatMoney(potentialSavings) + '</div>' +
        '<div style="font-size:12px;color:#64748b;margin-top:4px">If all trucks matched best performer</div>' +
        '</div>' +
        '</div>' +
        '<div style="font-size:13px;color:var(--text-muted)">ðŸ’¡ Tips: Maintain tire pressure (35-75 PSI), reduce idling, use cruise control on highways</div>' +
        '</div></div>' +
        
        // Truck Efficiency Ranking
        '<div class="card"><div class="card-header"><h3>ðŸ† Truck Efficiency Ranking</h3></div><div style="padding:20px">' +
        (rankedTrucks.length === 0 ? '<div style="text-align:center;padding:20px;color:var(--text-muted)">No efficiency data available</div>' :
        rankedTrucks.map(function(item, i) {
          const tn = item[0], data = item[1];
          const medal = i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : '';
          const barWidth = bestMPG > 0 ? (data.mpg / bestMPG) * 100 : 0;
          return '<div style="margin-bottom:16px">' +
            '<div style="display:flex;justify-content:space-between;margin-bottom:4px">' +
            '<span style="font-weight:600">' + medal + ' Truck #' + tn + '</span>' +
            '<span style="font-weight:700;color:' + (data.mpg >= 6 ? '#059669' : data.mpg >= 5 ? '#d97706' : '#dc2626') + '">' + data.mpg.toFixed(2) + ' MPG</span>' +
            '</div>' +
            '<div style="background:var(--bg-card);height:24px;border-radius:4px;overflow:hidden">' +
            '<div style="background:' + (data.mpg >= 6 ? '#22c55e' : data.mpg >= 5 ? '#f59e0b' : '#ef4444') + ';height:100%;width:' + barWidth + '%;display:flex;align-items:center;justify-content:flex-end;padding-right:8px">' +
            '<span style="font-size:11px;color:white;font-weight:600">' + data.miles.toLocaleString() + ' mi</span>' +
            '</div></div></div>';
        }).join('')) +
        '</div></div>' +
        
        // Driver Analysis
        '<div class="card"><div class="card-header"><h3>ðŸ‘¨â€âœˆï¸ Driver Fuel Usage</h3></div><div style="padding:20px">' +
        (Object.keys(driverStats).length === 0 ? '<div style="text-align:center;padding:20px;color:var(--text-muted)">No driver data available</div>' :
        '<table style="width:100%;font-size:13px"><thead><tr style="border-bottom:2px solid var(--border)"><th style="text-align:left;padding:8px">Driver</th><th style="text-align:right;padding:8px">Fill-ups</th><th style="text-align:right;padding:8px">Gallons</th><th style="text-align:right;padding:8px">Cost</th></tr></thead><tbody>' +
        Object.entries(driverStats).sort(function(a, b) { return b[1].cost - a[1].cost; }).slice(0, 8).map(function(item) {
          const name = item[0], data = item[1];
          return '<tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">' + name + '</td><td style="text-align:right;padding:8px">' + data.fillups + '</td><td style="text-align:right;padding:8px">' + data.gallons.toFixed(0) + '</td><td style="text-align:right;padding:8px;color:#dc2626">' + formatMoney(data.cost) + '</td></tr>';
        }).join('') +
        '</tbody></table>') +
        '</div></div>' +
        
        '</div>';
    }
    
    // Fuel Prices Tab
    function renderFuelPricesTab(txns, stateStats, avgPrice) {
      // Price by state with comparison
      const statePrices = Object.entries(stateStats)
        .map(function(item) {
          const state = item[0], data = item[1];
          return { state: state, avgPrice: data.gallons > 0 ? data.cost / data.gallons : 0, gallons: data.gallons, cost: data.cost };
        })
        .filter(function(s) { return s.avgPrice > 0; })
        .sort(function(a, b) { return a.avgPrice - b.avgPrice; });
      
      const cheapestState = statePrices[0];
      const expensiveState = statePrices[statePrices.length - 1];
      
      // Recent price trend
      const recentTxns = txns.filter(function(t) { return t.product === 'ULSD'; }).sort(function(a, b) { return new Date(b.transaction_date) - new Date(a.transaction_date); }).slice(0, 20);
      const recentAvgPrice = recentTxns.reduce(function(s, t) { return s + (parseFloat(t.amount || 0) / parseFloat(t.gallons || 1)); }, 0) / Math.max(recentTxns.length, 1);
      const priceTrend = recentAvgPrice - avgPrice;
      
      // Price alerts
      const priceAlerts = [];
      if (cheapestState && expensiveState && cheapestState.state !== expensiveState.state) {
        const savings = (expensiveState.avgPrice - cheapestState.avgPrice) * 100;
        if (savings > 10) {
          priceAlerts.push({ type: 'tip', msg: 'Save ' + savings.toFixed(0) + 'Â¢/gal by filling in ' + cheapestState.state + ' instead of ' + expensiveState.state });
        }
      }
      if (Math.abs(priceTrend) > 0.10) {
        priceAlerts.push({ type: priceTrend > 0 ? 'warning' : 'good', msg: 'Prices ' + (priceTrend > 0 ? 'up' : 'down') + ' ' + Math.abs(priceTrend * 100).toFixed(0) + 'Â¢/gal recently' });
      }
      
      return '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px">' +
        
        // Price Alerts
        (priceAlerts.length > 0 ? '<div class="card" style="grid-column:1/-1"><div style="padding:16px">' +
        priceAlerts.map(function(a) { return '<div style="display:flex;gap:12px;padding:12px;background:' + (a.type === 'warning' ? '#fee2e2' : a.type === 'good' ? '#dcfce7' : '#dbeafe') + ';border-radius:8px;margin-bottom:8px">' +
          '<span style="font-size:20px">' + (a.type === 'warning' ? 'âš ï¸' : a.type === 'good' ? 'âœ…' : 'ðŸ’¡') + '</span>' +
          '<div style="font-weight:600;color:' + (a.type === 'warning' ? '#991b1b' : a.type === 'good' ? '#166534' : '#1d4ed8') + '">' + a.msg + '</div></div>'; }).join('') +
        '</div></div>' : '') +
        
        // Price Summary
        '<div class="card"><div class="card-header"><h3>ðŸ’° Price Summary</h3></div><div style="padding:20px">' +
        '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:20px">' +
        '<div style="background:var(--bg-darker);padding:16px;border-radius:8px;text-align:center">' +
        '<div style="font-size:11px;color:var(--text-muted)">Average Price</div>' +
        '<div style="font-size:24px;font-weight:700">' + formatMoney(avgPrice) + '</div>' +
        '<div style="font-size:11px;color:var(--text-muted)">per gallon</div></div>' +
        (cheapestState ? '<div style="background:#dcfce7;padding:16px;border-radius:8px;text-align:center">' +
        '<div style="font-size:11px;color:#166534">Cheapest State</div>' +
        '<div style="font-size:24px;font-weight:700;color:#059669">' + cheapestState.state + '</div>' +
        '<div style="font-size:13px;color:#166534">' + formatMoney(cheapestState.avgPrice) + '/gal</div></div>' : '') +
        (expensiveState ? '<div style="background:#fee2e2;padding:16px;border-radius:8px;text-align:center">' +
        '<div style="font-size:11px;color:#991b1b">Most Expensive</div>' +
        '<div style="font-size:24px;font-weight:700;color:#dc2626">' + expensiveState.state + '</div>' +
        '<div style="font-size:13px;color:#991b1b">' + formatMoney(expensiveState.avgPrice) + '/gal</div></div>' : '') +
        '</div>' +
        '<div style="font-size:13px;color:var(--text-muted)">Recent trend: <strong style="color:' + (priceTrend > 0 ? '#dc2626' : '#059669') + '">' + (priceTrend > 0 ? 'â†‘' : 'â†“') + ' ' + formatMoney(Math.abs(priceTrend)) + '/gal</strong></div>' +
        '</div></div>' +
        
        // Price by State
        '<div class="card"><div class="card-header"><h3>ðŸ—ºï¸ Price by State</h3></div><div style="padding:20px">' +
        (statePrices.length === 0 ? '<div style="text-align:center;padding:20px;color:var(--text-muted)">No state data</div>' :
        statePrices.map(function(s, i) {
          const isLowest = i === 0;
          const isHighest = i === statePrices.length - 1 && statePrices.length > 1;
          return '<div style="display:flex;align-items:center;gap:12px;padding:12px;background:' + (isLowest ? '#dcfce7' : isHighest ? '#fee2e2' : 'var(--bg-darker)') + ';border-radius:8px;margin-bottom:8px">' +
            '<div style="font-size:20px;font-weight:700;width:50px">' + s.state + '</div>' +
            '<div style="flex:1"><div style="background:var(--bg-card);height:20px;border-radius:4px;overflow:hidden">' +
            '<div style="background:' + (isLowest ? '#22c55e' : isHighest ? '#ef4444' : '#3b82f6') + ';height:100%;width:' + (s.avgPrice / (expensiveState ? expensiveState.avgPrice : s.avgPrice) * 100) + '%"></div></div></div>' +
            '<div style="text-align:right;min-width:80px">' +
            '<div style="font-weight:700;color:' + (isLowest ? '#059669' : isHighest ? '#dc2626' : 'inherit') + '">' + formatMoney(s.avgPrice) + '</div>' +
            '<div style="font-size:11px;color:var(--text-muted)">' + s.gallons.toFixed(0) + ' gal</div></div></div>';
        }).join('')) +
        '</div></div>' +
        
        // Recent Transactions with Price
        '<div class="card"><div class="card-header"><h3>ðŸ“‹ Recent Fill-ups</h3></div><div style="padding:20px;max-height:400px;overflow-y:auto">' +
        recentTxns.slice(0, 10).map(function(t) {
          const pricePerGal = parseFloat(t.gallons) > 0 ? parseFloat(t.amount) / parseFloat(t.gallons) : 0;
          const diff = pricePerGal - avgPrice;
          return '<div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border)">' +
            '<div><div style="font-weight:600">' + t.city + ', ' + t.state + '</div><div style="font-size:11px;color:var(--text-muted)">' + formatDate(t.transaction_date) + ' â€¢ Truck #' + t.truck_number + '</div></div>' +
            '<div style="text-align:right"><div style="font-weight:700">' + formatMoney(pricePerGal) + '/gal</div>' +
            '<div style="font-size:11px;color:' + (diff <= 0 ? '#059669' : '#dc2626') + '">' + (diff <= 0 ? 'â†“' : 'â†‘') + formatMoney(Math.abs(diff)) + ' vs avg</div></div></div>';
        }).join('') +
        '</div></div>' +
        
        '</div>';
    }

    async function deletePeriodFuelData() {
      const range = getFuelDateRange();
      const periodLabel = getFuelPeriodLabel();
      
      // Get transactions for this period
      const toDelete = (appData.fuel_transactions || []).filter(t => {
        if (!t.transaction_date) return false;
        const d = t.transaction_date;
        return d >= range.start && d <= range.end;
      });
      
      if (toDelete.length === 0) {
        showToast('No data to delete for this period', 'error');
        return;
      }
      
      if (!confirm('Delete all ' + toDelete.length + ' fuel transactions for ' + periodLabel + '?\n\nThis cannot be undone!')) {
        return;
      }
      
      showToast('Deleting ' + toDelete.length + ' transactions...');
      
      let deleted = 0;
      for (const txn of toDelete) {
        try {
          await dbDelete('fuel_transactions', txn.id);
          deleted++;
        } catch (e) {
          console.error('Failed to delete', txn.id, e);
        }
      }
      
      showToast('Deleted ' + deleted + ' transactions');
      await loadAllData();
      renderFuelTracking(document.getElementById('main-content'));
    }

    function openFuelUploadModal() {
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3>ðŸ“¤ Upload Fuel Report</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body">' +
        '<div style="background:#dbeafe;padding:16px;border-radius:8px;margin-bottom:16px"><strong style="color:#1d4ed8">Supported Formats:</strong><p style="color:#1e40af;margin-top:8px;font-size:14px">â€¢ <strong>CSV</strong> (Recommended) - More reliable<br>â€¢ <strong>PDF</strong> - Love\'s / TA Transaction Reports</p></div>' +
        '<div class="form-group"><label>Select File (CSV or PDF)</label><input type="file" id="fuelFile" accept=".csv,.pdf"></div>' +
        '<div id="fuelParsePreview" style="display:none;margin-top:16px;max-height:300px;overflow-y:auto"></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="parseFuelFile()">ðŸ” Parse File</button><button class="btn btn-primary" id="saveFuelBtn" style="display:none;background:#10b981" onclick="saveFuelTransactions()">ðŸ’¾ Save Transactions</button></div></div>';
      document.body.appendChild(m);
    }

    let parsedFuelData = [];

    async function parseFuelFile() {
      const fileInput = document.getElementById('fuelFile');
      if (!fileInput.files || fileInput.files.length === 0) {
        showToast('Please select a file', 'error');
        return;
      }
      
      const file = fileInput.files[0];
      const fileName = file.name.toLowerCase();
      
      if (fileName.endsWith('.csv')) {
        parseFuelCsv(file);
      } else if (fileName.endsWith('.pdf')) {
        parseFuelPdf(file);
      } else {
        showToast('Please select a CSV or PDF file', 'error');
      }
    }

    function parseFuelCsv(file) {
      showToast('Parsing CSV... Please wait');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const lines = text.split('\n');
          
          // Valid US state codes
          const validStates = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY','DC'];
          
          // Find header row to determine column positions
          let headerIdx = -1;
          let headers = [];
          
          for (let i = 0; i < Math.min(10, lines.length); i++) {
            const line = lines[i].toLowerCase();
            if (line.includes('txn') || line.includes('transaction') || line.includes('unit') || line.includes('gallons')) {
              headerIdx = i;
              headers = parseCSVLine(lines[i]);
              break;
            }
          }
          
          if (headerIdx === -1) {
            // No header found, assume standard format
            headerIdx = 0;
            headers = ['txn', 'unit', 'card', 'cardholder', 'date', 'city', 'st', 'location', 'code', 'gallons', 'product', 'retail', 'disc', 'svgs'];
          }
          
          // Map header names to indices
          const colMap = {};
          headers.forEach((h, i) => {
            const lh = h.toLowerCase().trim();
            if (lh.includes('txn') || lh.includes('transaction')) colMap.txn = i;
            else if (lh.includes('unit')) colMap.unit = i;
            else if (lh.includes('card') && !lh.includes('holder')) colMap.card = i;
            else if (lh.includes('holder') || lh.includes('driver') || lh.includes('nic')) colMap.driver = i;
            else if (lh.includes('date')) colMap.date = i;
            else if (lh.includes('city')) colMap.city = i;
            else if (lh === 'st' || lh === 'st.' || lh.includes('state')) colMap.state = i;
            else if (lh.includes('location')) colMap.location = i;
            else if (lh.includes('code')) colMap.code = i;
            else if (lh.includes('gallon')) colMap.gallons = i;
            else if (lh.includes('product')) colMap.product = i;
            else if (lh.includes('retail')) colMap.retail = i;
            else if (lh.includes('disc')) colMap.disc = i;
            else if (lh.includes('svg') || lh.includes('saving')) colMap.savings = i;
          });
          
          console.log('Column mapping:', colMap);
          
          const transactions = [];
          
          for (let i = headerIdx + 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const cols = parseCSVLine(line);
            if (cols.length < 5) continue;
            
            // Get values
            const txnNum = cols[colMap.txn] || cols[0] || '';
            const unitNum = cols[colMap.unit] || cols[1] || '';
            const cardNum = cols[colMap.card] || cols[2] || '';
            const driverName = cols[colMap.driver] || cols[3] || '';
            let dateStr = cols[colMap.date] || cols[4] || '';
            const city = cols[colMap.city] || cols[5] || '';
            let state = (cols[colMap.state] || cols[6] || '').toUpperCase().trim();
            const location = cols[colMap.location] || cols[7] || '';
            const gallonsStr = cols[colMap.gallons] || cols[9] || '';
            const product = (cols[colMap.product] || cols[10] || '').toUpperCase().trim();
            const discStr = cols[colMap.disc] || cols[12] || '';
            const savingsStr = cols[colMap.savings] || cols[13] || '';
            
            // Validate
            if (!txnNum || !/^\d+$/.test(txnNum.trim())) continue;
            if (!unitNum || !/^\d+$/.test(unitNum.trim())) continue;
            if (!product || (product !== 'ULSD' && product !== 'DEF' && !product.includes('TXN') && !product.includes('FEE'))) continue;
            
            // Parse date (MM/DD/YYYY -> YYYY-MM-DD)
            let formattedDate = '';
            const dateMatch = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if (dateMatch) {
              formattedDate = dateMatch[3] + '-' + dateMatch[1].padStart(2, '0') + '-' + dateMatch[2].padStart(2, '0');
            } else {
              continue;
            }
            
            // Validate state
            if (!validStates.includes(state)) {
              // Try to find state in location or city
              for (const s of validStates) {
                if (location.toUpperCase().includes(' ' + s + ' ') || city.toUpperCase().includes(s)) {
                  state = s;
                  break;
                }
              }
            }
            
            // Parse amounts
            const parseNum = (s) => parseFloat((s || '').replace(/[$,]/g, '')) || 0;
            const gallons = parseNum(gallonsStr);
            const disc = parseNum(discStr);
            const savings = parseNum(savingsStr);
            
            // Determine product type
            let productType = product;
            if (product.includes('TXN') || product.includes('FEE')) {
              productType = 'Txn Fee';
            }
            
            transactions.push({
              txn_number: txnNum.trim(),
              truck_number: unitNum.trim(),
              card_number: cardNum.trim(),
              driver_name: driverName.trim(),
              transaction_date: formattedDate,
              city: city.trim(),
              state: state,
              location: location.trim(),
              product: productType,
              gallons: gallons,
              retail_amount: 0,
              amount: disc,
              savings: savings
            });
          }
          
          parsedFuelData = transactions;
          showFuelPreview();
          
        } catch (err) {
          showToast('Error parsing CSV: ' + err.message, 'error');
          console.error(err);
        }
      };
      reader.readAsText(file);
    }
    
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }
    
    function showFuelPreview() {
      const preview = document.getElementById('fuelParsePreview');
      if (parsedFuelData.length > 0) {
        // Calculate totals for preview
        const ulsd = parsedFuelData.filter(t => t.product === 'ULSD');
        const def = parsedFuelData.filter(t => t.product === 'DEF');
        const totalUlsdGal = ulsd.reduce((s, t) => s + t.gallons, 0);
        const totalDefGal = def.reduce((s, t) => s + t.gallons, 0);
        const totalCost = parsedFuelData.reduce((s, t) => s + t.amount, 0);
        
        preview.style.display = 'block';
        preview.innerHTML = '<div style="background:#d1fae5;padding:12px;border-radius:8px;margin-bottom:12px"><strong style="color:#059669">âœ“ Found ' + parsedFuelData.length + ' transactions</strong><br><span style="font-size:12px">ULSD: ' + totalUlsdGal.toFixed(2) + ' gal | DEF: ' + totalDefGal.toFixed(2) + ' gal | Total: $' + totalCost.toFixed(2) + '</span></div>' +
          '<table style="width:100%;font-size:12px"><thead><tr><th>Date</th><th>Truck</th><th>State</th><th>Product</th><th>Gallons</th><th>Amount</th></tr></thead><tbody>' +
          parsedFuelData.filter(t => t.product !== 'Txn Fee').slice(0, 10).map(t => '<tr><td>' + t.transaction_date + '</td><td>#' + t.truck_number + '</td><td><strong>' + t.state + '</strong></td><td>' + t.product + '</td><td>' + t.gallons.toFixed(2) + '</td><td>$' + t.amount.toFixed(2) + '</td></tr>').join('') +
          (parsedFuelData.filter(t => t.product !== 'Txn Fee').length > 10 ? '<tr><td colspan="6" style="text-align:center;color:#64748b">... and ' + (parsedFuelData.filter(t => t.product !== 'Txn Fee').length - 10) + ' more</td></tr>' : '') +
          '</tbody></table>';
        document.getElementById('saveFuelBtn').style.display = 'inline-block';
      } else {
        preview.style.display = 'block';
        preview.innerHTML = '<div style="background:#fee2e2;padding:12px;border-radius:8px"><strong style="color:#dc2626">No transactions found. Make sure this is a valid fuel report.</strong></div>';
      }
    }

    async function parseFuelPdf(file) {
      showToast('Parsing PDF... Please wait');
      
      // Load PDF.js from CDN
      if (!window.pdfjsLib) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
        document.head.appendChild(script);
        await new Promise(resolve => script.onload = resolve);
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      }
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const typedarray = new Uint8Array(e.target.result);
          const pdf = await pdfjsLib.getDocument(typedarray).promise;
          let fullText = '';
          
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            
            // Group text items by their Y position to reconstruct lines
            let lastY = null;
            let lineText = '';
            
            for (const item of textContent.items) {
              const y = Math.round(item.transform[5]); // Y position
              
              if (lastY !== null && Math.abs(y - lastY) > 5) {
                // New line detected
                fullText += lineText + '\n';
                lineText = item.str;
              } else {
                // Same line, add space if needed
                if (lineText && !lineText.endsWith(' ') && !item.str.startsWith(' ')) {
                  lineText += ' ';
                }
                lineText += item.str;
              }
              lastY = y;
            }
            // Add last line
            if (lineText) {
              fullText += lineText + '\n';
            }
          }
          
          console.log('Extracted text:', fullText.substring(0, 2000)); // Debug
          
          // Parse the text
          parsedFuelData = parseFuelText(fullText);
          showFuelPreview();
          
        } catch (err) {
          showToast('Error parsing PDF: ' + err.message, 'error');
          console.error(err);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function parseFuelText(text) {
      const transactions = [];
      
      // Valid US state codes
      const validStates = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY','DC'];
      const statePattern = validStates.join('|');
      
      // Try line-by-line parsing first (more reliable)
      const lines = text.split('\n');
      
      for (const line of lines) {
        // Check if line starts with 10-digit transaction number
        const txnMatch = line.match(/^(\d{10})\s+(\d+)\s+(\d+)\s+/);
        if (!txnMatch) continue;
        
        const txnNum = txnMatch[1];
        const unitNum = txnMatch[2];
        const cardNum = txnMatch[3];
        
        // Find date
        const dateMatch = line.match(/(\d{2}\/\d{2}\/\d{4})/);
        if (!dateMatch) continue;
        
        const dateStr = dateMatch[1];
        const [month, day, year] = dateStr.split('/');
        const formattedDate = year + '-' + month + '-' + day;
        
        // Extract driver name (between card# and date)
        const afterCard = line.substring(line.indexOf(cardNum) + cardNum.length);
        const beforeDate = afterCard.substring(0, afterCard.indexOf(dateStr));
        const driverName = beforeDate.trim();
        
        // Find state - look for 2-letter state code
        const afterDate = line.substring(line.indexOf(dateStr) + 10).trim();
        const words = afterDate.split(/\s+/);
        
        let state = '';
        let city = '';
        let stateIdx = -1;
        
        for (let i = 0; i < words.length && i < 15; i++) {
          const word = words[i].toUpperCase();
          if (word.length === 2 && validStates.includes(word)) {
            state = word;
            city = words.slice(0, i).join(' ');
            stateIdx = i;
            break;
          }
        }
        
        if (!state) continue;
        
        // Determine product and parse amounts
        let product = '';
        let gallons = 0;
        let amount = 0;
        let savings = 0;
        let location = '';
        
        // Get location (words after state until we hit numbers or product)
        const afterState = words.slice(stateIdx + 1);
        const locParts = [];
        for (const w of afterState) {
          if (/^[\d.]+$/.test(w) || w === 'ULSD' || w === 'DEF' || w === 'Txn' || w === '--') break;
          locParts.push(w);
        }
        location = locParts.join(' ');
        
        if (line.includes('ULSD')) {
          product = 'ULSD';
          // Match: gallons ULSD $retail $disc $savings
          const ulsdMatch = line.match(/([\d.]+)\s+ULSD\s+\$?([\d.]+)\s+\$?([\d.]+)\s+\$?([\d.]+)/);
          if (ulsdMatch) {
            gallons = parseFloat(ulsdMatch[1]) || 0;
            amount = parseFloat(ulsdMatch[3]) || 0; // Disc price
            savings = parseFloat(ulsdMatch[4]) || 0;
          }
        } else if (line.includes(' DEF ') && !line.includes('Txn Fee')) {
          product = 'DEF';
          // Match: gallons DEF $retail $disc $savings (savings might be $0.000)
          const defMatch = line.match(/([\d.]+)\s+DEF\s+\$?([\d.]+)\s+\$?([\d.]+)/);
          if (defMatch) {
            gallons = parseFloat(defMatch[1]) || 0;
            amount = parseFloat(defMatch[3]) || 0;
          }
        } else if (line.includes('Txn Fee')) {
          product = 'Txn Fee';
          const feeMatch = line.match(/Txn\s+Fee\s+\$?([\d.]+)/);
          if (feeMatch) {
            amount = parseFloat(feeMatch[1]) || 0;
          }
        } else {
          continue;
        }
        
        // Only add if we have valid data
        if (product && unitNum && /^\d+$/.test(unitNum)) {
          transactions.push({
            txn_number: txnNum,
            truck_number: unitNum,
            card_number: cardNum,
            driver_name: driverName,
            transaction_date: formattedDate,
            city: city,
            state: state,
            location: location,
            product: product,
            gallons: gallons,
            retail_amount: 0,
            amount: amount,
            savings: savings
          });
        }
      }
      
      // If line-by-line didn't work, text might not have line breaks - use regex on full text
      if (transactions.length === 0) {
        // Find all 10-digit transaction numbers and process surrounding text
        const txnRegex = /(\d{10})\s+(\d+)\s+(\d+)\s+([A-Za-z\s]+?)\s+(\d{2}\/\d{2}\/\d{4})/g;
        let match;
        
        while ((match = txnRegex.exec(text)) !== null) {
          const txnNum = match[1];
          const unitNum = match[2];
          const cardNum = match[3];
          const driverName = match[4].trim();
          const dateStr = match[5];
          
          const [month, day, year] = dateStr.split('/');
          const formattedDate = year + '-' + month + '-' + day;
          
          // Get text after this match until next transaction or end
          const afterMatch = text.substring(match.index + match[0].length, match.index + match[0].length + 200);
          
          // Find state
          let state = '';
          let city = '';
          const stateMatch = afterMatch.match(new RegExp('(.+?)\\s+(' + statePattern + ')\\s+', 'i'));
          if (stateMatch) {
            city = stateMatch[1].trim();
            state = stateMatch[2].toUpperCase();
          }
          
          if (!state) continue;
          
          // Find product
          let product = '';
          let gallons = 0;
          let amount = 0;
          let savings = 0;
          
          if (afterMatch.includes('ULSD')) {
            product = 'ULSD';
            const ulsdMatch = afterMatch.match(/([\d.]+)\s+ULSD\s+\$?([\d.]+)\s+\$?([\d.]+)\s+\$?([\d.]+)/);
            if (ulsdMatch) {
              gallons = parseFloat(ulsdMatch[1]) || 0;
              amount = parseFloat(ulsdMatch[3]) || 0;
              savings = parseFloat(ulsdMatch[4]) || 0;
            }
          } else if (afterMatch.includes('DEF') && !afterMatch.includes('Txn Fee')) {
            product = 'DEF';
            const defMatch = afterMatch.match(/([\d.]+)\s+DEF\s+\$?([\d.]+)\s+\$?([\d.]+)/);
            if (defMatch) {
              gallons = parseFloat(defMatch[1]) || 0;
              amount = parseFloat(defMatch[3]) || 0;
            }
          } else if (afterMatch.includes('Txn Fee')) {
            product = 'Txn Fee';
            const feeMatch = afterMatch.match(/Txn\s+Fee\s+\$?([\d.]+)/);
            if (feeMatch) {
              amount = parseFloat(feeMatch[1]) || 0;
            }
          }
          
          if (product) {
            transactions.push({
              txn_number: txnNum,
              truck_number: unitNum,
              card_number: cardNum,
              driver_name: driverName,
              transaction_date: formattedDate,
              city: city,
              state: state,
              location: '',
              product: product,
              gallons: gallons,
              retail_amount: 0,
              amount: amount,
              savings: savings
            });
          }
        }
      }
      
      return transactions;
    }

    async function saveFuelTransactions() {
      if (parsedFuelData.length === 0) {
        showToast('No transactions to save', 'error');
        return;
      }
      
      showToast('Saving ' + parsedFuelData.length + ' transactions...');
      
      let saved = 0;
      let skipped = 0;
      
      for (const txn of parsedFuelData) {
        // Check if transaction already exists
        const existing = (appData.fuel_transactions || []).find(t => t.txn_number === txn.txn_number);
        if (existing) {
          skipped++;
          continue;
        }
        
        try {
          await dbInsert('fuel_transactions', txn);
          saved++;
        } catch (e) {
          console.error('Failed to save txn', txn.txn_number, e);
        }
      }
      
      document.querySelector('.modal-overlay').remove();
      showToast('Saved ' + saved + ' transactions' + (skipped > 0 ? ' (' + skipped + ' duplicates skipped)' : ''));
      parsedFuelData = [];
      await loadAllData();
      renderFuelTracking(document.getElementById('main-content'));
    }

    // ============ IFTA REPORT SECTION ============
    let iftaQuarter = Math.ceil((new Date().getMonth() + 1) / 3);
    let iftaYear = new Date().getFullYear();
    let iftaMileageData = [];
    let fleetMPG = 6.0; // Default MPG for car haulers

    // 2024 IFTA Tax Rates (cents per gallon) - Diesel
    const iftaTaxRates = {
      'AL': 0.29, 'AZ': 0.26, 'AR': 0.285, 'CA': 0.8945, 'CO': 0.205,
      'CT': 0.441, 'DE': 0.22, 'FL': 0.35, 'GA': 0.354, 'ID': 0.32,
      'IL': 0.467, 'IN': 0.56, 'IA': 0.325, 'KS': 0.26, 'KY': 0.246,
      'LA': 0.20, 'ME': 0.312, 'MD': 0.3705, 'MA': 0.26, 'MI': 0.267,
      'MN': 0.285, 'MS': 0.18, 'MO': 0.17, 'MT': 0.2975, 'NE': 0.287,
      'NV': 0.27, 'NH': 0.222, 'NJ': 0.494, 'NM': 0.21, 'NY': 0.3005,
      'NC': 0.382, 'ND': 0.23, 'OH': 0.47, 'OK': 0.19, 'OR': 0.38,
      'PA': 0.741, 'RI': 0.34, 'SC': 0.22, 'SD': 0.28, 'TN': 0.27,
      'TX': 0.20, 'UT': 0.315, 'VT': 0.31, 'VA': 0.296, 'WA': 0.494,
      'WV': 0.352, 'WI': 0.329, 'WY': 0.24, 'DC': 0.235,
      // Canadian Provinces
      'AB': 0.13, 'BC': 0.2767, 'MB': 0.14, 'NB': 0.217, 'NL': 0.165,
      'NS': 0.154, 'ON': 0.143, 'PE': 0.137, 'QC': 0.202, 'SK': 0.15
    };

    function getQuarterDateRange(quarter, year) {
      const ranges = {
        1: { start: year + '-01-01', end: year + '-03-31', label: 'Q1 (Jan-Mar)' },
        2: { start: year + '-04-01', end: year + '-06-30', label: 'Q2 (Apr-Jun)' },
        3: { start: year + '-07-01', end: year + '-09-30', label: 'Q3 (Jul-Sep)' },
        4: { start: year + '-10-01', end: year + '-12-31', label: 'Q4 (Oct-Dec)' }
      };
      return ranges[quarter];
    }

    function renderIFTA(c) {
      const qRange = getQuarterDateRange(iftaQuarter, iftaYear);
      
      // Get fuel data for the quarter from fuel_transactions
      const quarterFuel = (appData.fuel_transactions || []).filter(t => {
        if (!t.transaction_date) return false;
        const d = t.transaction_date;
        return d >= qRange.start && d <= qRange.end && t.product === 'ULSD';
      });
      
      // Group fuel by state
      const fuelByState = {};
      quarterFuel.forEach(t => {
        const state = t.state?.toUpperCase();
        if (state) {
          if (!fuelByState[state]) fuelByState[state] = 0;
          fuelByState[state] += parseFloat(t.gallons || 0);
        }
      });
      
      const totalFuelGallons = Object.values(fuelByState).reduce((s, v) => s + v, 0);
      
      // Calculate actual MPG from trip data for the quarter
      const quarterTrips = (appData.trips || []).filter(t => {
        if (!t.trip_date) return false;
        return t.trip_date >= qRange.start && t.trip_date <= qRange.end;
      });
      const tripMilesTotal = quarterTrips.reduce((s, t) => s + parseFloat(t.miles || 0), 0);
      const calculatedMPG = totalFuelGallons > 0 ? (tripMilesTotal / totalFuelGallons) : 0;
      const hasCalcData = tripMilesTotal > 0 && totalFuelGallons > 0;
      
      // Calculate IFTA if we have mileage data
      let iftaResults = [];
      let totalMiles = 0;
      let totalTaxableGallons = 0;
      let totalTaxOwed = 0;
      let totalTaxCredit = 0;
      
      if (iftaMileageData.length > 0) {
        totalMiles = iftaMileageData.reduce((s, m) => s + m.miles, 0);
        totalTaxableGallons = totalMiles / fleetMPG;
        
        iftaMileageData.forEach(m => {
          const state = m.state.toUpperCase();
          const stateMiles = m.miles;
          const percentOfMiles = totalMiles > 0 ? stateMiles / totalMiles : 0;
          const taxableGallons = totalTaxableGallons * percentOfMiles;
          const fuelPurchased = fuelByState[state] || 0;
          const netTaxableGallons = taxableGallons - fuelPurchased;
          const taxRate = iftaTaxRates[state] || 0;
          const taxDue = netTaxableGallons * taxRate;
          
          if (taxDue > 0) totalTaxOwed += taxDue;
          else totalTaxCredit += Math.abs(taxDue);
          
          iftaResults.push({
            state,
            miles: stateMiles,
            percentOfMiles: percentOfMiles * 100,
            taxableGallons,
            fuelPurchased,
            netTaxableGallons,
            taxRate,
            taxDue
          });
        });
        
        // Sort by state
        iftaResults.sort((a, b) => a.state.localeCompare(b.state));
      }
      
      const netTax = totalTaxOwed - totalTaxCredit;
      
      c.innerHTML = '<div class="header"><h2>ðŸ“‘ IFTA Report</h2><div style="display:flex;gap:12px"><button class="btn btn-primary" onclick="openIFTAUploadModal()">ðŸ“¤ Upload Samsara Mileage</button>' + (iftaMileageData.length > 0 ? '<button class="btn btn-secondary" style="background:#fee2e2;color:#dc2626;border-color:#fecaca" onclick="clearIFTAMileage()">ðŸ—‘ï¸ Clear Mileage Data</button>' : '') + '</div></div>' +
        
        // Quarter selector
        '<div class="card" style="padding:16px;margin-bottom:24px"><div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">' +
        '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Quarter</label><select id="iftaQuarter" onchange="iftaQuarter=parseInt(this.value);renderIFTA(document.getElementById(\'main-content\'))"><option value="1"' + (iftaQuarter === 1 ? ' selected' : '') + '>Q1 (Jan-Mar)</option><option value="2"' + (iftaQuarter === 2 ? ' selected' : '') + '>Q2 (Apr-Jun)</option><option value="3"' + (iftaQuarter === 3 ? ' selected' : '') + '>Q3 (Jul-Sep)</option><option value="4"' + (iftaQuarter === 4 ? ' selected' : '') + '>Q4 (Oct-Dec)</option></select></div>' +
        '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Year</label><select id="iftaYear" onchange="iftaYear=parseInt(this.value);renderIFTA(document.getElementById(\'main-content\'))"><option value="2024"' + (iftaYear === 2024 ? ' selected' : '') + '>2024</option><option value="2025"' + (iftaYear === 2025 ? ' selected' : '') + '>2025</option><option value="2026"' + (iftaYear === 2026 ? ' selected' : '') + '>2026</option><option value="2027"' + (iftaYear === 2027 ? ' selected' : '') + '>2027</option></select></div>' +
        '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Fleet MPG</label><div style="display:flex;gap:8px;align-items:center"><input type="number" step="0.1" value="' + fleetMPG + '" style="width:80px" onchange="fleetMPG=parseFloat(this.value)||6;renderIFTA(document.getElementById(\'main-content\'))">' +
        (hasCalcData ? '<button class="btn btn-secondary" style="padding:6px 10px;font-size:12px" onclick="fleetMPG=' + calculatedMPG.toFixed(2) + ';renderIFTA(document.getElementById(\'main-content\'))" title="Use calculated MPG from your trip miles and fuel data">Use ' + calculatedMPG.toFixed(2) + '</button>' : '') +
        '</div></div>' +
        '<div style="margin-left:auto;font-size:18px;font-weight:700;color:#1e40af">ðŸ“… ' + qRange.label + ' ' + iftaYear + '</div></div>' +
        
        // Auto MPG Info Box
        (hasCalcData ? '<div style="background:#dbeafe;border:1px solid #3b82f6;border-radius:6px;padding:12px;margin-top:12px;display:flex;align-items:center;gap:16px;flex-wrap:wrap">' +
        '<span style="font-size:14px;color:#1e40af">ðŸ“Š <strong>Auto-Calculated MPG:</strong> ' + calculatedMPG.toFixed(2) + ' MPG</span>' +
        '<span style="font-size:12px;color:#3b82f6">(' + tripMilesTotal.toLocaleString() + ' trip miles Ã· ' + totalFuelGallons.toFixed(1) + ' gallons = ' + calculatedMPG.toFixed(2) + ' MPG)</span>' +
        (Math.abs(calculatedMPG - fleetMPG) > 0.5 ? '<span style="font-size:12px;color:#dc2626;background:#fee2e2;padding:4px 8px;border-radius:4px">âš ï¸ Differs from current setting by ' + Math.abs(calculatedMPG - fleetMPG).toFixed(2) + ' MPG</span>' : '<span style="font-size:12px;color:#059669">âœ“ Close to current setting</span>') +
        '</div>' : 
        '<div style="background:#fef3c7;border:1px solid #f59e0b;border-radius:6px;padding:12px;margin-top:12px">' +
        '<span style="font-size:13px;color:#92400e">ðŸ’¡ <strong>Tip:</strong> Add trip miles and fuel transactions to auto-calculate your actual fleet MPG for more accurate IFTA reporting.</span></div>') +
        '</div>' +
        
        // Summary Stats
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Total Miles</div><div class="value">' + totalMiles.toLocaleString(undefined, {maximumFractionDigits: 0}) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:80px;padding:12px 16px"><div class="label">Fleet MPG</div><div class="value">' + fleetMPG.toFixed(1) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px"><div class="label">Taxable Gallons</div><div class="value">' + totalTaxableGallons.toFixed(2) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px"><div class="label">Fuel Purchased</div><div class="value">' + totalFuelGallons.toFixed(2) + ' gal</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px;background:#fee2e2"><div class="label">Tax Owed</div><div class="value" style="color:#dc2626">' + formatMoney(totalTaxOwed) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px;background:#d1fae5"><div class="label">Tax Credit</div><div class="value" style="color:#059669">' + formatMoney(totalTaxCredit) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px;background:' + (netTax >= 0 ? '#fee2e2' : '#d1fae5') + '"><div class="label">Net Tax Due</div><div class="value" style="color:' + (netTax >= 0 ? '#dc2626' : '#059669') + ';font-size:20px">' + (netTax >= 0 ? '' : '-') + formatMoney(Math.abs(netTax)) + '</div></div>' +
        '</div>' +
        
        // Instructions if no mileage data
        (iftaMileageData.length === 0 ? 
          '<div style="background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:24px;margin-bottom:24px;text-align:center">' +
          '<h3 style="color:#92400e;margin:0 0 12px 0">ðŸ“¤ Upload Samsara Mileage Report</h3>' +
          '<p style="color:#a16207;margin:0">Click the button above to upload your Samsara IFTA CSV file with mileage by state.</p>' +
          '</div>' : '') +
        
        // Fuel by State (from fuel tracking)
        '<div class="card" style="margin-bottom:24px"><div class="card-header"><h3>â›½ Fuel Purchased by State (from Fuel Tracking)</h3></div><div class="table-wrapper"><table><thead><tr><th>State</th><th>Gallons Purchased</th></tr></thead><tbody>' +
        (Object.keys(fuelByState).length === 0 ? '<tr><td colspan="2" style="text-align:center;padding:20px">No fuel data for this quarter. Upload fuel reports in Fuel Tracking.</td></tr>' :
        Object.entries(fuelByState).sort((a, b) => a[0].localeCompare(b[0])).map(([st, gal]) => '<tr><td><strong>' + st + '</strong></td><td>' + gal.toFixed(2) + '</td></tr>').join('')) +
        '<tr style="background:#f1f5f9;font-weight:700"><td>TOTAL</td><td>' + totalFuelGallons.toFixed(2) + '</td></tr>' +
        '</tbody></table></div></div>' +
        
        // IFTA Calculation Table
        (iftaMileageData.length > 0 ?
          '<div class="card"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center"><h3>ðŸ“Š IFTA Calculation by Jurisdiction</h3><button class="btn btn-secondary" onclick="exportIFTA()">ðŸ“¥ Export CSV</button></div><div class="table-wrapper"><table><thead><tr><th>State</th><th>Miles</th><th>% of Miles</th><th>Taxable Gal</th><th>Fuel Purchased</th><th>Net Taxable</th><th>Tax Rate</th><th>Tax Due</th></tr></thead><tbody>' +
          iftaResults.map(r => '<tr><td><strong>' + r.state + '</strong></td><td>' + r.miles.toLocaleString(undefined, {maximumFractionDigits: 0}) + '</td><td>' + r.percentOfMiles.toFixed(2) + '%</td><td>' + r.taxableGallons.toFixed(2) + '</td><td>' + r.fuelPurchased.toFixed(2) + '</td><td style="color:' + (r.netTaxableGallons >= 0 ? '#dc2626' : '#059669') + '">' + r.netTaxableGallons.toFixed(2) + '</td><td>$' + r.taxRate.toFixed(4) + '</td><td class="money" style="color:' + (r.taxDue >= 0 ? '#dc2626' : '#059669') + '">' + (r.taxDue >= 0 ? '' : '-') + formatMoney(Math.abs(r.taxDue)) + '</td></tr>').join('') +
          '<tr style="background:#f1f5f9;font-weight:700"><td>TOTAL</td><td>' + totalMiles.toLocaleString(undefined, {maximumFractionDigits: 0}) + '</td><td>100%</td><td>' + totalTaxableGallons.toFixed(2) + '</td><td>' + totalFuelGallons.toFixed(2) + '</td><td>' + (totalTaxableGallons - totalFuelGallons).toFixed(2) + '</td><td>-</td><td style="color:' + (netTax >= 0 ? '#dc2626' : '#059669') + '">' + (netTax >= 0 ? '' : '-') + formatMoney(Math.abs(netTax)) + '</td></tr>' +
          '</tbody></table></div></div>' : '');
    }

    function openIFTAUploadModal() {
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3>ðŸ“¤ Upload Samsara IFTA Mileage</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body">' +
        '<div style="background:#dbeafe;padding:16px;border-radius:8px;margin-bottom:16px"><strong style="color:#1d4ed8">Supported Format:</strong><p style="color:#1e40af;margin-top:8px;font-size:14px">Samsara IFTA CSV export with columns: Jurisdiction, Fuel Type, Taxable Miles, Total Miles</p></div>' +
        '<div class="form-group"><label>Select CSV File</label><input type="file" id="iftaCsvFile" accept=".csv"></div>' +
        '<div id="iftaParsePreview" style="display:none;margin-top:16px;max-height:300px;overflow-y:auto"></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="parseIFTACsv()">ðŸ” Parse CSV</button></div></div>';
      document.body.appendChild(m);
    }

    function clearIFTAMileage() {
      if (!confirm('Clear all uploaded mileage data?\n\nYou will need to re-upload the Samsara CSV.')) {
        return;
      }
      iftaMileageData = [];
      showToast('Mileage data cleared');
      renderIFTA(document.getElementById('main-content'));
    }

    async function parseIFTACsv() {
      const fileInput = document.getElementById('iftaCsvFile');
      if (!fileInput.files || fileInput.files.length === 0) {
        showToast('Please select a CSV file', 'error');
        return;
      }
      
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n');
        const data = [];
        
        // Skip header
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          const cols = line.split(',');
          if (cols.length >= 4) {
            const state = cols[0].trim().toUpperCase();
            const miles = parseFloat(cols[2]) || parseFloat(cols[3]) || 0; // Taxable Miles or Total Miles
            
            if (state && miles > 0) {
              data.push({ state, miles });
            }
          }
        }
        
        if (data.length > 0) {
          iftaMileageData = data;
          document.querySelector('.modal-overlay').remove();
          showToast('Loaded ' + data.length + ' jurisdictions');
          renderIFTA(document.getElementById('main-content'));
        } else {
          const preview = document.getElementById('iftaParsePreview');
          preview.style.display = 'block';
          preview.innerHTML = '<div style="background:#fee2e2;padding:12px;border-radius:8px"><strong style="color:#dc2626">No valid data found. Check CSV format.</strong></div>';
        }
      };
      
      reader.readAsText(file);
    }

    function exportIFTA() {
      const qRange = getQuarterDateRange(iftaQuarter, iftaYear);
      
      // Get fuel data
      const quarterFuel = (appData.fuel_transactions || []).filter(t => {
        if (!t.transaction_date) return false;
        const d = t.transaction_date;
        return d >= qRange.start && d <= qRange.end && t.product === 'ULSD';
      });
      
      const fuelByState = {};
      quarterFuel.forEach(t => {
        const state = t.state?.toUpperCase();
        if (state) {
          if (!fuelByState[state]) fuelByState[state] = 0;
          fuelByState[state] += parseFloat(t.gallons || 0);
        }
      });
      
      const totalMiles = iftaMileageData.reduce((s, m) => s + m.miles, 0);
      const totalTaxableGallons = totalMiles / fleetMPG;
      
      let csv = 'Jurisdiction,Miles,Percent of Miles,Taxable Gallons,Fuel Purchased,Net Taxable Gallons,Tax Rate,Tax Due\n';
      
      iftaMileageData.forEach(m => {
        const state = m.state.toUpperCase();
        const stateMiles = m.miles;
        const percentOfMiles = totalMiles > 0 ? stateMiles / totalMiles : 0;
        const taxableGallons = totalTaxableGallons * percentOfMiles;
        const fuelPurchased = fuelByState[state] || 0;
        const netTaxableGallons = taxableGallons - fuelPurchased;
        const taxRate = iftaTaxRates[state] || 0;
        const taxDue = netTaxableGallons * taxRate;
        
        csv += state + ',' + stateMiles.toFixed(2) + ',' + (percentOfMiles * 100).toFixed(4) + ',' + taxableGallons.toFixed(2) + ',' + fuelPurchased.toFixed(2) + ',' + netTaxableGallons.toFixed(2) + ',' + taxRate.toFixed(4) + ',' + taxDue.toFixed(2) + '\n';
      });
      
      // Download
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'IFTA_Report_Q' + iftaQuarter + '_' + iftaYear + '.csv';
      a.click();
      URL.revokeObjectURL(url);
      showToast('IFTA Report exported!');
    }

    // ============ TASKS SECTION ============
    let taskFilter = 'all'; // all, today, upcoming, overdue, completed
    
    function renderTasks(c) {
      const tasks = appData.tasks || [];
      const today = new Date().toISOString().split('T')[0];
      
      // Filter tasks
      let filteredTasks = tasks;
      if (taskFilter === 'today') {
        filteredTasks = tasks.filter(t => t.due_date === today && t.status !== 'COMPLETED');
      } else if (taskFilter === 'upcoming') {
        filteredTasks = tasks.filter(t => t.due_date > today && t.status !== 'COMPLETED');
      } else if (taskFilter === 'overdue') {
        filteredTasks = tasks.filter(t => t.due_date < today && t.status !== 'COMPLETED');
      } else if (taskFilter === 'urgent') {
        filteredTasks = tasks.filter(t => t.priority === 'URGENT' && t.status !== 'COMPLETED');
      } else if (taskFilter === 'completed') {
        filteredTasks = tasks.filter(t => t.status === 'COMPLETED');
      } else {
        filteredTasks = tasks.filter(t => t.status !== 'COMPLETED');
      }
      
      // Sort: urgent first, then by due date
      filteredTasks.sort((a, b) => {
        if (a.priority === 'URGENT' && b.priority !== 'URGENT') return -1;
        if (b.priority === 'URGENT' && a.priority !== 'URGENT') return 1;
        return new Date(a.due_date) - new Date(b.due_date);
      });
      
      // Stats
      const totalPending = tasks.filter(t => t.status !== 'COMPLETED').length;
      const todayTasks = tasks.filter(t => t.due_date === today && t.status !== 'COMPLETED').length;
      const overdueTasks = tasks.filter(t => t.due_date < today && t.status !== 'COMPLETED').length;
      const urgentTasks = tasks.filter(t => t.priority === 'URGENT' && t.status !== 'COMPLETED').length;
      
      const getPriorityBadge = (p) => {
        if (p === 'URGENT') return '<span class="badge" style="background:#dc2626;color:white">ðŸ”¥ URGENT</span>';
        if (p === 'HIGH') return '<span class="badge" style="background:#f59e0b;color:white">HIGH</span>';
        if (p === 'NORMAL') return '<span class="badge badge-blue">NORMAL</span>';
        return '<span class="badge badge-gray">LOW</span>';
      };
      
      const getStatusBadge = (s) => {
        if (s === 'COMPLETED') return '<span class="badge badge-green">âœ“ COMPLETED</span>';
        if (s === 'IN_PROGRESS') return '<span class="badge badge-amber">IN PROGRESS</span>';
        return '<span class="badge badge-gray">PENDING</span>';
      };
      
      const isOverdue = (d, s) => d < today && s !== 'COMPLETED';
      
      c.innerHTML = '<div class="header"><h2>ðŸ“‹ Tasks</h2><button class="btn btn-primary" onclick="openTaskModal()">+ New Task</button></div>' +
        
        // Stats cards
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px;cursor:pointer;' + (taskFilter === 'all' ? 'border:2px solid #3b82f6' : '') + '" onclick="taskFilter=\'all\';renderTasks(document.getElementById(\'main-content\'))"><div class="label">Pending Tasks</div><div class="value">' + totalPending + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px;cursor:pointer;background:#dbeafe;' + (taskFilter === 'today' ? 'border:2px solid #3b82f6' : '') + '" onclick="taskFilter=\'today\';renderTasks(document.getElementById(\'main-content\'))"><div class="label">Due Today</div><div class="value" style="color:#2563eb">' + todayTasks + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px;cursor:pointer;background:#fee2e2;' + (taskFilter === 'overdue' ? 'border:2px solid #dc2626' : '') + '" onclick="taskFilter=\'overdue\';renderTasks(document.getElementById(\'main-content\'))"><div class="label">Overdue</div><div class="value" style="color:#dc2626">' + overdueTasks + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px;cursor:pointer;background:#fef3c7;' + (taskFilter === 'urgent' ? 'border:2px solid #f59e0b' : '') + '" onclick="taskFilter=\'urgent\';renderTasks(document.getElementById(\'main-content\'))"><div class="label">ðŸ”¥ Urgent</div><div class="value" style="color:#d97706">' + urgentTasks + '</div></div>' +
        '</div>' +
        
        // Filter tabs
        '<div style="display:flex;gap:8px;margin-bottom:16px">' +
        '<button class="btn ' + (taskFilter === 'all' ? 'btn-primary' : 'btn-secondary') + '" onclick="taskFilter=\'all\';renderTasks(document.getElementById(\'main-content\'))">All Pending</button>' +
        '<button class="btn ' + (taskFilter === 'today' ? 'btn-primary' : 'btn-secondary') + '" onclick="taskFilter=\'today\';renderTasks(document.getElementById(\'main-content\'))">Today</button>' +
        '<button class="btn ' + (taskFilter === 'upcoming' ? 'btn-primary' : 'btn-secondary') + '" onclick="taskFilter=\'upcoming\';renderTasks(document.getElementById(\'main-content\'))">Upcoming</button>' +
        '<button class="btn ' + (taskFilter === 'overdue' ? 'btn-primary' : 'btn-secondary') + '" style="' + (taskFilter === 'overdue' ? '' : 'background:#fee2e2;color:#dc2626;border-color:#fecaca') + '" onclick="taskFilter=\'overdue\';renderTasks(document.getElementById(\'main-content\'))">Overdue</button>' +
        '<button class="btn ' + (taskFilter === 'completed' ? 'btn-primary' : 'btn-secondary') + '" onclick="taskFilter=\'completed\';renderTasks(document.getElementById(\'main-content\'))">Completed</button>' +
        '</div>' +
        
        // Tasks list
        '<div class="card"><div class="card-header"><h3>' + (taskFilter === 'completed' ? 'Completed Tasks' : taskFilter === 'overdue' ? 'Overdue Tasks' : taskFilter === 'today' ? "Today's Tasks" : 'Tasks') + ' (' + filteredTasks.length + ')</h3></div>' +
        (filteredTasks.length === 0 ? '<div style="padding:40px;text-align:center;color:#64748b">' + (taskFilter === 'completed' ? 'No completed tasks yet' : 'No tasks found') + '</div>' :
        '<div style="padding:16px">' +
        filteredTasks.map(t => {
          const assignee = appData.dispatchers.find(d => d.id === t.assigned_to);
          const creator = appData.users.find(u => u.id === t.created_by);
          const overdueStyle = isOverdue(t.due_date, t.status) ? 'border-left:4px solid #dc2626;background:#fef2f2' : '';
          const urgentStyle = t.priority === 'URGENT' && t.status !== 'COMPLETED' ? 'border-left:4px solid #f59e0b;background:#fffbeb' : '';
          
          return '<div style="padding:16px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:12px;' + (overdueStyle || urgentStyle) + '">' +
            '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px">' +
            '<div style="flex:1">' +
            '<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">' +
            (t.status !== 'COMPLETED' ? '<input type="checkbox" style="width:20px;height:20px;cursor:pointer" onchange="toggleTaskComplete(' + t.id + ',this.checked)" title="Mark as completed">' : '<span style="color:#10b981;font-size:20px">âœ“</span>') +
            '<strong style="font-size:16px;' + (t.status === 'COMPLETED' ? 'text-decoration:line-through;color:#94a3b8' : '') + '">' + t.title + '</strong>' +
            getPriorityBadge(t.priority) +
            getStatusBadge(t.status) +
            '</div>' +
            (t.description ? '<p style="color:#64748b;margin:0 0 8px 32px;font-size:14px">' + t.description + '</p>' : '') +
            '<div style="display:flex;gap:16px;margin-left:32px;font-size:13px;color:#64748b">' +
            '<span>ðŸ“… ' + (isOverdue(t.due_date, t.status) ? '<span style="color:#dc2626;font-weight:600">OVERDUE: </span>' : '') + formatDate(t.due_date) + '</span>' +
            (assignee ? '<span>ðŸ‘¤ ' + assignee.name + '</span>' : '') +
            (creator ? '<span>Created by: ' + (creator.first_name || creator.email) + '</span>' : '') +
            '</div>' +
            '</div>' +
            '<div class="actions">' +
            (t.status !== 'COMPLETED' ? '<button class="action-btn" style="background:#10b981;color:white" onclick="toggleTaskComplete(' + t.id + ',true)" title="Complete">âœ“</button>' : '<button class="action-btn" style="background:#f59e0b;color:white" onclick="toggleTaskComplete(' + t.id + ',false)" title="Reopen">â†©</button>') +
            '<button class="action-btn edit" onclick="openTaskModal(' + t.id + ')">Edit</button>' +
            '<button class="action-btn delete" onclick="deleteTask(' + t.id + ')">Del</button>' +
            '</div></div></div>';
        }).join('') +
        '</div>') +
        '</div>';
    }
    
    function openTaskModal(id = null) {
      const t = id ? (appData.tasks || []).find(x => x.id === id) : null;
      const today = new Date().toISOString().split('T')[0];
      
      const dispatcherOptions = appData.dispatchers.map(d => '<option value="' + d.id + '"' + (t?.assigned_to === d.id ? ' selected' : '') + '>' + d.name + '</option>').join('');
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3>' + (t ? 'Edit Task' : 'New Task') + '</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body">' +
        '<div class="form-group"><label>Task Title *</label><input id="taskTitle" value="' + (t?.title || '') + '" placeholder="What needs to be done?"></div>' +
        '<div class="form-group"><label>Description</label><textarea id="taskDesc" rows="3" placeholder="Additional details...">' + (t?.description || '') + '</textarea></div>' +
        '<div class="form-row"><div class="form-group"><label>Due Date *</label><input type="date" id="taskDue" value="' + (t?.due_date || today) + '"></div><div class="form-group"><label>Priority</label><select id="taskPriority"><option value="LOW"' + (t?.priority === 'LOW' ? ' selected' : '') + '>Low</option><option value="NORMAL"' + (!t || t?.priority === 'NORMAL' ? ' selected' : '') + '>Normal</option><option value="HIGH"' + (t?.priority === 'HIGH' ? ' selected' : '') + '>High</option><option value="URGENT"' + (t?.priority === 'URGENT' ? ' selected' : '') + '>ðŸ”¥ Urgent</option></select></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Assign To</label><select id="taskAssignee"><option value="">Everyone / Unassigned</option>' + dispatcherOptions + '</select></div><div class="form-group"><label>Status</label><select id="taskStatus"><option value="PENDING"' + (!t || t?.status === 'PENDING' ? ' selected' : '') + '>Pending</option><option value="IN_PROGRESS"' + (t?.status === 'IN_PROGRESS' ? ' selected' : '') + '>In Progress</option><option value="COMPLETED"' + (t?.status === 'COMPLETED' ? ' selected' : '') + '>Completed</option></select></div></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveTask(' + id + ')">Save Task</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function saveTask(id) {
      const title = document.getElementById('taskTitle').value.trim();
      if (!title) { showToast('Please enter task title', 'error'); return; }
      
      const data = {
        title: title,
        description: document.getElementById('taskDesc').value || null,
        due_date: document.getElementById('taskDue').value,
        priority: document.getElementById('taskPriority').value,
        assigned_to: parseInt(document.getElementById('taskAssignee').value) || null,
        status: document.getElementById('taskStatus').value,
        created_by: currentUser.id
      };
      
      try {
        if (id) {
          await dbUpdate('tasks', id, data);
          await logActivity('TASK_UPDATED', { task_id: id, task_title: title, status: data.status, priority: data.priority });
        } else {
          const newTask = await dbInsert('tasks', data);
          await logActivity('TASK_CREATED', { task_id: newTask.id, task_title: title, status: data.status, priority: data.priority });
        }
        document.querySelector('.modal-overlay').remove();
        showToast(id ? 'Task updated!' : 'Task created!');
        await loadAllData();
        renderTasks(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    async function toggleTaskComplete(id, complete) {
      try {
        const task = (appData.tasks || []).find(t => t.id === id);
        await dbUpdate('tasks', id, { 
          status: complete ? 'COMPLETED' : 'PENDING',
          completed_at: complete ? new Date().toISOString() : null
        });
        await logActivity(complete ? 'TASK_COMPLETED' : 'TASK_REOPENED', { task_id: id, task_title: task?.title });
        showToast(complete ? 'Task completed! âœ“' : 'Task reopened');
        await loadAllData();
        renderTasks(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    async function deleteTask(id) {
      if (!confirm('Delete this task?')) return;
      try {
        const task = (appData.tasks || []).find(t => t.id === id);
        await dbDelete('tasks', id);
        await logActivity('TASK_DELETED', { task_id: id, task_title: task?.title });
        showToast('Task deleted');
        await loadAllData();
        renderTasks(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    // ============ COMPLIANCE SECTION ============
    let complianceTab = 'drivers';

    // Compliance tab state
    let complianceMainTab = 'dashboard'; // dashboard, tasks, driver_files, truck_files, driver_compliance, accidents
    
    function renderCompliance(c) {
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      
      // Tab buttons
      const tabs = [
        { id: 'dashboard', label: 'ðŸ“Š Dashboard', color: '#3b82f6' },
        { id: 'tasks', label: 'ðŸ“‹ Compliance Tasks', color: '#8b5cf6' },
        { id: 'driver_files', label: 'ðŸ‘¤ Driver Files', color: '#1e40af' },
        { id: 'truck_files', label: 'ðŸšš Truck Files', color: '#0891b2' },
        { id: 'driver_compliance', label: 'ðŸŽ« Tickets/Violations', color: '#dc2626' },
        { id: 'accidents', label: 'ðŸš¨ Accident Registry', color: '#f59e0b' }
      ];
      
      const tabsHtml = '<div style="display:flex;gap:4px;margin-bottom:20px;flex-wrap:wrap">' +
        tabs.map(t => '<button onclick="complianceMainTab=\'' + t.id + '\';renderCompliance(document.getElementById(\'main-content\'))" style="padding:10px 16px;border:none;cursor:pointer;font-weight:600;border-radius:8px;font-size:13px;' + (complianceMainTab === t.id ? 'background:' + t.color + ';color:white' : 'background:#e2e8f0;color:#475569') + '">' + t.label + '</button>').join('') +
        '</div>';
      
      c.innerHTML = '<div class="header"><h2>ðŸ“‹ Compliance Center</h2></div>' + tabsHtml + '<div id="complianceContent"></div>';
      
      const content = document.getElementById('complianceContent');
      if (complianceMainTab === 'dashboard') renderComplianceDashboard(content);
      else if (complianceMainTab === 'tasks') renderComplianceTasks(content);
      else if (complianceMainTab === 'driver_files') renderComplianceDriverFiles(content);
      else if (complianceMainTab === 'truck_files') renderComplianceTruckFiles(content);
      else if (complianceMainTab === 'driver_compliance') renderComplianceDriverSection(content);
      else if (complianceMainTab === 'accidents') renderAccidentRegistry(content);
    }
    
    // ========== COMPLIANCE DASHBOARD ==========
    function renderComplianceDashboard(c) {
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const next7Days = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      const next30Days = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      
      const tickets = appData.tickets || [];
      const claims = appData.claims || [];
      const accidents = appData.accidents || [];
      const compTasks = appData.compliance_tasks || [];
      
      // Stats
      const openTickets = tickets.filter(t => !['RESOLVED', 'DISMISSED'].includes(t.status)).length;
      const openClaims = claims.filter(cl => !['SETTLED', 'DENIED'].includes(cl.status)).length;
      
      // Days without accidents
      const lastAccident = accidents.sort((a, b) => (b.accident_date || '').localeCompare(a.accident_date || ''))[0];
      const daysWithoutAccident = lastAccident?.accident_date ? Math.floor((today - new Date(lastAccident.accident_date)) / (1000 * 60 * 60 * 24)) : 'N/A';
      
      // Upcoming driver tasks (file expirations)
      const driverTasks = [];
      appData.drivers.forEach(d => {
        const files = (appData.driver_files || []).filter(f => f.driver_id === d.id && f.expiration_date);
        files.forEach(f => {
          if (f.expiration_date >= todayStr && f.expiration_date <= next7Days) {
            driverTasks.push({ driver: d.first_name + ' ' + d.last_name, task: f.file_type.replace(/_/g, ' '), due: f.expiration_date });
          }
        });
      });
      
      // Driver birthdays in next 7 days
      const birthdays = appData.drivers.filter(d => {
        if (!d.date_of_birth) return false;
        const dob = new Date(d.date_of_birth);
        const thisYearBday = new Date(today.getFullYear(), dob.getMonth(), dob.getDate());
        const diff = Math.ceil((thisYearBday - today) / (1000 * 60 * 60 * 24));
        return diff >= 0 && diff <= 7;
      }).map(d => {
        const dob = new Date(d.date_of_birth);
        const thisYearBday = new Date(today.getFullYear(), dob.getMonth(), dob.getDate());
        return { driver: d.first_name + ' ' + d.last_name, date: thisYearBday.toISOString().split('T')[0] };
      });
      
      // Vehicle tasks (truck file expirations)
      const vehicleTasks = [];
      appData.trucks.forEach(t => {
        const files = (appData.truck_files || []).filter(f => f.truck_id === t.id && f.expiration_date);
        files.forEach(f => {
          if (f.expiration_date >= todayStr && f.expiration_date <= next7Days) {
            vehicleTasks.push({ unit: '#' + t.truck_number, task: f.file_type.replace(/_/g, ' '), due: f.expiration_date });
          }
        });
      });
      
      // Court dates in next 30 days
      const courtDates = tickets.filter(t => t.court_date && t.court_date >= todayStr && t.court_date <= next30Days && !['RESOLVED', 'DISMISSED'].includes(t.status))
        .map(t => {
          const driver = appData.drivers.find(d => d.id === t.driver_id);
          return { driver: driver ? driver.first_name + ' ' + driver.last_name : 'Unknown', date: t.court_date };
        });
      
      // Compliance tasks due in next 30 days
      const upcomingCompTasks = compTasks.filter(t => t.next_due_date && t.next_due_date >= todayStr && t.next_due_date <= next30Days)
        .map(t => ({ task: t.task_name, due: t.next_due_date }));
      
      c.innerHTML = '<div class="card" style="margin-bottom:24px;background:linear-gradient(135deg,#1e40af,#3b82f6);color:white;padding:24px"><h3 style="margin:0 0 16px">ðŸ“Š Compliance Report</h3>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">' +
        '<div style="background:rgba(255,255,255,0.15);padding:20px;border-radius:12px;text-align:center"><div style="font-size:14px;opacity:0.9">Open Tickets</div><div style="font-size:36px;font-weight:700">' + openTickets + '</div></div>' +
        '<div style="background:rgba(255,255,255,0.15);padding:20px;border-radius:12px;text-align:center"><div style="font-size:14px;opacity:0.9">Open Claims</div><div style="font-size:36px;font-weight:700">' + openClaims + '</div></div>' +
        '<div style="background:rgba(255,255,255,0.15);padding:20px;border-radius:12px;text-align:center"><div style="font-size:14px;opacity:0.9">Days Without Accidents</div><div style="font-size:36px;font-weight:700;color:#4ade80">' + daysWithoutAccident + '</div></div>' +
        '</div></div>' +
        
        // Grid of upcoming items
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px">' +
        
        // Driver Tasks
        '<div class="card"><div class="card-header"><h4 style="margin:0">ðŸ‘¤ Driver Tasks (Next 7 Days)</h4></div><div style="padding:16px;max-height:200px;overflow-y:auto">' +
        (driverTasks.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:20px">No tasks due</div>' :
        driverTasks.map(t => '<div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-darker);border-radius:6px;margin-bottom:8px"><div><strong>' + t.driver + '</strong><br><span style="font-size:12px;color:var(--text-muted)">' + t.task + '</span></div><div style="font-size:12px;color:#f59e0b">' + formatDate(t.due) + '</div></div>').join('')) +
        '</div></div>' +
        
        // Birthdays
        '<div class="card"><div class="card-header"><h4 style="margin:0">ðŸŽ‚ Birthdays (Next 7 Days)</h4></div><div style="padding:16px;max-height:200px;overflow-y:auto">' +
        (birthdays.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:20px">No birthdays this week</div>' :
        birthdays.map(b => '<div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-darker);border-radius:6px;margin-bottom:8px"><div><strong>' + b.driver + '</strong></div><div style="font-size:12px;color:#ec4899">' + formatDate(b.date) + '</div></div>').join('')) +
        '</div></div>' +
        
        // Vehicle Tasks
        '<div class="card"><div class="card-header"><h4 style="margin:0">ðŸšš Vehicle Tasks (Next 7 Days)</h4></div><div style="padding:16px;max-height:200px;overflow-y:auto">' +
        (vehicleTasks.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:20px">No tasks due</div>' :
        vehicleTasks.map(t => '<div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-darker);border-radius:6px;margin-bottom:8px"><div><strong>' + t.unit + '</strong><br><span style="font-size:12px;color:var(--text-muted)">' + t.task + '</span></div><div style="font-size:12px;color:#f59e0b">' + formatDate(t.due) + '</div></div>').join('')) +
        '</div></div>' +
        
        // Court Dates
        '<div class="card"><div class="card-header"><h4 style="margin:0">âš–ï¸ Court Dates (Next 30 Days)</h4></div><div style="padding:16px;max-height:200px;overflow-y:auto">' +
        (courtDates.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:20px">No court dates found</div>' :
        courtDates.map(cd => '<div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-darker);border-radius:6px;margin-bottom:8px"><div><strong>' + cd.driver + '</strong></div><div style="font-size:12px;color:#dc2626">' + formatDate(cd.date) + '</div></div>').join('')) +
        '</div></div>' +
        
        // Compliance Tasks
        '<div class="card"><div class="card-header"><h4 style="margin:0">ðŸ“‹ Compliance Tasks (Next 30 Days)</h4></div><div style="padding:16px;max-height:200px;overflow-y:auto">' +
        (upcomingCompTasks.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:20px">No tasks found</div>' :
        upcomingCompTasks.map(t => '<div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-darker);border-radius:6px;margin-bottom:8px"><div><strong>' + t.task + '</strong></div><div style="font-size:12px;color:#8b5cf6">' + formatDate(t.due) + '</div></div>').join('')) +
        '</div></div>' +
        
        '</div>';
    }
    
    // ========== COMPLIANCE TASKS ==========
    function renderComplianceTasks(c) {
      const tasks = appData.compliance_tasks || [];
      const today = new Date().toISOString().split('T')[0];
      
      // Default compliance tasks
      const defaultTasks = [
        { name: 'BOC-3 Form', frequency: 'ANNUALLY', description: 'Blanket of Coverage form filed with FMCSA' },
        { name: 'Biennial MCS-150 Update Filing', frequency: 'BIENNIALLY', description: 'Update company info every 2 years' },
        { name: 'Liability Insurance Renewal', frequency: 'ANNUALLY', description: 'Renew liability insurance policy' },
        { name: 'Accident Register', frequency: 'AS_NEEDED', description: 'Document all accidents within 30 days' },
        { name: 'Annual Report with SOS', frequency: 'ANNUALLY', description: 'Secretary of State annual report' },
        { name: 'UCR (Unified Carrier Registration)', frequency: 'ANNUALLY', description: 'Annual UCR registration' },
        { name: 'IFTA Quarterly Filing', frequency: 'QUARTERLY', description: 'File IFTA fuel tax returns' },
        { name: 'NM Quarterly Filing', frequency: 'QUARTERLY', description: 'New Mexico quarterly filing if applicable' },
        { name: 'Purchase NM Permits', frequency: 'ANNUALLY', description: 'New Mexico trip permits' },
        { name: 'Order IFTA Decals', frequency: 'ANNUALLY', description: 'Order new IFTA decals' },
        { name: 'Clearinghouse Annual Queries', frequency: 'ANNUALLY', description: 'Run annual queries on all drivers' },
        { name: 'IRP Renewal - Truck Registration', frequency: 'ANNUALLY', description: 'International Registration Plan renewal' },
        { name: 'Pay 2290 Heavy Vehicle Use Tax', frequency: 'ANNUALLY', description: 'Due by Aug 31 for tax year' },
        { name: 'Arkansas Ad Valorem (If Needed)', frequency: 'ANNUALLY', description: 'Arkansas property tax if applicable' },
        { name: 'Drug and Alcohol Random Consortium Renewal', frequency: 'ANNUALLY', description: 'Consortium membership renewal' }
      ];
      
      // IFTA due dates calculation
      const getIFTADueDates = () => {
        const year = new Date().getFullYear();
        return [
          { quarter: 'Q1', period: 'Jan-Mar', due: year + '-04-30' },
          { quarter: 'Q2', period: 'Apr-Jun', due: year + '-07-31' },
          { quarter: 'Q3', period: 'Jul-Sep', due: year + '-10-31' },
          { quarter: 'Q4', period: 'Oct-Dec', due: (year + 1) + '-01-31' }
        ];
      };
      
      const iftaDates = getIFTADueDates();
      const nextIFTA = iftaDates.find(d => d.due >= today) || iftaDates[0];
      
      c.innerHTML = '<div class="card" style="margin-bottom:24px;background:#dbeafe;padding:16px;border:1px solid #3b82f6"><strong>ðŸ“… Next IFTA Filing:</strong> ' + nextIFTA.quarter + ' (' + nextIFTA.period + ') - Due: <strong>' + formatDate(nextIFTA.due) + '</strong></div>' +
        
        '<div class="card" style="margin-bottom:24px"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center"><h3>ðŸ“‹ Compliance Tasks</h3><button class="btn btn-primary" onclick="openComplianceTaskModal()">+ Add Task</button></div>' +
        '<div class="table-wrapper"><table><thead><tr><th>Task</th><th>Frequency</th><th>Last Completed</th><th>Next Due</th><th>Status</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        (tasks.length === 0 ? '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-muted)">No tasks added. Click "+ Add Task" or use default tasks below.</td></tr>' :
        tasks.map(t => {
          const isOverdue = t.next_due_date && t.next_due_date < today;
          const isDueSoon = t.next_due_date && !isOverdue && t.next_due_date <= new Date(new Date().getTime() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
          return '<tr><td><strong>' + t.task_name + '</strong>' + (t.description ? '<br><span style="font-size:11px;color:var(--text-muted)">' + t.description + '</span>' : '') + '</td>' +
            '<td><span class="badge badge-blue">' + (t.frequency || 'ANNUALLY') + '</span></td>' +
            '<td>' + (t.last_completed ? formatDate(t.last_completed) : '-') + '</td>' +
            '<td>' + (t.next_due_date ? formatDate(t.next_due_date) : '-') + '</td>' +
            '<td>' + (t.is_completed ? '<span class="badge badge-green">âœ“ Done</span>' : isOverdue ? '<span class="badge badge-red">OVERDUE</span>' : isDueSoon ? '<span class="badge badge-amber">Due Soon</span>' : '<span class="badge badge-gray">Pending</span>') + '</td>' +
            '<td class="sticky-col"><div class="actions"><button class="action-btn edit" onclick="markComplianceTaskDone(' + t.id + ')">âœ“ Done</button><button class="action-btn edit" onclick="openComplianceTaskModal(' + t.id + ')">Edit</button><button class="action-btn delete" onclick="deleteComplianceTask(' + t.id + ')">Del</button></div></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>' +
        
        // Default tasks helper
        '<div class="card"><div class="card-header"><h4>ðŸ“ Standard Compliance Tasks Reference</h4></div><div class="table-wrapper"><table><thead><tr><th>Task</th><th>Frequency</th><th>Action</th></tr></thead><tbody>' +
        defaultTasks.map(dt => {
          const exists = tasks.find(t => t.task_name === dt.name);
          return '<tr><td><strong>' + dt.name + '</strong><br><span style="font-size:11px;color:var(--text-muted)">' + dt.description + '</span></td><td><span class="badge badge-blue">' + dt.frequency + '</span></td><td>' + (exists ? '<span class="badge badge-green">Added</span>' : '<button class="btn btn-secondary btn-sm" onclick="addDefaultComplianceTask(\'' + dt.name.replace(/'/g, "\\'") + '\',\'' + dt.frequency + '\',\'' + dt.description.replace(/'/g, "\\'") + '\')">+ Add</button>') + '</td></tr>';
        }).join('') +
        '</tbody></table></div></div>';
    }
    
    function openComplianceTaskModal(id) {
      const t = id ? (appData.compliance_tasks || []).find(x => x.id === id) : null;
      const today = new Date().toISOString().split('T')[0];
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3>' + (t ? 'Edit' : 'Add') + ' Compliance Task</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body">' +
        '<div class="form-group"><label>Task Name *</label><input id="ctName" value="' + (t?.task_name || '') + '" placeholder="e.g., IFTA Quarterly Filing"></div>' +
        '<div class="form-group"><label>Description</label><input id="ctDesc" value="' + (t?.description || '') + '" placeholder="Brief description"></div>' +
        '<div class="form-row"><div class="form-group"><label>Frequency</label><select id="ctFreq"><option value="QUARTERLY"' + (t?.frequency === 'QUARTERLY' ? ' selected' : '') + '>Quarterly</option><option value="ANNUALLY"' + (!t || t?.frequency === 'ANNUALLY' ? ' selected' : '') + '>Annually</option><option value="BIENNIALLY"' + (t?.frequency === 'BIENNIALLY' ? ' selected' : '') + '>Biennially</option><option value="AS_NEEDED"' + (t?.frequency === 'AS_NEEDED' ? ' selected' : '') + '>As Needed</option></select></div><div class="form-group"><label>Next Due Date</label><input type="date" id="ctDue" value="' + (t?.next_due_date || '') + '"></div></div>' +
        '<div class="form-group"><label>Last Completed</label><input type="date" id="ctLast" value="' + (t?.last_completed || '') + '"></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveComplianceTask(' + (id || 'null') + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function saveComplianceTask(id) {
      const data = {
        task_name: document.getElementById('ctName').value,
        description: document.getElementById('ctDesc').value || null,
        frequency: document.getElementById('ctFreq').value,
        next_due_date: document.getElementById('ctDue').value || null,
        last_completed: document.getElementById('ctLast').value || null,
        is_completed: false
      };
      if (!data.task_name) { showToast('Task name required', 'error'); return; }
      try {
        if (id) { await dbUpdate('compliance_tasks', id, data); }
        else { await dbInsert('compliance_tasks', data); }
        document.querySelector('.modal-overlay').remove();
        showToast('Saved!');
        await loadAllData(true);
        renderCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    async function addDefaultComplianceTask(name, frequency, description) {
      try {
        await dbInsert('compliance_tasks', { task_name: name, frequency: frequency, description: description, is_completed: false });
        showToast('Task added!');
        await loadAllData(true);
        renderCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    async function markComplianceTaskDone(id) {
      const today = new Date().toISOString().split('T')[0];
      const task = (appData.compliance_tasks || []).find(t => t.id === id);
      if (!task) return;
      
      // Calculate next due date based on frequency
      let nextDue = null;
      const lastDate = new Date();
      if (task.frequency === 'QUARTERLY') {
        lastDate.setMonth(lastDate.getMonth() + 3);
        nextDue = lastDate.toISOString().split('T')[0];
      } else if (task.frequency === 'ANNUALLY') {
        lastDate.setFullYear(lastDate.getFullYear() + 1);
        nextDue = lastDate.toISOString().split('T')[0];
      } else if (task.frequency === 'BIENNIALLY') {
        lastDate.setFullYear(lastDate.getFullYear() + 2);
        nextDue = lastDate.toISOString().split('T')[0];
      }
      
      try {
        await dbUpdate('compliance_tasks', id, { last_completed: today, next_due_date: nextDue, is_completed: false });
        showToast('Marked complete!');
        await loadAllData(true);
        renderCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    async function deleteComplianceTask(id) {
      if (!confirm('Delete this task?')) return;
      try {
        await dbDelete('compliance_tasks', id);
        showToast('Deleted');
        await loadAllData(true);
        renderCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    // ========== DRIVER FILES TAB ==========
    function renderComplianceDriverFiles(c) {
      const today = new Date();
      
      // Alerts
      const alerts = [];
      appData.drivers.forEach(d => {
        const driverFiles = (appData.driver_files || []).filter(f => f.driver_id === d.id && f.expiration_date);
        driverFiles.forEach(f => {
          const expDate = new Date(f.expiration_date);
          const daysUntil = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
          if (daysUntil <= 7) {
            alerts.push({ name: d.first_name + ' ' + d.last_name, doc: f.file_type.replace(/_/g, ' '), days: daysUntil });
          }
        });
      });
      
      const alertsHtml = alerts.length > 0 ? '<div style="background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:16px;margin-bottom:24px"><strong style="color:#dc2626">âš ï¸ Expiring Soon (' + alerts.length + ')</strong><div style="margin-top:8px">' + alerts.slice(0, 5).map(a => '<span class="badge badge-amber" style="margin:4px">' + a.name + ' - ' + a.doc + ' (' + (a.days < 0 ? 'EXPIRED' : a.days + 'd') + ')</span>').join('') + '</div></div>' : '';
      
      c.innerHTML = alertsHtml +
        '<div class="card"><div class="table-wrapper"><table><thead><tr><th>Driver</th><th>CDL</th><th>Medical Card</th><th>MVR</th><th>PSP Report</th><th>Other</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        (appData.drivers.length === 0 ? '<tr><td colspan="7" style="text-align:center;padding:40px">No drivers</td></tr>' :
        appData.drivers.map(d => {
          const files = (appData.driver_files || []).filter(f => f.driver_id === d.id);
          const getStatus = (type) => {
            const file = files.find(f => f.file_type === type);
            if (!file) return '<span class="badge badge-gray">Missing</span>';
            if (!file.expiration_date) return '<span class="badge badge-green">âœ“</span>';
            const exp = new Date(file.expiration_date);
            const days = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
            if (days < 0) return '<span class="badge badge-red">Expired</span>';
            if (days <= 7) return '<span class="badge badge-amber">' + days + 'd</span>';
            return '<span class="badge badge-green">âœ“</span>';
          };
          const otherCount = files.filter(f => !['CDL', 'MEDICAL_CARD', 'MVR', 'PSP_REPORT'].includes(f.file_type)).length;
          return '<tr><td><strong>' + d.first_name + ' ' + d.last_name + '</strong></td><td>' + getStatus('CDL') + '</td><td>' + getStatus('MEDICAL_CARD') + '</td><td>' + getStatus('MVR') + '</td><td>' + getStatus('PSP_REPORT') + '</td><td>' + otherCount + '</td><td class="sticky-col"><button class="action-btn view" onclick="viewDriverProfile(' + d.id + ')">Manage</button></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }
    
    // ========== TRUCK FILES TAB ==========
    function renderComplianceTruckFiles(c) {
      const today = new Date();
      
      c.innerHTML = '<div class="card"><div class="table-wrapper"><table><thead><tr><th>Truck</th><th>Registration</th><th>Annual Insp</th><th>PA Insp</th><th>IRP</th><th>Insurance</th><th>Actions</th></tr></thead><tbody>' +
        (appData.trucks.length === 0 ? '<tr><td colspan="7" style="text-align:center;padding:40px">No trucks</td></tr>' :
        appData.trucks.map(t => {
          const files = (appData.truck_files || []).filter(f => f.truck_id === t.id);
          const getStatus = (type) => {
            const file = files.find(f => f.file_type === type);
            if (!file) return '<span class="badge badge-gray">-</span>';
            if (!file.expiration_date) return '<span class="badge badge-green">âœ“</span>';
            const exp = new Date(file.expiration_date);
            const days = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
            if (days < 0) return '<span class="badge badge-red">Exp</span>';
            if (days <= 7) return '<span class="badge badge-amber">' + days + 'd</span>';
            return '<span class="badge badge-green">âœ“</span>';
          };
          return '<tr><td><strong>#' + t.truck_number + '</strong></td><td>' + getStatus('VEHICLE_REGISTRATION') + '</td><td>' + getStatus('ANNUAL_INSPECTION') + '</td><td>' + getStatus('PA_INSPECTION') + '</td><td>' + getStatus('IRP_CAB_CARD') + '</td><td>' + getStatus('INSURANCE_CARD') + '</td><td><button class="action-btn view" onclick="viewTruckCompliance(' + t.id + ')">Manage</button></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }
    
    // ========== DRIVER COMPLIANCE (TICKETS/VIOLATIONS/CLAIMS) ==========
    function renderComplianceDriverSection(c) {
      // Render the driver compliance content here (reuse from driver_compliance page)
      dcTab = dcTab || 'tickets';
      const tickets = appData.tickets || [];
      const violations = appData.violations || [];
      const claims = (appData.claims || []).filter(cl => cl.driver_id);
      
      c.innerHTML = '<div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap">' +
        '<button class="btn ' + (dcTab === 'tickets' ? 'btn-primary' : 'btn-secondary') + '" onclick="dcTab=\'tickets\';renderCompliance(document.getElementById(\'main-content\'))">ðŸŽ« Tickets (' + tickets.length + ')</button>' +
        '<button class="btn ' + (dcTab === 'violations' ? 'btn-primary' : 'btn-secondary') + '" style="' + (dcTab === 'violations' ? 'background:#8b5cf6;border-color:#8b5cf6' : '') + '" onclick="dcTab=\'violations\';renderCompliance(document.getElementById(\'main-content\'))">âš ï¸ Violations (' + violations.length + ')</button>' +
        '<button class="btn ' + (dcTab === 'claims' ? 'btn-primary' : 'btn-secondary') + '" style="' + (dcTab === 'claims' ? 'background:#f59e0b;border-color:#f59e0b' : '') + '" onclick="dcTab=\'claims\';renderCompliance(document.getElementById(\'main-content\'))">ðŸ’¥ Claims (' + claims.length + ')</button>' +
        '<div style="margin-left:auto;display:flex;gap:8px">' +
        '<button class="btn btn-primary btn-sm" onclick="openTicketModal()">+ Ticket</button>' +
        '<button class="btn btn-sm" style="background:#8b5cf6;border-color:#8b5cf6;color:white" onclick="openViolationModal()">+ Violation</button>' +
        '<button class="btn btn-sm" style="background:#f59e0b;border-color:#f59e0b;color:white" onclick="openClaimModal()">+ Claim</button>' +
        '</div></div>' +
        '<div id="dcSubContent"></div>';
      
      const subContent = document.getElementById('dcSubContent');
      if (dcTab === 'tickets') renderTicketsTab(subContent);
      else if (dcTab === 'violations') renderViolationsTab(subContent);
      else renderClaimsTab(subContent);
    }
    
    // ========== ACCIDENT REGISTRY ==========
    function renderAccidentRegistry(c) {
      const accidents = appData.accidents || [];
      
      c.innerHTML = '<div class="card"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center"><h3>ðŸš¨ Accident Registry</h3><button class="btn btn-primary" onclick="openAccidentModal()">+ Log Accident</button></div>' +
        '<div class="table-wrapper"><table><thead><tr><th>Date/Time</th><th>Driver</th><th>Type</th><th>Location</th><th>Deaths</th><th>Injuries</th><th>HAZMAT</th><th>Drug Test</th><th>Report</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        (accidents.length === 0 ? '<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-muted)">No accidents recorded âœ“</td></tr>' :
        accidents.sort((a, b) => (b.accident_date || '').localeCompare(a.accident_date || '')).map(a => {
          const driver = appData.drivers.find(d => d.id === a.driver_id);
          return '<tr>' +
            '<td>' + (a.accident_date ? formatDate(a.accident_date) : '-') + (a.accident_time ? '<br><span style="font-size:11px;color:var(--text-muted)">' + a.accident_time + '</span>' : '') + '</td>' +
            '<td><strong>' + (driver ? driver.first_name + ' ' + driver.last_name : '-') + '</strong></td>' +
            '<td><span class="badge badge-gray">' + (a.accident_type || '-') + '</span></td>' +
            '<td style="max-width:150px;font-size:12px">' + [a.street_address, a.city, a.state].filter(Boolean).join(', ') + '</td>' +
            '<td style="text-align:center;color:' + (a.num_deaths > 0 ? '#dc2626' : 'inherit') + '">' + (a.num_deaths || 0) + '</td>' +
            '<td style="text-align:center;color:' + (a.num_injuries > 0 ? '#f59e0b' : 'inherit') + '">' + (a.num_injuries || 0) + '</td>' +
            '<td>' + (a.hazmat_involved ? '<span class="badge badge-red">YES</span>' : '<span class="badge badge-gray">NO</span>') + '</td>' +
            '<td>' + getDrugTestBadge(a.drug_test_result) + '</td>' +
            '<td>' + (a.report_filed ? '<span class="badge badge-green">Filed</span>' : '<span class="badge badge-gray">-</span>') + '</td>' +
            '<td class="sticky-col"><div class="actions"><button class="action-btn edit" onclick="openAccidentModal(' + a.id + ')">Edit</button><button class="action-btn delete" onclick="deleteAccident(' + a.id + ')">Del</button></div></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }
    
    function getDrugTestBadge(result) {
      if (!result) return '<span class="badge badge-gray">N/A</span>';
      const badges = {
        'NEGATIVE': '<span class="badge badge-green">NEGATIVE</span>',
        'POSITIVE': '<span class="badge badge-red">POSITIVE</span>',
        'PENDING': '<span class="badge badge-amber">PENDING</span>',
        'NOT_REQUIRED': '<span class="badge badge-gray">Not Req</span>'
      };
      return badges[result] || '<span class="badge badge-gray">' + result + '</span>';
    }
    
    function openAccidentModal(id) {
      const a = id ? (appData.accidents || []).find(x => x.id === id) : null;
      const today = new Date().toISOString().split('T')[0];
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:650px"><div class="modal-header"><h3>ðŸš¨ ' + (a ? 'Edit' : 'Log') + ' Accident</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body" style="max-height:70vh;overflow-y:auto">' +
        
        '<div class="form-row"><div class="form-group"><label>Driver *</label><select id="accDriver"><option value="">Select Driver</option>' +
        appData.drivers.map(d => '<option value="' + d.id + '"' + (a?.driver_id === d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('') +
        '</select></div><div class="form-group"><label>Accident Type</label><select id="accType"><option value="">Select Type</option><option value="Collision"' + (a?.accident_type === 'Collision' ? ' selected' : '') + '>Collision</option><option value="Rollover"' + (a?.accident_type === 'Rollover' ? ' selected' : '') + '>Rollover</option><option value="Jackknife"' + (a?.accident_type === 'Jackknife' ? ' selected' : '') + '>Jackknife</option><option value="Cargo Spill"' + (a?.accident_type === 'Cargo Spill' ? ' selected' : '') + '>Cargo Spill</option><option value="Hit and Run"' + (a?.accident_type === 'Hit and Run' ? ' selected' : '') + '>Hit and Run</option><option value="Other"' + (a?.accident_type === 'Other' ? ' selected' : '') + '>Other</option></select></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Accident Date *</label><input type="date" id="accDate" value="' + (a?.accident_date || today) + '"></div><div class="form-group"><label>Time</label><input type="time" id="accTime" value="' + (a?.accident_time || '') + '"></div></div>' +
        
        '<h4 style="margin:16px 0 8px;padding-top:12px;border-top:1px solid var(--border)">ðŸ“ Location</h4>' +
        '<div class="form-group"><label>Street Address</label><input id="accStreet" value="' + (a?.street_address || '') + '" placeholder="123 Main St"></div>' +
        '<div class="form-row"><div class="form-group"><label>City</label><input id="accCity" value="' + (a?.city || '') + '"></div><div class="form-group"><label>State</label><input id="accState" value="' + (a?.state || '') + '" maxlength="2" placeholder="PA"></div></div>' +
        
        '<h4 style="margin:16px 0 8px;padding-top:12px;border-top:1px solid var(--border)">ðŸ“Š Incident Details</h4>' +
        '<div class="form-row"><div class="form-group"><label>No. of Deaths</label><input type="number" id="accDeaths" value="' + (a?.num_deaths || 0) + '" min="0"></div><div class="form-group"><label>No. of Injuries</label><input type="number" id="accInjuries" value="' + (a?.num_injuries || 0) + '" min="0"></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>HAZMAT Involved?</label><select id="accHazmat"><option value="false"' + (!a?.hazmat_involved ? ' selected' : '') + '>No</option><option value="true"' + (a?.hazmat_involved ? ' selected' : '') + '>Yes</option></select></div><div class="form-group"><label>Report Filed?</label><select id="accReport"><option value="false"' + (!a?.report_filed ? ' selected' : '') + '>No</option><option value="true"' + (a?.report_filed ? ' selected' : '') + '>Yes</option></select></div></div>' +
        
        '<div class="form-group"><label>Drug/Alcohol Test Result</label><select id="accDrug"><option value="">Select</option><option value="NOT_REQUIRED"' + (a?.drug_test_result === 'NOT_REQUIRED' ? ' selected' : '') + '>Not Required</option><option value="PENDING"' + (a?.drug_test_result === 'PENDING' ? ' selected' : '') + '>Pending</option><option value="NEGATIVE"' + (a?.drug_test_result === 'NEGATIVE' ? ' selected' : '') + '>Negative</option><option value="POSITIVE"' + (a?.drug_test_result === 'POSITIVE' ? ' selected' : '') + '>Positive</option></select></div>' +
        
        '<div class="form-group"><label>Notes</label><textarea id="accNotes" rows="2" placeholder="Additional details...">' + (a?.notes || '') + '</textarea></div>' +
        
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveAccident(' + (id || 'null') + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function saveAccident(id) {
      const driverId = parseInt(document.getElementById('accDriver').value);
      if (!driverId) { showToast('Please select a driver', 'error'); return; }
      
      const data = {
        driver_id: driverId,
        accident_type: document.getElementById('accType').value || null,
        accident_date: document.getElementById('accDate').value || null,
        accident_time: document.getElementById('accTime').value || null,
        street_address: document.getElementById('accStreet').value || null,
        city: document.getElementById('accCity').value || null,
        state: document.getElementById('accState').value || null,
        num_deaths: parseInt(document.getElementById('accDeaths').value) || 0,
        num_injuries: parseInt(document.getElementById('accInjuries').value) || 0,
        hazmat_involved: document.getElementById('accHazmat').value === 'true',
        report_filed: document.getElementById('accReport').value === 'true',
        drug_test_result: document.getElementById('accDrug').value || null,
        notes: document.getElementById('accNotes').value || null
      };
      
      try {
        if (id) { await dbUpdate('accidents', id, data); }
        else { await dbInsert('accidents', data); }
        document.querySelector('.modal-overlay').remove();
        showToast('Accident saved!');
        await loadAllData(true);
        renderCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    async function deleteAccident(id) {
      if (!confirm('Delete this accident record?')) return;
      try {
        await dbDelete('accidents', id);
        showToast('Deleted');
        await loadAllData(true);
        renderCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    function renderComplianceDrivers() {
      const today = new Date();
      return '<div class="table-wrapper"><table><thead><tr><th>Driver</th><th>CDL</th><th>Medical Card</th><th>MVR</th><th>PSP Report</th><th>Other Files</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        (appData.drivers.length === 0 ? '<tr><td colspan="7" style="text-align:center;padding:40px">No drivers yet</td></tr>' :
        appData.drivers.map(d => {
          const files = (appData.driver_files || []).filter(f => f.driver_id === d.id);
          const getStatus = (type) => {
            const file = files.find(f => f.file_type === type);
            if (!file) return '<span class="badge badge-gray">Missing</span>';
            if (!file.expiration_date) return '<span class="badge badge-green">âœ“</span>';
            const exp = new Date(file.expiration_date);
            const days = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
            if (days < 0) return '<span class="badge badge-red">Expired</span>';
            if (days <= 7) return '<span class="badge badge-amber">' + days + 'd</span>';
            return '<span class="badge badge-green">âœ“</span>';
          };
          const otherCount = files.filter(f => !['CDL', 'MEDICAL_CARD', 'MVR', 'PSP_REPORT'].includes(f.file_type)).length;
          return '<tr><td><strong>' + d.first_name + ' ' + d.last_name + '</strong></td><td>' + getStatus('CDL') + '</td><td>' + getStatus('MEDICAL_CARD') + '</td><td>' + getStatus('MVR') + '</td><td>' + getStatus('PSP_REPORT') + '</td><td>' + otherCount + ' files</td><td class="sticky-col"><button class="action-btn view" onclick="viewDriverProfile(' + d.id + ')">Manage</button></td></tr>';
        }).join('')) +
        '</tbody></table></div>';
    }

    function renderComplianceTrucks() {
      const today = new Date();
      return '<div class="table-wrapper"><table><thead><tr><th>Truck</th><th>Registration</th><th>Annual Inspection</th><th>PA Inspection</th><th>Actions</th></tr></thead><tbody>' +
        (appData.trucks.length === 0 ? '<tr><td colspan="5" style="text-align:center;padding:40px">No trucks yet</td></tr>' :
        appData.trucks.map(t => {
          const files = (appData.truck_files || []).filter(f => f.truck_id === t.id);
          const getStatus = (type) => {
            const file = files.find(f => f.file_type === type);
            if (!file) return '<span class="badge badge-gray">Missing</span>';
            if (!file.expiration_date) return '<span class="badge badge-green">âœ“</span>';
            const exp = new Date(file.expiration_date);
            const days = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
            if (days < 0) return '<span class="badge badge-red">Expired</span>';
            if (days <= 7) return '<span class="badge badge-amber">' + days + 'd</span>';
            return '<span class="badge badge-green">âœ“</span>';
          };
          return '<tr><td><strong>#' + t.truck_number + '</strong><br><span style="color:#64748b;font-size:12px">' + t.truck_type + '</span></td><td>' + getStatus('VEHICLE_REGISTRATION') + '</td><td>' + getStatus('ANNUAL_INSPECTION') + '</td><td>' + getStatus('PA_INSPECTION') + '</td><td><button class="action-btn view" onclick="viewTruckCompliance(' + t.id + ')">Manage</button></td></tr>';
        }).join('')) +
        '</tbody></table></div>';
    }

    function viewTruckCompliance(truckId) {
      // Mark that we're viewing a truck detail (prevents background re-renders)
      currentDetailView = { type: 'truck', id: truckId };
      
      const t = appData.trucks.find(x => x.id === truckId);
      const truckFiles = (appData.truck_files || []).filter(f => f.truck_id === truckId);
      const complianceFiles = truckFiles.filter(f => f.category !== 'CUSTOM');
      const customFiles = truckFiles.filter(f => f.category === 'CUSTOM');
      const customFolders = [...new Set(customFiles.map(f => f.folder_name || 'Uncategorized'))];
      const today = new Date();
      
      const truckFileTypes = [
        { type: 'VEHICLE_REGISTRATION', hasExpiry: true },
        { type: 'ANNUAL_INSPECTION', hasExpiry: true },
        { type: 'PA_INSPECTION', hasExpiry: true },
        { type: 'INSURANCE_CARD', hasExpiry: true },
        { type: 'TITLE', hasExpiry: false },
        { type: 'LEASE_AGREEMENT', hasExpiry: true },
        { type: 'IRP_CAB_CARD', hasExpiry: true },
        { type: 'IFTA_PERMIT', hasExpiry: true }
      ];
      
      const formatFileType = (t) => t.replace(/_/g, ' ');
      
      const getExpiryBadge = (file) => {
        if (!file || !file.expiration_date) return '';
        const expDate = new Date(file.expiration_date);
        const daysUntil = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
        if (daysUntil < 0) return '<span class="badge badge-red">EXPIRED</span>';
        if (daysUntil === 0) return '<span class="badge badge-red">EXPIRES TODAY</span>';
        if (daysUntil <= 3) return '<span class="badge badge-red">Expires in ' + daysUntil + 'd</span>';
        if (daysUntil <= 7) return '<span class="badge badge-amber">Expires in ' + daysUntil + 'd</span>';
        return '<span class="badge badge-green">Valid until ' + formatDate(file.expiration_date) + '</span>';
      };
      
      const c = document.getElementById('main-content');
      
      // Get maintenance records for this truck
      const maintenanceRecords = (appData.maintenance_records || []).filter(m => m.truck_id === truckId);
      const totalMaintenanceCost = maintenanceRecords.reduce((s, m) => s + parseFloat(m.total_cost || 0), 0);
      
      c.innerHTML = '<div class="header"><div style="display:flex;align-items:center;gap:16px"><button class="btn btn-secondary" onclick="renderCompliance(document.getElementById(\'main-content\'))">â† Back</button><h2>ðŸšš Truck #' + t.truck_number + ' Compliance Files</h2><span class="badge ' + getBadge(t.status) + '">' + t.status + '</span></div></div>' +
        
        // Stats
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px"><div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Truck Type</div><div class="value" style="font-size:14px">' + t.truck_type + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px"><div class="label">Capacity</div><div class="value">' + t.capacity + ' cars</div></div><div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Documents</div><div class="value">' + complianceFiles.length + '/' + truckFileTypes.length + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:130px;padding:12px 16px"><div class="label">Maintenance Records</div><div class="value">' + maintenanceRecords.length + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:140px;padding:12px 16px;background:#fee2e2"><div class="label">Total Maintenance Cost</div><div class="value" style="color:#dc2626">' + formatMoney(totalMaintenanceCost) + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px;background:#dbeafe"><div class="label">Custom Folders</div><div class="value" style="color:#1d4ed8">' + customFolders.length + '</div></div></div>' +
        
        // Truck Files Section
        '<div class="card" style="margin-bottom:24px"><div class="card-header" style="background:#f59e0b;color:white;border-radius:8px 8px 0 0"><h3 style="margin:0">ðŸ“ Truck Compliance Files</h3></div><div class="table-wrapper"><table><thead><tr><th>Document Type</th><th>Status</th><th>Expiration</th><th>Uploaded</th><th>Actions</th></tr></thead><tbody>' +
        truckFileTypes.map(ft => {
          const file = complianceFiles.find(f => f.file_type === ft.type);
          return '<tr><td><strong>' + formatFileType(ft.type) + '</strong></td><td>' + (file ? '<span class="badge badge-green">âœ“ Uploaded</span>' : '<span class="badge badge-gray">Missing</span>') + '</td><td>' + (ft.hasExpiry ? (file ? getExpiryBadge(file) : '<span style="color:#64748b">-</span>') : '<span style="color:#64748b">N/A</span>') + '</td><td>' + (file ? formatDate(file.created_at) : '-') + '</td><td><div class="actions">' + (file ? '<button class="action-btn view" onclick="viewTruckFile(' + file.id + ')">View</button><button class="action-btn delete" onclick="deleteTruckFile(' + file.id + ',' + truckId + ')">Del</button>' : '<button class="action-btn edit" onclick="openUploadTruckFileModal(' + truckId + ',\'' + ft.type + '\',' + ft.hasExpiry + ')">Upload</button>') + '</div></td></tr>';
        }).join('') +
        '</tbody></table></div></div>' +
        
        // Custom Folders Section
        '<div class="card" style="margin-bottom:24px"><div class="card-header" style="background:#0891b2;color:white;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0">ðŸ“‚ Custom Folders</h3><button class="btn" style="background:white;color:#0891b2;padding:6px 12px;font-size:13px" onclick="openCustomFolderModal(' + truckId + ',\'truck\')">+ New Folder</button></div>' +
        (customFolders.length === 0 ? '<div style="padding:40px;text-align:center;color:#64748b">No custom folders yet. Click "+ New Folder" to create one.</div>' :
        '<div style="padding:16px">' +
        customFolders.map(folder => {
          const folderFiles = customFiles.filter(f => (f.folder_name || 'Uncategorized') === folder);
          return '<div style="margin-bottom:16px;border:1px solid #e5e7eb;border-radius:8px"><div style="background:#f0f9ff;padding:12px 16px;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center"><strong>ðŸ“ ' + folder + ' (' + folderFiles.length + ' files)</strong><button class="action-btn edit" onclick="openCustomFileUpload(' + truckId + ',\'' + folder.replace(/'/g, "\\'") + '\',\'truck\')">+ Add File</button></div>' +
            '<div class="table-wrapper"><table><thead><tr><th>File Name</th><th>Type</th><th>Uploaded</th><th>Notes</th><th>Actions</th></tr></thead><tbody>' +
            folderFiles.map(f => '<tr><td>' + f.file_name + '</td><td>' + (f.file_type || '-') + '</td><td>' + formatDate(f.created_at) + '</td><td>' + (f.notes || '-') + '</td><td><div class="actions"><button class="action-btn view" onclick="viewTruckFile(' + f.id + ')">View</button><button class="action-btn delete" onclick="deleteTruckFile(' + f.id + ',' + truckId + ')">Del</button></div></td></tr>').join('') +
            '</tbody></table></div></div>';
        }).join('') +
        '</div>') +
        '</div>' +
        
        // Maintenance Records Section
        '<div class="card"><div class="card-header" style="background:#059669;color:white;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0">ðŸ”§ Maintenance Records</h3><button class="btn" style="background:white;color:#059669;padding:8px 16px" onclick="openMaintenanceModal(' + truckId + ')">+ Add Service Record</button></div>' +
        (maintenanceRecords.length === 0 ? '<div style="padding:40px;text-align:center;color:#64748b">No maintenance records yet. Add a service record or upload an invoice.</div>' :
        '<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Service Type</th><th>Shop</th><th>Description</th><th>Odometer</th><th>Cost</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        maintenanceRecords.map(m => '<tr><td>' + formatDate(m.service_date) + '</td><td><span class="badge badge-blue">' + (m.service_type || '-') + '</span></td><td>' + (m.shop_name || '-') + '</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + (m.description || '-') + '</td><td>' + (m.odometer ? m.odometer.toLocaleString() + ' mi' : '-') + '</td><td class="money">' + formatMoney(m.total_cost) + '</td><td class="sticky-col"><div class="actions">' + (m.invoice_file ? '<button class="action-btn view" onclick="viewMaintenanceInvoice(' + m.id + ')">Invoice</button>' : '') + '<button class="action-btn edit" onclick="openMaintenanceModal(' + truckId + ',' + m.id + ')">Edit</button><button class="action-btn delete" onclick="deleteMaintenanceRecord(' + m.id + ',' + truckId + ')">Del</button></div></td></tr>').join('') +
        '</tbody></table></div>') +
        '</div>';
    }

    function openUploadTruckFileModal(truckId, fileType, hasExpiry) {
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:450px"><div class="modal-header"><h3>ðŸ“¤ Upload ' + fileType.replace(/_/g, ' ') + '</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body">' +
        '<div class="form-group"><label>File (PDF, Image, etc.)</label><input type="file" id="truckFileUpload" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"></div>' +
        '<div class="form-group"><label>Notes (Optional)</label><input id="truckFileNotes" placeholder="Any additional notes..."></div>' +
        (hasExpiry ? '<div class="form-group"><label>Expiration Date</label><input type="date" id="truckFileExpiry"></div><div style="background:#fef3c7;padding:12px;border-radius:8px;font-size:13px;color:#92400e">âš ï¸ You will receive reminders at 7 days, 3 days, 1 day, and on expiration date.</div>' : '') +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="uploadTruckFile(' + truckId + ',\'' + fileType + '\',' + hasExpiry + ')">Upload</button></div></div>';
      document.body.appendChild(m);
    }

    async function uploadTruckFile(truckId, fileType, hasExpiry) {
      const fileInput = document.getElementById('truckFileUpload');
      const notes = document.getElementById('truckFileNotes').value;
      const expiry = hasExpiry ? document.getElementById('truckFileExpiry').value : null;
      
      if (!fileInput.files || fileInput.files.length === 0) {
        showToast('Please select a file', 'error');
        return;
      }
      
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      reader.onload = async function(e) {
        const fileData = e.target.result;
        
        const data = {
          truck_id: truckId,
          file_type: fileType,
          file_name: file.name,
          file_data: fileData,
          notes: notes || null,
          expiration_date: expiry || null
        };
        
        try {
          await dbInsert('truck_files', data);
          document.querySelector('.modal-overlay').remove();
          showToast('File uploaded successfully!');
          await loadAllData();
          viewTruckCompliance(truckId);
        } catch (e) {
          showToast('Upload failed: ' + e.message, 'error');
        }
      };
      
      reader.readAsDataURL(file);
    }

    function viewTruckFile(fileId) {
      const file = appData.truck_files.find(f => f.id === fileId);
      if (!file || !file.file_data) {
        showToast('File not found', 'error');
        return;
      }
      
      const win = window.open();
      if (file.file_data.startsWith('data:application/pdf') || file.file_data.startsWith('data:image')) {
        win.document.write('<iframe src="' + file.file_data + '" style="width:100%;height:100%;border:none"></iframe>');
      } else {
        win.document.write('<html><body><h2>' + file.file_name + '</h2><p>File type: ' + file.file_type.replace(/_/g, ' ') + '</p><p>Notes: ' + (file.notes || 'None') + '</p><a href="' + file.file_data + '" download="' + file.file_name + '">Download File</a></body></html>');
      }
    }

    async function deleteTruckFile(fileId, truckId) {
      if (!confirm('Delete this file?')) return;
      try {
        await dbDelete('truck_files', fileId);
        showToast('File deleted');
        await loadAllData();
        viewTruckCompliance(truckId);
      } catch (e) {
        showToast('Delete failed: ' + e.message, 'error');
      }
    }

    // ============ MAINTENANCE RECORDS ============
    const maintenanceServiceTypes = [
      'Oil & Filter Change',
      'Air Filter Change',
      'Fuel Filter Change',
      'Transmission Fluid & Filter',
      'Engine Coolant',
      'Cooling System Flush',
      'Tire Repair or Replacement',
      'Tire',
      'Rotation or Balance',
      'Hose',
      'Replacement',
      'Brake Repair',
      'Engine',
      'Tune-Up',
      'Front End Alignment',
      'Power Steering / Brake Fluid',
      'A/C or Heater Repair',
      'Replace Belts',
      'Electrical Repairs',
      'Battery Replacement',
      'Battery Cables / Terminals',
      'Headlights or Light Bulbs',
      'Windshield Wiper Blades',
      'Wash & Wax',
      'Miscellaneous Service',
      'DOT Inspection',
      'Annual Inspection',
      'Trailer Repair',
      'Suspension',
      'Exhaust System',
      'DEF System',
      'EGR/DPF Service'
    ];

    function openMaintenanceModal(truckId, recordId = null) {
      const record = recordId ? appData.maintenance_records.find(m => m.id === recordId) : null;
      if (!truckId && record) truckId = record.truck_id;
      const hasApiKey = !!getApiKey();
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      
      const truckSelector = !truckId ? '<div class="form-group"><label>Truck *</label><select id="maintTruckSelect"><option value="">Select Truck</option>' + appData.trucks.map(t => '<option value="' + t.id + '">' + t.truck_number + '</option>').join('') + '</select></div>' : '';
      
      m.innerHTML = '<div class="modal" style="max-width:550px;max-height:90vh;overflow-y:auto"><div class="modal-header"><h3>ðŸ”§ ' + (record ? 'Edit' : 'Add') + ' Maintenance Record</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body">' +
        
        // Upload Invoice Section
        '<div style="background:#dbeafe;padding:16px;border-radius:8px;margin-bottom:16px"><strong style="color:#1d4ed8">ðŸ“¤ ' + (hasApiKey ? 'Upload Invoice to Auto-Fill' : 'Attach Invoice') + '</strong><p style="font-size:13px;color:#1e40af;margin:8px 0 12px 0">' + (hasApiKey ? 'Upload shop invoice (PDF or image) and AI will extract the details' : 'Upload shop invoice to keep on record') + '</p><input type="file" id="maintenanceInvoice" accept=".pdf,.jpg,.jpeg,.png"><div id="invoicePreview" style="margin-top:8px"></div>' + (hasApiKey ? '<button type="button" id="extractBtn" class="btn btn-primary" style="display:none;margin-top:12px;background:#059669" onclick="extractInvoiceData(' + (truckId || 'null') + ')">ðŸ¤– Extract Invoice Data</button>' : '') + '</div>' +
        
        '<div id="extractingStatus" style="display:none;background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:16px;text-align:center"><span style="color:#92400e">â³ Reading invoice... Please wait...</span></div>' +
        
        truckSelector +
        
        '<div class="form-row"><div class="form-group"><label>Service Date *</label><input type="date" id="maintDate" value="' + (record?.service_date || new Date().toISOString().split('T')[0]) + '"></div><div class="form-group"><label>Odometer</label><input type="number" id="maintOdometer" value="' + (record?.odometer || '') + '" placeholder="e.g., 125000"></div></div>' +
        
        '<div class="form-group"><label>Service Type *</label><select id="maintType"><option value="">Select Service Type</option>' + maintenanceServiceTypes.map(st => '<option value="' + st + '"' + (record?.service_type === st ? ' selected' : '') + '>' + st + '</option>').join('') + '</select></div>' +
        
        '<div class="form-group"><label>Shop Name</label><input id="maintShop" value="' + (record?.shop_name || '') + '" placeholder="e.g., Love\'s Truck Care"></div>' +
        
        '<div class="form-group"><label>Description / Work Performed</label><textarea id="maintDesc" rows="5" placeholder="Detailed list of all services performed, parts replaced, work done...">' + (record?.description || '') + '</textarea></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Parts Cost</label><input type="number" step="0.01" id="maintParts" value="' + (record?.parts_cost || '') + '" placeholder="0.00"></div><div class="form-group"><label>Labor Cost</label><input type="number" step="0.01" id="maintLabor" value="' + (record?.labor_cost || '') + '" placeholder="0.00"></div><div class="form-group"><label>Total Cost *</label><input type="number" step="0.01" id="maintTotal" value="' + (record?.total_cost || '') + '" placeholder="0.00"></div></div>' +
        
        '<div class="form-group"><label>Notes</label><input id="maintNotes" value="' + (record?.notes || '') + '" placeholder="Any additional notes..."></div>' +
        
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveMaintenanceRecord(' + (truckId || 'null') + ',' + recordId + ')">Save</button></div></div>';
      
      document.body.appendChild(m);
      
      // Show file name and extract button when selected
      document.getElementById('maintenanceInvoice').addEventListener('change', function() {
        const preview = document.getElementById('invoicePreview');
        const extractBtn = document.getElementById('extractBtn');
        this.dataset.aiScanned = 'false'; // Reset scan status
        if (this.files && this.files[0]) {
          preview.innerHTML = '<span style="color:#059669">âœ“ ' + this.files[0].name + ' selected</span><br><span style="font-size:11px;color:#64748b">ðŸ“Ž Invoice will be saved with record</span>';
          if (extractBtn) extractBtn.style.display = 'inline-block';
        } else {
          preview.innerHTML = '';
          if (extractBtn) extractBtn.style.display = 'none';
        }
      });
      
      // Auto-calculate total when parts/labor change
      document.getElementById('maintParts').addEventListener('input', calcMaintenanceTotal);
      document.getElementById('maintLabor').addEventListener('input', calcMaintenanceTotal);
    }

    async function extractInvoiceData(truckId) {
      const fileInput = document.getElementById('maintenanceInvoice');
      const apiKey = getApiKey();
      
      if (!apiKey) {
        showToast('API key not configured. Go to Settings.', 'error');
        return;
      }
      
      if (!fileInput.files || !fileInput.files[0]) {
        showToast('Please select an invoice file first', 'error');
        return;
      }
      
      const file = fileInput.files[0];
      const statusDiv = document.getElementById('extractingStatus');
      const extractBtn = document.getElementById('extractBtn');
      
      // Show loading
      statusDiv.style.display = 'block';
      extractBtn.disabled = true;
      extractBtn.textContent = 'â³ Extracting...';
      
      try {
        // Convert file to base64
        const base64Data = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = () => reject(new Error('Failed to read file'));
          reader.readAsDataURL(file);
        });
        
        // Determine media type
        let mediaType = 'image/jpeg';
        if (file.type === 'image/png') {
          mediaType = 'image/png';
        } else if (file.type === 'image/jpeg' || file.type === 'image/jpg') {
          mediaType = 'image/jpeg';
        } else if (file.type === 'application/pdf') {
          mediaType = 'application/pdf';
        }
        
        // Build content array
        const content = [];
        if (mediaType === 'application/pdf') {
          content.push({
            type: 'document',
            source: { type: 'base64', media_type: mediaType, data: base64Data }
          });
        } else {
          content.push({
            type: 'image',
            source: { type: 'base64', media_type: mediaType, data: base64Data }
          });
        }
        content.push({
          type: 'text',
          text: 'Extract ALL information from this truck/vehicle repair invoice. Return ONLY valid JSON (no markdown):\n\n{"truck_number":"string - look for Unit #, Truck #, Vehicle #, Equipment #, or any identifying number","shop_name":"string - the repair shop/service center name","service_date":"YYYY-MM-DD - invoice date or service date","odometer":number|null - mileage/odometer reading,"service_type":"string - main category of service","services_performed":"string - LIST ALL individual services, parts, and work items performed (be detailed, include everything listed)","description":"string - brief summary","parts_cost":number|null,"labor_cost":number|null,"total_cost":number - grand total}\n\nFor service_type use the BEST match from: Oil & Filter Change, Brake Repair, Tire Repair or Replacement, Engine, Transmission Fluid & Filter, Electrical Repairs, DOT Inspection, Annual Inspection, Suspension, A/C or Heater Repair, Trailer Repair, DEF System, EGR/DPF Service, Miscellaneous Service\n\nIMPORTANT: For services_performed, list EVERY line item of work done, parts replaced, and services rendered. Be thorough.'
        });
        
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1000,
            messages: [{ role: 'user', content: content }]
          })
        });
        
        const data = await response.json();
        console.log('API Response:', data);
        
        if (data.error) {
          throw new Error(data.error.message || 'API Error');
        }
        
        if (data.content && data.content[0] && data.content[0].text) {
          let jsonText = data.content[0].text.trim();
          jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
          
          const extracted = JSON.parse(jsonText);
          console.log('Extracted data:', extracted);
          
          // Fill in the form fields
          if (extracted.shop_name) document.getElementById('maintShop').value = extracted.shop_name;
          if (extracted.service_date) document.getElementById('maintDate').value = extracted.service_date;
          if (extracted.odometer) document.getElementById('maintOdometer').value = extracted.odometer;
          
          // Use detailed services_performed if available, otherwise use description
          const detailedDesc = extracted.services_performed || extracted.description || '';
          document.getElementById('maintDesc').value = detailedDesc;
          
          if (extracted.parts_cost) document.getElementById('maintParts').value = parseFloat(extracted.parts_cost).toFixed(2);
          if (extracted.labor_cost) document.getElementById('maintLabor').value = parseFloat(extracted.labor_cost).toFixed(2);
          if (extracted.total_cost) document.getElementById('maintTotal').value = parseFloat(extracted.total_cost).toFixed(2);
          
          // Try to match truck number from invoice to trucks in system
          if (extracted.truck_number) {
            const truckSelect = document.getElementById('maintTruckSelect');
            if (truckSelect) {
              const invoiceTruckNum = extracted.truck_number.toString().replace(/[^0-9]/g, '');
              let matched = false;
              for (let i = 0; i < truckSelect.options.length; i++) {
                const optVal = truckSelect.options[i].text.replace(/[^0-9]/g, '');
                if (optVal && invoiceTruckNum && (optVal === invoiceTruckNum || optVal.includes(invoiceTruckNum) || invoiceTruckNum.includes(optVal))) {
                  truckSelect.selectedIndex = i;
                  matched = true;
                  break;
                }
              }
              if (matched) {
                showToast('âœ“ Matched truck #' + extracted.truck_number + ' from invoice!');
              } else {
                showToast('âš ï¸ Truck #' + extracted.truck_number + ' found on invoice - please select manually', 'error');
              }
            }
          }
          
          // Match service type
          if (extracted.service_type) {
            const typeSelect = document.getElementById('maintType');
            const searchType = extracted.service_type.toLowerCase();
            for (let i = 0; i < typeSelect.options.length; i++) {
              const optVal = typeSelect.options[i].value.toLowerCase();
              if (optVal === searchType || optVal.includes(searchType) || searchType.includes(optVal)) {
                typeSelect.selectedIndex = i;
                break;
              }
            }
          }
          
          // Mark invoice as scanned - it will be auto-saved with the record
          fileInput.dataset.aiScanned = 'true';
          
          // Update preview to show it will be saved
          const preview = document.getElementById('invoicePreview');
          preview.innerHTML = '<span style="color:#059669">âœ“ ' + file.name + '</span><br><span style="font-size:11px;color:#047857;background:#d1fae5;padding:2px 8px;border-radius:4px;margin-top:4px;display:inline-block">ðŸ“Ž Invoice will be saved with record</span>';
          
          showToast('âœ“ Invoice data extracted! Invoice will be saved automatically.');
        } else {
          throw new Error('Could not extract data from response');
        }
        
      } catch (error) {
        console.error('Extract error:', error);
        showToast('Could not read invoice: ' + error.message, 'error');
      } finally {
        statusDiv.style.display = 'none';
        extractBtn.disabled = false;
        extractBtn.textContent = 'ðŸ¤– Extract Invoice Data';
      }
    }

    function calcMaintenanceTotal() {
      const parts = parseFloat(document.getElementById('maintParts').value) || 0;
      const labor = parseFloat(document.getElementById('maintLabor').value) || 0;
      const totalInput = document.getElementById('maintTotal');
      // Only auto-calculate if total is empty or was auto-calculated before
      if (!totalInput.value || totalInput.dataset.autoCalc === 'true') {
        totalInput.value = (parts + labor).toFixed(2);
        totalInput.dataset.autoCalc = 'true';
      }
    }
    
    // Mark total as manually entered when user types
    document.addEventListener('input', function(e) {
      if (e.target && e.target.id === 'maintTotal') {
        e.target.dataset.autoCalc = 'false';
      }
    });

    async function saveMaintenanceRecord(truckId, recordId) {
      if (!truckId) {
        const truckSelect = document.getElementById('maintTruckSelect');
        if (truckSelect) {
          truckId = parseInt(truckSelect.value);
          if (!truckId) { showToast('Please select a truck', 'error'); return; }
        }
      }
      
      const serviceDate = document.getElementById('maintDate').value;
      const serviceType = document.getElementById('maintType').value;
      const totalCost = parseFloat(document.getElementById('maintTotal').value) || 0;
      
      if (!serviceDate) { showToast('Please enter service date', 'error'); return; }
      if (!serviceType) { showToast('Please select service type', 'error'); return; }
      if (!totalCost) { showToast('Please enter total cost', 'error'); return; }
      
      const data = {
        truck_id: truckId,
        service_date: serviceDate,
        service_type: serviceType,
        shop_name: document.getElementById('maintShop').value || null,
        description: document.getElementById('maintDesc').value || null,
        odometer: parseInt(document.getElementById('maintOdometer').value) || null,
        parts_cost: parseFloat(document.getElementById('maintParts').value) || 0,
        labor_cost: parseFloat(document.getElementById('maintLabor').value) || 0,
        total_cost: totalCost,
        notes: document.getElementById('maintNotes').value || null
      };
      
      // Handle invoice file upload
      const invoiceInput = document.getElementById('maintenanceInvoice');
      if (invoiceInput.files && invoiceInput.files[0]) {
        const file = invoiceInput.files[0];
        const reader = new FileReader();
        
        reader.onload = async function(e) {
          data.invoice_file = e.target.result;
          data.invoice_filename = file.name;
          await doSaveMaintenanceRecord(truckId, recordId, data);
        };
        reader.readAsDataURL(file);
      } else {
        await doSaveMaintenanceRecord(truckId, recordId, data);
      }
    }

    async function doSaveMaintenanceRecord(truckId, recordId, data) {
      try {
        const hasInvoice = !!data.invoice_file;
        const truck = appData.trucks.find(t => t.id === truckId);
        if (recordId) {
          await dbUpdate('maintenance_records', recordId, data);
          await logActivity('MAINTENANCE_UPDATED', { record_id: recordId, truck_id: truckId, truck_number: truck?.truck_number, service_type: data.service_type, total_cost: data.total_cost });
        } else {
          const newRecord = await dbInsert('maintenance_records', data);
          await logActivity('MAINTENANCE_CREATED', { record_id: newRecord.id, truck_id: truckId, truck_number: truck?.truck_number, service_type: data.service_type, total_cost: data.total_cost, shop: data.shop_name });
        }
        document.querySelector('.modal-overlay').remove();
        showToast(hasInvoice ? 'âœ“ Maintenance record saved with invoice!' : 'Maintenance record saved!');
        await loadAllData();
        // Stay on current page - if on maintenance page, refresh it; otherwise go to truck compliance
        if (currentPage === 'maintenance') {
          renderMaintenance(document.getElementById('main-content'));
        } else if (truckId && typeof viewTruckCompliance === 'function') {
          viewTruckCompliance(truckId);
        }
      } catch (e) {
        showToast('Save failed: ' + e.message, 'error');
      }
    }

    function viewMaintenanceInvoice(recordId) {
      const record = appData.maintenance_records.find(m => m.id === recordId);
      if (!record || !record.invoice_file) {
        showToast('Invoice not found', 'error');
        return;
      }
      
      const win = window.open();
      if (record.invoice_file.startsWith('data:application/pdf') || record.invoice_file.startsWith('data:image')) {
        win.document.write('<iframe src="' + record.invoice_file + '" style="width:100%;height:100%;border:none"></iframe>');
      } else {
        win.document.write('<html><body><h2>' + (record.invoice_filename || 'Invoice') + '</h2><a href="' + record.invoice_file + '" download="' + (record.invoice_filename || 'invoice') + '">Download File</a></body></html>');
      }
    }

    async function deleteMaintenanceRecord(recordId, truckId) {
      if (!confirm('Delete this maintenance record?')) return;
      try {
        const record = appData.maintenance_records.find(m => m.id === recordId);
        const truck = appData.trucks.find(t => t.id === truckId);
        await dbDelete('maintenance_records', recordId);
        await logActivity('MAINTENANCE_DELETED', { record_id: recordId, truck_id: truckId, truck_number: truck?.truck_number, service_type: record?.service_type, total_cost: record?.total_cost });
        showToast('Record deleted');
        await loadAllData();
        if (truckId && typeof viewTruckCompliance === 'function') {
          viewTruckCompliance(truckId);
        } else if (currentPage === 'maintenance') {
          renderMaintenance(document.getElementById('main-content'));
        }
      } catch (e) {
        showToast('Delete failed: ' + e.message, 'error');
      }
    }

    // ============ DRIVER COMPLIANCE (TICKETS, VIOLATIONS & CLAIMS) ============
    let dcTab = 'tickets'; // 'tickets', 'violations', or 'claims'
    let dcFilterStatus = '';
    let dcFilterDriver = '';
    
    function renderDriverCompliance(c) {
      const tickets = appData.tickets || [];
      const violations = appData.violations || [];
      const claims = (appData.claims || []).filter(cl => cl.driver_id); // Only driver-assigned claims
      const today = new Date().toISOString().split('T')[0];
      
      // Combined stats
      const openTickets = tickets.filter(t => ['OPEN', 'IN_PROGRESS', 'ATTORNEY_HIRED', 'PENDING_COURT', 'PENDING_DATAQ'].includes(t.status)).length;
      const openViolations = violations.filter(v => ['OPEN', 'IN_PROGRESS', 'PENDING_REVIEW'].includes(v.status)).length;
      const openClaims = claims.filter(cl => ['OPEN', 'UNDER_REVIEW'].includes(cl.status)).length;
      const resolvedTickets = tickets.filter(t => ['RESOLVED', 'DISMISSED'].includes(t.status)).length;
      const resolvedViolations = violations.filter(v => ['RESOLVED', 'DISMISSED'].includes(v.status)).length;
      
      // Financial impact of claims
      const totalClaimsPaid = claims.filter(cl => cl.status === 'SETTLED' && cl.fault_party === 'DRIVER')
        .reduce((s, cl) => s + parseFloat(cl.settlement_amount || cl.claim_amount || 0), 0);
      
      // Upcoming court dates
      const upcomingCourt = tickets.filter(t => t.court_date && t.court_date >= today && !['RESOLVED', 'DISMISSED'].includes(t.status))
        .sort((a, b) => a.court_date.localeCompare(b.court_date));
      
      c.innerHTML = '<div class="header"><h2>ðŸŽ« Driver Compliance</h2><div style="display:flex;gap:12px;flex-wrap:wrap">' +
        '<button class="btn btn-primary" onclick="openTicketModal()">+ Ticket</button>' +
        '<button class="btn btn-secondary" style="background:#8b5cf6;border-color:#8b5cf6;color:white" onclick="openViolationModal()">+ Violation</button>' +
        '<button class="btn btn-secondary" style="background:#f59e0b;border-color:#f59e0b;color:white" onclick="openClaimModal()">+ Claim</button>' +
        '</div></div>' +
        
        // Stats
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="border-left:4px solid #ef4444"><div class="label">Open Tickets</div><div class="value" style="color:#ef4444">' + openTickets + '</div></div>' +
        '<div class="stat-card" style="border-left:4px solid #8b5cf6"><div class="label">Open Violations</div><div class="value" style="color:#8b5cf6">' + openViolations + '</div></div>' +
        '<div class="stat-card" style="border-left:4px solid #f59e0b"><div class="label">Open Claims</div><div class="value" style="color:#f59e0b">' + openClaims + '</div></div>' +
        '<div class="stat-card" style="border-left:4px solid #22c55e"><div class="label">Resolved</div><div class="value" style="color:#22c55e">' + (resolvedTickets + resolvedViolations) + '</div></div>' +
        (totalClaimsPaid > 0 ? '<div class="stat-card" style="border-left:4px solid #dc2626;background:#fee2e2"><div class="label">Driver Claims Paid</div><div class="value" style="color:#dc2626">' + formatMoney(totalClaimsPaid) + '</div></div>' : '') +
        '</div>' +
        
        // Upcoming Court Dates Alert
        (upcomingCourt.length > 0 ? '<div class="card" style="margin-bottom:24px;background:linear-gradient(135deg,#fef3c7,#fde68a);border:1px solid #f59e0b"><div class="card-header" style="background:transparent"><h3 style="color:#92400e">âš ï¸ Upcoming Court Dates</h3></div><div style="padding:16px">' +
        upcomingCourt.slice(0, 5).map(t => {
          const driver = appData.drivers.find(d => d.id === t.driver_id);
          const driverName = driver ? driver.first_name + ' ' + driver.last_name : 'Unknown';
          const daysUntil = Math.ceil((new Date(t.court_date) - new Date(today)) / (1000 * 60 * 60 * 24));
          return '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:white;border-radius:8px;margin-bottom:8px">' +
            '<div><strong>' + driverName + '</strong><div style="font-size:12px;color:#64748b">' + (t.ticket_description || 'No description') + '</div></div>' +
            '<div style="text-align:right"><div style="font-weight:600;color:' + (daysUntil <= 3 ? '#dc2626' : daysUntil <= 7 ? '#d97706' : '#059669') + '">' + formatDate(t.court_date) + '</div>' +
            '<div style="font-size:12px;color:#64748b">' + (daysUntil === 0 ? 'TODAY!' : daysUntil === 1 ? 'Tomorrow' : daysUntil + ' days') + '</div></div></div>';
        }).join('') + '</div></div>' : '') +
        
        // Tabs
        '<div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap">' +
        '<button class="btn ' + (dcTab === 'tickets' ? 'btn-primary' : 'btn-secondary') + '" onclick="dcTab=\'tickets\';renderDriverCompliance(document.getElementById(\'main-content\'))">ðŸŽ« Tickets (' + tickets.length + ')</button>' +
        '<button class="btn ' + (dcTab === 'violations' ? 'btn-primary' : 'btn-secondary') + '" style="' + (dcTab === 'violations' ? 'background:#8b5cf6;border-color:#8b5cf6' : '') + '" onclick="dcTab=\'violations\';renderDriverCompliance(document.getElementById(\'main-content\'))">âš ï¸ Violations (' + violations.length + ')</button>' +
        '<button class="btn ' + (dcTab === 'claims' ? 'btn-primary' : 'btn-secondary') + '" style="' + (dcTab === 'claims' ? 'background:#f59e0b;border-color:#f59e0b' : '') + '" onclick="dcTab=\'claims\';renderDriverCompliance(document.getElementById(\'main-content\'))">ðŸ’¥ Claims (' + claims.length + ')</button>' +
        '</div>' +
        
        '<div id="dcTabContent"></div>';
      
      const tabContent = document.getElementById('dcTabContent');
      if (dcTab === 'tickets') renderTicketsTab(tabContent);
      else if (dcTab === 'violations') renderViolationsTab(tabContent);
      else renderClaimsTab(tabContent);
    }
    
    function renderTicketsTab(c) {
      const tickets = appData.tickets || [];
      let filtered = tickets;
      if (dcFilterStatus) filtered = filtered.filter(t => t.status === dcFilterStatus);
      if (dcFilterDriver) filtered = filtered.filter(t => t.driver_id == dcFilterDriver);
      
      c.innerHTML = '<div class="card" style="padding:16px;margin-bottom:20px"><div style="display:flex;gap:16px;align-items:end;flex-wrap:wrap">' +
        '<div class="form-group" style="margin:0;min-width:150px"><label style="margin-bottom:4px">Status</label><select onchange="dcFilterStatus=this.value;renderDriverCompliance(document.getElementById(\'main-content\'))">' +
        '<option value="">All Statuses</option>' +
        '<option value="OPEN"' + (dcFilterStatus === 'OPEN' ? ' selected' : '') + '>Open</option>' +
        '<option value="IN_PROGRESS"' + (dcFilterStatus === 'IN_PROGRESS' ? ' selected' : '') + '>In Progress</option>' +
        '<option value="ATTORNEY_HIRED"' + (dcFilterStatus === 'ATTORNEY_HIRED' ? ' selected' : '') + '>Attorney Hired</option>' +
        '<option value="PENDING_COURT"' + (dcFilterStatus === 'PENDING_COURT' ? ' selected' : '') + '>Pending Court</option>' +
        '<option value="PENDING_DATAQ"' + (dcFilterStatus === 'PENDING_DATAQ' ? ' selected' : '') + '>Pending DataQ</option>' +
        '<option value="RESOLVED"' + (dcFilterStatus === 'RESOLVED' ? ' selected' : '') + '>Resolved</option>' +
        '<option value="DISMISSED"' + (dcFilterStatus === 'DISMISSED' ? ' selected' : '') + '>Dismissed</option>' +
        '</select></div>' +
        '<div class="form-group" style="margin:0;min-width:150px"><label style="margin-bottom:4px">Driver</label><select onchange="dcFilterDriver=this.value;renderDriverCompliance(document.getElementById(\'main-content\'))">' +
        '<option value="">All Drivers</option>' +
        appData.drivers.map(d => '<option value="' + d.id + '"' + (dcFilterDriver == d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('') +
        '</select></div>' +
        ((dcFilterStatus || dcFilterDriver) ? '<button class="btn btn-secondary" onclick="dcFilterStatus=\'\';dcFilterDriver=\'\';renderDriverCompliance(document.getElementById(\'main-content\'))">âœ• Clear</button>' : '') +
        '<div style="margin-left:auto;font-size:13px;color:var(--text-muted)">' + filtered.length + ' of ' + tickets.length + ' tickets</div>' +
        '</div></div>' +
        
        '<div class="card"><div class="card-header"><h3>ðŸŽ« Tickets</h3></div><div class="table-wrapper"><table><thead><tr>' +
        '<th>Driver</th><th>Date</th><th>Description</th><th>Status</th><th>Court Date</th><th>Attorney</th><th>Court Decision</th><th>DataQ</th><th>Files</th><th class="sticky-col">Actions</th>' +
        '</tr></thead><tbody>' +
        (filtered.length === 0 ? '<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-muted)">No tickets found</td></tr>' :
        filtered.sort((a, b) => (b.ticket_date || '').localeCompare(a.ticket_date || '')).map(t => {
          const driver = appData.drivers.find(d => d.id === t.driver_id);
          const driverName = driver ? driver.first_name + ' ' + driver.last_name : '<span style="color:#ef4444">Unknown</span>';
          const files = (appData.ticket_files || []).filter(f => f.ticket_id === t.id);
          
          return '<tr>' +
            '<td><strong>' + driverName + '</strong></td>' +
            '<td>' + (t.ticket_date ? formatDate(t.ticket_date) : '-') + '</td>' +
            '<td style="max-width:180px">' + (t.ticket_description || '-') + '</td>' +
            '<td>' + getTicketStatusBadge(t.status) + '</td>' +
            '<td>' + (t.court_date ? formatDate(t.court_date) : '-') + '</td>' +
            '<td style="max-width:120px;font-size:12px">' + (t.attorney_info || '-') + '</td>' +
            '<td>' + (t.court_decision ? getCourtDecisionBadge(t.court_decision) : '-') + '</td>' +
            '<td>' + (t.dataq_decision ? getDataQBadge(t.dataq_decision) : '-') + '</td>' +
            '<td><button class="btn btn-secondary btn-sm" onclick="openTicketFilesModal(' + t.id + ')">ðŸ“Ž ' + files.length + '</button></td>' +
            '<td class="sticky-col"><div class="actions">' +
            '<button class="action-btn edit" onclick="openTicketModal(' + t.id + ')">Edit</button>' +
            '<button class="action-btn delete" onclick="deleteTicket(' + t.id + ')">Del</button>' +
            '</div></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }
    
    function renderViolationsTab(c) {
      const violations = appData.violations || [];
      let filtered = violations;
      if (dcFilterStatus) filtered = filtered.filter(v => v.status === dcFilterStatus);
      if (dcFilterDriver) filtered = filtered.filter(v => v.driver_id == dcFilterDriver);
      
      c.innerHTML = '<div class="card" style="padding:16px;margin-bottom:20px"><div style="display:flex;gap:16px;align-items:end;flex-wrap:wrap">' +
        '<div class="form-group" style="margin:0;min-width:150px"><label style="margin-bottom:4px">Status</label><select onchange="dcFilterStatus=this.value;renderDriverCompliance(document.getElementById(\'main-content\'))">' +
        '<option value="">All Statuses</option>' +
        '<option value="OPEN"' + (dcFilterStatus === 'OPEN' ? ' selected' : '') + '>Open</option>' +
        '<option value="IN_PROGRESS"' + (dcFilterStatus === 'IN_PROGRESS' ? ' selected' : '') + '>In Progress</option>' +
        '<option value="PENDING_REVIEW"' + (dcFilterStatus === 'PENDING_REVIEW' ? ' selected' : '') + '>Pending Review</option>' +
        '<option value="RESOLVED"' + (dcFilterStatus === 'RESOLVED' ? ' selected' : '') + '>Resolved</option>' +
        '<option value="DISMISSED"' + (dcFilterStatus === 'DISMISSED' ? ' selected' : '') + '>Dismissed</option>' +
        '</select></div>' +
        '<div class="form-group" style="margin:0;min-width:150px"><label style="margin-bottom:4px">Driver</label><select onchange="dcFilterDriver=this.value;renderDriverCompliance(document.getElementById(\'main-content\'))">' +
        '<option value="">All Drivers</option>' +
        appData.drivers.map(d => '<option value="' + d.id + '"' + (dcFilterDriver == d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('') +
        '</select></div>' +
        ((dcFilterStatus || dcFilterDriver) ? '<button class="btn btn-secondary" onclick="dcFilterStatus=\'\';dcFilterDriver=\'\';renderDriverCompliance(document.getElementById(\'main-content\'))">âœ• Clear</button>' : '') +
        '<div style="margin-left:auto;font-size:13px;color:var(--text-muted)">' + filtered.length + ' of ' + violations.length + ' violations</div>' +
        '</div></div>' +
        
        '<div class="card"><div class="card-header"><h3>âš ï¸ Violations</h3></div><div class="table-wrapper"><table><thead><tr>' +
        '<th>Driver</th><th>Date</th><th>Type</th><th>Description</th><th>Severity</th><th>Status</th><th>Points</th><th>Fine</th><th>Files</th><th class="sticky-col">Actions</th>' +
        '</tr></thead><tbody>' +
        (filtered.length === 0 ? '<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-muted)">No violations found</td></tr>' :
        filtered.sort((a, b) => (b.violation_date || '').localeCompare(a.violation_date || '')).map(v => {
          const driver = appData.drivers.find(d => d.id === v.driver_id);
          const driverName = driver ? driver.first_name + ' ' + driver.last_name : '<span style="color:#ef4444">Unknown</span>';
          const files = (appData.violation_files || []).filter(f => f.violation_id === v.id);
          
          return '<tr>' +
            '<td><strong>' + driverName + '</strong></td>' +
            '<td>' + (v.violation_date ? formatDate(v.violation_date) : '-') + '</td>' +
            '<td>' + getViolationTypeBadge(v.violation_type) + '</td>' +
            '<td style="max-width:180px">' + (v.description || '-') + '</td>' +
            '<td>' + getSeverityBadge(v.severity) + '</td>' +
            '<td>' + getViolationStatusBadge(v.status) + '</td>' +
            '<td>' + (v.points || '-') + '</td>' +
            '<td>' + (v.fine_amount ? formatMoney(v.fine_amount) : '-') + '</td>' +
            '<td><button class="btn btn-secondary btn-sm" onclick="openViolationFilesModal(' + v.id + ')">ðŸ“Ž ' + files.length + '</button></td>' +
            '<td class="sticky-col"><div class="actions">' +
            '<button class="action-btn edit" onclick="openViolationModal(' + v.id + ')">Edit</button>' +
            '<button class="action-btn delete" onclick="deleteViolation(' + v.id + ')">Del</button>' +
            '</div></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }
    
    function renderClaimsTab(c) {
      const claims = (appData.claims || []).filter(cl => cl.driver_id); // Only driver-assigned claims
      let filtered = claims;
      if (dcFilterStatus) filtered = filtered.filter(cl => cl.status === dcFilterStatus);
      if (dcFilterDriver) filtered = filtered.filter(cl => cl.driver_id == dcFilterDriver);
      
      c.innerHTML = '<div class="card" style="padding:16px;margin-bottom:20px"><div style="display:flex;gap:16px;align-items:end;flex-wrap:wrap">' +
        '<div class="form-group" style="margin:0;min-width:150px"><label style="margin-bottom:4px">Status</label><select onchange="dcFilterStatus=this.value;renderDriverCompliance(document.getElementById(\'main-content\'))">' +
        '<option value="">All Statuses</option>' +
        '<option value="OPEN"' + (dcFilterStatus === 'OPEN' ? ' selected' : '') + '>Open</option>' +
        '<option value="UNDER_REVIEW"' + (dcFilterStatus === 'UNDER_REVIEW' ? ' selected' : '') + '>Under Review</option>' +
        '<option value="APPROVED"' + (dcFilterStatus === 'APPROVED' ? ' selected' : '') + '>Approved</option>' +
        '<option value="DENIED"' + (dcFilterStatus === 'DENIED' ? ' selected' : '') + '>Denied</option>' +
        '<option value="SETTLED"' + (dcFilterStatus === 'SETTLED' ? ' selected' : '') + '>Settled</option>' +
        '</select></div>' +
        '<div class="form-group" style="margin:0;min-width:150px"><label style="margin-bottom:4px">Driver</label><select onchange="dcFilterDriver=this.value;renderDriverCompliance(document.getElementById(\'main-content\'))">' +
        '<option value="">All Drivers</option>' +
        appData.drivers.map(d => '<option value="' + d.id + '"' + (dcFilterDriver == d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('') +
        '</select></div>' +
        ((dcFilterStatus || dcFilterDriver) ? '<button class="btn btn-secondary" onclick="dcFilterStatus=\'\';dcFilterDriver=\'\';renderDriverCompliance(document.getElementById(\'main-content\'))">âœ• Clear</button>' : '') +
        '<div style="margin-left:auto;font-size:13px;color:var(--text-muted)">' + filtered.length + ' of ' + claims.length + ' claims</div>' +
        '</div></div>' +
        
        // Financial Summary
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:20px">' +
        '<div style="background:#fef3c7;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#92400e">Total Claimed</div><div style="font-size:20px;font-weight:700;color:#d97706">' + formatMoney(filtered.reduce((s,cl) => s + parseFloat(cl.claim_amount || 0), 0)) + '</div></div>' +
        '<div style="background:#fee2e2;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#991b1b">Driver Fault (Paid)</div><div style="font-size:20px;font-weight:700;color:#dc2626">' + formatMoney(filtered.filter(cl => cl.fault_party === 'DRIVER' && cl.status === 'SETTLED').reduce((s,cl) => s + parseFloat(cl.settlement_amount || cl.claim_amount || 0), 0)) + '</div></div>' +
        '<div style="background:#dcfce7;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#166534">Recovered</div><div style="font-size:20px;font-weight:700;color:#16a34a">' + formatMoney(filtered.filter(cl => cl.fault_party !== 'DRIVER' && cl.status === 'SETTLED').reduce((s,cl) => s + parseFloat(cl.settlement_amount || 0), 0)) + '</div></div>' +
        '</div>' +
        
        '<div class="card"><div class="card-header"><h3>ðŸ’¥ Damage Claims</h3></div><div class="table-wrapper"><table><thead><tr>' +
        '<th>Claim #</th><th>Date</th><th>Driver</th><th>Type</th><th>Description</th><th>Fault</th><th>Amount</th><th>Status</th><th>Files</th><th class="sticky-col">Actions</th>' +
        '</tr></thead><tbody>' +
        (filtered.length === 0 ? '<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-muted)">No claims found</td></tr>' :
        filtered.sort((a, b) => (b.incident_date || '').localeCompare(a.incident_date || '')).map(cl => {
          const driver = appData.drivers.find(d => d.id === cl.driver_id);
          const driverName = driver ? driver.first_name + ' ' + driver.last_name : '-';
          const files = (appData.claim_files || []).filter(f => f.claim_id === cl.id);
          
          return '<tr>' +
            '<td><strong>' + (cl.claim_number || 'CLM-' + cl.id) + '</strong></td>' +
            '<td>' + (cl.incident_date ? formatDate(cl.incident_date) : '-') + '</td>' +
            '<td>' + driverName + '</td>' +
            '<td><span class="badge badge-gray">' + (cl.damage_type || '-') + '</span></td>' +
            '<td style="max-width:180px">' + (cl.description || '-') + '</td>' +
            '<td>' + getFaultBadge(cl.fault_party) + '</td>' +
            '<td class="money">' + formatMoney(cl.claim_amount) + '</td>' +
            '<td>' + getClaimStatusBadge(cl.status) + '</td>' +
            '<td><button class="btn btn-secondary btn-sm" onclick="openClaimFilesModal(' + cl.id + ')">ðŸ“Ž ' + files.length + '</button></td>' +
            '<td class="sticky-col"><div class="actions">' +
            '<button class="action-btn view" onclick="viewClaim(' + cl.id + ')">View</button>' +
            '<button class="action-btn edit" onclick="openClaimModal(' + cl.id + ')">Edit</button>' +
            '<button class="action-btn delete" onclick="deleteClaim(' + cl.id + ')">Del</button>' +
            '</div></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }
    
    function getFaultBadge(fault) {
      const badges = {
        'DRIVER': '<span class="badge badge-red">DRIVER</span>',
        'BROKER': '<span class="badge badge-blue">BROKER</span>',
        'SHIPPER': '<span class="badge badge-purple">SHIPPER</span>',
        'CARRIER': '<span class="badge badge-amber">CARRIER</span>',
        'OTHER': '<span class="badge badge-gray">OTHER</span>',
        'UNKNOWN': '<span class="badge badge-gray">UNKNOWN</span>'
      };
      return badges[fault] || '<span class="badge badge-gray">' + (fault || 'N/A') + '</span>';
    }
    
    // Claim Files Modal
    function openClaimFilesModal(claimId) {
      const claim = (appData.claims || []).find(c => c.id === claimId);
      const files = (appData.claim_files || []).filter(f => f.claim_id === claimId);
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3>ðŸ“Ž Claim Files</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body">' +
        '<div style="margin-bottom:16px;padding:12px;background:var(--bg-darker);border-radius:8px"><strong>' + (claim?.claim_number || 'Claim #' + claimId) + '</strong></div>' +
        '<div class="form-group"><label>Upload File</label><input type="file" id="claimFileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"></div>' +
        '<button class="btn btn-primary btn-sm" onclick="uploadClaimFile(' + claimId + ')">ðŸ“¤ Upload</button>' +
        '<div style="margin-top:20px"><h4>Attached Files (' + files.length + ')</h4>' +
        (files.length === 0 ? '<p style="color:var(--text-muted)">No files attached</p>' :
        '<div style="display:flex;flex-direction:column;gap:8px;margin-top:12px">' +
        files.map(f => '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg-darker);border-radius:6px">' +
          '<div><strong>' + f.file_name + '</strong><div style="font-size:11px;color:var(--text-muted)">' + formatDate(f.uploaded_at) + '</div></div>' +
          '<div class="actions"><a href="' + f.file_url + '" target="_blank" class="action-btn view">View</a><button class="action-btn delete" onclick="deleteClaimFile(' + f.id + ',' + claimId + ')">Del</button></div></div>'
        ).join('') + '</div>') +
        '</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Close</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function uploadClaimFile(claimId) {
      const fileInput = document.getElementById('claimFileInput');
      if (!fileInput.files.length) { showToast('Select a file', 'error'); return; }
      const file = fileInput.files[0];
      showToast('Uploading...');
      try {
        const fileName = Date.now() + '_' + file.name;
        const { data: uploadData, error: uploadError } = await supabase.storage.from('claim-files').upload(fileName, file);
        if (uploadError) throw uploadError;
        const { data: urlData } = supabase.storage.from('claim-files').getPublicUrl(fileName);
        await dbInsert('claim_files', { claim_id: claimId, file_name: file.name, file_url: urlData.publicUrl, uploaded_at: new Date().toISOString() });
        showToast('File uploaded!');
        await loadAllData(true);
        document.querySelector('.modal-overlay').remove();
        openClaimFilesModal(claimId);
      } catch (e) { showToast('Upload failed: ' + e.message, 'error'); }
    }
    
    async function deleteClaimFile(fileId, claimId) {
      if (!confirm('Delete this file?')) return;
      try {
        await dbDelete('claim_files', fileId);
        showToast('File deleted');
        await loadAllData(true);
        document.querySelector('.modal-overlay').remove();
        openClaimFilesModal(claimId);
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    function getTicketStatusBadge(status) {
      const badges = {
        'OPEN': '<span class="badge badge-red">OPEN</span>',
        'IN_PROGRESS': '<span class="badge badge-amber">IN PROGRESS</span>',
        'ATTORNEY_HIRED': '<span class="badge badge-blue">ATTORNEY HIRED</span>',
        'PENDING_COURT': '<span class="badge badge-purple">PENDING COURT</span>',
        'PENDING_DATAQ': '<span class="badge badge-purple">PENDING DATAQ</span>',
        'RESOLVED': '<span class="badge badge-green">RESOLVED</span>',
        'DISMISSED': '<span class="badge badge-gray">DISMISSED</span>'
      };
      return badges[status] || '<span class="badge badge-gray">' + status + '</span>';
    }
    
    function getViolationStatusBadge(status) {
      const badges = {
        'OPEN': '<span class="badge badge-red">OPEN</span>',
        'IN_PROGRESS': '<span class="badge badge-amber">IN PROGRESS</span>',
        'PENDING_REVIEW': '<span class="badge badge-purple">PENDING REVIEW</span>',
        'RESOLVED': '<span class="badge badge-green">RESOLVED</span>',
        'DISMISSED': '<span class="badge badge-gray">DISMISSED</span>'
      };
      return badges[status] || '<span class="badge badge-gray">' + status + '</span>';
    }
    
    function getViolationTypeBadge(type) {
      const badges = {
        'HOS': '<span class="badge" style="background:#dc2626;color:white">HOS</span>',
        'SPEEDING': '<span class="badge" style="background:#f59e0b;color:white">SPEEDING</span>',
        'LOGBOOK': '<span class="badge" style="background:#8b5cf6;color:white">LOGBOOK</span>',
        'EQUIPMENT': '<span class="badge" style="background:#3b82f6;color:white">EQUIPMENT</span>',
        'WEIGHT': '<span class="badge" style="background:#64748b;color:white">WEIGHT</span>',
        'SAFETY': '<span class="badge" style="background:#dc2626;color:white">SAFETY</span>',
        'OTHER': '<span class="badge badge-gray">OTHER</span>'
      };
      return badges[type] || '<span class="badge badge-gray">' + (type || 'N/A') + '</span>';
    }
    
    function getSeverityBadge(severity) {
      const badges = {
        'MINOR': '<span class="badge badge-blue">MINOR</span>',
        'MODERATE': '<span class="badge badge-amber">MODERATE</span>',
        'SERIOUS': '<span class="badge badge-red">SERIOUS</span>',
        'CRITICAL': '<span class="badge" style="background:#7f1d1d;color:white">CRITICAL</span>'
      };
      return badges[severity] || '<span class="badge badge-gray">' + (severity || 'N/A') + '</span>';
    }
    
    function getCourtDecisionBadge(decision) {
      const badges = {
        'GUILTY': '<span class="badge badge-red">GUILTY</span>',
        'NOT_GUILTY': '<span class="badge badge-green">NOT GUILTY</span>',
        'DISMISSED': '<span class="badge badge-blue">DISMISSED</span>',
        'REDUCED': '<span class="badge badge-amber">REDUCED</span>',
        'PENDING': '<span class="badge badge-gray">PENDING</span>'
      };
      return badges[decision] || '<span class="badge badge-gray">' + decision + '</span>';
    }
    
    function getDataQBadge(decision) {
      const badges = {
        'ACCEPTED': '<span class="badge badge-green">ACCEPTED</span>',
        'DENIED': '<span class="badge badge-red">DENIED</span>',
        'PENDING': '<span class="badge badge-amber">PENDING</span>',
        'NOT_FILED': '<span class="badge badge-gray">NOT FILED</span>'
      };
      return badges[decision] || '<span class="badge badge-gray">' + decision + '</span>';
    }
    
    // TICKET MODAL
    function openTicketModal(id) {
      const t = id ? (appData.tickets || []).find(x => x.id === id) : null;
      const today = new Date().toISOString().split('T')[0];
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:650px"><div class="modal-header"><h3>ðŸŽ« ' + (t ? 'Edit' : 'New') + ' Ticket</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body" style="max-height:70vh;overflow-y:auto">' +
        
        '<div class="form-row"><div class="form-group"><label>Driver *</label><select id="ticketDriver">' +
        '<option value="">Select Driver</option>' +
        appData.drivers.map(d => '<option value="' + d.id + '"' + (t?.driver_id === d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('') +
        '</select></div><div class="form-group"><label>Status *</label><select id="ticketStatus">' +
        '<option value="OPEN"' + (t?.status === 'OPEN' ? ' selected' : '') + '>Open</option>' +
        '<option value="IN_PROGRESS"' + (t?.status === 'IN_PROGRESS' ? ' selected' : '') + '>In Progress</option>' +
        '<option value="ATTORNEY_HIRED"' + (t?.status === 'ATTORNEY_HIRED' ? ' selected' : '') + '>Attorney Hired</option>' +
        '<option value="PENDING_COURT"' + (t?.status === 'PENDING_COURT' ? ' selected' : '') + '>Pending Court</option>' +
        '<option value="PENDING_DATAQ"' + (t?.status === 'PENDING_DATAQ' ? ' selected' : '') + '>Pending DataQ</option>' +
        '<option value="RESOLVED"' + (t?.status === 'RESOLVED' ? ' selected' : '') + '>Resolved</option>' +
        '<option value="DISMISSED"' + (t?.status === 'DISMISSED' ? ' selected' : '') + '>Dismissed</option>' +
        '</select></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Ticket Date</label><input type="date" id="ticketDate" value="' + (t?.ticket_date || today) + '"></div>' +
        '<div class="form-group"><label>Court Date</label><input type="date" id="ticketCourtDate" value="' + (t?.court_date || '') + '"></div></div>' +
        
        '<div class="form-group"><label>Ticket Description</label><textarea id="ticketDescription" rows="2" placeholder="e.g., Speeding 15mph over limit, Logbook violation...">' + (t?.ticket_description || '') + '</textarea></div>' +
        
        '<div class="form-group"><label>Attorney Info</label><input type="text" id="ticketAttorney" value="' + (t?.attorney_info || '') + '" placeholder="Attorney name, phone, or firm"></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Court Decision</label><select id="ticketCourtDecision">' +
        '<option value="">Not Yet</option>' +
        '<option value="PENDING"' + (t?.court_decision === 'PENDING' ? ' selected' : '') + '>Pending</option>' +
        '<option value="GUILTY"' + (t?.court_decision === 'GUILTY' ? ' selected' : '') + '>Guilty</option>' +
        '<option value="NOT_GUILTY"' + (t?.court_decision === 'NOT_GUILTY' ? ' selected' : '') + '>Not Guilty</option>' +
        '<option value="DISMISSED"' + (t?.court_decision === 'DISMISSED' ? ' selected' : '') + '>Dismissed</option>' +
        '<option value="REDUCED"' + (t?.court_decision === 'REDUCED' ? ' selected' : '') + '>Reduced</option>' +
        '</select></div><div class="form-group"><label>DataQ Decision</label><select id="ticketDataQ">' +
        '<option value="">Not Filed</option>' +
        '<option value="NOT_FILED"' + (t?.dataq_decision === 'NOT_FILED' ? ' selected' : '') + '>Not Filed</option>' +
        '<option value="PENDING"' + (t?.dataq_decision === 'PENDING' ? ' selected' : '') + '>Pending</option>' +
        '<option value="ACCEPTED"' + (t?.dataq_decision === 'ACCEPTED' ? ' selected' : '') + '>Accepted (Removed)</option>' +
        '<option value="DENIED"' + (t?.dataq_decision === 'DENIED' ? ' selected' : '') + '>Denied</option>' +
        '</select></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Fine Amount ($)</label><input type="number" id="ticketFine" value="' + (t?.fine_amount || '') + '" placeholder="0.00"></div>' +
        '<div class="form-group"><label>Points</label><input type="number" id="ticketPoints" value="' + (t?.points || '') + '" placeholder="0"></div></div>' +
        
        '<div class="form-group"><label>Notes</label><textarea id="ticketNotes" rows="2" placeholder="Additional notes...">' + (t?.notes || '') + '</textarea></div>' +
        
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveTicket(' + (id || 'null') + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function saveTicket(id) {
      const driverId = parseInt(document.getElementById('ticketDriver').value);
      if (!driverId) { showToast('Please select a driver', 'error'); return; }
      
      const data = {
        driver_id: driverId,
        status: document.getElementById('ticketStatus').value,
        ticket_date: document.getElementById('ticketDate').value || null,
        ticket_description: document.getElementById('ticketDescription').value,
        court_date: document.getElementById('ticketCourtDate').value || null,
        attorney_info: document.getElementById('ticketAttorney').value,
        court_decision: document.getElementById('ticketCourtDecision').value || null,
        dataq_decision: document.getElementById('ticketDataQ').value || null,
        fine_amount: parseFloat(document.getElementById('ticketFine').value) || null,
        points: parseInt(document.getElementById('ticketPoints').value) || null,
        notes: document.getElementById('ticketNotes').value
      };
      
      try {
        if (id) { await dbUpdate('tickets', id, data); }
        else { await dbInsert('tickets', data); }
        document.querySelector('.modal-overlay').remove();
        showToast('Ticket saved!');
        await loadAllData(true);
        renderDriverCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    async function deleteTicket(id) {
      if (!confirm('Delete this ticket?')) return;
      try {
        await dbDelete('tickets', id);
        showToast('Ticket deleted');
        await loadAllData(true);
        renderDriverCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    // VIOLATION MODAL
    function openViolationModal(id) {
      const v = id ? (appData.violations || []).find(x => x.id === id) : null;
      const today = new Date().toISOString().split('T')[0];
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:650px"><div class="modal-header"><h3>âš ï¸ ' + (v ? 'Edit' : 'New') + ' Violation</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body" style="max-height:70vh;overflow-y:auto">' +
        
        '<div class="form-row"><div class="form-group"><label>Driver *</label><select id="violationDriver">' +
        '<option value="">Select Driver</option>' +
        appData.drivers.map(d => '<option value="' + d.id + '"' + (v?.driver_id === d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('') +
        '</select></div><div class="form-group"><label>Status *</label><select id="violationStatus">' +
        '<option value="OPEN"' + (v?.status === 'OPEN' ? ' selected' : '') + '>Open</option>' +
        '<option value="IN_PROGRESS"' + (v?.status === 'IN_PROGRESS' ? ' selected' : '') + '>In Progress</option>' +
        '<option value="PENDING_REVIEW"' + (v?.status === 'PENDING_REVIEW' ? ' selected' : '') + '>Pending Review</option>' +
        '<option value="RESOLVED"' + (v?.status === 'RESOLVED' ? ' selected' : '') + '>Resolved</option>' +
        '<option value="DISMISSED"' + (v?.status === 'DISMISSED' ? ' selected' : '') + '>Dismissed</option>' +
        '</select></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Violation Date</label><input type="date" id="violationDate" value="' + (v?.violation_date || today) + '"></div>' +
        '<div class="form-group"><label>Violation Type</label><select id="violationType">' +
        '<option value="">Select Type</option>' +
        '<option value="HOS"' + (v?.violation_type === 'HOS' ? ' selected' : '') + '>Hours of Service (HOS)</option>' +
        '<option value="SPEEDING"' + (v?.violation_type === 'SPEEDING' ? ' selected' : '') + '>Speeding</option>' +
        '<option value="LOGBOOK"' + (v?.violation_type === 'LOGBOOK' ? ' selected' : '') + '>Logbook</option>' +
        '<option value="EQUIPMENT"' + (v?.violation_type === 'EQUIPMENT' ? ' selected' : '') + '>Equipment</option>' +
        '<option value="WEIGHT"' + (v?.violation_type === 'WEIGHT' ? ' selected' : '') + '>Weight/Overload</option>' +
        '<option value="SAFETY"' + (v?.violation_type === 'SAFETY' ? ' selected' : '') + '>Safety</option>' +
        '<option value="OTHER"' + (v?.violation_type === 'OTHER' ? ' selected' : '') + '>Other</option>' +
        '</select></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Severity</label><select id="violationSeverity">' +
        '<option value="MINOR"' + (v?.severity === 'MINOR' ? ' selected' : '') + '>Minor</option>' +
        '<option value="MODERATE"' + (v?.severity === 'MODERATE' ? ' selected' : '') + '>Moderate</option>' +
        '<option value="SERIOUS"' + (v?.severity === 'SERIOUS' ? ' selected' : '') + '>Serious</option>' +
        '<option value="CRITICAL"' + (v?.severity === 'CRITICAL' ? ' selected' : '') + '>Critical</option>' +
        '</select></div><div class="form-group"><label>Location</label><input type="text" id="violationLocation" value="' + (v?.location || '') + '" placeholder="City, State"></div></div>' +
        
        '<div class="form-group"><label>Description</label><textarea id="violationDescription" rows="2" placeholder="Detailed description of the violation...">' + (v?.description || '') + '</textarea></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Fine Amount ($)</label><input type="number" id="violationFine" value="' + (v?.fine_amount || '') + '" placeholder="0.00"></div>' +
        '<div class="form-group"><label>Points</label><input type="number" id="violationPoints" value="' + (v?.points || '') + '" placeholder="0"></div></div>' +
        
        '<div class="form-group"><label>Inspection Report #</label><input type="text" id="violationReportNum" value="' + (v?.report_number || '') + '" placeholder="DOT inspection report number"></div>' +
        
        '<div class="form-group"><label>Notes</label><textarea id="violationNotes" rows="2" placeholder="Additional notes...">' + (v?.notes || '') + '</textarea></div>' +
        
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveViolation(' + (id || 'null') + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function saveViolation(id) {
      const driverId = parseInt(document.getElementById('violationDriver').value);
      if (!driverId) { showToast('Please select a driver', 'error'); return; }
      
      const data = {
        driver_id: driverId,
        status: document.getElementById('violationStatus').value,
        violation_date: document.getElementById('violationDate').value || null,
        violation_type: document.getElementById('violationType').value || null,
        severity: document.getElementById('violationSeverity').value,
        location: document.getElementById('violationLocation').value,
        description: document.getElementById('violationDescription').value,
        fine_amount: parseFloat(document.getElementById('violationFine').value) || null,
        points: parseInt(document.getElementById('violationPoints').value) || null,
        report_number: document.getElementById('violationReportNum').value,
        notes: document.getElementById('violationNotes').value
      };
      
      try {
        if (id) { await dbUpdate('violations', id, data); }
        else { await dbInsert('violations', data); }
        document.querySelector('.modal-overlay').remove();
        showToast('Violation saved!');
        await loadAllData(true);
        renderDriverCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    async function deleteViolation(id) {
      if (!confirm('Delete this violation?')) return;
      try {
        await dbDelete('violations', id);
        showToast('Violation deleted');
        await loadAllData(true);
        renderDriverCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    // FILE ATTACHMENTS FOR TICKETS
    function openTicketFilesModal(ticketId) {
      const ticket = (appData.tickets || []).find(t => t.id === ticketId);
      const files = (appData.ticket_files || []).filter(f => f.ticket_id === ticketId);
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3>ðŸ“Ž Ticket Files</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body">' +
        '<div style="margin-bottom:16px;padding:12px;background:var(--bg-darker);border-radius:8px"><strong>' + (ticket?.ticket_description || 'Ticket #' + ticketId) + '</strong></div>' +
        '<div class="form-group"><label>Upload File</label><input type="file" id="ticketFileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"></div>' +
        '<button class="btn btn-primary btn-sm" onclick="uploadTicketFile(' + ticketId + ')">ðŸ“¤ Upload</button>' +
        '<div style="margin-top:20px"><h4>Attached Files (' + files.length + ')</h4>' +
        (files.length === 0 ? '<p style="color:var(--text-muted)">No files attached</p>' :
        '<div style="display:flex;flex-direction:column;gap:8px;margin-top:12px">' +
        files.map(f => '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg-darker);border-radius:6px">' +
          '<div><strong>' + f.file_name + '</strong><div style="font-size:11px;color:var(--text-muted)">' + formatDate(f.uploaded_at) + '</div></div>' +
          '<div class="actions"><a href="' + f.file_url + '" target="_blank" class="action-btn view">View</a><button class="action-btn delete" onclick="deleteTicketFile(' + f.id + ',' + ticketId + ')">Del</button></div></div>'
        ).join('') + '</div>') +
        '</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Close</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function uploadTicketFile(ticketId) {
      const fileInput = document.getElementById('ticketFileInput');
      if (!fileInput.files.length) { showToast('Select a file', 'error'); return; }
      const file = fileInput.files[0];
      showToast('Uploading...');
      try {
        const fileName = Date.now() + '_' + file.name;
        const { data: uploadData, error: uploadError } = await supabase.storage.from('ticket-files').upload(fileName, file);
        if (uploadError) throw uploadError;
        const { data: urlData } = supabase.storage.from('ticket-files').getPublicUrl(fileName);
        await dbInsert('ticket_files', { ticket_id: ticketId, file_name: file.name, file_url: urlData.publicUrl, uploaded_at: new Date().toISOString() });
        showToast('File uploaded!');
        await loadAllData(true);
        document.querySelector('.modal-overlay').remove();
        openTicketFilesModal(ticketId);
      } catch (e) { showToast('Upload failed: ' + e.message, 'error'); }
    }
    
    async function deleteTicketFile(fileId, ticketId) {
      if (!confirm('Delete this file?')) return;
      try {
        await dbDelete('ticket_files', fileId);
        showToast('File deleted');
        await loadAllData(true);
        document.querySelector('.modal-overlay').remove();
        openTicketFilesModal(ticketId);
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    // FILE ATTACHMENTS FOR VIOLATIONS
    function openViolationFilesModal(violationId) {
      const violation = (appData.violations || []).find(v => v.id === violationId);
      const files = (appData.violation_files || []).filter(f => f.violation_id === violationId);
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3>ðŸ“Ž Violation Files</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body">' +
        '<div style="margin-bottom:16px;padding:12px;background:var(--bg-darker);border-radius:8px"><strong>' + (violation?.description || 'Violation #' + violationId) + '</strong></div>' +
        '<div class="form-group"><label>Upload File</label><input type="file" id="violationFileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"></div>' +
        '<button class="btn btn-primary btn-sm" onclick="uploadViolationFile(' + violationId + ')">ðŸ“¤ Upload</button>' +
        '<div style="margin-top:20px"><h4>Attached Files (' + files.length + ')</h4>' +
        (files.length === 0 ? '<p style="color:var(--text-muted)">No files attached</p>' :
        '<div style="display:flex;flex-direction:column;gap:8px;margin-top:12px">' +
        files.map(f => '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg-darker);border-radius:6px">' +
          '<div><strong>' + f.file_name + '</strong><div style="font-size:11px;color:var(--text-muted)">' + formatDate(f.uploaded_at) + '</div></div>' +
          '<div class="actions"><a href="' + f.file_url + '" target="_blank" class="action-btn view">View</a><button class="action-btn delete" onclick="deleteViolationFile(' + f.id + ',' + violationId + ')">Del</button></div></div>'
        ).join('') + '</div>') +
        '</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Close</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function uploadViolationFile(violationId) {
      const fileInput = document.getElementById('violationFileInput');
      if (!fileInput.files.length) { showToast('Select a file', 'error'); return; }
      const file = fileInput.files[0];
      showToast('Uploading...');
      try {
        const fileName = Date.now() + '_' + file.name;
        const { data: uploadData, error: uploadError } = await supabase.storage.from('violation-files').upload(fileName, file);
        if (uploadError) throw uploadError;
        const { data: urlData } = supabase.storage.from('violation-files').getPublicUrl(fileName);
        await dbInsert('violation_files', { violation_id: violationId, file_name: file.name, file_url: urlData.publicUrl, uploaded_at: new Date().toISOString() });
        showToast('File uploaded!');
        await loadAllData(true);
        document.querySelector('.modal-overlay').remove();
        openViolationFilesModal(violationId);
      } catch (e) { showToast('Upload failed: ' + e.message, 'error'); }
    }
    
    async function deleteViolationFile(fileId, violationId) {
      if (!confirm('Delete this file?')) return;
      try {
        await dbDelete('violation_files', fileId);
        showToast('File deleted');
        await loadAllData(true);
        document.querySelector('.modal-overlay').remove();
        openViolationFilesModal(violationId);
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    // ============ DAMAGE CLAIMS MANAGEMENT ============
    function renderClaims(c) {
      const claims = appData.claims || [];
      
      // Stats
      const openClaims = claims.filter(cl => cl.status === 'OPEN').length;
      const underReview = claims.filter(cl => cl.status === 'UNDER_REVIEW').length;
      const approvedClaims = claims.filter(cl => cl.status === 'APPROVED').length;
      const deniedClaims = claims.filter(cl => cl.status === 'DENIED').length;
      const settledClaims = claims.filter(cl => cl.status === 'SETTLED').length;
      const totalClaimAmount = claims.reduce((s, cl) => s + parseFloat(cl.claim_amount || 0), 0);
      const settledAmount = claims.filter(cl => cl.status === 'SETTLED').reduce((s, cl) => s + parseFloat(cl.settlement_amount || cl.claim_amount || 0), 0);
      
      c.innerHTML = '<div class="header"><h2>âš ï¸ Damage Claims</h2><button class="btn btn-primary" onclick="openClaimModal()">+ New Claim</button></div>' +
        
        // Stats Row - Mobile friendly grid
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="padding:16px;text-align:center"><div style="font-size:24px;margin-bottom:4px">âš ï¸</div><div class="label">Open Claims</div><div class="value">' + openClaims + '</div></div>' +
        '<div class="stat-card" style="padding:16px;text-align:center"><div style="font-size:24px;margin-bottom:4px">ðŸ”</div><div class="label">Under Review</div><div class="value">' + underReview + '</div></div>' +
        '<div class="stat-card" style="padding:16px;text-align:center"><div style="font-size:24px;margin-bottom:4px">âœ…</div><div class="label">Approved</div><div class="value">' + approvedClaims + '</div></div>' +
        '<div class="stat-card" style="padding:16px;text-align:center"><div style="font-size:24px;margin-bottom:4px">âŒ</div><div class="label">Denied</div><div class="value">' + deniedClaims + '</div></div>' +
        '<div class="stat-card" style="padding:16px;text-align:center"><div style="font-size:24px;margin-bottom:4px">ðŸ’°</div><div class="label">Settled</div><div class="value">' + settledClaims + '</div></div>' +
        '<div class="stat-card" style="padding:16px;text-align:center;background:#fef3c7"><div style="font-size:24px;margin-bottom:4px">ðŸ’µ</div><div class="label">Total Claimed</div><div class="value" style="color:#f59e0b">' + formatMoney(totalClaimAmount) + '</div></div>' +
        '<div class="stat-card" style="padding:16px;text-align:center;background:#d1fae5"><div style="font-size:24px;margin-bottom:4px">âœ“</div><div class="label">Total Settled</div><div class="value" style="color:#10b981">' + formatMoney(settledAmount) + '</div></div>' +
        '</div>' +
        
        // Claims Table
        '<div class="card"><div class="card-header"><h3>ðŸ“‹ All Claims</h3></div>' +
        '<div class="table-wrapper"><table><thead><tr><th>#</th><th>Date</th><th>Truck</th><th>Driver</th><th>Type</th><th>Description</th><th>Claim Amount</th><th>Status</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        (claims.length === 0 ? '<tr><td colspan="9" style="text-align:center;padding:40px;color:#64748b">No damage claims recorded. Click "+ New Claim" to add one.</td></tr>' :
        claims.sort((a, b) => new Date(b.incident_date) - new Date(a.incident_date)).map((cl, i) => {
          const truck = appData.trucks.find(t => t.id === cl.truck_id);
          const driver = appData.drivers.find(d => d.id === cl.driver_id);
          const statusBadge = getClaimStatusBadge(cl.status);
          return '<tr>' +
            '<td><strong>' + (cl.claim_number || 'CLM-' + cl.id) + '</strong></td>' +
            '<td>' + formatDate(cl.incident_date) + '</td>' +
            '<td>' + (truck ? '<span class="badge badge-blue">#' + truck.truck_number + '</span>' : '-') + '</td>' +
            '<td>' + (driver ? driver.first_name + ' ' + driver.last_name : '-') + '</td>' +
            '<td><span class="badge badge-gray">' + (cl.damage_type || 'Other') + '</span></td>' +
            '<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="' + (cl.description || '') + '">' + (cl.description || '-') + '</td>' +
            '<td class="money">' + formatMoney(cl.claim_amount) + '</td>' +
            '<td>' + statusBadge + '</td>' +
            '<td class="sticky-col"><div class="actions"><button class="action-btn view" onclick="viewClaim(' + cl.id + ')">View</button><button class="action-btn edit" onclick="openClaimModal(' + cl.id + ')">Edit</button><button class="action-btn delete" onclick="deleteClaim(' + cl.id + ')">Del</button></div></td>' +
            '</tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }
    
    function getClaimStatusBadge(status) {
      const badges = {
        'OPEN': '<span class="badge badge-amber">OPEN</span>',
        'UNDER_REVIEW': '<span class="badge badge-blue">UNDER REVIEW</span>',
        'APPROVED': '<span class="badge badge-green">APPROVED</span>',
        'DENIED': '<span class="badge badge-red">DENIED</span>',
        'SETTLED': '<span class="badge badge-purple">SETTLED</span>'
      };
      return badges[status] || '<span class="badge badge-gray">' + status + '</span>';
    }
    
    function openClaimModal(claimId) {
      const claim = claimId ? appData.claims.find(c => c.id === claimId) : null;
      const isEdit = !!claim;
      
      const truckOptions = appData.trucks.map(t => '<option value="' + t.id + '"' + (claim && claim.truck_id === t.id ? ' selected' : '') + '>#' + t.truck_number + ' - ' + t.truck_type + '</option>').join('');
      const driverOptions = appData.drivers.map(d => '<option value="' + d.id + '"' + (claim && claim.driver_id === d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('');
      const tripOptions = appData.trips.map(t => '<option value="' + t.id + '"' + (claim && claim.trip_id === t.id ? ' selected' : '') + '>' + t.trip_number + '</option>').join('');
      
      const damageTypes = ['Cargo Damage', 'Vehicle Damage', 'Property Damage', 'Equipment Damage', 'Theft', 'Weather Damage', 'Accident', 'Other'];
      const damageTypeOptions = damageTypes.map(dt => '<option value="' + dt + '"' + (claim && claim.damage_type === dt ? ' selected' : '') + '>' + dt + '</option>').join('');
      
      const statusOptions = ['OPEN', 'UNDER_REVIEW', 'APPROVED', 'DENIED', 'SETTLED'].map(s => '<option value="' + s + '"' + (claim && claim.status === s ? ' selected' : '') + '>' + s.replace('_', ' ') + '</option>').join('');
      
      const faultOptions = ['UNKNOWN', 'DRIVER', 'BROKER', 'SHIPPER', 'CARRIER', 'OTHER'].map(f => '<option value="' + f + '"' + (claim && claim.fault_party === f ? ' selected' : '') + '>' + f + '</option>').join('');
      
      showModal('claim-modal', (isEdit ? 'Edit' : 'New') + ' Damage Claim', 
        '<form id="claim-form">' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">' +
        '<div class="form-group"><label>Incident Date *</label><input type="date" name="incident_date" value="' + (claim ? claim.incident_date : new Date().toISOString().split('T')[0]) + '" required></div>' +
        '<div class="form-group"><label>Claim Number</label><input type="text" name="claim_number" value="' + (claim ? claim.claim_number || '' : '') + '" placeholder="Auto-generated if empty"></div>' +
        '</div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">' +
        '<div class="form-group"><label>Assign to Truck</label><select name="truck_id"><option value="">-- Select Truck --</option>' + truckOptions + '</select></div>' +
        '<div class="form-group"><label>Assign to Driver</label><select name="driver_id"><option value="">-- Select Driver --</option>' + driverOptions + '</select></div>' +
        '</div>' +
        '<div class="form-group"><label>Related Trip (Optional)</label><select name="trip_id"><option value="">-- Select Trip --</option>' + tripOptions + '</select></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">' +
        '<div class="form-group"><label>Damage Type *</label><select name="damage_type" required>' + damageTypeOptions + '</select></div>' +
        '<div class="form-group"><label>Fault Party *</label><select name="fault_party" required>' + faultOptions + '</select></div>' +
        '<div class="form-group"><label>Status *</label><select name="status" required>' + statusOptions + '</select></div>' +
        '</div>' +
        '<div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:16px;font-size:13px"><strong>ðŸ’¡ Fault Party:</strong> If DRIVER is at fault and claim is SETTLED, it will be tracked as a company expense or driver deduction.</div>' +
        '<div class="form-group"><label>Description *</label><textarea name="description" rows="3" required placeholder="Describe the damage incident...">' + (claim ? claim.description || '' : '') + '</textarea></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">' +
        '<div class="form-group"><label>Claim Amount ($) *</label><input type="number" name="claim_amount" step="0.01" value="' + (claim ? claim.claim_amount || '' : '') + '" required placeholder="0.00"></div>' +
        '<div class="form-group"><label>Settlement Amount ($)</label><input type="number" name="settlement_amount" step="0.01" value="' + (claim ? claim.settlement_amount || '' : '') + '" placeholder="If settled"></div>' +
        '</div>' +
        '<div class="form-group"><label>Insurance Claim Number</label><input type="text" name="insurance_claim_number" value="' + (claim ? claim.insurance_claim_number || '' : '') + '" placeholder="Insurance reference #"></div>' +
        '<div class="form-group"><label>Location of Incident</label><input type="text" name="incident_location" value="' + (claim ? claim.incident_location || '' : '') + '" placeholder="Address or location"></div>' +
        '<div class="form-group"><label>Resolution Notes</label><textarea name="resolution_notes" rows="2" placeholder="Notes about claim resolution...">' + (claim ? claim.resolution_notes || '' : '') + '</textarea></div>' +
        '</form>',
        '<button class="btn btn-secondary" onclick="closeModal(\'claim-modal\')">Cancel</button>' +
        '<button class="btn btn-primary" onclick="saveClaim(' + (claimId || 'null') + ')">' + (isEdit ? 'Update' : 'Create') + ' Claim</button>'
      );
    }
    
    async function saveClaim(claimId) {
      const form = document.getElementById('claim-form');
      const formData = new FormData(form);
      
      const claimData = {
        incident_date: formData.get('incident_date'),
        claim_number: formData.get('claim_number') || null,
        truck_id: formData.get('truck_id') ? parseInt(formData.get('truck_id')) : null,
        driver_id: formData.get('driver_id') ? parseInt(formData.get('driver_id')) : null,
        trip_id: formData.get('trip_id') ? parseInt(formData.get('trip_id')) : null,
        damage_type: formData.get('damage_type'),
        fault_party: formData.get('fault_party') || 'UNKNOWN',
        status: formData.get('status'),
        description: formData.get('description'),
        claim_amount: parseFloat(formData.get('claim_amount')) || 0,
        settlement_amount: formData.get('settlement_amount') ? parseFloat(formData.get('settlement_amount')) : null,
        insurance_claim_number: formData.get('insurance_claim_number') || null,
        incident_location: formData.get('incident_location') || null,
        resolution_notes: formData.get('resolution_notes') || null
      };
      
      // Generate claim number if not provided
      if (!claimData.claim_number) {
        claimData.claim_number = 'CLM-' + Date.now().toString().slice(-6);
      }
      
      try {
        if (claimId) {
          // Update existing claim in database
          await dbUpdate('claims', claimId, claimData);
          await logActivity('CLAIM_UPDATED', { claim_id: claimId, claim_number: claimData.claim_number, status: claimData.status, claim_amount: claimData.claim_amount, damage_type: claimData.damage_type });
          const idx = appData.claims.findIndex(c => c.id === claimId);
          if (idx !== -1) {
            appData.claims[idx] = { ...appData.claims[idx], ...claimData };
          }
          showToast('Claim updated successfully');
        } else {
          // Create new claim in database
          const newClaim = await dbInsert('claims', claimData);
          await logActivity('CLAIM_CREATED', { claim_id: newClaim.id, claim_number: claimData.claim_number, claim_amount: claimData.claim_amount, damage_type: claimData.damage_type });
          appData.claims.push(newClaim);
          showToast('Claim created successfully');
        }
        closeModal('claim-modal');
        renderClaims(document.getElementById('main-content'));
      } catch (e) {
        showToast('Error saving claim: ' + e.message, 'error');
      }
    }
    
    function viewClaim(claimId) {
      const claim = appData.claims.find(c => c.id === claimId);
      if (!claim) return;
      
      const truck = appData.trucks.find(t => t.id === claim.truck_id);
      const driver = appData.drivers.find(d => d.id === claim.driver_id);
      const trip = appData.trips.find(t => t.id === claim.trip_id);
      
      showModal('view-claim-modal', 'âš ï¸ Claim Details: ' + (claim.claim_number || 'CLM-' + claim.id),
        '<div style="display:grid;gap:16px">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;padding:16px;background:var(--bg-tertiary);border-radius:8px">' +
        '<div><strong style="font-size:24px">' + formatMoney(claim.claim_amount) + '</strong><br><span style="color:var(--text-muted)">Claim Amount</span></div>' +
        '<div>' + getClaimStatusBadge(claim.status) + '</div>' +
        '</div>' +
        
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">' +
        '<div style="padding:12px;background:var(--bg-tertiary);border-radius:8px"><strong>Incident Date</strong><br>' + formatDate(claim.incident_date) + '</div>' +
        '<div style="padding:12px;background:var(--bg-tertiary);border-radius:8px"><strong>Damage Type</strong><br>' + (claim.damage_type || '-') + '</div>' +
        '<div style="padding:12px;background:var(--bg-tertiary);border-radius:8px"><strong>Assigned Truck</strong><br>' + (truck ? '#' + truck.truck_number + ' (' + truck.truck_type + ')' : 'Not assigned') + '</div>' +
        '<div style="padding:12px;background:var(--bg-tertiary);border-radius:8px"><strong>Assigned Driver</strong><br>' + (driver ? driver.first_name + ' ' + driver.last_name : 'Not assigned') + '</div>' +
        '</div>' +
        
        (trip ? '<div style="padding:12px;background:#dbeafe;border-radius:8px"><strong>Related Trip:</strong> ' + trip.trip_number + '</div>' : '') +
        
        '<div style="padding:12px;background:var(--bg-tertiary);border-radius:8px"><strong>Description</strong><br>' + (claim.description || '-') + '</div>' +
        
        (claim.incident_location ? '<div style="padding:12px;background:var(--bg-tertiary);border-radius:8px"><strong>Incident Location</strong><br>' + claim.incident_location + '</div>' : '') +
        
        (claim.insurance_claim_number ? '<div style="padding:12px;background:#fef3c7;border-radius:8px"><strong>Insurance Claim #</strong><br>' + claim.insurance_claim_number + '</div>' : '') +
        
        (claim.settlement_amount ? '<div style="padding:12px;background:#d1fae5;border-radius:8px"><strong>Settlement Amount</strong><br><span style="font-size:20px;color:#047857">' + formatMoney(claim.settlement_amount) + '</span></div>' : '') +
        
        (claim.resolution_notes ? '<div style="padding:12px;background:#e0e7ff;border-radius:8px"><strong>Resolution Notes</strong><br>' + claim.resolution_notes + '</div>' : '') +
        
        '<div style="font-size:12px;color:var(--text-muted)">Created: ' + formatDate(claim.created_at) + '</div>' +
        '</div>',
        '<button class="btn btn-secondary" onclick="closeModal(\'view-claim-modal\')">Close</button>' +
        '<button class="btn btn-primary" onclick="closeModal(\'view-claim-modal\');openClaimModal(' + claimId + ')">Edit Claim</button>'
      );
    }
    
    async function deleteClaim(claimId) {
      if (!confirm('Are you sure you want to delete this claim?')) return;
      
      try {
        const claim = appData.claims.find(c => c.id === claimId);
        // Delete from database
        await dbDelete('claims', claimId);
        await logActivity('CLAIM_DELETED', { claim_id: claimId, claim_number: claim?.claim_number, claim_amount: claim?.claim_amount });
        
        // Remove from local array
        const idx = appData.claims.findIndex(c => c.id === claimId);
        if (idx !== -1) {
          appData.claims.splice(idx, 1);
        }
        showToast('Claim deleted');
        renderClaims(document.getElementById('main-content'));
      } catch (e) {
        showToast('Delete failed: ' + e.message, 'error');
      }
    }

    function renderPayroll(c) {
      const payrollData = appData.drivers.map(driver => {
        const driverTrips = appData.trips.filter(t => t.driver_id === driver.id && t.status === 'COMPLETED');
        let grossEarnings = 0;
        let cashCollected = 0;
        let expenseReimbursements = 0;

        driverTrips.forEach(trip => {
          const fin = getTripFin(trip.id);
          grossEarnings += fin.driverCut;
          
          const tripOrders = appData.orders.filter(o => o.trip_id === trip.id);
          // For split payments, only count cod_amount as cash collected, not full revenue
          cashCollected += tripOrders
            .filter(o => o.payment_type === 'COD' || o.payment_type === 'COP')
            .reduce((sum, o) => {
              if (parseFloat(o.bill_amount || 0) > 0) {
                return sum + parseFloat(o.cod_amount || 0);
              }
              return sum + parseFloat(o.revenue || 0);
            }, 0);
          
          const tripExpenses = appData.expenses.filter(e => e.trip_id === trip.id);
          // Only reimburse OTHER category expenses
          expenseReimbursements += tripExpenses.filter(e => e.category === 'OTHER').reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
        });

        const netPay = grossEarnings - cashCollected + expenseReimbursements;
        return { driver, driverTrips, tripCount: driverTrips.length, grossEarnings, cashCollected, expenseReimbursements, netPay };
      });

      c.innerHTML = '<div class="header"><h2>ðŸ’° Driver Payroll</h2><button class="btn btn-secondary" onclick="window.print()">ðŸ–¨ï¸ Print</button></div>' +
        '<div style="background:#dbeafe;border:1px solid #93c5fd;border-radius:8px;padding:16px;margin-bottom:24px"><strong style="color:#1d4ed8">ðŸ“‹ Formula:</strong><p style="color:#1e40af;margin-top:8px">Net Pay = Gross Earnings âˆ’ Cash Collected + Expense Reimbursements (OTHER only)</p><p style="color:#64748b;font-size:13px;margin-top:4px">Only COMPLETED trips are included. Only "OTHER" category expenses are reimbursed to drivers.</p></div>' +
        '<div class="card"><div class="table-wrapper"><table><thead><tr><th>Driver</th><th>Completed Trips</th><th>Gross Earnings</th><th>Cash Collected</th><th>Expense Reimb.</th><th>Net Pay</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        (payrollData.length === 0 ? '<tr><td colspan="7" style="text-align:center;padding:40px">No drivers yet</td></tr>' :
        payrollData.map(p => '<tr><td><strong>' + p.driver.first_name + ' ' + p.driver.last_name + '</strong><br><span style="color:#64748b;font-size:12px">' + p.driver.cut_percent + '% cut</span></td><td>' + p.tripCount + '</td><td class="money positive">' + formatMoney(p.grossEarnings) + '</td><td class="money negative">-' + formatMoney(p.cashCollected) + '</td><td class="money positive">+' + formatMoney(p.expenseReimbursements) + '</td><td class="money" style="font-size:16px;font-weight:700;color:' + (p.netPay >= 0 ? '#047857' : '#dc2626') + '">' + formatMoney(p.netPay) + '</td><td class="sticky-col"><button class="btn btn-primary btn-sm" onclick="openPaystubModal(' + p.driver.id + ')">ðŸ“„ Generate Paystub</button></td></tr>').join('')) +
        '</tbody></table></div></div>' +
        '<div class="card"><div class="card-header"><h3>ðŸ“Š Payroll Summary</h3></div><div style="padding:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:20px;text-align:center">' +
        '<div><div style="font-size:12px;color:#64748b">Total Gross</div><div style="font-size:20px;font-weight:700;color:#1e293b">' + formatMoney(payrollData.reduce((s,p) => s + p.grossEarnings, 0)) + '</div></div>' +
        '<div><div style="font-size:12px;color:#64748b">Total Cash Collected</div><div style="font-size:20px;font-weight:700;color:#ef4444">' + formatMoney(payrollData.reduce((s,p) => s + p.cashCollected, 0)) + '</div></div>' +
        '<div><div style="font-size:12px;color:#64748b">Total Reimbursements</div><div style="font-size:20px;font-weight:700;color:#10b981">' + formatMoney(payrollData.reduce((s,p) => s + p.expenseReimbursements, 0)) + '</div></div>' +
        '<div style="background:#d1fae5;padding:16px;border-radius:8px"><div style="font-size:12px;color:#064e3b">Total Net Payroll</div><div style="font-size:20px;font-weight:700;color:#047857">' + formatMoney(payrollData.reduce((s,p) => s + p.netPay, 0)) + '</div></div>' +
        '</div></div>';
    }

    function openPaystubModal(driverId) {
      const driver = appData.drivers.find(d => d.id === driverId);
      const completedTrips = appData.trips.filter(t => t.driver_id === driverId && t.status === 'COMPLETED');
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:600px;max-height:90vh;display:flex;flex-direction:column"><div class="modal-header"><h3>ðŸ“„ Generate Paystub</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body" style="overflow-y:auto;flex:1">' +
        '<div class="form-row"><div class="form-group"><label>Driver</label><input value="' + driver.first_name + ' ' + driver.last_name + '" readonly style="background:#f1f5f9"></div><div class="form-group"><label>Driver Email</label><input type="email" id="driverEmail" value="' + (driver.email || '') + '" placeholder="driver@email.com"></div></div>' +
        '<div class="form-group"><label>Select Trip(s) for Paystub</label><div style="max-height:150px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:8px;padding:8px">' +
        (completedTrips.length === 0 ? '<p style="color:#64748b;text-align:center;padding:20px">No completed trips</p>' :
        completedTrips.map(t => {
          const f = getTripFin(t.id);
          return '<label style="display:flex;align-items:center;gap:8px;padding:8px;cursor:pointer;border-bottom:1px solid #f1f5f9"><input type="checkbox" class="paystub-trip" value="' + t.id + '"><span><strong>' + t.trip_number + '</strong> - ' + formatDate(t.trip_date) + '</span><span style="margin-left:auto;color:#10b981">' + formatMoney(f.driverCut) + '</span></label>';
        }).join('')) +
        '</div></div>' +
        '<div class="form-row"><div class="form-group"><label>Stub #</label><input type="number" id="stubNumber" value="' + (1000 + Math.floor(Math.random() * 9000)) + '"></div><div class="form-group"><label>Check #</label><input type="number" id="checkNumber" value="' + (10000 + Math.floor(Math.random() * 90000)) + '"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Period Starting</label><input type="date" id="periodStart" value="' + new Date().toISOString().split('T')[0] + '"></div><div class="form-group"><label>Period Ending</label><input type="date" id="periodEnd" value="' + new Date().toISOString().split('T')[0] + '"></div></div>' +
        '<div class="form-group"><label>Pay Date</label><input type="date" id="payDate" value="' + new Date().toISOString().split('T')[0] + '"></div>' +
        
        // Deductions Section
        '<div style="background:#fee2e2;padding:12px;border-radius:8px;margin-top:12px">' +
        '<label style="font-weight:600;margin-bottom:8px;display:block;color:#dc2626">âž– DEDUCTIONS</label>' +
        '<div class="form-row" style="gap:8px"><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Insurance (Cargo/Liab/Phys)</label><input type="number" id="dedInsurance" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Fuel</label><input type="number" id="dedFuel" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Fuel Deposit</label><input type="number" id="dedFuelDeposit" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div></div>' +
        '<div class="form-row" style="gap:8px"><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">ELD</label><input type="number" id="dedELD" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Tolls</label><input type="number" id="dedTolls" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">IFTA</label><input type="number" id="dedIFTA" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div></div>' +
        '<div class="form-row" style="gap:8px"><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Highway Use Tax (2290)</label><input type="number" id="ded2290" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Reg Renewal</label><input type="number" id="dedRegRenewal" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Other Deductions</label><input type="number" id="dedOther" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div></div>' +
        '<div style="text-align:right;margin-top:8px;font-weight:600;color:#dc2626">Total Deductions: $<span id="totalDeductionsDisplay">0.00</span></div></div>' +
        
        // Bonuses Section
        '<div style="background:#d1fae5;padding:12px;border-radius:8px;margin-top:12px">' +
        '<label style="font-weight:600;margin-bottom:8px;display:block;color:#059669">âž• BONUSES</label>' +
        '<div class="form-row" style="gap:8px"><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Level I Inspection</label><input type="number" id="bonusLevel1" value="0" class="bonus-input" onchange="updatePaystubTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Level II Inspection</label><input type="number" id="bonusLevel2" value="0" class="bonus-input" onchange="updatePaystubTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Level III Inspection</label><input type="number" id="bonusLevel3" value="0" class="bonus-input" onchange="updatePaystubTotals()"></div></div>' +
        '<div class="form-row" style="gap:8px"><div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Other Bonus</label><input type="number" id="bonusOther" value="0" class="bonus-input" onchange="updatePaystubTotals()"></div></div>' +
        '<div style="text-align:right;margin-top:8px;font-weight:600;color:#059669">Total Bonuses: $<span id="totalBonusesDisplay">0.00</span></div></div>' +
        
        '</div><div class="modal-footer" style="flex-wrap:wrap;gap:8px"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="generatePaystub(' + driverId + ', \'print\')"><svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right:6px"><path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2H5zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1z"/><path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2V7z"/></svg>Print</button><button class="btn btn-primary" style="background:#059669" onclick="generatePaystub(' + driverId + ', \'email\')"><svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right:6px"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/></svg>Send Email</button><button class="btn btn-secondary" onclick="generatePaystub(' + driverId + ', \'both\')">Print & Email</button></div></div>';
      document.body.appendChild(m);
    }
    
    function updatePaystubTotals() {
      const deductions = ['dedInsurance', 'dedFuel', 'dedFuelDeposit', 'dedELD', 'dedTolls', 'dedIFTA', 'ded2290', 'dedRegRenewal', 'dedOther'];
      const bonuses = ['bonusLevel1', 'bonusLevel2', 'bonusLevel3', 'bonusOther'];
      
      let totalDed = 0;
      deductions.forEach(id => { totalDed += parseFloat(document.getElementById(id)?.value || 0); });
      
      let totalBonus = 0;
      bonuses.forEach(id => { totalBonus += parseFloat(document.getElementById(id)?.value || 0); });
      
      document.getElementById('totalDeductionsDisplay').textContent = totalDed.toFixed(2);
      document.getElementById('totalBonusesDisplay').textContent = totalBonus.toFixed(2);
    }

    async function generatePaystub(driverId, action = 'print') {
      // action can be: 'print', 'email', or 'both'
      const driver = appData.drivers.find(d => d.id === driverId);
      const selectedTripIds = Array.from(document.querySelectorAll('.paystub-trip:checked')).map(cb => parseInt(cb.value));
      
      if (selectedTripIds.length === 0) { showToast('Please select at least one trip', 'error'); return; }
      
      const stubNumber = document.getElementById('stubNumber').value;
      const checkNumber = document.getElementById('checkNumber').value;
      const periodStart = document.getElementById('periodStart').value;
      const periodEnd = document.getElementById('periodEnd').value;
      const payDate = document.getElementById('payDate').value;
      
      // Get itemized deductions
      const deductions = {
        insurance: parseFloat(document.getElementById('dedInsurance').value) || 0,
        fuel: parseFloat(document.getElementById('dedFuel').value) || 0,
        fuelDeposit: parseFloat(document.getElementById('dedFuelDeposit').value) || 0,
        eld: parseFloat(document.getElementById('dedELD').value) || 0,
        tolls: parseFloat(document.getElementById('dedTolls').value) || 0,
        ifta: parseFloat(document.getElementById('dedIFTA').value) || 0,
        hut2290: parseFloat(document.getElementById('ded2290').value) || 0,
        regRenewal: parseFloat(document.getElementById('dedRegRenewal').value) || 0,
        other: parseFloat(document.getElementById('dedOther').value) || 0
      };
      const totalDeductions = Object.values(deductions).reduce((a, b) => a + b, 0);
      
      // Get itemized bonuses
      const bonuses = {
        level1: parseFloat(document.getElementById('bonusLevel1').value) || 0,
        level2: parseFloat(document.getElementById('bonusLevel2').value) || 0,
        level3: parseFloat(document.getElementById('bonusLevel3').value) || 0,
        other: parseFloat(document.getElementById('bonusOther').value) || 0
      };
      const totalBonuses = Object.values(bonuses).reduce((a, b) => a + b, 0);
      
      // For backward compatibility
      const otherAdditions = totalBonuses;
      const otherDeductions = totalDeductions;
      
      // Gather all order data for selected trips
      let earnings = [];
      let totalRevenue = 0, totalBrokerFee = 0, totalLocalFee = 0, totalCleanGross = 0, totalDriverCut = 0;
      let totalCashCollected = 0, totalExpenses = 0;
      
      selectedTripIds.forEach(tripId => {
        const trip = appData.trips.find(t => t.id === tripId);
        const orders = appData.orders.filter(o => o.trip_id === tripId);
        const expenses = appData.expenses.filter(e => e.trip_id === tripId);
        const cutPercent = trip.driver_cut_percent || driver.cut_percent || 32;
        
        orders.forEach(o => {
          const revenue = parseFloat(o.revenue || 0);
          const brokerFee = parseFloat(o.broker_fee || 0);
          const localFee = parseFloat(o.local_fee || 0);
          const cleanGross = revenue - brokerFee - localFee;
          const driverCut = cleanGross * (cutPercent / 100);
          const isCash = o.payment_type === 'COD' || o.payment_type === 'COP';
          // For split payments, only count cod_amount as cash on hand
          const hasBillPortion = parseFloat(o.bill_amount || 0) > 0;
          const cashOnHand = isCash ? (hasBillPortion ? parseFloat(o.cod_amount || 0) : revenue) : 0;
          
          earnings.push({
            date: trip.trip_date,
            tripNumber: trip.trip_number,
            revenue,
            brokerFee,
            localFee,
            cleanGross,
            driverCut,
            cutPercent,
            cashOnHand,
            isCash
          });
          
          totalRevenue += revenue;
          totalBrokerFee += brokerFee;
          totalLocalFee += localFee;
          totalCleanGross += cleanGross;
          totalDriverCut += driverCut;
          if (isCash) totalCashCollected += cashOnHand;
        });
        
        // Only reimburse OTHER category expenses
        expenses.forEach(e => {
          if (e.category === 'OTHER') {
            totalExpenses += parseFloat(e.amount || 0);
          }
        });
      });
      
      const netPay = totalDriverCut - totalCashCollected + totalExpenses + otherAdditions - otherDeductions;
      
      // Calculate additional metrics for the statement
      const avgEarningsPerTrip = selectedTripIds.length > 0 ? totalDriverCut / selectedTripIds.length : 0;
      const avgRevenuePerLoad = earnings.length > 0 ? totalRevenue / earnings.length : 0;
      const cashCollectedPercent = totalDriverCut > 0 ? (totalCashCollected / totalDriverCut * 100) : 0;
      
      // Generate professional paystub HTML
      const paystubHTML = `
<!DOCTYPE html>
<html>
<head>
  <title>Earnings Statement - ${driver.first_name} ${driver.last_name}</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
      font-size: 12px; 
      background: #ffffff;
      color: #111827;
      line-height: 1.4;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    .page { max-width: 800px; margin: 0 auto; padding: 0; }
    
    /* Header */
    .header {
      background: #111827;
      color: #ffffff;
      padding: 24px 32px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .brand { display: flex; align-items: center; gap: 16px; }
    .brand-mark {
      width: 48px; height: 48px;
      background: #ffffff;
      color: #111827;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; font-weight: 700;
      letter-spacing: -1px;
    }
    .brand-text { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
    .brand-sub { font-size: 11px; opacity: 0.7; margin-top: 2px; font-weight: 400; }
    .doc-info { text-align: right; }
    .doc-title { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; opacity: 0.7; }
    .doc-type { font-size: 18px; font-weight: 600; margin: 4px 0 12px; }
    .doc-meta { font-size: 11px; opacity: 0.85; }
    .doc-meta-row { display: flex; justify-content: flex-end; gap: 24px; margin: 2px 0; }
    .doc-meta-label { opacity: 0.7; }
    .doc-meta-value { font-weight: 600; }
    
    /* Amount Banner */
    .amount-banner {
      background: ${netPay >= 0 ? '#047857' : '#b91c1c'};
      color: #ffffff;
      padding: 28px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .amount-label { font-size: 13px; text-transform: uppercase; letter-spacing: 1px; font-weight: 500; }
    .amount-value { font-size: 36px; font-weight: 700; letter-spacing: -1px; }
    
    /* Content Area */
    .content { padding: 24px 32px; background: #ffffff; }
    
    /* Driver Section */
    .driver-section {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding-bottom: 20px;
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 20px;
    }
    .driver-info h2 { font-size: 16px; font-weight: 600; color: #111827; }
    .driver-detail { font-size: 12px; color: #6b7280; margin-top: 4px; }
    .driver-stats { display: flex; gap: 32px; }
    .stat-block { text-align: right; }
    .stat-value { font-size: 18px; font-weight: 700; color: #111827; }
    .stat-label { font-size: 10px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; }
    
    /* Summary Grid */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    .summary-item {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 14px;
      text-align: center;
    }
    .summary-item.highlight { background: #f0fdf4; border-color: #bbf7d0; }
    .summary-item.negative { background: #fef2f2; border-color: #fecaca; }
    .summary-amount { font-size: 18px; font-weight: 700; color: #111827; }
    .summary-amount.green { color: #047857; }
    .summary-amount.red { color: #b91c1c; }
    .summary-label { font-size: 9px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
    
    /* Section Headers */
    .section-header {
      background: #f3f4f6;
      padding: 10px 16px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #374151;
      margin: 24px 0 0;
      border-left: 3px solid #111827;
    }
    
    /* Tables */
    table { width: 100%; border-collapse: collapse; margin-top: 0; }
    thead { background: #f9fafb; }
    th { 
      padding: 10px 8px; 
      text-align: left; 
      font-weight: 600; 
      color: #6b7280;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #e5e7eb;
    }
    td { 
      padding: 10px 8px; 
      border-bottom: 1px solid #f3f4f6;
      font-size: 11px;
    }
    .text-right { text-align: right; }
    .text-center { text-align: center; }
    .mono { font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 11px; }
    .text-green { color: #047857; }
    .text-red { color: #b91c1c; }
    .text-muted { color: #9ca3af; }
    .font-medium { font-weight: 500; }
    .font-semibold { font-weight: 600; }
    
    .total-row { background: #f3f4f6; }
    .total-row td { font-weight: 600; padding: 12px 8px; border-bottom: none; }
    
    .trip-badge {
      display: inline-block;
      background: #e5e7eb;
      color: #374151;
      padding: 2px 8px;
      font-size: 10px;
      font-weight: 500;
    }
    .cash-badge {
      display: inline-block;
      background: #dcfce7;
      color: #166534;
      padding: 2px 8px;
      font-size: 10px;
      font-weight: 500;
    }
    
    /* Two Column Layout */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      margin-top: 24px;
    }
    .col { padding: 16px; border: 1px solid #e5e7eb; }
    .col:first-child { border-right: none; }
    .col-header {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding-bottom: 12px;
      margin-bottom: 12px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .col-header.red { color: #b91c1c; border-color: #fecaca; }
    .col-header.green { color: #047857; border-color: #bbf7d0; }
    .col-icon {
      width: 20px; height: 20px;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 700;
    }
    .line-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 11px;
      border-bottom: 1px dashed #f3f4f6;
    }
    .line-item:last-of-type { border-bottom: none; }
    .line-total {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      margin-top: 12px;
      font-weight: 600;
      font-size: 12px;
    }
    .line-total.red { background: #fef2f2; color: #b91c1c; }
    .line-total.green { background: #f0fdf4; color: #047857; }
    .empty-state {
      text-align: center;
      padding: 20px;
      color: #9ca3af;
      font-size: 11px;
      font-style: italic;
    }
    
    /* Check Stub */
    .check-stub {
      margin-top: 32px;
      border: 2px solid #111827;
    }
    .check-header {
      background: #f9fafb;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #e5e7eb;
    }
    .check-company { font-size: 11px; color: #374151; }
    .check-company strong { display: block; color: #111827; font-size: 12px; margin-bottom: 2px; }
    .check-numbers { text-align: right; font-size: 11px; }
    .check-numbers strong { font-size: 13px; }
    .check-body {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .pay-to-label { font-size: 10px; color: #6b7280; text-transform: uppercase; }
    .pay-to-name { font-size: 16px; font-weight: 700; color: #111827; margin: 4px 0; }
    .check-amount-box {
      background: ${netPay >= 0 ? '#f0fdf4' : '#fef2f2'};
      border: 2px solid ${netPay >= 0 ? '#047857' : '#b91c1c'};
      padding: 12px 24px;
      text-align: center;
    }
    .check-amount-value {
      font-size: 24px;
      font-weight: 700;
      color: ${netPay >= 0 ? '#047857' : '#b91c1c'};
    }
    .check-footer {
      background: #111827;
      color: #ffffff;
      padding: 8px 20px;
      display: flex;
      justify-content: space-between;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    /* Footer */
    .footer {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
      text-align: center;
      font-size: 10px;
      color: #9ca3af;
    }
    
    /* Print Button */
    .print-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 24px;
      background: #111827;
      color: #ffffff;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .print-btn:hover { background: #1f2937; }
    
    @media print { 
      body { background: white; }
      .page { padding: 0; max-width: none; }
      .print-btn { display: none; }
    }
  </style>
</head>
<body>
  <button class="print-btn" onclick="window.print()">
    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2H5zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1z"/><path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2V7zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/></svg>
    Print Statement
  </button>
  
  <div class="page">
    <!-- Header -->
    <div class="header">
      <div class="brand">
        <div class="brand-mark">HS</div>
        <div>
          <div class="brand-text">HORIZON STAR</div>
          <div class="brand-sub">Transportation Services</div>
        </div>
      </div>
      <div class="doc-info">
        <div class="doc-title">Official Document</div>
        <div class="doc-type">Earnings Statement</div>
        <div class="doc-meta">
          <div class="doc-meta-row">
            <span><span class="doc-meta-label">Stub No.</span> <span class="doc-meta-value">${stubNumber}</span></span>
            <span><span class="doc-meta-label">Check No.</span> <span class="doc-meta-value">${checkNumber}</span></span>
          </div>
          <div class="doc-meta-row">
            <span><span class="doc-meta-label">Period</span> <span class="doc-meta-value">${formatDate(periodStart)} - ${formatDate(periodEnd)}</span></span>
          </div>
          <div class="doc-meta-row">
            <span><span class="doc-meta-label">Pay Date</span> <span class="doc-meta-value">${formatDate(payDate)}</span></span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Amount Banner -->
    <div class="amount-banner">
      <div class="amount-label">Net Pay This Period</div>
      <div class="amount-value">${formatMoney(netPay)}</div>
    </div>
    
    <div class="content">
      <!-- Driver Section -->
      <div class="driver-section">
        <div class="driver-info">
          <h2>${driver.first_name.toUpperCase()} ${driver.last_name.toUpperCase()}</h2>
          <div class="driver-detail">Driver | ${earnings.length > 0 ? earnings[0].cutPercent : driver.cut_percent}% Commission Rate</div>
        </div>
        <div class="driver-stats">
          <div class="stat-block">
            <div class="stat-value">${selectedTripIds.length}</div>
            <div class="stat-label">Trips</div>
          </div>
          <div class="stat-block">
            <div class="stat-value">${earnings.length}</div>
            <div class="stat-label">Loads</div>
          </div>
          <div class="stat-block">
            <div class="stat-value">${formatMoney(avgEarningsPerTrip)}</div>
            <div class="stat-label">Avg Per Trip</div>
          </div>
        </div>
      </div>
      
      <!-- Summary Grid -->
      <div class="summary-grid">
        <div class="summary-item highlight">
          <div class="summary-amount green">${formatMoney(totalDriverCut)}</div>
          <div class="summary-label">Gross Earnings</div>
        </div>
        <div class="summary-item negative">
          <div class="summary-amount red">-${formatMoney(totalCashCollected)}</div>
          <div class="summary-label">Cash Collected</div>
        </div>
        <div class="summary-item">
          <div class="summary-amount green">+${formatMoney(totalExpenses)}</div>
          <div class="summary-label">Reimbursements</div>
        </div>
        <div class="summary-item">
          <div class="summary-amount">${formatMoney(totalRevenue)}</div>
          <div class="summary-label">Total Revenue</div>
        </div>
      </div>
      
      <!-- Earnings Table -->
      <div class="section-header">Earnings Detail</div>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Trip</th>
            <th class="text-right">Revenue</th>
            <th class="text-right">Broker Fee</th>
            <th class="text-right">Local Fee</th>
            <th class="text-right">Clean Gross</th>
            <th class="text-right">Driver Cut</th>
            <th class="text-center">Rate</th>
            <th class="text-right">Cash</th>
          </tr>
        </thead>
        <tbody>
          ${earnings.map(e => `
            <tr>
              <td class="mono">${formatDate(e.date)}</td>
              <td><span class="trip-badge">${e.tripNumber}</span></td>
              <td class="text-right mono">${formatMoney(e.revenue)}</td>
              <td class="text-right mono text-red">${e.brokerFee > 0 ? '-' + formatMoney(e.brokerFee) : '<span class="text-muted">â€”</span>'}</td>
              <td class="text-right mono text-red">${e.localFee > 0 ? '-' + formatMoney(e.localFee) : '<span class="text-muted">â€”</span>'}</td>
              <td class="text-right mono font-medium">${formatMoney(e.cleanGross)}</td>
              <td class="text-right mono font-semibold text-green">${formatMoney(e.driverCut)}</td>
              <td class="text-center">${e.cutPercent.toFixed(0)}%</td>
              <td class="text-right">${e.cashOnHand > 0 ? '<span class="cash-badge">' + formatMoney(e.cashOnHand) + '</span>' : '<span class="text-muted">â€”</span>'}</td>
            </tr>
          `).join('')}
          <tr class="total-row">
            <td colspan="2">TOTAL</td>
            <td class="text-right mono">${formatMoney(totalRevenue)}</td>
            <td class="text-right mono text-red">-${formatMoney(totalBrokerFee)}</td>
            <td class="text-right mono text-red">-${formatMoney(totalLocalFee)}</td>
            <td class="text-right mono">${formatMoney(totalCleanGross)}</td>
            <td class="text-right mono text-green">${formatMoney(totalDriverCut)}</td>
            <td class="text-center">${earnings.length > 0 ? earnings[0].cutPercent.toFixed(0) : 0}%</td>
            <td class="text-right mono">${formatMoney(totalCashCollected)}</td>
          </tr>
        </tbody>
      </table>
      
      <!-- Deductions & Bonuses -->
      <div class="two-col">
        <div class="col">
          <div class="col-header red">
            <span class="col-icon">âˆ’</span>
            Deductions
          </div>
          ${totalDeductions > 0 ? `
            ${deductions.insurance > 0 ? `<div class="line-item"><span>Insurance (Cargo/Liability/Physical)</span><span class="text-red mono">-${formatMoney(deductions.insurance)}</span></div>` : ''}
            ${deductions.fuel > 0 ? `<div class="line-item"><span>Fuel</span><span class="text-red mono">-${formatMoney(deductions.fuel)}</span></div>` : ''}
            ${deductions.fuelDeposit > 0 ? `<div class="line-item"><span>Fuel Deposit</span><span class="text-red mono">-${formatMoney(deductions.fuelDeposit)}</span></div>` : ''}
            ${deductions.eld > 0 ? `<div class="line-item"><span>ELD</span><span class="text-red mono">-${formatMoney(deductions.eld)}</span></div>` : ''}
            ${deductions.tolls > 0 ? `<div class="line-item"><span>Tolls</span><span class="text-red mono">-${formatMoney(deductions.tolls)}</span></div>` : ''}
            ${deductions.ifta > 0 ? `<div class="line-item"><span>IFTA</span><span class="text-red mono">-${formatMoney(deductions.ifta)}</span></div>` : ''}
            ${deductions.hut2290 > 0 ? `<div class="line-item"><span>Highway Use Tax (2290)</span><span class="text-red mono">-${formatMoney(deductions.hut2290)}</span></div>` : ''}
            ${deductions.regRenewal > 0 ? `<div class="line-item"><span>Registration Renewal</span><span class="text-red mono">-${formatMoney(deductions.regRenewal)}</span></div>` : ''}
            ${deductions.other > 0 ? `<div class="line-item"><span>Other Deductions</span><span class="text-red mono">-${formatMoney(deductions.other)}</span></div>` : ''}
            <div class="line-total red">
              <span>Total Deductions</span>
              <span>-${formatMoney(totalDeductions)}</span>
            </div>
          ` : '<div class="empty-state">No deductions this period</div>'}
        </div>
        
        <div class="col">
          <div class="col-header green">
            <span class="col-icon">+</span>
            Bonuses & Additions
          </div>
          ${totalBonuses > 0 || totalExpenses > 0 ? `
            ${totalExpenses > 0 ? `<div class="line-item"><span>Expense Reimbursements</span><span class="text-green mono">+${formatMoney(totalExpenses)}</span></div>` : ''}
            ${bonuses.level1 > 0 ? `<div class="line-item"><span>Level I Inspection Bonus</span><span class="text-green mono">+${formatMoney(bonuses.level1)}</span></div>` : ''}
            ${bonuses.level2 > 0 ? `<div class="line-item"><span>Level II Inspection Bonus</span><span class="text-green mono">+${formatMoney(bonuses.level2)}</span></div>` : ''}
            ${bonuses.level3 > 0 ? `<div class="line-item"><span>Level III Inspection Bonus</span><span class="text-green mono">+${formatMoney(bonuses.level3)}</span></div>` : ''}
            ${bonuses.other > 0 ? `<div class="line-item"><span>Other Bonus</span><span class="text-green mono">+${formatMoney(bonuses.other)}</span></div>` : ''}
            <div class="line-total green">
              <span>Total Additions</span>
              <span>+${formatMoney(totalBonuses + totalExpenses)}</span>
            </div>
          ` : '<div class="empty-state">No bonuses this period</div>'}
        </div>
      </div>
      
      <!-- Check Stub -->
      <div class="check-stub">
        <div class="check-header">
          <div class="check-company">
            <strong>Horizon Star, LLC</strong>
            118 Mary Ambler Way, Ambler, PA 19002<br>
            (267) 334-1834
          </div>
          <div class="check-numbers">
            Check No. <strong>${checkNumber}</strong><br>
            Date: ${formatDate(payDate)}
          </div>
        </div>
        <div class="check-body">
          <div>
            <div class="pay-to-label">Pay to the order of</div>
            <div class="pay-to-name">${driver.first_name.toUpperCase()} ${driver.last_name.toUpperCase()}</div>
          </div>
          <div class="check-amount-box">
            <div class="check-amount-value">${formatMoney(netPay)}</div>
          </div>
        </div>
        <div class="check-footer">
          <span>This is not a negotiable instrument</span>
          <span>For record keeping purposes only</span>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="footer">
        Horizon Star, LLC | 118 Mary Ambler Way, Ambler, PA 19002 | (267) 334-1834<br>
        Statement generated ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}
      </div>
    </div>
  </div>
</body>
</html>`;
      
      // Handle based on action type
      const driverEmail = document.getElementById('driverEmail').value;
      const shouldPrint = action === 'print' || action === 'both';
      const shouldEmail = action === 'email' || action === 'both';
      
      // Open print window if needed
      if (shouldPrint) {
        const printWindow = window.open('', '_blank');
        printWindow.document.write(paystubHTML);
        printWindow.document.close();
      }
      
      // Send email directly via Supabase Edge Function if requested
      if (shouldEmail) {
        if (!driverEmail) {
          showToast('Please enter driver email address', 'error');
          return;
        }

        // Show sending indicator
        showToast('Sending email to ' + driverEmail + '...', 'info');

        try {
          const emailSubject = 'Earnings Statement - ' + driver.first_name + ' ' + driver.last_name + ' - Pay Date: ' + formatDate(payDate);

          // Send the full HTML earnings statement via Supabase Edge Function
          await sendEarningsEmail(
            driverEmail,
            driver.first_name + ' ' + driver.last_name,
            emailSubject,
            paystubHTML
          );
          
          showToast('Email sent successfully to ' + driverEmail + '!', 'success');
          
          // Log the activity
          await logActivity('PAYSTUB_EMAILED', {
            driver_id: driverId,
            driver_name: driver.first_name + ' ' + driver.last_name,
            email: driverEmail,
            stub_number: stubNumber,
            net_pay: netPay,
            period: formatDate(periodStart) + ' - ' + formatDate(periodEnd)
          });
          
        } catch (error) {
          console.error('Email send error:', error);
          showToast('Failed to send email: ' + (error.text || error.message || 'Unknown error'), 'error');
          return;
        }
      }
      
      document.querySelector('.modal-overlay').remove();
      if (shouldPrint && !shouldEmail) {
        showToast('Paystub generated! Print window opened.');
      } else if (!shouldPrint && shouldEmail) {
        // Already showed success message
      } else if (shouldPrint && shouldEmail) {
        showToast('Paystub printed and emailed successfully!');
      }
    }

    // Fixed Costs Management
    // ============ CONSOLIDATED FINANCIALS ============
    let finTab = 'executive'; // executive, analysis, overview, costs, trips, drivers, brokers, lanes
    
    function renderConsolidatedFinancials(c) {
      const trips = appData.trips || [];
      const orders = appData.orders || [];
      const trucks = appData.trucks || [];
      const drivers = appData.drivers || [];
      const fixedCosts = appData.fixed_costs || [];
      const variableCosts = appData.variable_costs || [];
      const maintenance = appData.maintenance_records || [];
      const fuelRecords = appData.fuel_transactions || [];
      
      // Calculate time period
      const tripDates = trips.filter(t => t.trip_date).map(t => parseTripDate(t.trip_date)).filter(d => d !== null);
      const minDate = tripDates.length > 0 ? new Date(Math.min(...tripDates)) : new Date();
      const maxDate = tripDates.length > 0 ? new Date(Math.max(...tripDates)) : new Date();
      const monthsInData = Math.max(1, Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24 * 30)));
      
      // â•â•â• REVENUE & COSTS FROM TRIPS â•â•â•
      let totalRevenue = 0, totalBrokerFees = 0, totalLocalFees = 0, totalDriverPay = 0, totalTripExpenses = 0;
      let totalMiles = 0, totalCars = 0;
      
      trips.forEach(t => {
        const fin = getTripFin(t.id);
        totalRevenue += fin.loadRevenue;
        totalBrokerFees += fin.brokerFee;
        totalLocalFees += fin.localFees;
        totalDriverPay += fin.driverCut;
        totalTripExpenses += fin.totalExpenses;
        totalMiles += parseFloat(t.miles || 0);
        totalCars += fin.vehicleCount;
      });
      
      // Fixed & Variable Costs
      const monthlyFixedCosts = fixedCosts.reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);
      const totalFixedCosts = monthlyFixedCosts * monthsInData;
      const totalFuelFromRecords = fuelRecords.reduce((sum, f) => sum + parseFloat(f.total_cost || 0), 0);
      const totalMaintenanceCost = maintenance.reduce((sum, m) => sum + parseFloat(m.total_cost || 0), 0);
      const totalOtherVariableCosts = variableCosts.reduce((sum, vc) => sum + parseFloat(vc.amount || 0), 0);
      const totalVariableCosts = totalFuelFromRecords + totalMaintenanceCost + totalOtherVariableCosts;
      
      // Calculate profits
      const cleanRevenue = totalRevenue - totalBrokerFees - totalLocalFees;
      const grossProfit = cleanRevenue - totalDriverPay;
      const operatingProfit = grossProfit - totalTripExpenses - totalVariableCosts;
      const netProfit = operatingProfit - totalFixedCosts;
      const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue * 100) : 0;
      
      // Per unit metrics
      const profitPerCar = totalCars > 0 ? netProfit / totalCars : 0;
      const profitPerMile = totalMiles > 0 ? netProfit / totalMiles : 0;
      const revenuePerMile = totalMiles > 0 ? totalRevenue / totalMiles : 0;
      const avgRevenuePerCar = totalCars > 0 ? totalRevenue / totalCars : 0;
      
      // Tabs
      const tabs = `
        <div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;">
          <button class="btn ${finTab === 'executive' ? 'btn-primary' : 'btn-secondary'}" style="padding:6px 12px;font-size:12px" onclick="finTab='executive';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ¢ Executive</button>
          <button class="btn ${finTab === 'analysis' ? 'btn-primary' : 'btn-secondary'}" style="padding:6px 12px;font-size:12px" onclick="finTab='analysis';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ“ˆ Analysis</button>
          <button class="btn ${finTab === 'overview' ? 'btn-primary' : 'btn-secondary'}" style="padding:6px 12px;font-size:12px" onclick="finTab='overview';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ“Š Overview</button>
          <button class="btn ${finTab === 'costs' ? 'btn-primary' : 'btn-secondary'}" style="padding:6px 12px;font-size:12px" onclick="finTab='costs';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ’¸ Costs</button>
          <button class="btn ${finTab === 'trips' ? 'btn-primary' : 'btn-secondary'}" style="padding:6px 12px;font-size:12px" onclick="finTab='trips';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸš› By Trip</button>
          <button class="btn ${finTab === 'drivers' ? 'btn-primary' : 'btn-secondary'}" style="padding:6px 12px;font-size:12px" onclick="finTab='drivers';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ‘¤ By Driver</button>
          <button class="btn ${finTab === 'brokers' ? 'btn-primary' : 'btn-secondary'}" style="padding:6px 12px;font-size:12px" onclick="finTab='brokers';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ¤ By Broker</button>
          <button class="btn ${finTab === 'lanes' ? 'btn-primary' : 'btn-secondary'}" style="padding:6px 12px;font-size:12px" onclick="finTab='lanes';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ—ºï¸ By Lane</button>
        </div>
      `;
      
      let content = '';
      
      // Route to original functions for Executive and Analysis
      if (finTab === 'executive') {
        renderExecutiveDashboard(c);
        return;
      } else if (finTab === 'analysis') {
        renderFinancialAnalysis(c);
        return;
      } else if (finTab === 'overview') {
        content = renderFinOverview(totalRevenue, cleanRevenue, grossProfit, operatingProfit, netProfit, profitMargin, totalCars, totalMiles, trips.length, monthlyFixedCosts, totalVariableCosts, totalDriverPay, totalBrokerFees, totalLocalFees, totalTripExpenses, profitPerCar, profitPerMile, revenuePerMile, avgRevenuePerCar);
      } else if (finTab === 'costs') {
        content = renderFinCosts(fixedCosts, variableCosts, monthlyFixedCosts, totalVariableCosts, totalFuelFromRecords, totalMaintenanceCost, totalOtherVariableCosts);
      } else if (finTab === 'trips') {
        content = renderFinByTrip(trips);
      } else if (finTab === 'drivers') {
        content = renderFinByDriver(trips, drivers);
      } else if (finTab === 'brokers') {
        content = renderFinByBroker(orders, trips);
      } else if (finTab === 'lanes') {
        content = renderFinByLane(orders, trips);
      }
      
      c.innerHTML = '<div class="header"><h2>ðŸ’° Financials</h2></div>' + tabs + content;
    }
    
    function renderFinOverview(totalRevenue, cleanRevenue, grossProfit, operatingProfit, netProfit, profitMargin, totalCars, totalMiles, tripCount, monthlyFixedCosts, totalVariableCosts, totalDriverPay, totalBrokerFees, totalLocalFees, totalTripExpenses, profitPerCar, profitPerMile, revenuePerMile, avgRevenuePerCar) {
      return `
        <div class="stats-grid" style="margin-bottom:24px;">
          <div class="stat-card" style="border-left:4px solid #22c55e">
            <div class="label">Total Revenue</div>
            <div class="value" style="color:#22c55e">${formatMoney(totalRevenue)}</div>
            <div style="font-size:12px;color:#64748b;margin-top:4px">${totalCars} cars â€¢ ${tripCount} trips</div>
          </div>
          <div class="stat-card" style="border-left:4px solid #3b82f6">
            <div class="label">Clean Revenue</div>
            <div class="value" style="color:#3b82f6">${formatMoney(cleanRevenue)}</div>
            <div style="font-size:12px;color:#64748b;margin-top:4px">After broker & local fees</div>
          </div>
          <div class="stat-card" style="border-left:4px solid ${netProfit >= 0 ? '#22c55e' : '#ef4444'}">
            <div class="label">Net Profit</div>
            <div class="value" style="color:${netProfit >= 0 ? '#22c55e' : '#ef4444'}">${formatMoney(netProfit)}</div>
            <div style="font-size:12px;color:#64748b;margin-top:4px">${profitMargin.toFixed(1)}% margin</div>
          </div>
          <div class="stat-card">
            <div class="label">Profit / Car</div>
            <div class="value">${formatMoney(profitPerCar)}</div>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;">
          <div class="card">
            <div class="card-header"><h3>ðŸ“ˆ Revenue Breakdown</h3></div>
            <div style="padding:20px;">
              <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #e2e8f0">
                <span>Gross Revenue</span><strong style="color:#22c55e">${formatMoney(totalRevenue)}</strong>
              </div>
              <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #e2e8f0">
                <span style="color:#ef4444">âˆ’ Broker Fees</span><span style="color:#ef4444">${formatMoney(totalBrokerFees)}</span>
              </div>
              <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #e2e8f0">
                <span style="color:#ef4444">âˆ’ Local Fees</span><span style="color:#ef4444">${formatMoney(totalLocalFees)}</span>
              </div>
              <div style="display:flex;justify-content:space-between;padding:12px 0;background:#f0fdf4;margin:0 -20px;padding-left:20px;padding-right:20px;">
                <strong>= Clean Revenue</strong><strong style="color:#22c55e">${formatMoney(cleanRevenue)}</strong>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header"><h3>ðŸ“‰ Expenses Breakdown</h3></div>
            <div style="padding:20px;">
              <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #e2e8f0">
                <span>Driver Pay</span><span style="color:#ef4444">${formatMoney(totalDriverPay)}</span>
              </div>
              <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #e2e8f0">
                <span>Trip Expenses (fuel, tolls)</span><span style="color:#ef4444">${formatMoney(totalTripExpenses)}</span>
              </div>
              <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #e2e8f0">
                <span>Variable Costs</span><span style="color:#ef4444">${formatMoney(totalVariableCosts)}</span>
              </div>
              <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #e2e8f0">
                <span>Fixed Costs (monthly)</span><span style="color:#ef4444">${formatMoney(monthlyFixedCosts)}/mo</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card" style="margin-top:24px;">
          <div class="card-header"><h3>ðŸ“Š Key Metrics</h3></div>
          <div style="padding:20px;display:grid;grid-template-columns:repeat(4,1fr);gap:20px;">
            <div style="text-align:center;padding:16px;background:#f8fafc;border-radius:8px;">
              <div style="font-size:24px;font-weight:700;color:#3b82f6">${formatMoney(revenuePerMile)}</div>
              <div style="font-size:13px;color:#64748b;margin-top:4px">Revenue / Mile</div>
            </div>
            <div style="text-align:center;padding:16px;background:#f8fafc;border-radius:8px;">
              <div style="font-size:24px;font-weight:700;color:#22c55e">${formatMoney(profitPerMile)}</div>
              <div style="font-size:13px;color:#64748b;margin-top:4px">Profit / Mile</div>
            </div>
            <div style="text-align:center;padding:16px;background:#f8fafc;border-radius:8px;">
              <div style="font-size:24px;font-weight:700;color:#8b5cf6">${formatMoney(avgRevenuePerCar)}</div>
              <div style="font-size:13px;color:#64748b;margin-top:4px">Avg Revenue / Car</div>
            </div>
            <div style="text-align:center;padding:16px;background:#f8fafc;border-radius:8px;">
              <div style="font-size:24px;font-weight:700;color:#f59e0b">${totalMiles.toLocaleString()}</div>
              <div style="font-size:13px;color:#64748b;margin-top:4px">Total Miles</div>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderFinCosts(fixedCosts, variableCosts, monthlyFixedCosts, totalVariableCosts, totalFuelFromRecords, totalMaintenanceCost, totalOtherVariableCosts) {
      const fixedRows = fixedCosts.length === 0 
        ? '<tr><td colspan="4" style="text-align:center;padding:20px;color:#64748b">No fixed costs yet</td></tr>'
        : fixedCosts.map(fc => `<tr><td><span class="badge badge-blue">${fc.category || 'OTHER'}</span></td><td>${fc.name}</td><td class="money">${formatMoney(fc.amount)}/mo</td><td><div class="actions"><button class="action-btn edit" onclick="openFixedCostModal(${fc.id})">Edit</button><button class="action-btn delete" onclick="deleteFixedCost(${fc.id})">Del</button></div></td></tr>`).join('');
      
      const varRows = variableCosts.length === 0
        ? '<tr><td colspan="5" style="text-align:center;padding:20px;color:#64748b">No variable costs yet</td></tr>'
        : variableCosts.map(vc => `<tr><td>${vc.date ? formatDate(vc.date) : '-'}</td><td><span class="badge badge-purple">${vc.category || 'OTHER'}</span></td><td>${vc.name || vc.description || '-'}</td><td class="money">${formatMoney(vc.amount)}</td><td><div class="actions"><button class="action-btn edit" onclick="openVariableCostModal(${vc.id})">Edit</button><button class="action-btn delete" onclick="deleteVariableCost(${vc.id})">Del</button></div></td></tr>`).join('');
      
      return `
        <div class="stats-grid" style="margin-bottom:24px;">
          <div class="stat-card" style="border-left:4px solid #ef4444">
            <div class="label">Monthly Fixed Costs</div>
            <div class="value" style="color:#ef4444">${formatMoney(monthlyFixedCosts)}</div>
          </div>
          <div class="stat-card" style="border-left:4px solid #f59e0b">
            <div class="label">Total Variable Costs</div>
            <div class="value" style="color:#f59e0b">${formatMoney(totalVariableCosts)}</div>
          </div>
          <div class="stat-card">
            <div class="label">Fuel (from records)</div>
            <div class="value">${formatMoney(totalFuelFromRecords)}</div>
          </div>
          <div class="stat-card">
            <div class="label">Maintenance</div>
            <div class="value">${formatMoney(totalMaintenanceCost)}</div>
          </div>
        </div>
        
        <div class="card" style="margin-bottom:24px;">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
            <h3>ðŸ¢ Fixed Costs (Monthly)</h3>
            <button class="btn btn-primary" onclick="openFixedCostModal()">+ Add</button>
          </div>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Category</th><th>Name</th><th>Amount</th><th>Actions</th></tr></thead>
              <tbody>${fixedRows}</tbody>
            </table>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
            <h3>ðŸ“ Variable Costs</h3>
            <button class="btn btn-primary" onclick="openVariableCostModal()">+ Add</button>
          </div>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Actions</th></tr></thead>
              <tbody>${varRows}</tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    function renderFinByTrip(trips) {
      const tripRows = trips.length === 0
        ? '<tr><td colspan="9" style="text-align:center;padding:40px;color:#64748b">No trips yet</td></tr>'
        : [...trips].sort((a, b) => b.id - a.id).slice(0, 50).map(t => {
            const fin = getTripFin(t.id);
            const driver = appData.drivers.find(d => d.id === t.driver_id);
            const profit = fin.netProfit;
            return `<tr>
              <td><strong>${t.trip_number || 'TRIP-' + t.id}</strong></td>
              <td>${driver ? driver.first_name + ' ' + driver.last_name : '-'}</td>
              <td>${t.trip_date ? formatDate(t.trip_date) : '-'}</td>
              <td>${fin.vehicleCount}</td>
              <td>${(t.miles || 0).toLocaleString()}</td>
              <td class="money">${formatMoney(fin.loadRevenue)}</td>
              <td class="money negative">${formatMoney(fin.brokerFee + fin.localFees)}</td>
              <td class="money negative">${formatMoney(fin.driverCut + fin.totalExpenses)}</td>
              <td class="money ${profit >= 0 ? '' : 'negative'}" style="font-weight:700;color:${profit >= 0 ? '#22c55e' : '#ef4444'}">${formatMoney(profit)}</td>
            </tr>`;
          }).join('');
      
      return `
        <div class="card">
          <div class="card-header"><h3>ðŸš› Profitability by Trip</h3></div>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Trip</th><th>Driver</th><th>Date</th><th>Cars</th><th>Miles</th><th>Revenue</th><th>Fees</th><th>Costs</th><th>Profit</th></tr></thead>
              <tbody>${tripRows}</tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    function renderFinByDriver(trips, drivers) {
      const driverStats = {};
      drivers.forEach(d => {
        driverStats[d.id] = { name: d.first_name + ' ' + d.last_name, trips: 0, cars: 0, miles: 0, revenue: 0, profit: 0, driverPay: 0 };
      });
      
      trips.forEach(t => {
        if (t.driver_id && driverStats[t.driver_id]) {
          const fin = getTripFin(t.id);
          driverStats[t.driver_id].trips++;
          driverStats[t.driver_id].cars += fin.vehicleCount;
          driverStats[t.driver_id].miles += parseFloat(t.miles || 0);
          driverStats[t.driver_id].revenue += fin.loadRevenue;
          driverStats[t.driver_id].profit += fin.netProfit;
          driverStats[t.driver_id].driverPay += fin.driverCut;
        }
      });
      
      const driverList = Object.values(driverStats).filter(d => d.trips > 0).sort((a, b) => b.profit - a.profit);
      
      const rows = driverList.length === 0
        ? '<tr><td colspan="8" style="text-align:center;padding:40px;color:#64748b">No driver data yet</td></tr>'
        : driverList.map(d => `<tr>
            <td><strong>${d.name}</strong></td>
            <td>${d.trips}</td>
            <td>${d.cars}</td>
            <td>${d.miles.toLocaleString()}</td>
            <td class="money">${formatMoney(d.revenue)}</td>
            <td class="money">${formatMoney(d.driverPay)}</td>
            <td class="money ${d.profit >= 0 ? '' : 'negative'}" style="font-weight:700;color:${d.profit >= 0 ? '#22c55e' : '#ef4444'}">${formatMoney(d.profit)}</td>
            <td>${d.cars > 0 ? formatMoney(d.profit / d.cars) : '-'}</td>
          </tr>`).join('');
      
      return `
        <div class="card">
          <div class="card-header"><h3>ðŸ‘¤ Profitability by Driver</h3></div>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Driver</th><th>Trips</th><th>Cars</th><th>Miles</th><th>Revenue</th><th>Driver Pay</th><th>Net Profit</th><th>Profit/Car</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    function renderFinByBroker(orders, trips) {
      const brokerStats = {};
      
      orders.forEach(o => {
        const brokerName = o.broker_name || 'Unknown';
        if (!brokerStats[brokerName]) {
          brokerStats[brokerName] = { revenue: 0, brokerFee: 0, localFee: 0, cars: 0, trips: new Set() };
        }
        brokerStats[brokerName].revenue += parseFloat(o.revenue || 0);
        brokerStats[brokerName].brokerFee += parseFloat(o.broker_fee || 0);
        brokerStats[brokerName].localFee += parseFloat(o.local_fee || 0);
        brokerStats[brokerName].cars++;
        if (o.trip_id) brokerStats[brokerName].trips.add(o.trip_id);
      });
      
      const brokerList = Object.entries(brokerStats)
        .map(([name, data]) => ({
          name,
          revenue: data.revenue,
          brokerFee: data.brokerFee,
          cleanRevenue: data.revenue - data.brokerFee - data.localFee,
          feePercent: data.revenue > 0 ? (data.brokerFee / data.revenue * 100) : 0,
          cars: data.cars,
          trips: data.trips.size
        }))
        .sort((a, b) => b.cleanRevenue - a.cleanRevenue);
      
      const rows = brokerList.length === 0
        ? '<tr><td colspan="7" style="text-align:center;padding:40px;color:#64748b">No broker data yet</td></tr>'
        : brokerList.map(b => `<tr>
            <td><strong>${b.name}</strong></td>
            <td>${b.trips}</td>
            <td>${b.cars}</td>
            <td class="money">${formatMoney(b.revenue)}</td>
            <td class="money negative">${formatMoney(b.brokerFee)} <span style="color:#64748b;font-size:11px">(${b.feePercent.toFixed(1)}%)</span></td>
            <td class="money" style="color:#22c55e;font-weight:700">${formatMoney(b.cleanRevenue)}</td>
            <td>${b.cars > 0 ? formatMoney(b.cleanRevenue / b.cars) : '-'}</td>
          </tr>`).join('');
      
      return `
        <div class="card">
          <div class="card-header"><h3>ðŸ¤ Profitability by Broker</h3></div>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Broker</th><th>Trips</th><th>Cars</th><th>Revenue</th><th>Broker Fee</th><th>Clean Revenue</th><th>Per Car</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    function renderFinByLane(orders, trips) {
      const laneStats = {};
      
      orders.forEach(o => {
        if (!o.origin || !o.destination) return;
        const originState = extractState(o.origin);
        const destState = extractState(o.destination);
        const lane = originState + ' â†’ ' + destState;
        
        if (!laneStats[lane]) {
          laneStats[lane] = { revenue: 0, cleanRevenue: 0, miles: 0, cars: 0, trips: new Set() };
        }
        
        const revenue = parseFloat(o.revenue || 0);
        const brokerFee = parseFloat(o.broker_fee || 0);
        const localFee = parseFloat(o.local_fee || 0);
        
        laneStats[lane].revenue += revenue;
        laneStats[lane].cleanRevenue += revenue - brokerFee - localFee;
        laneStats[lane].cars++;
        if (o.trip_id) {
          laneStats[lane].trips.add(o.trip_id);
          const trip = trips.find(t => t.id === o.trip_id);
          if (trip) {
            const tripOrderCount = orders.filter(ord => ord.trip_id === o.trip_id).length || 1;
            laneStats[lane].miles += parseFloat(trip.miles || 0) / tripOrderCount;
          }
        }
      });
      
      const laneList = Object.entries(laneStats)
        .map(([lane, data]) => ({
          lane,
          revenue: data.revenue,
          cleanRevenue: data.cleanRevenue,
          cars: data.cars,
          trips: data.trips.size,
          miles: Math.round(data.miles),
          rpm: data.miles > 0 ? data.revenue / data.miles : 0
        }))
        .sort((a, b) => b.cleanRevenue - a.cleanRevenue)
        .slice(0, 20);
      
      const rows = laneList.length === 0
        ? '<tr><td colspan="7" style="text-align:center;padding:40px;color:#64748b">No lane data yet</td></tr>'
        : laneList.map(l => `<tr>
            <td><strong>${l.lane}</strong></td>
            <td>${l.trips}</td>
            <td>${l.cars}</td>
            <td>${l.miles.toLocaleString()}</td>
            <td class="money">${formatMoney(l.revenue)}</td>
            <td class="money" style="color:#22c55e;font-weight:700">${formatMoney(l.cleanRevenue)}</td>
            <td>${formatMoney(l.rpm)}/mi</td>
          </tr>`).join('');
      
      return `
        <div class="card">
          <div class="card-header"><h3>ðŸ—ºï¸ Profitability by Lane</h3></div>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Lane</th><th>Trips</th><th>Cars</th><th>Miles</th><th>Revenue</th><th>Clean Revenue</th><th>Rev/Mile</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>
      `;
    }
    function renderFixedCosts(c) {
      const costs = appData.fixed_costs || [];
      const totalMonthly = costs.reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);
      
      c.innerHTML = '<div class="header"><h2>ðŸ¢ Fixed Costs (Monthly)</h2><div style="display:flex;gap:12px"><button class="btn btn-secondary" onclick="openSetupWizard()">ðŸ§™â€â™‚ï¸ Setup Wizard</button><button class="btn btn-primary" onclick="openFixedCostModal()">+ Add Fixed Cost</button></div></div>' +
        '<div style="background:#dbeafe;border:1px solid #93c5fd;border-radius:8px;padding:16px;margin-bottom:24px"><strong style="color:#1d4ed8">ðŸ’¡ Fixed Costs</strong><p style="color:#1e40af;margin-top:8px">Enter your monthly fixed business expenses here. These will be included in the Financial Analysis report.</p></div>' +
        '<div class="stats-grid" style="margin-bottom:24px"><div class="stat-card" style="border-left:4px solid #ef4444"><div class="label">Total Monthly Fixed Costs</div><div class="value" style="color:#dc2626">' + formatMoney(totalMonthly) + '</div></div><div class="stat-card"><div class="label">Annual Fixed Costs</div><div class="value">' + formatMoney(totalMonthly * 12) + '</div></div></div>' +
        '<div class="card"><div class="table-wrapper"><table><thead><tr><th>Category</th><th>Name</th><th>Monthly Amount</th><th>Actions</th></tr></thead><tbody>' +
        (costs.length === 0 ? '<tr><td colspan="4" style="text-align:center;padding:40px"><div style="margin-bottom:16px">No fixed costs yet.</div><button class="btn btn-primary" onclick="openSetupWizard()" style="font-size:16px;padding:12px 24px">ðŸ§™â€â™‚ï¸ Start Setup Wizard</button><div style="margin-top:12px;color:#64748b;font-size:13px">Walk through entering all your expenses step-by-step</div></td></tr>' :
        costs.map(fc => '<tr><td><span class="badge badge-blue">' + (fc.category || 'OTHER') + '</span></td><td><strong>' + fc.name + '</strong></td><td class="money">' + formatMoney(fc.amount) + '</td><td><div class="actions"><button class="action-btn edit" onclick="openFixedCostModal(' + fc.id + ')">Edit</button><button class="action-btn delete" onclick="deleteFixedCost(' + fc.id + ')">Del</button></div></td></tr>').join('')) +
        '</tbody></table></div></div>';
    }

    function openFixedCostModal(id = null) {
      const fc = id ? appData.fixed_costs.find(x => x.id === id) : null;
      const categories = ['INSURANCE', 'RENT', 'SALARY', 'LEASE_PAYMENT', 'DISPATCH', 'PARKING', 'TOLLS_FIXED', 'REGISTRATION', 'SOFTWARE', 'OTHER'];
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:450px"><div class="modal-header"><h3>' + (fc ? 'Edit' : 'Add') + ' Fixed Cost</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body"><div class="form-group"><label>Category</label><select id="fcCategory">' + categories.map(cat => '<option value="' + cat + '"' + (fc?.category === cat ? ' selected' : '') + '>' + cat.replace('_', ' ') + '</option>').join('') + '</select></div><div class="form-group"><label>Name / Description</label><input id="fcName" value="' + (fc?.name || '') + '" placeholder="e.g., Truck 10 Lease Payment"></div><div class="form-group"><label>Monthly Amount $</label><input type="number" id="fcAmount" value="' + (fc?.amount || '') + '" placeholder="e.g., 2750"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveFixedCost(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    async function saveFixedCost(id) {
      const data = { category: document.getElementById('fcCategory').value, name: document.getElementById('fcName').value, amount: parseFloat(document.getElementById('fcAmount').value) || 0 };
      try { 
        if (id) { 
          await dbUpdate('fixed_costs', id, data); 
          await logActivity('FIXED_COST_UPDATED', { cost_id: id, category: data.category, name: data.name, amount: data.amount });
        } else { 
          const newCost = await dbInsert('fixed_costs', data); 
          await logActivity('FIXED_COST_CREATED', { cost_id: newCost.id, category: data.category, name: data.name, amount: data.amount });
        } 
        document.querySelector('.modal-overlay').remove(); showToast('Saved!'); await loadAllData(); renderFixedCosts(document.getElementById('main-content')); 
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteFixedCost(id) { 
      if (!confirm('Delete this fixed cost?')) return; 
      const cost = (appData.fixed_costs || []).find(fc => fc.id === id);
      await dbDelete('fixed_costs', id); 
      await logActivity('FIXED_COST_DELETED', { cost_id: id, category: cost?.category, name: cost?.name, amount: cost?.amount });
      showToast('Deleted'); await loadAllData(); renderFixedCosts(document.getElementById('main-content')); 
    }

    // ============ VARIABLE COSTS ============
    const variableCostCategories = [
      { id: 'TOLLS', name: 'Tolls', icon: 'ðŸ›£ï¸' },
      { id: 'LUMPER', name: 'Lumper Fees', icon: 'ðŸ“¦' },
      { id: 'DETENTION', name: 'Detention', icon: 'â±ï¸' },
      { id: 'TONU', name: 'TONU (Truck Order Not Used)', icon: 'âŒ' },
      { id: 'DEF', name: 'DEF Fluid', icon: 'ðŸ’§' },
      { id: 'TRUCK_WASH', name: 'Truck Wash', icon: 'ðŸš¿' },
      { id: 'PARKING', name: 'Parking Fees', icon: 'ðŸ…¿ï¸' },
      { id: 'SCALE', name: 'Scale/Weigh Station', icon: 'âš–ï¸' },
      { id: 'PERMITS', name: 'Permits', icon: 'ðŸ“‹' },
      { id: 'DRIVER_ADVANCE', name: 'Driver Advance', icon: 'ðŸ’µ' },
      { id: 'REPAIRS_ROAD', name: 'Road Repairs', icon: 'ðŸ”§' },
      { id: 'TOWING', name: 'Towing', icon: 'ðŸš›' },
      { id: 'TICKETS', name: 'Tickets/Fines', icon: 'ðŸŽ«' },
      { id: 'OTHER', name: 'Other', icon: 'ðŸ“' }
    ];
    
    let varCostFilter = 'all';
    let varCostMonth = new Date().getMonth() + 1;
    let varCostYear = new Date().getFullYear();
    
    function renderVariableCosts(c) {
      const costs = appData.variable_costs || [];
      
      // Filter by month/year
      const filtered = varCostFilter === 'all' ? costs : costs.filter(vc => {
        if (!vc.date) return false;
        const d = new Date(vc.date);
        return d.getMonth() + 1 === varCostMonth && d.getFullYear() === varCostYear;
      });
      
      // Calculate totals
      const totalAll = costs.reduce((s, vc) => s + parseFloat(vc.amount || 0), 0);
      const totalFiltered = filtered.reduce((s, vc) => s + parseFloat(vc.amount || 0), 0);
      
      // Group by category
      const byCategory = {};
      variableCostCategories.forEach(cat => byCategory[cat.id] = 0);
      filtered.forEach(vc => {
        if (byCategory[vc.category] !== undefined) byCategory[vc.category] += parseFloat(vc.amount || 0);
        else byCategory['OTHER'] += parseFloat(vc.amount || 0);
      });
      
      // Sort by date desc
      const sorted = [...filtered].sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
      
      // Build category summary cards
      const categoryCards = variableCostCategories
        .filter(cat => byCategory[cat.id] > 0)
        .sort((a, b) => byCategory[b.id] - byCategory[a.id])
        .map(cat => '<div style="background:#f8fafc;padding:12px;border-radius:8px;text-align:center;min-width:120px"><div style="font-size:20px">' + cat.icon + '</div><div style="font-size:11px;color:#64748b;margin:4px 0">' + cat.name + '</div><div style="font-weight:700;color:#1e293b">' + formatMoney(byCategory[cat.id]) + '</div></div>').join('');
      
      const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      
      c.innerHTML = '<div class="header"><h2>ðŸ“Š Variable Costs</h2><button class="btn btn-primary" onclick="openVariableCostModal()">+ Add Expense</button></div>' +
        
        '<div style="background:#fef3c7;border:1px solid #fcd34d;border-radius:8px;padding:16px;margin-bottom:24px"><strong style="color:#92400e">ðŸ’¡ Variable Costs</strong><p style="color:#a16207;margin-top:8px">Track expenses that vary based on operations: tolls, lumper fees, DEF, parking, etc. These are included in the Profitability Dashboard.</p></div>' +
        
        // Period Filter
        '<div style="display:flex;gap:12px;align-items:center;margin-bottom:20px;flex-wrap:wrap">' +
        '<button class="btn ' + (varCostFilter === 'all' ? 'btn-primary' : 'btn-secondary') + '" onclick="setVarCostFilter(\'all\')">All Time</button>' +
        '<button class="btn ' + (varCostFilter === 'month' ? 'btn-primary' : 'btn-secondary') + '" onclick="setVarCostFilter(\'month\')">By Month</button>' +
        (varCostFilter === 'month' ? '<select onchange="setVarCostMonth(this.value)" style="padding:8px;border-radius:6px;border:1px solid #d1d5db">' + months.slice(1).map((m, i) => '<option value="' + (i + 1) + '"' + (varCostMonth === i + 1 ? ' selected' : '') + '>' + m + '</option>').join('') + '</select>' +
        '<select onchange="setVarCostYear(this.value)" style="padding:8px;border-radius:6px;border:1px solid #d1d5db">' + [2023, 2024, 2025, 2026, 2027].map(y => '<option value="' + y + '"' + (varCostYear === y ? ' selected' : '') + '>' + y + '</option>').join('') + '</select>' : '') +
        '</div>' +
        
        // Stats
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:130px;padding:12px 16px;border-left:4px solid #f59e0b"><div class="label">' + (varCostFilter === 'all' ? 'All Time' : months[varCostMonth] + ' ' + varCostYear) + ' Total</div><div class="value" style="color:#d97706">' + formatMoney(totalFiltered) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Total Entries</div><div class="value">' + filtered.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px"><div class="label">All Time Total</div><div class="value">' + formatMoney(totalAll) + '</div></div>' +
        '</div>' +
        
        // Category breakdown
        (categoryCards ? '<div style="margin-bottom:24px"><h4 style="margin-bottom:12px;color:#475569">By Category</h4><div style="display:flex;gap:12px;flex-wrap:wrap">' + categoryCards + '</div></div>' : '') +
        
        // Table
        '<div class="card"><div class="card-header"><h3>ðŸ“‹ All Variable Expenses</h3><button class="btn btn-secondary btn-sm" onclick="exportVariableCostsCSV()">ðŸ“Š Export</button></div><div class="table-wrapper"><table><thead><tr><th>Date</th><th>Category</th><th>Truck</th><th>Amount</th><th>Notes</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        (sorted.length === 0 ? '<tr><td colspan="6" style="text-align:center;padding:40px">No variable costs recorded yet.</td></tr>' :
        sorted.map(vc => {
          const cat = variableCostCategories.find(c => c.id === vc.category) || { icon: 'ðŸ“', name: vc.category };
          const truck = appData.trucks.find(t => t.id === vc.truck_id);
          return '<tr><td>' + formatDate(vc.date) + '</td><td>' + cat.icon + ' ' + cat.name + '</td><td>' + (truck ? '#' + truck.truck_number : '-') + '</td><td class="money" style="color:#d97706;font-weight:600">' + formatMoney(vc.amount) + '</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + (vc.notes || '-') + '</td><td class="sticky-col"><div class="actions"><button class="action-btn edit" onclick="openVariableCostModal(' + vc.id + ')">Edit</button><button class="action-btn delete" onclick="deleteVariableCost(' + vc.id + ')">Del</button></div></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }
    
    function setVarCostFilter(f) { varCostFilter = f; renderVariableCosts(document.getElementById('main-content')); }
    function setVarCostMonth(m) { varCostMonth = parseInt(m); renderVariableCosts(document.getElementById('main-content')); }
    function setVarCostYear(y) { varCostYear = parseInt(y); renderVariableCosts(document.getElementById('main-content')); }
    
    function openVariableCostModal(id = null) {
      const vc = id ? (appData.variable_costs || []).find(x => x.id === id) : null;
      const truckOptions = appData.trucks.map(t => '<option value="' + t.id + '"' + (vc?.truck_id === t.id ? ' selected' : '') + '>#' + t.truck_number + '</option>').join('');
      const catOptions = variableCostCategories.map(cat => '<option value="' + cat.id + '"' + (vc?.category === cat.id ? ' selected' : '') + '>' + cat.icon + ' ' + cat.name + '</option>').join('');
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:480px"><div class="modal-header"><h3>' + (vc ? 'Edit' : 'Add') + ' Variable Cost</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body">' +
        '<div class="form-row"><div class="form-group"><label>Date *</label><input type="date" id="vcDate" value="' + (vc?.date || new Date().toISOString().split('T')[0]) + '"></div>' +
        '<div class="form-group"><label>Amount $ *</label><input type="number" step="0.01" id="vcAmount" value="' + (vc?.amount || '') + '" placeholder="0.00"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Category *</label><select id="vcCategory">' + catOptions + '</select></div>' +
        '<div class="form-group"><label>Truck (Optional)</label><select id="vcTruck"><option value="">-- No Truck --</option>' + truckOptions + '</select></div></div>' +
        '<div class="form-group"><label>Trip # (Optional)</label><input id="vcTrip" value="' + (vc?.trip_number || '') + '" placeholder="e.g., T-1234"></div>' +
        '<div class="form-group"><label>Notes</label><textarea id="vcNotes" rows="2" placeholder="Additional details...">' + (vc?.notes || '') + '</textarea></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveVariableCost(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function saveVariableCost(id) {
      const data = {
        date: document.getElementById('vcDate').value,
        amount: parseFloat(document.getElementById('vcAmount').value) || 0,
        category: document.getElementById('vcCategory').value,
        truck_id: parseInt(document.getElementById('vcTruck').value) || null,
        trip_number: document.getElementById('vcTrip').value || null,
        notes: document.getElementById('vcNotes').value || null
      };
      
      if (!data.date || !data.amount) { showToast('Date and Amount are required', 'error'); return; }
      
      try {
        const truck = data.truck_id ? appData.trucks.find(t => t.id === data.truck_id) : null;
        if (id) {
          await dbUpdate('variable_costs', id, data);
          await logActivity('VARIABLE_COST_UPDATED', { cost_id: id, category: data.category, amount: data.amount, truck_number: truck?.truck_number });
        } else {
          const newCost = await dbInsert('variable_costs', data);
          await logActivity('VARIABLE_COST_CREATED', { cost_id: newCost.id, category: data.category, amount: data.amount, truck_number: truck?.truck_number });
        }
        document.querySelector('.modal-overlay').remove();
        showToast('Variable cost saved!');
        await loadAllData();
        renderVariableCosts(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }
    
    async function deleteVariableCost(id) {
      if (!confirm('Delete this expense?')) return;
      try {
        const cost = (appData.variable_costs || []).find(vc => vc.id === id);
        await dbDelete('variable_costs', id);
        await logActivity('VARIABLE_COST_DELETED', { cost_id: id, category: cost?.category, amount: cost?.amount });
        showToast('Deleted');
        await loadAllData();
        renderVariableCosts(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }
    
    function exportVariableCostsCSV() {
      const costs = appData.variable_costs || [];
      if (costs.length === 0) { showToast('No data to export', 'error'); return; }
      
      const headers = ['Date', 'Category', 'Truck #', 'Trip #', 'Amount', 'Notes'];
      const rows = costs.map(vc => {
        const truck = appData.trucks.find(t => t.id === vc.truck_id);
        const cat = variableCostCategories.find(c => c.id === vc.category);
        return [
          vc.date || '',
          cat ? cat.name : vc.category,
          truck ? truck.truck_number : '',
          vc.trip_number || '',
          vc.amount || 0,
          (vc.notes || '').replace(/"/g, '""')
        ].map(v => '"' + v + '"').join(',');
      });
      
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'variable_costs_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
      showToast('Exported ' + costs.length + ' records!');
    }

    // Financial Analysis Report
    let finPeriodType = 'month';
    let finYear = new Date().getFullYear();
    let finMonth = new Date().getMonth() + 1;
    let finQuarter = Math.ceil(finMonth / 3);

    function renderFinancialAnalysis(c) {
      const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const numTrucks = appData.trucks.filter(t => t.status === 'ACTIVE').length || 1;
      const monthlyFixedCosts = (appData.fixed_costs || []).reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);
      
      // ============ ALL-TIME CALCULATIONS FOR "AT A GLANCE" ============
      let allTimeRevenue = 0, allTimeBrokerFees = 0, allTimeLocalFees = 0, allTimeDriverCut = 0, allTimeExpenses = 0, allTimeMiles = 0, allTimeCars = 0;
      const allTimeFuelCosts = { FUEL: 0, TOLLS: 0, PERMITS: 0, PARKING: 0, MAINTENANCE: 0, OTHER: 0 };
      
      appData.trips.forEach(t => {
        const f = getTripFin(t.id);
        allTimeRevenue += f.loadRevenue;
        allTimeBrokerFees += f.brokerFee;
        allTimeLocalFees += f.localFees;
        allTimeDriverCut += f.driverCut;
        allTimeExpenses += f.totalExpenses;
        allTimeMiles += parseFloat(t.miles || 0);
        allTimeCars += f.vehicleCount;
        
        const tripExpenses = appData.expenses.filter(e => e.trip_id === t.id);
        tripExpenses.forEach(e => {
          if (allTimeFuelCosts[e.category] !== undefined) allTimeFuelCosts[e.category] += parseFloat(e.amount || 0);
          else allTimeFuelCosts.OTHER += parseFloat(e.amount || 0);
        });
      });
      
      const allTimeTripCount = appData.trips.length;
      const allTimeCleanGross = allTimeRevenue - allTimeBrokerFees - allTimeLocalFees;
      const allTimeDirectTripExpenses = allTimeBrokerFees + allTimeLocalFees + allTimeDriverCut + allTimeExpenses; // All trip costs
      const allTimeNetProfit = allTimeRevenue - allTimeDirectTripExpenses; // Revenue - All Trip Costs
      const allTimeTruckGross = allTimeCleanGross - allTimeDriverCut; // Keep for backward compatibility
      
      // Calculate avg driver cut percentage
      let totalCutPercent = 0;
      appData.trips.forEach(t => totalCutPercent += parseFloat(t.driver_cut_percent || 32));
      const avgDriverCutPercent = allTimeTripCount > 0 ? totalCutPercent / allTimeTripCount : 32;
      
      // All-time metrics
      const allTimeAvgPPC = allTimeCars > 0 ? allTimeRevenue / allTimeCars : 0;
      const allTimeAvgPPM = allTimeMiles > 0 ? allTimeRevenue / allTimeMiles : 0;
      const allTimeAvgCarsPerTrip = allTimeTripCount > 0 ? allTimeCars / allTimeTripCount : 0;
      const allTimeAvgMilesPerTrip = allTimeTripCount > 0 ? allTimeMiles / allTimeTripCount : 0;
      const allTimeAvgExpensePerTrip = allTimeTripCount > 0 ? allTimeExpenses / allTimeTripCount : 0;
      const allTimeAvgFuelPerMile = allTimeMiles > 0 ? allTimeFuelCosts.FUEL / allTimeMiles : 0;
      
      // Calculate break-even PPC
      // New formula: Net Profit = Clean Gross - Direct Trip Costs - Fixed Costs
      // Clean Gross = Revenue - Broker Fees - Local Fees
      // Direct Trip Costs = Driver Cut + Expenses
      // To break even: 0 = Clean Gross - Direct Trip Costs - Fixed Costs
      const brokerFeeRatio = allTimeRevenue > 0 ? allTimeBrokerFees / allTimeRevenue : 0;
      const localFeeRatio = allTimeRevenue > 0 ? allTimeLocalFees / allTimeRevenue : 0;
      const driverCutRatio = avgDriverCutPercent / 100;
      
      // Revenue needed per month to break even:
      // Clean Gross = Revenue * (1 - brokerRatio - localRatio)
      // Driver Cut = Clean Gross * driverRatio
      // Net Profit = Clean Gross - Driver Cut - Expenses - Fixed Costs = 0
      // Revenue * (1 - brokerRatio - localRatio) * (1 - driverRatio) = expenses + Fixed Costs
      // Calculate avg monthly direct costs from trips (includes all trip costs)
      const tripDates = appData.trips.map(t => parseTripDate(t.trip_date)).filter(d => d !== null);
      const minDate = tripDates.length > 0 ? new Date(Math.min(...tripDates)) : new Date();
      const maxDate = tripDates.length > 0 ? new Date(Math.max(...tripDates)) : new Date();
      const monthsOfData = Math.max(1, Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24 * 30)));
      const avgMonthlyDirectExpenses = allTimeDirectTripExpenses / monthsOfData;
      const avgMonthlyTrips = allTimeTripCount / monthsOfData;
      const avgMonthlyCars = allTimeCars / monthsOfData;
      
      const truckGrossRatio = (1 - brokerFeeRatio - localFeeRatio) * (1 - driverCutRatio);
      const breakEvenMonthlyRevenue = truckGrossRatio > 0 ? (monthlyFixedCosts + avgMonthlyDirectExpenses) / truckGrossRatio : 0;
      const breakEvenPPC = avgMonthlyCars > 0 ? breakEvenMonthlyRevenue / avgMonthlyCars : 0;
      const currentProfitPerCar = allTimeCars > 0 ? allTimeNetProfit / allTimeCars : 0;
      const ppcGap = breakEvenPPC - allTimeAvgPPC;
      
      // Profit trajectory (current vs needed) - using new formula
      const currentMonthlyProfit = allTimeNetProfit / monthsOfData - monthlyFixedCosts;
      const isProfitable = currentMonthlyProfit >= 0;
      
      // ============ PERIOD CALCULATIONS ============
      let filteredTrips = [];
      let periodLabel = '';
      
      if (finPeriodType === 'month') {
        filteredTrips = appData.trips.filter(t => {
          const d = parseTripDate(t.trip_date);
          return d && d.getFullYear() === finYear && (d.getMonth() + 1) === finMonth;
        });
        periodLabel = months[finMonth] + ' ' + finYear;
      } else if (finPeriodType === 'quarter') {
        const qMonths = [(finQuarter-1)*3+1, (finQuarter-1)*3+2, (finQuarter-1)*3+3];
        filteredTrips = appData.trips.filter(t => {
          const d = parseTripDate(t.trip_date);
          return d && d.getFullYear() === finYear && qMonths.includes(d.getMonth() + 1);
        });
        periodLabel = 'Q' + finQuarter + ' ' + finYear;
      } else {
        filteredTrips = appData.trips.filter(t => {
          const d = parseTripDate(t.trip_date);
          return d && d.getFullYear() === finYear;
        });
        periodLabel = 'Year ' + finYear;
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ðŸ“Š CAR VOLUME TRACKING BY TIMEFRAME
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Normalize to start of day
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth() + 1;
      const currentQuarter = Math.ceil(currentMonth / 3);
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ðŸš— CAR VOLUME TRACKING BY IMPORT DATE (created_at)
      // Tracks when vehicles were added to TMS, not trip date
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      // Helper: Get orders imported in date range (by created_at)
      const getOrdersInRange = (startDate, endDate) => appData.orders.filter(o => {
        if (!o.created_at) return false;
        const d = new Date(o.created_at);
        return d >= startDate && d <= endDate;
      });
      
      // Helper: Get orders imported in a specific month
      const getOrdersInMonth = (year, month) => appData.orders.filter(o => {
        if (!o.created_at) return false;
        const d = new Date(o.created_at);
        return d.getFullYear() === year && (d.getMonth() + 1) === month;
      });
      
      // Helper: Get orders imported in a specific year
      const getOrdersInYear = (year) => appData.orders.filter(o => {
        if (!o.created_at) return false;
        const d = new Date(o.created_at);
        return d.getFullYear() === year;
      });
      
      // Helper: Get orders imported in specific quarter
      const getOrdersInQuarter = (year, quarter) => {
        const qMonths = [(quarter-1)*3+1, (quarter-1)*3+2, (quarter-1)*3+3];
        return appData.orders.filter(o => {
          if (!o.created_at) return false;
          const d = new Date(o.created_at);
          return d.getFullYear() === year && qMonths.includes(d.getMonth() + 1);
        });
      };
      
      // â”€â”€ WEEKLY TRACKING â”€â”€
      const getWeekStart = (date) => {
        const d = new Date(date);
        const day = d.getDay();
        d.setDate(d.getDate() - day);
        d.setHours(0, 0, 0, 0);
        return d;
      };
      const getWeekEnd = (weekStart) => {
        const d = new Date(weekStart);
        d.setDate(d.getDate() + 6);
        d.setHours(23, 59, 59, 999);
        return d;
      };
      
      const thisWeekStart = getWeekStart(today);
      const thisWeekEnd = getWeekEnd(thisWeekStart);
      const lastWeekStart = new Date(thisWeekStart); lastWeekStart.setDate(lastWeekStart.getDate() - 7);
      const lastWeekEnd = new Date(thisWeekEnd); lastWeekEnd.setDate(lastWeekEnd.getDate() - 7);
      const twoWeeksAgoStart = new Date(lastWeekStart); twoWeeksAgoStart.setDate(twoWeeksAgoStart.getDate() - 7);
      const twoWeeksAgoEnd = new Date(lastWeekEnd); twoWeeksAgoEnd.setDate(twoWeeksAgoEnd.getDate() - 7);
      
      // Count cars by import date (created_at)
      const thisWeekCars = getOrdersInRange(thisWeekStart, thisWeekEnd).length;
      const lastWeekCars = getOrdersInRange(lastWeekStart, lastWeekEnd).length;
      const twoWeeksAgoCars = getOrdersInRange(twoWeeksAgoStart, twoWeeksAgoEnd).length;
      const weeklyChange = lastWeekCars > 0 ? ((thisWeekCars - lastWeekCars) / lastWeekCars * 100) : 0;
      
      // Debug logging
      console.log('=== CAR VOLUME DEBUG (by import date) ===');
      console.log('Today:', today.toISOString());
      console.log('This Week:', thisWeekStart.toISOString(), 'to', thisWeekEnd.toISOString());
      console.log('Total orders:', appData.orders.length);
      console.log('Orders this week:', thisWeekCars);
      console.log('Orders last week:', lastWeekCars);
      console.log('==========================================');
      
      // â”€â”€ MONTHLY TRACKING (by import date) â”€â”€
      const getMonthData = (year, month) => {
        const orders = getOrdersInMonth(year, month);
        // Count unique trips these orders belong to
        const tripIds = new Set(orders.filter(o => o.trip_id).map(o => o.trip_id));
        return { trips: tripIds.size, cars: orders.length };
      };
      
      const monthlyData = [];
      for (let i = 5; i >= 0; i--) {
        let m = currentMonth - i;
        let y = currentYear;
        if (m <= 0) { m += 12; y--; }
        const data = getMonthData(y, m);
        monthlyData.push({ 
          label: months[m].substring(0, 3) + ' ' + String(y).slice(-2), 
          month: m, 
          year: y,
          cars: data.cars, 
          trips: data.trips 
        });
      }
      
      const thisMonthCars = monthlyData[5]?.cars || 0;
      const lastMonthCars = monthlyData[4]?.cars || 0;
      const monthlyChange = lastMonthCars > 0 ? ((thisMonthCars - lastMonthCars) / lastMonthCars * 100) : 0;
      const maxMonthlyCars = Math.max(...monthlyData.map(m => m.cars), 1);
      
      // â”€â”€ QUARTERLY TRACKING (by import date) â”€â”€
      const getQuarterData = (year, quarter) => {
        const orders = getOrdersInQuarter(year, quarter);
        const tripIds = new Set(orders.filter(o => o.trip_id).map(o => o.trip_id));
        return { trips: tripIds.size, cars: orders.length };
      };
      
      // Current year quarters
      const q1Data = getQuarterData(currentYear, 1);
      const q2Data = getQuarterData(currentYear, 2);
      const q3Data = getQuarterData(currentYear, 3);
      const q4Data = getQuarterData(currentYear, 4);
      
      // Last year quarters for comparison
      const lastYearQ1 = getQuarterData(currentYear - 1, 1);
      const lastYearQ2 = getQuarterData(currentYear - 1, 2);
      const lastYearQ3 = getQuarterData(currentYear - 1, 3);
      const lastYearQ4 = getQuarterData(currentYear - 1, 4);
      
      const quarterlyData = [
        { label: 'Q1', current: q1Data, lastYear: lastYearQ1 },
        { label: 'Q2', current: q2Data, lastYear: lastYearQ2 },
        { label: 'Q3', current: q3Data, lastYear: lastYearQ3 },
        { label: 'Q4', current: q4Data, lastYear: lastYearQ4 }
      ];
      
      const maxQuarterlyCars = Math.max(...quarterlyData.map(q => Math.max(q.current.cars, q.lastYear.cars)), 1);
      
      // â”€â”€ YEARLY TRACKING (by import date) â”€â”€
      const getYearData = (year) => {
        const orders = getOrdersInYear(year);
        const tripIds = new Set(orders.filter(o => o.trip_id).map(o => o.trip_id));
        return { trips: tripIds.size, cars: orders.length };
      };
      
      const yearlyData = [];
      for (let y = currentYear - 2; y <= currentYear; y++) {
        const data = getYearData(y);
        yearlyData.push({ year: y, cars: data.cars, trips: data.trips });
      }
      
      const thisYearCars = yearlyData.find(y => y.year === currentYear)?.cars || 0;
      const lastYearCars = yearlyData.find(y => y.year === currentYear - 1)?.cars || 0;
      const yearlyChange = lastYearCars > 0 ? ((thisYearCars - lastYearCars) / lastYearCars * 100) : 0;
      const maxYearlyCars = Math.max(...yearlyData.map(y => y.cars), 1);
      
      // Calculate period metrics
      let loadRevenue = 0, brokerFees = 0, localFees = 0, driverCut = 0, tripExpenses = 0, totalMiles = 0, totalCars = 0;
      const fuelCosts = { FUEL: 0, TOLLS: 0, PERMITS: 0, PARKING: 0, MAINTENANCE: 0, OTHER: 0 };
      
      filteredTrips.forEach(t => {
        const f = getTripFin(t.id);
        loadRevenue += f.loadRevenue;
        brokerFees += f.brokerFee;
        localFees += f.localFees;
        driverCut += f.driverCut;
        tripExpenses += f.totalExpenses;
        totalMiles += parseFloat(t.miles || 0);
        totalCars += f.vehicleCount;
        
        const tripExp = appData.expenses.filter(e => e.trip_id === t.id);
        tripExp.forEach(e => {
          if (fuelCosts[e.category] !== undefined) fuelCosts[e.category] += parseFloat(e.amount || 0);
          else fuelCosts.OTHER += parseFloat(e.amount || 0);
        });
      });
      
      // Direct Trip Expenses = ALL costs for trips
      const directTripExpenses = brokerFees + localFees + driverCut + tripExpenses;
      
      const tripCount = filteredTrips.length;
      const cleanGross = loadRevenue - brokerFees - localFees;
      const netProfit = loadRevenue - directTripExpenses; // Revenue - All Trip Costs
      const truckGross = cleanGross - driverCut; // Keep for backward compatibility
      const periodMonths = finPeriodType === 'month' ? 1 : finPeriodType === 'quarter' ? 3 : 12;
      const totalFixedCosts = monthlyFixedCosts * periodMonths;
      const totalOperatingExpenses = totalFixedCosts + directTripExpenses;
      const netProfitBeforeTax = loadRevenue - totalOperatingExpenses; // Revenue - (Fixed Costs + Direct Trip Expenses)
      const grossProfitMargin = loadRevenue > 0 ? (netProfit / loadRevenue * 100) : 0; // Trip profit margin
      const netProfitMargin = loadRevenue > 0 ? (netProfitBeforeTax / loadRevenue * 100) : 0;
      
      // Per-unit metrics
      const avgRevPerTruck = loadRevenue / numTrucks;
      const avgTruckGrossPerTruck = truckGross / numTrucks;
      const fixedCostPerTruck = totalFixedCosts / numTrucks;
      const netProfitPerTruck = netProfitBeforeTax / numTrucks;
      
      const avgRevPerTrip = tripCount > 0 ? loadRevenue / tripCount : 0;
      const avgTruckGrossPerTrip = tripCount > 0 ? truckGross / tripCount : 0;
      const avgPricePerCar = totalCars > 0 ? loadRevenue / totalCars : 0;
      const directCostPerTrip = tripCount > 0 ? directTripExpenses / tripCount : 0;
      const fixedCostPerTrip = tripCount > 0 ? totalFixedCosts / tripCount : 0;
      const netProfitPerTrip = tripCount > 0 ? netProfitBeforeTax / tripCount : 0;
      
      const revenuePerMile = totalMiles > 0 ? loadRevenue / totalMiles : 0;
      const truckGrossPerMile = totalMiles > 0 ? truckGross / totalMiles : 0;
      const fuelCostPerMile = totalMiles > 0 ? fuelCosts.FUEL / totalMiles : 0;
      const netProfitPerMile = totalMiles > 0 ? netProfitBeforeTax / totalMiles : 0;
      
      // â•â•â• NEW: Enhanced Efficiency Metrics â•â•â•
      // Cost Per Mile breakdown
      const totalCostPerMile = totalMiles > 0 ? totalOperatingExpenses / totalMiles : 0;
      const directCostPerMile = totalMiles > 0 ? directTripExpenses / totalMiles : 0;
      
      // Efficiency Ratios
      const fuelToRevenueRatio = loadRevenue > 0 ? (fuelCosts.FUEL / loadRevenue * 100) : 0;
      const feeBurdenRatio = loadRevenue > 0 ? ((brokerFees + localFees) / loadRevenue * 100) : 0;
      const driverCutRatioDisplay = cleanGross > 0 ? (driverCut / cleanGross * 100) : 0;
      const expenseRatio = loadRevenue > 0 ? (tripExpenses / loadRevenue * 100) : 0;
      
      // Break-Even Analysis (enhanced)
      const breakEvenCarsPerMonth = currentProfitPerCar !== 0 ? Math.ceil(monthlyFixedCosts / Math.abs(currentProfitPerCar)) : 0;
      const breakEvenRevenuePerMonth = truckGrossRatio > 0 ? monthlyFixedCosts / truckGrossRatio : 0;
      const marginOfSafety = loadRevenue > 0 && breakEvenRevenuePerMonth > 0 ? ((loadRevenue / periodMonths - breakEvenRevenuePerMonth) / (loadRevenue / periodMonths) * 100) : 0;
      
      // Variable costs integration
      const totalVariableCosts = (appData.variable_costs || [])
        .filter(vc => {
          if (!vc.date) return false;
          const d = new Date(vc.date);
          if (finPeriodType === 'month') return d.getFullYear() === finYear && (d.getMonth() + 1) === finMonth;
          if (finPeriodType === 'quarter') {
            const qMonths = [(finQuarter-1)*3+1, (finQuarter-1)*3+2, (finQuarter-1)*3+3];
            return d.getFullYear() === finYear && qMonths.includes(d.getMonth() + 1);
          }
          return d.getFullYear() === finYear;
        })
        .reduce((s, vc) => s + parseFloat(vc.amount || 0), 0);
      
      // Fuel from fuel_transactions (for period)
      const fuelTransactionsCost = (appData.fuel_transactions || [])
        .filter(ft => {
          if (!ft.transaction_date) return false;
          const d = new Date(ft.transaction_date);
          if (finPeriodType === 'month') return d.getFullYear() === finYear && (d.getMonth() + 1) === finMonth;
          if (finPeriodType === 'quarter') {
            const qMonths = [(finQuarter-1)*3+1, (finQuarter-1)*3+2, (finQuarter-1)*3+3];
            return d.getFullYear() === finYear && qMonths.includes(d.getMonth() + 1);
          }
          return d.getFullYear() === finYear;
        })
        .reduce((s, ft) => s + parseFloat(ft.total_cost || 0), 0);
      
      // Combined true operating expenses
      const trueOperatingExpenses = totalOperatingExpenses + totalVariableCosts + fuelTransactionsCost;
      const trueNetProfit = loadRevenue - directTripExpenses - totalFixedCosts - totalVariableCosts;
      
      // Build fixed costs breakdown
      const fixedCostsBreakdown = (appData.fixed_costs || []).map(fc => '<tr><td style="padding-left:24px">' + fc.name + '</td><td class="money">' + formatMoney(fc.amount * periodMonths) + '</td></tr>').join('');
      
      // Tabs for consolidated view
      const finTabs = `
        <div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;">
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='executive';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ¢ Executive</button>
          <button class="btn btn-primary" style="padding:6px 12px;font-size:12px" onclick="finTab='analysis';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ“ˆ Analysis</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='overview';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ“Š Overview</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='costs';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ’¸ Costs</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='trips';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸš› By Trip</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='drivers';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ‘¤ By Driver</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='brokers';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ¤ By Broker</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='lanes';renderConsolidatedFinancials(document.getElementById('main-content'))">ðŸ—ºï¸ By Lane</button>
        </div>
      `;
      
      c.innerHTML = finTabs + '<div class="header"><h2>ðŸ“ˆ Financial Analysis</h2><div style="display:flex;gap:8px"><button class="btn btn-secondary" onclick="loadAllData(true).then(()=>renderFinancialAnalysis(document.getElementById(\'main-content\')))">ðŸ”„ Refresh</button><button class="btn btn-secondary" onclick="window.print()">ðŸ–¨ï¸ Print</button></div></div>' +
        
        // ============ TRIP SEARCH SECTION (UNCHANGED) ============
        '<div style="background:#7c3aed;color:white;padding:10px 16px;border-radius:8px 8px 0 0;font-weight:600;font-size:14px">ðŸ” TRIP SEARCH & ANALYSIS</div>' +
        '<div class="card" style="border-radius:0 0 8px 8px;margin-bottom:16px;padding:16px">' +
        '<div style="display:flex;gap:12px;align-items:end;flex-wrap:wrap;margin-bottom:16px">' +
        '<div class="form-group" style="margin:0;flex:1;min-width:180px"><label>Select or Search Trip #</label><select id="tripSearchSelect" onchange="showTripAnalysis(this.value)" style="width:100%"><option value="">-- Select a Trip --</option>' +
        appData.trips.map(t => '<option value="' + t.id + '">' + t.trip_number + '</option>').join('') +
        '</select></div>' +
        '<div class="form-group" style="margin:0"><label>Target Utilization %</label><input type="number" id="targetUtilization" value="85" style="width:100px" onchange="if(document.getElementById(\'tripSearchSelect\').value)showTripAnalysis(document.getElementById(\'tripSearchSelect\').value)"></div>' +
        '</div>' +
        '<div id="tripAnalysisResult"></div>' +
        '</div>' +
        
        // â•â•â• NEW: ALL TRIPS FINANCIAL OVERVIEW â•â•â•
        '<div class="card" style="padding:0;overflow:hidden;margin-bottom:24px">' +
        '<div style="background:linear-gradient(90deg,#0f766e,#0d9488);color:white;padding:16px 20px;font-weight:700;display:flex;align-items:center;justify-content:space-between">' +
        '<div style="display:flex;align-items:center;gap:10px"><span style="font-size:20px">ðŸ“‹</span> All Trips Financial Overview</div>' +
        '<div style="font-size:12px;opacity:0.9">' + appData.trips.length + ' trips total</div>' +
        '</div>' +
        '<div style="padding:16px;background:#f0fdfa;border-bottom:1px solid #99f6e4">' +
        '<div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">' +
        '<span style="font-size:13px;color:#0f766e;font-weight:500">Quick Filters:</span>' +
        '<button class="btn btn-sm" style="background:#dcfce7;color:#166534;border:1px solid #86efac" onclick="filterTripsTable(\'profitable\')">âœ… Profitable</button>' +
        '<button class="btn btn-sm" style="background:#fee2e2;color:#991b1b;border:1px solid #fecaca" onclick="filterTripsTable(\'losing\')">âŒ Losing</button>' +
        '<button class="btn btn-sm" style="background:#dbeafe;color:#1e40af;border:1px solid #93c5fd" onclick="filterTripsTable(\'all\')">ðŸ“Š All</button>' +
        '<span style="margin-left:auto;font-size:12px;color:#64748b">Click column headers to sort</span>' +
        '</div></div>' +
        '<div class="table-wrapper" style="max-height:400px;overflow-y:auto"><table id="tripsFinancialTable"><thead style="position:sticky;top:0;z-index:5"><tr>' +
        '<th onclick="sortTripsTable(\'date\')" style="cursor:pointer">Date â†•</th>' +
        '<th onclick="sortTripsTable(\'trip\')" style="cursor:pointer">Trip # â†•</th>' +
        '<th>Driver</th>' +
        '<th>Truck</th>' +
        '<th onclick="sortTripsTable(\'cars\')" style="cursor:pointer">Cars â†•</th>' +
        '<th onclick="sortTripsTable(\'miles\')" style="cursor:pointer">Miles â†•</th>' +
        '<th onclick="sortTripsTable(\'revenue\')" style="cursor:pointer">Revenue â†•</th>' +
        '<th onclick="sortTripsTable(\'expenses\')" style="cursor:pointer">Expenses â†•</th>' +
        '<th onclick="sortTripsTable(\'profit\')" style="cursor:pointer">Net Profit â†•</th>' +
        '<th onclick="sortTripsTable(\'margin\')" style="cursor:pointer">Margin â†•</th>' +
        '<th onclick="sortTripsTable(\'ppm\')" style="cursor:pointer">$/Mile â†•</th>' +
        '<th>Status</th>' +
        '</tr></thead><tbody>' +
        appData.trips.map(t => {
          const f = getTripFin(t.id);
          const driver = appData.drivers.find(d => d.id === t.driver_id);
          const truck = appData.trucks.find(tr => tr.id === t.truck_id);
          const miles = parseFloat(t.miles || 0);
          const margin = f.loadRevenue > 0 ? (f.netProfit / f.loadRevenue * 100) : 0;
          const ppm = miles > 0 ? f.netProfit / miles : 0;
          const isProfitable = f.netProfit >= 0;
          const statusBadge = isProfitable ? 
            '<span class="badge badge-green">âœ“ Profit</span>' : 
            '<span class="badge badge-red">âœ— Loss</span>';
          return '<tr data-profit="' + f.netProfit + '" class="trip-row">' +
            '<td>' + formatDate(t.trip_date) + '</td>' +
            '<td><a href="#" onclick="showTripAnalysis(' + t.id + ');return false" style="color:#0d9488;font-weight:600">' + t.trip_number + '</a></td>' +
            '<td>' + (driver ? driver.first_name + ' ' + driver.last_name.charAt(0) + '.' : '-') + '</td>' +
            '<td>' + (truck ? '#' + truck.truck_number : '-') + '</td>' +
            '<td style="text-align:center">' + f.vehicleCount + '</td>' +
            '<td style="text-align:right">' + miles.toLocaleString() + '</td>' +
            '<td class="money" style="color:#059669">' + formatMoney(f.loadRevenue) + '</td>' +
            '<td class="money" style="color:#dc2626">' + formatMoney(f.directTripExpenses) + '</td>' +
            '<td class="money" style="font-weight:700;color:' + (isProfitable ? '#16a34a' : '#dc2626') + '">' + formatMoney(f.netProfit) + '</td>' +
            '<td style="text-align:right;color:' + (margin >= 20 ? '#16a34a' : margin >= 0 ? '#f59e0b' : '#dc2626') + '">' + margin.toFixed(1) + '%</td>' +
            '<td class="money" style="color:' + (ppm >= 0.5 ? '#16a34a' : ppm >= 0 ? '#f59e0b' : '#dc2626') + '">' + formatMoney(ppm) + '</td>' +
            '<td>' + statusBadge + '</td>' +
            '</tr>';
        }).join('') +
        '</tbody></table></div>' +
        
        // Summary row
        '<div style="padding:16px;background:#f0fdfa;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px">' +
        (function() {
          let totRev = 0, totExp = 0, totProfit = 0, totMiles = 0, totCars = 0, profitableCount = 0;
          appData.trips.forEach(t => {
            const f = getTripFin(t.id);
            totRev += f.loadRevenue;
            totExp += f.directTripExpenses;
            totProfit += f.netProfit;
            totMiles += parseFloat(t.miles || 0);
            totCars += f.vehicleCount;
            if (f.netProfit >= 0) profitableCount++;
          });
          const avgMargin = totRev > 0 ? (totProfit / totRev * 100) : 0;
          const avgPPM = totMiles > 0 ? totProfit / totMiles : 0;
          return '<div style="text-align:center"><div style="font-size:11px;color:#0f766e">Total Revenue</div><div style="font-weight:700;color:#059669">' + formatMoney(totRev) + '</div></div>' +
            '<div style="text-align:center"><div style="font-size:11px;color:#0f766e">Total Expenses</div><div style="font-weight:700;color:#dc2626">' + formatMoney(totExp) + '</div></div>' +
            '<div style="text-align:center"><div style="font-size:11px;color:#0f766e">Total Profit</div><div style="font-weight:700;color:' + (totProfit >= 0 ? '#16a34a' : '#dc2626') + '">' + formatMoney(totProfit) + '</div></div>' +
            '<div style="text-align:center"><div style="font-size:11px;color:#0f766e">Avg Margin</div><div style="font-weight:700">' + avgMargin.toFixed(1) + '%</div></div>' +
            '<div style="text-align:center"><div style="font-size:11px;color:#0f766e">Avg $/Mile</div><div style="font-weight:700">' + formatMoney(avgPPM) + '</div></div>' +
            '<div style="text-align:center"><div style="font-size:11px;color:#0f766e">Profitable Trips</div><div style="font-weight:700;color:#16a34a">' + profitableCount + '/' + appData.trips.length + '</div></div>';
        })() +
        '</div></div>' +
        
        // ============ EXECUTIVE SUMMARY HERO ============
        '<div class="fin-hero" style="background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#334155 100%);border-radius:16px;padding:32px;margin-bottom:24px;position:relative;overflow:hidden">' +
        '<div style="position:absolute;top:0;right:0;width:300px;height:300px;background:radial-gradient(circle,rgba(99,102,241,0.15) 0%,transparent 70%);pointer-events:none"></div>' +
        '<div style="position:absolute;bottom:-50px;left:-50px;width:200px;height:200px;background:radial-gradient(circle,rgba(34,197,94,0.1) 0%,transparent 70%);pointer-events:none"></div>' +
        
        '<div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:20px;margin-bottom:24px">' +
        '<div>' +
        '<h3 style="color:#f1f5f9;margin:0 0 8px 0;font-size:24px;font-weight:700">Financial Health Dashboard</h3>' +
        '<p style="color:#94a3b8;margin:0;font-size:14px">All-time analysis â€¢ ' + allTimeTripCount + ' trips â€¢ ' + allTimeCars + ' cars â€¢ ' + allTimeMiles.toLocaleString() + ' miles</p>' +
        '</div>' +
        '<div style="display:flex;gap:12px">' +
        '<div style="background:' + (isProfitable ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)') + ';border:1px solid ' + (isProfitable ? '#22c55e' : '#ef4444') + ';padding:8px 16px;border-radius:20px;display:flex;align-items:center;gap:8px">' +
        '<span style="width:8px;height:8px;border-radius:50%;background:' + (isProfitable ? '#22c55e' : '#ef4444') + '"></span>' +
        '<span style="color:' + (isProfitable ? '#4ade80' : '#f87171') + ';font-weight:600;font-size:13px">' + (isProfitable ? 'PROFITABLE' : 'NEEDS ATTENTION') + '</span>' +
        '</div>' +
        '</div>' +
        '</div>' +
        
        // Hero Stats Row
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">' +
        
        // Profit Per Car - Main KPI
        '<div class="fin-kpi-card" style="background:linear-gradient(135deg,' + (currentProfitPerCar >= 0 ? '#065f46,#047857' : '#7f1d1d,#991b1b') + ');padding:24px;border-radius:12px;position:relative;overflow:hidden">' +
        '<div style="position:absolute;top:-20px;right:-20px;font-size:80px;opacity:0.1">ðŸ’°</div>' +
        '<div style="font-size:12px;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Profit Per Car</div>' +
        '<div style="font-size:36px;font-weight:800;color:white;line-height:1">' + formatMoney(currentProfitPerCar) + '</div>' +
        '<div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:8px">After all costs incl. fixed</div>' +
        '</div>' +
        
        // Est Monthly Profit
        '<div class="fin-kpi-card" style="background:linear-gradient(135deg,#1e3a5f,#1e40af);padding:24px;border-radius:12px;position:relative;overflow:hidden">' +
        '<div style="position:absolute;top:-20px;right:-20px;font-size:80px;opacity:0.1">ðŸ“Š</div>' +
        '<div style="font-size:12px;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Est. Monthly Profit</div>' +
        '<div style="font-size:36px;font-weight:800;color:' + (currentMonthlyProfit >= 0 ? '#4ade80' : '#f87171') + ';line-height:1">' + formatMoney(currentMonthlyProfit) + '</div>' +
        '<div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:8px">Based on ' + monthsOfData + ' months data</div>' +
        '</div>' +
        
        // Monthly Fixed Costs
        '<div class="fin-kpi-card" style="background:linear-gradient(135deg,#78350f,#92400e);padding:24px;border-radius:12px;position:relative;overflow:hidden">' +
        '<div style="position:absolute;top:-20px;right:-20px;font-size:80px;opacity:0.1">ðŸ¢</div>' +
        '<div style="font-size:12px;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Monthly Fixed Costs</div>' +
        '<div style="font-size:36px;font-weight:800;color:white;line-height:1">' + formatMoney(monthlyFixedCosts) + '</div>' +
        '<div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:8px">~' + formatMoney(avgMonthlyCars > 0 ? monthlyFixedCosts / avgMonthlyCars : 0) + ' per car</div>' +
        '</div>' +
        
        // Break-Even PPC
        '<div class="fin-kpi-card" style="background:linear-gradient(135deg,#4c1d95,#6d28d9);padding:24px;border-radius:12px;position:relative;overflow:hidden">' +
        '<div style="position:absolute;top:-20px;right:-20px;font-size:80px;opacity:0.1">ðŸŽ¯</div>' +
        '<div style="font-size:12px;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Break-Even PPC</div>' +
        '<div style="font-size:36px;font-weight:800;color:white;line-height:1">' + formatMoney(breakEvenPPC) + '</div>' +
        '<div style="font-size:12px;color:' + (ppcGap <= 0 ? '#4ade80' : '#fbbf24') + ';margin-top:8px">' + (ppcGap > 0 ? 'â†‘ Need +' + formatMoney(ppcGap) : 'âœ“ Above by ' + formatMoney(Math.abs(ppcGap))) + '</div>' +
        '</div>' +
        '</div>' +
        '</div>' +
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ðŸš— CAR VOLUME TRACKING BY TIMEFRAME
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        '<div class="card" style="padding:0;overflow:hidden;margin-bottom:24px">' +
        '<div style="background:linear-gradient(135deg,#7c3aed 0%,#6d28d9 100%);color:white;padding:20px 24px">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">' +
        '<div style="display:flex;align-items:center;gap:12px">' +
        '<span style="font-size:32px">ðŸš—</span>' +
        '<div><h3 style="margin:0;font-size:20px;font-weight:700">Car Volume Tracking</h3>' +
        '<p style="margin:4px 0 0 0;opacity:0.85;font-size:13px">Vehicles counted by import date (when added to TMS)</p></div>' +
        '</div>' +
        '<div style="display:flex;gap:16px;flex-wrap:wrap">' +
        '<div style="text-align:center;padding:8px 16px;background:rgba(255,255,255,0.15);border-radius:8px">' +
        '<div style="font-size:11px;opacity:0.8">ALL TIME</div>' +
        '<div style="font-size:24px;font-weight:800">' + appData.orders.length.toLocaleString() + '</div></div>' +
        '<div style="text-align:center;padding:8px 16px;background:rgba(255,255,255,0.15);border-radius:8px">' +
        '<div style="font-size:11px;opacity:0.8">THIS YEAR</div>' +
        '<div style="font-size:24px;font-weight:800">' + thisYearCars.toLocaleString() + '</div></div>' +
        '</div></div></div>' +
        
        '<div style="padding:24px">' +
        
        // â”€â”€ WEEKLY SECTION â”€â”€
        '<div style="margin-bottom:28px">' +
        '<div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">' +
        '<span style="font-size:18px">ðŸ“…</span>' +
        '<h4 style="margin:0;color:#1e293b;font-weight:600">Weekly Volume</h4>' +
        '<span style="margin-left:auto;font-size:12px;color:' + (weeklyChange >= 0 ? '#16a34a' : '#dc2626') + ';font-weight:600;background:' + (weeklyChange >= 0 ? '#dcfce7' : '#fee2e2') + ';padding:4px 10px;border-radius:12px">' +
        (weeklyChange >= 0 ? 'â†‘' : 'â†“') + ' ' + Math.abs(weeklyChange).toFixed(1) + '% vs last week</span>' +
        '</div>' +
        '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">' +
        '<div style="background:#f8fafc;border-radius:12px;padding:20px;text-align:center;border:2px solid #e2e8f0">' +
        '<div style="font-size:12px;color:#64748b;margin-bottom:4px">2 Weeks Ago</div>' +
        '<div style="font-size:32px;font-weight:800;color:#64748b">' + twoWeeksAgoCars + '</div>' +
        '<div style="font-size:11px;color:#94a3b8">cars</div></div>' +
        '<div style="background:#f8fafc;border-radius:12px;padding:20px;text-align:center;border:2px solid #e2e8f0">' +
        '<div style="font-size:12px;color:#64748b;margin-bottom:4px">Last Week</div>' +
        '<div style="font-size:32px;font-weight:800;color:#475569">' + lastWeekCars + '</div>' +
        '<div style="font-size:11px;color:#94a3b8">cars</div></div>' +
        '<div style="background:linear-gradient(135deg,#dbeafe,#ede9fe);border-radius:12px;padding:20px;text-align:center;border:2px solid #a5b4fc">' +
        '<div style="font-size:12px;color:#4f46e5;margin-bottom:4px;font-weight:600">THIS WEEK</div>' +
        '<div style="font-size:32px;font-weight:800;color:#4f46e5">' + thisWeekCars + '</div>' +
        '<div style="font-size:11px;color:#6366f1">cars</div></div>' +
        '</div></div>' +
        
        // â”€â”€ MONTHLY SECTION â”€â”€
        '<div style="margin-bottom:28px">' +
        '<div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">' +
        '<span style="font-size:18px">ðŸ“†</span>' +
        '<h4 style="margin:0;color:#1e293b;font-weight:600">Monthly Volume (Last 6 Months)</h4>' +
        '<span style="margin-left:auto;font-size:12px;color:' + (monthlyChange >= 0 ? '#16a34a' : '#dc2626') + ';font-weight:600;background:' + (monthlyChange >= 0 ? '#dcfce7' : '#fee2e2') + ';padding:4px 10px;border-radius:12px">' +
        (monthlyChange >= 0 ? 'â†‘' : 'â†“') + ' ' + Math.abs(monthlyChange).toFixed(1) + '% vs last month</span>' +
        '</div>' +
        '<div style="display:grid;grid-template-columns:repeat(6,1fr);gap:12px">' +
        monthlyData.map((m, i) => {
          const isCurrentMonth = i === 5;
          const barHeight = maxMonthlyCars > 0 ? (m.cars / maxMonthlyCars * 80) : 0;
          return '<div style="text-align:center">' +
            '<div style="height:100px;display:flex;flex-direction:column;justify-content:flex-end;align-items:center">' +
            '<div style="font-size:14px;font-weight:700;color:' + (isCurrentMonth ? '#4f46e5' : '#334155') + ';margin-bottom:4px">' + m.cars + '</div>' +
            '<div style="width:40px;height:' + barHeight + 'px;background:' + (isCurrentMonth ? 'linear-gradient(180deg,#818cf8,#4f46e5)' : 'linear-gradient(180deg,#94a3b8,#64748b)') + ';border-radius:4px 4px 0 0;min-height:4px"></div></div>' +
            '<div style="margin-top:8px;padding:8px;background:' + (isCurrentMonth ? '#eef2ff' : '#f8fafc') + ';border-radius:8px">' +
            '<div style="font-size:11px;font-weight:' + (isCurrentMonth ? '700' : '500') + ';color:' + (isCurrentMonth ? '#4f46e5' : '#64748b') + '">' + m.label + '</div>' +
            '<div style="font-size:10px;color:#94a3b8">' + m.trips + ' trips</div></div></div>';
        }).join('') +
        '</div></div>' +
        
        // â”€â”€ QUARTERLY SECTION â”€â”€
        '<div style="margin-bottom:28px">' +
        '<div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">' +
        '<span style="font-size:18px">ðŸ“Š</span>' +
        '<h4 style="margin:0;color:#1e293b;font-weight:600">Quarterly Comparison</h4>' +
        '<div style="margin-left:auto;display:flex;gap:12px;font-size:11px">' +
        '<span style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:12px;background:#4f46e5;border-radius:2px"></span> ' + currentYear + '</span>' +
        '<span style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:12px;background:#cbd5e1;border-radius:2px"></span> ' + (currentYear - 1) + '</span>' +
        '</div></div>' +
        '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px">' +
        quarterlyData.map((q, i) => {
          const isCurrentQuarter = (i + 1) === currentQuarter;
          const currentBarHeight = maxQuarterlyCars > 0 ? (q.current.cars / maxQuarterlyCars * 70) : 0;
          const lastYearBarHeight = maxQuarterlyCars > 0 ? (q.lastYear.cars / maxQuarterlyCars * 70) : 0;
          const qChange = q.lastYear.cars > 0 ? ((q.current.cars - q.lastYear.cars) / q.lastYear.cars * 100) : 0;
          return '<div style="background:' + (isCurrentQuarter ? '#eef2ff' : '#f8fafc') + ';border-radius:12px;padding:16px;border:2px solid ' + (isCurrentQuarter ? '#a5b4fc' : '#e2e8f0') + '">' +
            '<div style="text-align:center;margin-bottom:12px">' +
            '<div style="font-size:16px;font-weight:700;color:' + (isCurrentQuarter ? '#4f46e5' : '#334155') + '">' + q.label + (isCurrentQuarter ? ' âœ¦' : '') + '</div></div>' +
            '<div style="display:flex;justify-content:center;gap:8px;height:90px;align-items:flex-end">' +
            '<div style="display:flex;flex-direction:column;align-items:center">' +
            '<div style="font-size:12px;font-weight:600;color:#64748b;margin-bottom:2px">' + q.lastYear.cars + '</div>' +
            '<div style="width:28px;height:' + lastYearBarHeight + 'px;background:#cbd5e1;border-radius:4px 4px 0 0;min-height:4px"></div></div>' +
            '<div style="display:flex;flex-direction:column;align-items:center">' +
            '<div style="font-size:12px;font-weight:700;color:#4f46e5;margin-bottom:2px">' + q.current.cars + '</div>' +
            '<div style="width:28px;height:' + currentBarHeight + 'px;background:linear-gradient(180deg,#818cf8,#4f46e5);border-radius:4px 4px 0 0;min-height:4px"></div></div></div>' +
            '<div style="text-align:center;margin-top:8px;font-size:11px;color:' + (qChange >= 0 ? '#16a34a' : '#dc2626') + ';font-weight:600">' +
            (q.current.cars > 0 || q.lastYear.cars > 0 ? ((qChange >= 0 ? 'â†‘' : 'â†“') + ' ' + Math.abs(qChange).toFixed(0) + '% YoY') : '-') + '</div>' +
            '</div>';
        }).join('') +
        '</div></div>' +
        
        // â”€â”€ YEARLY SECTION â”€â”€
        '<div>' +
        '<div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">' +
        '<span style="font-size:18px">ðŸ“ˆ</span>' +
        '<h4 style="margin:0;color:#1e293b;font-weight:600">Annual Volume</h4>' +
        '<span style="margin-left:auto;font-size:12px;color:' + (yearlyChange >= 0 ? '#16a34a' : '#dc2626') + ';font-weight:600;background:' + (yearlyChange >= 0 ? '#dcfce7' : '#fee2e2') + ';padding:4px 10px;border-radius:12px">' +
        (yearlyChange >= 0 ? 'â†‘' : 'â†“') + ' ' + Math.abs(yearlyChange).toFixed(1) + '% YoY</span>' +
        '</div>' +
        '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">' +
        yearlyData.map((y, i) => {
          const isCurrentYear = y.year === currentYear;
          const barWidth = maxYearlyCars > 0 ? (y.cars / maxYearlyCars * 100) : 0;
          return '<div style="background:' + (isCurrentYear ? 'linear-gradient(135deg,#eef2ff,#e0e7ff)' : '#f8fafc') + ';border-radius:12px;padding:20px;border:2px solid ' + (isCurrentYear ? '#a5b4fc' : '#e2e8f0') + '">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">' +
            '<div style="font-size:20px;font-weight:800;color:' + (isCurrentYear ? '#4f46e5' : '#334155') + '">' + y.year + '</div>' +
            '<div style="font-size:11px;color:#64748b">' + y.trips + ' trips</div></div>' +
            '<div style="height:16px;background:#e2e8f0;border-radius:8px;overflow:hidden;margin-bottom:8px">' +
            '<div style="height:100%;width:' + barWidth + '%;background:' + (isCurrentYear ? 'linear-gradient(90deg,#818cf8,#4f46e5)' : 'linear-gradient(90deg,#94a3b8,#64748b)') + ';border-radius:8px"></div></div>' +
            '<div style="font-size:28px;font-weight:800;color:' + (isCurrentYear ? '#4f46e5' : '#475569') + ';text-align:center">' + y.cars.toLocaleString() + ' <span style="font-size:14px;font-weight:500">cars</span></div>' +
            '</div>';
        }).join('') +
        '</div></div>' +
        
        '</div></div>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:24px">' +
        
        '<div class="fin-metric-card" style="background:white;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid #e2e8f0;text-align:center;transition:all 0.2s;cursor:pointer" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.15)\'" onmouseout="this.style.transform=\'none\';this.style.boxShadow=\'0 1px 3px rgba(0,0,0,0.1)\'">' +
        '<div style="width:48px;height:48px;background:#dbeafe;border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:24px">ðŸ’µ</div>' +
        '<div style="font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Avg Price/Car</div>' +
        '<div style="font-size:22px;font-weight:700;color:#1e293b">' + formatMoney(allTimeAvgPPC) + '</div>' +
        '</div>' +
        
        '<div class="fin-metric-card" style="background:white;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid #e2e8f0;text-align:center;transition:all 0.2s;cursor:pointer" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.15)\'" onmouseout="this.style.transform=\'none\';this.style.boxShadow=\'0 1px 3px rgba(0,0,0,0.1)\'">' +
        '<div style="width:48px;height:48px;background:#dcfce7;border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:24px">ðŸ“</div>' +
        '<div style="font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Avg Price/Mile</div>' +
        '<div style="font-size:22px;font-weight:700;color:#1e293b">' + formatMoney(allTimeAvgPPM) + '</div>' +
        '</div>' +
        
        '<div class="fin-metric-card" style="background:white;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid #e2e8f0;text-align:center;transition:all 0.2s;cursor:pointer" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.15)\'" onmouseout="this.style.transform=\'none\';this.style.boxShadow=\'0 1px 3px rgba(0,0,0,0.1)\'">' +
        '<div style="width:48px;height:48px;background:#fef3c7;border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:24px">ðŸš—</div>' +
        '<div style="font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Cars/Trip</div>' +
        '<div style="font-size:22px;font-weight:700;color:#1e293b">' + allTimeAvgCarsPerTrip.toFixed(1) + '</div>' +
        '</div>' +
        
        '<div class="fin-metric-card" style="background:white;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid #e2e8f0;text-align:center;transition:all 0.2s;cursor:pointer" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.15)\'" onmouseout="this.style.transform=\'none\';this.style.boxShadow=\'0 1px 3px rgba(0,0,0,0.1)\'">' +
        '<div style="width:48px;height:48px;background:#e0e7ff;border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:24px">ðŸ›£ï¸</div>' +
        '<div style="font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Miles/Trip</div>' +
        '<div style="font-size:22px;font-weight:700;color:#1e293b">' + allTimeAvgMilesPerTrip.toFixed(0) + '</div>' +
        '</div>' +
        
        '<div class="fin-metric-card" style="background:white;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid #e2e8f0;text-align:center;transition:all 0.2s;cursor:pointer" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.15)\'" onmouseout="this.style.transform=\'none\';this.style.boxShadow=\'0 1px 3px rgba(0,0,0,0.1)\'">' +
        '<div style="width:48px;height:48px;background:#fee2e2;border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:24px">â›½</div>' +
        '<div style="font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Fuel/Mile</div>' +
        '<div style="font-size:22px;font-weight:700;color:#1e293b">' + formatMoney(allTimeAvgFuelPerMile) + '</div>' +
        '</div>' +
        
        '<div class="fin-metric-card" style="background:white;border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid #e2e8f0;text-align:center;transition:all 0.2s;cursor:pointer" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.15)\'" onmouseout="this.style.transform=\'none\';this.style.boxShadow=\'0 1px 3px rgba(0,0,0,0.1)\'">' +
        '<div style="width:48px;height:48px;background:#fce7f3;border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:24px">ðŸ“‹</div>' +
        '<div style="font-size:11px;color:#64748b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Expense/Trip</div>' +
        '<div style="font-size:22px;font-weight:700;color:#1e293b">' + formatMoney(allTimeAvgExpensePerTrip) + '</div>' +
        '</div>' +
        '</div>' +
        
        // ============ PERIOD SELECTOR - MODERNIZED ============
        '<div class="card" style="padding:20px;margin-bottom:24px;background:linear-gradient(90deg,#f8fafc,#f1f5f9)">' +
        '<div style="display:flex;gap:20px;align-items:center;flex-wrap:wrap">' +
        '<div style="display:flex;align-items:center;gap:8px">' +
        '<span style="font-size:20px">ðŸ“…</span>' +
        '<span style="font-weight:600;color:#334155">Select Period:</span>' +
        '</div>' +
        '<div style="display:flex;gap:8px;background:white;padding:4px;border-radius:8px;border:1px solid #e2e8f0">' +
        '<button onclick="finPeriodType=\'month\';renderFinancialAnalysis(document.getElementById(\'main-content\'))" style="padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.2s;' + (finPeriodType === 'month' ? 'background:#3b82f6;color:white' : 'background:transparent;color:#64748b') + '">Monthly</button>' +
        '<button onclick="finPeriodType=\'quarter\';renderFinancialAnalysis(document.getElementById(\'main-content\'))" style="padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.2s;' + (finPeriodType === 'quarter' ? 'background:#3b82f6;color:white' : 'background:transparent;color:#64748b') + '">Quarterly</button>' +
        '<button onclick="finPeriodType=\'year\';renderFinancialAnalysis(document.getElementById(\'main-content\'))" style="padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.2s;' + (finPeriodType === 'year' ? 'background:#3b82f6;color:white' : 'background:transparent;color:#64748b') + '">Yearly</button>' +
        '</div>' +
        '<select id="finYear" onchange="finYear=parseInt(this.value);renderFinancialAnalysis(document.getElementById(\'main-content\'))" style="padding:10px 16px;border:1px solid #e2e8f0;border-radius:8px;background:white;font-weight:500"><option value="2024"' + (finYear === 2024 ? ' selected' : '') + '>2024</option><option value="2025"' + (finYear === 2025 ? ' selected' : '') + '>2025</option><option value="2026"' + (finYear === 2026 ? ' selected' : '') + '>2026</option><option value="2027"' + (finYear === 2027 ? ' selected' : '') + '>2027</option></select>' +
        (finPeriodType === 'month' ? '<select id="finMonth" onchange="finMonth=parseInt(this.value);renderFinancialAnalysis(document.getElementById(\'main-content\'))" style="padding:10px 16px;border:1px solid #e2e8f0;border-radius:8px;background:white;font-weight:500">' + months.slice(1).map((m, i) => '<option value="' + (i+1) + '"' + (finMonth === i+1 ? ' selected' : '') + '>' + m + '</option>').join('') + '</select>' : '') +
        (finPeriodType === 'quarter' ? '<select id="finQuarter" onchange="finQuarter=parseInt(this.value);renderFinancialAnalysis(document.getElementById(\'main-content\'))" style="padding:10px 16px;border:1px solid #e2e8f0;border-radius:8px;background:white;font-weight:500"><option value="1"' + (finQuarter === 1 ? ' selected' : '') + '>Q1 (Jan-Mar)</option><option value="2"' + (finQuarter === 2 ? ' selected' : '') + '>Q2 (Apr-Jun)</option><option value="3"' + (finQuarter === 3 ? ' selected' : '') + '>Q3 (Jul-Sep)</option><option value="4"' + (finQuarter === 4 ? ' selected' : '') + '>Q4 (Oct-Dec)</option></select>' : '') +
        '<div style="margin-left:auto;background:#1e293b;color:white;padding:10px 20px;border-radius:8px;font-weight:700">' + periodLabel + '</div>' +
        '</div></div>' +
        
        // ============ PERIOD PERFORMANCE DASHBOARD ============
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:24px;margin-bottom:24px">' +
        
        // Left: Revenue & Profit Visual
        '<div class="card" style="padding:0;overflow:hidden">' +
        '<div style="background:#1e40af;color:white;padding:16px 20px;font-weight:700;display:flex;align-items:center;gap:10px"><span style="font-size:20px">ðŸ’°</span> Revenue & Profit - ' + periodLabel + '</div>' +
        '<div style="padding:24px">' +
        
        // Revenue Bar
        '<div style="margin-bottom:20px">' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="font-weight:600;color:#334155">Gross Revenue</span><span style="font-weight:700;color:#1e40af">' + formatMoney(loadRevenue) + '</span></div>' +
        '<div style="height:12px;background:#e2e8f0;border-radius:6px;overflow:hidden"><div style="height:100%;width:100%;background:linear-gradient(90deg,#3b82f6,#1e40af);border-radius:6px"></div></div>' +
        '</div>' +
        
        // Clean Gross Bar
        '<div style="margin-bottom:20px">' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="font-weight:600;color:#334155">Clean Gross <span style="font-weight:400;color:#64748b">(- fees)</span></span><span style="font-weight:700;color:#059669">' + formatMoney(cleanGross) + '</span></div>' +
        '<div style="height:12px;background:#e2e8f0;border-radius:6px;overflow:hidden"><div style="height:100%;width:' + (loadRevenue > 0 ? (cleanGross/loadRevenue*100) : 0) + '%;background:linear-gradient(90deg,#10b981,#059669);border-radius:6px"></div></div>' +
        '</div>' +
        
        // Trip Net Profit Bar
        '<div style="margin-bottom:20px">' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="font-weight:600;color:#334155">Trip Net Profit</span><span style="font-weight:700;color:' + (netProfit >= 0 ? '#059669' : '#dc2626') + '">' + formatMoney(netProfit) + '</span></div>' +
        '<div style="height:12px;background:#e2e8f0;border-radius:6px;overflow:hidden"><div style="height:100%;width:' + (loadRevenue > 0 ? Math.max(0, netProfit/loadRevenue*100) : 0) + '%;background:linear-gradient(90deg,' + (netProfit >= 0 ? '#22c55e,#16a34a' : '#f87171,#dc2626') + ');border-radius:6px"></div></div>' +
        '</div>' +
        
        // Final Net Profit
        '<div style="background:' + (netProfitBeforeTax >= 0 ? '#dcfce7' : '#fee2e2') + ';padding:16px;border-radius:12px;margin-top:16px">' +
        '<div style="display:flex;justify-content:space-between;align-items:center">' +
        '<div><div style="font-size:13px;color:#64748b;margin-bottom:4px">Net Profit Before Tax</div><div style="font-size:11px;color:#94a3b8">(After fixed costs)</div></div>' +
        '<div style="font-size:28px;font-weight:800;color:' + (netProfitBeforeTax >= 0 ? '#166534' : '#991b1b') + '">' + formatMoney(netProfitBeforeTax) + '</div>' +
        '</div>' +
        '</div>' +
        '</div></div>' +
        
        // Right: Operational Volume
        '<div class="card" style="padding:0;overflow:hidden">' +
        '<div style="background:#059669;color:white;padding:16px 20px;font-weight:700;display:flex;align-items:center;gap:10px"><span style="font-size:20px">ðŸšš</span> Operations - ' + periodLabel + '</div>' +
        '<div style="padding:24px">' +
        '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px">' +
        
        '<div style="background:#f8fafc;padding:16px;border-radius:12px;text-align:center;border:1px solid #e2e8f0">' +
        '<div style="font-size:32px;font-weight:800;color:#1e293b">' + numTrucks + '</div>' +
        '<div style="font-size:12px;color:#64748b;margin-top:4px">Active Trucks</div>' +
        '</div>' +
        
        '<div style="background:#f8fafc;padding:16px;border-radius:12px;text-align:center;border:1px solid #e2e8f0">' +
        '<div style="font-size:32px;font-weight:800;color:#1e293b">' + tripCount + '</div>' +
        '<div style="font-size:12px;color:#64748b;margin-top:4px">Trips Completed</div>' +
        '</div>' +
        
        '<div style="background:#f8fafc;padding:16px;border-radius:12px;text-align:center;border:1px solid #e2e8f0">' +
        '<div style="font-size:32px;font-weight:800;color:#1e293b">' + totalCars + '</div>' +
        '<div style="font-size:12px;color:#64748b;margin-top:4px">Cars Hauled</div>' +
        '</div>' +
        
        '<div style="background:#f8fafc;padding:16px;border-radius:12px;text-align:center;border:1px solid #e2e8f0">' +
        '<div style="font-size:32px;font-weight:800;color:#1e293b">' + totalMiles.toLocaleString() + '</div>' +
        '<div style="font-size:12px;color:#64748b;margin-top:4px">Miles Traveled</div>' +
        '</div>' +
        '</div>' +
        
        // Per Unit Metrics
        '<div style="margin-top:20px;padding-top:20px;border-top:1px solid #e2e8f0">' +
        '<div style="font-weight:600;color:#334155;margin-bottom:12px">Per-Unit Performance</div>' +
        '<div style="display:flex;flex-direction:column;gap:8px">' +
        '<div style="display:flex;justify-content:space-between;padding:8px 12px;background:#f1f5f9;border-radius:6px"><span style="color:#64748b">Avg Revenue/Trip</span><span style="font-weight:600">' + formatMoney(avgRevPerTrip) + '</span></div>' +
        '<div style="display:flex;justify-content:space-between;padding:8px 12px;background:#f1f5f9;border-radius:6px"><span style="color:#64748b">Avg Price/Car</span><span style="font-weight:600">' + formatMoney(avgPricePerCar) + '</span></div>' +
        '<div style="display:flex;justify-content:space-between;padding:8px 12px;background:#f1f5f9;border-radius:6px"><span style="color:#64748b">Revenue/Mile</span><span style="font-weight:600">' + formatMoney(revenuePerMile) + '</span></div>' +
        '<div style="display:flex;justify-content:space-between;padding:8px 12px;background:' + (netProfitPerTrip >= 0 ? '#dcfce7' : '#fee2e2') + ';border-radius:6px"><span style="color:#64748b">Net Profit/Trip</span><span style="font-weight:700;color:' + (netProfitPerTrip >= 0 ? '#166534' : '#991b1b') + '">' + formatMoney(netProfitPerTrip) + '</span></div>' +
        '</div>' +
        '</div>' +
        '</div></div>' +
        '</div>' +
        
        // ============ EXPENSE BREAKDOWN VISUAL ============
        '<div class="card" style="padding:0;overflow:hidden;margin-bottom:24px">' +
        '<div style="background:#dc2626;color:white;padding:16px 20px;font-weight:700;display:flex;align-items:center;gap:10px"><span style="font-size:20px">ðŸ“Š</span> Expense Breakdown - ' + periodLabel + '</div>' +
        '<div style="padding:24px">' +
        
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px">' +
        
        // Broker Fees
        '<div style="position:relative;background:#fef2f2;border-radius:12px;padding:16px;border-left:4px solid #ef4444">' +
        '<div style="font-size:12px;color:#991b1b;text-transform:uppercase;margin-bottom:4px">Broker Fees</div>' +
        '<div style="font-size:24px;font-weight:700;color:#dc2626">' + formatMoney(brokerFees) + '</div>' +
        '<div style="font-size:11px;color:#64748b;margin-top:4px">' + (loadRevenue > 0 ? (brokerFees/loadRevenue*100).toFixed(1) : 0) + '% of revenue</div>' +
        '</div>' +
        
        // Local Fees
        '<div style="position:relative;background:#fff7ed;border-radius:12px;padding:16px;border-left:4px solid #f59e0b">' +
        '<div style="font-size:12px;color:#92400e;text-transform:uppercase;margin-bottom:4px">Local Fees</div>' +
        '<div style="font-size:24px;font-weight:700;color:#d97706">' + formatMoney(localFees) + '</div>' +
        '<div style="font-size:11px;color:#64748b;margin-top:4px">' + (loadRevenue > 0 ? (localFees/loadRevenue*100).toFixed(1) : 0) + '% of revenue</div>' +
        '</div>' +
        
        // Driver Cut
        '<div style="position:relative;background:#f5f3ff;border-radius:12px;padding:16px;border-left:4px solid #8b5cf6">' +
        '<div style="font-size:12px;color:#5b21b6;text-transform:uppercase;margin-bottom:4px">Driver Cut (' + avgDriverCutPercent.toFixed(0) + '%)</div>' +
        '<div style="font-size:24px;font-weight:700;color:#7c3aed">' + formatMoney(driverCut) + '</div>' +
        '<div style="font-size:11px;color:#64748b;margin-top:4px">' + (loadRevenue > 0 ? (driverCut/loadRevenue*100).toFixed(1) : 0) + '% of revenue</div>' +
        '</div>' +
        
        // Trip Expenses
        '<div style="position:relative;background:#f0fdf4;border-radius:12px;padding:16px;border-left:4px solid #22c55e">' +
        '<div style="font-size:12px;color:#166534;text-transform:uppercase;margin-bottom:4px">Trip Expenses</div>' +
        '<div style="font-size:24px;font-weight:700;color:#16a34a">' + formatMoney(tripExpenses) + '</div>' +
        '<div style="font-size:11px;color:#64748b;margin-top:4px">Fuel, tolls, etc.</div>' +
        '</div>' +
        '</div>' +
        
        // Detailed Expense Grid
        '<div style="background:#f8fafc;border-radius:12px;padding:20px">' +
        '<div style="font-weight:600;color:#334155;margin-bottom:16px">Expense Details</div>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px">' +
        '<div style="background:white;padding:12px;border-radius:8px;text-align:center;border:1px solid #e2e8f0"><div style="font-size:20px;margin-bottom:4px">â›½</div><div style="font-size:11px;color:#64748b">Fuel</div><div style="font-weight:700;color:#1e293b">' + formatMoney(fuelCosts.FUEL) + '</div></div>' +
        '<div style="background:white;padding:12px;border-radius:8px;text-align:center;border:1px solid #e2e8f0"><div style="font-size:20px;margin-bottom:4px">ðŸ›¤ï¸</div><div style="font-size:11px;color:#64748b">Tolls</div><div style="font-weight:700;color:#1e293b">' + formatMoney(fuelCosts.TOLLS) + '</div></div>' +
        '<div style="background:white;padding:12px;border-radius:8px;text-align:center;border:1px solid #e2e8f0"><div style="font-size:20px;margin-bottom:4px">ðŸ“‹</div><div style="font-size:11px;color:#64748b">Permits</div><div style="font-weight:700;color:#1e293b">' + formatMoney(fuelCosts.PERMITS) + '</div></div>' +
        '<div style="background:white;padding:12px;border-radius:8px;text-align:center;border:1px solid #e2e8f0"><div style="font-size:20px;margin-bottom:4px">ðŸ…¿ï¸</div><div style="font-size:11px;color:#64748b">Parking</div><div style="font-weight:700;color:#1e293b">' + formatMoney(fuelCosts.PARKING) + '</div></div>' +
        '<div style="background:white;padding:12px;border-radius:8px;text-align:center;border:1px solid #e2e8f0"><div style="font-size:20px;margin-bottom:4px">ðŸ”§</div><div style="font-size:11px;color:#64748b">Maintenance</div><div style="font-weight:700;color:#1e293b">' + formatMoney(fuelCosts.MAINTENANCE) + '</div></div>' +
        '<div style="background:white;padding:12px;border-radius:8px;text-align:center;border:1px solid #e2e8f0"><div style="font-size:20px;margin-bottom:4px">ðŸ“¦</div><div style="font-size:11px;color:#64748b">Other</div><div style="font-weight:700;color:#1e293b">' + formatMoney(fuelCosts.OTHER) + '</div></div>' +
        '</div>' +
        '</div>' +
        
        // Totals Row
        '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:20px">' +
        '<div style="background:#fecaca;padding:16px;border-radius:12px;text-align:center"><div style="font-size:12px;color:#991b1b;margin-bottom:4px">Total Direct Trip Expenses</div><div style="font-size:22px;font-weight:800;color:#dc2626">' + formatMoney(directTripExpenses) + '</div></div>' +
        '<div style="background:#fef3c7;padding:16px;border-radius:12px;text-align:center"><div style="font-size:12px;color:#92400e;margin-bottom:4px">Fixed Costs (' + periodMonths + ' mo)</div><div style="font-size:22px;font-weight:800;color:#d97706">' + formatMoney(totalFixedCosts) + '</div></div>' +
        '<div style="background:#e5e7eb;padding:16px;border-radius:12px;text-align:center"><div style="font-size:12px;color:#374151;margin-bottom:4px">Total Operating Expenses</div><div style="font-size:22px;font-weight:800;color:#1f2937">' + formatMoney(totalOperatingExpenses) + '</div></div>' +
        '</div>' +
        '</div></div>' +
        
        // ============ PROFIT MARGINS & FIXED COSTS ============
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:24px;margin-bottom:24px">' +
        
        // Profit Margins Visual
        '<div class="card" style="padding:24px">' +
        '<div style="font-weight:700;font-size:18px;color:#1e293b;margin-bottom:20px;display:flex;align-items:center;gap:10px"><span style="font-size:24px">ðŸ“ˆ</span> Profit Margins</div>' +
        '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:24px">' +
        
        // Trip Profit Margin Gauge
        '<div style="text-align:center">' +
        '<div style="position:relative;width:140px;height:70px;margin:0 auto 16px;overflow:hidden">' +
        '<div style="position:absolute;width:140px;height:140px;border-radius:50%;background:conic-gradient(' + (grossProfitMargin >= 0 ? '#22c55e' : '#ef4444') + ' 0deg ' + (Math.min(Math.abs(grossProfitMargin), 100) * 1.8) + 'deg, #e5e7eb ' + (Math.min(Math.abs(grossProfitMargin), 100) * 1.8) + 'deg 180deg, transparent 180deg 360deg)"></div>' +
        '<div style="position:absolute;top:10px;left:10px;width:120px;height:120px;border-radius:50%;background:white;display:flex;align-items:center;justify-content:center;padding-top:35px">' +
        '<span style="font-size:24px;font-weight:800;color:' + (grossProfitMargin >= 0 ? '#166534' : '#dc2626') + '">' + grossProfitMargin.toFixed(1) + '%</span>' +
        '</div></div>' +
        '<div style="font-weight:600;color:#334155">Trip Profit Margin</div>' +
        '<div style="font-size:12px;color:#64748b">Revenue to trip profit</div>' +
        '</div>' +
        
        // Net Profit Margin Gauge
        '<div style="text-align:center">' +
        '<div style="position:relative;width:140px;height:70px;margin:0 auto 16px;overflow:hidden">' +
        '<div style="position:absolute;width:140px;height:140px;border-radius:50%;background:conic-gradient(' + (netProfitMargin >= 0 ? '#3b82f6' : '#ef4444') + ' 0deg ' + (Math.min(Math.abs(netProfitMargin), 100) * 1.8) + 'deg, #e5e7eb ' + (Math.min(Math.abs(netProfitMargin), 100) * 1.8) + 'deg 180deg, transparent 180deg 360deg)"></div>' +
        '<div style="position:absolute;top:10px;left:10px;width:120px;height:120px;border-radius:50%;background:white;display:flex;align-items:center;justify-content:center;padding-top:35px">' +
        '<span style="font-size:24px;font-weight:800;color:' + (netProfitMargin >= 0 ? '#1e40af' : '#dc2626') + '">' + netProfitMargin.toFixed(1) + '%</span>' +
        '</div></div>' +
        '<div style="font-weight:600;color:#334155">Net Profit Margin</div>' +
        '<div style="font-size:12px;color:#64748b">After all expenses</div>' +
        '</div>' +
        '</div></div>' +
        
        // â•â•â• NEW: EFFICIENCY RATIOS & PER-MILE ANALYSIS â•â•â•
        '<div class="card" style="padding:0;overflow:hidden;margin-bottom:24px">' +
        '<div style="background:linear-gradient(90deg,#0891b2,#0e7490);color:white;padding:16px 20px;font-weight:700;display:flex;align-items:center;gap:10px"><span style="font-size:20px">âš¡</span> Efficiency & Per-Mile Analysis</div>' +
        '<div style="padding:24px">' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:20px">' +
        
        // Cost Per Mile
        '<div style="background:#f0fdfa;padding:16px;border-radius:12px;text-align:center;border:1px solid #99f6e4">' +
        '<div style="font-size:11px;color:#0d9488;text-transform:uppercase;margin-bottom:4px">Total Cost/Mile</div>' +
        '<div style="font-size:24px;font-weight:700;color:#0f766e">' + formatMoney(totalCostPerMile) + '</div>' +
        '</div>' +
        
        // Direct Cost Per Mile
        '<div style="background:#fef2f2;padding:16px;border-radius:12px;text-align:center;border:1px solid #fecaca">' +
        '<div style="font-size:11px;color:#dc2626;text-transform:uppercase;margin-bottom:4px">Direct Cost/Mile</div>' +
        '<div style="font-size:24px;font-weight:700;color:#b91c1c">' + formatMoney(directCostPerMile) + '</div>' +
        '</div>' +
        
        // Revenue Per Mile
        '<div style="background:#f0fdf4;padding:16px;border-radius:12px;text-align:center;border:1px solid #bbf7d0">' +
        '<div style="font-size:11px;color:#16a34a;text-transform:uppercase;margin-bottom:4px">Revenue/Mile</div>' +
        '<div style="font-size:24px;font-weight:700;color:#15803d">' + formatMoney(revenuePerMile) + '</div>' +
        '</div>' +
        
        // Profit Per Mile
        '<div style="background:' + (netProfitPerMile >= 0 ? '#dcfce7' : '#fee2e2') + ';padding:16px;border-radius:12px;text-align:center;border:1px solid ' + (netProfitPerMile >= 0 ? '#86efac' : '#fecaca') + '">' +
        '<div style="font-size:11px;color:' + (netProfitPerMile >= 0 ? '#166534' : '#991b1b') + ';text-transform:uppercase;margin-bottom:4px">Profit/Mile</div>' +
        '<div style="font-size:24px;font-weight:700;color:' + (netProfitPerMile >= 0 ? '#15803d' : '#dc2626') + '">' + formatMoney(netProfitPerMile) + '</div>' +
        '</div>' +
        
        // Fuel CPM
        '<div style="background:#fff7ed;padding:16px;border-radius:12px;text-align:center;border:1px solid #fed7aa">' +
        '<div style="font-size:11px;color:#ea580c;text-transform:uppercase;margin-bottom:4px">Fuel Cost/Mile</div>' +
        '<div style="font-size:24px;font-weight:700;color:#c2410c">' + formatMoney(fuelCostPerMile) + '</div>' +
        '</div>' +
        
        // Profit Per Car
        '<div style="background:' + (netProfitPerTrip >= 0 ? '#f0fdf4' : '#fef2f2') + ';padding:16px;border-radius:12px;text-align:center;border:1px solid ' + (netProfitPerTrip >= 0 ? '#bbf7d0' : '#fecaca') + '">' +
        '<div style="font-size:11px;color:' + (netProfitPerTrip >= 0 ? '#16a34a' : '#dc2626') + ';text-transform:uppercase;margin-bottom:4px">Profit/Trip</div>' +
        '<div style="font-size:24px;font-weight:700;color:' + (netProfitPerTrip >= 0 ? '#15803d' : '#b91c1c') + '">' + formatMoney(netProfitPerTrip) + '</div>' +
        '</div>' +
        '</div>' +
        
        // Efficiency Ratios
        '<div style="background:#f8fafc;padding:16px;border-radius:12px">' +
        '<div style="font-weight:600;color:#334155;margin-bottom:12px">Expense Ratios (% of Revenue)</div>' +
        '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">' +
        '<div style="text-align:center"><div style="font-size:11px;color:#64748b">Fuel</div><div style="font-size:18px;font-weight:700;color:' + (fuelToRevenueRatio <= 15 ? '#16a34a' : fuelToRevenueRatio <= 25 ? '#f59e0b' : '#dc2626') + '">' + fuelToRevenueRatio.toFixed(1) + '%</div></div>' +
        '<div style="text-align:center"><div style="font-size:11px;color:#64748b">Fees (Broker+Local)</div><div style="font-size:18px;font-weight:700;color:' + (feeBurdenRatio <= 10 ? '#16a34a' : feeBurdenRatio <= 15 ? '#f59e0b' : '#dc2626') + '">' + feeBurdenRatio.toFixed(1) + '%</div></div>' +
        '<div style="text-align:center"><div style="font-size:11px;color:#64748b">Driver Cut</div><div style="font-size:18px;font-weight:700;color:#7c3aed">' + driverCutRatioDisplay.toFixed(1) + '%</div></div>' +
        '<div style="text-align:center"><div style="font-size:11px;color:#64748b">Trip Expenses</div><div style="font-size:18px;font-weight:700;color:' + (expenseRatio <= 10 ? '#16a34a' : expenseRatio <= 20 ? '#f59e0b' : '#dc2626') + '">' + expenseRatio.toFixed(1) + '%</div></div>' +
        '</div></div>' +
        '</div></div>' +
        
        // â•â•â• NEW: BREAK-EVEN ANALYSIS â•â•â•
        '<div class="card" style="padding:0;overflow:hidden;margin-bottom:24px">' +
        '<div style="background:linear-gradient(90deg,#7c3aed,#6d28d9);color:white;padding:16px 20px;font-weight:700;display:flex;align-items:center;gap:10px"><span style="font-size:20px">ðŸŽ¯</span> Break-Even Analysis</div>' +
        '<div style="padding:24px">' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px">' +
        
        '<div style="background:#f5f3ff;padding:20px;border-radius:12px;text-align:center;border-left:4px solid #7c3aed">' +
        '<div style="font-size:12px;color:#6d28d9;margin-bottom:4px">Break-Even PPC</div>' +
        '<div style="font-size:28px;font-weight:800;color:#5b21b6">' + formatMoney(breakEvenPPC) + '</div>' +
        '<div style="font-size:11px;color:#64748b;margin-top:4px">Min price per car needed</div>' +
        '</div>' +
        
        '<div style="background:#f5f3ff;padding:20px;border-radius:12px;text-align:center;border-left:4px solid #7c3aed">' +
        '<div style="font-size:12px;color:#6d28d9;margin-bottom:4px">Break-Even Cars/Month</div>' +
        '<div style="font-size:28px;font-weight:800;color:#5b21b6">' + breakEvenCarsPerMonth + '</div>' +
        '<div style="font-size:11px;color:#64748b;margin-top:4px">To cover fixed costs</div>' +
        '</div>' +
        
        '<div style="background:#f5f3ff;padding:20px;border-radius:12px;text-align:center;border-left:4px solid #7c3aed">' +
        '<div style="font-size:12px;color:#6d28d9;margin-bottom:4px">Break-Even Revenue/Mo</div>' +
        '<div style="font-size:28px;font-weight:800;color:#5b21b6">' + formatMoney(breakEvenRevenuePerMonth) + '</div>' +
        '<div style="font-size:11px;color:#64748b;margin-top:4px">Monthly target</div>' +
        '</div>' +
        
        '<div style="background:' + (marginOfSafety >= 20 ? '#dcfce7' : marginOfSafety >= 0 ? '#fef3c7' : '#fee2e2') + ';padding:20px;border-radius:12px;text-align:center;border-left:4px solid ' + (marginOfSafety >= 20 ? '#22c55e' : marginOfSafety >= 0 ? '#f59e0b' : '#ef4444') + '">' +
        '<div style="font-size:12px;color:' + (marginOfSafety >= 20 ? '#166534' : marginOfSafety >= 0 ? '#92400e' : '#991b1b') + ';margin-bottom:4px">Margin of Safety</div>' +
        '<div style="font-size:28px;font-weight:800;color:' + (marginOfSafety >= 20 ? '#15803d' : marginOfSafety >= 0 ? '#d97706' : '#dc2626') + '">' + marginOfSafety.toFixed(1) + '%</div>' +
        '<div style="font-size:11px;color:#64748b;margin-top:4px">' + (marginOfSafety >= 20 ? 'âœ“ Healthy buffer' : marginOfSafety >= 0 ? 'âš  Tight margin' : 'âŒ Below break-even') + '</div>' +
        '</div>' +
        '</div>' +
        
        (totalVariableCosts > 0 || fuelTransactionsCost > 0 ? 
        '<div style="margin-top:16px;padding:12px;background:#fef3c7;border-radius:8px;border:1px solid #fcd34d">' +
        '<div style="font-size:12px;color:#92400e"><strong>âš ï¸ Additional Costs (not in trip expenses):</strong> Variable Costs: ' + formatMoney(totalVariableCosts) + ' | Fuel Transactions: ' + formatMoney(fuelTransactionsCost) + '</div>' +
        '</div>' : '') +
        '</div></div>' +
        '</div>' +
        
        // Fixed Costs Breakdown
        '<div class="card" style="padding:0;overflow:hidden">' +
        '<div style="background:#f59e0b;color:white;padding:16px 20px;font-weight:700;display:flex;align-items:center;gap:10px"><span style="font-size:20px">ðŸ¢</span> Fixed Costs - ' + formatMoney(totalFixedCosts) + '</div>' +
        '<div style="padding:20px;max-height:280px;overflow-y:auto">' +
        '<div style="display:grid;gap:8px">' +
        ((appData.fixed_costs || []).length === 0 ? '<div style="text-align:center;padding:20px;color:#64748b">No fixed costs configured</div>' :
        (appData.fixed_costs || []).map(fc => 
          '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#f8fafc;border-radius:8px;border-left:3px solid #f59e0b">' +
          '<div><span style="font-weight:600;color:#1e293b">' + fc.name + '</span><span style="margin-left:8px;font-size:11px;color:#64748b;background:#e2e8f0;padding:2px 8px;border-radius:4px">' + (fc.category || 'OTHER') + '</span></div>' +
          '<div style="font-weight:700;color:#d97706">' + formatMoney(fc.amount * periodMonths) + '</div>' +
          '</div>'
        ).join('')) +
        '</div>' +
        '</div></div>' +
        '</div>';
    }
    
    // â•â•â• TRIPS TABLE SORTING & FILTERING â•â•â•
    let tripsSortCol = 'date';
    let tripsSortDir = 'desc';
    
    function filterTripsTable(filter) {
      const rows = document.querySelectorAll('#tripsFinancialTable tbody tr.trip-row');
      rows.forEach(row => {
        const profit = parseFloat(row.dataset.profit || 0);
        if (filter === 'all') row.style.display = '';
        else if (filter === 'profitable') row.style.display = profit >= 0 ? '' : 'none';
        else if (filter === 'losing') row.style.display = profit < 0 ? '' : 'none';
      });
    }
    
    function sortTripsTable(col) {
      if (tripsSortCol === col) tripsSortDir = tripsSortDir === 'asc' ? 'desc' : 'asc';
      else { tripsSortCol = col; tripsSortDir = 'desc'; }
      
      const tbody = document.querySelector('#tripsFinancialTable tbody');
      const rows = Array.from(tbody.querySelectorAll('tr.trip-row'));
      
      rows.sort((a, b) => {
        let aVal, bVal;
        const cells = { a: a.cells, b: b.cells };
        
        switch(col) {
          case 'date': aVal = new Date(cells.a[0].textContent); bVal = new Date(cells.b[0].textContent); break;
          case 'trip': aVal = cells.a[1].textContent; bVal = cells.b[1].textContent; break;
          case 'cars': aVal = parseInt(cells.a[4].textContent) || 0; bVal = parseInt(cells.b[4].textContent) || 0; break;
          case 'miles': aVal = parseInt(cells.a[5].textContent.replace(/,/g,'')) || 0; bVal = parseInt(cells.b[5].textContent.replace(/,/g,'')) || 0; break;
          case 'revenue': aVal = parseFloat(cells.a[6].textContent.replace(/[$,]/g,'')) || 0; bVal = parseFloat(cells.b[6].textContent.replace(/[$,]/g,'')) || 0; break;
          case 'expenses': aVal = parseFloat(cells.a[7].textContent.replace(/[$,]/g,'')) || 0; bVal = parseFloat(cells.b[7].textContent.replace(/[$,]/g,'')) || 0; break;
          case 'profit': aVal = parseFloat(a.dataset.profit) || 0; bVal = parseFloat(b.dataset.profit) || 0; break;
          case 'margin': aVal = parseFloat(cells.a[9].textContent) || 0; bVal = parseFloat(cells.b[9].textContent) || 0; break;
          case 'ppm': aVal = parseFloat(cells.a[10].textContent.replace(/[$,]/g,'')) || 0; bVal = parseFloat(cells.b[10].textContent.replace(/[$,]/g,'')) || 0; break;
          default: aVal = 0; bVal = 0;
        }
        
        if (aVal < bVal) return tripsSortDir === 'asc' ? -1 : 1;
        if (aVal > bVal) return tripsSortDir === 'asc' ? 1 : -1;
        return 0;
      });
      
      rows.forEach(row => tbody.appendChild(row));
    }

    function showTripAnalysis(tripId) {
      if (!tripId) { document.getElementById('tripAnalysisResult').innerHTML = ''; return; }
      
      const trip = appData.trips.find(t => t.id === parseInt(tripId));
      const driver = appData.drivers.find(d => d.id === trip.driver_id);
      const truck = appData.trucks.find(t => t.id === trip.truck_id);
      const orders = appData.orders.filter(o => o.trip_id === parseInt(tripId));
      const expenses = appData.expenses.filter(e => e.trip_id === parseInt(tripId));
      const targetUtil = parseFloat(document.getElementById('targetUtilization').value) || 85;
      
      // Financial calculations
      const loadRevenue = orders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
      const brokerFee = orders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
      const localFee = orders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
      const cleanGross = loadRevenue - brokerFee - localFee;
      const driverCutPercent = trip.driver_cut_percent || 32;
      const driverCut = cleanGross * (driverCutPercent / 100);
      
      // Expense breakdown
      const fuelCosts = { FUEL: 0, TOLLS: 0, PERMITS: 0, PARKING: 0, MAINTENANCE: 0, OTHER: 0 };
      expenses.forEach(e => {
        if (fuelCosts[e.category] !== undefined) fuelCosts[e.category] += parseFloat(e.amount || 0);
        else fuelCosts.OTHER += parseFloat(e.amount || 0);
      });
      const tripExpenses = expenses.reduce((s, e) => s + parseFloat(e.amount || 0), 0);
      
      // Direct Trip Expenses = ALL costs for this trip
      const directTripExpenses = brokerFee + localFee + driverCut + tripExpenses;
      
      // Trip Net Profit = Revenue - All Trip Costs
      const tripNetProfit = loadRevenue - directTripExpenses;
      
      // Cash collected (COD + COP only)
      const cashCollected = orders.filter(o => o.payment_type === 'COD' || o.payment_type === 'COP').reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
      const expenseReimbursement = fuelCosts.OTHER; // Only OTHER category is reimbursed
      const netPayToDriver = driverCut - cashCollected + expenseReimbursement;
      
      // Miles and metrics
      const miles = parseFloat(trip.miles || 0);
      const totalCars = orders.length;
      const avgPricePerCar = totalCars > 0 ? loadRevenue / totalCars : 0;
      const revenuePerMile = miles > 0 ? loadRevenue / miles : 0;
      const netProfitPerMile = miles > 0 ? tripNetProfit / miles : 0;
      const fuelCostPerMile = miles > 0 ? fuelCosts.FUEL / miles : 0;
      const variableCostPerMile = miles > 0 ? directTripExpenses / miles : 0;
      
      // Utilization calculation (assuming 8-car hauler)
      const maxCapacity = 8;
      const haulerType = '8-Car Hauler';
      const tripUtilization = (totalCars / (maxCapacity * 2)) * 100; // *2 for round trip
      
      // Outbound vs Return (based on vehicle_direction)
      const outboundOrders = orders.filter(o => o.vehicle_direction && (o.vehicle_direction.includes('HOME_TO') || o.vehicle_direction.includes('NY_TO')));
      const returnOrders = orders.filter(o => o.vehicle_direction && (o.vehicle_direction.includes('TO_HOME') || o.vehicle_direction.includes('CA_TO') || o.vehicle_direction.includes('FL_TO')));
      const outboundCount = outboundOrders.length || Math.floor(totalCars / 2);
      const returnCount = returnOrders.length || totalCars - outboundCount;
      const outboundUtil = (outboundCount / maxCapacity) * 100;
      const returnUtil = (returnCount / maxCapacity) * 100;
      
      // Overhead allocation (monthly fixed costs / avg trips per month)
      const monthlyFixedCosts = (appData.fixed_costs || []).reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);
      const avgTripsPerMonth = appData.trips.length > 0 ? Math.max(1, appData.trips.length / 3) : 1;
      const overheadAllocation = monthlyFixedCosts / avgTripsPerMonth;
      const trueNetProfit = tripNetProfit - overheadAllocation;
      const trueNetProfitMargin = loadRevenue > 0 ? (trueNetProfit / loadRevenue) * 100 : 0;
      
      // Operating Ratio (total costs / revenue)
      const operatingRatio = loadRevenue > 0 ? (directTripExpenses / loadRevenue) * 100 : 0;
      
      // Rating
      let utilizationRating = 'Poor';
      let utilizationColor = '#dc2626';
      if (tripUtilization >= 90) { utilizationRating = 'Excellent'; utilizationColor = '#16a34a'; }
      else if (tripUtilization >= 80) { utilizationRating = 'Good'; utilizationColor = '#2563eb'; }
      else if (tripUtilization >= 70) { utilizationRating = 'Acceptable'; utilizationColor = '#ca8a04'; }
      
      let overallRating = 'Not Profitable';
      let overallColor = '#dc2626';
      if (trueNetProfit >= overheadAllocation) { overallRating = 'Highly Profitable'; overallColor = '#16a34a'; }
      else if (trueNetProfit >= 0) { overallRating = 'Profitable'; overallColor = '#2563eb'; }
      else if (trueNetProfit >= -500) { overallRating = 'Break Even'; overallColor = '#ca8a04'; }
      
      const isAboveTarget = tripNetProfit >= overheadAllocation;
      
      // Build utilization bar
      const utilBar = '<div style="background:#e5e7eb;border-radius:4px;height:20px;width:200px;overflow:hidden"><div style="background:' + utilizationColor + ';height:100%;width:' + Math.min(tripUtilization, 100) + '%"></div></div>';
      
      document.getElementById('tripAnalysisResult').innerHTML = 
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">' +
        
        // LEFT COLUMN - Financial Breakdown
        '<div>' +
        '<div style="background:#1e40af;color:white;padding:10px 16px;border-radius:8px 8px 0 0;font-weight:600">ðŸ’° Financial Breakdown</div>' +
        '<div style="border:1px solid #e5e7eb;border-top:none;padding:16px;border-radius:0 0 8px 8px">' +
        '<table style="width:100%;font-size:14px">' +
        '<tr><td>Load Revenue</td><td style="text-align:right;font-weight:600">' + formatMoney(loadRevenue) + '</td></tr>' +
        '<tr><td style="padding-left:16px;color:#64748b">Broker Fee</td><td style="text-align:right;color:#ef4444">(' + formatMoney(brokerFee) + ')</td></tr>' +
        '<tr><td style="padding-left:16px;color:#64748b">Local Fee</td><td style="text-align:right;color:#f59e0b">(' + formatMoney(localFee) + ')</td></tr>' +
        '<tr><td style="padding-left:16px;color:#8b5cf6">Driver\'s Cut (' + driverCutPercent + '%)</td><td style="text-align:right;color:#8b5cf6">(' + formatMoney(driverCut) + ')</td></tr>' +
        '<tr><td style="padding-left:16px">Fuel</td><td style="text-align:right">(' + formatMoney(fuelCosts.FUEL) + ')</td></tr>' +
        '<tr><td style="padding-left:16px">Tolls</td><td style="text-align:right">(' + formatMoney(fuelCosts.TOLLS) + ')</td></tr>' +
        '<tr><td style="padding-left:16px">Permits</td><td style="text-align:right">(' + formatMoney(fuelCosts.PERMITS) + ')</td></tr>' +
        '<tr><td style="padding-left:16px">Parking</td><td style="text-align:right">(' + formatMoney(fuelCosts.PARKING) + ')</td></tr>' +
        '<tr><td style="padding-left:16px">Maintenance</td><td style="text-align:right">(' + formatMoney(fuelCosts.MAINTENANCE) + ')</td></tr>' +
        '<tr><td style="padding-left:16px">Other</td><td style="text-align:right">(' + formatMoney(fuelCosts.OTHER) + ')</td></tr>' +
        '<tr style="background:#fee2e2"><td style="font-weight:600;color:#991b1b">Total Direct Trip Expenses</td><td style="text-align:right;font-weight:600;color:#dc2626">(' + formatMoney(directTripExpenses) + ')</td></tr>' +
        '<tr style="background:' + (tripNetProfit >= 0 ? '#d1fae5' : '#fee2e2') + '"><td style="font-weight:700">Trip Net Profit</td><td style="text-align:right;font-weight:700;color:' + (tripNetProfit >= 0 ? '#16a34a' : '#dc2626') + '">' + formatMoney(tripNetProfit) + '</td></tr>' +
        '</table>' +
        '</div>' +
        
        // Other Metrics
        '<div style="background:#6b7280;color:white;padding:10px 16px;border-radius:8px 8px 0 0;font-weight:600;margin-top:16px">ðŸ“Š Other Metrics</div>' +
        '<div style="border:1px solid #e5e7eb;border-top:none;padding:16px;border-radius:0 0 8px 8px">' +
        '<table style="width:100%;font-size:14px">' +
        '<tr><td>Avg Price Per Car (APPC)</td><td style="text-align:right;font-weight:600">' + formatMoney(avgPricePerCar) + '</td></tr>' +
        '<tr><td>Revenue Per Mile (RPM)</td><td style="text-align:right">' + formatMoney(revenuePerMile) + '</td></tr>' +
        '<tr><td>Trip Net Profit/Mile (NPPM)</td><td style="text-align:right">' + formatMoney(netProfitPerMile) + '</td></tr>' +
        '<tr><td>Fuel Costs Per Mile</td><td style="text-align:right">' + formatMoney(fuelCostPerMile) + '</td></tr>' +
        '<tr><td>Variable Cost Per Mile</td><td style="text-align:right">' + formatMoney(variableCostPerMile) + '</td></tr>' +
        '</table>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px">' +
        '<div style="background:#dbeafe;padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#1d4ed8">Cash Collected</div><div style="font-weight:700">' + formatMoney(cashCollected) + '</div></div>' +
        '<div style="background:#d1fae5;padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#16a34a">Driver Earnings</div><div style="font-weight:700">' + formatMoney(driverCut + expenseReimbursement) + '</div></div>' +
        '<div style="background:#fef3c7;padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#92400e">Other Reimb.</div><div style="font-weight:700">' + formatMoney(expenseReimbursement) + '</div></div>' +
        '<div style="background:#ede9fe;padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px;color:#6d28d9">Net Pay to Driver</div><div style="font-weight:700">' + formatMoney(netPayToDriver) + '</div></div>' +
        '</div></div>' +
        '</div>' +
        
        // RIGHT COLUMN - Trip Info & Utilization
        '<div>' +
        '<div style="background:#059669;color:white;padding:10px 16px;border-radius:8px 8px 0 0;font-weight:600">ðŸš› Trip Info</div>' +
        '<div style="border:1px solid #e5e7eb;border-top:none;padding:16px;border-radius:0 0 8px 8px">' +
        '<table style="width:100%;font-size:14px">' +
        '<tr><td>Trip #</td><td style="text-align:right;font-weight:600">' + trip.trip_number + '</td></tr>' +
        '<tr><td>Date</td><td style="text-align:right">' + (trip.trip_date || '-') + '</td></tr>' +
        '<tr><td>Driver</td><td style="text-align:right">' + (driver ? driver.first_name + ' ' + driver.last_name : '-') + '</td></tr>' +
        '<tr><td>Truck #</td><td style="text-align:right">' + (truck ? truck.truck_number : '-') + '</td></tr>' +
        '<tr><td>Hauler Type</td><td style="text-align:right">' + haulerType + '</td></tr>' +
        '<tr><td>Total Miles</td><td style="text-align:right;font-weight:600">' + miles.toLocaleString() + ' mi</td></tr>' +
        '</table></div>' +
        
        // Capacity & Utilization
        '<div style="background:#7c3aed;color:white;padding:10px 16px;border-radius:8px 8px 0 0;font-weight:600;margin-top:16px">ðŸ“¦ Trip Capacity & Utilization</div>' +
        '<div style="border:1px solid #e5e7eb;border-top:none;padding:16px;border-radius:0 0 8px 8px">' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:12px"><span>Max Capacity:</span><span style="font-weight:600">' + maxCapacity + ' cars</span></div>' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:12px"><span>Total Cars Loaded:</span><span style="font-weight:600">' + totalCars + ' cars</span></div>' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span>Trip Utilization:</span><span style="font-weight:700;color:' + utilizationColor + '">' + tripUtilization.toFixed(1) + '%</span></div>' +
        '<div style="margin-bottom:12px">' + utilBar + '</div>' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Target Utilization:</span><span style="font-weight:600">' + targetUtil + '%</span></div>' +
        '<div style="display:flex;justify-content:space-between"><span>Rating:</span><span style="font-weight:700;color:' + utilizationColor + '">' + utilizationRating + '</span></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px">' +
        '<div style="background:#dbeafe;padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px">Outbound Leg</div><div style="font-weight:700">' + outboundUtil.toFixed(0) + '%</div><div style="font-size:11px;color:#64748b">' + outboundCount + ' of ' + maxCapacity + ' cars</div></div>' +
        '<div style="background:#d1fae5;padding:12px;border-radius:8px;text-align:center"><div style="font-size:11px">Return Leg</div><div style="font-weight:700">' + returnUtil.toFixed(0) + '%</div><div style="font-size:11px;color:#64748b">' + returnCount + ' of ' + maxCapacity + ' cars</div></div>' +
        '</div></div>' +
        
        // Profitability Analysis
        '<div style="background:' + (trueNetProfit >= 0 ? '#16a34a' : '#dc2626') + ';color:white;padding:10px 16px;border-radius:8px 8px 0 0;font-weight:600;margin-top:16px">ðŸ“ˆ Profitability Analysis</div>' +
        '<div style="border:1px solid #e5e7eb;border-top:none;padding:16px;border-radius:0 0 8px 8px">' +
        '<div style="text-align:center;margin-bottom:16px"><div style="font-size:12px;color:#64748b">True Net Profit of Trip</div><div style="font-size:28px;font-weight:700;color:' + (trueNetProfit >= 0 ? '#16a34a' : '#dc2626') + '">' + (trueNetProfit >= 0 ? 'â†‘' : 'â†“') + ' ' + formatMoney(trueNetProfit) + '</div></div>' +
        '<div style="background:' + (isAboveTarget ? '#d1fae5' : '#fee2e2') + ';padding:12px;border-radius:8px;text-align:center;margin-bottom:12px;font-size:13px">' +
        'This trip\'s contribution of ' + formatMoney(tripNetProfit) + ' was ' + (isAboveTarget ? 'ðŸŸ¢ ABOVE' : 'ðŸ”´ BELOW') + ' the overhead allocation per trip.' +
        '</div>' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Overhead Allocation/Trip:</span><span style="font-weight:600">' + formatMoney(overheadAllocation) + '</span></div>' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Trip vs Break-Even:</span><span style="font-weight:700;color:' + (tripNetProfit - overheadAllocation >= 0 ? '#16a34a' : '#dc2626') + '">' + formatMoney(tripNetProfit - overheadAllocation) + '</span></div>' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Operating Ratio:</span><span style="font-weight:600">' + operatingRatio.toFixed(1) + '%</span></div>' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>True Net Profit Margin:</span><span style="font-weight:700;color:' + (trueNetProfitMargin >= 0 ? '#16a34a' : '#dc2626') + '">' + trueNetProfitMargin.toFixed(1) + '%</span></div>' +
        '<div style="text-align:center;margin-top:16px;padding:16px;background:#f8fafc;border-radius:8px"><div style="font-size:12px;color:#64748b">Overall Rating</div><div style="font-size:24px;font-weight:700;color:' + overallColor + '">' + overallRating + '</div></div>' +
        '</div></div>' +
        '</div>' +
        
        // TRIP DETAILS TABLE
        '<div style="grid-column:1/-1;margin-top:16px">' +
        '<div style="background:#475569;color:white;padding:10px 16px;border-radius:8px 8px 0 0;font-weight:600">ðŸ“‹ Trip Details - Vehicles</div>' +
        '<div class="table-wrapper" style="border:1px solid #e5e7eb;border-top:none;border-radius:0 0 8px 8px"><table><thead><tr><th>Direction</th><th>Order #</th><th>Dispatcher</th><th>Broker</th><th>Vehicle</th><th>Origin</th><th>Destination</th><th>Pick-Up</th><th>Delivery</th><th>Payment</th><th>Broker Fee</th><th>Local Fee</th><th>Revenue</th></tr></thead><tbody>' +
        orders.map(o => {
          const disp = appData.dispatchers.find(d => d.id === o.dispatcher_id);
          const dirLabel = vehicleDirections.find(d => d.id === o.vehicle_direction)?.label || '-';
          const noteHtml = o.dispatcher_notes ? '<tr style="background:#fef3c7"><td colspan="13" style="padding:8px 16px;font-size:13px"><span style="font-weight:600;color:#92400e">ðŸ“ Note:</span> ' + o.dispatcher_notes + '</td></tr>' : '';
          return '<tr><td><span class="badge" style="background:#6366f1;color:white">' + dirLabel + '</span></td><td><strong>' + o.order_number + '</strong>' + (o.dispatcher_notes ? ' ðŸ“' : '') + '</td><td>' + (disp ? disp.name : '-') + '</td><td>' + (o.broker_name || '-') + '</td><td>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</td><td>' + (o.origin || '-') + '</td><td>' + (o.destination || '-') + '</td><td>' + (o.pickup_date ? formatDate(o.pickup_date) : '-') + '</td><td>' + (o.dropoff_date ? formatDate(o.dropoff_date) : '-') + '</td><td><span class="badge badge-blue">' + (o.payment_type || '-') + '</span></td><td class="money negative">' + formatMoney(o.broker_fee || 0) + '</td><td class="money negative">' + formatMoney(o.local_fee || 0) + '</td><td class="money">' + formatMoney(o.revenue) + '</td></tr>' + noteHtml;
        }).join('') +
        '</tbody></table></div></div>' +
        '</div>';
    }

    // ============ PROFITABILITY DASHBOARD ============
    function renderProfitability(c) {
      try {
        const trips = appData.trips || [];
        const orders = appData.orders || [];
        const trucks = appData.trucks || [];
        const maintenance = appData.maintenance_records || [];
        const fuelRecords = appData.fuel_transactions || [];
        const fixedCosts = appData.fixed_costs || [];
        const variableCosts = appData.variable_costs || [];
      
      // Period selector - calculate months in data
      const tripDates = trips.filter(t => t.trip_date).map(t => parseTripDate(t.trip_date)).filter(d => d !== null);
      const minDate = tripDates.length > 0 ? new Date(Math.min(...tripDates)) : new Date();
      const maxDate = tripDates.length > 0 ? new Date(Math.max(...tripDates)) : new Date();
      const monthsInData = Math.max(1, Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24 * 30)));
      
      // â•â•â• FIXED: Use getTripFin() for accurate revenue/cost data â•â•â•
      let totalRevenue = 0, totalBrokerFees = 0, totalLocalFees = 0, totalDriverPay = 0, totalTripExpenses = 0;
      let totalMiles = 0, totalCars = 0;
      
      trips.forEach(t => {
        const fin = getTripFin(t.id);
        totalRevenue += fin.loadRevenue;
        totalBrokerFees += fin.brokerFee;
        totalLocalFees += fin.localFees;
        totalDriverPay += fin.driverCut;
        totalTripExpenses += fin.totalExpenses;
        totalMiles += parseFloat(t.miles || 0);
        totalCars += fin.vehicleCount;
      });
      
      const cleanRevenue = totalRevenue - totalBrokerFees - totalLocalFees;
      const avgRevenuePerMile = totalMiles > 0 ? totalRevenue / totalMiles : 0;
      
      // Calculate Variable Costs (Fuel Records + Maintenance Records + Variable Costs table)
      // Note: Trip expenses (fuel, tolls etc.) are already in totalTripExpenses from getTripFin()
      const totalFuelFromRecords = fuelRecords.reduce((sum, f) => sum + parseFloat(f.total_cost || 0), 0);
      const totalMaintenanceCost = maintenance.reduce((sum, m) => sum + parseFloat(m.total_cost || 0), 0);
      const totalOtherVariableCosts = variableCosts.reduce((sum, vc) => sum + parseFloat(vc.amount || 0), 0);
      // Don't double-count: totalTripExpenses already includes trip-level fuel/tolls
      const totalVariableCosts = totalFuelFromRecords + totalMaintenanceCost + totalOtherVariableCosts;
      
      // Calculate Fixed Costs (monthly * months in data)
      const monthlyFixedCosts = fixedCosts.reduce((sum, fc) => sum + parseFloat(fc.amount || 0), 0);
      const totalFixedCosts = monthlyFixedCosts * monthsInData;
      
      // TOTAL COSTS & TRUE NET PROFIT (using accurate data from getTripFin)
      const totalAllCosts = totalBrokerFees + totalLocalFees + totalDriverPay + totalTripExpenses + totalVariableCosts + totalFixedCosts;
      const grossProfit = cleanRevenue - totalDriverPay;
      const operatingProfit = grossProfit - totalTripExpenses - totalVariableCosts;
      const trueNetProfit = operatingProfit - totalFixedCosts;
      const profitMargin = totalRevenue > 0 ? (trueNetProfit / totalRevenue * 100) : 0;
      
      // â•â•â• NEW: Cost Per Mile & Profit Per Mile metrics â•â•â•
      const totalCPM = totalMiles > 0 ? totalAllCosts / totalMiles : 0;
      const fuelCPM = totalMiles > 0 ? totalFuelFromRecords / totalMiles : 0;
      const profitPerMile = totalMiles > 0 ? trueNetProfit / totalMiles : 0;
      const profitPerCar = totalCars > 0 ? trueNetProfit / totalCars : 0;
      
      // ---- BROKER PROFITABILITY (Using orders data for accuracy) ----
      const brokerStats = {};
      
      orders.forEach(o => {
        if (!o.trip_id) return; // Skip unassigned orders
        const trip = trips.find(t => t.id === o.trip_id);
        if (!trip) return;
        
        const brokerName = o.broker_name || 'Unknown';
        const revenue = parseFloat(o.revenue || 0);
        const brokerFee = parseFloat(o.broker_fee || 0);
        const localFee = parseFloat(o.local_fee || 0);
        
        if (!brokerStats[brokerName]) {
          brokerStats[brokerName] = { revenue: 0, trips: new Set(), brokerFee: 0, localFee: 0, cars: 0 };
        }
        brokerStats[brokerName].revenue += revenue;
        brokerStats[brokerName].brokerFee += brokerFee;
        brokerStats[brokerName].localFee += localFee;
        brokerStats[brokerName].trips.add(o.trip_id);
        brokerStats[brokerName].cars += 1;
      });
      
      const brokerList = Object.entries(brokerStats)
        .map(([name, data]) => {
          const cleanRevenue = data.revenue - data.brokerFee - data.localFee;
          return {
            name,
            revenue: data.revenue,
            trips: data.trips.size,
            cars: data.cars,
            brokerFee: data.brokerFee,
            profit: cleanRevenue,
            feePercent: data.revenue > 0 ? (data.brokerFee / data.revenue * 100) : 0
          };
        })
        .sort((a, b) => b.profit - a.profit)
        .slice(0, 10);
      
      // ---- LANE PROFITABILITY (Using orders data for accuracy) ----
      const laneStats = {};
      
      orders.forEach(o => {
        if (!o.trip_id || !o.origin || !o.destination) return;
        const trip = trips.find(t => t.id === o.trip_id);
        if (!trip) return;
        
        const originState = extractState(o.origin);
        const destState = extractState(o.destination);
        const lane = originState + ' â†’ ' + destState;
        
        const revenue = parseFloat(o.revenue || 0);
        const brokerFee = parseFloat(o.broker_fee || 0);
        const localFee = parseFloat(o.local_fee || 0);
        const cleanRevenue = revenue - brokerFee - localFee;
        
        if (!laneStats[lane]) {
          laneStats[lane] = { revenue: 0, miles: 0, trips: new Set(), profit: 0, cars: 0 };
        }
        laneStats[lane].revenue += revenue;
        laneStats[lane].profit += cleanRevenue;
        laneStats[lane].trips.add(o.trip_id);
        laneStats[lane].cars += 1;
        // Add trip miles proportionally (divide by cars in trip)
        const tripOrders = orders.filter(ord => ord.trip_id === o.trip_id).length;
        if (tripOrders > 0) {
          laneStats[lane].miles += parseFloat(trip.miles || 0) / tripOrders;
        }
      });
      
      const laneList = Object.entries(laneStats)
        .map(([lane, data]) => ({
          lane,
          revenue: data.revenue,
          miles: Math.round(data.miles),
          trips: data.trips.size,
          cars: data.cars,
          profit: data.profit,
          rpm: data.miles > 0 ? data.revenue / data.miles : 0,
          ppm: data.miles > 0 ? data.profit / data.miles : 0
        }))
        .sort((a, b) => b.ppm - a.ppm)
        .slice(0, 10);
      
      // ---- TRUCK PROFITABILITY (Using getTripFin for accuracy) ----
      const truckStats = {};
      trucks.forEach(t => {
        truckStats[t.id] = {
          truck_number: t.truck_number,
          revenue: 0,
          miles: 0,
          trips: 0,
          profit: 0,
          fuelCost: 0,
          maintenanceCost: 0,
          driverCut: 0
        };
      });
      
      trips.forEach(t => {
        if (t.truck_id && truckStats[t.truck_id]) {
          const fin = getTripFin(t.id);
          truckStats[t.truck_id].revenue += fin.loadRevenue;
          truckStats[t.truck_id].profit += fin.netProfit;
          truckStats[t.truck_id].driverCut += fin.driverCut;
          truckStats[t.truck_id].miles += parseFloat(t.miles || 0);
          truckStats[t.truck_id].trips += 1;
        }
      });
      
      fuelRecords.forEach(f => {
        if (f.truck_id && truckStats[f.truck_id]) {
          truckStats[f.truck_id].fuelCost += parseFloat(f.total_cost || 0);
        }
      });
      
      maintenance.forEach(m => {
        if (m.truck_id && truckStats[m.truck_id]) {
          truckStats[m.truck_id].maintenanceCost += parseFloat(m.total_cost || 0);
        }
      });
      
      const truckList = Object.values(truckStats)
        .map(t => ({
          ...t,
          totalCost: t.fuelCost + t.maintenanceCost,
          // Net profit from trips minus truck-specific costs
          trueProfit: t.profit - t.fuelCost - t.maintenanceCost,
          rpm: t.miles > 0 ? t.revenue / t.miles : 0,
          cpm: t.miles > 0 ? (t.fuelCost + t.maintenanceCost) / t.miles : 0,
          ppm: t.miles > 0 ? (t.profit - t.fuelCost - t.maintenanceCost) / t.miles : 0
        }))
        .filter(t => t.revenue > 0 || t.totalCost > 0)
        .sort((a, b) => b.trueProfit - a.trueProfit);
      
      // Build HTML
      c.innerHTML = '<div class="header"><h2>ðŸ’Ž Profitability Dashboard</h2></div>' +
        
        // Summary Stats - Enhanced with new metrics
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px"><div class="label">Total Revenue</div><div class="value" style="color:#10b981">' + formatMoney(totalRevenue) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Total Costs</div><div class="value" style="color:#ef4444">' + formatMoney(totalAllCosts) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px;border-left:3px solid ' + (trueNetProfit >= 0 ? '#10b981' : '#ef4444') + '"><div class="label">Net Profit</div><div class="value" style="color:' + (trueNetProfit >= 0 ? '#10b981' : '#ef4444') + '">' + formatMoney(trueNetProfit) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Profit Margin</div><div class="value" style="color:' + (profitMargin >= 20 ? '#10b981' : profitMargin >= 10 ? '#f59e0b' : '#ef4444') + '">' + profitMargin.toFixed(1) + '%</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px"><div class="label">Avg $/Mile</div><div class="value">' + formatMoney(avgRevenuePerMile) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Total Miles</div><div class="value">' + totalMiles.toLocaleString() + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Total Cars</div><div class="value">' + totalCars.toLocaleString() + '</div></div>' +
        '</div>' +
        
        // NEW: Per-Mile & Per-Car Analysis
        '<div class="card" style="margin-bottom:24px;background:linear-gradient(135deg,#1e3a5f,#1e40af);color:white"><div class="card-header" style="border:none"><h3 style="color:white">ðŸ“Š Key Performance Metrics</h3></div><div style="padding:20px">' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px">' +
        '<div style="background:rgba(255,255,255,0.15);padding:16px;border-radius:8px;text-align:center"><div style="font-size:11px;opacity:0.8">Cost Per Mile</div><div style="font-size:24px;font-weight:700">' + formatMoney(totalCPM) + '</div></div>' +
        '<div style="background:rgba(255,255,255,0.15);padding:16px;border-radius:8px;text-align:center"><div style="font-size:11px;opacity:0.8">Fuel CPM</div><div style="font-size:24px;font-weight:700">' + formatMoney(fuelCPM) + '</div></div>' +
        '<div style="background:' + (profitPerMile >= 0 ? 'rgba(34,197,94,0.3)' : 'rgba(239,68,68,0.3)') + ';padding:16px;border-radius:8px;text-align:center"><div style="font-size:11px;opacity:0.8">Profit Per Mile</div><div style="font-size:24px;font-weight:700;color:' + (profitPerMile >= 0 ? '#4ade80' : '#f87171') + '">' + formatMoney(profitPerMile) + '</div></div>' +
        '<div style="background:' + (profitPerCar >= 0 ? 'rgba(34,197,94,0.3)' : 'rgba(239,68,68,0.3)') + ';padding:16px;border-radius:8px;text-align:center"><div style="font-size:11px;opacity:0.8">Profit Per Car</div><div style="font-size:24px;font-weight:700;color:' + (profitPerCar >= 0 ? '#4ade80' : '#f87171') + '">' + formatMoney(profitPerCar) + '</div></div>' +
        '<div style="background:rgba(255,255,255,0.15);padding:16px;border-radius:8px;text-align:center"><div style="font-size:11px;opacity:0.8">Fee Burden</div><div style="font-size:24px;font-weight:700">' + (totalRevenue > 0 ? ((totalBrokerFees + totalLocalFees) / totalRevenue * 100).toFixed(1) : 0) + '%</div></div>' +
        '<div style="background:rgba(255,255,255,0.15);padding:16px;border-radius:8px;text-align:center"><div style="font-size:11px;opacity:0.8">Driver Ratio</div><div style="font-size:24px;font-weight:700">' + (cleanRevenue > 0 ? (totalDriverPay / cleanRevenue * 100).toFixed(1) : 0) + '%</div></div>' +
        '</div></div></div>' +
        
        // Cost Breakdown Card
        '<div class="card" style="margin-bottom:24px"><div class="card-header"><h3>ðŸ’° Cost Breakdown</h3></div><div style="padding:20px">' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px">' +
        '<div style="background:#fef2f2;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#991b1b">â›½ Fuel (Records)</div><div style="font-size:20px;font-weight:700;color:#dc2626">' + formatMoney(totalFuelFromRecords) + '</div></div>' +
        '<div style="background:#fef3c7;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#92400e">ðŸ”§ Maintenance</div><div style="font-size:20px;font-weight:700;color:#d97706">' + formatMoney(totalMaintenanceCost) + '</div></div>' +
        '<div style="background:#f3e8ff;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#6b21a8">ðŸ“Š Variable Costs</div><div style="font-size:20px;font-weight:700;color:#7c3aed">' + formatMoney(totalOtherVariableCosts) + '</div></div>' +
        '<div style="background:#dbeafe;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#1e40af">ðŸ¢ Fixed (Monthly)</div><div style="font-size:20px;font-weight:700;color:#2563eb">' + formatMoney(monthlyFixedCosts) + '</div></div>' +
        '<div style="background:#f1f5f9;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#475569">ðŸ‘¤ Driver Pay</div><div style="font-size:20px;font-weight:700;color:#64748b">' + formatMoney(totalDriverPay) + '</div></div>' +
        '<div style="background:#fce7f3;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#9d174d">ðŸ’¸ Fees</div><div style="font-size:20px;font-weight:700;color:#be185d">' + formatMoney(totalBrokerFees + totalLocalFees) + '</div></div>' +
        '<div style="background:#ecfdf5;padding:16px;border-radius:8px;text-align:center"><div style="font-size:12px;color:#166534">ðŸ“‹ Trip Expenses</div><div style="font-size:20px;font-weight:700;color:#16a34a">' + formatMoney(totalTripExpenses) + '</div></div>' +
        '</div></div></div>' +
        
        // Two column layout
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px">' +
        
        // Top Brokers - Enhanced with profit
        '<div class="card"><div class="card-header"><h3>ðŸ† Top Brokers by Profit</h3></div><div class="table-wrapper"><table><thead><tr><th>Broker</th><th>Cars</th><th>Trips</th><th>Revenue</th><th>Profit</th><th>Fee %</th></tr></thead><tbody>' +
        (brokerList.length === 0 ? '<tr><td colspan="6" style="text-align:center;padding:20px">No data</td></tr>' :
        brokerList.map((b, i) => {
          const medal = i === 0 ? 'ðŸ¥‡ ' : i === 1 ? 'ðŸ¥ˆ ' : i === 2 ? 'ðŸ¥‰ ' : '';
          const profitColor = b.profit >= 0 ? '#10b981' : '#ef4444';
          return '<tr><td><strong>' + medal + b.name + '</strong></td><td>' + b.cars + '</td><td>' + b.trips + '</td><td class="money">' + formatMoney(b.revenue) + '</td><td class="money" style="color:' + profitColor + ';font-weight:600">' + formatMoney(b.profit) + '</td><td style="color:#f59e0b">' + b.feePercent.toFixed(1) + '%</td></tr>';
        }).join('')) +
        '</tbody></table></div></div>' +
        
        // Top Lanes - Enhanced with PPM
        '<div class="card"><div class="card-header"><h3>ðŸ›£ï¸ Top Lanes by Profit/Mile</h3></div><div class="table-wrapper"><table><thead><tr><th>Lane</th><th>Cars</th><th>Miles</th><th>Revenue</th><th>Profit</th><th>$/Mile</th></tr></thead><tbody>' +
        (laneList.length === 0 ? '<tr><td colspan="6" style="text-align:center;padding:20px">No data</td></tr>' :
        laneList.map((l, i) => {
          const medal = i === 0 ? 'ðŸ¥‡ ' : i === 1 ? 'ðŸ¥ˆ ' : i === 2 ? 'ðŸ¥‰ ' : '';
          const ppmColor = l.ppm >= 0.5 ? '#10b981' : l.ppm >= 0 ? '#f59e0b' : '#ef4444';
          return '<tr><td><strong>' + medal + l.lane + '</strong></td><td>' + l.cars + '</td><td>' + l.miles.toLocaleString() + '</td><td class="money">' + formatMoney(l.revenue) + '</td><td class="money" style="color:' + (l.profit >= 0 ? '#10b981' : '#ef4444') + '">' + formatMoney(l.profit) + '</td><td style="color:' + ppmColor + ';font-weight:600">' + formatMoney(l.ppm) + '</td></tr>';
        }).join('')) +
        '</tbody></table></div></div>' +
        
        '</div>' +
        
        // Truck Profitability - Enhanced with PPM
        '<div class="card"><div class="card-header"><h3>ðŸš› Truck Profitability</h3></div><div class="table-wrapper"><table><thead><tr><th>Truck</th><th>Trips</th><th>Miles</th><th>Revenue</th><th>Fuel Cost</th><th>Maint Cost</th><th>True Profit</th><th>$/Mile</th><th>CPM</th><th>PPM</th></tr></thead><tbody>' +
        (truckList.length === 0 ? '<tr><td colspan="10" style="text-align:center;padding:20px">No data</td></tr>' :
        truckList.map((t, i) => {
          const profitColor = t.trueProfit >= 0 ? '#10b981' : '#ef4444';
          const ppmColor = t.ppm >= 0.5 ? '#10b981' : t.ppm >= 0 ? '#f59e0b' : '#ef4444';
          const medal = i === 0 ? 'ðŸ¥‡ ' : i === 1 ? 'ðŸ¥ˆ ' : i === 2 ? 'ðŸ¥‰ ' : '';
          return '<tr style="' + (i < 3 ? 'background:#f0fdf4' : '') + '"><td><strong>' + medal + '#' + t.truck_number + '</strong></td><td>' + t.trips + '</td><td>' + t.miles.toLocaleString() + '</td><td class="money">' + formatMoney(t.revenue) + '</td><td class="money" style="color:#ef4444">' + formatMoney(t.fuelCost) + '</td><td class="money" style="color:#f59e0b">' + formatMoney(t.maintenanceCost) + '</td><td class="money" style="color:' + profitColor + ';font-weight:700">' + formatMoney(t.trueProfit) + '</td><td>' + formatMoney(t.rpm) + '</td><td style="color:#64748b">' + formatMoney(t.cpm) + '</td><td style="color:' + ppmColor + ';font-weight:600">' + formatMoney(t.ppm) + '</td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
      } catch (error) {
        console.error('Profitability error:', error);
        c.innerHTML = '<div class="header"><h2>ðŸ’Ž Profitability Dashboard</h2></div><div class="card" style="padding:40px;text-align:center"><p style="color:#ef4444">Error loading profitability data: ' + error.message + '</p><p style="color:#64748b;margin-top:10px">Check console for details.</p></div>';
      }
    }
    
    function extractState(location) {
      if (!location) return 'Unknown';
      // Try to extract state abbreviation (last 2 letters after comma or space)
      const parts = location.split(',');
      if (parts.length >= 2) {
        const statePart = parts[parts.length - 1].trim();
        const stateMatch = statePart.match(/([A-Z]{2})/);
        if (stateMatch) return stateMatch[1];
      }
      // Try to find state abbreviation anywhere
      const stateMatch = location.match(/\b([A-Z]{2})\b/);
      if (stateMatch) return stateMatch[1];
      // Return first 10 chars if no state found
      return location.substring(0, 10);
    }

    // ============ MAINTENANCE PAGE ============
    let maintenanceFilter = { truck: 'all', sort: 'newest' };
    
    function renderMaintenance(c) {
      const records = appData.maintenance_records || [];
      
      // Apply truck filter
      let filtered = records;
      if (maintenanceFilter.truck !== 'all') {
        filtered = records.filter(m => m.truck_id === parseInt(maintenanceFilter.truck));
      }
      
      // Apply sort
      const sorted = [...filtered].sort((a, b) => {
        if (maintenanceFilter.sort === 'newest') {
          return new Date(b.service_date || 0) - new Date(a.service_date || 0);
        } else {
          return new Date(a.service_date || 0) - new Date(b.service_date || 0);
        }
      });
      
      const total = filtered.reduce((s, m) => s + parseFloat(m.total_cost || 0), 0);
      
      // Get unique trucks for filter dropdown
      const trucksWithRecords = [...new Set(records.map(m => m.truck_id))].filter(id => id);
      const truckOptions = trucksWithRecords.map(id => {
        const truck = appData.trucks.find(t => t.id === id);
        return '<option value="' + id + '"' + (maintenanceFilter.truck == id ? ' selected' : '') + '>#' + (truck ? truck.truck_number : id) + '</option>';
      }).join('');
      
      c.innerHTML = '<div class="header"><h2>ðŸ”§ Maintenance</h2><div style="display:flex;gap:8px"><button class="btn btn-secondary" onclick="exportMaintenanceToCSV()">ðŸ“Š Export to Sheets</button><button class="btn btn-primary" onclick="openMaintenanceModal(null, null)">+ New Record</button></div></div>' +
        
        // Filters
        '<div style="display:flex;gap:16px;margin-bottom:20px;flex-wrap:wrap;align-items:center;background:#f8fafc;padding:16px;border-radius:8px">' +
        '<div style="display:flex;align-items:center;gap:8px"><label style="font-weight:600;color:#475569">ðŸš› Truck:</label><select onchange="maintenanceFilter.truck=this.value;renderMaintenance(document.getElementById(\'main-content\'))" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:14px"><option value="all"' + (maintenanceFilter.truck === 'all' ? ' selected' : '') + '>All Trucks</option>' + truckOptions + '</select></div>' +
        '<div style="display:flex;align-items:center;gap:8px"><label style="font-weight:600;color:#475569">ðŸ“… Sort:</label><select onchange="maintenanceFilter.sort=this.value;renderMaintenance(document.getElementById(\'main-content\'))" style="padding:8px 12px;border:1px solid #e2e8f0;border-radius:6px;font-size:14px"><option value="newest"' + (maintenanceFilter.sort === 'newest' ? ' selected' : '') + '>Newest First</option><option value="oldest"' + (maintenanceFilter.sort === 'oldest' ? ' selected' : '') + '>Oldest First</option></select></div>' +
        '<button class="btn btn-secondary" style="padding:8px 16px" onclick="maintenanceFilter={truck:\'all\',sort:\'newest\'};renderMaintenance(document.getElementById(\'main-content\'))">Clear Filters</button>' +
        '</div>' +
        
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px"><div class="label">Total Records</div><div class="value">' + records.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:12px 16px"><div class="label">Filtered Records</div><div class="value">' + filtered.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:130px;padding:12px 16px;border-left:3px solid #10b981"><div class="label">Total Spent' + (maintenanceFilter.truck !== 'all' ? ' (Filtered)' : '') + '</div><div class="value" style="color:#10b981">' + formatMoney(total) + '</div></div></div>' +
        '<div class="card"><div class="card-header"><h3>ðŸ“‹ Maintenance Records' + (maintenanceFilter.truck !== 'all' ? ' - Truck #' + (appData.trucks.find(t => t.id == maintenanceFilter.truck)?.truck_number || '') : '') + '</h3></div><div class="table-wrapper"><table><thead><tr><th>Truck</th><th>Date</th><th>Type</th><th>Shop</th><th>Description</th><th>Cost</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        (sorted.length === 0 ? '<tr><td colspan="7" style="text-align:center;padding:40px">No maintenance records found.</td></tr>' :
        sorted.map(m => {
          const truck = appData.trucks.find(t => t.id === m.truck_id);
          return '<tr><td><strong>#' + (truck ? truck.truck_number : '-') + '</strong></td>' +
            '<td>' + (m.service_date ? formatDate(m.service_date) : '-') + '</td>' +
            '<td><span class="badge badge-blue">' + (m.service_type || '-') + '</span></td>' +
            '<td>' + (m.shop_name || '-') + '</td>' +
            '<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + (m.description || '-') + '</td>' +
            '<td class="money">' + formatMoney(m.total_cost || 0) + '</td>' +
            '<td class="sticky-col"><div class="actions">' +
            (m.invoice_file ? '<button class="action-btn view" onclick="viewMaintenanceInvoice(' + m.id + ')">ðŸ“„</button>' : '') +
            '<button class="action-btn edit" onclick="openMaintenanceModal(null,' + m.id + ')">Edit</button>' +
            '<button class="action-btn delete" onclick="deleteMaintenanceRecord(' + m.id + ',' + m.truck_id + ')">Del</button></div></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }
    
    function exportMaintenanceToCSV() {
      const records = appData.maintenance_records || [];
      if (records.length === 0) {
        showToast('No maintenance records to export', 'error');
        return;
      }
      
      // Sort by date descending
      const sorted = [...records].sort((a, b) => new Date(b.service_date || 0) - new Date(a.service_date || 0));
      
      // CSV Headers
      const headers = ['Truck #', 'Service Date', 'Service Type', 'Shop Name', 'Description', 'Odometer', 'Parts Cost', 'Labor Cost', 'Total Cost', 'Notes'];
      
      // Build CSV rows
      const rows = sorted.map(m => {
        const truck = appData.trucks.find(t => t.id === m.truck_id);
        return [
          truck ? truck.truck_number : '',
          m.service_date || '',
          m.service_type || '',
          (m.shop_name || '').replace(/"/g, '""'),
          (m.description || '').replace(/"/g, '""').replace(/\n/g, ' '),
          m.odometer || '',
          m.parts_cost || 0,
          m.labor_cost || 0,
          m.total_cost || 0,
          (m.notes || '').replace(/"/g, '""')
        ].map(val => '"' + val + '"').join(',');
      });
      
      // Combine headers and rows
      const csv = [headers.join(','), ...rows].join('\n');
      
      // Create download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'maintenance_records_' + new Date().toISOString().split('T')[0] + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast('âœ“ Exported ' + records.length + ' records! Open in Google Sheets.');
    }

    // ============ SETTINGS ============
    function getApiKey() {
      return localStorage.getItem('horizonstar_anthropic_key') || '';
    }
    
    function setApiKey(key) {
      if (key) {
        localStorage.setItem('horizonstar_anthropic_key', key);
      } else {
        localStorage.removeItem('horizonstar_anthropic_key');
      }
    }
    
    // ============ EMAIL INTEGRATION (Supabase Edge Function + Resend) ============

    // Send earnings statement email via Supabase Edge Function
    async function sendEarningsEmail(driverEmail, driverName, subject, htmlContent) {
      try {
        const response = await fetch(SUPABASE_URL + '/functions/v1/send-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getAccessToken()
          },
          body: JSON.stringify({
            to: driverEmail,
            subject: subject,
            html: htmlContent,
            from_name: 'Horizon Star TMS'
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to send email');
        }

        return { success: true, id: data.id };
      } catch (error) {
        console.error('Email error:', error);
        throw error;
      }
    }

    // Test email configuration
    async function testEmailSetup() {
      const resultDiv = document.getElementById('emailTestResult');
      resultDiv.innerHTML = '<div style="background:#dbeafe;padding:12px;border-radius:8px;color:#1d4ed8">Sending test email...</div>';

      try {
        await sendEarningsEmail(
          currentUser.email,
          currentUser.first_name,
          'Test Email from Horizon Star TMS',
          '<h2>Email Configuration Successful!</h2><p>Your email integration is working correctly.</p><p>You can now send earnings statements directly to drivers.</p><br><p style="color:#64748b;font-size:12px">- Horizon Star TMS</p>'
        );

        resultDiv.innerHTML = '<div style="background:#d1fae5;padding:12px;border-radius:8px;color:#059669">Test email sent to ' + currentUser.email + '! Check your inbox.</div>';
      } catch (error) {
        console.error('Email test failed:', error);
        resultDiv.innerHTML = '<div style="background:#fee2e2;padding:12px;border-radius:8px;color:#dc2626">Failed: ' + error.message + '</div>';
      }
    }

    function renderSettings(c) {
      if (currentUser.role !== 'ADMIN') { c.innerHTML = '<div style="text-align:center;padding:60px">Access Denied</div>'; return; }
      
      const currentKey = getApiKey();
      const maskedKey = currentKey ? currentKey.substring(0, 10) + '...' + currentKey.substring(currentKey.length - 4) : '';
      
      const samsaraKey = getSamsaraApiKey();
      const maskedSamsaraKey = samsaraKey ? samsaraKey.substring(0, 8) + '...' + samsaraKey.substring(samsaraKey.length - 4) : '';
      const samsaraProxyUrl = getSamsaraProxyUrl();
      
      c.innerHTML = '<div class="header"><h2>âš™ï¸ Settings</h2></div>' +
        
        // Samsara Integration Section
        '<div class="card" style="max-width:700px"><div class="card-header"><h3>ðŸ“ Samsara GPS Integration</h3></div>' +
        '<div style="padding:20px">' +
        '<p style="color:#64748b;margin-bottom:20px">Connect to Samsara for real-time truck GPS tracking on the Live Map.</p>' +
        
        '<div class="form-group"><label>Samsara API Token</label><div style="display:flex;gap:12px"><input type="password" id="samsaraKeyInput" value="' + samsaraKey + '" placeholder="samsara_api_xxxxxxxx..." style="flex:1"><button class="btn btn-secondary" onclick="toggleSamsaraKeyVisibility()">ðŸ‘ï¸</button></div></div>' +
        
        '<div class="form-group"><label>Proxy URL <span style="color:#64748b;font-weight:normal">(required for browser access)</span></label><input type="text" id="samsaraProxyInput" value="' + samsaraProxyUrl + '" placeholder="https://samsara-proxy.yourname.workers.dev" style="width:100%"></div>' +
        
        (samsaraKey ? '<div style="background:#d1fae5;padding:12px;border-radius:8px;margin-bottom:16px"><span style="color:#059669">âœ“ Samsara token saved: ' + maskedSamsaraKey + '</span>' + (samsaraProxyUrl ? '<br><span style="color:#059669">âœ“ Proxy configured</span>' : '<br><span style="color:#92400e">âš ï¸ No proxy - may not work in browser</span>') + '</div>' : '<div style="background:#fef3c7;padding:12px;border-radius:8px;margin-bottom:16px"><span style="color:#92400e">âš ï¸ No Samsara token. Live tracking disabled.</span></div>') +
        
        '<div style="display:flex;gap:12px;flex-wrap:wrap"><button class="btn btn-primary" onclick="saveSamsaraKey()">ðŸ’¾ Save Settings</button>' +
        (samsaraKey ? '<button class="btn btn-secondary" style="background:#fee2e2;color:#dc2626" onclick="clearSamsaraKey()">ðŸ—‘ï¸ Remove</button>' : '') +
        '<button class="btn btn-secondary" onclick="testSamsaraConnection()">ðŸ§ª Test Connection</button>' +
        (samsaraKey ? '<button class="btn btn-secondary" onclick="manageTruckSamsaraLinks()">ðŸ”— Link Trucks to Vehicles</button>' : '') +
        '</div>' +
        
        '<div id="samsaraTestResult" style="margin-top:16px"></div>' +
        '</div></div>' +
        
        '<div class="card" style="max-width:700px;margin-top:24px"><div class="card-header"><h3>ðŸ”§ Proxy Setup (Required for Browser)</h3></div>' +
        '<div style="padding:20px">' +
        '<p style="color:#64748b;margin-bottom:16px">Samsara blocks direct browser requests (CORS). Set up a free Cloudflare Worker proxy:</p>' +
        '<ol style="color:#64748b;line-height:2.2">' +
        '<li>Go to <a href="https://dash.cloudflare.com" target="_blank" style="color:#1d4ed8">dash.cloudflare.com</a> (free account)</li>' +
        '<li>Click <strong>Workers & Pages</strong> â†’ <strong>Create Application</strong> â†’ <strong>Create Worker</strong></li>' +
        '<li>Name it <code style="background:#f1f5f9;padding:2px 6px;border-radius:4px">samsara-proxy</code></li>' +
        '<li>Click <strong>Deploy</strong>, then <strong>Edit Code</strong></li>' +
        '<li>Replace all code with: <button class="btn btn-secondary" style="padding:4px 12px;font-size:12px;margin-left:8px" onclick="showProxyCode()">ðŸ“‹ View Code</button></li>' +
        '<li>Click <strong>Save and Deploy</strong></li>' +
        '<li>Copy your URL (e.g., <code style="background:#f1f5f9;padding:2px 6px;border-radius:4px">https://samsara-proxy.yourname.workers.dev</code>)</li>' +
        '<li>Paste it in the Proxy URL field above</li>' +
        '</ol>' +
        '</div></div>' +
        
        '<div class="card" style="max-width:700px;margin-top:24px"><div class="card-header"><h3>ðŸ“‹ How to Get Samsara API Token</h3></div>' +
        '<div style="padding:20px">' +
        '<ol style="color:#64748b;line-height:2">' +
        '<li>Log into <a href="https://cloud.samsara.com" target="_blank" style="color:#1d4ed8">cloud.samsara.com</a></li>' +
        '<li>Go to <strong>Settings</strong> â†’ <strong>API Tokens</strong></li>' +
        '<li>Click <strong>Add API Token</strong></li>' +
        '<li>Name it (e.g., "TMS Integration")</li>' +
        '<li>Select permissions: <strong>Read</strong> for Fleet, Vehicles</li>' +
        '<li>Copy the token and paste above</li>' +
        '</ol>' +
        '</div></div>' +
        
        // Email Integration Section (Supabase Edge Function + Resend)
        '<div class="card" style="max-width:700px;margin-top:24px"><div class="card-header"><h3>ðŸ“§ Email Integration (Resend)</h3></div>' +
        '<div style="padding:20px">' +
        '<p style="color:#64748b;margin-bottom:20px">Send earnings statements directly to drivers via email. Uses Supabase Edge Function + Resend API.</p>' +

        '<div style="background:#d1fae5;padding:16px;border-radius:8px;margin-bottom:20px">' +
        '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="color:#059669;font-weight:600">Email sending is ready</span></div>' +
        '<span style="color:#047857;font-size:13px">Emails are sent via Supabase Edge Function. No configuration needed in the app.</span>' +
        '</div>' +

        '<div style="display:flex;gap:12px;flex-wrap:wrap">' +
        '<button class="btn btn-primary" onclick="testEmailSetup()">ðŸ§ª Send Test Email</button>' +
        '</div>' +

        '<div id="emailTestResult" style="margin-top:16px"></div>' +
        '</div></div>' +

        '<div class="card" style="max-width:700px;margin-top:24px"><div class="card-header"><h3>ðŸ“‹ Resend Setup (One-Time - 100 emails/day free)</h3></div>' +
        '<div style="padding:20px">' +
        '<p style="color:#64748b;margin-bottom:16px">If email is not working, follow these steps to set up Resend:</p>' +
        '<ol style="color:#64748b;line-height:2.2">' +
        '<li>Go to <a href="https://resend.com/" target="_blank" style="color:#1d4ed8">resend.com</a> and create a free account</li>' +
        '<li>Copy your <strong>API Key</strong> from the dashboard</li>' +
        '<li>Open terminal and run: <code style="background:#f1f5f9;padding:2px 6px;border-radius:4px">supabase secrets set RESEND_API_KEY=re_xxxxx</code></li>' +
        '<li>Deploy the edge function: <code style="background:#f1f5f9;padding:2px 6px;border-radius:4px">supabase functions deploy send-email</code></li>' +
        '<li>Test using the button above</li>' +
        '</ol>' +
        '<div style="background:#dbeafe;padding:12px;border-radius:8px;margin-top:16px"><strong style="color:#1d4ed8">Free Tier:</strong> 100 emails/day, 3,000 emails/month</div>' +
        '</div></div>' +
        
        // Claude API Section
        '<div class="card" style="max-width:700px;margin-top:24px"><div class="card-header"><h3>ðŸ¤– AI Integration (Claude API)</h3></div>' +
        '<div style="padding:20px">' +
        '<p style="color:#64748b;margin-bottom:20px">Enter your Anthropic API key to enable AI features like automatic invoice data extraction.</p>' +
        
        '<div class="form-group"><label>Anthropic API Key</label><div style="display:flex;gap:12px"><input type="password" id="apiKeyInput" value="' + currentKey + '" placeholder="sk-ant-api..." style="flex:1"><button class="btn btn-secondary" onclick="toggleApiKeyVisibility()">ðŸ‘ï¸</button></div></div>' +
        
        (currentKey ? '<div style="background:#d1fae5;padding:12px;border-radius:8px;margin-bottom:16px"><span style="color:#059669">âœ“ API Key configured: ' + maskedKey + '</span></div>' : '<div style="background:#fee2e2;padding:12px;border-radius:8px;margin-bottom:16px"><span style="color:#dc2626">âš ï¸ No API key configured. AI features disabled.</span></div>') +
        
        '<div style="display:flex;gap:12px;margin-top:20px"><button class="btn btn-primary" onclick="saveApiKey()">ðŸ’¾ Save API Key</button>' +
        (currentKey ? '<button class="btn btn-secondary" style="background:#fee2e2;color:#dc2626" onclick="clearApiKey()">ðŸ—‘ï¸ Remove Key</button>' : '') +
        '<button class="btn btn-secondary" onclick="testApiKey()">ðŸ§ª Test Connection</button></div>' +
        
        '<div id="apiTestResult" style="margin-top:16px"></div>' +
        '</div></div>' +
        
        '<div class="card" style="max-width:700px;margin-top:24px"><div class="card-header"><h3>ðŸ”‘ Get Claude API Key</h3></div>' +
        '<div style="padding:20px">' +
        '<ol style="color:#64748b;line-height:2">' +
        '<li>Go to <a href="https://console.anthropic.com/" target="_blank" style="color:#1d4ed8">console.anthropic.com</a></li>' +
        '<li>Sign up or log in</li>' +
        '<li>Go to API Keys section</li>' +
        '<li>Create a new key</li>' +
        '<li>Copy and paste it above</li>' +
        '</ol>' +
        '</div></div>';
    }
    
    // ============ SAMSARA INTEGRATION ============
    // Global storage for Samsara settings (loaded from DB)
    let samsaraSettings = {
      api_key: '',
      proxy_url: ''
    };
    
    function getSamsaraApiKey() {
      return samsaraSettings.api_key || localStorage.getItem('samsara_api_key') || '';
    }
    
    function setSamsaraApiKey(key) {
      samsaraSettings.api_key = key || '';
      // Also keep in localStorage as backup
      if (key) {
        localStorage.setItem('samsara_api_key', key);
      } else {
        localStorage.removeItem('samsara_api_key');
      }
    }
    
    function getSamsaraProxyUrl() {
      return samsaraSettings.proxy_url || localStorage.getItem('samsara_proxy_url') || '';
    }
    
    function setSamsaraProxyUrl(url) {
      samsaraSettings.proxy_url = url || '';
      if (url) {
        localStorage.setItem('samsara_proxy_url', url);
      } else {
        localStorage.removeItem('samsara_proxy_url');
      }
    }
    
    async function loadSamsaraSettings() {
      try {
        const settings = await dbFetch('app_settings', { key: 'eq.samsara' });
        if (settings && settings.length > 0) {
          const data = settings[0].value;
          if (data) {
            samsaraSettings.api_key = data.api_key || '';
            samsaraSettings.proxy_url = data.proxy_url || '';
            // Sync to localStorage for faster access
            if (samsaraSettings.api_key) localStorage.setItem('samsara_api_key', samsaraSettings.api_key);
            if (samsaraSettings.proxy_url) localStorage.setItem('samsara_proxy_url', samsaraSettings.proxy_url);
          }
        }
      } catch (e) {
        console.log('No app_settings table, using localStorage for Samsara settings');
        // Fallback to localStorage
        samsaraSettings.api_key = localStorage.getItem('samsara_api_key') || '';
        samsaraSettings.proxy_url = localStorage.getItem('samsara_proxy_url') || '';
      }
    }
    
    async function saveSamsaraSettingsToDb() {
      const data = {
        api_key: samsaraSettings.api_key,
        proxy_url: samsaraSettings.proxy_url
      };
      
      try {
        // Try to upsert
        const existing = await dbFetch('app_settings', { key: 'eq.samsara' });
        if (existing && existing.length > 0) {
          await dbUpdate('app_settings', existing[0].id, { value: data });
        } else {
          await dbInsert('app_settings', { key: 'samsara', value: data });
        }
        return true;
      } catch (e) {
        console.error('Failed to save Samsara settings to DB:', e);
        // Continue using localStorage
        return false;
      }
    }
    
    function showProxyCode() {
      const proxyCode = `// Samsara API Proxy - Cloudflare Worker
// Deploy this at dash.cloudflare.com -> Workers & Pages

export default {
  async fetch(request, env, ctx) {
    // Handle CORS preflight
    if (request.method === 'OPTIONS') {
      return new Response(null, {
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type, X-Samsara-Token',
          'Access-Control-Max-Age': '86400',
        },
      });
    }

    try {
      const url = new URL(request.url);
      const samsaraPath = url.searchParams.get('path');
      
      if (!samsaraPath) {
        return jsonResponse({ error: 'Missing path parameter' }, 400);
      }

      const samsaraToken = request.headers.get('X-Samsara-Token');
      
      if (!samsaraToken) {
        return jsonResponse({ error: 'Missing X-Samsara-Token header' }, 401);
      }

      const samsaraUrl = 'https://api.samsara.com' + samsaraPath;

      const samsaraResponse = await fetch(samsaraUrl, {
        method: request.method,
        headers: {
          'Authorization': 'Bearer ' + samsaraToken,
          'Content-Type': 'application/json',
        },
      });

      const data = await samsaraResponse.json();
      return jsonResponse(data, samsaraResponse.status);

    } catch (error) {
      return jsonResponse({ error: error.message }, 500);
    }
  },
};

function jsonResponse(data, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: {
      'Content-Type': 'application/json',
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, X-Samsara-Token',
    },
  });
}`;

      showModal('proxy-code-modal', 'ðŸ“‹ Cloudflare Worker Proxy Code',
        '<p style="margin-bottom:16px;color:#64748b">Copy this code and paste it into your Cloudflare Worker:</p>' +
        '<div style="position:relative">' +
        '<button onclick="navigator.clipboard.writeText(document.getElementById(\'proxyCodeText\').textContent);showToast(\'Code copied!\')" style="position:absolute;top:8px;right:8px;padding:6px 12px;background:#22c55e;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px">ðŸ“‹ Copy</button>' +
        '<pre id="proxyCodeText" style="background:#1e293b;color:#e2e8f0;padding:16px;border-radius:8px;overflow-x:auto;font-size:12px;line-height:1.5;max-height:400px;overflow-y:auto">' + proxyCode.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>' +
        '</div>',
        '<button class="btn btn-primary" onclick="closeModal(\'proxy-code-modal\')">Done</button>'
      );
    }
    
    function toggleSamsaraKeyVisibility() {
      const input = document.getElementById('samsaraKeyInput');
      input.type = input.type === 'password' ? 'text' : 'password';
    }
    
    async function saveSamsaraKey() {
      const key = document.getElementById('samsaraKeyInput').value.trim();
      setSamsaraApiKey(key);
      const proxyUrl = document.getElementById('samsaraProxyInput')?.value.trim() || '';
      setSamsaraProxyUrl(proxyUrl);
      
      // Save to database for all users
      const saved = await saveSamsaraSettingsToDb();
      if (saved) {
        showToast('Samsara settings saved for all users!');
      } else {
        showToast('Samsara settings saved locally');
      }
      renderSettings(document.getElementById('main-content'));
    }
    
    async function clearSamsaraKey() {
      if (!confirm('Remove Samsara token? Live tracking will be disabled for all users.')) return;
      setSamsaraApiKey('');
      setSamsaraProxyUrl('');
      await saveSamsaraSettingsToDb();
      showToast('Samsara settings removed');
      renderSettings(document.getElementById('main-content'));
    }
    
    async function samsaraFetch(path) {
      const key = getSamsaraApiKey();
      const proxyUrl = getSamsaraProxyUrl();
      
      if (!key) return null;
      
      try {
        let response;
        
        if (proxyUrl) {
          // Use proxy
          response = await fetch(proxyUrl + '?path=' + encodeURIComponent(path), {
            method: 'GET',
            headers: {
              'X-Samsara-Token': key,
              'Content-Type': 'application/json'
            }
          });
        } else {
          // Direct call (may fail due to CORS)
          response = await fetch('https://api.samsara.com' + path, {
            method: 'GET',
            headers: {
              'Authorization': 'Bearer ' + key,
              'Content-Type': 'application/json'
            }
          });
        }
        
        if (response.ok) {
          return await response.json();
        } else if (response.status === 401) {
          console.error('Samsara: Invalid API token');
        }
      } catch (e) {
        console.error('Samsara fetch error:', e);
      }
      return null;
    }
    
    async function testSamsaraConnection() {
      const key = document.getElementById('samsaraKeyInput').value.trim();
      const proxyUrl = document.getElementById('samsaraProxyInput')?.value.trim() || '';
      const resultDiv = document.getElementById('samsaraTestResult');
      
      if (!key) {
        resultDiv.innerHTML = '<div style="background:#fee2e2;padding:12px;border-radius:8px;color:#dc2626">Please enter a Samsara API token first</div>';
        return;
      }
      
      resultDiv.innerHTML = '<div style="background:#fef3c7;padding:12px;border-radius:8px;color:#92400e">â³ Testing Samsara connection...</div>';
      
      try {
        let response;
        
        if (proxyUrl) {
          // Use proxy
          response = await fetch(proxyUrl + '?path=' + encodeURIComponent('/fleet/vehicles'), {
            method: 'GET',
            headers: {
              'X-Samsara-Token': key,
              'Content-Type': 'application/json'
            }
          });
        } else {
          // Direct call
          response = await fetch('https://api.samsara.com/fleet/vehicles', {
            method: 'GET',
            headers: {
              'Authorization': 'Bearer ' + key,
              'Content-Type': 'application/json'
            }
          });
        }
        
        if (response.ok) {
          const data = await response.json();
          const vehicleCount = data.data ? data.data.length : 0;
          resultDiv.innerHTML = '<div style="background:#d1fae5;padding:12px;border-radius:8px;color:#059669">âœ“ Connection successful! Found ' + vehicleCount + ' vehicles in your Samsara fleet.' + (proxyUrl ? ' (via proxy)' : '') + '</div>';
        } else if (response.status === 401) {
          resultDiv.innerHTML = '<div style="background:#fee2e2;padding:12px;border-radius:8px;color:#dc2626">âœ— Invalid API token. Please check your token.</div>';
        } else {
          resultDiv.innerHTML = '<div style="background:#fee2e2;padding:12px;border-radius:8px;color:#dc2626">âœ— Connection failed: ' + response.status + '</div>';
        }
      } catch (e) {
        if (proxyUrl) {
          resultDiv.innerHTML = '<div style="background:#fee2e2;padding:12px;border-radius:8px;color:#dc2626">âœ— Proxy error: ' + e.message + '. Check your proxy URL.</div>';
        } else {
          resultDiv.innerHTML = '<div style="background:#fee2e2;padding:12px;border-radius:8px;color:#dc2626">âœ— CORS blocked. Please set up a proxy (see instructions below) or deploy to a server.</div>';
        }
      }
    }
    
    async function fetchSamsaraVehicles() {
      const data = await samsaraFetch('/fleet/vehicles');
      return data?.data || [];
    }
    
    async function fetchSamsaraLocations() {
      const data = await samsaraFetch('/fleet/vehicles/locations');
      return data?.data || [];
    }
    
    function getTruckSamsaraLinks() {
      try {
        return JSON.parse(localStorage.getItem('truck_samsara_links') || '{}');
      } catch (e) {
        return {};
      }
    }
    
    function setTruckSamsaraLink(truckId, samsaraVehicleId) {
      const links = getTruckSamsaraLinks();
      if (samsaraVehicleId) {
        links[truckId] = samsaraVehicleId;
      } else {
        delete links[truckId];
      }
      localStorage.setItem('truck_samsara_links', JSON.stringify(links));
    }
    
    async function manageTruckSamsaraLinks() {
      const samsaraVehicles = await fetchSamsaraVehicles();
      const links = getTruckSamsaraLinks();
      
      if (samsaraVehicles.length === 0) {
        showToast('Could not fetch Samsara vehicles. Check your token.', 'error');
        return;
      }
      
      const vehicleOptions = samsaraVehicles.map(v => 
        '<option value="' + v.id + '">' + (v.name || 'Vehicle ' + v.id) + '</option>'
      ).join('');
      
      const truckRows = appData.trucks.map(t => {
        const linkedVehicle = links[t.id] || '';
        return '<tr>' +
          '<td><strong>#' + t.truck_number + '</strong></td>' +
          '<td>' + t.truck_type + '</td>' +
          '<td><select onchange="setTruckSamsaraLink(' + t.id + ', this.value)" style="padding:8px;border-radius:6px;border:1px solid var(--border);min-width:200px">' +
          '<option value="">-- Not Linked --</option>' +
          samsaraVehicles.map(v => '<option value="' + v.id + '"' + (linkedVehicle === v.id ? ' selected' : '') + '>' + (v.name || 'Vehicle ' + v.id) + '</option>').join('') +
          '</select></td>' +
          '</tr>';
      }).join('');
      
      showModal('samsara-link-modal', 'ðŸ”— Link Trucks to Samsara Vehicles',
        '<p style="color:#64748b;margin-bottom:20px">Match your TMS trucks with Samsara vehicles for live GPS tracking.</p>' +
        '<div class="table-wrapper"><table>' +
        '<thead><tr><th>Truck #</th><th>Type</th><th>Samsara Vehicle</th></tr></thead>' +
        '<tbody>' + truckRows + '</tbody>' +
        '</table></div>',
        '<button class="btn btn-primary" onclick="closeModal(\'samsara-link-modal\');showToast(\'Links saved!\')">Done</button>'
      );
    }
    
    // ============ LIVE MAP PAGE ============
    let liveMapInstance = null;
    let liveMapMarkers = {};
    let liveMapRefreshInterval = null;
    
    async function renderLiveMap(c) {
      const samsaraKey = getSamsaraApiKey();
      
      c.innerHTML = '<div class="header"><h2>ðŸ“ ' + t('live_map') + '</h2>' +
        '<div style="display:flex;gap:12px;align-items:center">' +
        '<span id="lastUpdateTime" style="color:var(--text-muted);font-size:13px"></span>' +
        '<button class="btn btn-secondary" onclick="refreshLiveMap()">ðŸ”„ Refresh</button>' +
        (currentUser.role === 'ADMIN' ? '<button class="btn btn-secondary" onclick="goToPage(\'settings\')">âš™ï¸ Configure Samsara</button>' : '') +
        '</div></div>' +
        
        (!samsaraKey ? 
          '<div class="card" style="text-align:center;padding:60px">' +
          '<div style="font-size:48px;margin-bottom:20px">ðŸ“</div>' +
          '<h3 style="margin-bottom:12px">Samsara Not Connected</h3>' +
          '<p style="color:var(--text-muted);margin-bottom:24px">Connect your Samsara account to see live truck locations.</p>' +
          (currentUser.role === 'ADMIN' ? '<button class="btn btn-primary" onclick="goToPage(\'settings\')">Configure Samsara â†’</button>' : '<p style="color:var(--text-muted)">Please ask an administrator to configure Samsara.</p>') +
          '</div>' 
        :
          '<div style="display:flex;gap:20px;height:calc(100vh - 180px)">' +
          '<div id="liveMapContainer" style="flex:1;border-radius:12px;overflow:hidden;border:1px solid var(--border);min-height:500px"></div>' +
          '<div id="truckListPanel" style="width:300px;background:var(--bg-card);border-radius:12px;border:1px solid var(--border);overflow-y:auto;padding:16px">' +
          '<h3 style="margin-bottom:16px">ðŸš› Fleet Status</h3>' +
          '<div id="truckStatusList"><div style="text-align:center;padding:40px;color:var(--text-muted)">Loading...</div></div>' +
          '</div></div>'
        );
      
      if (samsaraKey) {
        // Load Leaflet CSS
        if (!document.getElementById('leaflet-css')) {
          const link = document.createElement('link');
          link.id = 'leaflet-css';
          link.rel = 'stylesheet';
          link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
          document.head.appendChild(link);
        }
        
        // Load Leaflet JS
        if (!window.L) {
          const script = document.createElement('script');
          script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
          script.onload = () => initLiveMap();
          document.body.appendChild(script);
        } else {
          initLiveMap();
        }
        
        // Start auto-refresh every 30 seconds
        if (liveMapRefreshInterval) clearInterval(liveMapRefreshInterval);
        liveMapRefreshInterval = setInterval(refreshLiveMap, 30000);
      }
    }
    
    function initLiveMap() {
      const container = document.getElementById('liveMapContainer');
      if (!container || !window.L) return;

      // Ensure container has dimensions before initializing
      if (container.offsetWidth === 0 || container.offsetHeight === 0) {
        // Retry after a short delay if container not ready
        setTimeout(initLiveMap, 100);
        return;
      }

      // Clear existing map
      if (liveMapInstance) {
        try {
          liveMapInstance.remove();
        } catch (e) {
          // Ignore removal errors
        }
        liveMapInstance = null;
      }
      liveMapMarkers = {};

      // Initialize map centered on US
      try {
        liveMapInstance = L.map('liveMapContainer').setView([39.8283, -98.5795], 4);
      } catch (e) {
        console.warn('Leaflet map init error:', e);
        return;
      }
      
      // Add tile layer (OpenStreetMap)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(liveMapInstance);
      
      // Load truck locations
      refreshLiveMap();
    }
    
    async function refreshLiveMap() {
      if (!liveMapInstance) return;
      
      const locations = await fetchSamsaraLocations();
      const links = getTruckSamsaraLinks();
      const reverseLinks = {};
      
      // Create reverse lookup: samsaraVehicleId -> truckId
      Object.entries(links).forEach(([truckId, samsaraId]) => {
        reverseLinks[samsaraId] = parseInt(truckId);
      });
      
      // Update last refresh time
      const timeEl = document.getElementById('lastUpdateTime');
      if (timeEl) {
        timeEl.textContent = 'Updated: ' + new Date().toLocaleTimeString();
      }
      
      // Build truck status list
      let truckStatusHtml = '';
      const bounds = [];
      
      if (locations.length === 0) {
        truckStatusHtml = '<div style="text-align:center;padding:20px;color:var(--text-muted)">No location data available.<br><br>Make sure your trucks are linked to Samsara vehicles in Settings.</div>';
      } else {
        locations.forEach(loc => {
          const samsaraVehicle = loc.id;
          const truckId = reverseLinks[samsaraVehicle];
          const truck = truckId ? appData.trucks.find(t => t.id === truckId) : null;
          
          const lat = loc.location?.latitude;
          const lng = loc.location?.longitude;
          const speed = loc.location?.speed ? Math.round(loc.location.speed * 0.621371) : 0; // Convert km/h to mph
          const heading = loc.location?.heading || 0;
          const address = loc.location?.reverseGeo?.formattedLocation || 'Unknown location';
          const vehicleName = loc.name || 'Vehicle ' + samsaraVehicle;
          const truckLabel = truck ? 'Truck #' + truck.truck_number : vehicleName;
          const isMoving = speed > 2;
          
          if (lat && lng) {
            bounds.push([lat, lng]);
            
            // Create/update marker
            const markerKey = samsaraVehicle;
            const iconHtml = '<div style="background:' + (isMoving ? '#22c55e' : '#64748b') + ';color:white;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600;white-space:nowrap;box-shadow:0 2px 4px rgba(0,0,0,0.3)">ðŸš› ' + (truck ? '#' + truck.truck_number : vehicleName.substring(0, 10)) + '</div>';
            
            const customIcon = L.divIcon({
              html: iconHtml,
              className: 'truck-marker',
              iconSize: null,
              iconAnchor: [40, 20]
            });
            
            if (liveMapMarkers[markerKey]) {
              liveMapMarkers[markerKey].setLatLng([lat, lng]);
              liveMapMarkers[markerKey].setIcon(customIcon);
            } else {
              liveMapMarkers[markerKey] = L.marker([lat, lng], { icon: customIcon })
                .addTo(liveMapInstance)
                .bindPopup('<div style="min-width:200px"><strong>' + truckLabel + '</strong><br>' +
                  '<span style="color:#64748b">' + address + '</span><br>' +
                  '<div style="margin-top:8px">' +
                  '<span style="background:' + (isMoving ? '#dcfce7' : '#f1f5f9') + ';color:' + (isMoving ? '#166534' : '#64748b') + ';padding:2px 8px;border-radius:4px;font-size:12px">' + (isMoving ? 'ðŸŸ¢ Moving ' + speed + ' mph' : 'âš« Stopped') + '</span>' +
                  '</div></div>');
            }
            
            // Add to status list
            truckStatusHtml += '<div onclick="liveMapInstance.setView([' + lat + ',' + lng + '], 12)" style="padding:12px;margin-bottom:8px;background:var(--bg-tertiary);border-radius:8px;cursor:pointer;border-left:4px solid ' + (isMoving ? '#22c55e' : '#64748b') + '">' +
              '<div style="font-weight:600">' + truckLabel + '</div>' +
              '<div style="font-size:12px;color:var(--text-muted);margin-top:4px">' + address.substring(0, 40) + (address.length > 40 ? '...' : '') + '</div>' +
              '<div style="font-size:12px;margin-top:6px">' +
              '<span style="color:' + (isMoving ? '#22c55e' : '#64748b') + '">' + (isMoving ? 'â— ' + speed + ' mph' : 'â— Stopped') + '</span>' +
              '</div></div>';
          }
        });
        
        // Fit map to show all trucks
        if (bounds.length > 0) {
          liveMapInstance.fitBounds(bounds, { padding: [50, 50] });
        }
      }
      
      // Also show trucks that aren't linked
      const linkedTruckIds = Object.keys(links).map(id => parseInt(id));
      const unlinkedTrucks = appData.trucks.filter(t => !linkedTruckIds.includes(t.id));
      
      if (unlinkedTrucks.length > 0) {
        truckStatusHtml += '<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">' +
          '<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">Not linked to Samsara:</div>';
        
        unlinkedTrucks.forEach(t => {
          truckStatusHtml += '<div style="padding:8px;margin-bottom:4px;background:var(--bg-tertiary);border-radius:6px;opacity:0.6">' +
            '<span style="font-weight:500">Truck #' + t.truck_number + '</span>' +
            '<span style="color:var(--text-muted);font-size:12px;margin-left:8px">No GPS</span>' +
            '</div>';
        });
        
        truckStatusHtml += '</div>';
      }
      
      const listEl = document.getElementById('truckStatusList');
      if (listEl) {
        listEl.innerHTML = truckStatusHtml || '<div style="text-align:center;padding:20px;color:var(--text-muted)">No trucks to display</div>';
      }
    }
    
    // Cleanup map on page change
    function cleanupLiveMap() {
      if (liveMapRefreshInterval) {
        clearInterval(liveMapRefreshInterval);
        liveMapRefreshInterval = null;
      }
      if (liveMapInstance) {
        liveMapInstance.remove();
        liveMapInstance = null;
      }
      liveMapMarkers = {};
    }

    // ============ TEAM CHAT ============
    let chatMessages = [];
    let chatRefreshInterval = null;
    let lastMessageId = 0;
    let mentionDropdownVisible = false;
    let mentionStartPos = -1;
    let unreadChatCount = 0;
    let lastSeenChatId = parseInt(localStorage.getItem('lastSeenChatId') || '0');
    let miniChatOpen = false;
    let miniChatRefreshInterval = null;
    
    async function renderTeamChat(c) {
      c.innerHTML = '<div class="chat-container" style="display:flex;flex-direction:column;height:calc(100vh - 120px);max-width:900px;margin:0 auto">' +
        '<div class="chat-header" style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--bg-card);border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center">' +
        '<div><h2 style="margin:0;display:flex;align-items:center;gap:10px">ðŸ’¬ ' + t('team_chat') + '</h2>' +
        '<span style="color:var(--text-muted);font-size:13px" id="chatOnlineStatus">Loading...</span></div>' +
        '<div style="display:flex;gap:8px">' +
        '<button class="btn btn-secondary" onclick="refreshChat()" style="padding:8px 12px">ðŸ”„</button>' +
        '</div></div>' +
        
        '<div id="chatMessages" class="chat-messages" style="flex:1;overflow-y:auto;padding:20px;background:var(--bg-secondary);display:flex;flex-direction:column;gap:12px">' +
        '<div style="text-align:center;color:var(--text-muted);padding:40px">Loading messages...</div>' +
        '</div>' +
        
        '<div class="chat-input-area" style="padding:16px;background:var(--bg-card);border-top:1px solid var(--border);border-radius:0 0 12px 12px">' +
        '<div id="chatFilePreview" style="display:none;margin-bottom:12px;padding:12px;background:var(--bg-tertiary);border-radius:8px"></div>' +
        '<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">ðŸ’¡ ' + 'Type @ to mention â€¢ ðŸ“Ž to attach files' + '</div>' +
        '<div style="display:flex;gap:12px;align-items:flex-end">' +
        '<input type="file" id="chatFileInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" style="display:none" onchange="handleChatFileSelect(event)">' +
        '<button onclick="document.getElementById(\'chatFileInput\').click()" class="btn btn-secondary" style="height:48px;width:48px;padding:0;border-radius:12px;flex-shrink:0" title="' + 'Attach file' + '">ðŸ“Ž</button>' +
        '<div style="flex:1;position:relative">' +
        '<textarea id="chatInput" placeholder="' + 'Type a message...' + '" ' +
        'style="width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:12px;resize:none;font-size:14px;line-height:1.4;min-height:48px;max-height:120px;background:var(--bg-tertiary);color:var(--text-primary)" ' +
        'onkeydown="handleChatKeydown(event)" oninput="handleChatInput(event)"></textarea>' +
        '<div id="mentionDropdown" style="display:none;position:absolute;bottom:100%;left:0;right:0;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;box-shadow:var(--shadow-lg);max-height:200px;overflow-y:auto;margin-bottom:4px;z-index:100"></div>' +
        '</div>' +
        '<button onclick="sendChatMessage()" class="btn btn-primary" style="height:48px;padding:0 24px;border-radius:12px;font-weight:600">' +
        '<span style="display:flex;align-items:center;gap:6px">ðŸ“¤ ' + 'Send' + '</span></button>' +
        '</div></div>' +
        '</div>';
      
      // Load messages
      await loadChatMessages();
      
      // Start auto-refresh every 5 seconds
      if (chatRefreshInterval) clearInterval(chatRefreshInterval);
      chatRefreshInterval = setInterval(checkNewMessages, 5000);
      
      // Focus input
      setTimeout(() => document.getElementById('chatInput')?.focus(), 100);
    }
    
    function autoResizeTextarea(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 120) + 'px';
    }
    
    function handleChatInput(e) {
      const input = e.target;
      autoResizeTextarea(input);
      
      const cursorPos = input.selectionStart;
      const text = input.value;
      
      // Check for @ mention trigger
      const textBeforeCursor = text.substring(0, cursorPos);
      const atMatch = textBeforeCursor.match(/@(\w*)$/);
      
      if (atMatch) {
        mentionStartPos = cursorPos - atMatch[1].length - 1;
        showMentionDropdown(atMatch[1]);
      } else {
        hideMentionDropdown();
      }
    }
    
    function showMentionDropdown(query) {
      const dropdown = document.getElementById('mentionDropdown');
      if (!dropdown) return;
      
      // Get all users that can be mentioned
      const allUsers = appData.users || [];
      const filtered = query 
        ? allUsers.filter(u => 
            (u.first_name + ' ' + (u.last_name || '')).toLowerCase().includes(query.toLowerCase()) ||
            u.email.toLowerCase().includes(query.toLowerCase())
          )
        : allUsers;
      
      if (filtered.length === 0) {
        dropdown.style.display = 'none';
        return;
      }
      
      dropdown.innerHTML = filtered.slice(0, 8).map((u, idx) => {
        const name = u.first_name + ' ' + (u.last_name || '');
        const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const color = getAvatarColor(u.id);
        return '<div onclick="selectMention(' + u.id + ', \'' + name.replace(/'/g, "\\'") + '\')" ' +
          'style="padding:10px 12px;cursor:pointer;display:flex;align-items:center;gap:10px;' + (idx === 0 ? 'background:var(--bg-hover);' : '') + '" ' +
          'onmouseover="this.style.background=\'var(--bg-hover)\'" onmouseout="this.style.background=\'\'">' +
          '<div style="width:32px;height:32px;border-radius:50%;background:' + color + ';color:white;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600">' + initials + '</div>' +
          '<div><div style="font-weight:500">' + name + '</div>' +
          '<div style="font-size:11px;color:var(--text-muted)">' + u.role + '</div></div></div>';
      }).join('');
      
      dropdown.style.display = 'block';
      mentionDropdownVisible = true;
    }
    
    function hideMentionDropdown() {
      const dropdown = document.getElementById('mentionDropdown');
      if (dropdown) dropdown.style.display = 'none';
      mentionDropdownVisible = false;
      mentionStartPos = -1;
    }
    
    function selectMention(userId, userName) {
      const input = document.getElementById('chatInput');
      if (!input || mentionStartPos === -1) return;
      
      const text = input.value;
      const before = text.substring(0, mentionStartPos);
      const after = text.substring(input.selectionStart);
      
      input.value = before + '@' + userName + ' ' + after;
      input.focus();
      
      // Set cursor after mention
      const newPos = before.length + userName.length + 2;
      input.setSelectionRange(newPos, newPos);
      
      hideMentionDropdown();
    }
    
    function handleChatKeydown(e) {
      if (mentionDropdownVisible) {
        if (e.key === 'Escape') {
          e.preventDefault();
          hideMentionDropdown();
          return;
        }
        if (e.key === 'Tab' || e.key === 'Enter') {
          const firstItem = document.querySelector('#mentionDropdown > div');
          if (firstItem) {
            e.preventDefault();
            firstItem.click();
            return;
          }
        }
      }
      
      if (e.key === 'Enter' && !e.shiftKey && !mentionDropdownVisible) {
        e.preventDefault();
        sendChatMessage();
      }
    }
    
    async function loadChatMessages() {
      try {
        chatMessages = await dbFetch('chat_messages', { order: 'created_at.asc', limit: 100 }) || [];
        renderChatMessages();
        if (chatMessages.length > 0) {
          lastMessageId = chatMessages[chatMessages.length - 1].id;
          // Mark all messages as seen
          lastSeenChatId = lastMessageId;
          localStorage.setItem('lastSeenChatId', lastSeenChatId.toString());
          unreadChatCount = 0;
          updateChatBadges();
        }
        updateOnlineStatus();
      } catch (e) {
        console.error('Failed to load chat:', e);
        document.getElementById('chatMessages').innerHTML = 
          '<div style="text-align:center;color:var(--text-muted);padding:40px">' +
          '<p>ðŸ’¬ Chat not set up yet</p>' +
          '<p style="font-size:13px;margin-top:8px">Run the SQL script to create the chat_messages table</p></div>';
      }
    }
    
    async function checkNewMessages() {
      if (currentPage !== 'team_chat') {
        cleanupChat();
        return;
      }
      
      try {
        const newMessages = await dbFetch('chat_messages', { 
          order: 'created_at.asc',
          filter: { id: 'gt.' + lastMessageId }
        }) || [];
        
        if (newMessages.length > 0) {
          chatMessages = [...chatMessages, ...newMessages];
          lastMessageId = newMessages[newMessages.length - 1].id;
          renderChatMessages();
        }
        updateOnlineStatus();
      } catch (e) {
        console.error('Chat refresh error:', e);
      }
    }
    
    async function refreshChat() {
      lastMessageId = 0;
      await loadChatMessages();
      showToast('Chat refreshed');
    }
    
    function updateOnlineStatus() {
      const statusEl = document.getElementById('chatOnlineStatus');
      if (statusEl) {
        const userCount = [...new Set(chatMessages.slice(-20).map(m => m.user_id))].length;
        statusEl.innerHTML = '<span style="color:#22c55e">â—</span> ' + 
          'Online' + 
          ' â€¢ ' + chatMessages.length + ' ' + 'messages';
      }
    }
    
    function renderChatMessages() {
      const container = document.getElementById('chatMessages');
      if (!container) return;
      
      if (chatMessages.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:60px">' +
          '<div style="font-size:48px;margin-bottom:16px">ðŸ’¬</div>' +
          '<p>' + 'No messages yet' + '</p>' +
          '<p style="font-size:13px;margin-top:8px">' + 'Start the conversation!' + '</p></div>';
        return;
      }
      
      // Group messages by date
      let html = '';
      let currentDate = '';
      
      chatMessages.forEach((msg, idx) => {
        const msgDate = new Date(msg.created_at);
        const dateStr = msgDate.toLocaleDateString();
        const timeStr = msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const isOwnMessage = msg.user_id === currentUser.id;
        const isConsecutive = idx > 0 && chatMessages[idx - 1].user_id === msg.user_id && 
          (new Date(msg.created_at) - new Date(chatMessages[idx - 1].created_at)) < 60000;
        
        // Date separator
        if (dateStr !== currentDate) {
          currentDate = dateStr;
          const isToday = dateStr === new Date().toLocaleDateString();
          const isYesterday = dateStr === new Date(Date.now() - 86400000).toLocaleDateString();
          const dateLabel = isToday ? 'Today' : 
                           isYesterday ? 'Yesterday' : dateStr;
          html += '<div style="text-align:center;margin:16px 0"><span style="background:var(--bg-tertiary);padding:6px 16px;border-radius:20px;font-size:12px;color:var(--text-muted)">' + dateLabel + '</span></div>';
        }
        
        // Message bubble
        const userName = escapeHtml(msg.user_name || 'Unknown');
        const initials = escapeHtml((msg.user_name || 'U').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase());
        const avatarColor = getAvatarColor(msg.user_id);
        
        html += '<div style="display:flex;gap:10px;align-items:flex-start;' + (isOwnMessage ? 'flex-direction:row-reverse' : '') + '">';
        
        // Avatar (only show if not consecutive)
        if (!isConsecutive) {
          html += '<div style="width:36px;height:36px;border-radius:50%;background:' + avatarColor + ';color:white;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;flex-shrink:0">' + initials + '</div>';
        } else {
          html += '<div style="width:36px;flex-shrink:0"></div>';
        }
        
        // Message content
        html += '<div style="max-width:70%;' + (isOwnMessage ? 'text-align:right' : '') + '">';
        
        if (!isConsecutive) {
          html += '<div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;' + (isOwnMessage ? 'text-align:right' : '') + '">' +
            '<span style="font-weight:600;color:var(--text-primary)">' + userName + '</span>' +
            (msg.user_role ? ' <span style="background:var(--bg-tertiary);padding:2px 6px;border-radius:4px;font-size:10px">' + escapeHtml(msg.user_role) + '</span>' : '') +
            '</div>';
        }
        
        const isDark = document.body.classList.contains('dark-theme');
        const otherMsgBg = isDark ? 'var(--bg-card)' : '#ffffff';
        const otherMsgColor = isDark ? 'var(--text-primary)' : '#1e293b';
        const otherMsgBorder = isDark ? '1px solid var(--border)' : '1px solid #e2e8f0';
        const otherMsgShadow = isDark ? '0 2px 8px rgba(0,0,0,0.3)' : '0 2px 8px rgba(0,0,0,0.1)';
        
        // Parse file attachments
        let attachmentsHtml = '';
        if (msg.file_attachments) {
          try {
            const files = typeof msg.file_attachments === 'string' ? JSON.parse(msg.file_attachments) : msg.file_attachments;
            if (files && files.length > 0) {
              attachmentsHtml = '<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px">';
              files.forEach(file => {
                const isImage = file.type && file.type.startsWith('image/');
                if (isImage) {
                  attachmentsHtml += '<a href="' + file.url + '" target="_blank" style="display:block">' +
                    '<img src="' + file.url + '" alt="' + escapeHtml(file.name) + '" style="max-width:200px;max-height:200px;border-radius:8px;cursor:pointer;display:block" onclick="openImageViewer(\'' + file.url + '\');event.preventDefault()">' +
                    '</a>';
                } else {
                  const icon = file.type && file.type.includes('pdf') ? 'ðŸ“„' : 'ðŸ“Ž';
                  attachmentsHtml += '<a href="' + file.url + '" target="_blank" download style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:' + (isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)') + ';border-radius:8px;text-decoration:none;color:inherit">' +
                    '<span style="font-size:20px">' + icon + '</span>' +
                    '<div><div style="font-size:12px;font-weight:500">' + escapeHtml(file.name) + '</div>' +
                    '<div style="font-size:10px;opacity:0.7">' + formatFileSize(file.size || 0) + '</div></div>' +
                    '</a>';
                }
              });
              attachmentsHtml += '</div>';
            }
          } catch (e) {
            console.error('Failed to parse attachments:', e);
          }
        }
        
        html += '<div style="background:' + (isOwnMessage ? 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)' : otherMsgBg) + ';color:' + (isOwnMessage ? 'white' : otherMsgColor) + ';padding:10px 14px;border-radius:' + (isOwnMessage ? '16px 16px 4px 16px' : '16px 16px 16px 4px') + ';display:inline-block;text-align:left;word-wrap:break-word;box-shadow:' + (isOwnMessage ? '0 2px 8px rgba(34, 197, 94, 0.3)' : otherMsgShadow) + ';border:' + (isOwnMessage ? 'none' : otherMsgBorder) + '">';
        
        // Text content (only if there's text)
        if (msg.message && msg.message.trim()) {
          html += '<div style="white-space:pre-wrap">' + formatMessageWithMentions(msg.message, isOwnMessage) + '</div>';
        }
        
        // File attachments
        html += attachmentsHtml;
        
        // Time
        html += '<div style="font-size:10px;opacity:0.7;margin-top:4px;text-align:right">' + timeStr + '</div>' +
          '</div>';
        
        html += '</div></div>';
      });
      
      container.innerHTML = html;
      
      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }
    
    function openImageViewer(imageUrl) {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10000;display:flex;align-items:center;justify-content:center;cursor:zoom-out';
      overlay.onclick = () => overlay.remove();
      
      const img = document.createElement('img');
      img.src = imageUrl;
      img.style.cssText = 'max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px';
      
      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = 'Ã—';
      closeBtn.style.cssText = 'position:absolute;top:20px;right:20px;width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,0.2);color:white;border:none;font-size:24px;cursor:pointer';
      closeBtn.onclick = () => overlay.remove();
      
      const downloadBtn = document.createElement('a');
      downloadBtn.href = imageUrl;
      downloadBtn.download = '';
      downloadBtn.innerHTML = 'â¬‡ï¸ ' + 'Download';
      downloadBtn.style.cssText = 'position:absolute;bottom:20px;right:20px;padding:12px 20px;background:var(--primary);color:white;border-radius:8px;text-decoration:none;font-weight:600';
      
      overlay.appendChild(img);
      overlay.appendChild(closeBtn);
      overlay.appendChild(downloadBtn);
      document.body.appendChild(overlay);
    }
    
    function getAvatarColor(userId) {
      const colors = ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];
      return colors[userId % colors.length];
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function formatMessageWithMentions(text, isOwnMessage) {
      // First escape HTML
      let html = escapeHtml(text);
      
      // Then highlight @mentions
      html = html.replace(/@([A-Za-z\u10A0-\u10FF]+ ?[A-Za-z\u10A0-\u10FF]*)/g, function(match, name) {
        const mentionStyle = isOwnMessage 
          ? 'background:rgba(255,255,255,0.2);padding:2px 6px;border-radius:4px;font-weight:600' 
          : 'background:rgba(34,197,94,0.15);color:#16a34a;padding:2px 6px;border-radius:4px;font-weight:600';
        return '<span style="' + mentionStyle + '">@' + name + '</span>';
      });
      
      return html;
    }
    
    function extractMentions(message) {
      const mentions = [];
      const regex = /@([A-Za-z\u10A0-\u10FF]+ ?[A-Za-z\u10A0-\u10FF]*)/g;
      let match;
      
      while ((match = regex.exec(message)) !== null) {
        const mentionName = match[1].trim();
        // Find user by name
        const user = appData.users.find(u => {
          const fullName = (u.first_name + ' ' + (u.last_name || '')).trim();
          return fullName.toLowerCase() === mentionName.toLowerCase() ||
                 u.first_name.toLowerCase() === mentionName.toLowerCase();
        });
        if (user && user.id !== currentUser.id) {
          mentions.push(user);
        }
      }
      
      return mentions;
    }
    
    // ============ CHAT FILE UPLOAD ============
    let chatPendingFiles = [];
    
    function handleChatFileSelect(event) {
      const files = Array.from(event.target.files);
      if (files.length === 0) return;
      
      // Limit file size (10MB each for Storage)
      const maxSize = 10 * 1024 * 1024;
      const validFiles = files.filter(f => {
        if (f.size > maxSize) {
          showToast('File too large (max 10MB): ' + f.name, 'error');
          return false;
        }
        return true;
      });
      
      chatPendingFiles = [...chatPendingFiles, ...validFiles].slice(0, 5); // Max 5 files
      renderChatFilePreview();
      
      // Clear input for re-selection
      event.target.value = '';
    }
    
    function renderChatFilePreview() {
      const preview = document.getElementById('chatFilePreview');
      if (!preview) return;
      
      if (chatPendingFiles.length === 0) {
        preview.style.display = 'none';
        return;
      }
      
      preview.style.display = 'block';
      preview.innerHTML = '<div style="display:flex;flex-wrap:wrap;gap:8px">' +
        chatPendingFiles.map((file, idx) => {
          const isImage = file.type.startsWith('image/');
          const icon = isImage ? 'ðŸ–¼ï¸' : (file.type.includes('pdf') ? 'ðŸ“„' : 'ðŸ“Ž');
          const preview = isImage ? URL.createObjectURL(file) : null;
          
          return '<div style="position:relative;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:8px;display:flex;align-items:center;gap:8px">' +
            (preview ? '<img src="' + preview + '" style="width:40px;height:40px;object-fit:cover;border-radius:4px">' : '<span style="font-size:24px">' + icon + '</span>') +
            '<div style="max-width:120px;overflow:hidden">' +
            '<div style="font-size:12px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + file.name + '</div>' +
            '<div style="font-size:10px;color:var(--text-muted)">' + formatFileSize(file.size) + '</div>' +
            '</div>' +
            '<button onclick="removeChatPendingFile(' + idx + ')" style="position:absolute;top:-6px;right:-6px;width:20px;height:20px;border-radius:50%;background:#ef4444;color:white;border:none;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center">Ã—</button>' +
            '</div>';
        }).join('') +
        '</div>';
    }
    
    function removeChatPendingFile(idx) {
      chatPendingFiles.splice(idx, 1);
      renderChatFilePreview();
    }
    
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    async function uploadChatFile(file) {
      const timestamp = Date.now();
      const ext = file.name.split('.').pop();
      const fileName = `chat_${currentUser.id}_${timestamp}.${ext}`;
      
      try {
        // Upload to Supabase Storage
        const { data, error } = await sb.storage
          .from('chatfiles')
          .upload(fileName, file, {
            cacheControl: '3600',
            upsert: true
          });
        
        if (error) {
          console.error('Storage upload error:', error);
          throw new Error(error.message || 'Storage upload failed');
        }
        
        const { data: urlData } = sb.storage
          .from('chatfiles')
          .getPublicUrl(fileName);
        
        return {
          url: urlData.publicUrl,
          name: file.name,
          type: file.type,
          size: file.size
        };
      } catch (storageError) {
        console.error('Upload failed:', storageError);
        
        // Base64 fallback for small files (under 500KB)
        const maxBase64Size = 500 * 1024;
        if (file.size <= maxBase64Size) {
          showToast('Storage failed, using base64', 'warning');
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
              resolve({
                url: reader.result,
                name: file.name,
                type: file.type,
                size: file.size,
                isBase64: true
              });
            };
            reader.onerror = () => reject(new Error('Failed to read file'));
            reader.readAsDataURL(file);
          });
        }
        
        throw storageError;
      }
    }
    
    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      // Need either message or files
      if (!message && chatPendingFiles.length === 0) return;
      
      // Disable input while sending
      input.disabled = true;
      
      try {
        const senderName = currentUser.first_name + ' ' + (currentUser.last_name || '');
        
        // Upload files first
        let fileAttachments = [];
        if (chatPendingFiles.length > 0) {
          showToast('Uploading files...', 'info');
          
          for (const file of chatPendingFiles) {
            try {
              const uploaded = await uploadChatFile(file);
              fileAttachments.push(uploaded);
            } catch (e) {
              showToast('Upload failed: ' + file.name, 'error');
            }
          }
        }
        
        const msgData = {
          user_id: currentUser.id,
          user_name: senderName,
          user_role: currentUser.role,
          message: message || '',
          file_attachments: fileAttachments.length > 0 ? JSON.stringify(fileAttachments) : null
        };
        
        const newMsg = await dbInsert('chat_messages', msgData);
        
        // Extract mentions and create notifications
        const mentionedUsers = extractMentions(message);
        for (const user of mentionedUsers) {
          try {
            await dbInsert('notifications', {
              user_id: user.id,
              type: 'MENTION',
              title: senderName + ' mentioned you',
              message: message.substring(0, 100) + (message.length > 100 ? '...' : ''),
              link: 'team_chat',
              is_read: false
            });
          } catch (e) {
            console.error('Failed to create notification:', e);
          }
        }
        
        // Add to local list and render
        chatMessages.push(newMsg);
        lastMessageId = newMsg.id;
        renderChatMessages();
        
        // Clear input and files
        input.value = '';
        input.style.height = '48px';
        chatPendingFiles = [];
        renderChatFilePreview();
        
        // Log activity
        await logActivity('CHAT_MESSAGE_SENT', { 
          message_preview: message.substring(0, 50), 
          mentions: mentionedUsers.map(u => u.first_name).join(', '),
          files: fileAttachments.length 
        });
        
        if (fileAttachments.length > 0) {
          showToast('Sent!');
        }
        
      } catch (e) {
        showToast('Failed to send message: ' + e.message, 'error');
      } finally {
        input.disabled = false;
        input.focus();
      }
    }
    
    // ============ MOBILE SWIPE ACTIONS ============
    function initSwipeActions(element, options = {}) {
      if (!element) return;
      
      let startX = 0;
      let currentX = 0;
      let isDragging = false;
      const threshold = 80;
      
      const content = element.querySelector('.swipe-content') || element;
      
      element.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isDragging = true;
        content.style.transition = 'none';
      }, { passive: true });
      
      element.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        currentX = e.touches[0].clientX - startX;
        
        // Limit swipe distance
        const maxSwipe = 160;
        if (currentX > maxSwipe) currentX = maxSwipe;
        if (currentX < -maxSwipe) currentX = -maxSwipe;
        
        content.style.transform = `translateX(${currentX}px)`;
      }, { passive: true });
      
      element.addEventListener('touchend', () => {
        if (!isDragging) return;
        isDragging = false;
        content.style.transition = 'transform 0.3s ease';
        
        if (currentX > threshold && options.onSwipeRight) {
          options.onSwipeRight();
        } else if (currentX < -threshold && options.onSwipeLeft) {
          options.onSwipeLeft();
        }
        
        // Reset position
        content.style.transform = 'translateX(0)';
        currentX = 0;
      });
    }
    
    // ============ BOTTOM SHEET MENU ============
    let currentBottomSheet = null;
    
    function showBottomSheet(items, title = '') {
      // Remove existing
      closeBottomSheet();
      
      const overlay = document.createElement('div');
      overlay.className = 'bottom-sheet-overlay';
      overlay.onclick = (e) => {
        if (e.target === overlay) closeBottomSheet();
      };
      
      let itemsHtml = items.map(item => {
        if (item.divider) {
          return '<div class="bottom-sheet-divider"></div>';
        }
        return '<button class="bottom-sheet-item ' + (item.danger ? 'bottom-sheet-item-danger' : '') + '" onclick="' + item.action + ';closeBottomSheet()">' +
          '<span class="bottom-sheet-item-icon">' + item.icon + '</span>' +
          '<span>' + item.label + '</span></button>';
      }).join('');
      
      overlay.innerHTML = '<div class="bottom-sheet">' +
        (title ? '<div style="padding:16px 24px 8px;font-weight:600;font-size:14px;color:var(--text-muted)">' + title + '</div>' : '') +
        itemsHtml +
        '</div>';
      
      document.body.appendChild(overlay);
      currentBottomSheet = overlay;
      
      // Trigger animation
      requestAnimationFrame(() => {
        overlay.classList.add('open');
      });
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }
    
    function closeBottomSheet() {
      if (currentBottomSheet) {
        currentBottomSheet.classList.remove('open');
        setTimeout(() => {
          currentBottomSheet?.remove();
          currentBottomSheet = null;
        }, 300);
        document.body.style.overflow = '';
      }
    }
    
    // ============ MOBILE ACTION SHEET HELPER ============
    function showMobileActions(entityType, entityId, entityName) {
      const isMobile = window.innerWidth <= 768;
      if (!isMobile) return false; // Let desktop handle normally
      
      const actions = [];
      
      switch(entityType) {
        case 'trip':
          actions.push(
            { icon: 'ðŸ‘ï¸', label: 'View', action: 'openTripView(' + entityId + ')' },
            { icon: 'âœï¸', label: 'Edit', action: 'editTrip(' + entityId + ')' },
            { icon: 'âž•', label: 'Add Vehicle', action: 'addVehicleToTrip(' + entityId + ')' },
            { divider: true },
            { icon: 'ðŸ—‘ï¸', label: 'Delete', action: 'deleteTrip(' + entityId + ')', danger: true }
          );
          break;
        case 'driver':
          actions.push(
            { icon: 'ðŸ‘ï¸', label: 'View', action: 'viewDriver(' + entityId + ')' },
            { icon: 'âœï¸', label: 'Edit', action: 'editDriver(' + entityId + ')' },
            { icon: 'ðŸ“ž', label: 'Call', action: 'callDriver(' + entityId + ')' },
            { divider: true },
            { icon: 'ðŸ—‘ï¸', label: 'Delete', action: 'deleteDriver(' + entityId + ')', danger: true }
          );
          break;
        case 'truck':
          actions.push(
            { icon: 'ðŸ‘ï¸', label: 'View', action: 'viewTruck(' + entityId + ')' },
            { icon: 'âœï¸', label: 'Edit', action: 'editTruck(' + entityId + ')' },
            { icon: 'ðŸ”§', label: 'Maintenance', action: 'addMaintenanceForTruck(' + entityId + ')' },
            { divider: true },
            { icon: 'ðŸ—‘ï¸', label: 'Delete', action: 'deleteTruck(' + entityId + ')', danger: true }
          );
          break;
        case 'order':
          actions.push(
            { icon: 'âœï¸', label: 'Edit', action: 'editVehicle(' + entityId + ')' },
            { icon: 'ðŸš›', label: 'Move to Trip', action: 'moveVehicleToTrip(' + entityId + ')' },
            { divider: true },
            { icon: 'ðŸ—‘ï¸', label: 'Delete', action: 'deleteOrder(' + entityId + ')', danger: true }
          );
          break;
        case 'task':
          actions.push(
            { icon: 'âœ…', label: 'Complete', action: 'toggleTaskComplete(' + entityId + ')' },
            { icon: 'âœï¸', label: 'Edit', action: 'editTask(' + entityId + ')' },
            { divider: true },
            { icon: 'ðŸ—‘ï¸', label: 'Delete', action: 'deleteTask(' + entityId + ')', danger: true }
          );
          break;
        case 'chat':
          actions.push(
            { icon: 'ðŸ“‹', label: 'Copy', action: 'copyMessage(' + entityId + ')' },
            { icon: 'â†©ï¸', label: 'Reply', action: 'replyToMessage(' + entityId + ')' }
          );
          break;
        default:
          return false;
      }
      
      showBottomSheet(actions, entityName);
      return true;
    }
    
    // ============ FLOATING ACTION BUTTON ============
    function addFloatingActionButton(page, action, icon = '+') {
      // Remove existing FAB
      document.querySelector('.fab')?.remove();
      
      if (window.innerWidth > 768) return; // Only on mobile
      
      const fab = document.createElement('button');
      fab.className = 'fab';
      fab.innerHTML = icon;
      fab.onclick = action;
      document.body.appendChild(fab);
      document.body.classList.add('has-fab');
    }
    
    function removeFloatingActionButton() {
      document.querySelector('.fab')?.remove();
      document.body.classList.remove('has-fab');
    }
    
    // ============ CALL DRIVER FUNCTION ============
    function callDriver(driverId) {
      const driver = appData.drivers.find(d => d.id === driverId);
      if (driver && driver.phone) {
        window.location.href = 'tel:' + driver.phone.replace(/[^0-9+]/g, '');
      } else {
        showToast('No phone number', 'error');
      }
    }
    
    function copyMessage(messageId) {
      const msg = chatMessages.find(m => m.id === messageId);
      if (msg) {
        navigator.clipboard.writeText(msg.message);
        showToast('Copied!');
      }
    }
    
    function replyToMessage(messageId) {
      const msg = chatMessages.find(m => m.id === messageId);
      if (msg) {
        const input = document.getElementById('chatInput');
        if (input) {
          input.value = '@' + msg.user_name + ' ';
          input.focus();
        }
      }
    }

    // ============ EXCEL EXPORT ============
    let xlsxLoaded = false;
    
    async function loadXLSX() {
      if (xlsxLoaded) return true;
      return new Promise((resolve) => {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        script.onload = () => {
          xlsxLoaded = true;
          resolve(true);
        };
        script.onerror = () => resolve(false);
        document.head.appendChild(script);
      });
    }
    
    async function exportToExcel(data, filename, sheetName = 'Sheet1') {
      showToast('Preparing export...', 'info');
      
      const loaded = await loadXLSX();
      if (!loaded) {
        showToast('Failed to load export library', 'error');
        return;
      }
      
      try {
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
        
        // Auto-size columns
        const colWidths = Object.keys(data[0] || {}).map(key => ({
          wch: Math.max(key.length, ...data.map(row => String(row[key] || '').length))
        }));
        ws['!cols'] = colWidths;
        
        XLSX.writeFile(wb, filename + '.xlsx');
        showToast('Export successful!');
        
        await logActivity('DATA_EXPORTED', { filename, records: data.length });
      } catch (e) {
        showToast('Export failed: ' + e.message, 'error');
      }
    }
    
    function exportTrips() {
      const data = appData.trips.map(t => {
        const truck = appData.trucks.find(tr => tr.id === t.truck_id);
        const driver = appData.drivers.find(d => d.id === t.driver_id);
        const f = getTripFin(t.id);
        return {
          'Trip #': t.trip_number || t.id,
          'Status': t.status,
          'Truck': truck ? '#' + truck.truck_number : '',
          'Driver': driver ? driver.name : '',
          'Origin': t.origin || '',
          'Destination': t.destination || '',
          'Miles': t.miles || 0,
          'Load Revenue': f.loadRevenue,
          'Broker Fee': f.brokerFee,
          'Driver Cut': f.driverCut,
          'Expenses': f.totalExpenses,
          'Net Profit': f.netProfit,
          'Vehicles': f.vehicleCount,
          'Start Date': t.start_date || '',
          'End Date': t.end_date || '',
          'Notes': t.notes || ''
        };
      });
      exportToExcel(data, 'trips_export_' + new Date().toISOString().split('T')[0], 'Trips');
    }
    
    function exportOrders() {
      const data = appData.orders.map(o => {
        const trip = appData.trips.find(t => t.id === o.trip_id);
        const broker = appData.brokers.find(b => b.id === o.broker_id);
        const dispatcher = appData.dispatchers.find(d => d.id === o.dispatcher_id);
        return {
          'Order #': o.order_number || o.id,
          'Status': o.status,
          'Trip #': trip ? trip.trip_number || trip.id : 'Unassigned',
          'Year': o.vehicle_year || '',
          'Make': o.vehicle_make || '',
          'Model': o.vehicle_model || '',
          'VIN': o.vin || '',
          'Pickup': o.pickup_location || '',
          'Delivery': o.delivery_location || '',
          'Revenue': o.revenue || 0,
          'Broker': broker ? broker.name : '',
          'Dispatcher': dispatcher ? dispatcher.name : '',
          'Pickup Date': o.pickup_date || '',
          'Delivery Date': o.delivery_date || '',
          'Notes': o.notes || ''
        };
      });
      exportToExcel(data, 'orders_export_' + new Date().toISOString().split('T')[0], 'Orders');
    }
    
    function exportFinancials() {
      // Trip-level financials
      const tripData = appData.trips.map(t => {
        const truck = appData.trucks.find(tr => tr.id === t.truck_id);
        const f = getTripFin(t.id);
        return {
          'Trip #': t.trip_number || t.id,
          'Truck': truck ? '#' + truck.truck_number : '',
          'Load Revenue': f.loadRevenue,
          'Broker Fee': f.brokerFee,
          'Local Fees': f.localFees,
          'Driver Cut': f.driverCut,
          'Trip Expenses': f.totalExpenses,
          'Gross Profit': f.grossProfit,
          'Net Profit': f.netProfit,
          'Profit Margin %': f.loadRevenue > 0 ? ((f.netProfit / f.loadRevenue) * 100).toFixed(1) : 0,
          'Revenue/Mile': t.miles > 0 ? (f.loadRevenue / t.miles).toFixed(2) : 0,
          'Profit/Mile': t.miles > 0 ? (f.netProfit / t.miles).toFixed(2) : 0
        };
      });
      
      exportToExcel(tripData, 'financials_export_' + new Date().toISOString().split('T')[0], 'Financials');
    }
    
    function exportMaintenance() {
      const data = appData.maintenance_records.map(m => {
        const truck = appData.trucks.find(t => t.id === m.truck_id);
        return {
          'Date': m.service_date || '',
          'Truck': truck ? '#' + truck.truck_number : '',
          'Service Type': m.service_type || '',
          'Description': m.description || '',
          'Cost': m.cost || 0,
          'Vendor': m.vendor || '',
          'Mileage': m.mileage || '',
          'Next Service': m.next_service_date || '',
          'Notes': m.notes || ''
        };
      });
      exportToExcel(data, 'maintenance_export_' + new Date().toISOString().split('T')[0], 'Maintenance');
    }
    
    function exportDrivers() {
      const data = appData.drivers.map(d => {
        const tripCount = appData.trips.filter(t => t.driver_id === d.id).length;
        return {
          'Name': d.name,
          'Phone': d.phone || '',
          'Email': d.email || '',
          'License #': d.license_number || '',
          'License Exp': d.license_expiration || '',
          'Status': d.status || 'ACTIVE',
          'Pay Type': d.pay_type || '',
          'Pay Rate': d.pay_rate || '',
          'Total Trips': tripCount
        };
      });
      exportToExcel(data, 'drivers_export_' + new Date().toISOString().split('T')[0], 'Drivers');
    }
    
    function exportTrucks() {
      const data = appData.trucks.map(t => {
        const tripCount = appData.trips.filter(tr => tr.truck_id === t.id).length;
        const maintenanceCost = appData.maintenance_records
          .filter(m => m.truck_id === t.id)
          .reduce((sum, m) => sum + parseFloat(m.cost || 0), 0);
        return {
          'Truck #': t.truck_number,
          'Type': t.truck_type || '',
          'Year': t.year || '',
          'Make': t.make || '',
          'Model': t.model || '',
          'VIN': t.vin || '',
          'License Plate': t.license_plate || '',
          'Status': t.status || 'ACTIVE',
          'Total Trips': tripCount,
          'Maintenance Cost': maintenanceCost
        };
      });
      exportToExcel(data, 'trucks_export_' + new Date().toISOString().split('T')[0], 'Trucks');
    }
    
    function showExportMenu() {
      const isMobile = window.innerWidth <= 768;
      
      if (isMobile) {
        showBottomSheet([
          { icon: 'ðŸš›', label: 'Export Trips', action: 'exportTrips()' },
          { icon: 'ðŸ“¦', label: 'Export Orders', action: 'exportOrders()' },
          { icon: 'ðŸ’°', label: 'Export Financials', action: 'exportFinancials()' },
          { icon: 'ðŸ”§', label: 'Export Maintenance', action: 'exportMaintenance()' },
          { divider: true },
          { icon: 'ðŸ‘¨â€âœˆï¸', label: 'Export Drivers', action: 'exportDrivers()' },
          { icon: 'ðŸšš', label: 'Export Trucks', action: 'exportTrucks()' }
        ], 'ðŸ“¥ Export to Excel');
      } else {
        showModal('export-modal', 'ðŸ“¥ ' + 'Export to Excel',
          '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">' +
          '<button class="btn btn-secondary" onclick="exportTrips();closeModal(\'export-modal\')" style="padding:20px;display:flex;flex-direction:column;align-items:center;gap:8px"><span style="font-size:24px">ðŸš›</span><span>' + 'Trips' + '</span></button>' +
          '<button class="btn btn-secondary" onclick="exportOrders();closeModal(\'export-modal\')" style="padding:20px;display:flex;flex-direction:column;align-items:center;gap:8px"><span style="font-size:24px">ðŸ“¦</span><span>' + 'Orders' + '</span></button>' +
          '<button class="btn btn-secondary" onclick="exportFinancials();closeModal(\'export-modal\')" style="padding:20px;display:flex;flex-direction:column;align-items:center;gap:8px"><span style="font-size:24px">ðŸ’°</span><span>' + 'Financials' + '</span></button>' +
          '<button class="btn btn-secondary" onclick="exportMaintenance();closeModal(\'export-modal\')" style="padding:20px;display:flex;flex-direction:column;align-items:center;gap:8px"><span style="font-size:24px">ðŸ”§</span><span>' + 'Maintenance' + '</span></button>' +
          '<button class="btn btn-secondary" onclick="exportDrivers();closeModal(\'export-modal\')" style="padding:20px;display:flex;flex-direction:column;align-items:center;gap:8px"><span style="font-size:24px">ðŸ‘¨â€âœˆï¸</span><span>' + 'Drivers' + '</span></button>' +
          '<button class="btn btn-secondary" onclick="exportTrucks();closeModal(\'export-modal\')" style="padding:20px;display:flex;flex-direction:column;align-items:center;gap:8px"><span style="font-size:24px">ðŸšš</span><span>' + 'Trucks' + '</span></button>' +
          '</div>',
          '<button class="btn btn-secondary" onclick="closeModal(\'export-modal\')">' + 'Close' + '</button>'
        );
      }
    }

    // ============ QUICK SETUP WIZARD ============
    let wizardStep = 1;
    let wizardData = {};
    
    function openSetupWizard() {
      wizardStep = 1;
      wizardData = {
        // Insurance (annual)
        liability_insurance: '',
        cargo_insurance: '',
        physical_damage: '',
        bobtail_insurance: '',
        workers_comp: '',
        general_liability: '',
        // Permits (annual)
        mc_authority: '',
        ucr_registration: '',
        ifta_irp: '',
        state_permits: '',
        hut_2290: '',
        // Truck Payments (monthly each)
        truck_payments: [],
        // Technology (monthly)
        eld_gps: '',
        dispatch_software: '',
        load_boards: '',
        accounting_software: '',
        phones_communication: '',
        // Office (monthly)
        office_rent: '',
        truck_parking: '',
        utilities_internet: '',
        bookkeeper_cpa: '',
        bank_fees: '',
        // Other
        other_monthly: ''
      };
      
      const m = document.createElement('div');
      m.className = 'modal-overlay';
      m.id = 'setup-wizard-modal';
      m.innerHTML = getWizardHTML();
      document.body.appendChild(m);
      updateWizardStep();
    }
    
    function getWizardHTML() {
      return `
        <div class="modal" style="max-width:600px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column">
          <div class="modal-header" style="background:linear-gradient(135deg,#3b82f6,#1e40af);flex-shrink:0">
            <h3 style="color:white;display:flex;align-items:center;gap:10px">
              <span style="font-size:24px">ðŸ§™â€â™‚ï¸</span> Quick Setup Wizard
            </h3>
            <button class="modal-close" onclick="closeSetupWizard()" style="color:white">Ã—</button>
          </div>
          
          <!-- Progress Bar -->
          <div style="padding:16px 20px;background:#f8fafc;border-bottom:1px solid #e2e8f0;flex-shrink:0">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span id="wizard-step-label" style="font-weight:600;color:#1e40af">Step 1 of 6</span>
              <span id="wizard-step-name" style="color:#64748b">Insurance</span>
            </div>
            <div style="height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden">
              <div id="wizard-progress" style="height:100%;background:linear-gradient(90deg,#3b82f6,#1e40af);width:16.66%;transition:width 0.3s"></div>
            </div>
          </div>
          
          <!-- Step Content -->
          <div id="wizard-content" style="padding:20px;overflow-y:auto;flex:1">
            <!-- Dynamic content here -->
          </div>
          
          <!-- Footer -->
          <div style="padding:16px 20px;border-top:1px solid #e2e8f0;display:flex;justify-content:space-between;gap:12px;flex-shrink:0;background:#f8fafc">
            <button id="wizard-back" class="btn btn-secondary" onclick="wizardBack()" style="display:none">â† Back</button>
            <div style="flex:1"></div>
            <button id="wizard-skip" class="btn btn-secondary" onclick="wizardSkip()">Skip This Step</button>
            <button id="wizard-next" class="btn btn-primary" onclick="wizardNext()">Next â†’</button>
          </div>
        </div>
      `;
    }
    
    function updateWizardStep() {
      const content = document.getElementById('wizard-content');
      const progress = document.getElementById('wizard-progress');
      const stepLabel = document.getElementById('wizard-step-label');
      const stepName = document.getElementById('wizard-step-name');
      const backBtn = document.getElementById('wizard-back');
      const nextBtn = document.getElementById('wizard-next');
      const skipBtn = document.getElementById('wizard-skip');
      
      const steps = [
        { name: 'Insurance', icon: 'ðŸ›¡ï¸' },
        { name: 'Permits & Authority', icon: 'ðŸ“‹' },
        { name: 'Truck Payments', icon: 'ðŸš›' },
        { name: 'Technology', icon: 'ðŸ’»' },
        { name: 'Office & Admin', icon: 'ðŸ ' },
        { name: 'Review & Save', icon: 'âœ…' }
      ];
      
      progress.style.width = ((wizardStep / 6) * 100) + '%';
      stepLabel.textContent = 'Step ' + wizardStep + ' of 6';
      stepName.textContent = steps[wizardStep - 1].icon + ' ' + steps[wizardStep - 1].name;
      
      backBtn.style.display = wizardStep > 1 ? 'block' : 'none';
      skipBtn.style.display = wizardStep < 6 ? 'block' : 'none';
      nextBtn.textContent = wizardStep === 6 ? 'ðŸ’¾ Save All' : 'Next â†’';
      
      // Render step content
      if (wizardStep === 1) {
        content.innerHTML = getInsuranceStepHTML();
      } else if (wizardStep === 2) {
        content.innerHTML = getPermitsStepHTML();
      } else if (wizardStep === 3) {
        content.innerHTML = getTruckPaymentsStepHTML();
      } else if (wizardStep === 4) {
        content.innerHTML = getTechnologyStepHTML();
      } else if (wizardStep === 5) {
        content.innerHTML = getOfficeStepHTML();
      } else if (wizardStep === 6) {
        content.innerHTML = getReviewStepHTML();
      }
    }
    
    function getInsuranceStepHTML() {
      return `
        <div style="margin-bottom:16px">
          <div style="background:#dbeafe;padding:12px 16px;border-radius:8px;margin-bottom:16px">
            <div style="font-weight:600;color:#1e40af;margin-bottom:4px">ðŸ›¡ï¸ Insurance Policies</div>
            <div style="font-size:13px;color:#3b82f6">Enter your ANNUAL premium amounts. We'll calculate monthly automatically.</div>
          </div>
          
          <div style="display:grid;gap:16px">
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Liability Insurance (Annual)</span>
                <span style="font-size:11px;color:#64748b">Typical: $15,000-40,000/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-liability" value="${wizardData.liability_insurance}" placeholder="e.g. 25000" style="padding-left:28px" onchange="wizardData.liability_insurance=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Cargo Insurance (Annual)</span>
                <span style="font-size:11px;color:#64748b">Typical: $3,000-8,000/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-cargo" value="${wizardData.cargo_insurance}" placeholder="e.g. 5000" style="padding-left:28px" onchange="wizardData.cargo_insurance=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Physical Damage (Annual)</span>
                <span style="font-size:11px;color:#64748b">Typical: $5,000-15,000/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-physical" value="${wizardData.physical_damage}" placeholder="e.g. 8000" style="padding-left:28px" onchange="wizardData.physical_damage=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Bobtail Insurance (Annual)</span>
                <span style="font-size:11px;color:#64748b">Typical: $1,200-3,600/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-bobtail" value="${wizardData.bobtail_insurance}" placeholder="e.g. 2000" style="padding-left:28px" onchange="wizardData.bobtail_insurance=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Workers Compensation (Annual)</span>
                <span style="font-size:11px;color:#64748b">Typical: $2,400-10,000/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-workers" value="${wizardData.workers_comp}" placeholder="e.g. 5000" style="padding-left:28px" onchange="wizardData.workers_comp=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>General Liability (Annual)</span>
                <span style="font-size:11px;color:#64748b">Typical: $1,200-3,600/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-general" value="${wizardData.general_liability}" placeholder="e.g. 2000" style="padding-left:28px" onchange="wizardData.general_liability=this.value">
              </div>
            </div>
          </div>
          
          <div style="margin-top:16px;padding:12px;background:#f0fdf4;border-radius:8px;border:1px solid #bbf7d0">
            <div style="font-size:13px;color:#166534">
              <strong>Monthly Insurance Total:</strong> 
              <span id="insurance-monthly-total">$0</span>
              <span style="color:#64748b;margin-left:8px">(Annual Ã· 12)</span>
            </div>
          </div>
        </div>
      `;
    }
    
    function getPermitsStepHTML() {
      return `
        <div style="margin-bottom:16px">
          <div style="background:#fef3c7;padding:12px 16px;border-radius:8px;margin-bottom:16px">
            <div style="font-weight:600;color:#92400e;margin-bottom:4px">ðŸ“‹ Permits & Authority</div>
            <div style="font-size:13px;color:#b45309">Enter ANNUAL amounts. These are typically paid yearly but we'll divide by 12 for monthly cost.</div>
          </div>
          
          <div style="display:grid;gap:16px">
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>MC Authority Renewal (Annual)</span>
                <span style="font-size:11px;color:#64748b">Typical: $300-600/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-mc" value="${wizardData.mc_authority}" placeholder="e.g. 500" style="padding-left:28px" onchange="wizardData.mc_authority=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>UCR Registration (Annual)</span>
                <span style="font-size:11px;color:#64748b">Typical: $100-600/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-ucr" value="${wizardData.ucr_registration}" placeholder="e.g. 200" style="padding-left:28px" onchange="wizardData.ucr_registration=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>IFTA + IRP (All Trucks Combined, Annual)</span>
                <span style="font-size:11px;color:#64748b">Typical: $2,000-5,000/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-ifta" value="${wizardData.ifta_irp}" placeholder="e.g. 3500" style="padding-left:28px" onchange="wizardData.ifta_irp=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>State Permits (CA, NY, OR, etc. - Annual)</span>
                <span style="font-size:11px;color:#64748b">Typical: $500-2,000/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-state" value="${wizardData.state_permits}" placeholder="e.g. 1000" style="padding-left:28px" onchange="wizardData.state_permits=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>HUT/2290 Heavy Use Tax (Annual)</span>
                <span style="font-size:11px;color:#64748b">Typical: $550-1,200/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-hut" value="${wizardData.hut_2290}" placeholder="e.g. 800" style="padding-left:28px" onchange="wizardData.hut_2290=this.value">
              </div>
            </div>
          </div>
          
          <div style="margin-top:16px;padding:12px;background:#f0fdf4;border-radius:8px;border:1px solid #bbf7d0">
            <div style="font-size:13px;color:#166534">
              <strong>Monthly Permits Total:</strong> 
              <span id="permits-monthly-total">$0</span>
            </div>
          </div>
        </div>
      `;
    }
    
    function getTruckPaymentsStepHTML() {
      const numTrucks = appData.trucks?.length || 4;
      let trucksHTML = '';
      
      for (let i = 0; i < Math.max(numTrucks, 1); i++) {
        const truck = appData.trucks?.[i];
        const truckLabel = truck ? 'Truck #' + truck.truck_number : 'Truck ' + (i + 1);
        const savedValue = wizardData.truck_payments[i] || '';
        
        trucksHTML += `
          <div class="form-group">
            <label style="display:flex;justify-content:space-between">
              <span>${truckLabel} - Monthly Payment</span>
              <span style="font-size:11px;color:#64748b">Typical: $1,500-3,000/mo</span>
            </label>
            <div style="position:relative">
              <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
              <input type="number" class="truck-payment-input" data-index="${i}" value="${savedValue}" placeholder="e.g. 2500" style="padding-left:28px" onchange="wizardData.truck_payments[${i}]=this.value">
            </div>
          </div>
        `;
      }
      
      return `
        <div style="margin-bottom:16px">
          <div style="background:#e0f2fe;padding:12px 16px;border-radius:8px;margin-bottom:16px">
            <div style="font-weight:600;color:#0369a1;margin-bottom:4px">ðŸš› Truck & Trailer Payments</div>
            <div style="font-size:13px;color:#0284c7">Enter MONTHLY payment for each truck (loan or lease). Leave blank if owned outright.</div>
          </div>
          
          <div style="display:grid;gap:16px">
            ${trucksHTML}
            
            <div class="form-group" style="border-top:1px dashed #e2e8f0;padding-top:16px">
              <label style="display:flex;justify-content:space-between">
                <span>Trailer Payments (All Trailers Combined, Monthly)</span>
                <span style="font-size:11px;color:#64748b">If separate from truck</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-trailers" value="${wizardData.trailer_payments || ''}" placeholder="e.g. 1500" style="padding-left:28px" onchange="wizardData.trailer_payments=this.value">
              </div>
            </div>
          </div>
          
          <div style="margin-top:16px;padding:12px;background:#f0fdf4;border-radius:8px;border:1px solid #bbf7d0">
            <div style="font-size:13px;color:#166534">
              <strong>Monthly Truck/Trailer Payments:</strong> 
              <span id="trucks-monthly-total">$0</span>
            </div>
          </div>
        </div>
      `;
    }
    
    function getTechnologyStepHTML() {
      return `
        <div style="margin-bottom:16px">
          <div style="background:#ede9fe;padding:12px 16px;border-radius:8px;margin-bottom:16px">
            <div style="font-weight:600;color:#6d28d9;margin-bottom:4px">ðŸ’» Technology & Software</div>
            <div style="font-size:13px;color:#7c3aed">Enter MONTHLY subscription/service costs.</div>
          </div>
          
          <div style="display:grid;gap:16px">
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>ELD + GPS Tracking (All Trucks, Monthly)</span>
                <span style="font-size:11px;color:#64748b">Typical: $100-200/mo total</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-eld" value="${wizardData.eld_gps}" placeholder="e.g. 150" style="padding-left:28px" onchange="wizardData.eld_gps=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Dispatch Software / TMS (Monthly)</span>
                <span style="font-size:11px;color:#64748b">Typical: $50-300/mo</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-dispatch" value="${wizardData.dispatch_software}" placeholder="e.g. 150" style="padding-left:28px" onchange="wizardData.dispatch_software=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Load Boards (CD, Super Dispatch, etc. Monthly)</span>
                <span style="font-size:11px;color:#64748b">Typical: $40-150/mo</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-loadboards" value="${wizardData.load_boards}" placeholder="e.g. 100" style="padding-left:28px" onchange="wizardData.load_boards=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Accounting Software (Monthly)</span>
                <span style="font-size:11px;color:#64748b">Typical: $25-80/mo</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-accounting" value="${wizardData.accounting_software}" placeholder="e.g. 50" style="padding-left:28px" onchange="wizardData.accounting_software=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Phones & Communication (Monthly)</span>
                <span style="font-size:11px;color:#64748b">Typical: $50-200/mo</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-phones" value="${wizardData.phones_communication}" placeholder="e.g. 100" style="padding-left:28px" onchange="wizardData.phones_communication=this.value">
              </div>
            </div>
          </div>
          
          <div style="margin-top:16px;padding:12px;background:#f0fdf4;border-radius:8px;border:1px solid #bbf7d0">
            <div style="font-size:13px;color:#166534">
              <strong>Monthly Technology Total:</strong> 
              <span id="tech-monthly-total">$0</span>
            </div>
          </div>
        </div>
      `;
    }
    
    function getOfficeStepHTML() {
      return `
        <div style="margin-bottom:16px">
          <div style="background:#fce7f3;padding:12px 16px;border-radius:8px;margin-bottom:16px">
            <div style="font-weight:600;color:#be185d;margin-bottom:4px">ðŸ  Office & Admin</div>
            <div style="font-size:13px;color:#db2777">Enter MONTHLY costs. Enter 0 if working from home.</div>
          </div>
          
          <div style="display:grid;gap:16px">
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Office Rent (Monthly)</span>
                <span style="font-size:11px;color:#64748b">$0 if home office</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-office" value="${wizardData.office_rent}" placeholder="e.g. 0" style="padding-left:28px" onchange="wizardData.office_rent=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Truck Parking / Yard (All Trucks, Monthly)</span>
                <span style="font-size:11px;color:#64748b">Typical: $400-1,200/mo</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-parking" value="${wizardData.truck_parking}" placeholder="e.g. 600" style="padding-left:28px" onchange="wizardData.truck_parking=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Utilities & Internet (Monthly)</span>
                <span style="font-size:11px;color:#64748b">Typical: $100-300/mo</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-utilities" value="${wizardData.utilities_internet}" placeholder="e.g. 150" style="padding-left:28px" onchange="wizardData.utilities_internet=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Bookkeeper / CPA (Monthly)</span>
                <span style="font-size:11px;color:#64748b">Typical: $200-500/mo</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-cpa" value="${wizardData.bookkeeper_cpa}" placeholder="e.g. 300" style="padding-left:28px" onchange="wizardData.bookkeeper_cpa=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Bank Fees (Monthly)</span>
                <span style="font-size:11px;color:#64748b">Typical: $20-100/mo</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-bank" value="${wizardData.bank_fees}" placeholder="e.g. 50" style="padding-left:28px" onchange="wizardData.bank_fees=this.value">
              </div>
            </div>
            
            <div class="form-group" style="border-top:1px dashed #e2e8f0;padding-top:16px">
              <label style="display:flex;justify-content:space-between">
                <span>Other Monthly Costs</span>
                <span style="font-size:11px;color:#64748b">Anything else recurring</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#64748b">$</span>
                <input type="number" id="wiz-other" value="${wizardData.other_monthly}" placeholder="e.g. 200" style="padding-left:28px" onchange="wizardData.other_monthly=this.value">
              </div>
            </div>
          </div>
          
          <div style="margin-top:16px;padding:12px;background:#f0fdf4;border-radius:8px;border:1px solid #bbf7d0">
            <div style="font-size:13px;color:#166534">
              <strong>Monthly Office/Admin Total:</strong> 
              <span id="office-monthly-total">$0</span>
            </div>
          </div>
        </div>
      `;
    }
    
    function getReviewStepHTML() {
      // Calculate totals
      const insurance = (
        (parseFloat(wizardData.liability_insurance) || 0) +
        (parseFloat(wizardData.cargo_insurance) || 0) +
        (parseFloat(wizardData.physical_damage) || 0) +
        (parseFloat(wizardData.bobtail_insurance) || 0) +
        (parseFloat(wizardData.workers_comp) || 0) +
        (parseFloat(wizardData.general_liability) || 0)
      ) / 12;
      
      const permits = (
        (parseFloat(wizardData.mc_authority) || 0) +
        (parseFloat(wizardData.ucr_registration) || 0) +
        (parseFloat(wizardData.ifta_irp) || 0) +
        (parseFloat(wizardData.state_permits) || 0) +
        (parseFloat(wizardData.hut_2290) || 0)
      ) / 12;
      
      const trucks = (wizardData.truck_payments || []).reduce((s, v) => s + (parseFloat(v) || 0), 0) + (parseFloat(wizardData.trailer_payments) || 0);
      
      const tech = (
        (parseFloat(wizardData.eld_gps) || 0) +
        (parseFloat(wizardData.dispatch_software) || 0) +
        (parseFloat(wizardData.load_boards) || 0) +
        (parseFloat(wizardData.accounting_software) || 0) +
        (parseFloat(wizardData.phones_communication) || 0)
      );
      
      const office = (
        (parseFloat(wizardData.office_rent) || 0) +
        (parseFloat(wizardData.truck_parking) || 0) +
        (parseFloat(wizardData.utilities_internet) || 0) +
        (parseFloat(wizardData.bookkeeper_cpa) || 0) +
        (parseFloat(wizardData.bank_fees) || 0) +
        (parseFloat(wizardData.other_monthly) || 0)
      );
      
      const total = insurance + permits + trucks + tech + office;
      
      return `
        <div style="margin-bottom:16px">
          <div style="background:#d1fae5;padding:12px 16px;border-radius:8px;margin-bottom:16px">
            <div style="font-weight:600;color:#065f46;margin-bottom:4px">âœ… Review & Save</div>
            <div style="font-size:13px;color:#047857">Review your monthly fixed costs. Click "Save All" to add these to your TMS.</div>
          </div>
          
          <div style="background:#f8fafc;border-radius:12px;padding:20px;border:1px solid #e2e8f0">
            <table style="width:100%;border-collapse:collapse">
              <tr style="border-bottom:1px solid #e2e8f0">
                <td style="padding:12px 0;font-weight:500">ðŸ›¡ï¸ Insurance</td>
                <td style="padding:12px 0;text-align:right;font-weight:600;color:#0369a1">${formatMoney(insurance)}/mo</td>
              </tr>
              <tr style="border-bottom:1px solid #e2e8f0">
                <td style="padding:12px 0;font-weight:500">ðŸ“‹ Permits & Authority</td>
                <td style="padding:12px 0;text-align:right;font-weight:600;color:#0369a1">${formatMoney(permits)}/mo</td>
              </tr>
              <tr style="border-bottom:1px solid #e2e8f0">
                <td style="padding:12px 0;font-weight:500">ðŸš› Truck/Trailer Payments</td>
                <td style="padding:12px 0;text-align:right;font-weight:600;color:#0369a1">${formatMoney(trucks)}/mo</td>
              </tr>
              <tr style="border-bottom:1px solid #e2e8f0">
                <td style="padding:12px 0;font-weight:500">ðŸ’» Technology</td>
                <td style="padding:12px 0;text-align:right;font-weight:600;color:#0369a1">${formatMoney(tech)}/mo</td>
              </tr>
              <tr style="border-bottom:2px solid #1e40af">
                <td style="padding:12px 0;font-weight:500">ðŸ  Office & Admin</td>
                <td style="padding:12px 0;text-align:right;font-weight:600;color:#0369a1">${formatMoney(office)}/mo</td>
              </tr>
              <tr style="background:#1e40af;color:white">
                <td style="padding:16px 12px;font-weight:700;font-size:16px;border-radius:0 0 0 8px">TOTAL MONTHLY FIXED COSTS</td>
                <td style="padding:16px 12px;text-align:right;font-weight:700;font-size:20px;border-radius:0 0 8px 0">${formatMoney(total)}/mo</td>
              </tr>
            </table>
          </div>
          
          <div style="margin-top:16px;padding:12px;background:#fef3c7;border-radius:8px;border:1px solid #fcd34d">
            <div style="font-size:13px;color:#92400e">
              <strong>ðŸ’¡ What happens next:</strong> We'll create individual line items in your Fixed Costs page. You can edit them anytime.
            </div>
          </div>
        </div>
      `;
    }
    
    function saveCurrentStepData() {
      // Save data from current step inputs
      if (wizardStep === 1) {
        wizardData.liability_insurance = document.getElementById('wiz-liability')?.value || '';
        wizardData.cargo_insurance = document.getElementById('wiz-cargo')?.value || '';
        wizardData.physical_damage = document.getElementById('wiz-physical')?.value || '';
        wizardData.bobtail_insurance = document.getElementById('wiz-bobtail')?.value || '';
        wizardData.workers_comp = document.getElementById('wiz-workers')?.value || '';
        wizardData.general_liability = document.getElementById('wiz-general')?.value || '';
      } else if (wizardStep === 2) {
        wizardData.mc_authority = document.getElementById('wiz-mc')?.value || '';
        wizardData.ucr_registration = document.getElementById('wiz-ucr')?.value || '';
        wizardData.ifta_irp = document.getElementById('wiz-ifta')?.value || '';
        wizardData.state_permits = document.getElementById('wiz-state')?.value || '';
        wizardData.hut_2290 = document.getElementById('wiz-hut')?.value || '';
      } else if (wizardStep === 3) {
        document.querySelectorAll('.truck-payment-input').forEach((input, i) => {
          wizardData.truck_payments[i] = input.value;
        });
        wizardData.trailer_payments = document.getElementById('wiz-trailers')?.value || '';
      } else if (wizardStep === 4) {
        wizardData.eld_gps = document.getElementById('wiz-eld')?.value || '';
        wizardData.dispatch_software = document.getElementById('wiz-dispatch')?.value || '';
        wizardData.load_boards = document.getElementById('wiz-loadboards')?.value || '';
        wizardData.accounting_software = document.getElementById('wiz-accounting')?.value || '';
        wizardData.phones_communication = document.getElementById('wiz-phones')?.value || '';
      } else if (wizardStep === 5) {
        wizardData.office_rent = document.getElementById('wiz-office')?.value || '';
        wizardData.truck_parking = document.getElementById('wiz-parking')?.value || '';
        wizardData.utilities_internet = document.getElementById('wiz-utilities')?.value || '';
        wizardData.bookkeeper_cpa = document.getElementById('wiz-cpa')?.value || '';
        wizardData.bank_fees = document.getElementById('wiz-bank')?.value || '';
        wizardData.other_monthly = document.getElementById('wiz-other')?.value || '';
      }
    }
    
    function wizardNext() {
      saveCurrentStepData();
      
      if (wizardStep === 6) {
        saveWizardData();
      } else {
        wizardStep++;
        updateWizardStep();
      }
    }
    
    function wizardBack() {
      saveCurrentStepData();
      if (wizardStep > 1) {
        wizardStep--;
        updateWizardStep();
      }
    }
    
    function wizardSkip() {
      wizardStep++;
      updateWizardStep();
    }
    
    async function saveWizardData() {
      const fixedCosts = [];
      
      // Insurance (annual Ã· 12)
      if (wizardData.liability_insurance) fixedCosts.push({ name: 'Liability Insurance', amount: parseFloat(wizardData.liability_insurance) / 12 });
      if (wizardData.cargo_insurance) fixedCosts.push({ name: 'Cargo Insurance', amount: parseFloat(wizardData.cargo_insurance) / 12 });
      if (wizardData.physical_damage) fixedCosts.push({ name: 'Physical Damage Insurance', amount: parseFloat(wizardData.physical_damage) / 12 });
      if (wizardData.bobtail_insurance) fixedCosts.push({ name: 'Bobtail Insurance', amount: parseFloat(wizardData.bobtail_insurance) / 12 });
      if (wizardData.workers_comp) fixedCosts.push({ name: 'Workers Compensation', amount: parseFloat(wizardData.workers_comp) / 12 });
      if (wizardData.general_liability) fixedCosts.push({ name: 'General Liability', amount: parseFloat(wizardData.general_liability) / 12 });
      
      // Permits (annual Ã· 12)
      if (wizardData.mc_authority) fixedCosts.push({ name: 'MC Authority', amount: parseFloat(wizardData.mc_authority) / 12 });
      if (wizardData.ucr_registration) fixedCosts.push({ name: 'UCR Registration', amount: parseFloat(wizardData.ucr_registration) / 12 });
      if (wizardData.ifta_irp) fixedCosts.push({ name: 'IFTA + IRP', amount: parseFloat(wizardData.ifta_irp) / 12 });
      if (wizardData.state_permits) fixedCosts.push({ name: 'State Permits', amount: parseFloat(wizardData.state_permits) / 12 });
      if (wizardData.hut_2290) fixedCosts.push({ name: 'HUT/2290 Tax', amount: parseFloat(wizardData.hut_2290) / 12 });
      
      // Truck payments (already monthly)
      (wizardData.truck_payments || []).forEach((payment, i) => {
        if (payment) {
          const truck = appData.trucks?.[i];
          const label = truck ? 'Truck #' + truck.truck_number + ' Payment' : 'Truck ' + (i + 1) + ' Payment';
          fixedCosts.push({ name: label, amount: parseFloat(payment) });
        }
      });
      if (wizardData.trailer_payments) fixedCosts.push({ name: 'Trailer Payments', amount: parseFloat(wizardData.trailer_payments) });
      
      // Technology (already monthly)
      if (wizardData.eld_gps) fixedCosts.push({ name: 'ELD + GPS Tracking', amount: parseFloat(wizardData.eld_gps) });
      if (wizardData.dispatch_software) fixedCosts.push({ name: 'Dispatch Software', amount: parseFloat(wizardData.dispatch_software) });
      if (wizardData.load_boards) fixedCosts.push({ name: 'Load Boards', amount: parseFloat(wizardData.load_boards) });
      if (wizardData.accounting_software) fixedCosts.push({ name: 'Accounting Software', amount: parseFloat(wizardData.accounting_software) });
      if (wizardData.phones_communication) fixedCosts.push({ name: 'Phones & Communication', amount: parseFloat(wizardData.phones_communication) });
      
      // Office (already monthly)
      if (wizardData.office_rent) fixedCosts.push({ name: 'Office Rent', amount: parseFloat(wizardData.office_rent) });
      if (wizardData.truck_parking) fixedCosts.push({ name: 'Truck Parking/Yard', amount: parseFloat(wizardData.truck_parking) });
      if (wizardData.utilities_internet) fixedCosts.push({ name: 'Utilities & Internet', amount: parseFloat(wizardData.utilities_internet) });
      if (wizardData.bookkeeper_cpa) fixedCosts.push({ name: 'Bookkeeper/CPA', amount: parseFloat(wizardData.bookkeeper_cpa) });
      if (wizardData.bank_fees) fixedCosts.push({ name: 'Bank Fees', amount: parseFloat(wizardData.bank_fees) });
      if (wizardData.other_monthly) fixedCosts.push({ name: 'Other Monthly Costs', amount: parseFloat(wizardData.other_monthly) });
      
      if (fixedCosts.length === 0) {
        showToast('No costs to save', 'error');
        return;
      }
      
      try {
        // Save each fixed cost
        let saved = 0;
        for (const cost of fixedCosts) {
          await dbInsert('fixed_costs', cost);
          saved++;
        }
        
        closeSetupWizard();
        showToast('âœ… Saved ' + saved + ' fixed costs!', 'success');
        await loadAllData(true);
        renderPage();
      } catch (e) {
        showToast('Error saving: ' + e.message, 'error');
      }
    }
    
    function closeSetupWizard() {
      document.getElementById('setup-wizard-modal')?.remove();
    }

    function cleanupChat() {
      if (chatRefreshInterval) {
        clearInterval(chatRefreshInterval);
        chatRefreshInterval = null;
      }
    }

    // ============ MINI CHAT WIDGET ============
    function initMiniChat() {
      // Don't show on team_chat page
      if (currentPage === 'team_chat') {
        document.body.classList.add('on-team-chat');
        return;
      }
      document.body.classList.remove('on-team-chat');
      
      // Remove existing mini chat elements
      document.querySelector('.mini-chat-bubble')?.remove();
      document.querySelector('.mini-chat-window')?.remove();
      
      // Create chat bubble
      const bubble = document.createElement('button');
      bubble.className = 'mini-chat-bubble';
      bubble.innerHTML = 'ðŸ’¬' + (unreadChatCount > 0 ? '<span class="badge">' + (unreadChatCount > 99 ? '99+' : unreadChatCount) + '</span>' : '');
      bubble.onclick = toggleMiniChat;
      document.body.appendChild(bubble);
      
      // Start checking for new messages
      startMiniChatPolling();
    }
    
    function toggleMiniChat() {
      if (miniChatOpen) {
        closeMiniChat();
      } else {
        openMiniChat();
      }
    }
    
    function openMiniChat() {
      miniChatOpen = true;
      
      // Mark messages as seen
      if (chatMessages.length > 0) {
        lastSeenChatId = chatMessages[chatMessages.length - 1].id;
        localStorage.setItem('lastSeenChatId', lastSeenChatId.toString());
        unreadChatCount = 0;
        updateChatBadges();
      }
      
      const window = document.createElement('div');
      window.className = 'mini-chat-window';
      window.innerHTML = 
        '<div class="mini-chat-header">' +
        '<h4>ðŸ’¬ ' + 'Team Chat' + '</h4>' +
        '<div style="display:flex;gap:8px">' +
        '<button onclick="navigate(\'team_chat\');closeMiniChat()" title="' + 'Full Chat' + '">â†—ï¸</button>' +
        '<button onclick="closeMiniChat()">âœ•</button>' +
        '</div></div>' +
        '<div class="mini-chat-messages" id="miniChatMessages"><div style="text-align:center;color:var(--text-muted);padding:20px">Loading...</div></div>' +
        '<div id="miniChatFilePreview" style="display:none;padding:8px 12px;background:var(--bg-tertiary);border-top:1px solid var(--border)"></div>' +
        '<div class="mini-chat-input-area" style="position:relative">' +
        '<div id="miniMentionDropdown" style="display:none;position:absolute;bottom:100%;left:0;right:0;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;box-shadow:0 -4px 20px rgba(0,0,0,0.15);max-height:180px;overflow-y:auto;margin-bottom:4px;z-index:100"></div>' +
        '<input type="file" id="miniChatFileInput" accept="image/*,.pdf,.doc,.docx" style="display:none" onchange="handleMiniChatFileSelect(event)">' +
        '<button onclick="document.getElementById(\'miniChatFileInput\').click()" style="width:36px;height:36px;border-radius:50%;background:var(--bg-tertiary);border:1px solid var(--border);cursor:pointer;font-size:16px" title="' + 'Attach file' + '">ðŸ“Ž</button>' +
        '<input type="text" id="miniChatInput" placeholder="' + '@ to mention...' + '" oninput="handleMiniChatMention(event)" onkeydown="handleMiniChatKeydown(event)">' +
        '<button onclick="sendMiniChatMessage()">ðŸ“¤</button>' +
        '</div>';
      
      document.body.appendChild(window);
      
      // Load messages
      loadMiniChatMessages();
      
      // Focus input
      setTimeout(() => document.getElementById('miniChatInput')?.focus(), 100);
    }
    
    function closeMiniChat() {
      miniChatOpen = false;
      document.querySelector('.mini-chat-window')?.remove();
    }
    
    async function loadMiniChatMessages() {
      try {
        chatMessages = await dbFetch('chat_messages', { order: 'created_at.asc', limit: 50 }) || [];
        renderMiniChatMessages();
      } catch (e) {
        document.getElementById('miniChatMessages').innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Chat not available</div>';
      }
    }
    
    function renderMiniChatMessages() {
      const container = document.getElementById('miniChatMessages');
      if (!container) return;
      
      if (chatMessages.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">No messages yet</div>';
        return;
      }
      
      container.innerHTML = chatMessages.slice(-20).map(msg => {
        const isOwn = msg.user_id === currentUser.id;
        const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        return '<div style="margin-bottom:8px;' + (isOwn ? 'text-align:right' : '') + '">' +
          '<div style="display:inline-block;max-width:80%;padding:8px 12px;border-radius:12px;' + 
          (isOwn ? 'background:var(--primary);color:white' : 'background:var(--bg-tertiary)') + '">' +
          (!isOwn ? '<div style="font-size:11px;font-weight:600;margin-bottom:2px">' + (msg.user_name || 'Unknown') + '</div>' : '') +
          '<div style="font-size:13px">' + (msg.message || '').replace(/\n/g, '<br>') + '</div>' +
          '</div>' +
          '<div style="font-size:10px;color:var(--text-muted);margin-top:2px">' + time + '</div>' +
          '</div>';
      }).join('');
      
      container.scrollTop = container.scrollHeight;
    }
    
    async function sendMiniChatMessage() {
      const input = document.getElementById('miniChatInput');
      const message = input.value.trim();
      
      if (!message && !miniChatPendingFile) return;
      
      try {
        const msgData = {
          user_id: currentUser.id,
          user_name: currentUser.first_name + ' ' + (currentUser.last_name || ''),
          message: message
        };
        
        await dbInsert('chat_messages', msgData);
        input.value = '';
        miniChatPendingFile = null;
        renderMiniChatFilePreview();
        await loadMiniChatMessages();
      } catch (e) {
        showToast('Failed to send message', 'error');
      }
    }
    
    function startMiniChatPolling() {
      if (miniChatRefreshInterval) clearInterval(miniChatRefreshInterval);
      
      miniChatRefreshInterval = setInterval(async () => {
        try {
          const newMessages = await dbFetch('chat_messages', { 
            order: 'id.desc', 
            limit: 1 
          }) || [];
          
          if (newMessages.length > 0) {
            const latestId = newMessages[0].id;
            const newCount = latestId - lastSeenChatId;
            
            if (newCount !== unreadChatCount && newCount > 0) {
              unreadChatCount = Math.max(0, newCount);
              updateChatBadges();
              
              // Play sound for new messages
              if (unreadChatCount > 0 && !miniChatOpen && currentPage !== 'team_chat') {
                playNotificationSound();
              }
            }
          }
        } catch (e) {
          // Silent fail for polling
        }
      }, 10000);
    }
    
    function stopMiniChatPolling() {
      if (miniChatRefreshInterval) {
        clearInterval(miniChatRefreshInterval);
        miniChatRefreshInterval = null;
      }
    }
    
    function updateChatBadges() {
      // Update mini chat bubble
      const bubble = document.querySelector('.mini-chat-bubble');
      if (bubble) {
        if (unreadChatCount > 0) {
          bubble.innerHTML = 'ðŸ’¬<span class="badge">' + (unreadChatCount > 99 ? '99+' : unreadChatCount) + '</span>';
        } else {
          bubble.innerHTML = 'ðŸ’¬';
        }
      }
      
      // Update nav badge
      const navBadge = document.getElementById('navChatBadge');
      if (unreadChatCount > 0) {
        if (navBadge) {
          navBadge.textContent = unreadChatCount > 99 ? '99+' : unreadChatCount;
          navBadge.style.display = 'flex';
        }
      } else if (navBadge) {
        navBadge.style.display = 'none';
      }
    }
    
    function renderMiniChatFilePreview() {
      const preview = document.getElementById('miniChatFilePreview');
      if (!preview) return;
      
      if (miniChatPendingFile) {
        preview.style.display = 'block';
        preview.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center">' +
          '<span style="font-size:12px">ðŸ“Ž ' + miniChatPendingFile.name + '</span>' +
          '<button onclick="miniChatPendingFile=null;renderMiniChatFilePreview()" style="background:none;border:none;cursor:pointer">âœ•</button></div>';
      } else {
        preview.style.display = 'none';
        preview.innerHTML = '';
      }
    }
    
    let miniChatPendingFile = null;
    let miniMentionStartPos = -1;
    
    function handleMiniChatMention(e) {
      const input = e.target;
      const cursorPos = input.selectionStart;
      const text = input.value;
      
      // Check for @ mention trigger
      const textBeforeCursor = text.substring(0, cursorPos);
      const atMatch = textBeforeCursor.match(/@(\w*)$/);
      
      if (atMatch) {
        miniMentionStartPos = cursorPos - atMatch[1].length - 1;
        showMiniMentionDropdown(atMatch[1]);
      } else {
        hideMiniMentionDropdown();
      }
    }
    
    function handleMiniChatKeydown(e) {
      const dropdown = document.getElementById('miniMentionDropdown');
      
      if (e.key === 'Enter') {
        if (dropdown && dropdown.style.display !== 'none') {
          // Select first mention
          const firstItem = dropdown.querySelector('.mention-item');
          if (firstItem) {
            firstItem.click();
            e.preventDefault();
            return;
          }
        }
        sendMiniChatMessage();
        e.preventDefault();
      } else if (e.key === 'Escape') {
        hideMiniMentionDropdown();
      } else if (e.key === 'Tab' && dropdown && dropdown.style.display !== 'none') {
        const firstItem = dropdown.querySelector('.mention-item');
        if (firstItem) {
          firstItem.click();
          e.preventDefault();
        }
      }
    }
    
    function showMiniMentionDropdown(query) {
      const dropdown = document.getElementById('miniMentionDropdown');
      if (!dropdown) return;
      
      const allUsers = appData.users || [];
      const filtered = query 
        ? allUsers.filter(u => 
            (u.first_name + ' ' + (u.last_name || '')).toLowerCase().includes(query.toLowerCase()) ||
            (u.email || '').toLowerCase().includes(query.toLowerCase())
          )
        : allUsers;
      
      if (filtered.length === 0) {
        dropdown.style.display = 'none';
        return;
      }
      
      dropdown.style.display = 'block';
      dropdown.innerHTML = filtered.slice(0, 6).map((u, idx) => {
        const name = u.first_name + ' ' + (u.last_name || '');
        const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const color = getAvatarColor(u.id);
        return '<div class="mention-item" onclick="selectMiniMention(' + u.id + ', \'' + name.replace(/'/g, "\\'") + '\')" style="display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;' + (idx === 0 ? 'background:var(--bg-tertiary);' : '') + '" onmouseover="this.style.background=\'var(--bg-tertiary)\'" onmouseout="this.style.background=\'' + (idx === 0 ? 'var(--bg-tertiary)' : 'transparent') + '\'">' +
          '<div style="width:28px;height:28px;border-radius:50%;background:' + color + ';color:white;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600">' + initials + '</div>' +
          '<div><div style="font-weight:500;font-size:13px">' + name + '</div>' +
          '<div style="font-size:11px;color:var(--text-muted)">' + (u.role || 'User') + '</div></div>' +
          '</div>';
      }).join('');
    }
    
    function hideMiniMentionDropdown() {
      const dropdown = document.getElementById('miniMentionDropdown');
      if (dropdown) dropdown.style.display = 'none';
      miniMentionStartPos = -1;
    }
    
    function selectMiniMention(userId, userName) {
      const input = document.getElementById('miniChatInput');
      if (!input || miniMentionStartPos < 0) return;
      
      const before = input.value.substring(0, miniMentionStartPos);
      const after = input.value.substring(input.selectionStart);
      
      input.value = before + '@' + userName + ' ' + after;
      input.focus();
      
      const newPos = miniMentionStartPos + userName.length + 2;
      input.setSelectionRange(newPos, newPos);
      
      hideMiniMentionDropdown();
    }
    
    function handleMiniChatFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Limit file size (10MB for Storage)
      if (file.size > 10 * 1024 * 1024) {
        showToast('File too large (max 10MB)', 'error');
        return;
      }
      
      miniChatPendingFile = file;
      renderMiniChatFilePreview();
      event.target.value = '';
    }
    
    function renderMiniChatFilePreview() {
      const preview = document.getElementById('miniChatFilePreview');
      if (!preview) return;
      
      if (!miniChatPendingFile) {
        preview.style.display = 'none';
        return;
      }
      
      const isImage = miniChatPendingFile.type.startsWith('image/');
      const icon = isImage ? 'ðŸ–¼ï¸' : 'ðŸ“Ž';
      
      preview.style.display = 'flex';
      preview.innerHTML = '<div style="display:flex;align-items:center;gap:8px;flex:1">' +
        '<span style="font-size:18px">' + icon + '</span>' +
        '<div style="flex:1;overflow:hidden"><div style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + miniChatPendingFile.name + '</div>' +
        '<div style="font-size:10px;color:var(--text-muted)">' + formatFileSize(miniChatPendingFile.size) + '</div></div>' +
        '<button onclick="miniChatPendingFile=null;renderMiniChatFilePreview()" style="width:24px;height:24px;border-radius:50%;background:#ef4444;color:white;border:none;cursor:pointer;font-size:14px">Ã—</button>' +
        '</div>';
    }
    
    function closeMiniChat() {
      miniChatOpen = false;
      document.querySelector('.mini-chat-window')?.remove();
    }
    
    async function loadMiniChatMessages() {
      try {
        chatMessages = await dbFetch('chat_messages', { order: 'created_at.asc', limit: 50 }) || [];
        renderMiniChatMessages();
      } catch (e) {
        console.error('Failed to load mini chat messages:', e);
      }
    }
    
    function renderMiniChatMessages() {
      const container = document.getElementById('miniChatMessages');
      if (!container) return;
      
      if (chatMessages.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:40px">' + 
          'No messages yet' + '</div>';
        return;
      }
      
      // Show last 20 messages
      const recentMessages = chatMessages.slice(-20);
      
      const isDark = document.body.classList.contains('dark-theme');
      const otherMsgBg = isDark ? 'var(--bg-card)' : '#ffffff';
      const otherMsgColor = isDark ? 'var(--text-primary)' : '#1e293b';
      const otherMsgBorder = isDark ? '1px solid var(--border)' : '1px solid #e2e8f0';
      const otherMsgShadow = isDark ? '0 2px 6px rgba(0,0,0,0.3)' : '0 2px 6px rgba(0,0,0,0.1)';
      const textMuted = isDark ? 'var(--text-muted)' : '#64748b';
      
      container.innerHTML = recentMessages.map(msg => {
        const isOwnMessage = msg.user_id === currentUser.id;
        const initials = msg.user_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const color = getAvatarColor(msg.user_id);
        const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        // Parse file attachments
        let attachmentsHtml = '';
        if (msg.file_attachments) {
          try {
            const files = typeof msg.file_attachments === 'string' ? JSON.parse(msg.file_attachments) : msg.file_attachments;
            if (files && files.length > 0) {
              attachmentsHtml = '<div style="margin-top:6px">';
              files.forEach(file => {
                const isImage = file.type && file.type.startsWith('image/');
                if (isImage) {
                  attachmentsHtml += '<a href="' + file.url + '" target="_blank"><img src="' + file.url + '" style="max-width:150px;max-height:100px;border-radius:6px;margin-top:4px;display:block" onclick="openImageViewer(\'' + file.url + '\');event.preventDefault()"></a>';
                } else {
                  attachmentsHtml += '<a href="' + file.url + '" target="_blank" download style="display:flex;align-items:center;gap:6px;padding:6px 8px;background:' + (isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)') + ';border-radius:6px;text-decoration:none;color:inherit;font-size:11px;margin-top:4px">ðŸ“Ž ' + escapeHtml(file.name) + '</a>';
                }
              });
              attachmentsHtml += '</div>';
            }
          } catch (e) {}
        }
        
        return '<div style="display:flex;gap:8px;' + (isOwnMessage ? 'flex-direction:row-reverse' : '') + '">' +
          '<div style="width:32px;height:32px;border-radius:50%;background:' + color + ';color:white;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;flex-shrink:0">' + initials + '</div>' +
          '<div style="max-width:70%">' +
          '<div style="font-size:11px;color:' + textMuted + ';margin-bottom:2px;' + (isOwnMessage ? 'text-align:right' : '') + '">' + msg.user_name + '</div>' +
          '<div style="background:' + (isOwnMessage ? 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)' : otherMsgBg) + ';color:' + (isOwnMessage ? 'white' : otherMsgColor) + ';padding:8px 12px;border-radius:12px;font-size:13px;box-shadow:' + (isOwnMessage ? '0 2px 6px rgba(34, 197, 94, 0.3)' : otherMsgShadow) + ';border:' + (isOwnMessage ? 'none' : otherMsgBorder) + '">' +
          (msg.message ? formatMessageWithMentions(msg.message, isOwnMessage) : '') +
          attachmentsHtml +
          '<div style="font-size:10px;opacity:0.7;margin-top:4px;text-align:right">' + time + '</div>' +
          '</div></div></div>';
      }).join('');
      
      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }
    
    async function sendMiniChatMessage() {
      const input = document.getElementById('miniChatInput');
      const message = input.value.trim();
      
      // Need either message or file
      if (!message && !miniChatPendingFile) return;
      
      input.disabled = true;
      
      try {
        const senderName = currentUser.first_name + ' ' + (currentUser.last_name || '');
        
        // Upload file if present
        let fileAttachments = [];
        if (miniChatPendingFile) {
          try {
            showToast('Uploading...', 'info');
            const uploaded = await uploadChatFile(miniChatPendingFile);
            fileAttachments.push(uploaded);
          } catch (e) {
            showToast('Upload failed', 'error');
          }
        }
        
        const msgData = {
          user_id: currentUser.id,
          user_name: senderName,
          user_role: currentUser.role,
          message: message || '',
          file_attachments: fileAttachments.length > 0 ? JSON.stringify(fileAttachments) : null
        };
        
        const newMsg = await dbInsert('chat_messages', msgData);
        
        // Extract mentions and create notifications
        const mentionedUsers = extractMentions(message);
        for (const user of mentionedUsers) {
          try {
            await dbInsert('notifications', {
              user_id: user.id,
              type: 'MENTION',
              title: senderName + ' mentioned you',
              message: message.substring(0, 100) + (message.length > 100 ? '...' : ''),
              link: 'team_chat',
              is_read: false
            });
          } catch (e) {}
        }
        
        chatMessages.push(newMsg);
        lastSeenChatId = newMsg.id;
        localStorage.setItem('lastSeenChatId', lastSeenChatId.toString());
        
        renderMiniChatMessages();
        input.value = '';
        miniChatPendingFile = null;
        renderMiniChatFilePreview();
        
        await logActivity('CHAT_MESSAGE_SENT', { message_preview: message.substring(0, 50), via: 'mini_chat', files: fileAttachments.length });
      } catch (e) {
        showToast('Failed to send message', 'error');
      } finally {
        input.disabled = false;
        input.focus();
      }
    }
    
    function startMiniChatPolling() {
      if (miniChatRefreshInterval) clearInterval(miniChatRefreshInterval);
      
      // Check for new messages every 10 seconds
      miniChatRefreshInterval = setInterval(async () => {
        try {
          const messages = await dbFetch('chat_messages', { order: 'created_at.desc', limit: 10 }) || [];
          
          if (messages.length > 0) {
            const latestId = messages[0].id;
            const newCount = messages.filter(m => m.id > lastSeenChatId && m.user_id !== currentUser.id).length;
            
            if (newCount !== unreadChatCount) {
              unreadChatCount = newCount;
              updateChatBadges();
              
              // Play sound if new messages
              if (newCount > 0 && !miniChatOpen && currentPage !== 'team_chat') {
                playNotificationSound();
              }
            }
            
            // Update messages if mini chat is open
            if (miniChatOpen) {
              chatMessages = await dbFetch('chat_messages', { order: 'created_at.asc', limit: 50 }) || [];
              renderMiniChatMessages();
            }
          }
        } catch (e) {}
      }, 10000);
    }
    
    function updateChatBadges() {
      // Update bubble badge
      const bubble = document.querySelector('.mini-chat-bubble');
      if (bubble) {
        const badge = bubble.querySelector('.badge');
        if (unreadChatCount > 0) {
          if (badge) {
            badge.textContent = unreadChatCount > 99 ? '99+' : unreadChatCount;
          } else {
            bubble.innerHTML = 'ðŸ’¬<span class="badge">' + (unreadChatCount > 99 ? '99+' : unreadChatCount) + '</span>';
          }
        } else {
          bubble.innerHTML = 'ðŸ’¬';
        }
      }
      
      // Update nav badge
      const navBadge = document.getElementById('navChatBadge');
      if (navBadge) {
        if (unreadChatCount > 0) {
          navBadge.textContent = unreadChatCount > 99 ? '99+' : unreadChatCount;
          navBadge.style.display = 'block';
        } else {
          navBadge.style.display = 'none';
        }
      }
      
      // Re-render nav to update badge
      renderNav();
    }
    
    function stopMiniChatPolling() {
      if (miniChatRefreshInterval) {
        clearInterval(miniChatRefreshInterval);
        miniChatRefreshInterval = null;
      }
    }

    // ============ NOTIFICATIONS SYSTEM ============
    let notifications = [];
    let notificationRefreshInterval = null;
    let previousUnreadCount = 0;
    
    function playNotificationSound() {
      try {
        // Create a simple beep sound using Web Audio API
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.value = 0.1;
        
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.15);
      } catch (e) {
        console.log('Could not play notification sound');
      }
    }
    
    async function loadNotifications() {
      try {
        const previousCount = notifications.filter(n => !n.is_read).length;
        
        notifications = await dbFetch('notifications', { 
          filter: { user_id: 'eq.' + currentUser.id },
          order: 'created_at.desc',
          limit: 50 
        }) || [];
        
        const currentUnreadCount = notifications.filter(n => !n.is_read).length;
        
        // Play sound if new notifications arrived
        if (currentUnreadCount > previousUnreadCount && previousUnreadCount > 0) {
          playNotificationSound();
          // Show toast for new notification
          const newest = notifications.find(n => !n.is_read);
          if (newest) {
            showToast('ðŸ”” ' + (newest.title || 'New notification'), 'info');
          }
        }
        
        previousUnreadCount = currentUnreadCount;
        updateNotificationBadge();
        renderNotificationList();
      } catch (e) {
        console.error('Failed to load notifications:', e);
        notifications = [];
      }
    }
    
    function updateNotificationBadge() {
      const badge = document.getElementById('notificationBadge');
      if (!badge) return;
      
      const unreadCount = notifications.filter(n => !n.is_read).length;
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }
    
    function renderNotificationList() {
      const list = document.getElementById('notificationList');
      if (!list) return;
      
      if (notifications.length === 0) {
        list.innerHTML = '<div style="padding:40px 20px;text-align:center;color:var(--text-muted)">' +
          '<div style="font-size:32px;margin-bottom:12px">ðŸ””</div>' +
          '<div>' + 'No notifications' + '</div></div>';
        return;
      }
      
      list.innerHTML = notifications.map(n => {
        const timeAgo = getTimeAgo(n.created_at);
        const icon = n.type === 'MENTION' ? 'ðŸ’¬' : 'ðŸ””';
        
        return '<div class="notification-item ' + (n.is_read ? '' : 'unread') + '" onclick="handleNotificationClick(' + n.id + ', \'' + (n.link || '') + '\')">' +
          '<div class="notification-icon">' + icon + '</div>' +
          '<div class="notification-content">' +
          '<div class="notification-title">' + escapeHtml(n.title || 'Notification') + '</div>' +
          '<div class="notification-message">' + escapeHtml(n.message || '') + '</div>' +
          '<div class="notification-time">' + timeAgo + '</div>' +
          '</div></div>';
      }).join('');
    }
    
    function getTimeAgo(dateStr) {
      const now = new Date();
      const date = new Date(dateStr);
      const seconds = Math.floor((now - date) / 1000);
      
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
      return date.toLocaleDateString();
    }
    
    function toggleNotificationDropdown() {
      const dropdown = document.getElementById('notificationDropdown');
      const userDropdown = document.getElementById('userDropdown');
      
      // Close user dropdown if open
      if (userDropdown) userDropdown.classList.remove('open');
      document.querySelector('.topbar-user-wrapper')?.classList.remove('open');
      
      if (dropdown) {
        const isOpen = dropdown.classList.contains('open');
        dropdown.classList.toggle('open');
        
        // Load notifications when opening
        if (!isOpen) {
          loadNotifications();
        }
      }
    }
    
    async function handleNotificationClick(notificationId, link) {
      // Mark as read
      try {
        await dbUpdate('notifications', notificationId, { is_read: true });
        const notif = notifications.find(n => n.id === notificationId);
        if (notif) notif.is_read = true;
        updateNotificationBadge();
        renderNotificationList();
      } catch (e) {
        console.error('Failed to mark notification as read:', e);
      }
      
      // Navigate if there's a link
      if (link) {
        toggleNotificationDropdown();
        navigate(link);
      }
    }
    
    async function markAllNotificationsRead() {
      try {
        const unread = notifications.filter(n => !n.is_read);
        for (const n of unread) {
          await dbUpdate('notifications', n.id, { is_read: true });
          n.is_read = true;
        }
        updateNotificationBadge();
        renderNotificationList();
        showToast('All marked as read');
      } catch (e) {
        showToast('Failed to update', 'error');
      }
    }
    
    // Start notification polling
    function startNotificationPolling() {
      loadNotifications();
      if (notificationRefreshInterval) clearInterval(notificationRefreshInterval);
      notificationRefreshInterval = setInterval(loadNotifications, 30000); // Check every 30 seconds
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
      const notifWrapper = document.querySelector('.notification-wrapper');
      const notifDropdown = document.getElementById('notificationDropdown');
      
      if (notifWrapper && !notifWrapper.contains(e.target) && notifDropdown) {
        notifDropdown.classList.remove('open');
      }
    });

    function toggleApiKeyVisibility() {
      const input = document.getElementById('apiKeyInput');
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    function saveApiKey() {
      const key = document.getElementById('apiKeyInput').value.trim();
      if (key && !key.startsWith('sk-')) {
        showToast('Invalid API key format. Should start with sk-', 'error');
        return;
      }
      setApiKey(key);
      showToast('API Key saved!');
      renderSettings(document.getElementById('main-content'));
    }

    function clearApiKey() {
      if (!confirm('Remove API key? AI features will be disabled.')) return;
      setApiKey('');
      showToast('API Key removed');
      renderSettings(document.getElementById('main-content'));
    }

    async function testApiKey() {
      const key = document.getElementById('apiKeyInput').value.trim();
      const resultDiv = document.getElementById('apiTestResult');
      
      if (!key) {
        resultDiv.innerHTML = '<div style="background:#fee2e2;padding:12px;border-radius:8px;color:#dc2626">Please enter an API key first</div>';
        return;
      }
      
      resultDiv.innerHTML = '<div style="background:#fef3c7;padding:12px;border-radius:8px;color:#92400e">â³ Testing connection...</div>';
      
      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': key,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 10,
            messages: [{ role: 'user', content: 'Say "OK"' }]
          })
        });
        
        if (response.ok) {
          resultDiv.innerHTML = '<div style="background:#d1fae5;padding:12px;border-radius:8px;color:#059669">âœ“ Connection successful! API key is valid.</div>';
        } else {
          const error = await response.json();
          resultDiv.innerHTML = '<div style="background:#fee2e2;padding:12px;border-radius:8px;color:#dc2626">âœ— Error: ' + (error.error?.message || 'Invalid API key') + '</div>';
        }
      } catch (e) {
        resultDiv.innerHTML = '<div style="background:#fee2e2;padding:12px;border-radius:8px;color:#dc2626">âœ— Connection failed: ' + e.message + '</div>';
      }
    }

    function renderUsers(c) {
      if (currentUser.role !== 'ADMIN') { c.innerHTML = '<div style="text-align:center;padding:60px">Access Denied</div>'; return; }
      c.innerHTML = '<div class="header"><h2>Users</h2><button class="btn btn-primary" onclick="openUserModal()">+ New User</button></div><div class="card"><div class="table-wrapper"><table><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead><tbody>' + appData.users.map(u => '<tr><td><strong>' + u.first_name + ' ' + u.last_name + '</strong></td><td>' + u.email + '</td><td><span class="badge ' + (u.role === 'ADMIN' ? 'badge-red' : u.role === 'MANAGER' ? 'badge-amber' : 'badge-blue') + '">' + u.role + '</span></td><td><span class="badge ' + (u.is_active ? 'badge-green' : 'badge-gray') + '">' + (u.is_active ? 'Active' : 'Inactive') + '</span></td><td><div class="actions"><button class="action-btn edit" onclick="openUserModal(' + u.id + ')">Edit</button>' + (u.id !== currentUser.id ? '<button class="action-btn delete" onclick="deleteUser(' + u.id + ')">Del</button>' : '') + '</div></td></tr>').join('') + '</tbody></table></div></div>';
    }

    function openUserModal(id = null) {
      const u = id ? appData.users.find(x => x.id === id) : null;
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:450px"><div class="modal-header"><h3>' + (u ? 'Edit' : 'New') + ' User</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body"><div class="form-row"><div class="form-group"><label>First Name</label><input id="uFirst" value="' + (u?.first_name || '') + '"></div><div class="form-group"><label>Last Name</label><input id="uLast" value="' + (u?.last_name || '') + '"></div></div><div class="form-group"><label>Email</label><input id="uEmail" value="' + (u?.email || '') + '"></div><div class="form-group"><label>Password' + (u ? ' (blank = keep)' : '') + '</label><input type="password" id="uPass"></div><div class="form-row"><div class="form-group"><label>Role</label><select id="uRole"><option' + (u?.role === 'DISPATCHER' ? ' selected' : '') + '>DISPATCHER</option><option' + (u?.role === 'MANAGER' ? ' selected' : '') + '>MANAGER</option><option' + (u?.role === 'ADMIN' ? ' selected' : '') + '>ADMIN</option></select></div><div class="form-group"><label>Active</label><select id="uActive"><option value="true"' + (u?.is_active !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (u?.is_active === false ? ' selected' : '') + '>No</option></select></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveUser(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    async function saveUser(id) {
      const data = { first_name: document.getElementById('uFirst').value, last_name: document.getElementById('uLast').value, email: document.getElementById('uEmail').value, role: document.getElementById('uRole').value, is_active: document.getElementById('uActive').value === 'true' };
      const pass = document.getElementById('uPass').value;
      if (pass || !id) {
        // Hash password before saving
        data.password = await hashPassword(pass);
      }
      try { 
        if (id) { 
          await dbUpdate('users', id, data); 
          await logActivity('USER_UPDATED', { target_user_id: id, user_email: data.email, role: data.role, is_active: data.is_active });
        } else { 
          const newUser = await dbInsert('users', data); 
          await logActivity('USER_CREATED', { target_user_id: newUser.id, user_email: data.email, role: data.role });
        } 
        document.querySelector('.modal-overlay').remove(); showToast('Saved!'); await loadAllData(); renderUsers(document.getElementById('main-content')); 
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteUser(id) { 
      if (!confirm('Delete?')) return; 
      const user = appData.users.find(u => u.id === id);
      await dbDelete('users', id); 
      await logActivity('USER_DELETED', { target_user_id: id, user_email: user?.email });
      showToast('Deleted'); await loadAllData(); renderUsers(document.getElementById('main-content')); 
    }

    // ============ ACTIVITY LOG SECTION ============
    let activityLogData = [];
    let activityLogFilter = 'all';
    
    let activityDateFrom = '';
    let activityDateTo = '';
    
    async function renderActivityLog(c) {
      // Fetch activity log from database
      try {
        activityLogData = await dbFetch('activity_log', { order: 'created_at.desc', limit: 1000 }) || [];
      } catch (e) {
        activityLogData = [];
      }
      
      const actionTypes = [...new Set(activityLogData.map(a => a.action))].sort();
      const userEmails = [...new Set(activityLogData.map(a => a.user_email))].filter(e => e && e !== 'unknown').sort();
      
      // Filter data
      let filtered = activityLogFilter === 'all' 
        ? activityLogData 
        : activityLogData.filter(a => a.action === activityLogFilter || a.user_email === activityLogFilter);
      
      // Apply date filter
      if (activityDateFrom) {
        filtered = filtered.filter(a => new Date(a.created_at) >= new Date(activityDateFrom));
      }
      if (activityDateTo) {
        const endDate = new Date(activityDateTo);
        endDate.setDate(endDate.getDate() + 1);
        filtered = filtered.filter(a => new Date(a.created_at) < endDate);
      }
      
      // Pagination
      pagination.activity_log.total = filtered.length;
      const paginatedData = getPaginatedData(filtered, 'activity_log');
      
      // Action type colors
      const actionColors = {
        'LOGIN_SUCCESS': '#22c55e',
        'LOGOUT': '#64748b',
        'SIGNUP': '#3b82f6',
        'VEHICLE_ADDED': '#10b981',
        'VEHICLE_UPDATED': '#f59e0b',
        'VEHICLE_REMOVED_FROM_TRIP': '#ef4444',
        'TRIP_CREATED': '#22c55e',
        'TRIP_UPDATED': '#f59e0b',
        'TRIP_DELETED': '#ef4444',
        'ORDER_CREATED': '#22c55e',
        'ORDER_UPDATED': '#f59e0b',
        'ORDER_DELETED': '#ef4444',
        'TRUCK_CREATED': '#22c55e',
        'TRUCK_UPDATED': '#f59e0b',
        'TRUCK_DELETED': '#ef4444',
        'DRIVER_CREATED': '#22c55e',
        'DRIVER_UPDATED': '#f59e0b',
        'EXPENSE_CREATED': '#f59e0b',
        'EXPENSE_DELETED': '#ef4444',
        'TASK_CREATED': '#22c55e',
        'TASK_COMPLETED': '#10b981',
        'TASK_REOPENED': '#f59e0b',
        'TASK_DELETED': '#ef4444',
        'CLAIM_CREATED': '#f59e0b',
        'CLAIM_UPDATED': '#3b82f6',
        'MAINTENANCE_CREATED': '#3b82f6',
        'MAINTENANCE_UPDATED': '#f59e0b',
        'USER_CREATED': '#22c55e',
        'USER_UPDATED': '#f59e0b',
        'USER_DELETED': '#ef4444',
        'PASSWORD_RESET_SUCCESS': '#8b5cf6',
        'DATA_EXPORTED': '#6366f1',
        'CHAT_MESSAGE_SENT': '#06b6d4'
      };
      
      // Action category icons
      const actionIcons = {
        'LOGIN': 'ðŸ”', 'LOGOUT': 'ðŸšª', 'SIGNUP': 'ðŸ‘¤',
        'TRIP': 'ðŸš›', 'ORDER': 'ðŸ“¦', 'VEHICLE': 'ðŸš—',
        'TRUCK': 'ðŸšš', 'DRIVER': 'ðŸ‘¨â€âœˆï¸', 'EXPENSE': 'ðŸ’¸',
        'TASK': 'ðŸ“‹', 'CLAIM': 'âš ï¸', 'MAINTENANCE': 'ðŸ”§',
        'USER': 'ðŸ‘¥', 'PASSWORD': 'ðŸ”‘', 'DATA': 'ðŸ“Š',
        'CHAT': 'ðŸ’¬', 'FIXED_COST': 'ðŸ“', 'VARIABLE_COST': 'ðŸ’µ',
        'LOCAL_DRIVER': 'ðŸš', 'BROKER': 'ðŸ¤', 'DISPATCHER': 'ðŸ“ž'
      };
      
      function getActionIcon(action) {
        for (const [key, icon] of Object.entries(actionIcons)) {
          if (action.includes(key)) return icon;
        }
        return 'ðŸ“';
      }
      
      c.innerHTML = '<div class="header"><h2>ðŸ“‹ ' + 'Audit Trail' + '</h2>' +
        '<button class="btn btn-secondary" onclick="exportActivityLog()">ðŸ“¥ ' + 'Export' + '</button></div>' +
        
        // Stats cards
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:20px">' +
        '<div class="stat-card" style="background:linear-gradient(135deg,#22c55e22,#22c55e11)"><div class="label">' + 'Today' + '</div><div class="value">' + activityLogData.filter(a => new Date(a.created_at).toDateString() === new Date().toDateString()).length + '</div></div>' +
        '<div class="stat-card" style="background:linear-gradient(135deg,#3b82f622,#3b82f611)"><div class="label">' + 'This Week' + '</div><div class="value">' + activityLogData.filter(a => new Date(a.created_at) > new Date(Date.now() - 7*24*60*60*1000)).length + '</div></div>' +
        '<div class="stat-card" style="background:linear-gradient(135deg,#f59e0b22,#f59e0b11)"><div class="label">' + 'Unique Users' + '</div><div class="value">' + userEmails.length + '</div></div>' +
        '<div class="stat-card" style="background:linear-gradient(135deg,#8b5cf622,#8b5cf611)"><div class="label">' + 'Total Records' + '</div><div class="value">' + activityLogData.length + '</div></div>' +
        '</div>' +
        
        // Filters
        '<div class="card" style="margin-bottom:20px;padding:16px">' +
        '<div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">' +
        '<div style="display:flex;gap:8px;align-items:center"><label>' + 'Filter:' + '</label>' +
        '<select onchange="activityLogFilter=this.value;pagination.activity_log.page=1;renderActivityLog(document.getElementById(\'main-content\'))" style="padding:8px 12px;border-radius:6px;border:1px solid var(--border)">' +
        '<option value="all"' + (activityLogFilter === 'all' ? ' selected' : '') + '>' + 'All Activities' + '</option>' +
        '<optgroup label="' + 'By Action' + '">' + actionTypes.map(a => '<option value="' + a + '"' + (activityLogFilter === a ? ' selected' : '') + '>' + a.replace(/_/g, ' ') + '</option>').join('') + '</optgroup>' +
        '<optgroup label="' + 'By User' + '">' + userEmails.map(e => '<option value="' + e + '"' + (activityLogFilter === e ? ' selected' : '') + '>' + e + '</option>').join('') + '</optgroup>' +
        '</select></div>' +
        '<div style="display:flex;gap:8px;align-items:center"><label>' + 'From:' + '</label>' +
        '<input type="date" value="' + activityDateFrom + '" onchange="activityDateFrom=this.value;pagination.activity_log.page=1;renderActivityLog(document.getElementById(\'main-content\'))" style="padding:8px;border-radius:6px;border:1px solid var(--border)"></div>' +
        '<div style="display:flex;gap:8px;align-items:center"><label>' + 'To:' + '</label>' +
        '<input type="date" value="' + activityDateTo + '" onchange="activityDateTo=this.value;pagination.activity_log.page=1;renderActivityLog(document.getElementById(\'main-content\'))" style="padding:8px;border-radius:6px;border:1px solid var(--border)"></div>' +
        '<button class="btn btn-secondary" onclick="activityLogFilter=\'all\';activityDateFrom=\'\';activityDateTo=\'\';pagination.activity_log.page=1;renderActivityLog(document.getElementById(\'main-content\'))" style="padding:8px 12px">â†º ' + 'Clear' + '</button>' +
        '<span style="color:var(--text-muted);margin-left:auto">' + 'Showing' + ' ' + paginatedData.data.length + ' / ' + filtered.length + '</span>' +
        '</div></div>' +
        
        '<div class="card"><div class="table-wrapper"><table>' +
        '<thead><tr><th style="width:50px"></th><th style="width:160px">' + 'Date/Time' + '</th><th style="width:200px">' + 'User' + '</th><th style="width:180px">' + 'Action' + '</th><th>' + 'Details' + '</th></tr></thead>' +
        '<tbody>' +
        (paginatedData.data.length === 0 
          ? '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-muted)">' + 'No activity logs found' + '</td></tr>' 
          : paginatedData.data.map(a => {
              const color = actionColors[a.action] || '#64748b';
              const icon = getActionIcon(a.action);
              let details = '';
              try {
                const d = typeof a.details === 'string' ? JSON.parse(a.details || '{}') : (a.details || {});
                details = Object.entries(d).map(([k, v]) => '<span style="background:var(--bg-tertiary);padding:2px 6px;border-radius:4px;margin-right:4px;margin-bottom:2px;display:inline-block;font-size:11px"><strong>' + k.replace(/_/g, ' ') + ':</strong> ' + (v || '-') + '</span>').join('');
              } catch (e) { details = a.details || '-'; }
              
              return '<tr style="cursor:pointer" onclick="showActivityDetail(' + JSON.stringify(a).replace(/"/g, '&quot;') + ')">' +
                '<td style="font-size:20px;text-align:center">' + icon + '</td>' +
                '<td style="font-size:13px;white-space:nowrap">' + formatDateTime(a.created_at) + '</td>' +
                '<td style="font-weight:500">' + (a.user_email || 'System') + '</td>' +
                '<td><span style="background:' + color + '22;color:' + color + ';padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600">' + a.action.replace(/_/g, ' ') + '</span></td>' +
                '<td style="font-size:12px">' + details + '</td>' +
                '</tr>';
            }).join('')) +
        '</tbody></table></div>' +
        renderPaginationControls('activity_log') +
        '</div>';
    }
    
    function showActivityDetail(activity) {
      let detailsHtml = '';
      try {
        const d = typeof activity.details === 'string' ? JSON.parse(activity.details || '{}') : (activity.details || {});
        detailsHtml = '<div style="display:grid;gap:12px">' +
          Object.entries(d).map(([k, v]) => 
            '<div style="display:flex;justify-content:space-between;padding:12px;background:var(--bg-tertiary);border-radius:8px">' +
            '<span style="font-weight:500;color:var(--text-muted)">' + k.replace(/_/g, ' ').toUpperCase() + '</span>' +
            '<span style="font-weight:600">' + (v || '-') + '</span></div>'
          ).join('') + '</div>';
      } catch (e) {
        detailsHtml = '<p>' + (activity.details || 'No details') + '</p>';
      }
      
      showModal('activity-detail-modal', 'ðŸ“‹ ' + 'Activity Details',
        '<div style="margin-bottom:20px">' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">' +
        '<div><label style="color:var(--text-muted);font-size:12px">' + 'Date/Time' + '</label><div style="font-weight:600">' + formatDateTime(activity.created_at) + '</div></div>' +
        '<div><label style="color:var(--text-muted);font-size:12px">' + 'User' + '</label><div style="font-weight:600">' + (activity.user_email || 'System') + '</div></div>' +
        '<div><label style="color:var(--text-muted);font-size:12px">' + 'Action' + '</label><div style="font-weight:600">' + activity.action.replace(/_/g, ' ') + '</div></div>' +
        '<div><label style="color:var(--text-muted);font-size:12px">IP</label><div style="font-weight:600">' + (activity.ip_address || '-') + '</div></div>' +
        '</div>' +
        '<label style="color:var(--text-muted);font-size:12px;display:block;margin-bottom:8px">' + 'Details' + '</label>' +
        detailsHtml +
        '</div>',
        '<button class="btn btn-secondary" onclick="closeModal(\'activity-detail-modal\')">' + 'Close' + '</button>'
      );
    }
    
    async function exportActivityLog() {
      const data = activityLogData.map(a => {
        let details = {};
        try { details = typeof a.details === 'string' ? JSON.parse(a.details || '{}') : (a.details || {}); } catch(e) {}
        return {
          'Date/Time': formatDateTime(a.created_at),
          'User': a.user_email || 'System',
          'Action': a.action,
          'IP Address': a.ip_address || '',
          ...details
        };
      });
      exportToExcel(data, 'audit_trail_' + new Date().toISOString().split('T')[0], 'Audit Trail');
    }
    
    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Process pending auth from landing page
    async function processPendingAuth() {
      // Check for pending login
      const pendingLogin = sessionStorage.getItem('pendingLogin');
      if (pendingLogin) {
        sessionStorage.removeItem('pendingLogin');
        const { email, password } = JSON.parse(pendingLogin);
        
        // Check if account is locked
        const lockStatus = isAccountLocked(email.toLowerCase());
        if (lockStatus.locked) {
          alert(`Account locked. Try again in ${lockStatus.remainingMinutes} minutes.`);
          window.location.href = 'index.html';
          return false;
        }
        
        try {
          const users = await dbFetch('users', { filter: { email: 'eq.' + email.toLowerCase() } });
          if (users.length === 0) {
            recordLoginAttempt(email.toLowerCase(), false);
            alert('User not found');
            window.location.href = 'index.html';
            return false;
          }
          
          const user = users[0];
          
          // Check if user is active
          if (user.is_active === false) {
            alert('Account deactivated. Contact administrator.');
            window.location.href = 'index.html';
            return false;
          }
          
          // Hash password and compare
          const hashedPassword = await hashPassword(password);
          const passwordMatch = user.password === hashedPassword || user.password === password;
          
          if (!passwordMatch) {
            recordLoginAttempt(email.toLowerCase(), false);
            const attempts = getLoginAttempts(email.toLowerCase());
            if (attempts.count >= LOGIN_ATTEMPT_LIMIT) {
              alert(`Too many attempts. Account locked for ${LOGIN_LOCKOUT_MINUTES} minutes.`);
            } else {
              alert('Invalid password');
            }
            window.location.href = 'index.html';
            return false;
          }
          
          // Successful login
          recordLoginAttempt(email.toLowerCase(), true);
          
          // Update to hashed password if it was plain text
          if (user.password === password && user.password !== hashedPassword) {
            try {
              await dbUpdate('users', user.id, { password: hashedPassword });
            } catch (e) { /* Ignore */ }
          }
          
          currentUser = user;
          localStorage.setItem('horizonstar_user', JSON.stringify(user));
          startSessionMonitor();
          await logActivity('LOGIN_SUCCESS', { email: email.toLowerCase(), source: 'landing_page' });
          return true;
        } catch (e) {
          alert('Login error: ' + e.message);
          window.location.href = 'index.html';
          return false;
        }
      }
      
      // Check for pending signup
      const pendingSignup = sessionStorage.getItem('pendingSignup');
      if (pendingSignup) {
        sessionStorage.removeItem('pendingSignup');
        const { firstName, lastName, email, password } = JSON.parse(pendingSignup);
        
        try {
          // Check if email exists
          const existing = await dbFetch('users', { filter: { email: 'eq.' + email.toLowerCase() } });
          if (existing.length > 0) {
            alert('Email already registered');
            window.location.href = 'index.html';
            return false;
          }
          
          // Create user
          const newUser = await dbInsert('users', {
            email: email.toLowerCase(),
            password: password,
            first_name: firstName,
            last_name: lastName,
            role: 'DISPATCHER'
          });
          
          // Create dispatcher record
          await dbInsert('dispatchers', {
            name: firstName + ' ' + lastName,
            email: email.toLowerCase(),
            user_id: newUser.id
          });
          
          currentUser = {
            id: newUser.id,
            email: email.toLowerCase(),
            first_name: firstName,
            last_name: lastName,
            role: 'DISPATCHER'
          };
          localStorage.setItem('horizonstar_user', JSON.stringify(currentUser));
          return true;
        } catch (e) {
          alert('Signup error: ' + e.message);
          window.location.href = 'index.html';
          return false;
        }
      }
      
      return false;
    }

    // Start app
    (async function init() {
      // Try to restore Supabase Auth session
      try {
        const { data: { session } } = await sb.auth.getSession();
        if (session) {
          authSession = session;
          
          // Get user from our users table
          const users = await dbFetch('users', { filter: { email: 'eq.' + session.user.email } });
          if (users.length > 0) {
            currentUser = users[0];
            localStorage.setItem('horizonstar_user', JSON.stringify(currentUser));
          }
        } else {
          // No Supabase session - clear any stale local data
          currentUser = null;
          localStorage.removeItem('horizonstar_user');
        }
      } catch (e) {
        console.log('Session restore failed:', e);
        // Clear stale data on error
        currentUser = null;
        localStorage.removeItem('horizonstar_user');
      }
      
      // Listen for auth state changes
      sb.auth.onAuthStateChange((event, session) => {
        authSession = session;
        if (event === 'SIGNED_OUT') {
          currentUser = null;
          localStorage.removeItem('horizonstar_user');
          renderLogin();
        }
      });
      
      // Check for session timeout first
      if (currentUser && checkSessionTimeout()) {
        return; // Session expired, will show login
      }
      
      // If already logged in with valid Supabase session, show app
      if (currentUser && authSession) {
        startSessionMonitor();
        renderApp();
        return;
      }
      
      // Check for pending auth from landing page
      const authProcessed = await processPendingAuth();
      if (authProcessed && currentUser && authSession) {
        renderApp();
        return;
      }
      
      // Not logged in or no valid session, show login
      renderLogin();
    })();
    
    // ============ PWA SERVICE WORKER ============
    // Only register on HTTPS (not local file://)
    if ('serviceWorker' in navigator && location.protocol === 'https:') {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('PWA: Service Worker registered', reg.scope))
          .catch(err => console.log('PWA: Service Worker failed', err));
      });
    }
    
    // PWA Install Prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Show install button after login
      setTimeout(() => {
        if (document.querySelector('.sidebar') && !localStorage.getItem('pwa_install_dismissed')) {
          showPWAInstallPrompt();
        }
      }, 5000);
    });
    
    function showPWAInstallPrompt() {
      const prompt = document.createElement('div');
      prompt.id = 'pwa-install-prompt';
      prompt.innerHTML = `
        <div style="position:fixed;bottom:20px;right:20px;background:linear-gradient(135deg,#22c55e,#16a34a);color:white;padding:20px;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:99999;max-width:320px;font-family:Inter,sans-serif;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
            <span style="font-size:32px;">ðŸ“±</span>
            <div>
              <div style="font-weight:700;font-size:16px;">Install TMS App</div>
              <div style="font-size:13px;opacity:0.9;">Add to home screen for quick access</div>
            </div>
          </div>
          <div style="display:flex;gap:10px;">
            <button onclick="installPWA()" style="flex:1;background:white;color:#16a34a;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;">Install</button>
            <button onclick="dismissPWAPrompt()" style="background:rgba(255,255,255,0.2);color:white;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;">Later</button>
          </div>
        </div>
      `;
      document.body.appendChild(prompt);
    }
    
    function installPWA() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(choice => {
          if (choice.outcome === 'accepted') {
            console.log('PWA: User accepted install');
          }
          deferredPrompt = null;
        });
      }
      document.getElementById('pwa-install-prompt')?.remove();
    }
    
    function dismissPWAPrompt() {
      localStorage.setItem('pwa_install_dismissed', 'true');
      document.getElementById('pwa-install-prompt')?.remove();
    }
    
    // iOS Install Instructions (iOS doesn't support beforeinstallprompt)
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }
    
    function isInStandaloneMode() {
      return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    }
    
    if (isIOS() && !isInStandaloneMode() && !localStorage.getItem('ios_install_dismissed')) {
      setTimeout(() => {
        if (document.querySelector('.sidebar')) {
          showIOSInstallPrompt();
        }
      }, 5000);
    }
    
    function showIOSInstallPrompt() {
      const prompt = document.createElement('div');
      prompt.id = 'ios-install-prompt';
      prompt.innerHTML = `
        <div style="position:fixed;bottom:20px;left:20px;right:20px;background:linear-gradient(135deg,#22c55e,#16a34a);color:white;padding:20px;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:99999;font-family:Inter,sans-serif;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
            <span style="font-size:32px;">ðŸ“±</span>
            <div>
              <div style="font-weight:700;font-size:16px;">Install TMS App</div>
              <div style="font-size:13px;opacity:0.9;">Add to your home screen</div>
            </div>
            <button onclick="dismissIOSPrompt()" style="margin-left:auto;background:none;border:none;color:white;font-size:20px;cursor:pointer;">Ã—</button>
          </div>
          <div style="background:rgba(0,0,0,0.2);padding:12px;border-radius:8px;font-size:13px;">
            <div style="margin-bottom:8px;">1. Tap the <strong>Share</strong> button <span style="background:white;color:#333;padding:2px 6px;border-radius:4px;">â¬†ï¸</span></div>
            <div>2. Scroll down and tap <strong>"Add to Home Screen"</strong></div>
          </div>
        </div>
      `;
      document.body.appendChild(prompt);
    }
    
    function dismissIOSPrompt() {
      localStorage.setItem('ios_install_dismissed', 'true');
      document.getElementById('ios-install-prompt')?.remove();
    }
    
    // ============================================
    // ENHANCED REPORTS MODULE
    // Truck P&L, Driver Performance, Lane Analysis
    // ============================================
    
    let reportTab = 'truck_pl';
    let reportPeriod = 'month';
    let reportMonth = new Date().getMonth() + 1;
    let reportYear = new Date().getFullYear();
    let reportCompare = false;

    function renderReports(c) {
      const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      
      const filteredTrips = filterReportTripsByPeriod(appData.trips);
      const filteredOrders = appData.orders.filter(o => {
        const trip = appData.trips.find(t => t.id === o.trip_id);
        return trip && filteredTrips.includes(trip);
      });
      
      const prevPeriodTrips = reportCompare ? filterReportTripsByPeriod(appData.trips, true) : [];
      const prevPeriodOrders = reportCompare ? appData.orders.filter(o => {
        const trip = appData.trips.find(t => t.id === o.trip_id);
        return trip && prevPeriodTrips.includes(trip);
      }) : [];
      
      c.innerHTML = '<div class="header"><h2>ðŸ“Š Enhanced Reports</h2><div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap"><select id="reportPeriod" onchange="reportPeriod=this.value;renderReports(document.getElementById(\'main-content\'))" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card)"><option value="month"' + (reportPeriod === 'month' ? ' selected' : '') + '>Monthly</option><option value="quarter"' + (reportPeriod === 'quarter' ? ' selected' : '') + '>Quarterly</option><option value="year"' + (reportPeriod === 'year' ? ' selected' : '') + '>Yearly</option><option value="all"' + (reportPeriod === 'all' ? ' selected' : '') + '>All Time</option></select>' +
        (reportPeriod === 'month' ? '<select id="reportMonth" onchange="reportMonth=parseInt(this.value);renderReports(document.getElementById(\'main-content\'))" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card)">' + months.slice(1).map((m, i) => '<option value="' + (i+1) + '"' + (reportMonth === i+1 ? ' selected' : '') + '>' + m + '</option>').join('') + '</select>' : '') +
        (reportPeriod !== 'all' ? '<select id="reportYear" onchange="reportYear=parseInt(this.value);renderReports(document.getElementById(\'main-content\'))" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card)"><option value="2024"' + (reportYear === 2024 ? ' selected' : '') + '>2024</option><option value="2025"' + (reportYear === 2025 ? ' selected' : '') + '>2025</option><option value="2026"' + (reportYear === 2026 ? ' selected' : '') + '>2026</option><option value="2027"' + (reportYear === 2027 ? ' selected' : '') + '>2027</option></select>' : '') +
        '<label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox"' + (reportCompare ? ' checked' : '') + ' onchange="reportCompare=this.checked;renderReports(document.getElementById(\'main-content\'))"><span style="font-size:13px">Compare to previous</span></label><button class="btn btn-secondary" onclick="exportReportCSV()">ðŸ“¥ Export CSV</button></div></div>' +
        '<div style="display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap"><button class="btn ' + (reportTab === 'truck_pl' ? 'btn-primary' : 'btn-secondary') + '" onclick="reportTab=\'truck_pl\';renderReports(document.getElementById(\'main-content\'))">ðŸš› Truck P&L</button><button class="btn ' + (reportTab === 'driver_performance' ? 'btn-primary' : 'btn-secondary') + '" onclick="reportTab=\'driver_performance\';renderReports(document.getElementById(\'main-content\'))">ðŸ‘¨â€âœˆï¸ Driver Performance</button><button class="btn ' + (reportTab === 'lane_analysis' ? 'btn-primary' : 'btn-secondary') + '" onclick="reportTab=\'lane_analysis\';renderReports(document.getElementById(\'main-content\'))">ðŸ›£ï¸ Lane Analysis</button></div>' +
        '<div id="reportContent">' +
        (reportTab === 'truck_pl' ? renderTruckPLReport(filteredTrips, filteredOrders, prevPeriodTrips, prevPeriodOrders) : '') +
        (reportTab === 'driver_performance' ? renderDriverPerformanceReport(filteredTrips, filteredOrders, prevPeriodTrips, prevPeriodOrders) : '') +
        (reportTab === 'lane_analysis' ? renderLaneAnalysisReport(filteredTrips, filteredOrders, prevPeriodTrips, prevPeriodOrders) : '') +
        '</div>';
    }

    function filterReportTripsByPeriod(trips, previous = false) {
      if (reportPeriod === 'all') return trips;
      
      let startDate, endDate;
      const year = previous ? (reportPeriod === 'month' && reportMonth === 1 ? reportYear - 1 : reportYear) : reportYear;
      const month = previous ? (reportMonth === 1 ? 12 : reportMonth - 1) : reportMonth;
      
      if (reportPeriod === 'month') {
        startDate = new Date(year, month - 1, 1);
        endDate = new Date(year, month, 0);
      } else if (reportPeriod === 'quarter') {
        const q = Math.ceil(reportMonth / 3);
        const actualQ = previous ? (q === 1 ? 4 : q - 1) : q;
        const actualYear = previous && q === 1 ? reportYear - 1 : reportYear;
        startDate = new Date(actualYear, (actualQ - 1) * 3, 1);
        endDate = new Date(actualYear, actualQ * 3, 0);
      } else if (reportPeriod === 'year') {
        const actualYear = previous ? reportYear - 1 : reportYear;
        startDate = new Date(actualYear, 0, 1);
        endDate = new Date(actualYear, 11, 31);
      }
      
      return trips.filter(t => {
        if (!t.trip_date) return false;
        const tripDate = new Date(t.trip_date);
        return tripDate >= startDate && tripDate <= endDate;
      });
    }

    function renderTruckPLReport(trips, orders, prevTrips, prevOrders) {
      const trucks = appData.trucks.filter(t => t.status === 'ACTIVE');
      const monthlyFixedCosts = (appData.fixed_costs || []).reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);
      const fixedCostPerTruck = trucks.length > 0 ? monthlyFixedCosts / trucks.length : 0;
      
      let totalRevenue = 0, totalDriverCut = 0, totalFuel = 0, totalOther = 0, totalProfit = 0;
      
      const truckData = trucks.map(truck => {
        const truckTrips = trips.filter(t => t.truck_id === truck.id);
        const truckOrders = orders.filter(o => truckTrips.some(t => t.id === o.trip_id));
        
        const revenue = truckOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
        const brokerFees = truckOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
        const localFees = truckOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
        const cleanGross = revenue - brokerFees - localFees;
        
        const driverCut = truckTrips.reduce((sum, trip) => {
          const tripOrders = truckOrders.filter(o => o.trip_id === trip.id);
          const tripRevenue = tripOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
          const tripBroker = tripOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
          const tripLocal = tripOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
          const tripClean = tripRevenue - tripBroker - tripLocal;
          return sum + (tripClean * ((trip.driver_cut_percent || 32) / 100));
        }, 0);
        
        const tripIds = truckTrips.map(t => t.id);
        const fuelExpenses = (appData.expenses || []).filter(e => tripIds.includes(e.trip_id) && e.category === 'FUEL').reduce((s, e) => s + parseFloat(e.amount || 0), 0);
        const otherExpenses = (appData.expenses || []).filter(e => tripIds.includes(e.trip_id) && e.category !== 'FUEL').reduce((s, e) => s + parseFloat(e.amount || 0), 0);
        const maintenance = (appData.maintenance_records || []).filter(m => m.truck_id === truck.id).reduce((s, m) => s + parseFloat(m.cost || 0), 0);
        
        const totalCosts = driverCut + fuelExpenses + otherExpenses + fixedCostPerTruck + maintenance;
        const netProfit = cleanGross - totalCosts;
        const margin = cleanGross > 0 ? (netProfit / cleanGross) * 100 : 0;
        
        let prevData = null;
        if (reportCompare && prevTrips.length > 0) {
          const prevTruckTrips = prevTrips.filter(t => t.truck_id === truck.id);
          const prevTruckOrders = prevOrders.filter(o => prevTruckTrips.some(t => t.id === o.trip_id));
          const prevRevenue = prevTruckOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
          const prevBroker = prevTruckOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
          const prevLocal = prevTruckOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
          prevData = { revenue: prevRevenue - prevBroker - prevLocal, trips: prevTruckTrips.length };
        }
        
        totalRevenue += cleanGross;
        totalDriverCut += driverCut;
        totalFuel += fuelExpenses;
        totalOther += otherExpenses + maintenance + fixedCostPerTruck;
        totalProfit += netProfit;
        
        return { truck, trips: truckTrips.length, cars: truckOrders.length, revenue: cleanGross, driverCut, fuel: fuelExpenses, other: otherExpenses + maintenance + fixedCostPerTruck, netProfit, margin, prevData };
      }).sort((a, b) => b.netProfit - a.netProfit);
      
      const totalMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
      
      return '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px"><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Total Revenue</div><div style="font-size:28px;font-weight:700;color:#22c55e">' + formatMoney(totalRevenue) + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Total Costs</div><div style="font-size:28px;font-weight:700;color:#ef4444">' + formatMoney(totalDriverCut + totalFuel + totalOther) + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Net Profit</div><div style="font-size:28px;font-weight:700;color:' + (totalProfit >= 0 ? '#22c55e' : '#ef4444') + '">' + formatMoney(totalProfit) + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Profit Margin</div><div style="font-size:28px;font-weight:700;color:' + (totalMargin >= 25 ? '#22c55e' : totalMargin >= 15 ? '#f59e0b' : '#ef4444') + '">' + totalMargin.toFixed(1) + '%</div></div></div>' +
        '<div class="card"><div class="card-header"><h3>ðŸš› Profit & Loss by Truck</h3></div><div class="table-wrapper"><table><thead><tr><th>Truck</th><th>Trips</th><th>Cars</th><th>Revenue</th><th>Driver Cut</th><th>Fuel</th><th>Other Costs</th><th>Net Profit</th><th>Margin</th>' + (reportCompare ? '<th>vs Prev</th>' : '') + '</tr></thead><tbody>' +
        truckData.map((d, i) => '<tr><td><div style="display:flex;align-items:center;gap:8px">' + (i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : 'ðŸš›') + '<strong>' + d.truck.truck_number + '</strong></div></td><td>' + d.trips + '</td><td>' + d.cars + '</td><td style="color:#22c55e;font-weight:600">' + formatMoney(d.revenue) + '</td><td style="color:#ef4444">' + formatMoney(d.driverCut) + '</td><td style="color:#f59e0b">' + formatMoney(d.fuel) + '</td><td style="color:#64748b">' + formatMoney(d.other) + '</td><td style="font-weight:700;color:' + (d.netProfit >= 0 ? '#22c55e' : '#ef4444') + '">' + formatMoney(d.netProfit) + '</td><td><span style="padding:4px 8px;border-radius:12px;font-size:12px;font-weight:600;background:' + (d.margin >= 25 ? '#dcfce7' : d.margin >= 15 ? '#fef3c7' : '#fee2e2') + ';color:' + (d.margin >= 25 ? '#166534' : d.margin >= 15 ? '#92400e' : '#dc2626') + '">' + d.margin.toFixed(1) + '%</span></td>' + (reportCompare ? '<td>' + (d.prevData ? '<span style="color:' + (d.revenue >= d.prevData.revenue ? '#22c55e' : '#ef4444') + '">' + (d.revenue >= d.prevData.revenue ? 'â†‘' : 'â†“') + ' ' + Math.abs(((d.revenue - d.prevData.revenue) / (d.prevData.revenue || 1)) * 100).toFixed(0) + '%</span>' : '-') + '</td>' : '') + '</tr>').join('') +
        '<tr style="background:var(--bg-darker);font-weight:700"><td><strong>TOTAL</strong></td><td>' + truckData.reduce((s, d) => s + d.trips, 0) + '</td><td>' + truckData.reduce((s, d) => s + d.cars, 0) + '</td><td style="color:#22c55e">' + formatMoney(totalRevenue) + '</td><td style="color:#ef4444">' + formatMoney(totalDriverCut) + '</td><td style="color:#f59e0b">' + formatMoney(totalFuel) + '</td><td style="color:#64748b">' + formatMoney(totalOther) + '</td><td style="color:' + (totalProfit >= 0 ? '#22c55e' : '#ef4444') + '">' + formatMoney(totalProfit) + '</td><td>' + totalMargin.toFixed(1) + '%</td>' + (reportCompare ? '<td></td>' : '') + '</tr></tbody></table></div></div>' +
        (truckData.filter(d => d.margin < 15).length > 0 ? '<div style="margin-top:16px;padding:16px;background:#fef3c7;border-left:4px solid #f59e0b;border-radius:8px"><strong style="color:#92400e">âš ï¸ Low Margin Alert:</strong> <span style="color:#78350f">' + truckData.filter(d => d.margin < 15).map(d => d.truck.truck_number).join(', ') + ' ' + (truckData.filter(d => d.margin < 15).length === 1 ? 'has' : 'have') + ' margin below 15%. Review costs.</span></div>' : '');
    }

    function renderDriverPerformanceReport(trips, orders, prevTrips, prevOrders) {
      const drivers = appData.drivers || [];
      let totalTrips = 0, totalCars = 0, totalRevenue = 0, totalEarnings = 0;
      
      const driverData = drivers.map(driver => {
        const driverTrips = trips.filter(t => t.driver_id === driver.id);
        const driverOrders = orders.filter(o => driverTrips.some(t => t.id === o.trip_id));
        
        const revenue = driverOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
        const brokerFees = driverOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
        const localFees = driverOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
        const cleanGross = revenue - brokerFees - localFees;
        
        const earnings = driverTrips.reduce((sum, trip) => {
          const tripOrders = driverOrders.filter(o => o.trip_id === trip.id);
          const tripRevenue = tripOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
          const tripBroker = tripOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
          const tripLocal = tripOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
          const tripClean = tripRevenue - tripBroker - tripLocal;
          return sum + (tripClean * ((trip.driver_cut_percent || 32) / 100));
        }, 0);
        
        const cashCollected = driverOrders.filter(o => (o.payment_type === 'COD' || o.payment_type === 'COP') && o.driver_paid_status === 'PAID').reduce((s, o) => s + parseFloat(o.driver_paid_amount || o.revenue || 0), 0);
        const miles = driverTrips.reduce((s, t) => s + parseFloat(t.miles || 0), 0);
        const avgPerCar = driverOrders.length > 0 ? cleanGross / driverOrders.length : 0;
        
        let prevData = null;
        if (reportCompare && prevTrips.length > 0) {
          const prevDriverTrips = prevTrips.filter(t => t.driver_id === driver.id);
          prevData = { trips: prevDriverTrips.length };
        }
        
        totalTrips += driverTrips.length;
        totalCars += driverOrders.length;
        totalRevenue += cleanGross;
        totalEarnings += earnings;
        
        return { driver, trips: driverTrips.length, cars: driverOrders.length, revenue: cleanGross, earnings, cashCollected, miles, avgPerCar, avgCut: driverTrips.length > 0 ? driverTrips.reduce((s, t) => s + (t.driver_cut_percent || 32), 0) / driverTrips.length : 32, prevData };
      }).filter(d => d.trips > 0).sort((a, b) => b.revenue - a.revenue);
      
      return '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px"><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Total Trips</div><div style="font-size:28px;font-weight:700;color:#3b82f6">' + totalTrips + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Total Cars Hauled</div><div style="font-size:28px;font-weight:700;color:#8b5cf6">' + totalCars + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Revenue Generated</div><div style="font-size:28px;font-weight:700;color:#22c55e">' + formatMoney(totalRevenue) + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Driver Earnings</div><div style="font-size:28px;font-weight:700;color:#f59e0b">' + formatMoney(totalEarnings) + '</div></div></div>' +
        '<div class="card"><div class="card-header"><h3>ðŸ‘¨â€âœˆï¸ Driver Performance</h3></div><div class="table-wrapper"><table><thead><tr><th>Driver</th><th>Trips</th><th>Cars</th><th>Miles</th><th>Revenue</th><th>Avg $/Car</th><th>Cut %</th><th>Earnings</th><th>Cash Collected</th>' + (reportCompare ? '<th>vs Prev</th>' : '') + '</tr></thead><tbody>' +
        driverData.map((d, i) => '<tr><td><div style="display:flex;align-items:center;gap:8px">' + (i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : 'ðŸ‘¨â€âœˆï¸') + '<div><strong>' + d.driver.first_name + ' ' + d.driver.last_name + '</strong><div style="font-size:11px;color:var(--text-muted)">' + (d.driver.phone || '') + '</div></div></div></td><td><span style="font-weight:600">' + d.trips + '</span></td><td>' + d.cars + '</td><td>' + d.miles.toLocaleString() + '</td><td style="color:#22c55e;font-weight:600">' + formatMoney(d.revenue) + '</td><td>' + formatMoney(d.avgPerCar) + '</td><td><span style="color:#3b82f6;font-weight:600">' + d.avgCut.toFixed(0) + '%</span></td><td style="color:#f59e0b;font-weight:700">' + formatMoney(d.earnings) + '</td><td style="color:#8b5cf6">' + formatMoney(d.cashCollected) + '</td>' + (reportCompare ? '<td>' + (d.prevData ? '<span style="color:' + (d.trips >= d.prevData.trips ? '#22c55e' : '#ef4444') + '">' + (d.trips >= d.prevData.trips ? 'â†‘' : 'â†“') + ' ' + Math.abs(d.trips - d.prevData.trips) + ' trips</span>' : '-') + '</td>' : '') + '</tr>').join('') +
        '</tbody></table></div></div>' +
        '<div class="card" style="margin-top:16px"><div class="card-header"><h3>ðŸ’¡ Performance Insights</h3></div><div style="padding:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px"><div style="background:var(--bg-darker);padding:16px;border-radius:8px"><div style="font-size:13px;color:var(--text-muted);margin-bottom:8px">Top Performer</div><div style="font-size:18px;font-weight:700">ðŸ† ' + (driverData[0]?.driver.first_name || 'N/A') + ' ' + (driverData[0]?.driver.last_name || '') + '</div><div style="font-size:12px;color:#22c55e">' + formatMoney(driverData[0]?.revenue || 0) + ' revenue</div></div><div style="background:var(--bg-darker);padding:16px;border-radius:8px"><div style="font-size:13px;color:var(--text-muted);margin-bottom:8px">Most Cars Hauled</div><div style="font-size:18px;font-weight:700">ðŸ“¦ ' + ([...driverData].sort((a,b) => b.cars - a.cars)[0]?.driver.first_name || 'N/A') + '</div><div style="font-size:12px;color:#3b82f6">' + ([...driverData].sort((a,b) => b.cars - a.cars)[0]?.cars || 0) + ' cars</div></div><div style="background:var(--bg-darker);padding:16px;border-radius:8px"><div style="font-size:13px;color:var(--text-muted);margin-bottom:8px">Highest $/Car</div><div style="font-size:18px;font-weight:700">ðŸ’° ' + ([...driverData].sort((a,b) => b.avgPerCar - a.avgPerCar)[0]?.driver.first_name || 'N/A') + '</div><div style="font-size:12px;color:#f59e0b">' + formatMoney([...driverData].sort((a,b) => b.avgPerCar - a.avgPerCar)[0]?.avgPerCar || 0) + '/car</div></div><div style="background:var(--bg-darker);padding:16px;border-radius:8px"><div style="font-size:13px;color:var(--text-muted);margin-bottom:8px">Most Miles</div><div style="font-size:18px;font-weight:700">ðŸ›£ï¸ ' + ([...driverData].sort((a,b) => b.miles - a.miles)[0]?.driver.first_name || 'N/A') + '</div><div style="font-size:12px;color:#8b5cf6">' + ([...driverData].sort((a,b) => b.miles - a.miles)[0]?.miles || 0).toLocaleString() + ' miles</div></div></div></div>';
    }

    function renderLaneAnalysisReport(trips, orders, prevTrips, prevOrders) {
      const laneMap = new Map();
      
      trips.forEach(trip => {
        if (!trip.origin || !trip.destination) return;
        const originState = extractReportState(trip.origin);
        const destState = extractReportState(trip.destination);
        const laneKey = originState + ' â†’ ' + destState;
        
        const tripOrders = orders.filter(o => o.trip_id === trip.id);
        const revenue = tripOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
        const brokerFees = tripOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
        const localFees = tripOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
        const cleanGross = revenue - brokerFees - localFees;
        const miles = parseFloat(trip.miles || 0);
        
        if (!laneMap.has(laneKey)) {
          laneMap.set(laneKey, { lane: laneKey, origin: originState, destination: destState, trips: 0, cars: 0, revenue: 0, miles: 0, brokerFees: 0 });
        }
        
        const lane = laneMap.get(laneKey);
        lane.trips++;
        lane.cars += tripOrders.length;
        lane.revenue += cleanGross;
        lane.miles += miles;
        lane.brokerFees += brokerFees;
      });
      
      const laneData = Array.from(laneMap.values()).map(lane => ({
        ...lane,
        revenuePerMile: lane.miles > 0 ? lane.revenue / lane.miles : 0,
        avgPerCar: lane.cars > 0 ? lane.revenue / lane.cars : 0,
        avgBrokerFee: lane.revenue > 0 ? (lane.brokerFees / (lane.revenue + lane.brokerFees)) * 100 : 0
      })).sort((a, b) => b.revenue - a.revenue);
      
      const totalRevenue = laneData.reduce((s, l) => s + l.revenue, 0);
      const totalMiles = laneData.reduce((s, l) => s + l.miles, 0);
      const avgRevenuePerMile = totalMiles > 0 ? totalRevenue / totalMiles : 0;
      
      const backhaulOpportunities = [];
      laneData.forEach(lane => {
        const reverseLane = laneData.find(l => l.origin === lane.destination && l.destination === lane.origin);
        if (reverseLane && lane.trips > reverseLane.trips) {
          backhaulOpportunities.push({ from: lane.destination, to: lane.origin, currentTrips: reverseLane.trips, potentialTrips: lane.trips - reverseLane.trips, avgRevenue: reverseLane.avgPerCar });
        }
      });
      
      return '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px"><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Active Lanes</div><div style="font-size:28px;font-weight:700;color:#3b82f6">' + laneData.length + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Total Revenue</div><div style="font-size:28px;font-weight:700;color:#22c55e">' + formatMoney(totalRevenue) + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Total Miles</div><div style="font-size:28px;font-weight:700;color:#8b5cf6">' + totalMiles.toLocaleString() + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Avg $/Mile</div><div style="font-size:28px;font-weight:700;color:' + (avgRevenuePerMile >= 2 ? '#22c55e' : '#f59e0b') + '">' + formatMoney(avgRevenuePerMile) + '</div></div></div>' +
        '<div class="card"><div class="card-header"><h3>ðŸ›£ï¸ Lane Performance</h3></div><div class="table-wrapper"><table><thead><tr><th>Lane</th><th>Trips</th><th>Cars</th><th>Miles</th><th>Revenue</th><th>$/Mile</th><th>$/Car</th><th>Broker Fee %</th><th>% of Total</th></tr></thead><tbody>' +
        laneData.slice(0, 15).map((lane, i) => '<tr><td><div style="display:flex;align-items:center;gap:8px">' + (i === 0 ? 'ðŸ¥‡' : i === 1 ? 'ðŸ¥ˆ' : i === 2 ? 'ðŸ¥‰' : 'ðŸ›£ï¸') + '<strong>' + lane.lane + '</strong></div></td><td>' + lane.trips + '</td><td>' + lane.cars + '</td><td>' + lane.miles.toLocaleString() + '</td><td style="color:#22c55e;font-weight:600">' + formatMoney(lane.revenue) + '</td><td><span style="padding:4px 8px;border-radius:12px;font-size:12px;font-weight:600;background:' + (lane.revenuePerMile >= 2.5 ? '#dcfce7' : lane.revenuePerMile >= 1.5 ? '#fef3c7' : '#fee2e2') + ';color:' + (lane.revenuePerMile >= 2.5 ? '#166534' : lane.revenuePerMile >= 1.5 ? '#92400e' : '#dc2626') + '">' + formatMoney(lane.revenuePerMile) + '</span></td><td>' + formatMoney(lane.avgPerCar) + '</td><td style="color:' + (lane.avgBrokerFee <= 5 ? '#22c55e' : lane.avgBrokerFee <= 10 ? '#f59e0b' : '#ef4444') + '">' + lane.avgBrokerFee.toFixed(1) + '%</td><td><div style="display:flex;align-items:center;gap:8px"><div style="width:60px;height:8px;background:var(--bg-darker);border-radius:4px;overflow:hidden"><div style="width:' + ((lane.revenue / totalRevenue) * 100) + '%;height:100%;background:#3b82f6"></div></div><span style="font-size:12px">' + ((lane.revenue / totalRevenue) * 100).toFixed(1) + '%</span></div></td></tr>').join('') +
        '</tbody></table></div></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px"><div class="card"><div class="card-header"><h3>ðŸ’° Best $/Mile Lanes</h3></div><div style="padding:16px">' + [...laneData].sort((a, b) => b.revenuePerMile - a.revenuePerMile).slice(0, 5).map((lane, i) => '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-darker);border-radius:8px;margin-bottom:8px"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:16px">' + ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰','4ï¸âƒ£','5ï¸âƒ£'][i] + '</span><span style="font-weight:600">' + lane.lane + '</span></div><span style="color:#22c55e;font-weight:700">' + formatMoney(lane.revenuePerMile) + '/mi</span></div>').join('') + '</div></div>' +
        '<div class="card"><div class="card-header"><h3>ðŸ”„ Backhaul Opportunities</h3></div><div style="padding:16px">' + (backhaulOpportunities.length > 0 ? backhaulOpportunities.slice(0, 5).map(bh => '<div style="padding:12px;background:var(--bg-darker);border-radius:8px;margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-weight:600">' + bh.from + ' â†’ ' + bh.to + '</span><span style="color:#f59e0b;font-size:12px">+' + bh.potentialTrips + ' potential</span></div><div style="font-size:12px;color:var(--text-muted);margin-top:4px">Current: ' + bh.currentTrips + ' trips â€¢ Avg ' + formatMoney(bh.avgRevenue) + '/car</div></div>').join('') : '<div style="color:var(--text-muted);text-align:center;padding:20px">No clear backhaul opportunities detected</div>') + '</div></div></div>' +
        ([...laneData].filter(l => l.revenuePerMile < 1.5 && l.trips >= 2).length > 0 ? '<div style="margin-top:16px;padding:16px;background:#fee2e2;border-left:4px solid #ef4444;border-radius:8px"><strong style="color:#dc2626">âš ï¸ Low $/Mile Lanes:</strong> <span style="color:#7f1d1d">' + [...laneData].filter(l => l.revenuePerMile < 1.5 && l.trips >= 2).map(l => l.lane + ' (' + formatMoney(l.revenuePerMile) + '/mi)').join(', ') + ' - Consider negotiating better rates or avoiding these lanes.</span></div>' : '');
    }

    function extractReportState(location) {
      if (!location) return 'Unknown';
      const stateMatch = location.match(/,\s*([A-Z]{2})(?:\s|$|,)/);
      if (stateMatch) return stateMatch[1];
      const stateNames = { 'California': 'CA', 'Florida': 'FL', 'Texas': 'TX', 'Arizona': 'AZ', 'Nevada': 'NV', 'Pennsylvania': 'PA', 'New York': 'NY', 'Georgia': 'GA', 'Illinois': 'IL', 'Ohio': 'OH', 'Michigan': 'MI', 'New Jersey': 'NJ', 'Colorado': 'CO', 'Washington': 'WA', 'Oregon': 'OR', 'North Carolina': 'NC', 'South Carolina': 'SC', 'Virginia': 'VA', 'Maryland': 'MD', 'Tennessee': 'TN', 'Indiana': 'IN', 'Missouri': 'MO', 'Minnesota': 'MN', 'Wisconsin': 'WI', 'Alabama': 'AL', 'Louisiana': 'LA', 'Kentucky': 'KY', 'Oklahoma': 'OK', 'Connecticut': 'CT', 'Utah': 'UT', 'Iowa': 'IA', 'Arkansas': 'AR', 'Mississippi': 'MS', 'Kansas': 'KS', 'New Mexico': 'NM', 'Nebraska': 'NE', 'Idaho': 'ID', 'West Virginia': 'WV', 'Hawaii': 'HI', 'Maine': 'ME', 'New Hampshire': 'NH', 'Montana': 'MT', 'Rhode Island': 'RI', 'Delaware': 'DE', 'South Dakota': 'SD', 'North Dakota': 'ND', 'Alaska': 'AK', 'Vermont': 'VT', 'Wyoming': 'WY' };
      for (const [name, abbr] of Object.entries(stateNames)) {
        if (location.includes(name)) return abbr;
      }
      return location.split(',')[0].substring(0, 10);
    }

    function exportReportCSV() {
      const filteredTrips = filterReportTripsByPeriod(appData.trips);
      const filteredOrders = appData.orders.filter(o => {
        const trip = appData.trips.find(t => t.id === o.trip_id);
        return trip && filteredTrips.includes(trip);
      });
      
      let csv = '';
      let filename = '';
      
      if (reportTab === 'truck_pl') {
        csv = 'Truck,Trips,Cars,Revenue,Driver Cut,Fuel,Other Costs,Net Profit,Margin %\n';
        filename = 'truck_pl_report';
        const trucks = appData.trucks.filter(t => t.status === 'ACTIVE');
        trucks.forEach(truck => {
          const truckTrips = filteredTrips.filter(t => t.truck_id === truck.id);
          const truckOrders = filteredOrders.filter(o => truckTrips.some(t => t.id === o.trip_id));
          const revenue = truckOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
          const brokerFees = truckOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
          const localFees = truckOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
          const cleanGross = revenue - brokerFees - localFees;
          csv += truck.truck_number + ',' + truckTrips.length + ',' + truckOrders.length + ',' + cleanGross.toFixed(2) + ',0,0,0,0,0\n';
        });
      } else if (reportTab === 'driver_performance') {
        csv = 'Driver,Trips,Cars,Miles,Revenue,Avg Per Car,Cut %,Earnings,Cash Collected\n';
        filename = 'driver_performance_report';
        (appData.drivers || []).forEach(driver => {
          const driverTrips = filteredTrips.filter(t => t.driver_id === driver.id);
          if (driverTrips.length === 0) return;
          const driverOrders = filteredOrders.filter(o => driverTrips.some(t => t.id === o.trip_id));
          const revenue = driverOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
          const miles = driverTrips.reduce((s, t) => s + parseFloat(t.miles || 0), 0);
          csv += driver.first_name + ' ' + driver.last_name + ',' + driverTrips.length + ',' + driverOrders.length + ',' + miles + ',' + revenue.toFixed(2) + ',0,32,0,0\n';
        });
      } else if (reportTab === 'lane_analysis') {
        csv = 'Lane,Trips,Cars,Miles,Revenue,Revenue Per Mile,Avg Per Car\n';
        filename = 'lane_analysis_report';
      }
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename + '_' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
      URL.revokeObjectURL(url);
      showToast('Report exported!');
    }

    // ============================================
    // AI FINANCIAL ADVISOR - ENHANCED (24 Features)
    // ============================================
    
    let aiAdvisorHistory = [];
    let aiAdvisorLoading = false;
    let aiAdvisorTab = 'chat';
    let aiGoals = JSON.parse(localStorage.getItem('ai_advisor_goals') || '[]');
    let aiAlerts = JSON.parse(localStorage.getItem('ai_advisor_alerts') || '{"profitMargin":15,"cashReserve":10000}');
    let scenarioData = { trucks: 0, drivers: 0, revenue: 0 };

    function renderAIAdvisor(c) {
      const apiKey = getApiKey();
      const hasApiKey = apiKey && apiKey.length > 10;
      const fs = getFinancialSummaryForAI();
      const alertsList = checkFinancialAlerts(fs);
      const tip = getDailyTip(fs);
      
      c.innerHTML = `
        <div class="header">
          <h2>ðŸ¤– AI Financial Advisor</h2>
          <div style="display:flex;gap:12px;align-items:center">
            <span style="font-size:13px;color:var(--text-muted)">Powered by Claude AI</span>
            ${hasApiKey ? '<span style="color:#22c55e;font-size:12px">âœ“ API Connected</span>' : '<span style="color:#ef4444;font-size:12px">âš ï¸ Add API Key in Settings</span>'}
          </div>
        </div>
        
        ${alertsList.length > 0 ? `
        <div style="margin-bottom:16px;padding:14px 16px;background:linear-gradient(135deg,#7f1d1d,#991b1b);border-radius:12px;border:1px solid #dc2626">
          <div style="display:flex;align-items:center;gap:10px;color:#fecaca">
            <span style="font-size:20px">ðŸš¨</span>
            <div>
              <div style="font-weight:600;color:#fee2e2">Financial Alerts</div>
              <div style="font-size:13px">${alertsList.join(' â€¢ ')}</div>
            </div>
          </div>
        </div>` : ''}
        
        <div style="margin-bottom:16px;padding:14px 16px;background:linear-gradient(135deg,#1e3a5f,#164e63);border-radius:12px;border:1px solid #0891b2">
          <div style="display:flex;align-items:center;gap:10px;color:#a5f3fc">
            <span style="font-size:20px">ðŸ’¡</span>
            <div>
              <div style="font-weight:600;color:#cffafe">Daily Tip</div>
              <div style="font-size:13px">${tip}</div>
            </div>
          </div>
        </div>
        
        <div class="card" style="margin-bottom:20px;background:linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%);border:1px solid #334155">
          <div style="padding:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div style="font-size:13px;color:#94a3b8">ðŸ“Š Your Financial Snapshot</div>
              <button class="btn btn-secondary btn-sm" onclick="generateWeeklyDigest()">ðŸ“§ Weekly Digest</button>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px">
              <div style="background:rgba(0,0,0,0.2);padding:12px;border-radius:8px">
                <div style="font-size:11px;color:#64748b">Monthly Revenue</div>
                <div style="font-size:18px;font-weight:700;color:#22c55e">${formatMoney(fs.monthlyRevenue)}</div>
              </div>
              <div style="background:rgba(0,0,0,0.2);padding:12px;border-radius:8px">
                <div style="font-size:11px;color:#64748b">Monthly Profit</div>
                <div style="font-size:18px;font-weight:700;color:${fs.monthlyProfit >= 0 ? '#22c55e' : '#ef4444'}">${formatMoney(fs.monthlyProfit)}</div>
              </div>
              <div style="background:rgba(0,0,0,0.2);padding:12px;border-radius:8px">
                <div style="font-size:11px;color:#64748b">Active Trucks</div>
                <div style="font-size:18px;font-weight:700;color:#3b82f6">${fs.activeTrucks}</div>
              </div>
              <div style="background:rgba(0,0,0,0.2);padding:12px;border-radius:8px">
                <div style="font-size:11px;color:#64748b">Profit/Truck</div>
                <div style="font-size:18px;font-weight:700;color:#f59e0b">${formatMoney(fs.profitPerTruck)}</div>
              </div>
              <div style="background:rgba(0,0,0,0.2);padding:12px;border-radius:8px">
                <div style="font-size:11px;color:#64748b">Cash on Hand</div>
                <div style="font-size:18px;font-weight:700;color:#8b5cf6">${formatMoney(fs.cashOnHand)}</div>
              </div>
              <div style="background:rgba(0,0,0,0.2);padding:12px;border-radius:8px">
                <div style="font-size:11px;color:#64748b">Profit Margin</div>
                <div style="font-size:18px;font-weight:700;color:${fs.profitMargin >= 25 ? '#22c55e' : fs.profitMargin >= 15 ? '#f59e0b' : '#ef4444'}">${fs.profitMargin.toFixed(1)}%</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Tab Navigation -->
        <div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap">
          <button class="btn ${aiAdvisorTab === 'chat' ? 'btn-primary' : 'btn-secondary'}" onclick="switchAITab('chat')">ðŸ’¬ Chat</button>
          <button class="btn ${aiAdvisorTab === 'tools' ? 'btn-primary' : 'btn-secondary'}" onclick="switchAITab('tools')">ðŸ› ï¸ Tools</button>
          <button class="btn ${aiAdvisorTab === 'scenario' ? 'btn-primary' : 'btn-secondary'}" onclick="switchAITab('scenario')">ðŸ“ˆ Scenario</button>
          <button class="btn ${aiAdvisorTab === 'goals' ? 'btn-primary' : 'btn-secondary'}" onclick="switchAITab('goals')">ðŸŽ¯ Goals</button>
          <button class="btn ${aiAdvisorTab === 'analysis' ? 'btn-primary' : 'btn-secondary'}" onclick="switchAITab('analysis')">ðŸ“Š Analysis</button>
          <button class="btn ${aiAdvisorTab === 'alerts' ? 'btn-primary' : 'btn-secondary'}" onclick="switchAITab('alerts')">ðŸ”” Alerts</button>
        </div>
        
        <div id="aiTabContent"></div>
        
        <style>
          .typing-dot { width:8px; height:8px; background:var(--text-muted); border-radius:50%; animation:typingBounce 1s infinite; display:inline-block; }
          @keyframes typingBounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-8px)} }
          .goal-card { background:var(--bg-darker); border-radius:12px; padding:16px; margin-bottom:12px; }
          .progress-bar { height:8px; background:var(--bg-card); border-radius:4px; overflow:hidden; }
          .progress-fill { height:100%; border-radius:4px; transition:width 0.3s; }
        </style>
      `;
      
      // Render active tab content
      const tabContent = document.getElementById('aiTabContent');
      if (aiAdvisorTab === 'chat') renderAIChatTab(tabContent, hasApiKey);
      else if (aiAdvisorTab === 'tools') renderAIToolsTab(tabContent, fs);
      else if (aiAdvisorTab === 'scenario') renderAIScenarioTab(tabContent, fs);
      else if (aiAdvisorTab === 'goals') renderAIGoalsTab(tabContent, fs);
      else if (aiAdvisorTab === 'analysis') renderAIAnalysisTab(tabContent, fs);
      else if (aiAdvisorTab === 'alerts') renderAIAlertsTab(tabContent);
    }
    
    function switchAITab(tab) {
      aiAdvisorTab = tab;
      renderAIAdvisor(document.getElementById('main-content'));
    }

    // Chat Tab
    function renderAIChatTab(c, hasApiKey) {
      c.innerHTML = `
        <div style="margin-bottom:16px">
          <div style="font-size:13px;color:var(--text-muted);margin-bottom:10px">ðŸ’¡ Quick questions:</div>
          <div style="display:flex;flex-wrap:wrap;gap:8px">
            <button class="btn btn-secondary" style="font-size:11px" onclick="askAIAdvisor('Can we afford to buy a new truck for $100,000?')">ðŸš› Afford $100K truck?</button>
            <button class="btn btn-secondary" style="font-size:11px" onclick="askAIAdvisor('Should we hire another driver?')">ðŸ‘¨â€âœˆï¸ Hire driver?</button>
            <button class="btn btn-secondary" style="font-size:11px" onclick="askAIAdvisor('What is our break-even point per truck?')">ðŸ“Š Break-even?</button>
            <button class="btn btn-secondary" style="font-size:11px" onclick="askAIAdvisor('How can we improve profitability?')">ðŸ’° Improve profits?</button>
            <button class="btn btn-secondary" style="font-size:11px" onclick="askAIAdvisor('Analyze our best and worst lanes')">ðŸ›£ï¸ Lane analysis</button>
            <button class="btn btn-secondary" style="font-size:11px" onclick="askAIAdvisor('Which broker is most profitable?')">ðŸ¤ Best broker?</button>
            <button class="btn btn-secondary" style="font-size:11px" onclick="askAIAdvisor('What are our biggest financial risks?')">âš ï¸ Risks?</button>
            <button class="btn btn-secondary" style="font-size:11px" onclick="askAIAdvisor('How much cash reserve should we have?')">ðŸ¦ Cash reserve?</button>
          </div>
        </div>
        
        <div class="card" style="display:flex;flex-direction:column;height:420px">
          <div class="card-header" style="border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
            <h3>ðŸ’¬ Chat with AI Advisor</h3>
            <div style="display:flex;gap:8px">
              <button class="btn btn-secondary btn-sm" onclick="exportAIChat()">ðŸ“„ Export</button>
              <button class="btn btn-secondary btn-sm" onclick="clearAIAdvisorHistory()">ðŸ—‘ï¸ Clear</button>
            </div>
          </div>
          
          <div id="aiAdvisorMessages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:16px">
            ${aiAdvisorHistory.length === 0 ? `
              <div style="text-align:center;color:var(--text-muted);padding:40px">
                <div style="font-size:48px;margin-bottom:16px">ðŸ¤–</div>
                <div style="font-size:16px;font-weight:600;margin-bottom:8px">AI Financial Advisor</div>
                <div style="font-size:13px">Ask me anything about your business finances.<br>I analyze your real data to give specific advice.</div>
              </div>
            ` : aiAdvisorHistory.map(msg => `
              <div style="display:flex;gap:12px;${msg.role === 'user' ? 'flex-direction:row-reverse' : ''}">
                <div style="width:36px;height:36px;border-radius:50%;background:${msg.role === 'user' ? '#3b82f6' : '#22c55e'};display:flex;align-items:center;justify-content:center;flex-shrink:0">
                  ${msg.role === 'user' ? 'ðŸ‘¤' : 'ðŸ¤–'}
                </div>
                <div style="max-width:80%;padding:12px 16px;border-radius:12px;background:${msg.role === 'user' ? '#3b82f6' : 'var(--bg-darker)'};color:${msg.role === 'user' ? 'white' : 'var(--text-primary)'}">
                  <div style="white-space:pre-wrap;font-size:14px;line-height:1.6">${formatAIMessage(msg.content)}</div>
                </div>
              </div>
            `).join('')}
            ${aiAdvisorLoading ? `
              <div style="display:flex;gap:12px">
                <div style="width:36px;height:36px;border-radius:50%;background:#22c55e;display:flex;align-items:center;justify-content:center;flex-shrink:0">ðŸ¤–</div>
                <div style="padding:12px 16px;border-radius:12px;background:var(--bg-darker)">
                  <span class="typing-dot"></span>
                  <span class="typing-dot" style="animation-delay:0.2s"></span>
                  <span class="typing-dot" style="animation-delay:0.4s"></span>
                </div>
              </div>
            ` : ''}
          </div>
          
          <div style="padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:12px">
            <button class="btn btn-secondary" onclick="startVoiceInput()" title="Voice input">ðŸŽ¤</button>
            <input type="text" id="aiAdvisorInput" placeholder="Ask about your finances..." style="flex:1;padding:12px 16px;border-radius:8px;border:1px solid var(--border);background:var(--bg-darker);color:var(--text-primary);font-size:14px" onkeypress="if(event.key==='Enter')sendAIAdvisorMessage()">
            <button class="btn btn-primary" onclick="sendAIAdvisorMessage()" ${!hasApiKey ? 'disabled' : ''}>Send â†’</button>
          </div>
        </div>
      `;
      setTimeout(() => { const m = document.getElementById('aiAdvisorMessages'); if(m) m.scrollTop = m.scrollHeight; }, 100);
    }

    function getFinancialSummaryForAI() {
      const now = new Date();
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      
      const monthlyTrips = appData.trips.filter(t => {
        if (!t.trip_date) return false;
        const d = new Date(t.trip_date);
        return d >= startOfMonth && d <= endOfMonth;
      });
      
      const monthlyOrders = appData.orders.filter(o => monthlyTrips.some(t => t.id === o.trip_id));
      const grossRevenue = monthlyOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
      const brokerFees = monthlyOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
      const localFees = monthlyOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
      const monthlyRevenue = grossRevenue - brokerFees - localFees;
      
      const driverCuts = monthlyTrips.reduce((sum, trip) => {
        const tripOrders = monthlyOrders.filter(o => o.trip_id === trip.id);
        const tripRevenue = tripOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
        const tripBroker = tripOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
        const tripLocal = tripOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
        const tripClean = tripRevenue - tripBroker - tripLocal;
        return sum + (tripClean * ((trip.driver_cut_percent || 32) / 100));
      }, 0);
      
      const tripIds = monthlyTrips.map(t => t.id);
      const monthlyExpenses = (appData.expenses || []).filter(e => tripIds.includes(e.trip_id)).reduce((s, e) => s + parseFloat(e.amount || 0), 0);
      const monthlyFixedCosts = (appData.fixed_costs || []).reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);
      const activeTrucks = appData.trucks.filter(t => t.status === 'ACTIVE').length;
      const monthlyProfit = monthlyRevenue - driverCuts - monthlyExpenses - monthlyFixedCosts;
      const profitPerTruck = activeTrucks > 0 ? monthlyProfit / activeTrucks : 0;
      const cashCollected = monthlyOrders.filter(o => o.driver_paid_status === 'PAID').reduce((s, o) => s + parseFloat(o.driver_paid_amount || 0), 0);
      const outstanding = monthlyOrders.filter(o => o.driver_paid_status !== 'PAID' && (o.payment_type === 'COD' || o.payment_type === 'COP')).reduce((s, o) => s + parseFloat(o.revenue || 0), 0);

      return {
        monthlyRevenue, monthlyProfit, activeTrucks, profitPerTruck,
        cashOnHand: cashCollected, monthlyFixedCosts, driverCuts, monthlyExpenses,
        totalTrips: monthlyTrips.length, totalCars: monthlyOrders.length, outstanding,
        avgRevenuePerCar: monthlyOrders.length > 0 ? monthlyRevenue / monthlyOrders.length : 0,
        avgTripsPerTruck: activeTrucks > 0 ? monthlyTrips.length / activeTrucks : 0,
        drivers: appData.drivers?.length || 0,
        brokerFeePercent: grossRevenue > 0 ? (brokerFees / grossRevenue) * 100 : 0,
        profitMargin: monthlyRevenue > 0 ? (monthlyProfit / monthlyRevenue) * 100 : 0
      };
    }

    // Tools Tab
    function renderAIToolsTab(c, fs) {
      const breakEven = fs.monthlyFixedCosts / Math.max(fs.activeTrucks, 1) / ((100 - 32 - fs.brokerFeePercent) / 100);
      const carsNeeded = fs.avgRevenuePerCar > 0 ? Math.ceil(breakEven / fs.avgRevenuePerCar) : 0;
      
      c.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px">
          <div class="card">
            <div class="card-header"><h3>ðŸ“Š Break-Even Calculator</h3></div>
            <div style="padding:16px">
              <div style="background:var(--bg-darker);padding:16px;border-radius:8px;margin-bottom:16px">
                <div style="font-size:12px;color:var(--text-muted)">Break-Even per Truck/Month</div>
                <div style="font-size:28px;font-weight:700;color:#f59e0b">${formatMoney(breakEven)}</div>
                <div style="font-size:12px;color:var(--text-muted);margin-top:8px">= ${carsNeeded} cars at ${formatMoney(fs.avgRevenuePerCar)}/car</div>
              </div>
              <div style="font-size:13px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <div>Fixed/Truck: <strong>${formatMoney(fs.monthlyFixedCosts / Math.max(fs.activeTrucks, 1))}</strong></div>
                <div>Status: <strong style="color:${fs.monthlyRevenue > breakEven * fs.activeTrucks ? '#22c55e' : '#ef4444'}">${fs.monthlyRevenue > breakEven * fs.activeTrucks ? 'âœ… Above' : 'âš ï¸ Below'}</strong></div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header"><h3>ðŸ’³ Loan Calculator</h3></div>
            <div style="padding:16px">
              <div class="form-group"><label>Loan Amount ($)</label><input type="number" id="loanAmt" value="100000" onchange="calcLoan()" style="width:100%"></div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                <div class="form-group"><label>Interest (%)</label><input type="number" id="loanRate" value="8" step="0.1" onchange="calcLoan()" style="width:100%"></div>
                <div class="form-group"><label>Term (mo)</label><input type="number" id="loanTerm" value="60" onchange="calcLoan()" style="width:100%"></div>
              </div>
              <div id="loanResult" style="background:var(--bg-darker);padding:16px;border-radius:8px;margin-top:12px">
                <div style="font-size:12px;color:var(--text-muted)">Monthly Payment</div>
                <div style="font-size:24px;font-weight:700;color:#3b82f6">$2,028</div>
                <div style="font-size:12px;margin-top:8px;color:${fs.monthlyProfit > 2028 ? '#22c55e' : '#ef4444'}">${fs.monthlyProfit > 2028 ? 'âœ… Affordable' : 'âš ï¸ Exceeds profit'}</div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header"><h3>ðŸš› New Truck ROI</h3></div>
            <div style="padding:16px">
              <div class="form-group"><label>Truck Cost ($)</label><input type="number" id="truckCost" value="100000" onchange="calcTruckROI()" style="width:100%"></div>
              <div id="truckROI" style="background:var(--bg-darker);padding:16px;border-radius:8px">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                  <div><div style="font-size:12px;color:var(--text-muted)">Est. Monthly Profit</div><div style="font-size:20px;font-weight:700;color:#22c55e">${formatMoney(fs.profitPerTruck)}</div></div>
                  <div><div style="font-size:12px;color:var(--text-muted)">Payback</div><div style="font-size:20px;font-weight:700;color:#3b82f6">${fs.profitPerTruck > 0 ? Math.ceil(100000 / fs.profitPerTruck) : 'âˆž'} mo</div></div>
                </div>
                <div style="margin-top:12px;font-size:12px;color:var(--text-muted)">ROI: <strong style="color:#f59e0b">${fs.profitPerTruck > 0 ? ((fs.profitPerTruck * 12 / 100000) * 100).toFixed(1) : 0}%</strong>/year</div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header"><h3>ðŸ“ˆ 6-Month Cash Forecast</h3></div>
            <div style="padding:16px">${renderCashForecast(fs)}</div>
          </div>
        </div>
      `;
      calcLoan();
    }
    
    function calcLoan() {
      const a = parseFloat(document.getElementById('loanAmt')?.value || 100000);
      const r = parseFloat(document.getElementById('loanRate')?.value || 8) / 100 / 12;
      const t = parseInt(document.getElementById('loanTerm')?.value || 60);
      const pmt = (a * r * Math.pow(1+r,t)) / (Math.pow(1+r,t) - 1);
      const fs = getFinancialSummaryForAI();
      const el = document.getElementById('loanResult');
      if (el) el.innerHTML = '<div style="font-size:12px;color:var(--text-muted)">Monthly Payment</div><div style="font-size:24px;font-weight:700;color:#3b82f6">' + formatMoney(pmt) + '</div><div style="font-size:12px;margin-top:8px;color:' + (fs.monthlyProfit > pmt ? '#22c55e' : '#ef4444') + '">' + (fs.monthlyProfit > pmt ? 'âœ… Affordable' : 'âš ï¸ Exceeds profit') + '</div>';
    }
    
    function calcTruckROI() {
      const cost = parseFloat(document.getElementById('truckCost')?.value || 100000);
      const fs = getFinancialSummaryForAI();
      const el = document.getElementById('truckROI');
      if (el) el.innerHTML = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div><div style="font-size:12px;color:var(--text-muted)">Est. Monthly Profit</div><div style="font-size:20px;font-weight:700;color:#22c55e">' + formatMoney(fs.profitPerTruck) + '</div></div><div><div style="font-size:12px;color:var(--text-muted)">Payback</div><div style="font-size:20px;font-weight:700;color:#3b82f6">' + (fs.profitPerTruck > 0 ? Math.ceil(cost / fs.profitPerTruck) : 'âˆž') + ' mo</div></div></div><div style="margin-top:12px;font-size:12px;color:var(--text-muted)">ROI: <strong style="color:#f59e0b">' + (fs.profitPerTruck > 0 ? ((fs.profitPerTruck * 12 / cost) * 100).toFixed(1) : 0) + '%</strong>/year</div>';
    }
    
    function renderCashForecast(fs) {
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const cm = new Date().getMonth();
      let cash = fs.cashOnHand;
      let html = '<div style="display:flex;gap:6px;align-items:flex-end;height:100px">';
      for (let i = 0; i < 6; i++) {
        cash += fs.monthlyProfit * (0.85 + Math.random() * 0.3);
        html += '<div style="flex:1;text-align:center"><div style="background:' + (cash >= 0 ? '#22c55e' : '#ef4444') + ';height:' + Math.min(Math.max(cash/500, 10), 70) + 'px;border-radius:4px 4px 0 0"></div><div style="font-size:9px;color:var(--text-muted);margin-top:4px">' + months[(cm+i)%12] + '</div></div>';
      }
      html += '</div><div style="margin-top:12px;font-size:12px;color:var(--text-muted)">Projected: <strong style="color:#22c55e">' + formatMoney(cash) + '</strong></div>';
      return html;
    }

    // Scenario Tab
    function renderAIScenarioTab(c, fs) {
      const addTrucks = scenarioData.trucks || 0;
      const addDrivers = scenarioData.drivers || 0;
      const revChange = scenarioData.revenue || 0;
      
      const avgRevPerTruck = fs.activeTrucks > 0 ? fs.monthlyRevenue / fs.activeTrucks : 0;
      const newRevenue = (fs.monthlyRevenue + addTrucks * avgRevPerTruck) * (1 + revChange/100);
      const addedCosts = addTrucks * (fs.monthlyFixedCosts / Math.max(fs.activeTrucks,1)) * 0.8 + addDrivers * 4000;
      const newProfit = newRevenue - (fs.monthlyRevenue - fs.monthlyProfit) - addedCosts;
      const profitDiff = newProfit - fs.monthlyProfit;
      
      c.innerHTML = `
        <div class="card">
          <div class="card-header"><h3>ðŸ“ˆ What-If Scenario Planner</h3></div>
          <div style="padding:20px">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px">
              <div class="form-group"><label>Add Trucks</label><input type="number" value="${addTrucks}" min="0" max="10" onchange="scenarioData.trucks=+this.value;switchAITab('scenario')" style="width:100%"></div>
              <div class="form-group"><label>Add Drivers</label><input type="number" value="${addDrivers}" min="0" max="10" onchange="scenarioData.drivers=+this.value;switchAITab('scenario')" style="width:100%"></div>
              <div class="form-group"><label>Revenue Change (%)</label><input type="number" value="${revChange}" min="-50" max="100" onchange="scenarioData.revenue=+this.value;switchAITab('scenario')" style="width:100%"></div>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
              <div style="background:var(--bg-darker);padding:20px;border-radius:12px">
                <div style="font-weight:600;color:var(--text-muted);margin-bottom:16px">ðŸ“Š Current</div>
                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span>Trucks</span><strong>${fs.activeTrucks}</strong></div>
                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span>Revenue</span><strong style="color:#22c55e">${formatMoney(fs.monthlyRevenue)}</strong></div>
                <div style="display:flex;justify-content:space-between;padding:8px 0"><span>Profit</span><strong style="color:${fs.monthlyProfit >= 0 ? '#22c55e' : '#ef4444'}">${formatMoney(fs.monthlyProfit)}</strong></div>
              </div>
              <div style="background:linear-gradient(135deg,#1e3a5f,#164e63);padding:20px;border-radius:12px;border:2px solid #0891b2">
                <div style="font-weight:600;color:#67e8f9;margin-bottom:16px">ðŸ”® Projected</div>
                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);color:#e0f2fe"><span>Trucks</span><strong>${fs.activeTrucks + addTrucks}</strong></div>
                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);color:#e0f2fe"><span>Revenue</span><strong style="color:#4ade80">${formatMoney(newRevenue)}</strong></div>
                <div style="display:flex;justify-content:space-between;padding:8px 0;color:#e0f2fe"><span>Profit</span><strong style="color:${newProfit >= 0 ? '#4ade80' : '#f87171'}">${formatMoney(newProfit)}</strong></div>
              </div>
            </div>
            
            <div style="margin-top:20px;padding:16px;background:${profitDiff >= 0 ? '#dcfce7' : '#fee2e2'};border-radius:8px">
              <div style="font-weight:600;color:${profitDiff >= 0 ? '#166534' : '#991b1b'}">${profitDiff >= 0 ? 'ðŸ“ˆ Positive Impact' : 'ðŸ“‰ Negative Impact'}</div>
              <div style="font-size:13px;color:${profitDiff >= 0 ? '#15803d' : '#b91c1c'}">Profit change: <strong>${formatMoney(profitDiff)}</strong>/month</div>
            </div>
            
            <button class="btn btn-primary" style="margin-top:16px" onclick="askAIAdvisor('Analyze scenario: adding ${addTrucks} trucks, ${addDrivers} drivers, ${revChange}% revenue change. Good idea?')">ðŸ¤– Get AI Analysis</button>
          </div>
        </div>
      `;
    }

    // Goals Tab
    function renderAIGoalsTab(c, fs) {
      c.innerHTML = `
        <div class="card">
          <div class="card-header"><h3>ðŸŽ¯ Financial Goals</h3><button class="btn btn-primary btn-sm" onclick="openGoalModal()">+ Add Goal</button></div>
          <div style="padding:16px">
            ${aiGoals.length === 0 ? '<div style="text-align:center;padding:40px;color:var(--text-muted)"><div style="font-size:48px;margin-bottom:16px">ðŸŽ¯</div><div>No goals yet. Add your first financial goal!</div></div>' : aiGoals.map((g, i) => {
              let current = 0;
              if (g.type === 'revenue') current = fs.monthlyRevenue;
              else if (g.type === 'profit') current = fs.monthlyProfit;
              else if (g.type === 'savings') current = fs.cashOnHand;
              else if (g.type === 'trucks') current = fs.activeTrucks;
              else if (g.type === 'margin') current = fs.profitMargin;
              const pct = g.target > 0 ? Math.min((current / g.target) * 100, 100) : 0;
              return '<div class="goal-card"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px"><div><div style="font-weight:600">' + (g.icon||'ðŸŽ¯') + ' ' + g.name + '</div>' + (g.description ? '<div style="font-size:12px;color:var(--text-muted)">' + g.description + '</div>' : '') + '</div><button class="btn btn-secondary btn-sm" onclick="deleteGoal(' + i + ')">Ã—</button></div><div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:8px"><span>' + formatMoney(current) + ' / ' + formatMoney(g.target) + '</span><span style="color:' + (pct >= 100 ? '#22c55e' : pct >= 50 ? '#f59e0b' : '#64748b') + '">' + pct.toFixed(0) + '%</span></div><div class="progress-bar"><div class="progress-fill" style="width:' + pct + '%;background:' + (pct >= 100 ? '#22c55e' : pct >= 50 ? '#f59e0b' : '#3b82f6') + '"></div></div>' + (pct >= 100 ? '<div style="margin-top:8px;font-size:12px;color:#22c55e">ðŸŽ‰ Goal achieved!</div>' : '') + '</div>';
            }).join('')}
          </div>
        </div>
      `;
    }
    
    function openGoalModal() {
      const m = document.createElement('div');
      m.className = 'modal-overlay';
      m.innerHTML = '<div class="modal" style="max-width:400px"><div class="modal-header"><h3>ðŸŽ¯ Add Goal</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">Ã—</button></div><div class="modal-body"><div class="form-group"><label>Goal Name</label><input type="text" id="goalName" placeholder="Save for new truck"></div><div class="form-group"><label>Type</label><select id="goalType"><option value="savings">ðŸ’° Savings</option><option value="revenue">ðŸ“ˆ Revenue</option><option value="profit">ðŸ’µ Profit</option><option value="margin">ðŸ“Š Margin %</option><option value="trucks">ðŸš› Trucks</option></select></div><div class="form-group"><label>Target</label><input type="number" id="goalTarget" placeholder="50000"></div><div class="form-group"><label>Description</label><input type="text" id="goalDesc" placeholder="Optional"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveGoal()">Save</button></div></div>';
      document.body.appendChild(m);
    }
    
    function saveGoal() {
      const name = document.getElementById('goalName').value;
      const type = document.getElementById('goalType').value;
      const target = parseFloat(document.getElementById('goalTarget').value);
      const desc = document.getElementById('goalDesc').value;
      if (!name || !target) { showToast('Fill name and target', 'error'); return; }
      const icons = {savings:'ðŸ’°',revenue:'ðŸ“ˆ',profit:'ðŸ’µ',margin:'ðŸ“Š',trucks:'ðŸš›'};
      aiGoals.push({name, type, target, description: desc, icon: icons[type]});
      localStorage.setItem('ai_advisor_goals', JSON.stringify(aiGoals));
      document.querySelector('.modal-overlay').remove();
      switchAITab('goals');
      showToast('Goal added!');
    }
    
    function deleteGoal(i) {
      if (!confirm('Delete this goal?')) return;
      aiGoals.splice(i, 1);
      localStorage.setItem('ai_advisor_goals', JSON.stringify(aiGoals));
      switchAITab('goals');
    }

    // Analysis Tab
    function renderAIAnalysisTab(c, fs) {
      const brokers = analyzeBrokersForAI();
      const lanes = analyzeLanesForAI();
      const risks = analyzeRisksForAI(fs);
      
      c.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:16px">
          <div class="card">
            <div class="card-header"><h3>ðŸ¤ Broker Scorecard</h3></div>
            <div style="padding:16px">
              ${brokers.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:20px">No broker data</div>' : '<table style="width:100%;font-size:13px"><thead><tr style="border-bottom:2px solid var(--border)"><th style="text-align:left;padding:8px">Broker</th><th style="text-align:right;padding:8px">Revenue</th><th style="text-align:right;padding:8px">Fee %</th></tr></thead><tbody>' + brokers.slice(0,5).map((b,i) => '<tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">' + (i===0?'ðŸ¥‡':i===1?'ðŸ¥ˆ':i===2?'ðŸ¥‰':'') + ' ' + escapeHtml(b.name) + '</td><td style="text-align:right;padding:8px;color:#22c55e">' + formatMoney(b.revenue) + '</td><td style="text-align:right;padding:8px;color:' + (b.feeRate<=5?'#22c55e':b.feeRate<=10?'#f59e0b':'#ef4444') + '">' + b.feeRate.toFixed(1) + '%</td></tr>').join('') + '</tbody></table>'}
            </div>
          </div>
          
          <div class="card">
            <div class="card-header"><h3>ðŸ›£ï¸ Lane Optimizer</h3></div>
            <div style="padding:16px">
              <div style="margin-bottom:16px"><div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">âœ… Best Lanes</div>${lanes.best.slice(0,3).map(l => '<div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-darker);border-radius:6px;margin-bottom:6px"><span>' + escapeHtml(l.lane) + '</span><span style="color:#22c55e;font-weight:600">' + formatMoney(l.rpm) + '/mi</span></div>').join('')}</div>
              <div><div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">âš ï¸ Avoid</div>${lanes.worst.slice(0,3).map(l => '<div style="display:flex;justify-content:space-between;padding:8px;background:#fee2e2;border-radius:6px;margin-bottom:6px"><span style="color:#991b1b">' + escapeHtml(l.lane) + '</span><span style="color:#dc2626;font-weight:600">' + formatMoney(l.rpm) + '/mi</span></div>').join('')}</div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header"><h3>âš ï¸ Risk Analysis</h3></div>
            <div style="padding:16px">
              ${risks.length === 0 ? '<div style="background:#dcfce7;padding:16px;border-radius:8px;text-align:center"><div style="font-size:24px">âœ…</div><div style="color:#166534;font-weight:600">No major risks</div></div>' : risks.map(r => '<div style="display:flex;gap:12px;padding:12px;background:' + (r.high?'#fee2e2':'#fef3c7') + ';border-radius:8px;margin-bottom:8px"><span style="font-size:20px">' + (r.high?'ðŸš¨':'âš ï¸') + '</span><div><div style="font-weight:600;color:' + (r.high?'#991b1b':'#92400e') + '">' + r.title + '</div><div style="font-size:12px;color:' + (r.high?'#b91c1c':'#a16207') + '">' + r.desc + '</div></div></div>').join('')}
            </div>
          </div>
        </div>
      `;
    }
    
    function analyzeBrokersForAI() {
      const data = {};
      appData.orders.forEach(o => {
        const broker = appData.brokers?.find(b => b.id === o.broker_id);
        const name = broker?.name || 'Unknown';
        if (!data[name]) data[name] = {name, revenue: 0, fees: 0};
        data[name].revenue += parseFloat(o.revenue || 0);
        data[name].fees += parseFloat(o.broker_fee || 0);
      });
      return Object.values(data).map(b => ({...b, feeRate: b.revenue > 0 ? (b.fees/b.revenue)*100 : 0})).sort((a,b) => b.revenue - a.revenue);
    }
    
    function analyzeLanesForAI() {
      const data = new Map();
      appData.trips.forEach(t => {
        if (!t.origin || !t.destination) return;
        const key = extractReportState(t.origin) + 'â†’' + extractReportState(t.destination);
        const orders = appData.orders.filter(o => o.trip_id === t.id);
        const rev = orders.reduce((s,o) => s + parseFloat(o.revenue||0), 0);
        const mi = parseFloat(t.miles||0);
        if (!data.has(key)) data.set(key, {lane:key, revenue:0, miles:0, trips:0});
        const l = data.get(key);
        l.revenue += rev; l.miles += mi; l.trips++;
      });
      const lanes = Array.from(data.values()).map(l => ({...l, rpm: l.miles > 0 ? l.revenue/l.miles : 0})).filter(l => l.trips >= 2);
      return { best: lanes.sort((a,b) => b.rpm - a.rpm), worst: lanes.sort((a,b) => a.rpm - b.rpm) };
    }
    
    function analyzeRisksForAI(fs) {
      const risks = [];
      if (fs.profitMargin < 10) risks.push({high:true, title:'Low Profit Margin', desc: fs.profitMargin.toFixed(1) + '% is dangerously low'});
      if (fs.cashOnHand < fs.monthlyFixedCosts) risks.push({high:true, title:'Low Cash Reserve', desc:'Less than 1 month of fixed costs'});
      if (fs.outstanding > fs.monthlyRevenue * 0.5) risks.push({high:false, title:'High Receivables', desc: formatMoney(fs.outstanding) + ' outstanding'});
      if (fs.activeTrucks <= 2) risks.push({high:false, title:'Concentration Risk', desc:'Only ' + fs.activeTrucks + ' trucks - one breakdown hurts'});
      return risks;
    }

    // Alerts Tab
    function renderAIAlertsTab(c) {
      c.innerHTML = `
        <div class="card">
          <div class="card-header"><h3>ðŸ”” Alert Configuration</h3></div>
          <div style="padding:20px">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px">
              <div class="form-group"><label>âš ï¸ Alert when profit margin below (%)</label><input type="number" value="${aiAlerts.profitMargin}" onchange="aiAlerts.profitMargin=+this.value;saveAIAlerts()" style="width:100%"></div>
              <div class="form-group"><label>ðŸ’° Alert when cash reserve below ($)</label><input type="number" value="${aiAlerts.cashReserve}" onchange="aiAlerts.cashReserve=+this.value;saveAIAlerts()" style="width:100%"></div>
            </div>
            <button class="btn btn-primary" style="margin-top:16px" onclick="showToast('Settings saved!')">Save Settings</button>
          </div>
        </div>
      `;
    }
    
    function saveAIAlerts() { localStorage.setItem('ai_advisor_alerts', JSON.stringify(aiAlerts)); }

    // Helper Functions
    function checkFinancialAlerts(fs) {
      const alerts = [];
      if (fs.profitMargin < aiAlerts.profitMargin) alerts.push('Profit margin ' + fs.profitMargin.toFixed(1) + '% below ' + aiAlerts.profitMargin + '%');
      if (fs.cashOnHand < aiAlerts.cashReserve) alerts.push('Cash ' + formatMoney(fs.cashOnHand) + ' below ' + formatMoney(aiAlerts.cashReserve));
      return alerts;
    }
    
    function getDailyTip(fs) {
      const tips = [
        fs.profitMargin < 20 ? 'Your margin is ' + fs.profitMargin.toFixed(1) + '%. Consider raising rates by $50-100/car.' : null,
        fs.avgTripsPerTruck < 2 ? 'Averaging ' + fs.avgTripsPerTruck.toFixed(1) + ' trips/truck. Target is 2+.' : null,
        fs.brokerFeePercent > 8 ? 'Broker fees at ' + fs.brokerFeePercent.toFixed(1) + '%. Negotiate lower rates.' : null,
        'A 5% rate increase would add ' + formatMoney(fs.monthlyRevenue * 0.05) + ' monthly.',
        fs.profitPerTruck > 3000 ? 'Great job! ' + formatMoney(fs.profitPerTruck) + '/truck profit.' : 'Profit/truck: ' + formatMoney(fs.profitPerTruck) + '. Room to improve.'
      ].filter(Boolean);
      return tips[new Date().getDate() % tips.length] || 'Keep up the great work!';
    }
    
    function formatAIMessage(text) {
      // First escape HTML to prevent XSS, then apply markdown-style formatting
      const escaped = escapeHtml(text);
      return escaped.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
    }
    
    function startVoiceInput() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showToast('Voice not supported', 'error'); return;
      }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const r = new SR();
      r.lang = 'en-US';
      r.onresult = e => { document.getElementById('aiAdvisorInput').value = e.results[0][0].transcript; showToast('Voice captured!'); };
      r.onerror = () => showToast('Voice failed', 'error');
      r.start();
      showToast('Listening...');
    }
    
    function exportAIChat() {
      if (aiAdvisorHistory.length === 0) { showToast('No chat to export', 'error'); return; }
      const txt = aiAdvisorHistory.map(m => (m.role === 'user' ? 'You' : 'AI') + ': ' + m.content).join('\n\n---\n\n');
      const blob = new Blob([txt], {type:'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ai_advisor_' + new Date().toISOString().split('T')[0] + '.txt';
      a.click();
      showToast('Chat exported!');
    }
    
    async function generateWeeklyDigest() {
      const apiKey = getApiKey();
      if (!apiKey) { showToast('Add API key first', 'error'); return; }
      showToast('Generating digest...');
      try {
        const ctx = getDetailedFinancialContext();
        const r = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
          body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 1500, system: 'Generate a concise weekly financial digest. Include: 1) Key metrics, 2) Wins, 3) Concerns, 4) Action items. Be specific.', messages: [{role:'user', content: ctx}] })
        });
        const d = await r.json();
        aiAdvisorHistory = [{role:'assistant', content:'ðŸ“§ **Weekly Digest**\n\n' + d.content[0].text}];
        switchAITab('chat');
      } catch(e) { showToast('Error: ' + e.message, 'error'); }
    }

    function getDetailedFinancialContext() {
      const s = getFinancialSummaryForAI();
      const fc = (appData.fixed_costs || []).map(f => f.name + ': $' + parseFloat(f.amount||0).toFixed(2)).join(', ');
      
      // Get truck performance
      const truckPerf = appData.trucks.filter(t => t.status === 'ACTIVE').map(truck => {
        const trips = appData.trips.filter(t => t.truck_id === truck.id);
        const orders = appData.orders.filter(o => trips.some(t => t.id === o.trip_id));
        return truck.truck_number + ': ' + trips.length + ' trips, $' + orders.reduce((sum,o) => sum + parseFloat(o.revenue||0), 0).toFixed(0);
      }).join('; ');
      
      // Get lane data
      const laneMap = new Map();
      appData.trips.forEach(trip => {
        if (!trip.origin || !trip.destination) return;
        const key = extractReportState(trip.origin) + ' to ' + extractReportState(trip.destination);
        const orders = appData.orders.filter(o => o.trip_id === trip.id);
        const rev = orders.reduce((sum,o) => sum + parseFloat(o.revenue||0), 0);
        if (!laneMap.has(key)) laneMap.set(key, {trips:0, revenue:0, miles:0});
        const l = laneMap.get(key);
        l.trips++; l.revenue += rev; l.miles += parseFloat(trip.miles||0);
      });
      const topLanes = Array.from(laneMap.entries()).map(([lane, d]) => lane + ': ' + d.trips + ' trips, $' + (d.miles>0 ? (d.revenue/d.miles).toFixed(2) : '0') + '/mi').slice(0,5).join('; ');
      
      return 'FINANCIAL DATA FOR HORIZON STAR LLC:\n\n' +
        'CURRENT MONTH: Revenue: $' + s.monthlyRevenue.toFixed(2) + ', Profit: $' + s.monthlyProfit.toFixed(2) + ', Margin: ' + s.profitMargin.toFixed(1) + '%, Trucks: ' + s.activeTrucks + ', Drivers: ' + s.drivers + ', Trips: ' + s.totalTrips + ', Cars: ' + s.totalCars + ', Avg/Car: $' + s.avgRevenuePerCar.toFixed(2) + ', Profit/Truck: $' + s.profitPerTruck.toFixed(2) + '\n\n' +
        'COSTS: Driver Cuts: $' + s.driverCuts.toFixed(2) + ', Expenses: $' + s.monthlyExpenses.toFixed(2) + ', Fixed: $' + s.monthlyFixedCosts.toFixed(2) + ' (' + fc + '), Broker Fees: ' + s.brokerFeePercent.toFixed(1) + '%\n\n' +
        'CASH: On Hand: $' + s.cashOnHand.toFixed(2) + ', Outstanding: $' + s.outstanding.toFixed(2) + '\n\n' +
        'TRUCKS: ' + truckPerf + '\n\n' +
        'TOP LANES: ' + topLanes + '\n\n' +
        'CONTEXT: Auto transport carrier between PA, CA, FL. Driver cut typically 32%. Target 2+ trips/truck/month. Healthy margin is 25%+.';
    }

    function askAIAdvisor(question) {
      document.getElementById('aiAdvisorInput').value = question;
      aiAdvisorTab = 'chat';
      renderAIAdvisor(document.getElementById('main-content'));
      setTimeout(sendAIAdvisorMessage, 100);
    }

    async function sendAIAdvisorMessage() {
      const input = document.getElementById('aiAdvisorInput');
      const question = input.value.trim();
      if (!question) return;
      
      const apiKey = getApiKey();
      if (!apiKey) {
        showToast('Please add your Anthropic API key in Settings first', 'error');
        return;
      }
      
      aiAdvisorHistory.push({ role: 'user', content: question });
      input.value = '';
      aiAdvisorLoading = true;
      renderAIAdvisor(document.getElementById('main-content'));
      
      try {
        const financialContext = getDetailedFinancialContext();
        
        const systemPrompt = 'You are an expert financial advisor for "Horizon Star LLC" auto transport company. You have access to their real financial data and should provide specific, actionable advice based on their actual numbers.\n\nWhen answering:\n1. Reference their specific numbers\n2. Provide concrete recommendations with calculations\n3. Be direct and practical\n4. Calculate ROI and payback for major purchases\n5. Consider cash flow implications\n6. Flag any risks\n7. Use simple language\n\nDATA:\n' + financialContext;

        const messages = aiAdvisorHistory.map(msg => ({
          role: msg.role === 'user' ? 'user' : 'assistant',
          content: msg.content
        }));

        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1024,
            system: systemPrompt,
            messages: messages
          })
        });

        if (!response.ok) {
          throw new Error('API error: ' + response.status);
        }

        const data = await response.json();
        aiAdvisorHistory.push({ role: 'assistant', content: data.content[0].text });
        
      } catch (error) {
        console.error('AI Advisor error:', error);
        aiAdvisorHistory.push({ 
          role: 'assistant', 
          content: 'Sorry, I encountered an error: ' + error.message + '\n\nPlease check your API key in Settings and try again.' 
        });
      }
      
      aiAdvisorLoading = false;
      renderAIAdvisor(document.getElementById('main-content'));
    }

    function clearAIAdvisorHistory() {
      aiAdvisorHistory = [];
      renderAIAdvisor(document.getElementById('main-content'));
    }
  </script>
</body>
</html>
