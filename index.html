<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>HORIZON STAR TMS</title>
  
  <!-- PWA Support -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#22c55e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Horizon Star TMS">
  <link rel="apple-touch-icon" href="icon-192.svg">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Typography: Inter (All UI) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- External CSS Files -->
  <link rel="stylesheet" href="assets/css/design-system.css">
  <!-- <link rel="stylesheet" href="assets/css/variables.css"> kept as backup -->
  <link rel="stylesheet" href="assets/css/base.css">
  <link rel="stylesheet" href="assets/css/print.css" media="print">

  <!-- Supabase Client Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- PDF Generation Libraries for Earnings Statements -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root {
      /* Extra gradients not in design-system.css */
      --gradient-surface: linear-gradient(180deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0) 100%);
      --gradient-glow: radial-gradient(ellipse at center, rgba(34, 197, 94, 0.15) 0%, transparent 70%);
      --gradient-mesh:
        radial-gradient(at 40% 20%, rgba(34, 197, 94, 0.08) 0px, transparent 50%),
        radial-gradient(at 80% 0%, rgba(6, 182, 212, 0.05) 0px, transparent 50%),
        radial-gradient(at 0% 50%, rgba(34, 197, 94, 0.05) 0px, transparent 50%);

      /* Glow Effects */
      --glow-primary: 0 0 20px rgba(34, 197, 94, 0.3);
      --glow-accent: 0 0 20px rgba(6, 182, 212, 0.2);
    }
    
    body {
      font-family: var(--font-sans);
      background: var(--bg-primary);
      color: var(--text-primary);
      transition: background-color var(--transition-base) var(--ease-smooth), color var(--transition-base) var(--ease-smooth);
      font-size: var(--text-base);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100%;
      overflow: auto;
    }

    /* Typography - Heavy weight for headings */
    h1, h2, h3, .display, .page-title {
      font-family: var(--font-sans);
      letter-spacing: -0.03em;
      font-weight: 800;
    }

    /* Monospace for data/numbers */
    .stat-value, .money, .row-number, code, .mono {
      font-family: var(--font-mono);
      font-variant-numeric: tabular-nums;
    }
    
    /* Background gradient effect - only for dark theme */
    body.dark-theme::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      background: radial-gradient(circle at 30% 20%, rgba(34, 197, 94, 0.06) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.04) 0%, transparent 50%);
    }
    
    .app { display: flex; min-height: 100vh; position: relative; z-index: 1; overflow: visible; }
    
    /* ============ SIDEBAR - Design System ============ */
    .sidebar {
      width: var(--sidebar-width);
      max-width: var(--sidebar-width);
      min-width: var(--sidebar-width);
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 0;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      overflow-y: auto;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border);
      z-index: 100;
      transition: width 0.3s ease, min-width 0.3s ease, max-width 0.3s ease;
    }
    
    .sidebar::-webkit-scrollbar {
      width: 4px;
    }
    
    .sidebar::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }
    
    .sidebar.collapsed {
      width: var(--sidebar-collapsed-width);
      min-width: var(--sidebar-collapsed-width);
      max-width: var(--sidebar-collapsed-width);
      overflow-y: auto;
    }
    
    .sidebar.collapsed .logo h1 span,
    .sidebar.collapsed .logo p,
    .sidebar.collapsed .nav-section-title,
    .sidebar.collapsed .nav-item-text,
    .sidebar.collapsed .user-info .name,
    .sidebar.collapsed .user-info .role,
    .sidebar.collapsed .logout-btn span,
    .sidebar.collapsed .settings-panel {
      display: none;
    }
    
    .sidebar.collapsed .logo {
      padding: 16px 12px;
    }
    
    .sidebar.collapsed .logo h1 {
      justify-content: center;
    }
    
    .sidebar.collapsed .logo-icon {
      width: 40px;
      height: 40px;
      font-size: 22px;
    }
    
    .sidebar.collapsed .nav-item {
      justify-content: center;
      padding: 10px 0;
      border-left-color: transparent;
    }
    
    .sidebar.collapsed .nav-item .icon {
      margin: 0;
      font-size: 18px;
    }
    .sidebar.collapsed .nav-item .icon svg {
      width: 22px;
      height: 22px;
    }
    
    .sidebar.collapsed .user-info {
      padding: 12px;
    }
    
    .sidebar.collapsed .user-info-content {
      justify-content: center;
    }
    
    .sidebar.collapsed .user-avatar {
      width: 36px;
      height: 36px;
    }
    
    .sidebar.collapsed .logout-btn {
      padding: 10px;
      font-size: 16px;
      justify-content: center;
    }
    
    /* Fixed position tooltip for collapsed sidebar */
    .nav-tooltip {
      position: fixed;
      background: var(--bg-card);
      color: white;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      z-index: 9999;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s ease;
    }
    
    .nav-tooltip.visible {
      opacity: 1;
    }
    
    .nav-tooltip::before {
      content: '';
      position: absolute;
      left: -6px;
      top: 50%;
      transform: translateY(-50%);
      border: 6px solid transparent;
      border-right-color: var(--bg-card);
    }
    
    .sidebar-toggle {
      padding: 12px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 12px;
      z-index: 101;
      transition: all 0.15s ease;
      background: none;
      border-left: none;
      border-right: none;
      border-bottom: none;
      width: 100%;
    }

    .sidebar-toggle:hover {
      color: var(--text-primary);
      background: var(--bg-card-hover);
    }
    
    .logo {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo h1 {
      font-family: var(--font-sans);
      font-size: 1.375rem;
      font-weight: 700;
      letter-spacing: -0.03em;
      color: var(--green);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo span {
      color: var(--green) !important;
      -webkit-text-fill-color: var(--green) !important;
    }
    .logo-icon {
      width: 28px;
      height: 28px;
      flex-shrink: 0;
      color: var(--green);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .logo p {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.15em;
    }
    
    /* Navigation badge for notifications */
    .nav-badge {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--red);
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .sidebar.collapsed .nav-badge {
      right: 4px;
      top: 4px;
      transform: none;
      padding: 1px 4px;
      font-size: 9px;
      min-width: 14px;
    }
    
    /* Mini Chat Widget */
    .mini-chat-bubble {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary) 0%, var(--green) 100%);
      color: white;
      border: none;
      font-size: 26px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
      z-index: 999;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .mini-chat-bubble:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 24px rgba(34, 197, 94, 0.5);
    }
    
    .mini-chat-bubble .badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: var(--red);
      color: white;
      font-size: 11px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 20px;
      text-align: center;
    }
    
    .mini-chat-window {
      position: fixed;
      bottom: 100px;
      right: 24px;
      width: 380px;
      height: 500px;
      background: var(--bg-card);
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      z-index: 998;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid var(--border);
      animation: slideInUp 0.3s ease;
    }
    
    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .mini-chat-header {
      padding: 16px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--green) 100%);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .mini-chat-header h4 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
    }
    
    .mini-chat-header button {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .mini-chat-header button:hover {
      background: rgba(255,255,255,0.3);
    }
    
    .mini-chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--bg-secondary);
    }
    
    .mini-chat-input-area {
      padding: 12px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
      background: var(--bg-card);
    }
    
    .mini-chat-input-area input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 24px;
      font-size: 14px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    
    .mini-chat-input-area button {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 18px;
    }
    
    @media (max-width: 768px) {
      .mini-chat-bubble {
        bottom: calc(80px + env(safe-area-inset-bottom, 0px));
        right: 16px;
        width: 56px;
        height: 56px;
      }
      
      .mini-chat-window {
        bottom: 0;
        right: 0;
        left: 0;
        width: 100%;
        height: 70vh;
        border-radius: 20px 20px 0 0;
      }
    }
    
    /* Hide mini chat on team_chat page */
    body.on-team-chat .mini-chat-bubble,
    body.on-team-chat .mini-chat-window {
      display: none !important;
    }
    
    /* Submenu toggle button */
    .nav-item.submenu-toggle {
      justify-content: space-between;
    }
    .nav-item-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .nav-arrow {
      font-size: 10px;
      opacity: 0.5;
    }
    
    /* Submenu items */
    .nav-item.nav-subitem {
      padding-left: 44px;
      font-size: 12px;
    }
    
    .main {
      margin-left: var(--sidebar-width);
      flex: 1;
      padding: 0 24px 24px;
      min-height: 100vh;
      background: var(--bg-app);
      overflow: auto;
      box-sizing: border-box;
    }
    
    .main.sidebar-collapsed {
      margin-left: var(--sidebar-collapsed-width);
    }
    
    /* Ensure margin on desktop screens */
    @media (min-width: 769px) {
      .main {
        margin-left: var(--sidebar-width) !important;
      }
      .main.sidebar-collapsed {
        margin-left: var(--sidebar-collapsed-width) !important;
      }
    }
    
    /* ============ USER INFO ============ */
    .user-info {
      padding: 16px;
      border-top: 1px solid var(--border);
      margin-top: auto;
    }
    .user-info-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--green-dim);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      color: var(--green);
    }
    .user-info .name { font-size: 14px; color: var(--text-primary); font-weight: 600; }
    .user-info .role {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }
    .logout-btn {
      margin-top: 12px;
      width: 100%;
      padding: 10px;
      background: var(--red-dim);
      border: none;
      color: var(--red);
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .logout-btn:hover {
      background: rgba(239, 68, 68, 0.25);
      color: var(--red);
    }
    
    /* ============ HEADER ============ */
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 16px; 
      flex-wrap: wrap; 
      gap: 12px;
    }
    .header h2 { 
      font-size: 20px; 
      font-weight: 700; 
      color: var(--text-primary);
      letter-spacing: -0.5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    /* ============ TOPBAR - Adapts to Theme ============ */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-app);
      position: sticky;
      top: 0;
      z-index: 50;
    }
    
    .topbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .welcome-text {
      font-size: 18px;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .welcome-name {
      color: var(--green);
      font-weight: 600;
    }
    
    .topbar-center {
      display: flex;
      align-items: center;
      gap: 24px;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .world-clock {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding: 6px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      min-width: 80px;
    }
    
    .clock-city {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 500;
    }
    
    .clock-time {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    }
    
    .topbar {
      position: relative;
    }
    
    @media (max-width: 1100px) {
      .topbar-center {
        display: none;
      }
    }
    
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .topbar-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-secondary);
    }
    
    .topbar-btn:hover {
      background: var(--bg-card-hover);
      border-color: var(--text-muted);
      color: var(--text-primary);
    }
    
    /* Empty State - Lovable style */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
    }
    .empty-state-icon {
      font-size: 48px;
      color: var(--text-muted);
      margin-bottom: 16px;
      opacity: 0.5;
    }
    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    .empty-state-text {
      font-size: 14px;
      color: var(--text-muted);
      max-width: 300px;
    }
    
    .topbar-btn-text {
      font-size: 12px;
      font-weight: 500;
    }
    
    .notification-btn {
      position: relative;
    }
    
    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 18px;
      height: 18px;
      background: var(--red);
      color: white;
      font-size: 10px;
      font-weight: 600;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }
    
    .notification-wrapper {
      position: relative;
    }
    
    .notification-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      width: 360px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow-xl);
      margin-top: 8px;
      z-index: 1000;
      display: none;
      max-height: 480px;
      overflow: hidden;
    }
    
    .notification-dropdown.open {
      display: block;
    }
    
    .notification-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .notification-list {
      max-height: 400px;
      overflow-y: auto;
    }
    
    .notification-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }
    
    .notification-item:hover {
      background: var(--bg-hover);
    }
    
    .notification-item.unread {
      background: var(--primary-light);
    }
    
    .notification-item.unread:hover {
      background: var(--bg-hover);
    }
    
    .notification-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }
    
    .notification-content {
      flex: 1;
      min-width: 0;
    }
    
    .notification-title {
      font-weight: 500;
      margin-bottom: 2px;
      color: var(--text-primary);
    }
    
    .notification-message {
      font-size: 13px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .notification-time {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    .topbar-user {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 12px 6px 6px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 30px;
      margin-left: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .topbar-user:hover {
      background: var(--bg-card-hover);
      border-color: var(--text-muted);
    }
    
    .topbar-user-wrapper {
      position: relative;
    }
    
    .topbar-user-arrow {
      font-size: 10px;
      color: var(--text-muted);
      margin-left: 4px;
      transition: transform 0.2s;
    }
    
    .topbar-user-wrapper.open .topbar-user-arrow {
      transform: rotate(180deg);
    }
    
    .topbar-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 220px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.2s;
      z-index: 1000;
    }
    
    .topbar-user-wrapper.open .topbar-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .topbar-dropdown-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
    }
    
    .topbar-dropdown-avatar {
      width: 40px;
      height: 40px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      color: white;
    }
    
    .topbar-dropdown-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .topbar-dropdown-email {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .topbar-dropdown-divider {
      height: 1px;
      background: var(--border);
      margin: 0 12px;
    }
    
    .topbar-dropdown-item {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 12px 16px;
      background: none;
      border: none;
      font-size: 14px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
      text-align: left;
    }
    
    .topbar-dropdown-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }
    
    .topbar-dropdown-item:first-of-type {
      border-radius: 0;
    }
    
    .topbar-dropdown-item:last-child {
      border-radius: 0 0 12px 12px;
    }
    
    .topbar-dropdown-item.logout {
      color: var(--danger);
    }
    
    .topbar-dropdown-item.logout:hover {
      background: var(--danger-light);
      color: var(--danger);
    }
    
    .topbar-avatar {
      width: 32px;
      height: 32px;
      background: var(--primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
      color: white;
    }
    
    .topbar-user-info {
      display: none;
    }
    
    @media (min-width: 768px) {
      .topbar-user-info {
        display: block;
      }
      .topbar-user-name {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
      }
      .topbar-user-role {
        font-size: 11px;
        color: var(--text-muted);
      }
    }
    
    /* ============ SEARCH BOX ============ */
    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      min-width: 240px;
    }
    .search-box input {
      border: none;
      background: none;
      outline: none;
      font-size: 13px;
      color: var(--text-primary);
      width: 100%;
    }
    .search-box input::placeholder {
      color: var(--text-muted);
    }
    .search-box:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }
    
    /* ============ BUTTONS - Lovable Style ============ */
    .btn {
      padding: 10px 20px;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.15s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: inherit;
      line-height: 1;
    }
    .btn-primary {
      background: var(--green);
      color: white;
    }
    .btn-primary:hover {
      filter: brightness(1.1);
      transform: translateY(-1px);
    }
    .btn-primary:active {
      transform: translateY(0);
    }
    .btn-secondary {
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover {
      background: var(--bg-card-hover);
      border-color: var(--text-muted);
    }
    .btn-sm { padding: 8px 14px; font-size: 13px; }
    .btn-icon {
      width: 40px;
      height: 40px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }
    .btn-icon:hover {
      background: var(--bg-tertiary);
    }
    
    /* Assign to trip button - Lovable style */
    .btn-assign {
      color: var(--primary);
      background: none;
      border: none;
      font-weight: 500;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .btn-assign:hover {
      text-decoration: underline;
    }
    
    /* ============ STATS CARDS - Adapts to Theme ============ */
    .stats-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); 
      gap: 12px; 
      margin-bottom: 16px;
    }
    .stat-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-card);
      transition: all 0.2s ease;
      border: 1px solid var(--border);
      position: relative;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .stat-card:hover {
      box-shadow: var(--shadow-card-hover);
      transform: translateY(-1px);
    }
    .stat-card .stat-icon {
      width: 44px;
      height: 44px;
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }
    .stat-card .stat-icon.green { background: var(--green-dim); color: var(--green); }
    .stat-card .stat-icon.orange { background: var(--amber-dim); color: var(--amber); }
    .stat-card .stat-icon.red { background: var(--red-dim); color: var(--red); }
    .stat-card .stat-icon.blue { background: var(--blue-dim); color: var(--blue); }
    .stat-card .stat-content {
      flex: 1;
    }
    .stat-card .label {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .stat-card .value {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
      letter-spacing: -0.5px;
      line-height: 1.2;
      font-family: var(--font-mono);
    }
    .stat-card .value.green { color: var(--green); }
    .stat-card .value.red { color: var(--red); }
    .stat-card .value.orange { color: var(--warning); }
    .stat-card .trend {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    .stat-card .trend.up { color: var(--success); }
    .stat-card .trend.down { color: var(--danger); }
    .stat-card .icon { 
      width: 48px; 
      height: 48px; 
      border-radius: 12px;
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 22px;
      flex-shrink: 0;
    }
    .stat-card .icon.green { background: rgba(16, 185, 129, 0.15); color: var(--success); }
    .stat-card .icon.blue { background: rgba(59, 130, 246, 0.15); color: var(--info); }
    .stat-card .icon.amber { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
    .stat-card .icon.red { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
    
    /* Dashboard Colored Cards - Premium Treatment */
    .dashboard-stat-card {
      background: var(--bg-tertiary);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .dashboard-stat-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(255,255,255,0.04) 0%, rgba(255,255,255,0) 100%);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .dashboard-stat-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-card-hover);
    }
    .dashboard-stat-card:hover::before {
      opacity: 1;
    }
    .dashboard-stat-card .stat-label {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dashboard-stat-card .stat-value {
      font-family: var(--font-mono);
      font-size: var(--text-2xl);
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    .dashboard-stat-card .stat-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      font-family: var(--font-mono);
      font-size: 9px;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Revenue card - green glow accent */
    .dashboard-stat-card.revenue {
      background:
        radial-gradient(ellipse at top right, rgba(34, 197, 94, 0.12) 0%, transparent 50%),
        var(--bg-tertiary);
      border-color: rgba(34, 197, 94, 0.25);
    }
    .dashboard-stat-card.revenue .stat-value {
      color: var(--primary);
      text-shadow: 0 0 25px rgba(34, 197, 94, 0.3);
    }
    .dashboard-stat-card.revenue .stat-icon { color: var(--primary); }

    /* Deductions card - orange glow accent */
    .dashboard-stat-card.deductions {
      background:
        radial-gradient(ellipse at top right, rgba(245, 158, 11, 0.1) 0%, transparent 50%),
        var(--bg-tertiary);
      border-color: rgba(245, 158, 11, 0.2);
    }
    .dashboard-stat-card.deductions .stat-value { color: var(--warning); }
    .dashboard-stat-card.deductions .stat-icon { color: var(--warning); }

    /* Costs card - neutral with subtle accent */
    .dashboard-stat-card.costs {
      background: var(--bg-tertiary);
    }
    .dashboard-stat-card.costs .stat-value { color: var(--text-primary); }

    /* Profit card - green or red based on value */
    .dashboard-stat-card.profit {
      background:
        radial-gradient(ellipse at top right, rgba(34, 197, 94, 0.12) 0%, transparent 50%),
        var(--bg-tertiary);
      border-color: rgba(34, 197, 94, 0.2);
    }
    .dashboard-stat-card.profit .stat-value {
      color: var(--primary);
      text-shadow: 0 0 25px rgba(34, 197, 94, 0.3);
    }
    .dashboard-stat-card.profit.negative {
      background:
        radial-gradient(ellipse at top right, rgba(239, 68, 68, 0.1) 0%, transparent 50%),
        var(--bg-tertiary);
      border-color: rgba(239, 68, 68, 0.2);
    }
    .dashboard-stat-card.profit.negative .stat-value {
      color: var(--danger);
      text-shadow: 0 0 20px rgba(239, 68, 68, 0.25);
    }
    
    /* Mini stat cards row */
    .mini-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .mini-stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      text-align: center;
    }
    .mini-stat-card .mini-icon {
      font-size: 20px;
      margin-bottom: 8px;
      color: var(--text-muted);
    }
    .mini-stat-card .mini-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    .mini-stat-card .mini-label {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    /* Direction Tabs for Future Cars */
    .direction-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }
    .direction-tab {
      padding: 8px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .direction-tab:hover {
      background: var(--bg-tertiary);
      border-color: var(--text-muted);
    }
    .direction-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    .direction-tab.orange {
      background: var(--warning-light);
      border-color: var(--warning);
      color: var(--warning);
    }
    .direction-tab.orange.active {
      background: var(--warning);
      color: white;
    }
    .direction-tab.red {
      background: var(--danger-light);
      border-color: var(--danger);
      color: var(--danger);
    }
    .direction-tab.red.active {
      background: var(--danger);
      color: white;
    }
    
    /* Table section header - like Future Cars "NY to Home" header */
    .table-section-header {
      background: linear-gradient(135deg, var(--blue) 0%, var(--blue) 100%);
      color: white;
      padding: 12px 16px;
      font-weight: 600;
      font-size: 14px;
      border-radius: var(--radius) var(--radius) 0 0;
    }
    
    /* Toggle switch */
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--bg-tertiary);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid var(--border);
    }
    .toggle-switch.active {
      background: var(--primary);
      border-color: var(--primary);
    }
    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s;
    }
    .toggle-switch.active::after {
      left: 22px;
    }
    
    /* Remove old colored headers */
    .stat-card.green-header,
    .stat-card.blue-header,
    .stat-card.amber-header,
    .stat-card.red-header {
      border-left: none;
    }
    
    /* ============ CARDS - Adapts to Theme ============ */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-card);
      overflow: visible;
      margin-bottom: 14px;
      border: 1px solid var(--border);
      transition: all 0.2s ease;
    }
    .card > .table-wrapper,
    .card > div > .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .card-header { 
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      background: transparent;
    }
    .card-header h3 { 
      font-size: 14px; 
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-header h3 .icon {
      font-size: 16px;
    }
    .card-body {
      padding: 0;
    }
    
    /* Metric card style */
    .metric-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .metric-card .metric-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .metric-card .metric-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }
    .metric-card .metric-value.green { color: var(--success); }
    .metric-card .metric-value.red { color: var(--danger); }
    .metric-card .metric-value.orange { color: var(--warning); }
    
    /* Page header - Lovable style */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .page-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .page-title .icon {
      font-size: 24px;
    }
    
    .page-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    /* Search input - Lovable dark style */
    .search-input-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      min-width: 200px;
    }
    
    .search-input-wrap input {
      border: none;
      background: none;
      outline: none;
      font-size: 14px;
      color: var(--text-primary);
      width: 100%;
    }
    
    .search-input-wrap input::placeholder {
      color: var(--text-muted);
    }
    
    /* Icon buttons - filter, download */
    .icon-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-secondary);
    }
    
    .icon-btn:hover {
      background: var(--bg-hover);
      border-color: var(--primary);
      color: var(--primary);
    }
    
    /* ============ TRUCK TABS - Adapts to Theme ============ */
    .truck-tabs-container {
      display: flex !important;
      flex-wrap: nowrap !important;
      overflow-x: scroll !important;
      overflow-y: hidden !important;
      white-space: nowrap !important;
      margin-bottom: 0;
      padding-bottom: 10px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: var(--border) var(--bg-tertiary);
      max-width: 100%;
      width: 100%;
      position: relative;
      gap: 8px;
    }
    
    .truck-tabs-container::-webkit-scrollbar {
      height: 6px;
      display: block !important;
    }
    
    .truck-tabs-container::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }
    
    .truck-tabs-container::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
      min-width: 40px;
    }
    
    .truck-tabs-container::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }
    
    .truck-tabs-container button,
    .truck-tabs-container .truck-tab,
    .truck-tab {
      flex-shrink: 0 !important;
      flex-grow: 0 !important;
      white-space: nowrap !important;
      background: var(--bg-secondary) !important;
      border: 1px solid var(--border) !important;
      color: var(--text-secondary) !important;
      padding: 12px 20px !important;
      border-radius: 10px !important;
      font-weight: 700 !important;
      font-size: 15px !important;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .truck-tabs-container button:hover,
    .truck-tab:hover {
      background: var(--bg-tertiary) !important;
      border-color: var(--primary) !important;
    }
    
    .truck-tabs-container button.active,
    .truck-tab.active {
      background: var(--primary) !important;
      border-color: var(--primary) !important;
      color: white !important;
    }
    
    /* ============ TABLE - Adapts to Theme ============ */
    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: var(--radius);
      padding-right: 16px; /* Space for sticky actions column shadow */
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px;
      font-size: 13px;
    }
    th {
      text-align: left;
      padding: 12px 16px;
      background: var(--bg-elevated);
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
    }
    th:first-child {
      border-radius: var(--radius) 0 0 0;
    }
    th:last-child {
      border-radius: 0 var(--radius) 0 0;
    }
    td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      color: var(--text-primary);
      vertical-align: middle;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td {
      background: var(--bg-card-hover);
    }
    td strong {
      color: var(--text-primary);
      font-weight: 600;
    }
    td.money {
      font-family: var(--font-mono);
      font-weight: 600;
      color: var(--green);
    }
    
    /* Row numbers in green */
    .row-number {
      color: var(--green);
      font-weight: 600;
    }
    
    /* Action icons */
    .action-icons {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .action-icon {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-muted);
      background: transparent;
      border: none;
    }
    .action-icon:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }
    .action-icon.danger:hover {
      background: var(--red-dim);
      color: var(--red);
    }
    .action-icon svg {
      width: 18px;
      height: 18px;
    }
    
    /* Avatar in tables */
    .table-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--green-dim);
      color: var(--green);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    .table-user {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .table-user-info {
      display: flex;
      flex-direction: column;
    }
    
    .table-user-name {
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .table-user-email {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    /* ============ BADGES - Lovable Style ============ */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      line-height: 1.4;
    }
    .badge-green { background: var(--green-dim); color: var(--green); }
    .badge-amber { background: var(--amber-dim); color: var(--amber); }
    .badge-blue { background: var(--blue-dim); color: var(--blue); }
    .badge-red { background: var(--red-dim); color: var(--red); }
    .badge-gray { background: var(--bg-elevated); color: var(--text-muted); }
    .badge-purple { background: var(--purple-dim); color: var(--purple); }
    
    /* Payment type badges - filled gray */
    .badge-payment {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-weight: 600;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 6px;
    }
    
    /* Category badges - outlined with colors */
    .badge-category {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge-category.dealer { background: var(--green-dim); border: 1px solid var(--green); color: var(--green); }
    .badge-category.auction { background: var(--amber-dim); border: 1px solid var(--amber); color: var(--amber); }
    .badge-category.private { background: var(--purple-dim); border: 1px solid var(--purple); color: var(--purple); }
    
    /* Status badges - Lovable dark style */
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-badge.success { background: var(--green-dim); color: var(--green); }
    .status-badge.warning { background: var(--amber-dim); color: var(--amber); }
    .status-badge.danger { background: var(--red-dim); color: var(--red); }
    .status-badge.info { background: var(--blue-dim); color: var(--blue); }
    
    /* ============ MODALS ============ */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

    .modal {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 24px 48px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
      border: 1px solid var(--border);
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h3 {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-primary);
    }
    .modal-close {
      background: var(--bg-card-hover);
      border: 1px solid var(--border);
      width: 36px;
      height: 36px;
      border-radius: 6px;
      font-size: 18px;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
    }
    .modal-close:hover {
      color: var(--text-primary);
      border-color: var(--text-muted);
    }
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* Override inline purple modal headers */
    .modal-header[style*="background:var(--purple)"],
    .modal-header[style*="background:var(--purple)"],
    .modal-header[style*="background: var(--purple)"],
    .modal-header[style*="background: var(--purple)"] {
      background: linear-gradient(135deg, var(--purple) 0%, var(--purple) 100%) !important;
    }

    /* ============ ORDER DETAIL MODAL ============ */
    .modal.order-detail-modal {
      max-width: 1200px;
      width: 95%;
    }
    .order-detail-layout {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 24px;
    }
    @media (max-width: 900px) {
      .order-detail-layout {
        grid-template-columns: 1fr;
      }
    }
    .order-detail-main, .order-detail-sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .order-detail-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }
    .order-detail-card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-secondary);
    }
    .order-detail-card-header h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .order-detail-card-body {
      padding: 20px;
    }

    /* Order Info Grid */
    .order-info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }
    .order-info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .order-info-item .label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .order-info-item .value {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
    }

    /* Route Display */
    .route-display {
      display: flex;
      align-items: stretch;
      gap: 20px;
    }
    .route-point {
      flex: 1;
      padding: 16px;
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
    }
    .route-point.pickup {
      border-left: 4px solid var(--primary-500);
    }
    .route-point.delivery {
      border-left: 4px solid var(--amber);
    }
    .route-point .type-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .route-point.pickup .type-label { color: var(--primary-500); }
    .route-point.delivery .type-label { color: var(--amber); }
    .route-point .location {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    .route-point .address {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.4;
    }
    .route-point .contact {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      font-size: 13px;
      color: var(--text-secondary);
    }
    .route-arrow {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 24px;
    }
    @media (max-width: 600px) {
      .route-display {
        flex-direction: column;
      }
      .route-arrow {
        transform: rotate(90deg);
        padding: 8px 0;
      }
    }

    /* Inspection Cards */
    .inspection-card {
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      overflow: hidden;
      margin-bottom: 16px;
    }
    .inspection-card:last-child {
      margin-bottom: 0;
    }
    .inspection-card-header {
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }
    .inspection-card-header.pickup {
      border-left: 4px solid var(--primary-500);
    }
    .inspection-card-header.delivery {
      border-left: 4px solid var(--amber);
    }
    .inspection-card-header h5 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .inspection-card-body {
      padding: 16px;
    }
    .inspection-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 16px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    .inspection-meta span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Photo Grid */
    .inspection-photos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
      margin-bottom: 16px;
    }
    .inspection-photo-thumb {
      aspect-ratio: 1;
      border-radius: var(--radius-sm);
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: var(--transition);
    }
    .inspection-photo-thumb:hover {
      border-color: var(--primary);
      transform: scale(1.05);
    }
    .inspection-photo-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Damage Badges */
    .damages-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .damage-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(239, 68, 68, 0.1);
      color: var(--red);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .damage-badge.minor {
      background: rgba(251, 191, 36, 0.1);
      color: var(--amber);
    }
    .damage-badge.major {
      background: rgba(239, 68, 68, 0.1);
      color: var(--red);
    }
    .damage-badge.pre-existing {
      background: rgba(107, 114, 128, 0.1);
      color: var(--text-secondary);
    }

    /* Condition Flags */
    .condition-flags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    .condition-flag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* Activity Timeline */
    .activity-timeline {
      position: relative;
      padding-left: 24px;
    }
    .activity-timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 8px;
      bottom: 8px;
      width: 2px;
      background: var(--border);
    }
    .timeline-item {
      position: relative;
      padding-bottom: 20px;
    }
    .timeline-item:last-child {
      padding-bottom: 0;
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: -20px;
      top: 4px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
    }
    .timeline-item.completed::before {
      background: var(--primary-500);
      border-color: var(--primary-500);
    }
    .timeline-item.active::before {
      background: var(--blue);
      border-color: var(--blue);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
    }
    .timeline-item .event-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 2px;
    }
    .timeline-item .event-time {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* Signatures Grid */
    .signatures-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    @media (max-width: 500px) {
      .signatures-grid {
        grid-template-columns: 1fr;
      }
    }
    .signature-item {
      padding: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      text-align: center;
    }
    .signature-item .sig-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .signature-item .sig-image {
      max-width: 100%;
      max-height: 60px;
      margin-bottom: 8px;
    }
    .signature-item .sig-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }
    .signature-item .sig-time {
      font-size: 11px;
      color: var(--text-muted);
    }
    .signature-item.empty {
      color: var(--text-muted);
      font-style: italic;
    }

    /* Financials List */
    .financials-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .financials-list .fin-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }
    .financials-list .fin-row .label {
      color: var(--text-secondary);
    }
    .financials-list .fin-row .value {
      font-weight: 500;
      color: var(--text-primary);
    }
    .financials-list .fin-row.total {
      padding-top: 12px;
      border-top: 1px solid var(--border);
      font-weight: 600;
    }
    .financials-list .fin-row.total .value {
      color: var(--primary-500);
      font-size: 16px;
    }
    .financials-list .fin-row .value.negative {
      color: var(--red);
    }

    /* Photo Gallery Modal */
    .photo-gallery-modal {
      max-width: 900px;
    }
    .photo-gallery-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .photo-gallery-main {
      width: 100%;
      max-height: 500px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    .photo-gallery-main img {
      max-width: 100%;
      max-height: 500px;
      object-fit: contain;
    }
    .photo-gallery-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: var(--text-primary);
      transition: var(--transition);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .photo-gallery-nav:hover {
      background: var(--bg-card);
      transform: translateY(-50%) scale(1.1);
    }
    .photo-gallery-nav.prev { left: 16px; }
    .photo-gallery-nav.next { right: 16px; }
    .photo-gallery-info {
      margin-top: 16px;
      text-align: center;
    }
    .photo-gallery-info .photo-type {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    .photo-gallery-info .photo-counter {
      font-size: 13px;
      color: var(--text-muted);
    }
    .photo-gallery-thumbs {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      overflow-x: auto;
      padding: 8px 0;
    }
    .photo-gallery-thumbs img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: var(--radius-sm);
      cursor: pointer;
      border: 2px solid transparent;
      opacity: 0.6;
      transition: var(--transition);
    }
    .photo-gallery-thumbs img:hover {
      opacity: 1;
    }
    .photo-gallery-thumbs img.active {
      border-color: var(--primary);
      opacity: 1;
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .quick-actions .btn {
      width: 100%;
      justify-content: center;
    }

    /* ============ ORDER DETAIL FULL PAGE ============ */
    .order-detail-page {
      padding: 24px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .order-detail-page-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    .order-detail-page-header .header-left {
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }
    .order-detail-page-header .btn-back {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      font-size: 14px;
      margin-top: 2px;
    }
    .order-detail-page-header .header-title-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .order-detail-page-header .header-title-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .order-detail-page-header .header-title-row h2 {
      font-size: 22px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }
    .order-detail-page-header .header-badges {
      display: flex;
      gap: 8px;
    }
    .order-detail-page-header .header-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    .order-detail-page-header .header-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 12px;
    }
    .order-detail-page-header .assigned-to {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }
    .order-detail-page-header .assigned-label {
      color: var(--text-secondary);
    }
    .order-detail-page-header .assigned-name {
      color: var(--text-primary);
      font-weight: 600;
    }
    .order-detail-page-header .header-actions {
      display: flex;
      gap: 8px;
    }
    .badge-gray {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-purple {
      background: var(--purple-dim);
      color: var(--purple);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    body.dark-theme .badge-purple {
      background: rgba(124, 58, 237, 0.2);
      color: var(--purple);
    }
    @media (max-width: 768px) {
      .order-detail-page {
        padding: 16px;
      }
      .order-detail-page-header {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
      }
      .order-detail-page-header .header-left {
        flex-direction: column;
        gap: 12px;
      }
      .order-detail-page-header .header-right {
        align-items: flex-start;
      }
      .order-detail-page-header .header-title-row h2 {
        font-size: 18px;
      }
    }

    /* Route Side-by-Side Layout */
    .route-side-by-side {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }
    .route-column {
      background: var(--bg-secondary);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .route-column-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }
    .route-column-badge {
      display: inline-block;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.5px;
      padding: 4px 12px;
      border-radius: 4px;
    }
    .route-column-badge.pickup {
      background: var(--primary-100);
      color: var(--primary-800);
    }
    .route-column-badge.delivery {
      background: var(--amber-dim);
      color: var(--amber);
    }
    body.dark-theme .route-column-badge.pickup {
      background: rgba(34, 197, 94, 0.2);
      color: var(--primary-400);
    }
    body.dark-theme .route-column-badge.delivery {
      background: rgba(251, 146, 60, 0.2);
      color: var(--amber);
    }
    .route-column-body {
      padding: 16px;
    }
    .route-location {
      margin-bottom: 16px;
    }
    .route-location-name {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    .route-location-name svg {
      color: var(--text-secondary);
    }
    .route-address {
      font-size: 13px;
      color: var(--text-secondary);
      padding-left: 24px;
    }
    .route-dates {
      margin-bottom: 16px;
      padding: 12px;
      background: var(--bg-primary);
      border-radius: 8px;
    }
    .route-date-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .route-date-row:last-child {
      margin-bottom: 0;
    }
    .route-date-label {
      color: var(--text-secondary);
    }
    .route-date-value {
      color: var(--text-primary);
    }
    .route-date-value.success {
      color: var(--green);
      font-weight: 500;
    }
    .route-contact {
      border-top: 1px solid var(--border);
      padding-top: 12px;
    }
    .route-contact-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .route-contact-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-primary);
      margin-bottom: 6px;
    }
    .route-contact-row svg {
      color: var(--text-secondary);
    }
    .route-notes {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }
    .route-notes-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    .route-notes-text {
      font-size: 13px;
      color: var(--text-primary);
      font-style: italic;
    }
    @media (max-width: 768px) {
      .route-side-by-side {
        grid-template-columns: 1fr;
      }
    }

    /* Vehicle Section Table */
    .vehicle-section .order-detail-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .vehicle-total {
      font-weight: 700;
      font-size: 16px;
      color: var(--text-primary);
    }
    .vehicle-table {
      width: 100%;
      border-collapse: collapse;
    }
    .vehicle-table th {
      text-align: left;
      padding: 10px 16px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border);
    }
    .vehicle-table td {
      padding: 12px 16px;
      font-size: 14px;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border);
    }
    .vehicle-table tr:last-child td {
      border-bottom: none;
    }

    /* Enhanced Inspection Card */
    .inspection-card.enhanced {
      overflow: hidden;
    }
    .inspection-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      color: white;
    }
    .inspection-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .inspection-icon {
      font-size: 18px;
    }
    .inspection-label {
      font-weight: 600;
      font-size: 14px;
    }
    .inspection-header-right {
      display: flex;
      gap: 8px;
    }
    .badge-photos, .badge-damages {
      background: rgba(255,255,255,0.2);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    .badge-damages {
      background: rgba(239,68,68,0.3);
    }

    /* Enhanced Photos Section */
    .inspection-photos-enhanced {
      margin-bottom: 16px;
    }
    .photos-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .photos-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .btn-download-all {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      color: var(--primary);
      background: transparent;
      border: 1px solid var(--primary);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-download-all:hover {
      background: var(--primary);
      color: white;
    }
    .photos-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .featured-photo {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      cursor: pointer;
      aspect-ratio: 4/3;
    }
    .featured-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.2s;
    }
    .featured-photo:hover img {
      transform: scale(1.02);
    }
    .featured-photo .photo-type-badge {
      position: absolute;
      bottom: 8px;
      left: 8px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }
    .photos-grid-4col {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 8px;
    }
    .photo-thumb-small {
      position: relative;
      border-radius: 6px;
      overflow: hidden;
      cursor: pointer;
      aspect-ratio: 1;
    }
    .photo-thumb-small img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.2s;
    }
    .photo-thumb-small:hover img {
      transform: scale(1.05);
    }
    .more-photos-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 16px;
      font-weight: 600;
    }
    .inspection-additional {
      margin-top: 12px;
      padding: 12px;
      background: var(--bg-primary);
      border-radius: 8px;
    }
    .additional-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .additional-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
    }
    .additional-row span {
      color: var(--text-secondary);
    }
    .additional-row strong {
      color: var(--text-primary);
    }

    /* Damage Section */
    .damage-section {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .damage-header {
      margin-bottom: 8px;
    }
    .damage-count {
      font-size: 13px;
      font-weight: 600;
      color: var(--red);
    }
    .damage-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .damage-badge {
      background: var(--red-dim);
      color: var(--red);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
    }
    body.dark-theme .damage-badge {
      background: rgba(220,38,38,0.15);
      color: var(--red);
    }

    /* Conditions Row */
    .conditions-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }
    .conditions-label {
      font-size: 12px;
      color: var(--text-secondary);
    }
    .condition-badge {
      font-size: 12px;
      padding: 4px 8px;
      background: var(--bg-primary);
      border-radius: 4px;
    }

    /* Inspection Signer */
    .inspection-signer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      font-size: 13px;
      color: var(--text-primary);
    }
    .signer-date {
      color: var(--text-secondary);
      font-size: 12px;
    }

    @media (max-width: 768px) {
      .photos-layout {
        grid-template-columns: 1fr;
      }
      .photos-grid-4col {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    /* Payment Card (Prominent) */
    .payment-card .order-detail-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .payment-status-badge {
      background: var(--amber-dim);
      color: var(--amber);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .payment-status-badge.paid {
      background: var(--primary-100);
      color: var(--primary-800);
    }
    body.dark-theme .payment-status-badge {
      background: rgba(245, 158, 11, 0.2);
      color: var(--amber);
    }
    body.dark-theme .payment-status-badge.paid {
      background: rgba(34, 197, 94, 0.2);
      color: var(--primary-400);
    }
    .payment-amount {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
    }
    .payment-details {
      border-top: 1px solid var(--border);
      padding-top: 12px;
    }
    .payment-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
    }
    .payment-row:last-child {
      border-bottom: none;
    }
    .payment-row span:first-child {
      color: var(--text-secondary);
    }
    .payment-row span:last-child {
      color: var(--text-primary);
    }
    .payment-row .negative {
      color: var(--red);
    }
    .payment-row.net {
      font-weight: 600;
      border-top: 2px solid var(--border);
      margin-top: 4px;
      padding-top: 10px;
    }
    .payment-row.net span:last-child {
      color: var(--success);
    }

    /* Customer Information Card */
    .customer-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .customer-name {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
    }
    .customer-name svg {
      color: var(--text-secondary);
    }
    .customer-contact {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-primary);
      padding-left: 24px;
    }
    .customer-contact svg {
      color: var(--text-secondary);
    }
    .customer-contact.muted {
      color: var(--text-muted);
      font-style: italic;
    }

    /* Internal Notes */
    .internal-notes-content {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.5;
    }
    .internal-notes-content p {
      margin: 0;
      white-space: pre-wrap;
    }
    .internal-notes-content p.muted {
      color: var(--text-muted);
      font-style: italic;
      text-align: center;
    }
    .btn-icon-sm {
      background: none;
      border: none;
      padding: 4px;
      cursor: pointer;
      color: var(--text-secondary);
      border-radius: 4px;
      transition: all 0.2s;
    }
    .btn-icon-sm:hover {
      background: var(--bg-primary);
      color: var(--primary);
    }

    /* Activity Feed Sidebar */
    .activity-card .order-detail-card-body {
      max-height: 300px;
      overflow-y: auto;
    }
    .activity-feed-sidebar {
      display: flex;
      flex-direction: column;
    }
    .activity-feed-item {
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }
    .activity-feed-item:last-child {
      border-bottom: none;
    }
    .activity-feed-text {
      font-size: 13px;
      color: var(--text-primary);
      margin-bottom: 4px;
    }
    .activity-feed-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
    }
    .activity-feed-user {
      color: var(--primary);
      font-weight: 500;
    }
    .activity-feed-date {
      color: var(--text-muted);
    }

    /* Quick Actions Grid - 2x2 layout */
    .quick-actions-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .quick-actions-grid .btn {
      width: 100%;
      justify-content: center;
      font-size: 13px;
      padding: 10px 12px;
    }
    @media (max-width: 600px) {
      .quick-actions-grid[style*="repeat(3"] {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }

    /* Attachments List Styles */
    .attachments-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 12px;
    }
    .attachment-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: var(--bg-darker);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    .attachment-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }
    .attachment-icon {
      font-size: 24px;
    }
    .attachment-info strong {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 250px;
    }
    .attachment-actions {
      display: flex;
      gap: 6px;
      flex-shrink: 0;
    }
    .attachment-actions .action-btn {
      padding: 6px 10px;
      font-size: 12px;
    }

    /* ============ DARK THEME INLINE STYLE OVERRIDES ============ */
    /* Scoped to dark theme only - catches hardcoded light backgrounds */
    body.dark-theme [style*="background:var(--blue-dim)"],
    body.dark-theme [style*="background: var(--blue-dim)"] {
      background: rgba(59, 130, 246, 0.15) !important;
    }
    body.dark-theme [style*="background:var(--green-dim)"],
    body.dark-theme [style*="background: var(--green-dim)"] {
      background: rgba(34, 197, 94, 0.15) !important;
    }
    body.dark-theme [style*="background:var(--amber-dim)"],
    body.dark-theme [style*="background: var(--amber-dim)"] {
      background: rgba(245, 158, 11, 0.15) !important;
    }
    body.dark-theme [style*="background:var(--border)"],
    body.dark-theme [style*="background: var(--border)"] {
      background: rgba(255, 255, 255, 0.1) !important;
    }
    body.dark-theme [style*="background:var(--bg-card-hover)"],
    body.dark-theme [style*="background: var(--bg-card-hover)"] {
      background: rgba(255, 255, 255, 0.05) !important;
    }
    body.dark-theme [style*="background:var(--bg-card)"],
    body.dark-theme [style*="background: white"],
    body.dark-theme [style*="background:#ffffff"],
    body.dark-theme [style*="background: #ffffff"],
    body.dark-theme [style*="background:#fff"],
    body.dark-theme [style*="background: #fff"] {
      background: var(--bg-secondary) !important;
    }
    /* Fix light gray backgrounds in dark theme */
    body.dark-theme [style*="background:var(--bg-app)"],
    body.dark-theme [style*="background: var(--bg-app)"],
    body.dark-theme [style*="background:var(--bg-card-hover)"],
    body.dark-theme [style*="background: var(--bg-card-hover)"] {
      background: rgba(255, 255, 255, 0.03) !important;
    }

    /* ============ FORMS - Lovable Dark Style ============ */
    .form-group { margin-bottom: 20px; }
    .form-group label { 
      display: block; 
      font-size: 13px; 
      font-weight: 600; 
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 13px;
      font-family: inherit;
      background: var(--bg-app);
      color: var(--text-primary);
      transition: all 0.15s ease;
    }
    .form-group input:hover, .form-group select:hover, .form-group textarea:hover {
      border-color: var(--text-muted);
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--green);
      box-shadow: 0 0 0 3px var(--green-dim);
    }
    .form-group input::placeholder, .form-group textarea::placeholder {
      color: var(--text-muted);
    }
    .form-group select option {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    
    /* ============ ACTIONS ============ */
    .money { font-weight: 600; font-variant-numeric: tabular-nums; }
    .money.positive { color: var(--success); }
    .money.negative { color: var(--danger); }
    
    .actions { display: flex; gap: 8px; flex-wrap: nowrap; white-space: nowrap; }
    .action-btn { 
      padding: 8px 12px;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .action-btn.view { background: var(--success-light); color: var(--success); }
    .action-btn.view:hover { background: rgba(16, 185, 129, 0.25); }
    .action-btn.edit { background: var(--info-light); color: var(--info); }
    .action-btn.edit:hover { background: rgba(59, 130, 246, 0.25); }
    .action-btn.delete { background: var(--danger-light); color: var(--danger); }
    .action-btn.delete:hover { background: rgba(239, 68, 68, 0.25); }
    
    /* ============ TOAST ============ */
    .toast { 
      position: fixed; 
      bottom: 24px; 
      right: 24px; 
      padding: 16px 24px;
      border-radius: var(--radius);
      color: white; 
      font-size: 14px; 
      font-weight: 500;
      z-index: 2000;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideUp 0.3s ease;
    }
    .toast.success { background: linear-gradient(135deg, var(--success) 0%, var(--green) 100%); }
    .toast.error { background: linear-gradient(135deg, var(--danger) 0%, var(--red) 100%); }
    
    /* ============ LOGIN PAGE - Command Center Aesthetic ============ */
    /* Typography imports */
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Geist+Mono:wght@400;500;600&display=swap');

    .login-container {
      min-height: 100vh;
      background: #030808;
      position: relative;
      overflow: hidden;
      font-family: 'Outfit', sans-serif;
    }

    /* Gradient overlay - deeper, more dramatic */
    .login-container::before {
      content: '';
      position: absolute;
      inset: 0;
      background:
        radial-gradient(ellipse at 15% 25%, rgba(34, 197, 94, 0.15) 0%, transparent 45%),
        radial-gradient(ellipse at 85% 75%, rgba(34, 197, 94, 0.08) 0%, transparent 45%),
        radial-gradient(ellipse at 50% 100%, rgba(34, 197, 94, 0.05) 0%, transparent 50%);
      pointer-events: none;
    }

    /* Technical grid overlay */
    .login-container::after {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(34, 197, 94, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(34, 197, 94, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
    }

    /* Rain Particles Container */
    .login-particles {
      position: absolute;
      inset: 0;
      overflow: hidden;
      pointer-events: none;
    }

    /* Individual Rain Particle - Data stream effect */
    .login-particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: var(--primary-500);
      border-radius: 50%;
      opacity: 0;
      box-shadow: 0 0 6px var(--primary-500), 0 0 12px rgba(34,197,94,0.4);
      animation: particleRain linear infinite;
    }

    @keyframes particleRain {
      0% { transform: translateY(-10px); opacity: 0; }
      5% { opacity: 0.8; }
      50% { opacity: 0.5; transform: translateY(50vh); }
      95% { opacity: 0.2; }
      100% { transform: translateY(105vh); opacity: 0; }
    }

    /* Particle distribution - 30 particles */
    .login-particle:nth-child(1) { left: 3%; animation-duration: 18s; animation-delay: 0s; }
    .login-particle:nth-child(2) { left: 8%; animation-duration: 22s; animation-delay: 1.2s; width: 3px; height: 3px; }
    .login-particle:nth-child(3) { left: 13%; animation-duration: 20s; animation-delay: 2.5s; }
    .login-particle:nth-child(4) { left: 18%; animation-duration: 25s; animation-delay: 0.8s; width: 3px; height: 3px; }
    .login-particle:nth-child(5) { left: 23%; animation-duration: 19s; animation-delay: 3.2s; }
    .login-particle:nth-child(6) { left: 28%; animation-duration: 23s; animation-delay: 1.5s; }
    .login-particle:nth-child(7) { left: 33%; animation-duration: 21s; animation-delay: 4.0s; width: 3px; height: 3px; }
    .login-particle:nth-child(8) { left: 38%; animation-duration: 24s; animation-delay: 0.3s; }
    .login-particle:nth-child(9) { left: 43%; animation-duration: 20s; animation-delay: 2.8s; }
    .login-particle:nth-child(10) { left: 48%; animation-duration: 26s; animation-delay: 1.8s; width: 3px; height: 3px; }
    .login-particle:nth-child(11) { left: 53%; animation-duration: 22s; animation-delay: 3.5s; }
    .login-particle:nth-child(12) { left: 58%; animation-duration: 19s; animation-delay: 0.5s; }
    .login-particle:nth-child(13) { left: 63%; animation-duration: 24s; animation-delay: 2.2s; width: 3px; height: 3px; }
    .login-particle:nth-child(14) { left: 68%; animation-duration: 21s; animation-delay: 4.5s; }
    .login-particle:nth-child(15) { left: 73%; animation-duration: 25s; animation-delay: 1.0s; }
    .login-particle:nth-child(16) { left: 78%; animation-duration: 20s; animation-delay: 3.8s; width: 3px; height: 3px; }
    .login-particle:nth-child(17) { left: 83%; animation-duration: 23s; animation-delay: 0.7s; }
    .login-particle:nth-child(18) { left: 88%; animation-duration: 18s; animation-delay: 2.0s; }
    .login-particle:nth-child(19) { left: 93%; animation-duration: 26s; animation-delay: 4.2s; width: 3px; height: 3px; }
    .login-particle:nth-child(20) { left: 97%; animation-duration: 21s; animation-delay: 1.3s; }
    .login-particle:nth-child(21) { left: 5%; animation-duration: 24s; animation-delay: 5.5s; }
    .login-particle:nth-child(22) { left: 15%; animation-duration: 19s; animation-delay: 6.2s; width: 3px; height: 3px; }
    .login-particle:nth-child(23) { left: 25%; animation-duration: 22s; animation-delay: 7.0s; }
    .login-particle:nth-child(24) { left: 35%; animation-duration: 25s; animation-delay: 5.8s; }
    .login-particle:nth-child(25) { left: 45%; animation-duration: 20s; animation-delay: 6.5s; width: 3px; height: 3px; }
    .login-particle:nth-child(26) { left: 55%; animation-duration: 23s; animation-delay: 7.5s; }
    .login-particle:nth-child(27) { left: 65%; animation-duration: 18s; animation-delay: 5.2s; }
    .login-particle:nth-child(28) { left: 75%; animation-duration: 26s; animation-delay: 6.8s; width: 3px; height: 3px; }
    .login-particle:nth-child(29) { left: 85%; animation-duration: 21s; animation-delay: 7.2s; }
    .login-particle:nth-child(30) { left: 95%; animation-duration: 24s; animation-delay: 5.0s; }
    
    /* Navigation Bar */
    .login-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 60px;
      position: relative;
      z-index: 10;
    }

    .login-nav-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: var(--font-sans, 'Inter', sans-serif);
      font-size: 22px;
      font-weight: 700;
      color: white;
    }

    .login-nav-logo-icon {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--green) 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
    }
    
    .login-nav-links {
      display: flex;
      align-items: center;
      gap: 32px;
    }
    
    .login-nav-links a {
      color: rgba(255,255,255,0.8);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: color 0.2s;
    }
    
    .login-nav-links a:hover {
      color: white;
    }
    
    .login-nav-buttons {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .login-nav-btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    
    .login-nav-btn.register {
      background: var(--blue);
      color: white;
    }
    
    .login-nav-btn.register:hover {
      background: var(--blue);
    }
    
    .login-nav-btn.login {
      background: white;
      color: var(--bg-card);
    }
    
    .login-nav-btn.login:hover {
      background: var(--bg-card-hover);
    }
    
    .login-nav-lang {
      color: rgba(255,255,255,0.8);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* Hero Section */
    .login-hero {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 40px 60px 80px;
      gap: 60px;
      min-height: calc(100vh - 100px);
    }
    
    .login-hero-content {
      flex: 1;
      max-width: 600px;
    }
    
    .login-hero h1 {
      font-size: 52px;
      font-weight: 700;
      color: white;
      line-height: 1.15;
      margin-bottom: 20px;
      letter-spacing: -1px;
    }
    
    .login-hero h1 span {
      color: var(--blue);
    }
    
    .login-hero-subtitle {
      font-size: 18px;
      color: rgba(255,255,255,0.75);
      margin-bottom: 40px;
      line-height: 1.6;
    }
    
    /* Feature cards grid - 5 cards */
    .login-features {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 40px;
      max-width: 560px;
    }

    .login-feature {
      background: rgba(34, 197, 94, 0.08);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(34, 197, 94, 0.2);
      border-radius: 14px;
      padding: 16px 14px;
      width: calc(33.333% - 8px);
      min-width: 100px;
      transition: all 0.3s ease;
      cursor: pointer;
      text-align: center;
    }

    .login-feature:nth-child(4),
    .login-feature:nth-child(5) {
      width: calc(50% - 6px);
    }

    .login-feature:hover {
      background: rgba(34, 197, 94, 0.18);
      border-color: rgba(34, 197, 94, 0.4);
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(34, 197, 94, 0.15);
    }

    .login-feature-icon {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .login-feature-title {
      font-size: 12px;
      font-weight: 700;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .login-feature-subtitle {
      font-size: 11px;
      color: var(--primary-500);
      font-weight: 600;
      text-transform: uppercase;
      margin-top: 2px;
    }
    
    /* Embedded Auth Form - Premium Dark Card */
    .login-form-card {
      position: relative;
      z-index: 1;
      width: 420px;
      min-width: 400px;
      background: #0a1014;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 24px;
      padding: 48px;
      box-shadow:
        0 25px 50px -12px rgba(0, 0, 0, 0.5),
        0 0 80px rgba(34, 197, 94, 0.08);
    }

    .login-form-card h2 {
      font-family: var(--font-sans, 'Inter', sans-serif);
      font-size: 2rem;
      font-weight: 700;
      color: var(--bg-card-hover);
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--green) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .login-form-card .subtitle {
      font-family: var(--font-mono, 'JetBrains Mono', monospace);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.2em;
      color: var(--text-secondary);
      margin-bottom: 32px;
    }

    .login-form-card .form-group {
      margin-bottom: 20px;
    }

    .login-form-card .form-group label {
      display: block;
      font-family: var(--font-sans, 'Inter', sans-serif);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .login-form-card .form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      font-family: var(--font-sans, 'Inter', sans-serif);
      font-size: 15px;
      transition: all 0.2s ease;
      background: #1a2835;
      color: var(--bg-card-hover);
    }

    .login-form-card .form-group input:focus {
      outline: none;
      border-color: var(--primary-500);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
      background: #141f2a;
    }

    .login-form-card .form-group input::placeholder {
      color: var(--text-secondary);
    }

    .login-form-card .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .login-form-card .btn-submit {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--green) 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-family: var(--font-sans, 'Inter', sans-serif);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: 8px;
      box-shadow:
        0 1px 2px rgba(0, 0, 0, 0.1),
        0 4px 12px rgba(34, 197, 94, 0.25);
    }

    .login-form-card .btn-submit:hover {
      transform: translateY(-1px);
      box-shadow:
        0 2px 4px rgba(0, 0, 0, 0.1),
        0 8px 20px rgba(34, 197, 94, 0.35);
    }

    .login-form-card .form-footer {
      text-align: center;
      margin-top: 24px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .login-form-card .form-footer a {
      color: var(--primary-500);
      font-weight: 600;
      text-decoration: none;
    }

    .login-form-card .form-footer a:hover {
      text-decoration: underline;
    }

    .login-form-card .lang-toggle {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
    }
    
    .login-form-card .lang-btn {
      padding: 8px 16px;
      border: 1px solid var(--border);
      background: white;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .login-form-card .lang-btn:hover {
      background: var(--bg-card-hover);
    }
    
    .login-form-card .lang-btn.active {
      background: var(--blue);
      color: white;
      border-color: var(--blue);
    }
    
    .login-error { 
      background: var(--red-dim);
      color: var(--red);
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 13px;
      font-weight: 500;
      display: none;
    }
    
    .login-error.show {
      display: block;
    }
    
    /* Truck decoration */
    .login-truck-decoration {
      position: absolute;
      bottom: 30px;
      right: 60px;
      font-size: 100px;
      opacity: 0.15;
    }
    
    /* Route line decoration */
    .login-route-line {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 100%;
      pointer-events: none;
      opacity: 0.3;
    }
    
    /* Footer */
    .login-footer-bar {
      display: flex;
      justify-content: center;
      gap: 24px;
      padding: 24px;
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
    }
    
    .login-footer-bar a {
      color: rgba(255,255,255,0.6);
      font-size: 20px;
      text-decoration: none;
      transition: color 0.2s;
    }
    
    .login-footer-bar a:hover {
      color: white;
    }
    
    /* Dark theme */
    body.dark-theme .login-form-card {
      background: var(--bg-card);
    }
    
    body.dark-theme .login-form-card h2 {
      color: var(--bg-app);
    }
    
    body.dark-theme .login-form-card .subtitle {
      color: var(--text-muted);
    }
    
    body.dark-theme .login-form-card .form-group label {
      color: var(--text-secondary);
    }
    
    body.dark-theme .login-form-card .form-group input {
      background: var(--bg-card);
      border-color: var(--text-secondary);
      color: var(--bg-app);
    }
    
    body.dark-theme .login-form-card .lang-btn {
      background: var(--bg-card);
      border-color: var(--text-secondary);
      color: var(--text-secondary);
    }
    
    /* Mobile responsive */
    @media (max-width: 1024px) {
      .login-nav {
        padding: 16px 24px;
      }
      
      .login-nav-links {
        display: none;
      }
      
      .login-hero {
        flex-direction: column;
        padding: 30px 24px 60px;
        gap: 40px;
        text-align: center;
      }
      
      .login-hero-content {
        max-width: 100%;
      }
      
      .login-hero h1 {
        font-size: 36px;
      }
      
      .login-hero-subtitle {
        font-size: 16px;
        margin-bottom: 24px;
      }
      
      .login-features {
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 24px;
        max-width: 100%;
      }

      .login-feature {
        width: calc(33.333% - 8px);
        min-width: 90px;
        padding: 14px 10px;
      }

      .login-feature:nth-child(4),
      .login-feature:nth-child(5) {
        width: calc(50% - 6px);
      }
      
      .login-form-card {
        width: 100%;
        min-width: auto;
        max-width: 400px;
      }
      
      .login-truck-decoration {
        display: none;
      }
    }
    
    @media (max-width: 600px) {
      .login-hero {
        padding-bottom: 91px;
      }

      .login-hero h1 {
        font-size: 24px;
      }

      .login-hero-subtitle {
        font-size: 14px;
      }

      .login-features {
        gap: 8px;
        margin-top: 20px;
      }

      .login-feature {
        width: calc(33.333% - 6px);
        min-width: 80px;
        padding: 10px 6px;
      }

      .login-feature:nth-child(4),
      .login-feature:nth-child(5) {
        width: calc(50% - 4px);
      }

      .login-feature-icon {
        font-size: 22px;
        margin-bottom: 6px;
      }

      .login-feature-title {
        font-size: 10px;
      }

      .login-feature-subtitle {
        font-size: 9px;
      }

      .login-form-card {
        padding: 28px 24px;
      }

      .login-nav-btn.register {
        display: none;
      }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
      border-radius: var(--radius-sm);
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
    
    /* ============ LOADING ============ */
    .loading { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      padding: 60px;
      color: var(--text-muted);
      font-weight: 500;
    }
    .spinner { 
      width: 28px; 
      height: 28px; 
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%; 
      animation: spin 0.8s linear infinite;
      margin-right: 14px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* ============ DRIVER CARDS ============ */
    .drivers-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
      gap: 24px;
    }
    /* ============ DRIVER CARDS - Adapts to Theme ============ */
    .driver-card { 
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow);
      transition: var(--transition);
      border: 1px solid var(--border);
    }
    .driver-card:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow-lg);
    }
    .driver-avatar { 
      width: 48px; 
      height: 48px; 
      border-radius: 50%;
      background: var(--primary);
      color: white; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-weight: 600;
      font-size: 16px;
    }
    .driver-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .driver-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .driver-cut {
      font-size: 13px;
      color: var(--text-muted);
    }
    .driver-contact {
      font-size: 13px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
    }
    .driver-badges {
      display: flex;
      gap: 8px;
      margin: 12px 0;
      flex-wrap: wrap;
    }
    .driver-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 6px;
      font-weight: 500;
    }
    .driver-badge.qual { background: var(--info-light); color: var(--info); }
    .driver-badge.personal { background: rgba(139, 92, 246, 0.15); color: var(--purple); }
    .driver-badge.expired { background: var(--danger-light); color: var(--danger); }
    .driver-stats {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      margin-top: 12px;
    }
    .driver-stat {
      text-align: center;
    }
    .driver-stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }
    .driver-stat-value.green { color: var(--success); }
    .driver-stat-label {
      font-size: 11px;
      color: var(--text-muted);
    }
    .driver-actions {
      display: flex;
      gap: 8px;
    }
    .driver-action-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s;
    }
    .driver-action-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }
    .driver-action-btn.danger:hover {
      background: var(--danger-light);
      color: var(--danger);
    }
    
    /* ============ SETTINGS PANEL ============ */
    .settings-panel {
      padding: 12px;
      border-top: 1px solid var(--border);
    }
    .settings-row {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }
    .settings-btn {
      flex: 1;
      padding: 8px 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: var(--transition);
      font-family: inherit;
    }
    .settings-btn:hover {
      background: var(--primary-light);
      color: var(--primary);
      border-color: var(--primary);
    }
    .settings-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    /* ============ LIGHT MODE CHAT STYLING ============ */
    .chat-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .chat-header {
      background: linear-gradient(135deg, var(--bg-app) 0%, var(--bg-card) 100%);
      border-bottom: 2px solid var(--border);
    }
    
    .chat-header h2 {
      color: var(--bg-card);
    }
    
    .chat-messages {
      background: linear-gradient(180deg, var(--bg-card-hover) 0%, var(--border) 100%);
    }
    
    .chat-input-area {
      background: var(--bg-card);
      border-top: 2px solid var(--border);
      box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
    }

    /* Message bubbles - light mode */
    .chat-msg-other {
      background: var(--bg-card);
      color: var(--bg-card);
      border: 1px solid var(--border);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .chat-msg-own {
      background: linear-gradient(135deg, var(--primary-500) 0%, var(--green) 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
    }
    
    /* Light mode mini-chat enhancements */
    .mini-chat-messages {
      background: linear-gradient(180deg, var(--bg-card-hover) 0%, var(--border) 100%);
    }
    
    .mini-chat-window {
      border: 1px solid var(--border);
      box-shadow: 0 10px 50px rgba(0,0,0,0.15);
    }
    
    .mini-chat-input-area input {
      background: var(--bg-card);
      border: 2px solid var(--border);
    }
    
    .mini-chat-input-area input:focus {
      border-color: var(--primary-500);
      outline: none;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }
    
    /* Dark mode chat overrides */
    body.dark-theme .chat-container {
      background: var(--bg-card);
    }
    
    body.dark-theme .chat-header {
      background: var(--bg-card);
      border-bottom-color: var(--border);
    }
    
    body.dark-theme .chat-header h2 {
      color: var(--text-primary);
    }
    
    body.dark-theme .chat-messages {
      background: var(--bg-secondary);
    }
    
    body.dark-theme .chat-input-area {
      background: var(--bg-card);
      border-top-color: var(--border);
    }
    
    body.dark-theme .chat-msg-other {
      background: var(--bg-card);
      color: var(--text-primary);
      border-color: var(--border);
    }
    
    /* Chat online status */
    .chat-online-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--primary-500);
      font-size: 13px;
    }
    
    .chat-online-indicator::before {
      content: '';
      width: 8px;
      height: 8px;
      background: var(--primary-500);
      border-radius: 50%;
      animation: blink 1.5s infinite;
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    
    /* ============ RESPONSIVE ============ */
    @media (max-width: 1024px) {
      .main { padding: 24px; }
      .stats-grid { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    }
    @media (max-width: 768px) { 
      .sidebar { 
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      .sidebar.mobile-open { transform: translateX(0); }
      .main { margin-left: 0; padding: 20px; }
      .form-row { grid-template-columns: 1fr; }
      .header h2 { font-size: 22px; }
      .stat-card .value { font-size: 26px; }
    }
    
    /* ============ DARK THEME - Lovable Style ============ */
    /* Sidebar dark-theme overrides removed  base CSS now uses theme-aware vars */
    /* Topbar/card/table dark-theme overrides removed  base CSS now uses theme-aware vars */
    /* dark-theme form overrides removed  base CSS now uses theme-aware vars */
    /* dark-theme .btn-secondary override removed  base CSS now uses theme-aware vars */
    body.dark-theme .search-box,
    body.dark-theme .search-input-wrap {
      background: var(--bg-tertiary);
      border-color: var(--border);
    }
    body.dark-theme .search-box input,
    body.dark-theme .search-input-wrap input { color: var(--text-primary); }
    body.dark-theme .icon-btn {
      background: var(--bg-tertiary);
      border-color: var(--border);
    }
    body.dark-theme .icon-btn:hover {
      background: var(--bg-hover);
      border-color: var(--primary);
      color: var(--primary);
    }
    body.dark-theme .action-btn {
      background: var(--bg-hover) !important;
      border: 1px solid var(--border) !important;
    }
    body.dark-theme .action-btn.view {
      background: rgba(16, 185, 129, 0.3) !important;
      color: var(--primary-400) !important;
      border-color: rgba(16, 185, 129, 0.4) !important;
    }
    body.dark-theme .action-btn.edit {
      background: rgba(59, 130, 246, 0.3) !important;
      color: var(--blue) !important;
      border-color: rgba(59, 130, 246, 0.4) !important;
    }
    body.dark-theme .action-btn.delete {
      background: rgba(239, 68, 68, 0.3) !important;
      color: var(--red) !important;
      border-color: rgba(239, 68, 68, 0.4) !important;
    }
    body.dark-theme .truck-tabs-container button,
    body.dark-theme .truck-tab {
      background: var(--bg-tertiary) !important;
      border-color: var(--border) !important;
      color: var(--text-secondary) !important;
    }
    body.dark-theme .truck-tabs-container button:hover,
    body.dark-theme .truck-tab:hover {
      background: var(--bg-hover) !important;
      border-color: var(--primary) !important;
    }
    body.dark-theme .truck-tabs-container button.active,
    body.dark-theme .truck-tab.active {
      background: var(--primary) !important;
      border-color: var(--primary) !important;
      color: white !important;
    }
    body.dark-theme .direction-tab {
      background: var(--bg-tertiary);
      border-color: var(--border);
      color: var(--text-secondary);
    }
    body.dark-theme .direction-tab:hover {
      background: var(--bg-hover);
    }
    body.dark-theme .direction-tab.active {
      background: var(--primary);
      color: white;
    }
    body.dark-theme .dashboard-stat-card {
      background: var(--bg-card);
      border-color: var(--border);
    }
    body.dark-theme .dashboard-stat-card.revenue {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, var(--bg-card) 100%);
      border-color: rgba(16, 185, 129, 0.3);
    }
    body.dark-theme .dashboard-stat-card.deductions {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, var(--bg-card) 100%);
      border-color: rgba(245, 158, 11, 0.3);
    }
    body.dark-theme .mini-stat-card {
      background: var(--bg-card);
      border-color: var(--border);
    }
    /* Dashboard stat cards - dark theme */
    body.dark-theme .dashboard-stat-card.costs {
      background: var(--bg-card);
      border-color: var(--border);
    }
    body.dark-theme .dashboard-stat-card.profit {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, var(--bg-card) 100%);
      border-color: rgba(34, 197, 94, 0.3);
    }
    body.dark-theme .dashboard-stat-card.profit.negative {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, var(--bg-card) 100%);
      border-color: rgba(239, 68, 68, 0.3);
    }
    /* Task/table/badge dark-theme overrides removed  base CSS now uses theme-aware vars */
    /* Payment collection cards */
    body.dark-theme [style*="background: #d"], 
    body.dark-theme [style*="background: #e"],
    body.dark-theme [style*="background: #f"],
    body.dark-theme [style*="background:#d"],
    body.dark-theme [style*="background:#e"],
    body.dark-theme [style*="background:#f"] {
      background: var(--bg-card) !important;
      border: 1px solid var(--border) !important;
    }
    /* Money colors  now use var(--green) / var(--red) which auto-handle dark mode */
    /* Expense breakdown bars */
    body.dark-theme .expense-bar {
      background: var(--bg-tertiary);
    }
    /* Top performers cards */
    body.dark-theme .performer-card,
    body.dark-theme [class*="performer"] {
      background: var(--bg-card) !important;
      border-color: var(--border) !important;
    }
    /* KPI cards */
    body.dark-theme .kpi-card {
      background: var(--bg-card);
      border-color: var(--border);
    }
    /* Any remaining light backgrounds */
    body.dark-theme [style*="background: white"],
    body.dark-theme [style*="background:var(--bg-card)"],
    body.dark-theme [style*="background: #fff"],
    body.dark-theme [style*="background:#fff"],
    body.dark-theme [style*="background: rgb(255"],
    body.dark-theme [style*="background:rgb(255"] {
      background: var(--bg-card) !important;
    }
    /* Fix text colors in dark mode overridden backgrounds */
    body.dark-theme [style*="background:var(--bg-card)"] span,
    body.dark-theme [style*="background: white"] span {
      color: var(--text-primary) !important;
    }
    /* Override ALL light-colored inline backgrounds in dark mode */
    body.dark-theme [style*="background:var(--green-dim)"],
    body.dark-theme [style*="background: var(--green-dim)"] {
      background: rgba(34, 197, 94, 0.15) !important;
    }
    body.dark-theme [style*="background:var(--green-dim)"] div,
    body.dark-theme [style*="background: var(--green-dim)"] div {
      color: var(--primary-400) !important;
    }
    body.dark-theme [style*="background:var(--red-dim)"],
    body.dark-theme [style*="background: var(--red-dim)"] {
      background: rgba(239, 68, 68, 0.15) !important;
    }
    body.dark-theme [style*="background:var(--red-dim)"] div,
    body.dark-theme [style*="background: var(--red-dim)"] div {
      color: var(--red) !important;
    }
    body.dark-theme [style*="background:var(--bg-app)"],
    body.dark-theme [style*="background: var(--bg-app)"] {
      background: var(--bg-tertiary) !important;
    }
    body.dark-theme [style*="background:var(--bg-app)"] div,
    body.dark-theme [style*="background: var(--bg-app)"] div {
      color: var(--text-primary) !important;
    }
    body.dark-theme [style*="background:var(--amber-dim)"],
    body.dark-theme [style*="background: var(--amber-dim)"] {
      background: rgba(245, 158, 11, 0.15) !important;
    }
    body.dark-theme [style*="background:var(--amber-dim)"] div,
    body.dark-theme [style*="background: var(--amber-dim)"] div {
      color: var(--amber) !important;
    }
    body.dark-theme [style*="background:var(--blue-dim)"],
    body.dark-theme [style*="background: var(--blue-dim)"] {
      background: rgba(59, 130, 246, 0.15) !important;
    }
    body.dark-theme [style*="background:var(--blue-dim)"] div,
    body.dark-theme [style*="background: var(--blue-dim)"] div {
      color: var(--blue) !important;
    }
    body.dark-theme [style*="background:var(--purple-dim)"],
    body.dark-theme [style*="background: var(--purple-dim)"] {
      background: rgba(139, 92, 246, 0.15) !important;
    }
    body.dark-theme [style*="background:var(--purple-dim)"] div,
    body.dark-theme [style*="background: var(--purple-dim)"] div {
      color: var(--purple) !important;
    }
    body.dark-theme [style*="background:var(--bg-card-hover)"],
    body.dark-theme [style*="background: var(--bg-card-hover)"] {
      background: var(--bg-tertiary) !important;
    }
    body.dark-theme [style*="background:var(--bg-card-hover)"] div,
    body.dark-theme [style*="background: var(--bg-card-hover)"] div {
      color: var(--text-secondary) !important;
    }
    body.dark-theme [style*="background:var(--primary-200)"],
    body.dark-theme [style*="background: var(--primary-200)"] {
      background: rgba(34, 197, 94, 0.2) !important;
    }
    body.dark-theme [style*="background:var(--primary-200)"] div,
    body.dark-theme [style*="background: var(--primary-200)"] div {
      color: var(--primary-400) !important;
    }
    body.dark-theme [style*="background:var(--border)"],
    body.dark-theme [style*="background: var(--border)"] {
      background: var(--bg-tertiary) !important;
    }
    /* Fix text colors in dark theme */
    body.dark-theme [style*="color:var(--green)"] { color: var(--primary-400) !important; }
    body.dark-theme [style*="color: var(--green)"] { color: var(--primary-400) !important; }
    body.dark-theme [style*="color:var(--primary-700)"] { color: var(--primary-400) !important; }
    body.dark-theme [style*="color: var(--primary-700)"] { color: var(--primary-400) !important; }
    body.dark-theme [style*="color:var(--red)"] { color: var(--red) !important; }
    body.dark-theme [style*="color: var(--red)"] { color: var(--red) !important; }
    body.dark-theme [style*="color:var(--amber)"] { color: var(--amber) !important; }
    body.dark-theme [style*="color: var(--amber)"] { color: var(--amber) !important; }
    body.dark-theme [style*="color:var(--amber)"] { color: var(--amber) !important; }
    body.dark-theme [style*="color: var(--amber)"] { color: var(--amber) !important; }
    body.dark-theme [style*="color:var(--blue)"] { color: var(--blue) !important; }
    body.dark-theme [style*="color: var(--blue)"] { color: var(--blue) !important; }
    /* var(--bg-card) selectors removed  inline styles now use var(--text-primary) which auto-handles dark mode */
    body.dark-theme [style*="color:var(--text-muted)"] { color: var(--text-secondary) !important; }
    body.dark-theme [style*="color: var(--text-secondary)"] { color: var(--text-secondary) !important; }
    body.dark-theme [style*="color:var(--purple)"] { color: var(--purple) !important; }
    body.dark-theme [style*="color: var(--purple)"] { color: var(--purple) !important; }
    /* Progress bars in dark mode */
    body.dark-theme [style*="background:var(--red-dim);height:8px"],
    body.dark-theme [style*="background: var(--red-dim);height:8px"] {
      background: rgba(239, 68, 68, 0.2) !important;
    }
    body.dark-theme [style*="background:var(--amber-dim);height:8px"],
    body.dark-theme [style*="background: var(--amber-dim);height:8px"] {
      background: rgba(245, 158, 11, 0.2) !important;
    }
    body.dark-theme [style*="background:var(--purple-dim);height:8px"],
    body.dark-theme [style*="background: var(--purple-dim);height:8px"] {
      background: rgba(139, 92, 246, 0.2) !important;
    }
    body.dark-theme [style*="background:var(--border);height:8px"],
    body.dark-theme [style*="background: var(--border);height:8px"] {
      background: var(--bg-hover) !important;
    }
    /* Border colors in dark mode */
    body.dark-theme [style*="border:1px solid var(--bg-elevated)"],
    body.dark-theme [style*="border: 1px solid var(--bg-elevated)"] {
      border-color: var(--border) !important;
    }
    body.dark-theme .toggle-switch {
      background: var(--bg-tertiary);
      border-color: var(--border);
    }
    body.dark-theme .toggle-switch.active {
      background: var(--primary);
      border-color: var(--primary);
    }
    body.dark-theme .login-hero {
      background: 
        linear-gradient(135deg, rgba(3, 7, 18, 0.92) 0%, rgba(10, 15, 26, 0.88) 100%),
        url('https://images.unsplash.com/photo-1524661135-423995f22d0b?auto=format&fit=crop&w=2000&q=80');
      background-size: cover;
      background-position: center;
    }
    /* dark-theme modal overrides removed  base CSS now uses theme-aware vars */
    body.dark-theme .mobile-header { background: var(--bg-card); border-bottom: 1px solid var(--border); }
    
    /* ============ MOBILE HAMBURGER MENU ============ */
    .mobile-header {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(135deg, var(--primary-800) 0%, var(--green) 100%);
      z-index: 200;
      padding: 0 16px;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .mobile-header .logo-text {
      color: white;
      font-size: 17px;
      font-weight: 700;
      letter-spacing: -0.3px;
    }
    
    .hamburger {
      width: 42px;
      height: 42px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      background: rgba(255,255,255,0.15);
      border: none;
      padding: 10px;
      border-radius: 10px;
      transition: all 0.2s ease;
    }
    
    .hamburger:active {
      transform: scale(0.95);
      background: rgba(255,255,255,0.2);
    }
    
    .hamburger span {
      display: block;
      width: 20px;
      height: 2px;
      background: white;
      border-radius: 2px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .hamburger.active span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }
    
    .hamburger.active span:nth-child(2) {
      opacity: 0;
      transform: scaleX(0);
    }
    
    .hamburger.active span:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }
    
    .mobile-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 199;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    
    .mobile-overlay.active {
      display: block;
      opacity: 1;
      pointer-events: auto;
    }
    
    /* ============ RESPONSIVE - TABLET (768px - 1024px) ============ */
    @media (max-width: 1024px) {
      .main {
        padding: 24px 20px;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }
      
      .header h2 {
        font-size: 24px;
      }
      
      .table-wrapper {
        overflow-x: auto;
      }
      
      table {
        min-width: 600px;
      }
      
      .modal {
        max-width: 90% !important;
        margin: 20px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 12px;
      }
      
      .form-row .form-group {
        flex: 1 1 100%;
      }
    }
    
    /* ============ RESPONSIVE - MOBILE (< 768px) ============ */
    @media (max-width: 768px) {
      /* === HIDE TOPBAR ON MOBILE (use mobile-header instead) === */
      .topbar {
        display: none !important;
      }
      
      /* === MOBILE HEADER === */
      .mobile-header {
        display: flex;
        background: linear-gradient(135deg, var(--text-primary) 0%, var(--bg-card) 100%);
        box-shadow: 0 2px 12px rgba(0,0,0,0.15);
      }
      
      /* === MOBILE OVERLAY - behind sidebar === */
      .mobile-overlay {
        z-index: 200 !important;
      }
      
      /* === SIDEBAR === */
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 250 !important;
        width: 85%;
        min-width: 200px;
        max-width: 320px;
        padding-top: 60px;
        box-shadow: 4px 0 25px rgba(0,0,0,0.3);
        pointer-events: auto;
      }
      
      .sidebar.mobile-open {
        transform: translateX(0);
      }
      
      .sidebar.mobile-open nav,
      .sidebar.mobile-open .nav-item {
        pointer-events: auto !important;
        position: relative;
        z-index: 251;
      }
      
      .sidebar .sidebar-toggle {
        display: none;
      }
      
      .sidebar .nav-item {
        padding: 14px 18px;
        font-size: 15px;
        border-radius: 12px;
        margin: 3px 10px;
        -webkit-tap-highlight-color: rgba(34, 197, 94, 0.3);
        touch-action: manipulation;
        cursor: pointer;
        user-select: none;
        -webkit-user-select: none;
      }
      
      .sidebar .nav-item:active {
        background: rgba(34, 197, 94, 0.3) !important;
        transform: scale(0.98);
      }
      
      .sidebar .nav-item .icon {
        font-size: 20px;
        width: 28px;
      }
      
      .sidebar .settings-panel {
        padding: 16px;
        margin: 8px;
        background: rgba(255,255,255,0.05);
        border-radius: 12px;
      }
      
      .sidebar .settings-row {
        flex-direction: row;
        gap: 8px;
      }
      
      .sidebar .settings-btn {
        flex: 1;
        padding: 12px;
        font-size: 14px;
        border-radius: 10px;
      }
      
      .sidebar .user-info {
        padding: 16px;
        margin: 8px;
        background: rgba(255,255,255,0.05);
        border-radius: 12px;
      }
      
      .sidebar .logout-btn {
        padding: 14px;
        font-size: 15px;
        border-radius: 10px;
        margin-top: 12px;
      }
      
      /* === MAIN CONTENT === */
      .main {
        margin-left: 0 !important;
        padding: 72px 16px 100px 16px;
        width: 100%;
        min-height: 100vh;
        min-height: -webkit-fill-available;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
        position: relative;
      }
      
      /* Ensure body allows scrolling */
      html {
        height: 100%;
        height: -webkit-fill-available;
        overflow: auto;
      }
      
      body {
        min-height: 100%;
        min-height: -webkit-fill-available;
        overflow: auto;
        position: relative;
      }
      
      /* Fix for app container */
      .app {
        display: block !important;
        min-height: 100vh;
        min-height: -webkit-fill-available;
        overflow: visible;
      }
      
      /* Fix for content not scrolling */
      #main-content {
        height: auto !important;
        min-height: calc(100vh - 72px);
        overflow: visible !important;
      }
      
      /* When menu is open, lock scroll */
      body.menu-open {
        overflow: hidden !important;
        position: fixed;
        width: 100%;
        height: 100%;
      }
      
      /* === PAGE HEADER === */
      .header {
        flex-direction: column;
        align-items: stretch;
        gap: 16px;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }
      
      .header h2 {
        font-size: 22px;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .header-actions {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }
      
      .header-actions .btn,
      .header .btn {
        justify-content: center;
        padding: 14px 12px;
        font-size: 13px;
        font-weight: 600;
        border-radius: 12px;
      }
      
      .header-actions .btn-primary {
        grid-column: span 2;
        background: linear-gradient(135deg, var(--primary) 0%, var(--blue) 100%);
      }
      
      /* === STATS CARDS === */
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-bottom: 20px;
      }
      
      .stat-card {
        padding: 16px;
        border-radius: 16px;
        position: relative;
        overflow: hidden;
      }
      
      .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 60px;
        height: 60px;
        background: currentColor;
        opacity: 0.05;
        border-radius: 0 0 0 60px;
      }
      
      .stat-card .label {
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 6px;
        opacity: 0.8;
      }
      
      .stat-card .value {
        font-size: 20px;
        font-weight: 800;
        letter-spacing: -0.5px;
      }
      
      /* === CARDS === */
      .card {
        padding: 16px;
        border-radius: 16px;
        margin-bottom: 16px;
        border: 1px solid var(--border);
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        overflow: visible;
      }
      
      .card h3 {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--border);
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      /* === TABLES === */
      .table-wrapper {
        margin: 0 -16px;
        padding: 0 16px 16px;
        overflow-x: auto;
        overflow-y: visible;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        position: relative;
      }
      
      /* Scroll hint - fade on right edge */
      .table-wrapper::after {
        content: '';
        position: sticky;
        right: 0;
        top: 0;
        bottom: 0;
        width: 30px;
        background: linear-gradient(90deg, transparent, var(--bg-secondary));
        pointer-events: none;
      }
      
      .table-wrapper::-webkit-scrollbar {
        height: 6px;
      }
      
      .table-wrapper::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
      }
      
      table {
        min-width: 550px;
        font-size: 13px;
        border-collapse: separate;
        border-spacing: 0;
      }
      
      table th {
        padding: 12px 10px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: var(--bg-tertiary);
        position: sticky;
        top: 0;
        z-index: 5;
      }
      
      table th:first-child {
        border-radius: 10px 0 0 0;
      }
      
      table th:last-child {
        border-radius: 0 10px 0 0;
      }
      
      table td {
        padding: 14px 10px;
        border-bottom: 1px solid var(--border-light);
        vertical-align: middle;
      }
      
      table tr:active {
        background: var(--primary-light);
      }
      
      /* === MODALS - Bottom Sheet Style === */
      .modal-overlay {
        padding: 0;
        align-items: flex-end;
        background: rgba(0,0,0,0.6);
      }
      
      .modal {
        max-width: 100% !important;
        width: 100% !important;
        max-height: 92vh !important;
        margin: 0;
        border-radius: 24px 24px 0 0;
        animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
      }
      
      @keyframes slideUp {
        from { 
          transform: translateY(100%);
          opacity: 0.5;
        }
        to { 
          transform: translateY(0);
          opacity: 1;
        }
      }
      
      .modal::before {
        content: '';
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 4px;
        background: var(--border);
        border-radius: 2px;
      }
      
      .modal-header {
        padding: 24px 20px 16px;
        position: sticky;
        top: 0;
        background: var(--bg-secondary);
        z-index: 10;
        border-bottom: 1px solid var(--border);
      }
      
      .modal-header h3 {
        font-size: 20px;
        font-weight: 700;
      }
      
      .modal-close {
        width: 36px;
        height: 36px;
        font-size: 20px;
      }
      
      .modal-body {
        padding: 20px;
        max-height: calc(92vh - 160px);
        overflow-y: auto;
        overscroll-behavior: contain;
      }
      
      .modal-footer {
        padding: 16px 20px;
        padding-bottom: max(16px, env(safe-area-inset-bottom));
        gap: 12px;
        position: sticky;
        bottom: 0;
        background: var(--bg-secondary);
        border-top: 1px solid var(--border);
        box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
      }
      
      .modal-footer .btn {
        flex: 1;
        padding: 16px;
        font-size: 15px;
        font-weight: 600;
        border-radius: 14px;
      }
      
      /* === FORMS === */
      .form-row {
        flex-direction: column;
        gap: 0;
      }
      
      .form-row > div,
      .form-row .form-group {
        flex: 1 1 100% !important;
        width: 100% !important;
      }
      
      .form-group {
        margin-bottom: 16px;
      }
      
      .form-group label {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 8px;
        display: block;
        color: var(--text-secondary);
      }
      
      .form-group input,
      .form-group select,
      .form-group textarea {
        padding: 16px;
        font-size: 16px;
        border-radius: 12px;
        border: 2px solid var(--border);
        transition: all 0.2s ease;
        -webkit-appearance: none;
      }
      
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 4px var(--primary-light);
        outline: none;
      }
      
      .form-group select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 20px;
        padding-right: 44px;
      }
      
      /* === BUTTONS === */
      .btn {
        padding: 14px 20px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 12px;
        min-height: 48px;
        touch-action: manipulation;
      }
      
      .btn:active {
        transform: scale(0.97);
      }
      
      .btn-sm {
        padding: 10px 16px;
        font-size: 13px;
        min-height: 40px;
      }
      
      .btn-primary {
        box-shadow: 0 4px 14px rgba(99, 102, 241, 0.35);
      }
      
      /* === ACTION BUTTONS === */
      .actions {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }
      
      .action-btn {
        padding: 8px 12px;
        font-size: 12px;
        font-weight: 600;
        border-radius: 8px;
        min-height: 36px;
      }
      
      /* === BADGES === */
      .badge {
        font-size: 11px;
        padding: 6px 10px;
        font-weight: 700;
        border-radius: 8px;
        letter-spacing: 0.3px;
      }
      
      /* === DRIVER/TRUCK CARDS === */
      .drivers-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .driver-card {
        padding: 20px;
        border-radius: 16px;
        border: 1px solid var(--border);
      }
      
      .driver-card h3 {
        font-size: 18px;
        margin-bottom: 12px;
      }
      
      /* === TRIP TABS / HORIZONTAL SCROLL TABS === */
      [style*="overflow-x:auto"][style*="white-space:nowrap"] {
        display: flex !important;
        gap: 8px !important;
        padding: 8px 16px !important;
        margin: 0 -16px 0 -16px !important;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }
      
      [style*="overflow-x:auto"][style*="white-space:nowrap"]::-webkit-scrollbar {
        display: none;
      }
      
      [style*="overflow-x:auto"][style*="white-space:nowrap"] button {
        flex-shrink: 0 !important;
        padding: 14px 18px !important;
        font-size: 13px !important;
        border-radius: 12px 12px 0 0 !important;
        min-width: auto !important;
        white-space: nowrap !important;
      }
      
      /* === DASHBOARD GRIDS === */
      [style*="display:grid"][style*="grid-template-columns"]:not(.stats-grid) {
        display: block !important;
      }
      
      [style*="display:grid"]:not(.stats-grid) > div {
        margin-bottom: 16px;
      }
      
      /* === PAYMENT BOXES === */
      [style*="grid-template-columns:repeat(auto-fit"] {
        display: grid !important;
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 10px !important;
      }
      
      [style*="grid-template-columns:repeat(auto-fit"] > div {
        padding: 14px !important;
        border-radius: 12px !important;
      }
      
      /* === INFO BOXES === */
      [style*="background:var(--blue-dim)"],
      [style*="background:var(--green-dim)"],
      [style*="background:var(--amber-dim)"],
      [style*="background:var(--red-dim)"],
      [style*="background:var(--green-dim)"] {
        padding: 16px !important;
        border-radius: 14px !important;
        margin-bottom: 16px !important;
        font-size: 14px !important;
      }
      
      /* === AUTOCOMPLETE DROPDOWNS === */
      [id$="-dropdown"] {
        max-height: 200px !important;
        border-radius: 12px !important;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15) !important;
      }
      
      [id$="-dropdown"] > div {
        padding: 14px 16px !important;
        font-size: 15px !important;
      }
      
      /* === TOAST NOTIFICATIONS === */
      .toast {
        left: 16px !important;
        right: 16px !important;
        bottom: 90px !important;
        max-width: none !important;
        border-radius: 14px !important;
        padding: 16px 20px !important;
        font-size: 14px !important;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2) !important;
      }
      
      /* === LOGIN PAGE === */
      /* Login styles are in main login section */
      
      /* === FLOATING ACTION HINT === */
      .scroll-hint {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--text-primary);
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 500;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 50;
      }
      
      .scroll-hint.visible {
        opacity: 0.9;
      }
      
      /* === SAFE AREA FOR NOTCHED PHONES === */
      @supports (padding-bottom: env(safe-area-inset-bottom)) {
        .main {
          padding-bottom: calc(100px + env(safe-area-inset-bottom));
        }
        
        .mobile-header {
          padding-top: env(safe-area-inset-top);
          height: calc(60px + env(safe-area-inset-top));
        }
        
        .sidebar {
          padding-top: calc(60px + env(safe-area-inset-top));
        }
      }
    }
    
    /* ============ RESPONSIVE UTILITY CLASSES ============ */
    @media (max-width: 768px) {
      /* Force flex items to wrap - but not for tabs */
      [style*="display:flex"]:not(.truck-tabs-container),
      [style*="display: flex"]:not(.truck-tabs-container) {
        flex-wrap: wrap !important;
      }
      
      /* Make inline grids responsive - 2 columns on tablet */
      [style*="display:grid"]:not(.truck-tabs-container),
      [style*="display: grid"]:not(.truck-tabs-container) {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
      }
      
      /* Two column layouts become single */
      [style*="grid-template-columns: 1fr 1fr"],
      [style*="grid-template-columns:1fr 1fr"] {
        grid-template-columns: 1fr !important;
      }
      
      /* Fix Financial Analysis gradient box */
      [style*="linear-gradient"] {
        padding: 16px !important;
        border-radius: 12px !important;
      }
      
      /* Financial Analysis Dark Mode Support */
      body.dark-theme .fin-metric-card {
        background: var(--bg-card) !important;
        border-color: var(--bg-card) !important;
      }
      /* fin-metric-card var(--bg-card) selector removed  inline styles now use var(--text-primary) */
      body.dark-theme .fin-metric-card div[style*="color:var(--text-muted)"] {
        color: var(--text-muted) !important;
      }
      body.dark-theme .fin-metric-card div[style*="background:var(--blue-dim)"],
      body.dark-theme .fin-metric-card div[style*="background:var(--green-dim)"],
      body.dark-theme .fin-metric-card div[style*="background:var(--amber-dim)"],
      body.dark-theme .fin-metric-card div[style*="background:var(--blue-dim)"],
      body.dark-theme .fin-metric-card div[style*="background:var(--red-dim)"],
      body.dark-theme .fin-metric-card div[style*="background:var(--purple-dim)"] {
        opacity: 0.9;
      }
      body.dark-theme [style*="background:var(--bg-app)"],
      body.dark-theme [style*="background: var(--bg-app)"] {
        background: var(--bg-card) !important;
      }
      body.dark-theme [style*="background:var(--bg-card-hover)"],
      body.dark-theme [style*="background: var(--bg-card-hover)"] {
        background: var(--bg-card) !important;
      }
      body.dark-theme [style*="background:var(--bg-card)"],
      body.dark-theme [style*="background: white"] {
        background: var(--bg-card) !important;
      }
      body.dark-theme [style*="color:var(--bg-card)"],
      body.dark-theme [style*="color: var(--bg-card)"] {
        color: var(--text-secondary) !important;
      }
      body.dark-theme [style*="border:1px solid var(--border)"],
      body.dark-theme [style*="border: 1px solid var(--border)"] {
        border-color: var(--text-secondary) !important;
      }
      body.dark-theme details summary {
        background: var(--amber) !important;
      }
      
      /* Form rows with inline gap */
      [style*="gap:16px"],
      [style*="gap: 16px"] {
        gap: 12px !important;
      }
      
      /* Fix min-width items */
      [style*="min-width:180px"],
      [style*="min-width: 180px"],
      [style*="min-width:200px"],
      [style*="min-width: 200px"],
      [style*="min-width:140px"],
      [style*="min-width: 140px"] {
        min-width: unset !important;
        width: 100% !important;
      }
      
      /* Truck tabs should scroll horizontally */
      .truck-tabs-container {
        display: flex !important;
        flex-wrap: nowrap !important;
        overflow-x: scroll !important;
        overflow-y: hidden !important;
        -webkit-overflow-scrolling: touch !important;
        padding-bottom: 10px;
        max-width: 100% !important;
        width: 100% !important;
      }
      
      .truck-tabs-container button,
      .truck-tabs-container .truck-tab,
      .truck-tab {
        flex-shrink: 0 !important;
        white-space: nowrap !important;
      }
    }
    
    /* ============ RESPONSIVE - SMALL MOBILE (< 480px) ============ */
    @media (max-width: 480px) {
      .main {
        padding: 68px 12px 100px 12px;
      }
      
      .header h2 {
        font-size: 20px;
      }
      
      .header-actions {
        grid-template-columns: 1fr;
      }
      
      .header-actions .btn-primary {
        grid-column: span 1;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .stat-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 16px;
      }
      
      .stat-card .label {
        margin-bottom: 0;
        order: 1;
      }
      
      .stat-card .value {
        font-size: 22px;
        order: 2;
      }
      
      table {
        font-size: 12px;
        min-width: 480px;
      }
      
      table th, table td {
        padding: 10px 8px;
      }
      
      .modal-header h3 {
        font-size: 18px;
      }
      
      .modal-body {
        padding: 16px;
      }
      
      .card {
        padding: 14px;
        border-radius: 14px;
      }
      
      .card h3 {
        font-size: 15px;
      }
      
      .form-group input,
      .form-group select {
        padding: 14px;
      }
      
      [style*="grid-template-columns:repeat(auto-fit"] {
        grid-template-columns: 1fr !important;
      }
      
      [style*="grid-template-columns: repeat(auto-fit"] {
        grid-template-columns: 1fr !important;
      }
      
      /* Force all inline flex containers to wrap - except tabs */
      [style*="display:flex"]:not(.truck-tabs-container),
      [style*="display: flex"]:not(.truck-tabs-container) {
        flex-wrap: wrap !important;
      }
      
      /* Force all inline grids to single column */
      [style*="display:grid"]:not(.truck-tabs-container),
      [style*="display: grid"]:not(.truck-tabs-container) {
        grid-template-columns: 1fr !important;
      }
      
      /* Truck tabs should still scroll */
      .truck-tabs-container {
        display: flex !important;
        flex-wrap: nowrap !important;
        overflow-x: scroll !important;
        overflow-y: hidden !important;
        -webkit-overflow-scrolling: touch !important;
        padding-bottom: 10px;
        margin-left: -12px;
        margin-right: -12px;
        padding-left: 12px;
        padding-right: 12px;
        max-width: calc(100% + 24px) !important;
      }
      
      .truck-tabs-container button,
      .truck-tabs-container .truck-tab,
      .truck-tab {
        padding: 10px 14px !important;
        font-size: 12px !important;
        flex-shrink: 0 !important;
        white-space: nowrap !important;
      }
      
      /* Ensure gradient headers stay nice */
      [style*="linear-gradient"] {
        border-radius: 8px !important;
      }
      
      .driver-card {
        padding: 16px;
      }
      
      .driver-card h3 {
        font-size: 16px;
      }
    }
    
    /* ============ PRINT STYLES === */
    @media print {
      .mobile-header,
      .sidebar,
      .hamburger,
      .modal-overlay {
        display: none !important;
      }
      
      .main {
        margin: 0 !important;
        padding: 20px !important;
      }
    }
    
    /* ============ MOBILE SWIPE ACTIONS ============ */
    .swipe-container {
      position: relative;
      overflow: hidden;
      touch-action: pan-y;
    }
    
    .swipe-content {
      position: relative;
      background: var(--bg-card);
      transition: transform 0.3s ease;
      z-index: 2;
    }
    
    .swipe-actions {
      position: absolute;
      top: 0;
      bottom: 0;
      display: flex;
      align-items: stretch;
      z-index: 1;
    }
    
    .swipe-actions-left {
      left: 0;
      justify-content: flex-start;
    }
    
    .swipe-actions-right {
      right: 0;
      justify-content: flex-end;
    }
    
    .swipe-action {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 24px;
      color: white;
      font-weight: 600;
      font-size: 13px;
      gap: 8px;
      min-width: 80px;
    }
    
    .swipe-action-edit {
      background: var(--blue);
    }
    
    .swipe-action-delete {
      background: var(--red);
    }
    
    .swipe-action-complete {
      background: var(--primary-500);
    }
    
    .swipe-action-call {
      background: var(--purple);
    }
    
    /* ============ MOBILE LIST CARDS ============ */
    @media (max-width: 768px) {
      .mobile-list-item {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        border: 1px solid var(--border);
        position: relative;
        overflow: hidden;
      }
      
      .mobile-list-item:active {
        background: var(--bg-hover);
      }
      
      .mobile-list-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }
      
      .mobile-list-title {
        font-weight: 600;
        font-size: 15px;
        color: var(--text-primary);
      }
      
      .mobile-list-subtitle {
        font-size: 13px;
        color: var(--text-muted);
        margin-top: 2px;
      }
      
      .mobile-list-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
      }
      
      .mobile-list-body {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        font-size: 13px;
      }
      
      .mobile-list-field {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      
      .mobile-list-field-label {
        font-size: 10px;
        text-transform: uppercase;
        color: var(--text-muted);
        font-weight: 600;
      }
      
      .mobile-list-field-value {
        color: var(--text-primary);
        font-weight: 500;
      }
      
      .mobile-list-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid var(--border);
      }
      
      .mobile-list-action {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        border: none;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        min-height: 44px;
        touch-action: manipulation;
      }
      
      .mobile-list-action-primary {
        background: var(--primary);
        color: white;
      }
      
      .mobile-list-action-secondary {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }
      
      .mobile-list-action-danger {
        background: var(--red-dim);
        color: var(--red);
      }
    }
    
    /* ============ FLOATING ACTION BUTTON ============ */
    @media (max-width: 768px) {
      .fab {
        position: fixed;
        bottom: calc(24px + env(safe-area-inset-bottom, 0px));
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--primary) 0%, var(--green) 100%);
        color: white;
        border: none;
        font-size: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
        cursor: pointer;
        z-index: 100;
        touch-action: manipulation;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      
      .fab:active {
        transform: scale(0.92);
        box-shadow: 0 2px 10px rgba(34, 197, 94, 0.3);
      }
      
      /* Add bottom padding to main content when FAB is present */
      .has-fab .main {
        padding-bottom: calc(120px + env(safe-area-inset-bottom, 0px)) !important;
      }
    }
    
    /* ============ ENHANCED TOUCH TARGETS ============ */
    @media (max-width: 768px) {
      /* All interactive elements minimum 44px */
      button, 
      a, 
      input[type="checkbox"], 
      input[type="radio"],
      select,
      .clickable,
      [onclick] {
        min-height: 44px;
        min-width: 44px;
      }
      
      /* Table action buttons */
      table .btn,
      table button {
        padding: 10px 14px !important;
        min-height: 40px;
        font-size: 12px !important;
      }
      
      /* Checkbox and radio larger */
      input[type="checkbox"],
      input[type="radio"] {
        width: 22px;
        height: 22px;
        cursor: pointer;
      }
      
      /* Better tap states */
      button:active,
      a:active,
      .clickable:active,
      [onclick]:active {
        opacity: 0.8;
        transform: scale(0.98);
      }
      
      /* Search input */
      input[type="search"],
      input[type="text"],
      input[placeholder*="Search"],
      input[placeholder*=""] {
        min-height: 48px;
        font-size: 16px !important; /* Prevents iOS zoom */
      }
      
      /* Filter dropdowns */
      .filter-group select {
        min-height: 44px;
        padding: 12px 40px 12px 14px;
      }
      
      /* Notification dropdown */
      .notification-dropdown {
        width: calc(100vw - 24px);
        right: -60px;
        max-width: 400px;
      }
      
      .notification-item {
        padding: 16px;
        min-height: 72px;
      }
    }
    
    /* ============ MOBILE CHAT IMPROVEMENTS ============ */
    @media (max-width: 768px) {
      .chat-container {
        height: calc(100vh - 80px) !important;
        max-width: 100% !important;
      }
      
      .chat-header {
        padding: 12px 16px !important;
        border-radius: 0 !important;
      }
      
      .chat-header h2 {
        font-size: 18px !important;
      }
      
      .chat-messages {
        padding: 12px !important;
      }
      
      .chat-input-area {
        padding: 12px !important;
        padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px)) !important;
      }
      
      #chatInput {
        font-size: 16px !important; /* Prevents iOS zoom */
        min-height: 44px !important;
        padding: 12px !important;
      }
      
      #mentionDropdown {
        max-height: 180px;
      }
    }
    
    /* ============ PULL TO REFRESH INDICATOR ============ */
    .pull-refresh-indicator {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%) translateY(-60px);
      background: var(--bg-card);
      padding: 10px 20px;
      border-radius: 24px;
      box-shadow: var(--shadow-lg);
      z-index: 100;
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: var(--text-muted);
    }
    
    .pull-refresh-indicator.visible {
      transform: translateX(-50%) translateY(0);
    }
    
    .pull-refresh-indicator .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    /* ============ MOBILE LIVE MAP ============ */
    @media (max-width: 768px) {
      #liveMapContainer {
        height: 50vh !important;
        min-height: 300px !important;
        border-radius: 12px !important;
      }
      
      #truckListPanel {
        width: 100% !important;
        height: auto !important;
        max-height: 40vh;
        margin-top: 12px;
      }
      
      /* Stack map and list vertically */
      .live-map-layout {
        flex-direction: column !important;
      }
    }
    
    /* ============ BOTTOM SHEET MENU (for actions) ============ */
    .bottom-sheet-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    .bottom-sheet-overlay.open {
      opacity: 1;
      visibility: visible;
    }
    
    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border-radius: 20px 20px 0 0;
      padding: 8px 0;
      padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      z-index: 1001;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .bottom-sheet-overlay.open .bottom-sheet {
      transform: translateY(0);
    }
    
    .bottom-sheet::before {
      content: '';
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: 40px;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
    }
    
    .bottom-sheet-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 24px;
      font-size: 16px;
      color: var(--text-primary);
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      min-height: 56px;
    }
    
    .bottom-sheet-item:active {
      background: var(--bg-hover);
    }
    
    .bottom-sheet-item-icon {
      width: 24px;
      text-align: center;
      font-size: 20px;
    }
    
    .bottom-sheet-item-danger {
      color: var(--red);
    }
    
    .bottom-sheet-divider {
      height: 1px;
      background: var(--border);
      margin: 8px 24px;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--text-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    
    .loading-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    
    .loading-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 40px;
      color: white;
      animation: loadingFadeInUp 0.5s ease;
    }
    
    .loading-logo-icon {
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, var(--green) 0%, var(--primary-400) 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
    }
    
    .loading-logo span {
      color: var(--green);
    }
    
    .loading-truck {
      position: relative;
      width: 200px;
      height: 60px;
      margin-bottom: 30px;
    }
    
    .truck {
      font-size: 50px;
      position: absolute;
      animation: driveTruck 2s ease-in-out infinite;
    }
    
    @keyframes driveTruck {
      0% { left: -60px; }
      50% { left: calc(50% - 25px); }
      100% { left: calc(100% + 10px); }
    }
    
    .road {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 2px;
      overflow: hidden;
    }
    
    .road::after {
      content: '';
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 100%;
      height: 2px;
      background: repeating-linear-gradient(90deg, var(--amber) 0px, var(--amber) 20px, transparent 20px, transparent 40px);
      animation: roadMove 0.5s linear infinite;
    }
    
    @keyframes roadMove {
      0% { transform: translateY(-50%) translateX(0); }
      100% { transform: translateY(-50%) translateX(-40px); }
    }
    
    .loading-text {
      font-size: 16px;
      color: rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .loading-dots {
      display: flex;
      gap: 4px;
    }
    
    .loading-dots span {
      width: 6px;
      height: 6px;
      background: var(--green);
      border-radius: 50%;
      animation: loadingBounce 1.4s infinite ease-in-out both;
    }
    
    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    .loading-dots span:nth-child(3) { animation-delay: 0s; }
    
    @keyframes loadingBounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    
    @keyframes loadingFadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* 
        MODERN UI/UX IMPROVEMENTS v3.0 - Comprehensive Design System
        */
    
    /* ============ MICRO-INTERACTIONS & ANIMATIONS ============ */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(16px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.96); }
      to { opacity: 1; transform: scale(1); }
    }
    
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(24px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-24px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    @keyframes pulse-soft {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }
    
    @keyframes ripple {
      0% { transform: scale(0); opacity: 0.4; }
      100% { transform: scale(4); opacity: 0; }
    }
    
    @keyframes gradient-shift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    @keyframes border-glow {
      0%, 100% { border-color: var(--primary); box-shadow: 0 0 8px rgba(34, 197, 94, 0.3); }
      50% { border-color: var(--primary-hover); box-shadow: 0 0 16px rgba(34, 197, 94, 0.5); }
    }
    
    /* Page entry animation - premium */
    .main {
      animation: pageEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes pageEnter {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* ============ ENHANCED TYPOGRAPHY ============ */
    .text-truncate {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
    }
    
    .text-truncate-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .text-truncate-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .text-wrap {
      white-space: normal;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    /* ============ ENHANCED CARDS ============ */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow-card);
      overflow: hidden;
      transition: all var(--duration-normal) var(--ease-smooth);
      position: relative;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity var(--duration-fast);
    }
    
    .card:hover {
      border-color: rgba(34, 197, 94, 0.3);
      box-shadow: var(--shadow-card-hover);
      transform: translateY(-2px);
    }
    
    .card:hover::before {
      opacity: 1;
    }
    
    .card-header {
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--bg-card);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card-header h3 {
      font-size: var(--text-md);
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.3px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .card-header h3 .icon {
      font-size: 18px;
      opacity: 0.85;
    }
    
    .card-body {
      padding: 0;
    }
    
    /* Glass card variant */
    .card-glass {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
    }
    
    /* ============ ENHANCED STAT CARDS - Premium Treatment ============ */
    .stat-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-card);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    /* Gradient overlay on hover */
    .stat-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0) 100%);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    /* Top accent line - animated */
    .stat-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--gradient-primary);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-card-hover), 0 0 30px rgba(34, 197, 94, 0.08);
      border-color: rgba(34, 197, 94, 0.3);
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-card:hover::after {
      transform: scaleX(1);
    }

    /* Stat icon - premium treatment */
    .stat-card .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stat-card:hover .stat-icon {
      transform: scale(1.08);
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.2);
    }

    /* Label - monospace uppercase */
    .stat-card .label {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    /* Value - large monospace numbers */
    .stat-card .value {
      font-family: var(--font-mono);
      font-size: var(--text-3xl);
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1;
      color: var(--text-primary);
    }

    .stat-card .value.green {
      color: var(--primary);
      text-shadow: 0 0 30px rgba(34, 197, 94, 0.3);
    }
    .stat-card .value.red { color: var(--danger); }
    .stat-card .value.orange { color: var(--warning); }
    .stat-card .value.blue { color: var(--accent); }

    /* Trend badge */
    .stat-card .trend {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 4px 10px;
      border-radius: 6px;
      margin-top: 12px;
    }

    .stat-card .trend::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .stat-card .trend.up {
      background: rgba(34, 197, 94, 0.1);
      color: var(--primary);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .stat-card .trend.down {
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    /* Revenue card - hero treatment with glow */
    .stat-card.revenue,
    .stat-card.green-header {
      background:
        radial-gradient(ellipse at top right, rgba(34, 197, 94, 0.1) 0%, transparent 50%),
        var(--bg-tertiary);
      border-color: rgba(34, 197, 94, 0.2);
    }

    .stat-card.revenue .value,
    .stat-card.green-header .value {
      color: var(--primary);
      text-shadow: 0 0 30px rgba(34, 197, 94, 0.3);
    }
    
    /* ============ ENHANCED BUTTONS - Tactile & Premium ============ */
    .btn {
      position: relative;
      font-family: var(--font-sans);
      font-size: var(--text-sm);
      font-weight: 600;
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    /* Primary button - hero green with layered shadows */
    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      box-shadow:
        0 1px 2px rgba(0, 0, 0, 0.1),
        0 4px 12px rgba(34, 197, 94, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow:
        0 2px 4px rgba(0, 0, 0, 0.1),
        0 8px 20px rgba(34, 197, 94, 0.35),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow:
        0 1px 2px rgba(0, 0, 0, 0.1),
        0 2px 8px rgba(34, 197, 94, 0.2),
        inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Secondary button - ghost style */
    .btn-secondary {
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
      border-color: var(--primary);
      color: var(--primary);
    }

    /* Small button variant */
    .btn-sm {
      padding: 8px 14px;
      font-size: 12px;
      border-radius: 8px;
    }

    /* Icon buttons */
    .btn-icon {
      width: 40px;
      height: 40px;
      padding: 0;
      border-radius: 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .btn-icon:hover {
      background: var(--bg-secondary);
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
      transform: scale(1.05);
    }
    
    /* ============ ENHANCED TABLES - Premium Data Display ============ */
    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 0 0 16px 16px;
      background: var(--bg-tertiary);
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    /* Header row - bold industrial treatment */
    th {
      text-align: left;
      padding: 14px 16px;
      background: var(--bg-secondary);
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
    }

    th:first-child { border-radius: 0; padding-left: 20px; }
    th:last-child { border-radius: 0; padding-right: 20px; }

    /* Body cells */
    td {
      padding: 16px;
      font-family: var(--font-sans);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
      transition: all 0.15s ease;
      vertical-align: middle;
      background: var(--bg-tertiary);
    }

    td:first-child { padding-left: 20px; }
    td:last-child { padding-right: 20px; }

    /* Text truncation in table cells */
    td {
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    td.wrap {
      white-space: normal;
      max-width: none;
    }

    td.actions-cell {
      white-space: nowrap;
      max-width: none;
    }

    /* Alternate row pattern - subtle stripe */
    tbody tr:nth-child(even) td {
      background: rgba(255, 255, 255, 0.01);
    }

    /* Hover state - sophisticated green tint */
    tr:hover td {
      background: rgba(34, 197, 94, 0.04);
    }

    tr:last-child td {
      border-bottom: none;
    }

    td strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    /* Money columns - monospace with tabular numbers */
    td.money {
      font-family: var(--font-mono);
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      color: var(--primary);
    }

    /* Row number column - accent color */
    .row-number {
      font-family: var(--font-mono);
      font-weight: 600;
      font-size: 12px;
      color: var(--primary);
    }
    
    /* ============ ENHANCED BADGES - Industrial Style ============ */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 6px;
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .badge-green {
      background: rgba(34, 197, 94, 0.1);
      color: var(--primary);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .badge-amber {
      background: rgba(245, 158, 11, 0.1);
      color: var(--amber);
      border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .badge-red {
      background: rgba(239, 68, 68, 0.1);
      color: var(--red);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .badge-blue {
      background: rgba(6, 182, 212, 0.1);
      color: var(--accent);
      border: 1px solid rgba(6, 182, 212, 0.2);
    }

    .badge-purple {
      background: rgba(139, 92, 246, 0.1);
      color: var(--purple);
      border: 1px solid rgba(139, 92, 246, 0.2);
    }

    .badge-gray {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    /* Status badges with animated dot indicator */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 6px;
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }
    
    .status-badge::before {
      content: '';
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse-soft 2s ease-in-out infinite;
    }
    
    .status-badge.success {
      background: rgba(34, 197, 94, 0.12);
      color: var(--green);
    }
    
    .status-badge.warning {
      background: rgba(245, 158, 11, 0.12);
      color: var(--amber);
    }
    
    .status-badge.danger {
      background: rgba(239, 68, 68, 0.12);
      color: var(--red);
    }
    
    .status-badge.info {
      background: rgba(59, 130, 246, 0.12);
      color: var(--blue);
    }
    
    /* ============ ENHANCED FORMS - Refined Inputs ============ */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-family: var(--font-sans);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .form-group label .required {
      color: var(--danger);
      margin-left: 3px;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      font-family: var(--font-sans);
      font-size: var(--text-base);
      padding: 14px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    .form-group input:hover,
    .form-group select:hover,
    .form-group textarea:hover {
      border-color: var(--text-muted);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
      background: var(--bg-secondary);
    }

    .form-group input::placeholder,
    .form-group textarea::placeholder {
      color: var(--text-muted);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    /* ============ ENHANCED SEARCH - Premium Search Box ============ */
    .search-box,
    .search-input-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 12px;
      transition: all 0.2s ease;
    }

    .search-box:focus-within,
    .search-input-wrap:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15);
      background: var(--bg-secondary);
    }

    .search-box input,
    .search-input-wrap input {
      border: none;
      background: none;
      outline: none;
      font-family: var(--font-sans);
      font-size: var(--text-base);
      color: var(--text-primary);
      width: 100%;
    }
    
    /* ============ ENHANCED MODALS - Cinematic Premium ============ */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 24px;
      animation: overlayFadeIn 0.3s ease;
    }

    @keyframes overlayFadeIn {
      from { opacity: 0; backdrop-filter: blur(0); }
      to { opacity: 1; backdrop-filter: blur(8px); }
    }

    .modal {
      background: var(--bg-secondary, #0a1014);
      border: 1px solid var(--border);
      border-radius: 20px;
      width: 100%;
      max-width: 540px;
      max-height: 85vh;
      overflow: hidden;
      box-shadow:
        0 25px 50px -12px rgba(0, 0, 0, 0.5),
        0 0 0 1px rgba(255, 255, 255, 0.05) inset;
      animation: modalSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      display: flex;
      flex-direction: column;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      font-family: var(--font-sans);
      font-size: var(--text-lg);
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: var(--danger);
      color: var(--danger);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    /* Modal footer with gradient edge */
    .modal-footer {
      padding: 20px 24px;
      background: var(--bg-tertiary);
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    /* ============ ENHANCED NAVIGATION ============ */
    /* Colors use CSS variables to work in both light and dark themes */
    
    /* ============ ENHANCED PAGE HEADER ============ */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 28px;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .page-title {
      font-size: var(--text-2xl);
      font-weight: 800;
      color: var(--text-primary);
      letter-spacing: -0.8px;
      display: flex;
      align-items: center;
      gap: 14px;
    }
    
    .page-title .icon {
      font-size: 28px;
      opacity: 0.9;
    }
    
    /* ============ ENHANCED TABS ============ */
    .direction-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .direction-tab {
      padding: 10px 18px;
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: 10px;
      color: var(--text-secondary);
      font-size: var(--text-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--duration-fast) var(--ease-smooth);
    }
    
    .direction-tab:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-2px);
    }
    
    .direction-tab.active {
      background: var(--gradient-primary);
      border-color: transparent;
      color: white;
      box-shadow: var(--shadow-glow-green);
    }
    
    /* Truck tabs */
    .truck-tabs-container button,
    .truck-tab {
      padding: 12px 20px !important;
      border-radius: 12px !important;
      font-weight: 700 !important;
      font-size: var(--text-base) !important;
      transition: all var(--duration-fast) var(--ease-smooth) !important;
    }
    
    .truck-tabs-container button:hover,
    .truck-tab:hover {
      transform: translateY(-2px) !important;
      box-shadow: var(--shadow-sm) !important;
    }
    
    .truck-tabs-container button.active,
    .truck-tab.active {
      background: var(--gradient-secondary) !important;
      box-shadow: var(--shadow-glow-blue) !important;
    }
    
    /* ============ ENHANCED TOAST ============ */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      border-radius: 14px;
      color: white;
      font-size: var(--text-base);
      font-weight: 600;
      z-index: 2000;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInRight var(--duration-normal) var(--ease-spring);
      box-shadow: var(--shadow-float);
      max-width: 400px;
    }
    
    .toast.success { background: var(--gradient-primary); }
    .toast.error { background: var(--gradient-danger); }
    .toast.warning { background: var(--gradient-warning); }
    .toast.info { background: var(--gradient-secondary); }
    
    /* ============ ENHANCED EMPTY STATE ============ */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 24px;
      text-align: center;
    }
    
    .empty-state-icon {
      font-size: 56px;
      margin-bottom: 20px;
      opacity: 0.4;
      animation: float 3s ease-in-out infinite;
    }
    
    .empty-state-title {
      font-size: var(--text-xl);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }
    
    .empty-state-text {
      font-size: var(--text-base);
      color: var(--text-muted);
      max-width: 320px;
      line-height: 1.6;
    }
    
    /* ============ ENHANCED DRIVER CARDS ============ */
    .driver-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-card);
      transition: all var(--duration-normal) var(--ease-smooth);
      position: relative;
      overflow: hidden;
    }
    
    .driver-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity var(--duration-fast);
    }
    
    .driver-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-card-hover);
      border-color: rgba(34, 197, 94, 0.4);
    }
    
    .driver-card:hover::before {
      opacity: 1;
    }
    
    .driver-avatar {
      width: 54px;
      height: 54px;
      border-radius: 14px;
      background: var(--gradient-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      box-shadow: var(--shadow-glow-green);
    }
    
    .driver-name {
      font-size: 17px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.3px;
    }
    
    /* ============ ACTION BUTTONS ============ */
    .action-btn {
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: var(--text-sm);
      font-weight: 600;
      transition: all var(--duration-fast);
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    
    .action-btn.view {
      background: rgba(34, 197, 94, 0.1);
      color: var(--green);
    }
    
    .action-btn.view:hover {
      background: rgba(34, 197, 94, 0.2);
      transform: translateY(-1px);
    }
    
    .action-btn.edit {
      background: rgba(59, 130, 246, 0.1);
      color: var(--blue);
    }
    
    .action-btn.edit:hover {
      background: rgba(59, 130, 246, 0.2);
      transform: translateY(-1px);
    }
    
    .action-btn.delete {
      background: rgba(239, 68, 68, 0.1);
      color: var(--red);
    }
    
    .action-btn.delete:hover {
      background: rgba(239, 68, 68, 0.2);
      transform: translateY(-1px);
    }
    
    /* ============ SKELETON LOADING ============ */
    .skeleton {
      background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-hover) 50%, var(--bg-tertiary) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }
    
    .skeleton-text { height: 14px; margin-bottom: 8px; }
    .skeleton-title { height: 24px; width: 60%; margin-bottom: 12px; }
    .skeleton-card { height: 120px; border-radius: 16px; }
    
    /* ============ ENHANCED SCROLLBARS ============ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 4px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
      transition: background 0.2s;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }
    
    /* ============ TOPBAR ENHANCEMENTS ============ */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }
    
    .topbar-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: var(--text-base);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--duration-fast);
      color: var(--text-secondary);
    }
    
    .topbar-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
    }
    
    /* Dark theme enhancements removed  base CSS uses theme-aware vars */
    
    /* ============ RESPONSIVE FIXES ============ */
    @media (max-width: 768px) {
      .stat-card .value { font-size: var(--text-2xl); }
      .page-title { font-size: var(--text-xl); }
      .card-header { padding: 16px 18px; }
      .modal { max-width: 95%; }
      td { padding: 12px 14px; max-width: 150px; }
      th { padding: 12px 14px; }
      .form-row { grid-template-columns: 1fr; }
    }
    
    /* ============ UTILITY CLASSES ============ */
    .animate-in { animation: fadeInUp var(--duration-normal) var(--ease-out-expo); }
    .animate-scale { animation: scaleIn var(--duration-normal) var(--ease-spring); }
    .animate-slide-right { animation: slideInRight var(--duration-normal) var(--ease-out-expo); }
    .hover-lift { transition: transform var(--duration-fast); }
    .hover-lift:hover { transform: translateY(-3px); }
    .hover-glow:hover { box-shadow: var(--shadow-glow-green); }
    
    /* 
        ADDITIONAL SUBTLE ANIMATIONS & EFFECTS
        */
    
    /* ============ STAGGERED ENTRANCE ANIMATIONS - Premium Timing ============ */
    @keyframes staggerFadeIn {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes cardEnter {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Stat cards stagger - premium timing */
    .stats-grid .stat-card:nth-child(1) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.1s both; }
    .stats-grid .stat-card:nth-child(2) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.15s both; }
    .stats-grid .stat-card:nth-child(3) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.2s both; }
    .stats-grid .stat-card:nth-child(4) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.25s both; }
    .stats-grid .stat-card:nth-child(5) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.3s both; }
    .stats-grid .stat-card:nth-child(6) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.35s both; }

    /* Driver cards stagger */
    .drivers-grid .driver-card:nth-child(1) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.1s both; }
    .drivers-grid .driver-card:nth-child(2) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.15s both; }
    .drivers-grid .driver-card:nth-child(3) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.2s both; }
    .drivers-grid .driver-card:nth-child(4) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.25s both; }
    .drivers-grid .driver-card:nth-child(5) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.3s both; }
    .drivers-grid .driver-card:nth-child(6) { animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) 0.35s both; }

    /* Cards animate in */
    .card {
      animation: cardEnter 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
    }

    /* Number pop animation for stat values */
    .stat-card .value {
      display: inline-block;
      animation: numberPop 0.4s cubic-bezier(0.16, 1, 0.3, 1) 0.3s backwards;
    }

    @keyframes numberPop {
      from {
        opacity: 0;
        transform: scale(0.5);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Toast slide-in animation */
    .toast {
      animation: toastSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes toastSlideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Page title animation */
    .page-title {
      animation: titleEnter 0.6s cubic-bezier(0.16, 1, 0.3, 1) 0.1s both;
    }

    @keyframes titleEnter {
      from {
        opacity: 0;
        transform: translateY(-15px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* ============ TABLE ROW ANIMATIONS ============ */
    @keyframes rowSlideIn {
      from { opacity: 0; transform: translateX(-8px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    tbody tr {
      animation: rowSlideIn 0.3s ease-out both;
    }
    
    tbody tr:nth-child(1) { animation-delay: 0.02s; }
    tbody tr:nth-child(2) { animation-delay: 0.04s; }
    tbody tr:nth-child(3) { animation-delay: 0.06s; }
    tbody tr:nth-child(4) { animation-delay: 0.08s; }
    tbody tr:nth-child(5) { animation-delay: 0.1s; }
    tbody tr:nth-child(6) { animation-delay: 0.12s; }
    tbody tr:nth-child(7) { animation-delay: 0.14s; }
    tbody tr:nth-child(8) { animation-delay: 0.16s; }
    tbody tr:nth-child(9) { animation-delay: 0.18s; }
    tbody tr:nth-child(10) { animation-delay: 0.2s; }
    
    /* Row hover lift effect */
    tbody tr {
      transition: transform var(--duration-fast), box-shadow var(--duration-fast);
    }
    
    tbody tr:hover {
      transform: scale(1.005);
      position: relative;
      z-index: 1;
    }
    
    /* ============ BUTTON ENHANCEMENTS ============ */
    /* Icon spin on hover for icon buttons */
    .btn-icon:hover .icon,
    .btn-icon:hover svg,
    .action-icon:hover {
      transition: transform 0.3s var(--ease-spring);
    }
    
    /* Subtle pulse on primary buttons */
    .btn-primary {
      position: relative;
    }
    
    .btn-primary::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: inherit;
      opacity: 0;
      z-index: -1;
      transition: opacity 0.3s, transform 0.3s;
    }
    
    .btn-primary:hover::before {
      opacity: 0.4;
      transform: scale(1.08);
      filter: blur(8px);
    }
    
    /* Action button icons */
    .action-btn {
      transition: all var(--duration-fast) var(--ease-smooth);
    }
    
    .action-btn:hover {
      transform: translateY(-2px) scale(1.02);
    }
    
    .action-btn:active {
      transform: translateY(0) scale(0.98);
    }
    
    /* ============ NAVIGATION ENHANCEMENTS ============ */
    /* Smooth icon transition */
    .nav-item .icon {
      transition: transform var(--duration-fast) var(--ease-spring), color var(--duration-fast);
    }
    
    .nav-item:hover .icon {
      transform: scale(1.15) rotate(-3deg);
    }
    
    .nav-item.active .icon {
      animation: none;
      transform: scale(1.1);
    }
    
    /* Nav badge pulse */
    .nav-badge {
      animation: pulse-soft 2s ease-in-out infinite;
    }
    
    /* ============ CARD HOVER EFFECTS ============ */
    /* Subtle inner glow on card hover */
    .card::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      opacity: 0;
      transition: opacity var(--duration-normal);
      background: radial-gradient(circle at 50% 0%, rgba(34, 197, 94, 0.08) 0%, transparent 60%);
      pointer-events: none;
    }
    
    .card:hover::after {
      opacity: 1;
    }
    
    /* Stat card icon bounce on hover */
    .stat-card:hover .stat-icon {
      animation: iconBounce 0.4s var(--ease-spring);
    }
    
    @keyframes iconBounce {
      0%, 100% { transform: scale(1.1) rotate(0deg); }
      30% { transform: scale(1.2) rotate(-5deg); }
      60% { transform: scale(1.05) rotate(3deg); }
    }
    
    /* ============ DRIVER CARD AVATAR ============ */
    .driver-avatar {
      transition: transform var(--duration-normal) var(--ease-spring), box-shadow var(--duration-normal);
    }
    
    .driver-card:hover .driver-avatar {
      transform: scale(1.1) rotate(-5deg);
      box-shadow: 0 8px 20px rgba(34, 197, 94, 0.35);
    }
    
    /* ============ BADGE HOVER ============ */
    .badge {
      transition: all var(--duration-fast) var(--ease-smooth);
    }
    
    .badge:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
    }
    
    /* Status badge dot pulse */
    .status-badge::before {
      animation: pulse-soft 2s ease-in-out infinite;
    }
    
    /* ============ FORM FOCUS EFFECTS ============ */
    .form-group input,
    .form-group select,
    .form-group textarea {
      transition: all var(--duration-fast) var(--ease-smooth), box-shadow var(--duration-normal);
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      transform: translateY(-1px);
    }
    
    /* ============ SEARCH BOX ANIMATION ============ */
    .search-box,
    .search-input-wrap {
      transition: all var(--duration-fast) var(--ease-smooth);
    }
    
    .search-box:focus-within,
    .search-input-wrap:focus-within {
      transform: translateY(-1px);
    }
    
    /* Search icon animation */
    .search-box:focus-within .search-icon,
    .search-input-wrap:focus-within .search-icon {
      animation: searchPulse 0.3s var(--ease-spring);
    }
    
    @keyframes searchPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }
    
    /* ============ MODAL ENHANCEMENTS ============ */
    /* Modal content slide up */
    .modal-body {
      animation: modalContentIn 0.3s ease-out 0.1s both;
    }
    
    @keyframes modalContentIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Modal close button */
    .modal-close {
      transition: all var(--duration-fast) var(--ease-spring);
    }
    
    .modal-close:hover {
      transform: rotate(90deg) scale(1.1);
    }

    /* ============ ROUTE SEQUENCE STYLES ============ */
    .sequence-container {
      max-height: 60vh;
      overflow-y: auto;
      padding: 8px;
    }

    .sequence-item {
      user-select: none;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .sequence-item:hover {
      transform: translateX(4px);
    }

    .sequence-item:active {
      cursor: grabbing;
      opacity: 0.9;
    }

    .drag-handle {
      cursor: grab;
    }

    .drag-handle:active {
      cursor: grabbing;
    }

    /* ============ TOPBAR BUTTON EFFECTS ============ */
    .topbar-btn {
      transition: all var(--duration-fast) var(--ease-smooth);
    }
    
    .topbar-btn:hover {
      transform: translateY(-2px);
    }
    
    .topbar-btn:active {
      transform: translateY(0) scale(0.98);
    }
    
    /* Notification badge bounce */
    .notification-badge {
      animation: badgeBounce 0.5s var(--ease-spring);
    }
    
    @keyframes badgeBounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    
    /* ============ TABS ANIMATION ============ */
    .direction-tab,
    .truck-tab {
      transition: all var(--duration-fast) var(--ease-smooth) !important;
    }
    
    .direction-tab:active,
    .truck-tab:active {
      transform: scale(0.96) !important;
    }
    
    .direction-tab.active,
    .truck-tab.active {
      animation: tabActivate 0.3s var(--ease-spring);
    }
    
    @keyframes tabActivate {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.03); }
    }
    
    /* ============ PROGRESS BAR ANIMATION ============ */
    /* Animated fill for progress bars */
    [style*="height:8px"][style*="border-radius:4px"] > div,
    [style*="height: 8px"][style*="border-radius: 4px"] > div {
      animation: progressFill 0.8s ease-out both;
      transform-origin: left;
    }
    
    @keyframes progressFill {
      from { transform: scaleX(0); }
      to { transform: scaleX(1); }
    }
    
    /* ============ AVATAR HOVER ============ */
    .table-avatar,
    .topbar-avatar,
    .user-avatar {
      transition: transform var(--duration-fast) var(--ease-spring), box-shadow var(--duration-fast);
    }
    
    .table-avatar:hover,
    .topbar-avatar:hover,
    .user-avatar:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }
    
    /* ============ WORLD CLOCK PULSE ============ */
    .world-clock {
      transition: all var(--duration-fast);
    }
    
    .world-clock:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
    
    .clock-time {
      transition: color var(--duration-fast);
    }
    
    /* ============ TOAST ENHANCEMENTS ============ */
    .toast {
      animation: toastIn 0.4s var(--ease-spring);
    }
    
    @keyframes toastIn {
      0% { opacity: 0; transform: translateX(100%) scale(0.9); }
      100% { opacity: 1; transform: translateX(0) scale(1); }
    }
    
    /* Toast exit animation (add via JS) */
    .toast.exiting {
      animation: toastOut 0.3s ease-in forwards;
    }
    
    @keyframes toastOut {
      0% { opacity: 1; transform: translateX(0) scale(1); }
      100% { opacity: 0; transform: translateX(100%) scale(0.9); }
    }
    
    /* ============ DROPDOWN ANIMATIONS ============ */
    .topbar-dropdown,
    .notification-dropdown {
      animation: dropdownIn 0.2s var(--ease-out-expo);
      transform-origin: top right;
    }
    
    @keyframes dropdownIn {
      from { opacity: 0; transform: scale(0.95) translateY(-8px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    
    .topbar-dropdown-item,
    .notification-item {
      transition: all var(--duration-instant);
    }
    
    .topbar-dropdown-item:hover,
    .notification-item:hover {
      transform: translateX(4px);
    }
    
    /* ============ MINI CHAT BUBBLE ============ */
    .mini-chat-bubble {
      transition: all var(--duration-fast) var(--ease-spring);
    }
    
    .mini-chat-bubble:hover {
      transform: scale(1.08);
    }
    
    .mini-chat-bubble:active {
      transform: scale(0.95);
    }
    
    /* Chat bubble pulse when has messages */
    .mini-chat-bubble:has(.badge) {
      animation: chatPulse 2s ease-in-out infinite;
    }
    
    @keyframes chatPulse {
      0%, 100% { box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4); }
      50% { box-shadow: 0 4px 30px rgba(34, 197, 94, 0.6); }
    }
    
    /* ============ SIDEBAR TOGGLE ============ */
    .sidebar-toggle {
      transition: all var(--duration-fast) var(--ease-spring);
    }
    
    .sidebar-toggle:hover {
      transform: scale(1.15);
    }
    
    .sidebar-toggle:active {
      transform: scale(0.95);
    }
    
    /* ============ LOGOUT BUTTON ============ */
    .logout-btn {
      transition: all var(--duration-fast) var(--ease-smooth);
    }
    
    .logout-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25);
    }
    
    /* ============ LOADING SPINNER ENHANCEMENT ============ */
    .spinner {
      animation: spin 0.7s linear infinite;
    }
    
    .loading {
      animation: fadeInUp 0.3s ease-out;
    }
    
    /* ============ EMPTY STATE ICON ============ */
    .empty-state-icon {
      animation: float 3s ease-in-out infinite, fadeInScale 0.5s ease-out;
    }
    
    /* ============ HOVER REVEAL FOR ACTIONS ============ */
    /* Actions become more visible on row hover */
    .actions,
    .action-icons {
      opacity: 0.7;
      transition: opacity var(--duration-fast);
    }
    
    tr:hover .actions,
    tr:hover .action-icons {
      opacity: 1;
    }
    
    /* ============ LINK HOVER UNDERLINE ============ */
    a, .link-style {
      position: relative;
    }
    
    /* ============ CHECKBOX/TOGGLE ANIMATION ============ */
    .toggle-switch {
      transition: all var(--duration-fast) var(--ease-smooth);
    }
    
    .toggle-switch::after {
      transition: all var(--duration-fast) var(--ease-spring);
    }
    
    .toggle-switch:hover {
      transform: scale(1.05);
    }
    
    .toggle-switch.active::after {
      animation: toggleOn 0.3s var(--ease-spring);
    }
    
    @keyframes toggleOn {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }
    
    /* ============ SUBTLE HOVER GLOW FOR MONEY VALUES ============ */
    .money {
      transition: all var(--duration-fast);
    }
    
    tr:hover .money.positive,
    tr:hover td.money {
      text-shadow: 0 0 8px rgba(34, 197, 94, 0.3);
    }
    
    tr:hover .money.negative {
      text-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
    }
    
    /* ============ PAGE HEADER ANIMATION ============ */
    .page-header,
    .header {
      animation: slideInLeft 0.4s var(--ease-out-expo);
    }
    
    .page-title,
    .header h2 {
      display: inline-flex;
      align-items: center;
      gap: 12px;
    }
    
    .page-title .icon,
    .header h2 .icon {
      display: inline-block;
      transition: transform var(--duration-fast) var(--ease-spring);
    }
    
    .page-header:hover .page-title .icon,
    .header:hover h2 .icon {
      transform: rotate(-5deg) scale(1.1);
    }
    
    /* ============ SMOOTH COLOR TRANSITIONS ============ */
    * {
      transition-property: color, background-color, border-color, box-shadow, opacity;
      transition-duration: 0;
    }
    
    a, button, .btn, .nav-item, .badge, .card, input, select, textarea {
      transition-duration: var(--duration-fast);
    }
    
    /* ============ STICKY ACTIONS COLUMN ============ */
    /* Must be at end for highest CSS specificity */
    table th.sticky-col,
    table td.sticky-col {
      position: sticky !important;
      right: 0 !important;
      box-shadow: -4px 0 8px rgba(0,0,0,0.15);
      min-width: 220px;
      padding-right: 20px !important;
    }
    table td.sticky-col {
      z-index: 2 !important;
      background: var(--bg-card) !important;
    }
    table th.sticky-col {
      top: 0 !important;
      right: 0 !important;
      z-index: 12 !important;
      background: var(--bg-card-hover) !important;
    }
    [data-theme="dark"] table td.sticky-col {
      background: var(--bg-card) !important;
    }
    [data-theme="dark"] table th.sticky-col {
      background: var(--bg-card) !important;
    }

    /* ============ ENHANCED MOBILE TABLE STYLES ============ */
    @media (max-width: 768px) {
      /* Table wrapper with scroll indicators */
      .table-wrapper {
        position: relative;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
      }

      /* Scroll indicator shadows */
      .table-wrapper::before,
      .table-wrapper::after {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        width: 20px;
        pointer-events: none;
        z-index: 5;
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .table-wrapper::before {
        left: 0;
        background: linear-gradient(to right, rgba(0,0,0,0.1), transparent);
      }

      .table-wrapper::after {
        right: 0;
        background: linear-gradient(to left, rgba(0,0,0,0.1), transparent);
      }

      .table-wrapper.scrolled-left::before {
        opacity: 1;
      }

      .table-wrapper.scrolled-right::after {
        opacity: 1;
      }

      /* Larger touch targets for mobile */
      table td .action-btn,
      table td button {
        min-width: 44px;
        min-height: 44px;
        padding: 10px;
      }

      /* Mobile-friendly table cells */
      table th,
      table td {
        padding: 12px 10px;
        font-size: 13px;
      }

      /* First column sticky on mobile for context */
      table th:first-child,
      table td:first-child {
        position: sticky;
        left: 0;
        z-index: 3;
        background: inherit;
        box-shadow: 4px 0 8px rgba(0,0,0,0.1);
      }

      /* Card-style table rows on very small screens */
      @media (max-width: 480px) {
        .table-responsive-cards table,
        .table-responsive-cards thead,
        .table-responsive-cards tbody,
        .table-responsive-cards th,
        .table-responsive-cards td,
        .table-responsive-cards tr {
          display: block;
        }

        .table-responsive-cards thead tr {
          position: absolute;
          top: -9999px;
          left: -9999px;
        }

        .table-responsive-cards tr {
          background: var(--bg-card);
          border: 1px solid var(--border);
          border-radius: var(--radius);
          margin-bottom: 12px;
          padding: 12px;
        }

        .table-responsive-cards td {
          border: none;
          padding: 8px 0;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }

        .table-responsive-cards td::before {
          content: attr(data-label);
          font-weight: 600;
          color: var(--text-muted);
          font-size: 12px;
          text-transform: uppercase;
        }
      }
    }

    /* ============ REDUCE MOTION FOR ACCESSIBILITY ============ */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ============ SKIP LINK FOR ACCESSIBILITY ============ */
    .skip-link {
      position: absolute;
      top: -50px;
      left: 16px;
      background: var(--primary);
      color: var(--text-primary);
      padding: 12px 24px;
      border-radius: var(--radius);
      font-weight: 600;
      z-index: 10000;
      text-decoration: none;
      transition: top 0.2s ease;
    }
    .skip-link:focus {
      top: 16px;
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }

    /* Screen reader only - visually hidden but accessible */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* Focus visible for keyboard navigation */
    :focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Live region for dynamic announcements */
    .aria-live-region {
      position: absolute;
      left: -10000px;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }

    /* Inline spinner for buttons */
    .spinner-inline {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Skeleton loading animation */
    @keyframes skeleton-pulse {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }

    /* Loading state container */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Skip to Main Content Link for Accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-logo">
      <div class="loading-logo-icon"></div>
      Horizon <span>Star</span>
    </div>
    <div class="loading-truck">
      <div class="truck"></div>
      <div class="road"></div>
    </div>
    <div class="loading-text">
      <span id="loading-message">Logging out</span>
      <div class="loading-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>

  <div id="app"></div>
  <script>
    // ============ SUPABASE CLIENT SETUP ============
    const SUPABASE_URL = 'https://yrrczhlzulwvdqjwvhtu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlycmN6aGx6dWx3dmRxand2aHR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NDYyOTQsImV4cCI6MjA4MTEyMjI5NH0.qVVxDH36OkLXnUe3Sfng1CJY7_Qt_IOGC-1QaDw6WlE';
    
    // Initialize Supabase client
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Current auth session
    let authSession = null;
    
    // Get current access token for API calls
    function getAccessToken() {
      return authSession?.access_token || SUPABASE_KEY;
    }

    // ============ GLOBAL ERROR HANDLER ============
    // Catch unhandled errors to prevent silent failures
    window.onerror = function(message, source, lineno, colno, error) {
      console.error('Unhandled error:', message, 'at', source, lineno + ':' + colno);
      // Show user-friendly message (showToast will be available after app loads)
      if (typeof showToast === 'function') {
        showToast('Something went wrong. Please try again or refresh the page.', 'error');
      }
      return false; // Let error propagate for debugging
    };

    // Catch unhandled promise rejections
    window.addEventListener('unhandledrejection', function(event) {
      console.error('Unhandled promise rejection:', event.reason);
      if (typeof showToast === 'function') {
        showToast('A network or data error occurred. Please try again.', 'error');
      }
    });

    // ============ KEYBOARD SHORTCUTS ============
    const keyboardShortcuts = {
      enabled: true,
      shortcuts: {
        'k': { ctrl: true, action: 'search', description: 'Quick Search' },
        'n': { ctrl: true, action: 'new', description: 'New Item' },
        'd': { ctrl: true, shift: true, action: 'dashboard', description: 'Go to Dashboard' },
        't': { ctrl: true, shift: true, action: 'trips', description: 'Go to Trips' },
        '/': { action: 'help', description: 'Show Shortcuts' },
        'Escape': { action: 'close', description: 'Close Modal' }
      }
    };

    // Keyboard shortcut handler
    document.addEventListener('keydown', function(e) {
      // Skip if typing in input/textarea
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
        // Only handle Escape in inputs
        if (e.key === 'Escape') {
          e.target.blur();
          closeAllModals();
        }
        return;
      }

      // Ctrl/Cmd + K - Quick Search
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        openQuickSearch();
        return;
      }

      // Ctrl/Cmd + N - New Item (context-aware)
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        triggerNewItem();
        return;
      }

      // Ctrl/Cmd + Shift + D - Dashboard
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'D') {
        e.preventDefault();
        if (typeof navigate === 'function') navigate('dashboard');
        return;
      }

      // Ctrl/Cmd + Shift + T - Trips
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'T') {
        e.preventDefault();
        if (typeof navigate === 'function') navigate('trips');
        return;
      }

      // ? or / - Show keyboard shortcuts help
      if (e.key === '?' || (e.key === '/' && !e.ctrlKey)) {
        e.preventDefault();
        showKeyboardShortcutsHelp();
        return;
      }

      // Escape - Close modals
      if (e.key === 'Escape') {
        closeAllModals();
        return;
      }

      // Number keys 1-9 for quick navigation
      if (/^[1-9]$/.test(e.key) && !e.ctrlKey && !e.metaKey && !e.altKey) {
        const navPages = ['dashboard', 'trips', 'orders', 'drivers', 'trucks', 'fuel', 'ifta', 'payroll', 'settings'];
        const pageIndex = parseInt(e.key) - 1;
        if (pageIndex < navPages.length && typeof navigate === 'function') {
          navigate(navPages[pageIndex]);
          showToast('Navigated to ' + navPages[pageIndex].charAt(0).toUpperCase() + navPages[pageIndex].slice(1));
        }
      }
    });

    // Quick search modal
    function openQuickSearch() {
      const existing = document.querySelector('.quick-search-overlay');
      if (existing) {
        existing.remove();
        return;
      }

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay quick-search-overlay';
      overlay.style.cssText = 'display:flex;align-items:flex-start;justify-content:center;padding-top:15vh';
      overlay.innerHTML = `
        <div class="modal" style="max-width:500px;width:100%;margin:0 16px">
          <div style="padding:20px">
            <input type="text" id="quickSearchInput" placeholder="Search pages, trips, drivers..."
                   style="width:100%;padding:14px 18px;font-size:16px;border:2px solid var(--primary);border-radius:var(--radius);background:var(--bg-secondary);color:var(--text-primary)"
                   autocomplete="off">
            <div id="quickSearchResults" style="margin-top:16px;max-height:300px;overflow-y:auto"></div>
            <div style="margin-top:12px;font-size:12px;color:var(--text-muted);display:flex;gap:16px">
              <span> Navigate</span>
              <span> Select</span>
              <span>Esc Close</span>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);

      const input = document.getElementById('quickSearchInput');
      input.focus();

      input.addEventListener('input', handleQuickSearch);
      input.addEventListener('keydown', handleQuickSearchNav);
      overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
    }

    function handleQuickSearch(e) {
      const query = e.target.value.toLowerCase();
      const results = document.getElementById('quickSearchResults');

      if (!query) {
        results.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:20px">Start typing to search...</div>';
        return;
      }

      // Search pages
      const pages = [
        { name: 'Dashboard', page: 'dashboard', icon: '' },
        { name: 'Trips', page: 'trips', icon: '' },
        { name: 'Orders', page: 'orders', icon: '' },
        { name: 'Drivers', page: 'drivers', icon: '' },
        { name: 'Trucks', page: 'trucks', icon: '' },
        { name: 'Fuel', page: 'fuel', icon: '' },
        { name: 'IFTA', page: 'ifta', icon: '' },
        { name: 'Payroll', page: 'payroll', icon: '' },
        { name: 'Chat', page: 'team_chat', icon: '' },
        { name: 'Settings', page: 'settings', icon: '' }
      ];

      const matchedPages = pages.filter(p => p.name.toLowerCase().includes(query));

      if (matchedPages.length === 0) {
        results.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:20px">No results found</div>';
        return;
      }

      results.innerHTML = matchedPages.map((p, i) => `
        <div class="quick-search-item${i === 0 ? ' selected' : ''}" data-page="${p.page}"
             style="padding:12px 16px;cursor:pointer;border-radius:var(--radius);display:flex;align-items:center;gap:12px;${i === 0 ? 'background:var(--primary-light)' : ''}"
             onmouseover="this.style.background='var(--bg-hover)';selectQuickSearchItem(this)"
             onclick="navigateFromQuickSearch('${p.page}')">
          <span style="font-size:20px">${p.icon}</span>
          <span style="font-weight:500">${p.name}</span>
        </div>
      `).join('');
    }

    function handleQuickSearchNav(e) {
      const results = document.getElementById('quickSearchResults');
      const items = results.querySelectorAll('.quick-search-item');
      const selected = results.querySelector('.quick-search-item.selected');

      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        e.preventDefault();
        if (!items.length) return;

        let idx = Array.from(items).indexOf(selected);
        idx = e.key === 'ArrowDown' ? Math.min(idx + 1, items.length - 1) : Math.max(idx - 1, 0);

        items.forEach(i => { i.classList.remove('selected'); i.style.background = ''; });
        items[idx].classList.add('selected');
        items[idx].style.background = 'var(--primary-light)';
        items[idx].scrollIntoView({ block: 'nearest' });
      }

      if (e.key === 'Enter' && selected) {
        e.preventDefault();
        navigateFromQuickSearch(selected.dataset.page);
      }
    }

    function selectQuickSearchItem(item) {
      document.querySelectorAll('.quick-search-item').forEach(i => {
        i.classList.remove('selected');
        i.style.background = '';
      });
      item.classList.add('selected');
      item.style.background = 'var(--primary-light)';
    }

    function navigateFromQuickSearch(page) {
      document.querySelector('.quick-search-overlay')?.remove();
      if (typeof navigate === 'function') navigate(page);
    }

    // Trigger new item based on current page
    function triggerNewItem() {
      const newItemActions = {
        'trips': 'openTripModal',
        'orders': 'openOrderModal',
        'drivers': 'openDriverModal',
        'trucks': 'openTruckModal',
        'brokers': 'openBrokerModal',
        'tasks': 'openTaskModal',
        'fuel': 'openFuelModal',
        'future_cars': 'openLoadBoardOrder'
      };

      const action = newItemActions[typeof currentPage !== 'undefined' ? currentPage : ''];
      if (action && typeof window[action] === 'function') {
        window[action]();
      } else {
        showToast('Press + button to create new item on this page', 'info');
      }
    }

    // Close all modals
    function closeAllModals() {
      document.querySelectorAll('.modal-overlay').forEach(m => m.remove());
    }

    // Show keyboard shortcuts help
    function showKeyboardShortcutsHelp() {
      const existing = document.querySelector('.shortcuts-help-overlay');
      if (existing) { existing.remove(); return; }

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay shortcuts-help-overlay';
      overlay.innerHTML = `
        <div class="modal" style="max-width:450px">
          <div class="modal-header">
            <h3> Keyboard Shortcuts</h3>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
          </div>
          <div style="padding:20px">
            <div style="display:grid;gap:12px">
              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
                <span>Quick Search</span><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;font-family:monospace">Ctrl + K</kbd>
              </div>
              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
                <span>New Item</span><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;font-family:monospace">Ctrl + N</kbd>
              </div>
              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
                <span>Go to Dashboard</span><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;font-family:monospace">Ctrl + Shift + D</kbd>
              </div>
              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
                <span>Go to Trips</span><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;font-family:monospace">Ctrl + Shift + T</kbd>
              </div>
              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
                <span>Quick Navigate</span><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;font-family:monospace">1 - 9</kbd>
              </div>
              <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
                <span>Close Modal</span><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;font-family:monospace">Esc</kbd>
              </div>
              <div style="display:flex;justify-content:space-between;padding:8px 0">
                <span>Show This Help</span><kbd style="background:var(--bg-tertiary);padding:4px 8px;border-radius:4px;font-family:monospace">?</kbd>
              </div>
            </div>
            <div style="margin-top:16px;font-size:12px;color:var(--text-muted);text-align:center">
              Use <strong>Cmd</strong> instead of Ctrl on Mac
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
    }

    // Show dealer portal login modal
    function showDealerLoginInfo() {
      const m = document.createElement('div');
      m.className = 'modal-overlay';
      m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = `
        <div class="modal" style="max-width:450px">
          <div class="modal-header">
            <h3>Dealer Portal Login</h3>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
          </div>
          <div class="modal-body" style="padding:24px">
            <div style="text-align:center;margin-bottom:20px">
              <div style="font-size:48px;margin-bottom:8px"></div>
              <p style="color:var(--text-secondary);font-size:14px">Submit vehicles, track shipments, view spending</p>
            </div>
            <form onsubmit="handleDealerLogin(event)" id="dealer-login-form">
              <div class="form-group" style="margin-bottom:16px">
                <label style="display:block;margin-bottom:6px;font-weight:500;color:var(--text-primary)">Email</label>
                <input type="email" id="dealer-login-email" required placeholder="dealer@company.com"
                  style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text)">
              </div>
              <div class="form-group" style="margin-bottom:20px">
                <label style="display:block;margin-bottom:6px;font-weight:500;color:var(--text-primary)">Password</label>
                <input type="password" id="dealer-login-password" required placeholder="Your password"
                  style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text)">
              </div>
              <div id="dealer-login-error" style="color:var(--red);font-size:13px;margin-bottom:12px;display:none"></div>
              <button type="submit" class="btn btn-primary" id="dealer-login-btn" style="width:100%;padding:12px;font-size:15px">
                Sign In to Dealer Portal
              </button>
            </form>
            <p style="text-align:center;margin-top:16px;color:var(--text-muted);font-size:12px">
              Need an account? Contact <strong style="color:var(--green)">info@horizonstarllc.com</strong>
            </p>
          </div>
        </div>
      `;
      document.body.appendChild(m);
      document.getElementById('dealer-login-email').focus();
    }

    // Handle dealer login
    async function handleDealerLogin(event) {
      event.preventDefault();
      const email = document.getElementById('dealer-login-email').value.trim();
      const password = document.getElementById('dealer-login-password').value;
      const btn = document.getElementById('dealer-login-btn');
      const errorEl = document.getElementById('dealer-login-error');

      btn.disabled = true;
      btn.textContent = 'Signing in...';
      errorEl.style.display = 'none';

      try {
        // Authenticate with Supabase
        const { data: authData, error: authError } = await sb.auth.signInWithPassword({ email, password });
        if (authError) throw new Error(authError.message);

        // Get user from users table
        const { data: users, error: userError } = await sb.from('users').select('*').eq('email', email).limit(1);
        if (userError) throw new Error(userError.message);
        if (!users || users.length === 0) throw new Error('User not found');

        const user = users[0];

        // Check if user is a dealer
        if (user.role !== 'DEALER') {
          await sb.auth.signOut();
          throw new Error('This login is for dealers only. Please use the main login.');
        }

        // Set current user and session
        currentUser = user;
        authSession = authData.session;
        localStorage.setItem('horizonstar_user', JSON.stringify(user));
        localStorage.setItem('last_activity', Date.now().toString());

        // Close modal and render dealer dashboard
        document.querySelector('.modal-overlay')?.remove();
        showToast('Welcome back, ' + (user.name || user.email) + '!', 'success');
        await renderApp();
        navigate('dealer_dashboard');

      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Sign In to Dealer Portal';
      }
    }

    // ============ DATABASE FUNCTIONS ============
    async function dbFetch(table, options = {}) {
      let query = sb.from(table).select(options.select || '*');
      
      if (options.filter) {
        Object.entries(options.filter).forEach(([key, value]) => {
          // Parse filter like "email=eq.test@example.com"
          if (value.startsWith('eq.')) {
            query = query.eq(key, value.substring(3));
          } else if (value.startsWith('neq.')) {
            query = query.neq(key, value.substring(4));
          } else if (value.startsWith('gt.')) {
            query = query.gt(key, value.substring(3));
          } else if (value.startsWith('gte.')) {
            query = query.gte(key, value.substring(4));
          } else if (value.startsWith('lt.')) {
            query = query.lt(key, value.substring(3));
          } else if (value.startsWith('lte.')) {
            query = query.lte(key, value.substring(4));
          } else if (value.startsWith('like.')) {
            query = query.like(key, value.substring(5));
          } else if (value.startsWith('ilike.')) {
            query = query.ilike(key, value.substring(6));
          } else if (value.startsWith('in.(')) {
            // Handle in.(...) operator - extract values from in.(1,2,3) format
            const values = value.substring(4, value.length - 1).split(',').map(v => {
              const trimmed = v.trim();
              // Try to parse as number, otherwise keep as string
              const num = parseInt(trimmed);
              return isNaN(num) ? trimmed : num;
            });
            query = query.in(key, values);
          } else {
            query = query.eq(key, value);
          }
        });
      }
      
      if (options.order) {
        const [column, direction] = options.order.split('.');
        query = query.order(column, { ascending: direction !== 'desc' });
      }
      
      const { data, error } = await query;
      if (error) throw error;
      return data || [];
    }

    // Generate a unique dealer code from company name
    window.generateDealerCode = function(companyName) {
      const prefix = (companyName || 'DLR').substring(0, 3).toUpperCase().replace(/[^A-Z]/g, 'X');
      const suffix = Math.floor(100 + Math.random() * 900);
      return prefix + suffix;
    };

    async function dbInsert(table, data) {
      const { data: result, error } = await sb
        .from(table)
        .insert(data)
        .select()
        .single();
      
      if (error) throw new Error(error.message || 'Insert failed');
      
      // Track that we just made a change (for realtime sync)
      window.lastSaveTimestamp = Date.now();
      
      // Invalidate cache so next load gets fresh data
      dataCache.invalidate('appData');
      
      return result;
    }

    // Store original updated_at when opening edit modals
    let editingRecords = {};
    
    function startEditing(table, id, updatedAt) {
      editingRecords[table + '_' + id] = updatedAt || new Date().toISOString();
    }
    
    function getEditingTimestamp(table, id) {
      return editingRecords[table + '_' + id];
    }
    
    function clearEditing(table, id) {
      delete editingRecords[table + '_' + id];
    }
    
    async function dbUpdate(table, id, data, skipConflictCheck = false) {
      // Check for conflicts on important tables
      if (!skipConflictCheck && ['trips', 'orders', 'drivers', 'trucks'].includes(table)) {
        const originalTimestamp = getEditingTimestamp(table, id);
        if (originalTimestamp) {
          // Fetch current record to check if it was modified
          try {
            const { data: current, error } = await sb.from(table).select('updated_at').eq('id', id).single();
            // Only check conflict if we successfully got data with updated_at column
            if (!error && current && current.updated_at && current.updated_at !== originalTimestamp) {
              const confirmOverwrite = confirm(
                ' This record was modified by another user while you were editing.\n\n' +
                'Click OK to save your changes anyway (will overwrite their changes)\n' +
                'Click Cancel to refresh and see the latest version'
              );
              if (!confirmOverwrite) {
                await loadAllData(true); // Force refresh
                showToast('Data refreshed - please review and try again', 'info');
                return null; // Signal that save was cancelled
              }
            }
          } catch (e) {
            // If conflict check fails (e.g., updated_at column doesn't exist), skip it
            console.warn('Conflict check skipped:', e.message);
          }
        }
      }
      
      const { data: result, error } = await sb
        .from(table)
        .update(data)
        .eq('id', id)
        .select();
      
      if (error) throw new Error(error.message || 'Update failed');
      
      // Track that we just made a change (for realtime sync)
      window.lastSaveTimestamp = Date.now();
      
      // Clear editing tracker
      clearEditing(table, id);
      
      // Invalidate cache so next load gets fresh data
      dataCache.invalidate('appData');
      
      return result;
    }

    async function dbDelete(table, id) {
      const { error } = await sb
        .from(table)
        .delete()
        .eq('id', id);
      
      if (error) throw new Error(error.message || 'Delete failed');
      
      // Track that we just made a change (for realtime sync)
      window.lastSaveTimestamp = Date.now();
      
      // Invalidate cache so next load gets fresh data
      dataCache.invalidate('appData');
    }

    // ============ SECURITY FUNCTIONS ============
    
    // Password Hashing using SHA-256
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password + 'horizonstar_salt_2024');
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
    
    // Login Attempt Tracking
    const LOGIN_ATTEMPT_LIMIT = 5;
    const LOGIN_LOCKOUT_MINUTES = 15;
    
    function getLoginAttempts(email) {
      const attempts = JSON.parse(localStorage.getItem('login_attempts') || '{}');
      return attempts[email] || { count: 0, lastAttempt: 0, lockedUntil: 0 };
    }
    
    function recordLoginAttempt(email, success) {
      const attempts = JSON.parse(localStorage.getItem('login_attempts') || '{}');
      const now = Date.now();
      
      if (success) {
        // Clear attempts on successful login
        delete attempts[email];
      } else {
        // Increment failed attempts
        if (!attempts[email]) {
          attempts[email] = { count: 0, lastAttempt: 0, lockedUntil: 0 };
        }
        attempts[email].count++;
        attempts[email].lastAttempt = now;
        
        // Lock account after too many attempts
        if (attempts[email].count >= LOGIN_ATTEMPT_LIMIT) {
          attempts[email].lockedUntil = now + (LOGIN_LOCKOUT_MINUTES * 60 * 1000);
        }
      }
      
      localStorage.setItem('login_attempts', JSON.stringify(attempts));
      return attempts[email];
    }
    
    function isAccountLocked(email) {
      const attempts = getLoginAttempts(email);
      if (attempts.lockedUntil && Date.now() < attempts.lockedUntil) {
        const remainingMinutes = Math.ceil((attempts.lockedUntil - Date.now()) / 60000);
        return { locked: true, remainingMinutes };
      }
      // Reset if lockout expired
      if (attempts.lockedUntil && Date.now() >= attempts.lockedUntil) {
        const allAttempts = JSON.parse(localStorage.getItem('login_attempts') || '{}');
        delete allAttempts[email];
        localStorage.setItem('login_attempts', JSON.stringify(allAttempts));
      }
      return { locked: false };
    }
    
    // Session Timeout Management
    const SESSION_TIMEOUT_MINUTES = 60; // 1 hour
    let sessionTimeoutId = null;
    let lastActivityTime = Date.now();
    
    function updateLastActivity() {
      lastActivityTime = Date.now();
      localStorage.setItem('last_activity', lastActivityTime.toString());
    }
    
    function checkSessionTimeout() {
      const storedLastActivity = parseInt(localStorage.getItem('last_activity') || '0');
      const timeout = SESSION_TIMEOUT_MINUTES * 60 * 1000;
      
      // If no last_activity set, this is likely a fresh login - set it now
      if (storedLastActivity === 0) {
        localStorage.setItem('last_activity', Date.now().toString());
        return false; // Don't expire, treat as fresh session
      }
      
      if (currentUser && (Date.now() - storedLastActivity) > timeout) {
        sessionExpired();
        return true;
      }
      return false;
    }
    
    function sessionExpired() {
      currentUser = null;
      localStorage.removeItem('horizonstar_user');
      localStorage.removeItem('last_activity');
      showToast('Session expired. Please log in again.', 'warning');
      renderLogin();
    }
    
    function startSessionMonitor() {
      // Update activity on user interactions
      ['click', 'keypress', 'mousemove', 'scroll'].forEach(event => {
        document.addEventListener(event, updateLastActivity, { passive: true });
      });
      
      // Check session every minute
      if (sessionTimeoutId) clearInterval(sessionTimeoutId);
      sessionTimeoutId = setInterval(() => {
        if (currentUser) checkSessionTimeout();
      }, 60000);
      
      updateLastActivity();
    }
    
    // ============ REAL-TIME COLLABORATION ============
    let realtimeChannel = null;
    
    function startRealtimeSync() {
      if (!sb || realtimeChannel) return;
      
      // Subscribe to changes on key tables
      realtimeChannel = sb
        .channel('tms-realtime')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'trips' }, handleRealtimeChange)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, handleRealtimeChange)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'drivers' }, handleRealtimeChange)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'trucks' }, handleRealtimeChange)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'expenses' }, handleRealtimeChange)
        .on('postgres_changes', { event: '*', schema: 'public', table: 'chat_messages' }, handleChatRealtimeChange)
        .subscribe((status) => {
          if (status === 'SUBSCRIBED') {
            console.log(' Real-time sync active');
          }
        });
    }
    
    // Debounce realtime updates to avoid too many refreshes
    let realtimeDebounceTimer = null;
    let pendingRealtimeUpdate = false;
    
    function handleRealtimeChange(payload) {
      // Don't refresh if we just made the change ourselves (within last 3 seconds)
      const timeSinceLastSave = Date.now() - (window.lastSaveTimestamp || 0);
      if (timeSinceLastSave < 3000) {
        return; // Skip - this is likely our own change
      }

      // Debounce multiple rapid changes
      pendingRealtimeUpdate = true;
      if (realtimeDebounceTimer) clearTimeout(realtimeDebounceTimer);

      realtimeDebounceTimer = setTimeout(async () => {
        if (!pendingRealtimeUpdate) return;
        pendingRealtimeUpdate = false;

        // CRITICAL: Save current detail view BEFORE any async operations
        // This prevents race conditions where async code could clear/modify currentDetailView
        const savedDetailView = currentDetailView ? {...currentDetailView} : null;

        // Show notification
        showToast(' Data changed by another user', 'info');

        // Refresh data
        await loadAllData(true);

        // Respect SAVED detail view - don't navigate away
        if (savedDetailView) {
          // Re-render the detail view instead of the page list
          if (savedDetailView.type === 'trip') {
            viewTrip(savedDetailView.id);
          } else if (savedDetailView.type === 'driver') {
            viewDriverProfile(savedDetailView.id);
          } else if (savedDetailView.type === 'truck') {
            viewTruckCompliance(savedDetailView.id);
          } else if (savedDetailView.type === 'local_driver') {
            viewLocalDriverDetails(savedDetailView.id);
          } else {
            renderPage();
          }
        } else {
          renderPage();
        }
      }, 1000); // Wait 1 second for any additional changes
    }
    
    function handleChatRealtimeChange(payload) {
      // For chat, just trigger a re-render of chat if we're on that page
      if (payload.eventType === 'INSERT' && currentPage === 'team_chat') {
        const timeSinceLastSave = Date.now() - (window.lastSaveTimestamp || 0);
        if (timeSinceLastSave < 2000) return;
        
        // Reload chat messages
        loadAllData(true).then(() => {
          const main = document.getElementById('main-content');
          if (main && currentPage === 'team_chat') renderTeamChat(main);
        });
      }
    }
    
    function stopRealtimeSync() {
      if (realtimeChannel) {
        sb.removeChannel(realtimeChannel);
        realtimeChannel = null;
        console.log('Real-time sync stopped');
      }
    }
    
    // Activity Logging
    async function logActivity(action, details = {}) {
      try {
        // Get user's full name
        const userName = currentUser ? (currentUser.first_name + ' ' + currentUser.last_name).trim() : null;

        await dbInsert('activity_log', {
          user_id: currentUser?.id || null,
          user_email: currentUser?.email || details.email || 'unknown',
          user_name: userName || details.user_name || 'System',
          action: action,
          details: JSON.stringify(details),
          ip_address: 'client', // Can't get real IP from client
          created_at: new Date().toISOString()
        });
      } catch (e) {
        // Activity log table may not exist, fail silently
        console.log('Activity log:', action, details);
      }
    }
    
    // Password Reset Token Generation
    function generateResetToken() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
    }

    let currentUser = JSON.parse(localStorage.getItem('horizonstar_user') || 'null');
    let currentPage = 'dashboard';
    let currentLang = 'en';
    let appData = { users: [], trucks: [], drivers: [], local_drivers: [], dispatchers: [], trips: [], orders: [], expenses: [], fixed_costs: [], variable_costs: [], driver_files: [], truck_files: [], brokers: [], fuel_transactions: [], maintenance_records: [], claims: [], tickets: [], violations: [], ticket_files: [], violation_files: [], claim_files: [], compliance_tasks: [], accidents: [], order_attachments: [] };
    
    // ============ DEBOUNCE UTILITY ============
    function debounce(func, wait = 300) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // ============ DATA CACHE ============
    const dataCache = {
      data: {},
      timestamps: {},
      maxAge: 5 * 60 * 1000, // 5 minutes cache
      
      set(key, value) {
        this.data[key] = value;
        this.timestamps[key] = Date.now();
      },
      
      get(key) {
        if (!this.data[key]) return null;
        if (Date.now() - this.timestamps[key] > this.maxAge) {
          delete this.data[key];
          delete this.timestamps[key];
          return null;
        }
        return this.data[key];
      },
      
      invalidate(key) {
        if (key) {
          delete this.data[key];
          delete this.timestamps[key];
        } else {
          this.data = {};
          this.timestamps = {};
        }
      }
    };
    
    // ============ PAGINATION STATE ============
    const pagination = {
      trips: { page: 1, perPage: 50, total: 0 },
      orders: { page: 1, perPage: 50, total: 0 },
      maintenance: { page: 1, perPage: 50, total: 0 },
      expenses: { page: 1, perPage: 50, total: 0 },
      activity_log: { page: 1, perPage: 100, total: 0 }
    };
    
    function getPaginatedData(dataArray, pageKey) {
      const p = pagination[pageKey] || { page: 1, perPage: 50 };
      p.total = dataArray.length;
      const start = (p.page - 1) * p.perPage;
      const end = start + p.perPage;
      return {
        data: dataArray.slice(start, end),
        page: p.page,
        perPage: p.perPage,
        total: p.total,
        totalPages: Math.ceil(p.total / p.perPage)
      };
    }
    
    function renderPaginationControls(pageKey, onPageChange) {
      const p = pagination[pageKey];
      if (!p || p.total <= p.perPage) return '';
      
      const totalPages = Math.ceil(p.total / p.perPage);
      const prevDisabled = p.page <= 1 ? 'disabled' : '';
      const nextDisabled = p.page >= totalPages ? 'disabled' : '';
      
      return '<div class="pagination-controls" style="display:flex;align-items:center;justify-content:center;gap:12px;margin-top:20px;padding:16px;background:var(--bg-card);border-radius:12px">' +
        '<button class="btn btn-secondary" onclick="changePage(\'' + pageKey + '\', ' + (p.page - 1) + ')" ' + prevDisabled + ' style="padding:10px 16px"> ' + ('Previous') + '</button>' +
        '<span style="color:var(--text-muted)">' + ('Page') + ' <strong>' + p.page + '</strong> / ' + totalPages + ' (' + p.total + ' ' + ('records') + ')</span>' +
        '<button class="btn btn-secondary" onclick="changePage(\'' + pageKey + '\', ' + (p.page + 1) + ')" ' + nextDisabled + ' style="padding:10px 16px">' + ('Next') + ' </button>' +
        '</div>';
    }
    
    function changePage(pageKey, newPage) {
      if (pagination[pageKey]) {
        pagination[pageKey].page = newPage;
        renderPage();
      }
    }

    // ============ TRANSLATIONS ============
    const translations = {
      en: {
        // Navigation
        dashboard: 'Dashboard',
        loadboard: 'Future Cars',
        trips: 'Trips',
        orders: 'Orders',
        drivers: 'Drivers',
        local_drivers: 'Local Drivers',
        trucks: 'Trucks',
        brokers: 'Brokers',
        dispatchers: 'Dispatchers',
        dispatcher_ranking: 'Dispatcher Ranking',
        fuel: 'Fuel Tracking',
        ifta: 'IFTA Report',
        compliance: 'Compliance',
        driver_compliance: 'Driver Compliance',
        financials: 'Financials',
        billing: 'Billing',
        payroll: 'Payroll',
        reports: 'Reports',
        ai_advisor: 'AI Advisor',
        fixed_costs: 'Fixed Costs',
        variable_costs: 'Variable Costs',
        financial: 'Financial Analysis',
        profitability: 'Profitability',
        trip_profitability: 'Trip Profitability',
        executive_dashboard: 'Executive Dashboard',
        maintenance: 'Maintenance',
        claims: 'Damage Claims',
        settings: 'Settings',
        users: 'Users',
        tasks: 'Tasks',
        activity_log: 'Activity Log',
        live_map: 'Live Map',
        team_chat: 'Team Chat',
        applications: 'Applications',
        
        // Common buttons
        add: 'Add',
        edit: 'Edit',
        delete: 'Delete',
        save: 'Save',
        cancel: 'Cancel',
        close: 'Close',
        export: 'Export',
        search: 'Search',
        filter: 'Filter',
        view: 'View',
        
        // Dashboard
        welcome: 'Welcome',
        total_revenue: 'Total Revenue',
        active_trips: 'Active Trips',
        total_trucks: 'Total Trucks',
        total_drivers: 'Total Drivers',
        recent_trips: 'Recent Trips',
        quick_stats: 'Quick Stats',
        
        // Common labels
        date: 'Date',
        status: 'Status',
        amount: 'Amount',
        notes: 'Notes',
        actions: 'Actions',
        truck: 'Truck',
        driver: 'Driver',
        dispatcher: 'Dispatcher',
        broker: 'Broker',
        origin: 'Origin',
        destination: 'Destination',
        miles: 'Miles',
        revenue: 'Revenue',
        cost: 'Cost',
        profit: 'Profit',
        total: 'Total',
        
        // Trips
        trip_number: 'Trip #',
        trip_date: 'Trip Date',
        new_trip: 'New Trip',
        edit_trip: 'Edit Trip',
        trip_details: 'Trip Details',
        
        // Trucks
        truck_number: 'Truck #',
        new_truck: 'New Truck',
        edit_truck: 'Edit Truck',
        truck_details: 'Truck Details',
        vin: 'VIN',
        year: 'Year',
        make: 'Make',
        model: 'Model',
        license_plate: 'License Plate',
        
        // Drivers
        first_name: 'First Name',
        last_name: 'Last Name',
        phone: 'Phone',
        email: 'Email',
        new_driver: 'New Driver',
        edit_driver: 'Edit Driver',
        
        // Maintenance
        maintenance_records: 'Maintenance Records',
        new_record: 'New Record',
        service_date: 'Service Date',
        service_type: 'Service Type',
        shop_name: 'Shop Name',
        description: 'Description',
        parts_cost: 'Parts Cost',
        labor_cost: 'Labor Cost',
        total_cost: 'Total Cost',
        upload_invoice: 'Upload Invoice',
        extract_data: 'Extract Invoice Data',
        
        // Financial
        net_profit: 'Net Profit',
        profit_margin: 'Profit Margin',
        total_costs: 'Total Costs',
        fuel_cost: 'Fuel Cost',
        maintenance_cost: 'Maintenance Cost',
        driver_pay: 'Driver Pay',
        broker_fees: 'Broker Fees',
        
        // Status
        active: 'Active',
        inactive: 'Inactive',
        completed: 'Completed',
        in_progress: 'In Progress',
        planned: 'Planned',
        cancelled: 'Cancelled',
        
        // Messages
        saved_success: 'Saved successfully!',
        deleted_success: 'Deleted successfully!',
        error_occurred: 'An error occurred',
        confirm_delete: 'Are you sure you want to delete?',
        no_data: 'No data available',
        loading: 'Loading...',
        
        // Login
        login: 'Login',
        logout: 'Logout',
        username: 'Username',
        password: 'Password',
        sign_in: 'Sign In',
        
        // Misc
        all_time: 'All Time',
        this_month: 'This Month',
        this_year: 'This Year',
        per_mile: 'Per Mile',
        monthly: 'Monthly',
        annually: 'Annually',
        export_to_sheets: 'Export to Sheets'
      }
    };
    
    function t(key) {
      return translations.en[key] || key;
    }
    
    function setLanguage(lang) {
      // Language switching disabled - English only
    }
    
    // Dark Theme - Default to dark theme (true unless explicitly set to 'false')
    let isDarkTheme = localStorage.getItem('horizonstar_dark') !== 'false';
    
    function applyTheme() {
      if (isDarkTheme) {
        document.body.classList.add('dark-theme');
        document.documentElement.setAttribute('data-theme', 'dark');
      } else {
        document.body.classList.remove('dark-theme');
        document.documentElement.setAttribute('data-theme', 'light');
      }
    }
    
    function toggleDarkTheme() {
      isDarkTheme = !isDarkTheme;
      localStorage.setItem('horizonstar_dark', isDarkTheme);
      applyTheme();
      if (currentUser) {
        renderApp();
      } else {
        renderLogin();
      }
    }
    
    // Apply theme on load
    applyTheme();

    function formatMoney(n) { 
      const val = n || 0;
      const formatted = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(Math.abs(val));
      return val < 0 ? '(' + formatted + ')' : formatted;
    }
    function formatDate(d) { return d ? new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '-'; }
    function showToast(msg, type = 'success') {
      document.querySelectorAll('.toast').forEach(t => t.remove());
      const t = document.createElement('div'); t.className = 'toast ' + type; t.textContent = msg;
      document.body.appendChild(t); setTimeout(() => t.remove(), 3000);
    }
    function getBadge(s) {
      const m = { COMPLETED: 'badge-green', AT_TERMINAL: 'badge-amber', IN_PROGRESS: 'badge-amber', PLANNED: 'badge-blue', CANCELLED: 'badge-red', ACTIVE: 'badge-green', INACTIVE: 'badge-gray', MAINTENANCE: 'badge-amber', DELIVERED: 'badge-green', IN_TRANSIT: 'badge-amber', PENDING: 'badge-blue' };
      return m[s] || 'badge-gray';
    }

    // ============ HTML SANITIZATION (XSS Prevention) ============
    // Escape HTML special characters to prevent XSS attacks
    function escapeHtml(text) {
      if (text === null || text === undefined) return '';
      const str = String(text);
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return str.replace(/[&<>"']/g, char => map[char]);
    }

    // Sanitize user input before displaying (alias for escapeHtml)
    function sanitize(text) {
      return escapeHtml(text);
    }

    // ============ FORM VALIDATION UTILITIES ============
    const validators = {
      required: (value, fieldName) => {
        if (!value || (typeof value === 'string' && !value.trim())) {
          return fieldName + ' is required';
        }
        return null;
      },
      email: (value) => {
        if (!value) return null;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(value)) {
          return 'Please enter a valid email address';
        }
        return null;
      },
      phone: (value) => {
        if (!value) return null;
        const cleaned = value.replace(/\D/g, '');
        if (cleaned.length < 10 || cleaned.length > 11) {
          return 'Please enter a valid phone number';
        }
        return null;
      },
      number: (value, min, max) => {
        if (!value && value !== 0) return null;
        const num = parseFloat(value);
        if (isNaN(num)) return 'Please enter a valid number';
        if (min !== undefined && num < min) return 'Value must be at least ' + min;
        if (max !== undefined && num > max) return 'Value must not exceed ' + max;
        return null;
      },
      date: (value) => {
        if (!value) return null;
        const date = new Date(value);
        if (isNaN(date.getTime())) return 'Please enter a valid date';
        return null;
      },
      vin: (value) => {
        if (!value) return null;
        if (value.length !== 17) return 'VIN must be exactly 17 characters';
        if (!/^[A-HJ-NPR-Z0-9]{17}$/i.test(value)) return 'Invalid VIN format';
        return null;
      }
    };

    // Validate a form field and show inline error
    function validateField(input, validations) {
      const value = input.value;
      const fieldName = input.getAttribute('data-field-name') || input.name || 'This field';

      for (const validation of validations) {
        let error;
        if (typeof validation === 'string') {
          error = validators[validation] ? validators[validation](value, fieldName) : null;
        } else if (typeof validation === 'object') {
          const { type, ...params } = validation;
          error = validators[type] ? validators[type](value, params.min, params.max) : null;
        }

        if (error) {
          showFieldError(input, error);
          return false;
        }
      }

      clearFieldError(input);
      return true;
    }

    // Show error message under a field
    function showFieldError(input, message) {
      clearFieldError(input);
      input.style.borderColor = 'var(--red)';
      input.setAttribute('aria-invalid', 'true');

      const errorDiv = document.createElement('div');
      errorDiv.className = 'field-error';
      errorDiv.style.cssText = 'color:var(--red);font-size:12px;margin-top:4px';
      errorDiv.textContent = message;
      errorDiv.id = input.id + '-error';
      input.setAttribute('aria-describedby', errorDiv.id);

      input.parentNode.appendChild(errorDiv);
    }

    // Clear error message from a field
    function clearFieldError(input) {
      input.style.borderColor = '';
      input.removeAttribute('aria-invalid');
      input.removeAttribute('aria-describedby');

      const existingError = input.parentNode.querySelector('.field-error');
      if (existingError) existingError.remove();
    }

    // Validate entire form
    function validateForm(formSelector, fieldValidations) {
      const form = typeof formSelector === 'string' ? document.querySelector(formSelector) : formSelector;
      if (!form) return false;

      let isValid = true;
      for (const [fieldId, validations] of Object.entries(fieldValidations)) {
        const input = form.querySelector('#' + fieldId) || form.querySelector('[name="' + fieldId + '"]');
        if (input && !validateField(input, validations)) {
          isValid = false;
        }
      }

      if (!isValid) {
        showToast('Please fix the errors in the form', 'error');
      }
      return isValid;
    }

    // ============ MOBILE TABLE SCROLL INDICATORS ============
    // Add scroll indicators to table wrappers
    function initTableScrollIndicators() {
      document.querySelectorAll('.table-wrapper').forEach(wrapper => {
        const updateScrollIndicators = () => {
          const scrollLeft = wrapper.scrollLeft;
          const scrollWidth = wrapper.scrollWidth;
          const clientWidth = wrapper.clientWidth;

          wrapper.classList.toggle('scrolled-left', scrollLeft > 10);
          wrapper.classList.toggle('scrolled-right', scrollLeft < scrollWidth - clientWidth - 10);
        };

        wrapper.addEventListener('scroll', updateScrollIndicators);
        // Initial check
        setTimeout(updateScrollIndicators, 100);
      });
    }

    // Initialize on page render
    if (typeof MutationObserver !== 'undefined') {
      const tableObserver = new MutationObserver(() => {
        initTableScrollIndicators();
      });
      document.addEventListener('DOMContentLoaded', () => {
        tableObserver.observe(document.body, { childList: true, subtree: true });
        initTableScrollIndicators();
      });
    }

    // ============ LOADING STATE UTILITIES ============
    // Set loading state on a button
    function setButtonLoading(button, isLoading, loadingText) {
      if (typeof button === 'string') {
        button = document.querySelector(button);
      }
      if (!button) return;

      if (isLoading) {
        button.disabled = true;
        button.setAttribute('data-original-text', button.innerHTML);
        button.innerHTML = '<span class="spinner-inline"></span> ' + (loadingText || 'Loading...');
        button.style.opacity = '0.7';
        button.style.cursor = 'not-allowed';
      } else {
        button.disabled = false;
        const originalText = button.getAttribute('data-original-text');
        if (originalText) button.innerHTML = originalText;
        button.style.opacity = '';
        button.style.cursor = '';
      }
    }

    // Show loading state in a container
    function showContainerLoading(container, message) {
      if (typeof container === 'string') {
        container = document.querySelector(container);
      }
      if (!container) return;

      container.setAttribute('data-original-content', container.innerHTML);
      container.innerHTML = '<div class="loading-state" role="status" aria-live="polite"><div class="spinner"></div><div style="margin-top:12px;color:var(--text-muted)">' + (message || 'Loading...') + '</div></div>';
    }

    // Restore container from loading state
    function hideContainerLoading(container) {
      if (typeof container === 'string') {
        container = document.querySelector(container);
      }
      if (!container) return;

      const originalContent = container.getAttribute('data-original-content');
      if (originalContent) {
        container.innerHTML = originalContent;
        container.removeAttribute('data-original-content');
      }
    }

    // Show skeleton loading placeholder
    function showSkeleton(container, rows) {
      if (typeof container === 'string') {
        container = document.querySelector(container);
      }
      if (!container) return;

      rows = rows || 3;
      let skeletonHtml = '<div class="skeleton-loading" aria-hidden="true">';
      for (let i = 0; i < rows; i++) {
        const width = 60 + Math.random() * 40;
        skeletonHtml += '<div class="skeleton-line" style="width:' + width + '%;height:16px;background:var(--bg-tertiary);border-radius:4px;margin-bottom:12px;animation:skeleton-pulse 1.5s ease-in-out infinite"></div>';
      }
      skeletonHtml += '</div>';

      container.setAttribute('data-original-content', container.innerHTML);
      container.innerHTML = skeletonHtml;
    }

    // Helper: Parse date string consistently (handles timezone issues)
    function parseTripDate(dateStr) {
      if (!dateStr) return null;
      // Parse as local date to avoid timezone issues
      // Date strings like "2024-12-29" from DB should be treated as local dates
      const parts = String(dateStr).split('T')[0].split('-');
      if (parts.length === 3) {
        return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
      }
      return new Date(dateStr);
    }

    function getTripFin(tripId) {
      const tripIdStr = String(tripId);
      const trip = appData.trips.find(t => String(t.id) === tripIdStr);
      const orders = appData.orders.filter(o => String(o.trip_id) === tripIdStr);
      const expenses = appData.expenses.filter(e => String(e.trip_id) === tripIdStr);
      const loadRevenue = orders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
      const localFees = orders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
      const brokerFee = orders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0) + parseFloat(trip?.broker_fee || 0);
      const cleanGross = loadRevenue - brokerFee - localFees;
      const totalExpenses = expenses.reduce((s, e) => s + parseFloat(e.amount || 0), 0);

      // Check if driver is Owner-Operator
      const driver = appData.drivers.find(d => d.id === trip?.driver_id);
      const isOwnerOp = driver?.driver_type === 'OWNER_OP';

      let driverCut, dispatchFee, directTripExpenses, netProfit;

      if (isOwnerOp) {
        // OWNER-OPERATOR: Dispatch fee is company profit, expenses are NOT deducted
        const dispatchFeePercent = driver?.dispatch_fee_percent || 5;
        dispatchFee = cleanGross * (dispatchFeePercent / 100); // Company's profit from this trip
        driverCut = 0; // Owner-Ops are NOT paid by the company - they keep revenue minus dispatch fee
        // For Owner-Ops: Profit = Dispatch Fee only (no expenses deducted - owner's responsibility)
        directTripExpenses = brokerFee + localFees; // Don't include expenses (owner's responsibility)
        netProfit = dispatchFee; // Dispatch fee IS the profit for Owner-Ops
      } else {
        // COMPANY DRIVER: Normal calculation - driver gets cut, expenses deducted
        dispatchFee = 0; // No dispatch fee for company drivers
        const cutPercent = trip?.driver_cut_percent ?? driver?.cut_percent ?? 32;
        driverCut = cleanGross * (cutPercent / 100);
        directTripExpenses = brokerFee + localFees + driverCut + totalExpenses;
        netProfit = loadRevenue - directTripExpenses;
      }

      // Keep these for backward compatibility
      const truckGross = cleanGross - driverCut - dispatchFee;
      
      // Cash collected = COD and COP payments only (LOCAL_COD is paid to local drivers, not trip driver)
      const cashCollected = orders.filter(o => o.payment_type === 'COD' || o.payment_type === 'COP').reduce((s, o) => {
        // If bill_amount > 0, this is a split payment - only count cod_amount as cash
        if (parseFloat(o.bill_amount || 0) > 0) {
          return s + parseFloat(o.cod_amount || 0);
        }
        return s + parseFloat(o.revenue || 0);
      }, 0);
      
      return {
        loadRevenue,
        localFees,
        brokerFee,
        cleanGross,
        driverCut,           // Company Driver: driver's pay | Owner-Op: 0 (not paid by company)
        dispatchFee,         // Owner-Op: company's profit | Company Driver: 0
        truckGross,
        totalExpenses,
        directTripExpenses,  // All costs for this trip
        netProfit,           // Revenue - All Costs (for Owner-Op: dispatch fee)
        vehicleCount: orders.length,
        cashCollected,
        isOwnerOp            // Flag to indicate Owner-Operator trip
      };
    }

    // 
    //  ADVANCED FINANCIAL ANALYTICS ENGINE v2.0
    // 

    // ============ TRIP VOLUME & SEASONALITY TRACKING ============
    function calculateTripVolume(trips, truckId = null) {
      // Filter by truck if specified
      const filteredTrips = truckId 
        ? trips.filter(t => t.truck_id === truckId)
        : trips;
      
      if (filteredTrips.length === 0) return { 
        totalTrips: 0, totalTripValue: 0, monthlyAvg: 0, 
        monthlyData: {}, truckData: {}, seasonalIndex: {} 
      };
      
      const monthlyData = {};
      const truckMonthlyData = {};
      let totalTripValue = 0;
      
      filteredTrips.forEach(trip => {
        const startDate = parseTripDate(trip.trip_date || trip.period_start_date) || new Date();
        const endDate = trip.period_end_date ? (parseTripDate(trip.period_end_date) || startDate) : startDate;
        
        const startMonth = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}`;
        const endMonth = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}`;
        
        // Trip counting logic: Same month = 1, Cross month = 1.5
        const tripValue = (startMonth === endMonth) ? 1 : 1.5;
        totalTripValue += tripValue;
        
        // Track by month (attribute to start month)
        if (!monthlyData[startMonth]) {
          monthlyData[startMonth] = { trips: 0, tripValue: 0, revenue: 0, profit: 0, miles: 0, cars: 0 };
        }
        const fin = getTripFin(trip.id);
        monthlyData[startMonth].trips++;
        monthlyData[startMonth].tripValue += tripValue;
        monthlyData[startMonth].revenue += fin.loadRevenue;
        monthlyData[startMonth].profit += fin.netProfit;
        monthlyData[startMonth].miles += parseFloat(trip.miles || 0);
        monthlyData[startMonth].cars += fin.vehicleCount;
        
        // Track by truck per month
        if (trip.truck_id) {
          const truckKey = `${trip.truck_id}-${startMonth}`;
          if (!truckMonthlyData[truckKey]) {
            truckMonthlyData[truckKey] = { truckId: trip.truck_id, month: startMonth, trips: 0, tripValue: 0 };
          }
          truckMonthlyData[truckKey].trips++;
          truckMonthlyData[truckKey].tripValue += tripValue;
        }
      });
      
      // Calculate monthly average
      const monthCount = Object.keys(monthlyData).length || 1;
      const monthlyAvg = totalTripValue / monthCount;
      
      // Calculate seasonal index (compare each month to average)
      const seasonalIndex = {};
      Object.entries(monthlyData).forEach(([month, data]) => {
        seasonalIndex[month] = monthlyAvg > 0 ? (data.tripValue / monthlyAvg) : 1;
      });
      
      // Group truck data by truck
      const truckData = {};
      Object.values(truckMonthlyData).forEach(td => {
        if (!truckData[td.truckId]) {
          truckData[td.truckId] = { months: {}, totalTrips: 0, totalTripValue: 0 };
        }
        truckData[td.truckId].months[td.month] = td;
        truckData[td.truckId].totalTrips += td.trips;
        truckData[td.truckId].totalTripValue += td.tripValue;
      });
      
      return {
        totalTrips: filteredTrips.length,
        totalTripValue,
        monthlyAvg,
        monthlyData,
        truckData,
        seasonalIndex,
        monthCount
      };
    }

    // ============ BREAK-EVEN ANALYSIS ============
    function calculateBreakEven(options = {}) {
      const { truckId, tripId, targetProfit = 0, trips: filteredTrips } = options;

      // Get monthly fixed costs
      const monthlyFixedCosts = (appData.fixed_costs || []).reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);
      const activeTrucks = appData.trucks.filter(t => t.status === 'ACTIVE').length || 1;
      const fixedCostPerTruck = monthlyFixedCosts / activeTrucks;

      // Calculate historical averages - use filtered trips if provided
      const allTrips = filteredTrips || appData.trips || [];
      let totalBrokerFeeRatio = 0, totalLocalFeeRatio = 0, totalDriverCutRatio = 0;
      let totalExpensePerTrip = 0, avgMilesPerTrip = 0, avgCarsPerTrip = 0;
      let validTrips = 0;
      
      allTrips.forEach(trip => {
        const fin = getTripFin(trip.id);
        if (fin.loadRevenue > 0) {
          totalBrokerFeeRatio += fin.brokerFee / fin.loadRevenue;
          totalLocalFeeRatio += fin.localFees / fin.loadRevenue;
          const cleanGross = fin.loadRevenue - fin.brokerFee - fin.localFees;
          totalDriverCutRatio += cleanGross > 0 ? fin.driverCut / cleanGross : 0.32;
          totalExpensePerTrip += fin.totalExpenses;
          avgMilesPerTrip += parseFloat(trip.miles || 0);
          avgCarsPerTrip += fin.vehicleCount;
          validTrips++;
        }
      });
      
      const avgBrokerFeeRatio = validTrips > 0 ? totalBrokerFeeRatio / validTrips : 0.08;
      const avgLocalFeeRatio = validTrips > 0 ? totalLocalFeeRatio / validTrips : 0.02;
      const avgDriverCutRatio = validTrips > 0 ? totalDriverCutRatio / validTrips : 0.32;
      const avgExpensePerTrip = validTrips > 0 ? totalExpensePerTrip / validTrips : 500;
      avgMilesPerTrip = validTrips > 0 ? avgMilesPerTrip / validTrips : 2500;
      avgCarsPerTrip = validTrips > 0 ? avgCarsPerTrip / validTrips : 8;
      
      // Calculate break-even PPC (Price Per Car)
      // Revenue = PPC  Cars
      // Net Profit = Revenue  (1 - BrokerRatio - LocalRatio)  (1 - DriverCutRatio) - Expenses - FixedCostAllocation
      // At break-even: 0 = Revenue  TruckGrossRatio - Expenses - FixedCostAllocation
      // Revenue = (Expenses + FixedCostAllocation) / TruckGrossRatio
      
      const truckGrossRatio = (1 - avgBrokerFeeRatio - avgLocalFeeRatio) * (1 - avgDriverCutRatio);
      const tripVolume = calculateTripVolume(allTrips);
      const avgTripsPerMonth = tripVolume.monthlyAvg || 2;
      const fixedCostPerTrip = fixedCostPerTruck / avgTripsPerMonth;
      
      const breakEvenRevenue = truckGrossRatio > 0 
        ? (avgExpensePerTrip + fixedCostPerTrip + targetProfit) / truckGrossRatio 
        : 0;
      
      const breakEvenPPC = avgCarsPerTrip > 0 ? breakEvenRevenue / avgCarsPerTrip : 0;
      const profitablePPC = breakEvenPPC * 1.15; // 15% above break-even for comfortable profit
      
      // For specific trip calculation
      let tripSpecific = null;
      if (tripId) {
        const trip = appData.trips.find(t => t.id === tripId);
        if (trip) {
          const fin = getTripFin(tripId);
          const orders = appData.orders.filter(o => o.trip_id === tripId);
          const currentCars = orders.length;
          const currentRevenue = fin.loadRevenue;
          const driverCutPercent = trip.driver_cut_percent || 32;
          
          // Calculate what PPC is needed for break-even on THIS trip
          const tripBrokerRatio = currentRevenue > 0 ? fin.brokerFee / currentRevenue : avgBrokerFeeRatio;
          const tripLocalRatio = currentRevenue > 0 ? fin.localFees / currentRevenue : avgLocalFeeRatio;
          const tripTruckGrossRatio = (1 - tripBrokerRatio - tripLocalRatio) * (1 - driverCutPercent / 100);
          
          const tripBreakEvenRev = tripTruckGrossRatio > 0 
            ? (fin.totalExpenses + fixedCostPerTrip) / tripTruckGrossRatio 
            : 0;
          
          const remainingCapacity = 8 - currentCars; // Assuming 8-car hauler
          const currentPPC = currentCars > 0 ? currentRevenue / currentCars : 0;
          
          // What PPC needed for remaining cars to hit break-even
          const revenueNeeded = tripBreakEvenRev - currentRevenue;
          const ppcNeededForRemaining = remainingCapacity > 0 ? revenueNeeded / remainingCapacity : 0;
          
          tripSpecific = {
            currentCars,
            currentRevenue,
            currentPPC,
            remainingCapacity,
            tripBreakEvenRevenue: tripBreakEvenRev,
            ppcNeededForRemaining: Math.max(0, ppcNeededForRemaining),
            currentProfit: fin.netProfit,
            profitStatus: fin.netProfit >= fixedCostPerTrip ? 'PROFITABLE' : fin.netProfit >= 0 ? 'BREAK_EVEN' : 'LOSING',
            targetPPCForProfit: currentCars > 0 ? (tripBreakEvenRev * 1.15) / currentCars : profitablePPC
          };
        }
      }
      
      return {
        breakEvenPPC,
        profitablePPC,
        avgBrokerFeeRatio,
        avgLocalFeeRatio,
        avgDriverCutRatio,
        avgExpensePerTrip,
        avgMilesPerTrip,
        avgCarsPerTrip,
        fixedCostPerTruck,
        fixedCostPerTrip,
        truckGrossRatio,
        avgTripsPerMonth,
        tripSpecific
      };
    }

    // ============ CASH FLOW ANALYSIS ============
    function calculateCashFlow(periodStart = null, periodEnd = null) {
      const trips = appData.trips || [];
      const orders = appData.orders || [];
      const expenses = appData.expenses || [];
      const fixedCosts = appData.fixed_costs || [];
      
      // Filter by period if specified
      const filterByPeriod = (date) => {
        if (!periodStart && !periodEnd) return true;
        const d = new Date(date);
        if (periodStart && d < new Date(periodStart)) return false;
        if (periodEnd && d > new Date(periodEnd)) return false;
        return true;
      };
      
      const filteredTrips = trips.filter(t => filterByPeriod(t.trip_date));
      const filteredOrders = orders.filter(o => {
        const trip = trips.find(t => t.id === o.trip_id);
        return trip && filterByPeriod(trip.trip_date);
      });
      
      // CASH INFLOWS
      let codCollected = 0, copCollected = 0, localCodCollected = 0, checkPayments = 0, billedAmount = 0;
      
      filteredOrders.forEach(order => {
        const revenue = parseFloat(order.revenue || 0);
        const codAmount = parseFloat(order.cod_amount || 0);
        const billAmount = parseFloat(order.bill_amount || 0);
        
        switch (order.payment_type) {
          case 'COD':
            codCollected += billAmount > 0 ? codAmount : revenue;
            billedAmount += billAmount;
            break;
          case 'COP':
            copCollected += billAmount > 0 ? codAmount : revenue;
            billedAmount += billAmount;
            break;
          case 'LOCAL_COD':
            localCodCollected += billAmount > 0 ? codAmount : revenue;
            billedAmount += billAmount;
            break;
          case 'CHECK':
            checkPayments += revenue;
            break;
          case 'BILL':
          case 'SPLIT':
          default:
            billedAmount += revenue;
        }
      });
      
      const totalCashInflow = codCollected + copCollected + localCodCollected + checkPayments;
      const totalRevenue = codCollected + copCollected + localCodCollected + checkPayments + billedAmount;
      
      // CASH OUTFLOWS
      let driverPayments = 0, fuelExpenses = 0, tollsPermits = 0, maintenanceExpenses = 0, otherExpenses = 0;
      
      filteredTrips.forEach(trip => {
        const fin = getTripFin(trip.id);
        driverPayments += fin.driverCut;
        
        const tripExpenses = expenses.filter(e => e.trip_id === trip.id);
        tripExpenses.forEach(exp => {
          const amount = parseFloat(exp.amount || 0);
          switch (exp.category) {
            case 'FUEL': fuelExpenses += amount; break;
            case 'TOLLS':
            case 'PERMITS': tollsPermits += amount; break;
            case 'MAINTENANCE': maintenanceExpenses += amount; break;
            default: otherExpenses += amount;
          }
        });
      });
      
      // Fixed costs (monthly)
      const periodMonths = periodStart && periodEnd 
        ? Math.max(1, Math.ceil((new Date(periodEnd) - new Date(periodStart)) / (1000 * 60 * 60 * 24 * 30)))
        : 1;
      const totalFixedCosts = fixedCosts.reduce((s, fc) => s + parseFloat(fc.amount || 0), 0) * periodMonths;
      
      const totalCashOutflow = driverPayments + fuelExpenses + tollsPermits + maintenanceExpenses + otherExpenses + totalFixedCosts;
      const netCashFlow = totalCashInflow - totalCashOutflow;
      
      // Outstanding receivables (billed but not collected)
      const outstandingReceivables = billedAmount;
      
      return {
        inflows: {
          codCollected,
          copCollected,
          localCodCollected,
          checkPayments,
          billedAmount,
          totalCashInflow,
          totalRevenue
        },
        outflows: {
          driverPayments,
          fuelExpenses,
          tollsPermits,
          maintenanceExpenses,
          otherExpenses,
          totalFixedCosts,
          totalCashOutflow
        },
        netCashFlow,
        outstandingReceivables,
        cashPosition: netCashFlow + outstandingReceivables
      };
    }

    // ============ INCOME STATEMENT (P&L) ============
    function generateIncomeStatement(periodStart = null, periodEnd = null) {
      const trips = appData.trips || [];
      const fixedCosts = appData.fixed_costs || [];
      
      // Filter by period
      const filterByPeriod = (date) => {
        if (!periodStart && !periodEnd) return true;
        const d = new Date(date);
        if (periodStart && d < new Date(periodStart)) return false;
        if (periodEnd && d > new Date(periodEnd)) return false;
        return true;
      };
      
      const filteredTrips = trips.filter(t => filterByPeriod(t.trip_date));
      
      // REVENUE
      let grossRevenue = 0, brokerFees = 0, localFees = 0;
      
      // DIRECT COSTS (COGS)
      let driverCut = 0, fuelCosts = 0, tollsPermits = 0, otherDirectCosts = 0;
      
      filteredTrips.forEach(trip => {
        const fin = getTripFin(trip.id);
        grossRevenue += fin.loadRevenue;
        brokerFees += fin.brokerFee;
        localFees += fin.localFees;
        driverCut += fin.driverCut;
        
        const tripExpenses = (appData.expenses || []).filter(e => e.trip_id === trip.id);
        tripExpenses.forEach(exp => {
          const amount = isNaN(parseFloat(exp.amount)) ? 0 : parseFloat(exp.amount);
          if (exp.category === 'FUEL') fuelCosts += amount;
          else if (exp.category === 'TOLLS' || exp.category === 'PERMITS') tollsPermits += amount;
          else otherDirectCosts += amount;
        });
      });
      
      const netRevenue = grossRevenue - brokerFees - localFees;
      const totalDirectCosts = driverCut + fuelCosts + tollsPermits + otherDirectCosts;
      const grossProfit = netRevenue - totalDirectCosts;
      const grossProfitMargin = grossRevenue > 0 ? (grossProfit / grossRevenue * 100) : 0;
      
      // OPERATING EXPENSES (Fixed Costs)
      const periodMonths = periodStart && periodEnd 
        ? Math.max(1, Math.ceil((new Date(periodEnd) - new Date(periodStart)) / (1000 * 60 * 60 * 24 * 30)))
        : Math.max(1, Object.keys(calculateTripVolume(filteredTrips).monthlyData).length);
      
      const totalFixedCosts = fixedCosts.reduce((s, fc) => s + parseFloat(fc.amount || 0), 0) * periodMonths;
      const operatingProfit = grossProfit - totalFixedCosts;
      const operatingProfitMargin = grossRevenue > 0 ? (operatingProfit / grossRevenue * 100) : 0;
      
      // Maintenance from maintenance_records
      const maintenanceCosts = (appData.maintenance_records || [])
        .filter(m => filterByPeriod(m.service_date))
        .reduce((s, m) => s + parseFloat(m.total_cost || 0), 0);
      
      const netProfit = operatingProfit - maintenanceCosts;
      const netProfitMargin = grossRevenue > 0 ? (netProfit / grossRevenue * 100) : 0;
      
      return {
        revenue: {
          grossRevenue,
          brokerFees,
          localFees,
          netRevenue
        },
        directCosts: {
          driverCut,
          fuelCosts,
          tollsPermits,
          otherDirectCosts,
          totalDirectCosts
        },
        grossProfit,
        grossProfitMargin,
        operatingExpenses: {
          fixedCosts: totalFixedCosts,
          maintenanceCosts
        },
        operatingProfit,
        operatingProfitMargin,
        netProfit,
        netProfitMargin,
        periodMonths
      };
    }

    // ============ FORECASTING ENGINE ============
    function generateForecast(monthsAhead = 3) {
      const tripVolume = calculateTripVolume(appData.trips);
      const incomeStatement = generateIncomeStatement();
      const breakEven = calculateBreakEven();
      
      // Historical monthly averages
      const monthlyData = Object.values(tripVolume.monthlyData);
      const avgMonthlyRevenue = monthlyData.length > 0 
        ? monthlyData.reduce((s, m) => s + m.revenue, 0) / monthlyData.length 
        : 0;
      const avgMonthlyProfit = monthlyData.length > 0 
        ? monthlyData.reduce((s, m) => s + m.profit, 0) / monthlyData.length 
        : 0;
      const avgMonthlyCars = monthlyData.length > 0 
        ? monthlyData.reduce((s, m) => s + m.cars, 0) / monthlyData.length 
        : 0;
      const avgMonthlyMiles = monthlyData.length > 0 
        ? monthlyData.reduce((s, m) => s + m.miles, 0) / monthlyData.length 
        : 0;
      
      // Calculate trend (simple linear regression on recent 6 months)
      const recentMonths = monthlyData.slice(-6);
      let trend = 0;
      if (recentMonths.length >= 3) {
        const n = recentMonths.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
        recentMonths.forEach((m, i) => {
          sumX += i;
          sumY += m.revenue;
          sumXY += i * m.revenue;
          sumX2 += i * i;
        });
        trend = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX) || 0;
      }
      
      // Seasonal factors (by month of year)
      const seasonalFactors = {};
      for (let m = 1; m <= 12; m++) {
        const monthRevenues = monthlyData.filter(md => {
          const [year, month] = Object.keys(tripVolume.monthlyData).find(k => tripVolume.monthlyData[k] === md)?.split('-') || [];
          return parseInt(month) === m;
        });
        seasonalFactors[m] = monthRevenues.length > 0 && avgMonthlyRevenue > 0
          ? monthRevenues.reduce((s, md) => s + md.revenue, 0) / monthRevenues.length / avgMonthlyRevenue
          : 1;
      }
      
      // Generate forecasts
      const forecasts = [];
      const today = new Date();
      let cumulativeRevenue = 0, cumulativeProfit = 0;
      
      for (let i = 1; i <= monthsAhead; i++) {
        const forecastDate = new Date(today.getFullYear(), today.getMonth() + i, 1);
        const forecastMonth = forecastDate.getMonth() + 1;
        const seasonalFactor = seasonalFactors[forecastMonth] || 1;
        
        // Base forecast + trend + seasonal adjustment
        const baseRevenue = avgMonthlyRevenue + (trend * (monthlyData.length + i));
        const forecastRevenue = baseRevenue * seasonalFactor;
        
        // Estimate profit based on historical margin
        const profitMargin = avgMonthlyRevenue > 0 ? avgMonthlyProfit / avgMonthlyRevenue : 0.15;
        const forecastProfit = forecastRevenue * profitMargin;
        
        // Estimate cars and trips
        const forecastCars = avgMonthlyCars * seasonalFactor;
        const forecastTrips = tripVolume.monthlyAvg * seasonalFactor;
        
        cumulativeRevenue += forecastRevenue;
        cumulativeProfit += forecastProfit;
        
        forecasts.push({
          month: forecastDate.toLocaleString('default', { month: 'short', year: 'numeric' }),
          monthNum: forecastMonth,
          revenue: forecastRevenue,
          profit: forecastProfit,
          cars: forecastCars,
          trips: forecastTrips,
          seasonalFactor,
          cumulativeRevenue,
          cumulativeProfit,
          confidence: Math.max(0.5, 1 - (i * 0.1)) // Confidence decreases with time
        });
      }
      
      // Calculate annualized projections
      const annualizedRevenue = avgMonthlyRevenue * 12;
      const annualizedProfit = avgMonthlyProfit * 12;
      const annualizedCars = avgMonthlyCars * 12;
      
      // What-if scenarios
      const scenarios = {
        conservative: {
          revenue: annualizedRevenue * 0.85,
          profit: annualizedProfit * 0.75
        },
        base: {
          revenue: annualizedRevenue,
          profit: annualizedProfit
        },
        optimistic: {
          revenue: annualizedRevenue * 1.15,
          profit: annualizedProfit * 1.3
        }
      };
      
      return {
        forecasts,
        trend,
        seasonalFactors,
        avgMonthlyRevenue,
        avgMonthlyProfit,
        avgMonthlyCars,
        avgMonthlyMiles,
        annualized: {
          revenue: annualizedRevenue,
          profit: annualizedProfit,
          cars: annualizedCars
        },
        scenarios
      };
    }

    // ============ EFFICIENCY METRICS ============
    function calculateEfficiencyMetrics(filteredTrips) {
      // Use filtered trips if provided, otherwise use all trips
      const trips = filteredTrips || appData.trips || [];
      const trucks = appData.trucks.filter(t => t.status === 'ACTIVE') || [];
      const tripVolume = calculateTripVolume(trips);
      const incomeStatement = generateIncomeStatement();

      // Get fleet miles from Samsara if available
      const dateRange = getDashboardDateRange();
      const fleetMilesResult = getFleetMiles(dateRange.start, dateRange.end);

      let totalCars = 0, totalRevenue = 0, totalProfit = 0;

      trips.forEach(trip => {
        const fin = getTripFin(trip.id);
        totalCars += fin.vehicleCount;
        totalRevenue += fin.loadRevenue;
        totalProfit += fin.netProfit;
      });

      // Use Samsara miles for fleet-wide metrics, fall back to trip miles
      const totalMiles = fleetMilesResult.miles;
      const milesSource = fleetMilesResult.source; // 'samsara' or 'trips'
      
      const profitPerMile = totalMiles > 0 ? totalProfit / totalMiles : 0;
      const profitPerCar = totalCars > 0 ? totalProfit / totalCars : 0;
      const profitPerTrip = trips.length > 0 ? totalProfit / trips.length : 0;
      const revenuePerMile = totalMiles > 0 ? totalRevenue / totalMiles : 0;
      const revenuePerCar = totalCars > 0 ? totalRevenue / totalCars : 0;
      
      // Cost metrics
      const costPerMile = totalMiles > 0 ? (totalRevenue - totalProfit) / totalMiles : 0;
      const costPerCar = totalCars > 0 ? (totalRevenue - totalProfit) / totalCars : 0;
      
      // Utilization (assuming 8-car hauler)
      const maxCapacity = 8;
      const potentialCars = trips.length * maxCapacity * 2; // Round trip
      const utilizationRate = potentialCars > 0 ? (totalCars / potentialCars * 100) : 0;
      
      // Operating ratio
      const operatingRatio = totalRevenue > 0 ? ((totalRevenue - totalProfit) / totalRevenue * 100) : 100;
      
      // Per truck metrics
      const truckCount = trucks.length || 1;
      const monthCount = tripVolume.monthCount || 1;
      const profitPerTruckPerMonth = totalProfit / truckCount / monthCount;
      const tripsPerTruckPerMonth = tripVolume.totalTripValue / truckCount / monthCount;
      
      // Target benchmarks
      const targets = {
        profitPerMile: 0.50,
        profitPerCar: 75,
        profitPerTrip: 500,
        profitPerTruckPerMonth: 3000,
        revenuePerMile: 2.50,
        costPerMile: 2.00,
        utilizationRate: 85,
        operatingRatio: 85,
        tripsPerMonth: 2 // "Good Season" target
      };
      
      // Health scores (0-100)
      const scores = {
        profitPerMile: Math.min(100, (profitPerMile / targets.profitPerMile) * 100),
        profitPerCar: Math.min(100, (profitPerCar / targets.profitPerCar) * 100),
        utilizationRate: Math.min(100, (utilizationRate / targets.utilizationRate) * 100),
        operatingRatio: Math.min(100, (targets.operatingRatio / Math.max(operatingRatio, 1)) * 100),
        tripsPerMonth: Math.min(100, (tripsPerTruckPerMonth / targets.tripsPerMonth) * 100)
      };
      
      const overallHealthScore = Object.values(scores).reduce((s, v) => s + v, 0) / Object.keys(scores).length;
      
      return {
        metrics: {
          profitPerMile,
          profitPerCar,
          profitPerTrip,
          profitPerTruckPerMonth,
          revenuePerMile,
          revenuePerCar,
          costPerMile,
          costPerCar,
          utilizationRate,
          operatingRatio,
          tripsPerTruckPerMonth
        },
        targets,
        scores,
        overallHealthScore,
        totalMiles,
        totalCars,
        totalRevenue,
        totalProfit,
        truckCount,
        tripCount: trips.length,
        milesSource // 'samsara' or 'trips'
      };
    }

    // ============ DISPATCHER PRICING GUIDANCE ============
    function getDispatcherPricingGuidance(tripId) {
      const breakEven = calculateBreakEven({ tripId });
      const efficiency = calculateEfficiencyMetrics();
      const trip = appData.trips.find(t => t.id === tripId);
      const orders = appData.orders.filter(o => o.trip_id === tripId);
      const fin = getTripFin(tripId);
      
      if (!trip) return null;
      
      const currentCars = orders.length;
      const maxCapacity = 8;
      const remainingSlots = maxCapacity - currentCars;
      const currentRevenue = fin.loadRevenue;
      const currentPPC = currentCars > 0 ? currentRevenue / currentCars : 0;
      
      // Calculate recommended prices
      const minPPC = breakEven.breakEvenPPC; // Minimum to not lose money
      const targetPPC = breakEven.profitablePPC; // Target for good profit
      const avgMarketPPC = efficiency.metrics.revenuePerCar; // Historical average
      
      // Status indicators
      let tripStatus = 'LOADING';
      let statusColor = 'var(--amber)';
      let statusMessage = '';
      
      if (fin.netProfit >= breakEven.fixedCostPerTrip) {
        tripStatus = 'PROFITABLE';
        statusColor = 'var(--green)';
        statusMessage = `On track for $${fin.netProfit.toFixed(0)} profit`;
      } else if (fin.netProfit >= 0) {
        tripStatus = 'BREAK_EVEN';
        statusColor = 'var(--blue)';
        statusMessage = 'Covering direct costs, need more revenue for profit';
      } else {
        tripStatus = 'BELOW_TARGET';
        statusColor = 'var(--red)';
        statusMessage = `Need $${Math.abs(fin.netProfit).toFixed(0)} more to break even`;
      }
      
      // Calculate what remaining slots need to average
      let recommendedPPCForRemaining = targetPPC;
      if (currentCars > 0 && remainingSlots > 0) {
        const targetTotalRevenue = targetPPC * maxCapacity;
        const revenueNeeded = targetTotalRevenue - currentRevenue;
        recommendedPPCForRemaining = revenueNeeded / remainingSlots;
      }
      
      return {
        tripId,
        tripNumber: trip.trip_number,
        currentCars,
        remainingSlots,
        maxCapacity,
        currentRevenue,
        currentPPC,
        currentProfit: fin.netProfit,
        tripStatus,
        statusColor,
        statusMessage,
        pricing: {
          minimum: Math.max(0, minPPC),
          target: targetPPC,
          marketAvg: avgMarketPPC,
          recommendedForRemaining: Math.max(0, recommendedPPCForRemaining)
        },
        breakEvenInfo: {
          breakEvenPPC: breakEven.breakEvenPPC,
          fixedCostAllocation: breakEven.fixedCostPerTrip,
          truckGrossRatio: breakEven.truckGrossRatio
        }
      };
    }

    // ============ RENDER EXECUTIVE FINANCIAL DASHBOARD ============
    function renderExecutiveDashboard(c) {
      // Filter by financialsYear
      const yearStart = financialsYear + '-01-01';
      const yearEnd = financialsYear + '-12-31';

      const allTrips = appData.trips || [];
      const yearTrips = allTrips.filter(t => {
        if (!t.trip_date) return false;
        return t.trip_date >= yearStart && t.trip_date <= yearEnd;
      });

      const efficiency = calculateEfficiencyMetrics(yearTrips);
      const allTimeEfficiency = calculateEfficiencyMetrics(allTrips); // All time score
      const cashFlow = calculateCashFlow(yearStart, yearEnd);
      const incomeStatement = generateIncomeStatement(yearStart, yearEnd);
      const forecast = generateForecast(6);
      const tripVolume = calculateTripVolume(yearTrips);
      const breakEven = calculateBreakEven({ trips: yearTrips });

      // Health score color (current year)
      const healthColor = efficiency.overallHealthScore >= 80 ? 'var(--green)'
        : efficiency.overallHealthScore >= 60 ? 'var(--amber)'
        : 'var(--red)';

      const healthGrade = efficiency.overallHealthScore >= 90 ? 'A+'
        : efficiency.overallHealthScore >= 80 ? 'A'
        : efficiency.overallHealthScore >= 70 ? 'B'
        : efficiency.overallHealthScore >= 60 ? 'C'
        : efficiency.overallHealthScore >= 50 ? 'D'
        : 'F';

      // All-time health score color
      const allTimeHealthColor = allTimeEfficiency.overallHealthScore >= 80 ? 'var(--green)'
        : allTimeEfficiency.overallHealthScore >= 60 ? 'var(--amber)'
        : 'var(--red)';

      const allTimeHealthGrade = allTimeEfficiency.overallHealthScore >= 90 ? 'A+'
        : allTimeEfficiency.overallHealthScore >= 80 ? 'A'
        : allTimeEfficiency.overallHealthScore >= 70 ? 'B'
        : allTimeEfficiency.overallHealthScore >= 60 ? 'C'
        : allTimeEfficiency.overallHealthScore >= 50 ? 'D'
        : 'F';
      
      // Year selector options for Executive tab
      const currentYear = new Date().getFullYear();
      const yearOptions = [currentYear, currentYear - 1, currentYear - 2, currentYear - 3].map(y =>
        '<option value="' + y + '"' + (financialsYear === y ? ' selected' : '') + '>' + y + '</option>'
      ).join('');

      // Tabs for consolidated view
      const tabs = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px">
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button class="btn btn-primary" style="padding:6px 12px;font-size:12px" onclick="finTab='executive';renderConsolidatedFinancials(document.getElementById('main-content'))"> Executive</button>
            <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='analysis';renderConsolidatedFinancials(document.getElementById('main-content'))"> Analysis</button>
            <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='overview';renderConsolidatedFinancials(document.getElementById('main-content'))"> Overview</button>
            <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='costs';renderConsolidatedFinancials(document.getElementById('main-content'))"> Costs</button>
            <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='trips';renderConsolidatedFinancials(document.getElementById('main-content'))"> By Trip</button>
            <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='drivers';renderConsolidatedFinancials(document.getElementById('main-content'))"> By Driver</button>
            <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='brokers';renderConsolidatedFinancials(document.getElementById('main-content'))"> By Broker</button>
            <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='lanes';renderConsolidatedFinancials(document.getElementById('main-content'))"> By Lane</button>
          </div>
          <div style="display:flex;align-items:center;gap:8px;background:var(--bg-app);padding:8px 12px;border-radius:6px">
            <label style="font-weight:600;color:var(--text-secondary);font-size:13px">Year:</label>
            <select onchange="financialsYear=parseInt(this.value);renderConsolidatedFinancials(document.getElementById('main-content'))" style="padding:6px 12px;border:1px solid var(--border);border-radius:6px;font-weight:600">
              ${yearOptions}
            </select>
          </div>
        </div>
      `;
      
      c.innerHTML = tabs + `
        <div class="header">
          <h2> Executive Financial Dashboard</h2>
          <div style="display:flex;gap:12px">
            <button class="btn btn-secondary" onclick="window.print()"> Print</button>
            <button class="btn btn-secondary" onclick="loadAllData(true).then(()=>renderPage())"> Refresh</button>
          </div>
        </div>
        
        <!-- Health Score Banner - Current Year + All Time -->
        <div style="display:flex;gap:16px;margin-bottom:24px;flex-wrap:wrap">
          <!-- Current Year Score -->
          <div style="flex:1;min-width:280px;background:linear-gradient(135deg,${healthColor}20,${healthColor}10);border:2px solid ${healthColor};border-radius:16px;padding:24px">
            <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px">
              <div>
                <div style="font-size:12px;color:${healthColor};font-weight:600;margin-bottom:4px">${financialsYear} HEALTH SCORE</div>
                <div style="font-size:48px;font-weight:800;color:${healthColor};line-height:1">${efficiency.overallHealthScore.toFixed(0)}<span style="font-size:24px">/100</span></div>
                <div style="font-size:14px;color:var(--text-secondary);margin-top:4px">Grade: ${healthGrade}</div>
              </div>
              <div style="display:flex;gap:12px;flex-wrap:wrap">
                ${Object.entries(efficiency.scores).map(([key, score]) => `
                  <div style="text-align:center">
                    <div style="width:50px;height:50px;border-radius:50%;border:3px solid ${score >= 80 ? 'var(--green)' : score >= 60 ? 'var(--amber)' : 'var(--red)'};display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:${score >= 80 ? 'var(--green)' : score >= 60 ? 'var(--amber)' : 'var(--red)'}">${score.toFixed(0)}%</div>
                    <div style="font-size:9px;color:var(--text-muted);margin-top:2px;text-transform:uppercase">${key.replace(/([A-Z])/g, ' $1').trim()}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
          <!-- All Time Score -->
          <div style="min-width:200px;background:linear-gradient(135deg,${allTimeHealthColor}15,${allTimeHealthColor}05);border:2px solid ${allTimeHealthColor}80;border-radius:16px;padding:24px">
            <div style="text-align:center">
              <div style="font-size:12px;color:${allTimeHealthColor};font-weight:600;margin-bottom:4px">ALL TIME SCORE</div>
              <div style="font-size:36px;font-weight:800;color:${allTimeHealthColor};line-height:1">${allTimeEfficiency.overallHealthScore.toFixed(0)}<span style="font-size:18px">/100</span></div>
              <div style="font-size:14px;color:var(--text-secondary);margin-top:4px">Grade: ${allTimeHealthGrade}</div>
              <div style="font-size:var(--text-xs);color:var(--text-muted);margin-top:8px">${allTrips.length} total trips</div>
            </div>
          </div>
        </div>
        
        <!-- AI-Powered Optimization Recommendations (moved here) -->
        <div class="card" style="margin-bottom:16px">
          <div class="card-header" style="background:linear-gradient(135deg,var(--amber),var(--amber));color:white;padding:12px 16px">
            <h3 style="color:white;font-size:14px"> AI-Powered Optimization Recommendations</h3>
          </div>
          <div style="padding:14px">
            ${generateOptimizationRecommendations(efficiency, tripVolume, breakEven, forecast)}
          </div>
        </div>
        
        <!-- Key Financial Metrics Row -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">
          <div class="stat-card" style="border-left:4px solid var(--green)">
            <div class="stat-icon green"></div>
            <div class="stat-content">
              <div class="label">Total Revenue</div>
              <div class="value green">${formatMoney(efficiency.totalRevenue)}</div>
              <div class="trend up"> ${formatMoney(forecast.avgMonthlyRevenue)}/mo avg</div>
            </div>
          </div>
          <div class="stat-card" style="border-left:4px solid ${efficiency.totalProfit >= 0 ? 'var(--green)' : 'var(--red)'}">
            <div class="stat-icon ${efficiency.totalProfit >= 0 ? 'green' : 'red'}"></div>
            <div class="stat-content">
              <div class="label">Net Profit</div>
              <div class="value ${efficiency.totalProfit >= 0 ? 'green' : 'red'}">${formatMoney(efficiency.totalProfit)}</div>
              <div class="trend ${efficiency.totalProfit >= 0 ? 'up' : 'down'}">${incomeStatement.netProfitMargin.toFixed(1)}% margin</div>
            </div>
          </div>
          <div class="stat-card" style="border-left:4px solid var(--blue)">
            <div class="stat-icon blue"></div>
            <div class="stat-content">
              <div class="label">Cash Position</div>
              <div class="value">${formatMoney(cashFlow.netCashFlow)}</div>
              <div style="font-size:var(--text-xs);color:var(--text-muted)">${formatMoney(cashFlow.outstandingReceivables)} outstanding</div>
            </div>
          </div>
          <div class="stat-card" style="border-left:4px solid var(--purple)">
            <div class="stat-icon" style="background:rgba(139,92,246,0.12);color:var(--purple)"></div>
            <div class="stat-content">
              <div class="label">Profit Per Mile</div>
              <div class="value" style="color:${efficiency.metrics.profitPerMile >= 0.50 ? 'var(--green)' : 'var(--amber)'}">${formatMoney(efficiency.metrics.profitPerMile)}</div>
              <div style="font-size:var(--text-xs);color:var(--text-muted)">Target: $0.50+</div>
            </div>
          </div>
        </div>
        
        <!-- Quick View - Company Profitability Metrics -->
        ${(function() {
          const monthlyFixedCosts = (appData.fixed_costs || []).reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);
          const periodMonths = Math.max(1, incomeStatement.periodMonths || 1);
          const totalFixedCosts = monthlyFixedCosts * periodMonths;
          const maintenanceCosts = incomeStatement.operatingExpenses.maintenanceCosts || 0;
          const totalOperatingCosts = incomeStatement.revenue.brokerFees + incomeStatement.revenue.localFees + incomeStatement.directCosts.totalDirectCosts + totalFixedCosts + maintenanceCosts;
          const cpm = efficiency.totalMiles > 0 ? (totalOperatingCosts / efficiency.totalMiles) : 0;
          const rpm = efficiency.totalMiles > 0 ? (efficiency.totalRevenue / efficiency.totalMiles) : 0;
          const marginPerMile = rpm - cpm;
          const currentAvgPrice = efficiency.totalCars > 0 ? (efficiency.totalRevenue / efficiency.totalCars) : 0;
          const targetVehiclePrice = breakEven.profitablePPC || 0;
          const priceGap = targetVehiclePrice - currentAvgPrice;
          
          return '<div class="card" style="margin-bottom:24px;background:linear-gradient(135deg,var(--bg-elevated),var(--bg-elevated));color:white;overflow:hidden">' +
            '<div style="padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.1)">' +
            '<div style="display:flex;align-items:center;justify-content:space-between">' +
            '<h3 style="margin:0;color:white;font-size:16px"> Quick View - Company Profitability</h3>' +
            '<span style="background:rgba(255,255,255,0.15);padding:4px 10px;border-radius:12px;font-size:11px">' + efficiency.totalMiles.toLocaleString() + ' miles  ' + efficiency.totalCars + ' cars</span>' +
            '</div></div>' +
            '<div style="display:grid;grid-template-columns:repeat(6,1fr);gap:0">' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1)">' +
            '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Cost Per Mile</div>' +
            '<div style="font-size:28px;font-weight:700;color:var(--red)">$' + cpm.toFixed(2) + '</div>' +
            '<div style="font-size:10px;color:var(--text-muted);margin-top:4px">Operating CPM</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1)">' +
            '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Revenue Per Mile</div>' +
            '<div style="font-size:28px;font-weight:700;color:var(--primary-400)">$' + rpm.toFixed(2) + '</div>' +
            '<div style="font-size:10px;color:var(--text-muted);margin-top:4px">Gross RPM</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1);background:' + (marginPerMile >= 0 ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)') + '">' +
            '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Margin Per Mile</div>' +
            '<div style="font-size:28px;font-weight:700;color:' + (marginPerMile >= 0 ? 'var(--primary-400)' : 'var(--red)') + '">$' + marginPerMile.toFixed(2) + '</div>' +
            '<div style="font-size:10px;color:' + (marginPerMile >= 0 ? 'var(--green)' : 'var(--red)') + ';margin-top:4px">' + (marginPerMile >= 0 ? ' Profitable' : ' Losing Money') + '</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1)">' +
            '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Avg Vehicle Price</div>' +
            '<div style="font-size:28px;font-weight:700;color:var(--blue)">$' + currentAvgPrice.toFixed(0) + '</div>' +
            '<div style="font-size:10px;color:var(--text-muted);margin-top:4px">Current Average</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1)">' +
            '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Break-Even Price</div>' +
            '<div style="font-size:28px;font-weight:700;color:var(--purple)">$' + targetVehiclePrice.toFixed(0) + '</div>' +
            '<div style="font-size:10px;color:var(--text-muted);margin-top:4px">Min per vehicle</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;background:' + (priceGap <= 0 ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)') + '">' +
            '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Profit Per Vehicle</div>' +
            '<div style="font-size:28px;font-weight:700;color:' + (priceGap <= 0 ? 'var(--primary-400)' : 'var(--red)') + '">$' + Math.abs(currentAvgPrice - targetVehiclePrice).toFixed(0) + '</div>' +
            '<div style="font-size:10px;color:' + (priceGap <= 0 ? 'var(--green)' : 'var(--red)') + ';margin-top:4px">' + (priceGap <= 0 ? ' Profitable' : ' Losing $' + Math.abs(priceGap).toFixed(0) + '/car') + '</div>' +
            '</div>' +
            '</div></div>';
        })()}
        
        <!-- Two Column Layout -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px">
          
          <!-- Income Statement Summary -->
          <div class="card">
            <div class="card-header" style="background:linear-gradient(135deg,var(--green),var(--green));color:white">
              <h3 style="color:white"> Income Statement (P&L)</h3>
            </div>
            <div style="padding:20px">
              <table style="width:100%;font-size:14px">
                <tr style="background:var(--green-dim)"><td colspan="2" style="font-weight:700;color:var(--primary-800);padding:10px">REVENUE</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Gross Revenue</td><td style="text-align:right;font-weight:600">${formatMoney(incomeStatement.revenue.grossRevenue)}</td></tr>
                <tr><td style="padding:8px 10px 8px 24px;color:var(--text-muted)">Less: Broker Fees</td><td style="text-align:right;color:var(--red)">(${formatMoney(incomeStatement.revenue.brokerFees)})</td></tr>
                <tr><td style="padding:8px 10px 8px 24px;color:var(--text-muted)">Less: Local Fees</td><td style="text-align:right;color:var(--amber)">(${formatMoney(incomeStatement.revenue.localFees)})</td></tr>
                <tr style="border-top:1px solid var(--border)"><td style="padding:10px;font-weight:600">Net Revenue</td><td style="text-align:right;font-weight:700">${formatMoney(incomeStatement.revenue.netRevenue)}</td></tr>
                
                <tr style="background:var(--red-dim)"><td colspan="2" style="font-weight:700;color:var(--red);padding:10px">DIRECT COSTS</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Driver Cut</td><td style="text-align:right">(${formatMoney(incomeStatement.directCosts.driverCut)})</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Fuel</td><td style="text-align:right">(${formatMoney(incomeStatement.directCosts.fuelCosts)})</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Tolls & Permits</td><td style="text-align:right">(${formatMoney(incomeStatement.directCosts.tollsPermits)})</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Other Direct</td><td style="text-align:right">(${formatMoney(incomeStatement.directCosts.otherDirectCosts)})</td></tr>
                <tr style="background:var(--green-dim)"><td style="padding:10px;font-weight:700">GROSS PROFIT</td><td style="text-align:right;font-weight:700;color:var(--primary-800)">${formatMoney(incomeStatement.grossProfit)} <span style="font-size:12px">(${incomeStatement.grossProfitMargin.toFixed(1)}%)</span></td></tr>
                
                <tr style="background:var(--amber-dim)"><td colspan="2" style="font-weight:700;color:var(--amber);padding:10px">OPERATING EXPENSES</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Fixed Costs</td><td style="text-align:right">(${formatMoney(incomeStatement.operatingExpenses.fixedCosts)})</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Maintenance</td><td style="text-align:right">(${formatMoney(incomeStatement.operatingExpenses.maintenanceCosts)})</td></tr>
                <tr style="background:${incomeStatement.netProfit >= 0 ? 'var(--green-dim)' : 'var(--red-dim)'}"><td style="padding:12px;font-weight:700;font-size:16px">NET PROFIT</td><td style="text-align:right;font-weight:700;font-size:18px;color:${incomeStatement.netProfit >= 0 ? 'var(--primary-800)' : 'var(--red)'}">${formatMoney(incomeStatement.netProfit)}</td></tr>
              </table>
            </div>
          </div>
          
          <!-- Cash Flow Summary -->
          <div class="card">
            <div class="card-header" style="background:linear-gradient(135deg,var(--blue),var(--blue));color:white">
              <h3 style="color:white"> Cash Flow Statement</h3>
            </div>
            <div style="padding:20px">
              <table style="width:100%;font-size:14px">
                <tr style="background:var(--blue-dim)"><td colspan="2" style="font-weight:700;color:var(--blue);padding:10px">CASH INFLOWS</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">COD Collected</td><td style="text-align:right;color:var(--green);font-weight:600">+${formatMoney(cashFlow.inflows.codCollected)}</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">COP Collected</td><td style="text-align:right;color:var(--green);font-weight:600">+${formatMoney(cashFlow.inflows.copCollected)}</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Local COD</td><td style="text-align:right;color:var(--green);font-weight:600">+${formatMoney(cashFlow.inflows.localCodCollected)}</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Check Payments</td><td style="text-align:right;color:var(--green);font-weight:600">+${formatMoney(cashFlow.inflows.checkPayments)}</td></tr>
                <tr style="border-top:1px solid var(--border)"><td style="padding:10px;font-weight:600">Total Cash In</td><td style="text-align:right;font-weight:700;color:var(--green)">${formatMoney(cashFlow.inflows.totalCashInflow)}</td></tr>
                
                <tr style="background:var(--red-dim)"><td colspan="2" style="font-weight:700;color:var(--red);padding:10px">CASH OUTFLOWS</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Driver Payments</td><td style="text-align:right;color:var(--red)">-${formatMoney(cashFlow.outflows.driverPayments)}</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Fuel</td><td style="text-align:right;color:var(--red)">-${formatMoney(cashFlow.outflows.fuelExpenses)}</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Tolls & Permits</td><td style="text-align:right;color:var(--red)">-${formatMoney(cashFlow.outflows.tollsPermits)}</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Fixed Costs</td><td style="text-align:right;color:var(--red)">-${formatMoney(cashFlow.outflows.totalFixedCosts)}</td></tr>
                <tr><td style="padding:8px 10px 8px 24px">Maintenance & Other</td><td style="text-align:right;color:var(--red)">-${formatMoney(cashFlow.outflows.maintenanceExpenses + cashFlow.outflows.otherExpenses)}</td></tr>
                <tr style="border-top:1px solid var(--border)"><td style="padding:10px;font-weight:600">Total Cash Out</td><td style="text-align:right;font-weight:700;color:var(--red)">${formatMoney(cashFlow.outflows.totalCashOutflow)}</td></tr>
                
                <tr style="background:${cashFlow.netCashFlow >= 0 ? 'var(--green-dim)' : 'var(--red-dim)'}"><td style="padding:12px;font-weight:700;font-size:16px">NET CASH FLOW</td><td style="text-align:right;font-weight:700;font-size:18px;color:${cashFlow.netCashFlow >= 0 ? 'var(--primary-800)' : 'var(--red)'}">${formatMoney(cashFlow.netCashFlow)}</td></tr>
                <tr><td style="padding:10px;color:var(--text-muted)">Outstanding Receivables</td><td style="text-align:right;font-weight:600;color:var(--amber)">${formatMoney(cashFlow.outstandingReceivables)}</td></tr>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Trip Volume & Seasonality -->
        <div class="card" style="margin-bottom:24px">
          <div class="card-header" style="background:linear-gradient(135deg,var(--purple),var(--purple));color:white">
            <h3 style="color:white"> Trip Volume & Seasonality Analysis</h3>
            <div style="display:flex;gap:12px;align-items:center">
              <span style="font-size:13px;opacity:0.9">Target: 2 trips/truck/month</span>
            </div>
          </div>
          <div style="padding:20px">
            <!-- Trip Volume Stats -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:24px">
              <div style="background:var(--purple-dim);padding:16px;border-radius:12px;text-align:center">
                <div style="font-size:11px;color:var(--purple);font-weight:600">TOTAL TRIPS</div>
                <div style="font-size:28px;font-weight:800;color:var(--purple)">${tripVolume.totalTrips}</div>
                <div style="font-size:12px;color:var(--text-muted)">${tripVolume.totalTripValue.toFixed(1)} trip value</div>
              </div>
              <div style="background:var(--blue-dim);padding:16px;border-radius:12px;text-align:center">
                <div style="font-size:11px;color:var(--blue);font-weight:600">AVG TRIPS/MONTH</div>
                <div style="font-size:28px;font-weight:800;color:${tripVolume.monthlyAvg >= 2 * efficiency.truckCount ? 'var(--green)' : 'var(--amber)'}">${tripVolume.monthlyAvg.toFixed(1)}</div>
                <div style="font-size:12px;color:var(--text-muted)">Target: ${2 * efficiency.truckCount}/mo</div>
              </div>
              <div style="background:var(--green-dim);padding:16px;border-radius:12px;text-align:center">
                <div style="font-size:11px;color:var(--primary-800);font-weight:600">TRIPS/TRUCK/MONTH</div>
                <div style="font-size:28px;font-weight:800;color:${efficiency.metrics.tripsPerTruckPerMonth >= 2 ? 'var(--green)' : efficiency.metrics.tripsPerTruckPerMonth >= 1.5 ? 'var(--amber)' : 'var(--red)'}">${efficiency.metrics.tripsPerTruckPerMonth.toFixed(2)}</div>
                <div style="font-size:12px;color:var(--text-muted)">${efficiency.metrics.tripsPerTruckPerMonth >= 2 ? ' On Target' : ' Below Target'}</div>
              </div>
              <div style="background:var(--amber-dim);padding:16px;border-radius:12px;text-align:center">
                <div style="font-size:11px;color:var(--amber);font-weight:600">DATA PERIOD</div>
                <div style="font-size:28px;font-weight:800;color:var(--amber)">${tripVolume.monthCount}</div>
                <div style="font-size:12px;color:var(--text-muted)">months of data</div>
              </div>
            </div>
            
            <!-- Monthly Breakdown Chart (CSS bars) -->
            <div style="margin-bottom:20px">
              <div style="font-weight:600;margin-bottom:12px;color:var(--text-primary)">Monthly Trip Volume</div>
              <div style="display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto">
                ${Object.entries(tripVolume.monthlyData).slice(-12).map(([month, data]) => {
                  const maxTrips = Math.max(...Object.values(tripVolume.monthlyData).map(d => d.tripValue)) || 1;
                  const barWidth = (data.tripValue / maxTrips * 100);
                  const isGoodMonth = data.tripValue >= 2 * efficiency.truckCount;
                  return `
                    <div style="display:flex;align-items:center;gap:12px">
                      <div style="width:80px;font-size:13px;font-weight:500;color:var(--text-secondary)">${month}</div>
                      <div style="flex:1;background:var(--bg-tertiary);border-radius:4px;height:24px;overflow:hidden">
                        <div style="background:${isGoodMonth ? 'linear-gradient(90deg,var(--green),var(--green))' : 'linear-gradient(90deg,var(--amber),var(--amber))'};height:100%;width:${barWidth}%;border-radius:4px;display:flex;align-items:center;justify-content:flex-end;padding-right:8px">
                          <span style="font-size:11px;font-weight:600;color:white">${data.tripValue.toFixed(1)}</span>
                        </div>
                      </div>
                      <div style="width:100px;font-size:12px;color:var(--text-muted)">${formatMoney(data.revenue)}</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
            
            <!-- Truck Performance Table -->
            <div style="font-weight:600;margin-bottom:12px;color:var(--text-primary)">Performance by Truck</div>
            <div class="table-wrapper" style="border-radius:12px;border:1px solid var(--border)">
              <table>
                <thead>
                  <tr>
                    <th>Truck</th>
                    <th>Total Trips</th>
                    <th>Trip Value</th>
                    <th>Avg Trips/Month</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  ${appData.trucks.filter(t => t.status === 'ACTIVE').map(truck => {
                    const truckVolume = tripVolume.truckData[truck.id] || { totalTrips: 0, totalTripValue: 0 };
                    const avgPerMonth = tripVolume.monthCount > 0 ? truckVolume.totalTripValue / tripVolume.monthCount : 0;
                    const status = avgPerMonth >= 2 ? 'EXCELLENT' : avgPerMonth >= 1.5 ? 'GOOD' : avgPerMonth >= 1 ? 'FAIR' : 'NEEDS_ATTENTION';
                    const statusColors = { EXCELLENT: 'var(--green)', GOOD: 'var(--blue)', FAIR: 'var(--amber)', NEEDS_ATTENTION: 'var(--red)' };
                    return `
                      <tr>
                        <td><strong>#${truck.truck_number}</strong></td>
                        <td>${truckVolume.totalTrips}</td>
                        <td>${truckVolume.totalTripValue.toFixed(1)}</td>
                        <td style="font-weight:600;color:${statusColors[status]}">${avgPerMonth.toFixed(2)}</td>
                        <td><span class="badge" style="background:${statusColors[status]}20;color:${statusColors[status]};border:1px solid ${statusColors[status]}40">${status.replace('_', ' ')}</span></td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Forecasting Section -->
        <div class="card" style="margin-bottom:24px">
          <div class="card-header" style="background:linear-gradient(135deg,var(--blue),var(--blue));color:white">
            <h3 style="color:white"> Financial Forecast (Next 6 Months)</h3>
          </div>
          <div style="padding:20px">
            <!-- Forecast Summary -->
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px">
              <div style="background:var(--blue-dim);padding:16px;border-radius:12px;text-align:center;border:1px solid var(--blue)">
                <div style="font-size:11px;color:var(--blue);font-weight:600">PROJECTED REVENUE (6MO)</div>
                <div style="font-size:24px;font-weight:800;color:var(--blue)">${formatMoney(forecast.forecasts.reduce((s,f) => s + f.revenue, 0))}</div>
              </div>
              <div style="background:var(--green-dim);padding:16px;border-radius:12px;text-align:center;border:1px solid var(--green)">
                <div style="font-size:11px;color:var(--green);font-weight:600">PROJECTED PROFIT (6MO)</div>
                <div style="font-size:24px;font-weight:800;color:var(--green)">${formatMoney(forecast.forecasts.reduce((s,f) => s + f.profit, 0))}</div>
              </div>
              <div style="background:var(--amber-dim);padding:16px;border-radius:12px;text-align:center;border:1px solid var(--amber)">
                <div style="font-size:11px;color:var(--amber);font-weight:600">TREND</div>
                <div style="font-size:24px;font-weight:800;color:${forecast.trend >= 0 ? 'var(--green)' : 'var(--red)'}">${forecast.trend >= 0 ? '' : ''} ${forecast.trend >= 0 ? '+' : ''}${formatMoney(forecast.trend)}/mo</div>
              </div>
            </div>
            
            <!-- Monthly Forecasts -->
            <div class="table-wrapper" style="border-radius:12px;border:1px solid var(--border)">
              <table>
                <thead>
                  <tr>
                    <th>Month</th>
                    <th>Forecast Revenue</th>
                    <th>Forecast Profit</th>
                    <th>Est. Cars</th>
                    <th>Est. Trips</th>
                    <th>Seasonal Factor</th>
                    <th>Confidence</th>
                  </tr>
                </thead>
                <tbody>
                  ${forecast.forecasts.map(f => `
                    <tr>
                      <td><strong>${f.month}</strong></td>
                      <td class="money">${formatMoney(f.revenue)}</td>
                      <td class="money ${f.profit >= 0 ? 'positive' : 'negative'}">${formatMoney(f.profit)}</td>
                      <td>${f.cars.toFixed(0)}</td>
                      <td>${f.trips.toFixed(1)}</td>
                      <td>${(f.seasonalFactor * 100).toFixed(0)}%</td>
                      <td>
                        <div style="background:var(--bg-tertiary);border-radius:4px;height:8px;width:60px">
                          <div style="background:${f.confidence >= 0.7 ? 'var(--green)' : 'var(--amber)'};height:100%;width:${f.confidence * 100}%;border-radius:4px"></div>
                        </div>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <!-- Scenarios -->
            <div style="margin-top:24px">
              <div style="font-weight:600;margin-bottom:12px"> Annual Projection Scenarios</div>
              <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
                <div style="background:var(--red-dim);padding:16px;border-radius:12px;text-align:center">
                  <div style="font-size:var(--text-xs);color:var(--red);font-weight:600">CONSERVATIVE (-15%)</div>
                  <div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--red);margin-top:8px">${formatMoney(forecast.scenarios.conservative.revenue)}</div>
                  <div style="font-size:var(--text-sm);color:var(--red)">Profit: ${formatMoney(forecast.scenarios.conservative.profit)}</div>
                </div>
                <div style="background:var(--blue-dim);padding:16px;border-radius:12px;text-align:center;border:2px solid var(--blue)">
                  <div style="font-size:12px;color:var(--blue);font-weight:600">BASE CASE</div>
                  <div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--blue);margin-top:8px">${formatMoney(forecast.scenarios.base.revenue)}</div>
                  <div style="font-size:14px;color:var(--blue)">Profit: ${formatMoney(forecast.scenarios.base.profit)}</div>
                </div>
                <div style="background:var(--green-dim);padding:16px;border-radius:12px;text-align:center">
                  <div style="font-size:12px;color:var(--primary-800);font-weight:600">OPTIMISTIC (+15%)</div>
                  <div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--green);margin-top:8px">${formatMoney(forecast.scenarios.optimistic.revenue)}</div>
                  <div style="font-size:var(--text-sm);color:var(--green)">Profit: ${formatMoney(forecast.scenarios.optimistic.profit)}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Break-Even & Pricing Guidance -->
        <div class="card" style="margin-bottom:24px">
          <div class="card-header" style="background:linear-gradient(135deg,var(--red),var(--red));color:white">
            <h3 style="color:white"> Break-Even Analysis & Pricing Targets</h3>
          </div>
          <div style="padding:20px">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px">
              <div style="background:var(--red-dim);padding:20px;border-radius:12px;text-align:center;border:2px solid var(--red-dim)">
                <div style="font-size:var(--text-xs);color:var(--red);font-weight:600;margin-bottom:8px">BREAK-EVEN PPC</div>
                <div style="font-size:32px;font-weight:800;color:var(--red)">${formatMoney(breakEven.breakEvenPPC)}</div>
                <div style="font-size:12px;color:var(--text-muted);margin-top:8px">Minimum to cover all costs</div>
              </div>
              <div style="background:var(--green-dim);padding:20px;border-radius:12px;text-align:center;border:2px solid var(--green-dim)">
                <div style="font-size:12px;color:var(--primary-800);font-weight:600;margin-bottom:8px">TARGET PPC (PROFITABLE)</div>
                <div style="font-size:32px;font-weight:800;color:var(--green)">${formatMoney(breakEven.profitablePPC)}</div>
                <div style="font-size:12px;color:var(--text-muted);margin-top:8px">15% above break-even</div>
              </div>
              <div style="background:var(--blue-dim);padding:20px;border-radius:12px;text-align:center;border:2px solid var(--blue-dim)">
                <div style="font-size:12px;color:var(--blue);font-weight:600;margin-bottom:8px">CURRENT AVG PPC</div>
                <div style="font-size:32px;font-weight:800;color:var(--blue)">${formatMoney(efficiency.metrics.revenuePerCar)}</div>
                <div style="font-size:12px;color:var(--text-muted);margin-top:8px">${efficiency.metrics.revenuePerCar >= breakEven.profitablePPC ? ' Above target' : ' Below target'}</div>
              </div>
              <div style="background:var(--purple-dim);padding:20px;border-radius:12px;text-align:center;border:2px solid var(--purple-dim)">
                <div style="font-size:12px;color:var(--purple);font-weight:600;margin-bottom:8px">FIXED COST/TRIP</div>
                <div style="font-size:32px;font-weight:800;color:var(--purple)">${formatMoney(breakEven.fixedCostPerTrip)}</div>
                <div style="font-size:12px;color:var(--text-muted);margin-top:8px">Overhead allocation</div>
              </div>
            </div>
            
            <!-- Cost Structure -->
            <div style="margin-top:24px;padding:20px;background:var(--bg-tertiary);border-radius:12px">
              <div style="font-weight:600;margin-bottom:16px"> Cost Structure Analysis</div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px">
                <div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-secondary);border-radius:8px">
                  <span>Avg Broker Fee</span>
                  <span style="font-weight:600">${(breakEven.avgBrokerFeeRatio * 100).toFixed(1)}%</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-secondary);border-radius:8px">
                  <span>Avg Local Fee</span>
                  <span style="font-weight:600">${(breakEven.avgLocalFeeRatio * 100).toFixed(1)}%</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-secondary);border-radius:8px">
                  <span>Avg Driver Cut</span>
                  <span style="font-weight:600">${(breakEven.avgDriverCutRatio * 100).toFixed(1)}%</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-secondary);border-radius:8px">
                  <span>Truck Gross Ratio</span>
                  <span style="font-weight:600;color:var(--green)">${(breakEven.truckGrossRatio * 100).toFixed(1)}%</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-secondary);border-radius:8px">
                  <span>Avg Expense/Trip</span>
                  <span style="font-weight:600">${formatMoney(breakEven.avgExpensePerTrip)}</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-secondary);border-radius:8px">
                  <span>Avg Cars/Trip</span>
                  <span style="font-weight:600">${breakEven.avgCarsPerTrip.toFixed(1)}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ============ OPTIMIZATION RECOMMENDATIONS ENGINE ============
    function generateOptimizationRecommendations(efficiency, tripVolume, breakEven, forecast) {
      const recommendations = [];
      
      // 1. Trip Volume Analysis
      if (efficiency.metrics.tripsPerTruckPerMonth < 2) {
        const currentTrips = efficiency.metrics.tripsPerTruckPerMonth;
        const targetTrips = 2;
        const additionalTripsNeeded = (targetTrips - currentTrips) * efficiency.truckCount;
        const potentialRevenue = additionalTripsNeeded * (efficiency.totalRevenue / efficiency.tripCount || 0);
        
        recommendations.push({
          category: 'UTILIZATION',
          priority: 'HIGH',
          icon: '',
          title: 'Increase Trip Frequency',
          description: `Currently averaging ${currentTrips.toFixed(2)} trips/truck/month. Target is 2.0 trips.`,
          action: `Schedule ${additionalTripsNeeded.toFixed(1)} more trips/month across fleet`,
          impact: `Potential additional revenue: ${formatMoney(potentialRevenue)}/month`,
          color: 'var(--red)'
        });
      }
      
      // 2. Utilization Rate
      if (efficiency.metrics.utilizationRate < 85) {
        const currentUtil = efficiency.metrics.utilizationRate;
        const additionalCars = ((85 - currentUtil) / 100) * efficiency.tripCount * 16; // 8 cars  2 ways
        
        recommendations.push({
          category: 'UTILIZATION',
          priority: 'HIGH',
          icon: '',
          title: 'Improve Load Utilization',
          description: `Current utilization at ${currentUtil.toFixed(1)}% vs 85% target.`,
          action: `Fill ${additionalCars.toFixed(0)} more car slots per period`,
          impact: `Could increase revenue by ${formatMoney(additionalCars * breakEven.profitablePPC)}`,
          color: 'var(--amber)'
        });
      }
      
      // 3. Pricing Analysis
      if (efficiency.metrics.revenuePerCar < breakEven.profitablePPC) {
        const ppcGap = breakEven.profitablePPC - efficiency.metrics.revenuePerCar;
        
        recommendations.push({
          category: 'PRICING',
          priority: 'HIGH',
          icon: '',
          title: 'Increase Average Price Per Car',
          description: `Current PPC of ${formatMoney(efficiency.metrics.revenuePerCar)} is below target ${formatMoney(breakEven.profitablePPC)}.`,
          action: `Increase average booking price by ${formatMoney(ppcGap)}/car`,
          impact: `Would add ${formatMoney(ppcGap * efficiency.totalCars)} to bottom line`,
          color: 'var(--red)'
        });
      }
      
      // 4. Cost Reduction
      if (efficiency.metrics.operatingRatio > 85) {
        const excessCostRatio = efficiency.metrics.operatingRatio - 85;
        const excessCost = (excessCostRatio / 100) * efficiency.totalRevenue;
        
        recommendations.push({
          category: 'COSTS',
          priority: 'MEDIUM',
          icon: '',
          title: 'Reduce Operating Costs',
          description: `Operating ratio at ${efficiency.metrics.operatingRatio.toFixed(1)}% (target: 85%)`,
          action: 'Review fuel efficiency, negotiate better rates with brokers',
          impact: `Potential savings: ${formatMoney(excessCost)}`,
          color: 'var(--amber)'
        });
      }
      
      // 5. Seasonal Planning
      const lowSeasonMonths = Object.entries(tripVolume.seasonalIndex)
        .filter(([m, idx]) => idx < 0.8)
        .map(([m]) => m);
      
      if (lowSeasonMonths.length > 0) {
        recommendations.push({
          category: 'PLANNING',
          priority: 'MEDIUM',
          icon: '',
          title: 'Prepare for Seasonal Variations',
          description: `Low-volume periods identified: ${lowSeasonMonths.slice(-3).join(', ')}`,
          action: 'Build cash reserves, consider maintenance scheduling during slow periods',
          impact: 'Maintain profitability during seasonal dips',
          color: 'var(--blue)'
        });
      }
      
      // 6. Driver Efficiency
      if (breakEven.avgDriverCutRatio > 0.35) {
        recommendations.push({
          category: 'OPERATIONS',
          priority: 'LOW',
          icon: '',
          title: 'Review Driver Compensation Structure',
          description: `Driver cut averaging ${(breakEven.avgDriverCutRatio * 100).toFixed(1)}% of clean gross`,
          action: 'Consider performance-based incentives or adjusted percentage tiers',
          impact: 'Balance driver retention with profitability',
          color: 'var(--purple)'
        });
      }
      
      // 7. Positive Reinforcement
      if (efficiency.overallHealthScore >= 80) {
        recommendations.push({
          category: 'SUCCESS',
          priority: 'INFO',
          icon: '',
          title: 'Business is Performing Well!',
          description: `Health score of ${efficiency.overallHealthScore.toFixed(0)}/100 indicates strong operations`,
          action: 'Continue current practices, consider expansion opportunities',
          impact: 'Maintain competitive advantage',
          color: 'var(--green)'
        });
      }
      
      // 8. Cash Flow Management
      const cashFlow = calculateCashFlow();
      if (cashFlow.outstandingReceivables > cashFlow.inflows.totalCashInflow * 0.3) {
        recommendations.push({
          category: 'CASH_FLOW',
          priority: 'MEDIUM',
          icon: '',
          title: 'Reduce Outstanding Receivables',
          description: `${formatMoney(cashFlow.outstandingReceivables)} in unpaid invoices (${((cashFlow.outstandingReceivables / cashFlow.inflows.totalRevenue) * 100).toFixed(0)}% of revenue)`,
          action: 'Follow up on overdue invoices, consider COD for new customers',
          impact: 'Improve cash position and reduce risk',
          color: 'var(--amber)'
        });
      }
      
      // Sort by priority
      const priorityOrder = { HIGH: 0, MEDIUM: 1, LOW: 2, INFO: 3 };
      recommendations.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
      
      // Generate HTML
      return `
        <div style="display:flex;flex-direction:column;gap:16px">
          ${recommendations.map(rec => `
            <div style="background:${rec.color}10;border:1px solid ${rec.color}30;border-radius:var(--radius-lg);padding:var(--spacing-4);display:flex;gap:16px">
              <div style="font-size:32px">${rec.icon}</div>
              <div style="flex:1">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                  <span style="font-weight:700;color:var(--text-primary)">${rec.title}</span>
                  <span style="font-size:10px;padding:2px 8px;border-radius:4px;background:${rec.color}20;color:${rec.color};font-weight:600">${rec.priority}</span>
                </div>
                <div style="font-size:13px;color:var(--text-secondary);margin-bottom:8px">${rec.description}</div>
                <div style="font-size:13px;color:var(--text-primary)"><strong>Action:</strong> ${rec.action}</div>
                <div style="font-size:13px;color:${rec.color};font-weight:500;margin-top:4px"> ${rec.impact}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Track if we're viewing a detail (trip, driver, truck, etc.)
    let currentDetailView = null; // { type: 'trip', id: 123 } or null
    
    async function loadAllData(forceReload = false) {
      try {
        // Check cache first (unless forced reload)
        if (!forceReload && dataCache.get('appData')) {
          appData = dataCache.get('appData');
          return;
        }
        
        // Load essential data first (what dashboard needs - including tasks)
        const [users, trucks, drivers, dispatchers, trips, orders, brokers, tasks] = await Promise.all([
          dbFetch('users'), 
          dbFetch('trucks', { order: 'truck_number' }), 
          dbFetch('drivers'), 
          dbFetch('dispatchers'), 
          dbFetch('trips', { order: 'trip_date.desc' }), 
          dbFetch('orders', { order: 'id.desc' }), 
          dbFetch('brokers', { order: 'name' }),
          dbFetch('tasks', { order: 'due_date.asc' })
        ]);
        
        // Set initial data
        appData = {
          users, trucks, drivers, dispatchers, trips, orders, brokers: brokers || [],
          tasks: tasks || [],
          local_drivers: [], expenses: [], fixed_costs: [], variable_costs: [],
          driver_files: [], truck_files: [], fuel_transactions: [],
          maintenance_records: [], claims: [], tickets: [], violations: [], ticket_files: [], violation_files: [], claim_files: [], compliance_tasks: [], accidents: [],
          vehicle_inspections: [], inspection_photos: [], inspection_damages: [], order_attachments: []
        };
        
        // For force reload (like real-time sync), wait for ALL data including secondary
        // This ensures local_drivers, expenses, etc. are loaded before we re-render
        if (forceReload) {
          await loadSecondaryData();
        } else {
          // Load secondary data in background (non-blocking) for initial page load
          loadSecondaryData();
        }

        // Cache the data
        dataCache.set('appData', appData);
      } catch (e) { 
        console.error('Failed to load data:', e);
        showToast('Failed to load data', 'error'); 
      }
    }
    
    async function loadSecondaryData() {
      try {
        const [local_drivers, expenses, fixed_costs, variable_costs, driver_files, truck_files, fuel_transactions, maintenance_records] = await Promise.all([
          dbFetch('local_drivers', { order: 'name' }),
          dbFetch('expenses'), 
          dbFetch('fixed_costs', { order: 'name' }), 
          dbFetch('variable_costs', { order: 'date.desc' }), 
          dbFetch('driver_files', { order: 'id.desc' }), 
          dbFetch('truck_files', { order: 'id.desc' }), 
          dbFetch('fuel_transactions', { order: 'transaction_date.desc' }), 
          dbFetch('maintenance_records', { order: 'service_date.desc' })
        ]);
        
        // Try to load claims separately (table may not exist yet)
        let claims = [];
        try { claims = await dbFetch('claims', { order: 'incident_date.desc' }) || []; } catch(e) { claims = []; }
        
        // Try to load tickets separately (table may not exist yet)
        let tickets = [];
        try { tickets = await dbFetch('tickets', { order: 'ticket_date.desc' }) || []; } catch(e) { tickets = []; }
        
        // Try to load violations separately (table may not exist yet)
        let violations = [];
        try { violations = await dbFetch('violations', { order: 'violation_date.desc' }) || []; } catch(e) { violations = []; }
        
        // Try to load ticket/violation files
        let ticket_files = [];
        try { ticket_files = await dbFetch('ticket_files') || []; } catch(e) { ticket_files = []; }
        let violation_files = [];
        try { violation_files = await dbFetch('violation_files') || []; } catch(e) { violation_files = []; }
        let claim_files = [];
        try { claim_files = await dbFetch('claim_files') || []; } catch(e) { claim_files = []; }
        
        // Try to load compliance tasks
        let compliance_tasks = [];
        try { compliance_tasks = await dbFetch('compliance_tasks', { order: 'next_due_date.asc' }) || []; } catch(e) { compliance_tasks = []; }
        
        // Try to load accidents
        let accidents = [];
        try { accidents = await dbFetch('accidents', { order: 'accident_date.desc' }) || []; } catch(e) { accidents = []; }

        // Load vehicle inspections data
        let vehicle_inspections = [];
        try { vehicle_inspections = await dbFetch('vehicle_inspections', { order: 'created_at.desc' }) || []; } catch(e) { vehicle_inspections = []; }
        let inspection_photos = [];
        try { inspection_photos = await dbFetch('inspection_photos', { order: 'captured_at.desc' }) || []; } catch(e) { inspection_photos = []; }
        let inspection_damages = [];
        try { inspection_damages = await dbFetch('inspection_damages', { order: 'created_at.desc' }) || []; } catch(e) { inspection_damages = []; }

        // Try to load order attachments
        let order_attachments = [];
        try { order_attachments = await dbFetch('order_attachments', { order: 'uploaded_at.desc' }) || []; } catch(e) { order_attachments = []; }

        // Load fleet mileage data from Samsara uploads
        let fleet_mileage = [];
        try { fleet_mileage = await dbFetch('fleet_mileage', { order: 'period_end.desc' }) || []; } catch(e) { fleet_mileage = []; }

        // Populate fleetMileageData and fleetMileagePeriod from database
        if (fleet_mileage.length > 0) {
          fleetMileageData = fleet_mileage.map(r => ({
            vehicle_name: r.vehicle_name,
            truck_number: r.truck_number,
            distance: parseFloat(r.distance) || 0,
            driving_hours: parseFloat(r.driving_hours) || 0,
            stops: parseInt(r.stops) || 0,
            start_odometer: parseFloat(r.start_odometer) || 0,
            end_odometer: parseFloat(r.end_odometer) || 0
          }));
          // Get period from first record (all should have same period)
          fleetMileagePeriod = {
            start: fleet_mileage[0].period_start,
            end: fleet_mileage[0].period_end
          };
        }

        // Update appData with secondary data
        Object.assign(appData, {
          local_drivers: local_drivers || [],
          expenses: expenses || [],
          fixed_costs: fixed_costs || [],
          variable_costs: variable_costs || [],
          driver_files: driver_files || [],
          truck_files: truck_files || [],
          fuel_transactions: fuel_transactions || [],
          maintenance_records: maintenance_records || [],
          claims: claims,
          tickets: tickets,
          violations: violations,
          ticket_files: ticket_files,
          violation_files: violation_files,
          claim_files: claim_files,
          compliance_tasks: compliance_tasks,
          accidents: accidents,
          vehicle_inspections: vehicle_inspections,
          inspection_photos: inspection_photos,
          inspection_damages: inspection_damages,
          order_attachments: order_attachments
        });
        
        // Update cache
        dataCache.set('appData', appData);
        
        // Load Samsara settings from database (shared across all users)
        await loadSamsaraSettings();

        // NOTE: We intentionally do NOT call renderPage() here anymore.
        // The data is now loaded and cached - views will use it on next interaction.
        // Calling renderPage() from background async code caused race conditions
        // that would kick users out of detail views unexpectedly.
      } catch (e) {
        console.error('Failed to load secondary data:', e);
      }
    }
    
    // Invalidate cache and reload specific data
    async function reloadData(dataType) {
      dataCache.invalidate('appData');
      
      try {
        switch(dataType) {
          case 'trips':
            appData.trips = await dbFetch('trips', { order: 'trip_date.desc' }) || [];
            break;
          case 'orders':
            appData.orders = await dbFetch('orders', { order: 'id.desc' }) || [];
            break;
          case 'trucks':
            appData.trucks = await dbFetch('trucks', { order: 'truck_number' }) || [];
            break;
          case 'drivers':
            appData.drivers = await dbFetch('drivers') || [];
            break;
          case 'maintenance':
            appData.maintenance_records = await dbFetch('maintenance_records', { order: 'service_date.desc' }) || [];
            break;
          case 'tasks':
            appData.tasks = await dbFetch('tasks', { order: 'due_date.asc' }) || [];
            break;
          default:
            await loadAllData(true);
        }
        dataCache.set('appData', appData);
      } catch (e) {
        console.error('Failed to reload data:', e);
      }
    }

    let isSignUpMode = false;

    function renderLogin() {
      applyTheme();

      // Generate 30 particles for animated background
      let particlesHtml = '<div class="login-particles">';
      for (let i = 1; i <= 30; i++) {
        particlesHtml += '<div class="login-particle"></div>';
      }
      particlesHtml += '</div>';

      // Navigation bar
      const navBar = `
        <nav class="login-nav">
          <button class="login-nav-btn" onclick="renderDriverApplication()" style="background:transparent;border:2px solid var(--green);color:var(--green)">APPLY TO DRIVE</button>
          <div class="login-nav-links"></div>
          <div class="login-nav-buttons">
            <button class="login-nav-btn login" onclick="renderLogin()">LOGIN</button>
          </div>
        </nav>
      `;

      // Hero content (left side) with 5 features
      const heroContent = `
        <div class="login-hero-content">
          <div style="font-size:42px;font-weight:700;margin-bottom:16px;color:white"> Horizon<span style="color:var(--green)">Star</span></div>
          <p style="font-size: 14px; color: rgba(255,255,255,0.7); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px;">Transportation Management System</p>
          <p class="login-hero-subtitle">Complete fleet operations platform  track, plan, optimize, and grow your transportation business</p>

          <div class="login-features">
            <div class="login-feature">
              <div class="login-feature-title">FLEET</div>
              <div class="login-feature-subtitle">MANAGEMENT</div>
            </div>
            <div class="login-feature">
              <div class="login-feature-title">TRIP</div>
              <div class="login-feature-subtitle">PLANNING</div>
            </div>
            <div class="login-feature">
              <div class="login-feature-title">REAL-TIME</div>
              <div class="login-feature-subtitle">TRACKING</div>
            </div>
            <div class="login-feature">
              <div class="login-feature-title">FINANCIAL</div>
              <div class="login-feature-subtitle">DASHBOARD</div>
            </div>
            <div class="login-feature">
              <div class="login-feature-title">DRIVER</div>
              <div class="login-feature-subtitle">PAYROLL</div>
            </div>
          </div>
        </div>
      `;

      // Login Form
      const loginForm = `
        <div class="login-form-card">
          <h2>Welcome back</h2>
          <p class="subtitle">Enter your credentials to continue</p>
          <div class="login-error" id="login-error"></div>
          <form onsubmit="handleLogin(event)">
            <div class="form-group">
              <label>${t('email')}</label>
              <input type="email" id="login-email" required placeholder="you@company.com">
            </div>
            <div class="form-group">
              <label>${t('password')}</label>
              <input type="password" id="login-password" required placeholder="Your password">
              <a href="#" onclick="showForgotPassword();return false;" style="font-size:var(--text-xs);color:var(--green);text-decoration:none;display:block;text-align:right;margin-top:6px">Forgot password?</a>
            </div>
            <button type="submit" class="btn-submit" id="login-btn">${t('sign_in')}</button>
          </form>
          <p style="margin-top:16px;text-align:center;color:rgba(255,255,255,0.6);font-size:13px">
            Are you a dealer? <a href="#" onclick="showDealerLoginInfo();return false;" style="color:var(--green);text-decoration:none;font-weight:500">Dealer Portal</a>
          </p>
        </div>
      `;

      // Footer bar
      const footerBar = `
        <div class="login-footer-bar" style="color:rgba(255,255,255,0.5)">
          <span>Powered by <strong style="color:var(--green)">Horizon Star LLC</strong></span>
          <span style="color:rgba(255,255,255,0.3)"></span>
          <a href="#" onclick="showPrivacyPolicy();return false;" style="color:var(--green);text-decoration:none">Privacy Policy</a>
          <span style="color:rgba(255,255,255,0.3)"></span>
          <span>Built by <a href="#" style="color:var(--green);text-decoration:none">Levani Grigolia</a></span>
        </div>
      `;

      document.getElementById('app').innerHTML = `
        <div class="login-container">
          ${particlesHtml}
          ${navBar}
          <div class="login-hero">
            ${heroContent}
            ${loginForm}
          </div>
          ${footerBar}
        </div>
      `;
    }

    // ============ DRIVER APPLICATION FORM (FMCSA COMPLIANT) ============
    let applicationPage = 1;
    let applicationData = {
      // Page 1
      first_name: '', last_name: '', date_of_birth: '', ssn: '',
      phone: '', email: '', address: '', city: '', state: '', zip: '',
      lived_3_years: false, previous_addresses: [],
      license_number: '', license_state: '', license_class: '',
      license_expires: '', license_front_url: '', license_back_url: '',
      endorsements: [], other_licenses_3_years: false, other_licenses_details: [],
      medical_card_url: '', medical_expires: '',
      accidents_3_years: false, accidents_details: [],
      violations_3_years: false, violations_details: [],
      denied_license: false, denied_license_details: '',
      license_revoked: false, license_revoked_details: '',
      employment_history: [{ employer_name: '', phone: '', fax: '', email: '', address: '', city: '', state: '', zip: '', position: '', date_from: '', date_to: '', reason_leaving: '', equipment_class: '', subject_fmcsr: false, dot_regulated: false }],
      employment_gaps: '',
      // Signatures
      page1_signature: '', page1_date: '',
      page2_signature: '', page2_date: '',
      page3_signature: '', page3_date: '',
      page4_signature: '', page4_date: '',
      page5_signature: '', page5_date: '',
      page6_signature: '', page6_date: '', page6_full_name: '',
      page7_signature: '', page7_date: '', clearinghouse_registered: false,
      page8_signature: '', page8_date: '',
      // Drug/Alcohol
      tested_positive: false, alcohol_concentration: false, refused_test: false, return_to_duty_docs: false
    };
    let signatureCanvas = null;
    let signatureCtx = null;
    let isDrawing = false;

    function renderDriverApplication() {
      applyTheme();

      const pageNames = [
        'Applicant Information',
        'Fair Credit Reporting Act',
        'Driver License Compliance',
        'Drug & Alcohol Statement',
        'Safety Performance History',
        'PSP Disclosure',
        'Clearinghouse Consent',
        'MVR Release Consent'
      ];

      // Page tabs
      const pageTabs = pageNames.map((name, i) => `
        <div class="app-tab ${applicationPage === i + 1 ? 'active' : ''}" onclick="goToAppPage(${i + 1})" style="cursor:pointer;padding:8px 12px;font-size:12px;border-bottom:3px solid ${applicationPage === i + 1 ? 'var(--green)' : 'transparent'};color:${applicationPage === i + 1 ? 'var(--green)' : 'rgba(255,255,255,0.6)'};transition:all 0.2s">
          Page ${i + 1}
        </div>
      `).join('');

      // Get page content
      let pageContent = '';
      switch(applicationPage) {
        case 1: pageContent = getApplicationPage1(); break;
        case 2: pageContent = getApplicationPage2(); break;
        case 3: pageContent = getApplicationPage3(); break;
        case 4: pageContent = getApplicationPage4(); break;
        case 5: pageContent = getApplicationPage5(); break;
        case 6: pageContent = getApplicationPage6(); break;
        case 7: pageContent = getApplicationPage7(); break;
        case 8: pageContent = getApplicationPage8(); break;
      }

      document.getElementById('app').innerHTML = `
        <div style="min-height:100vh;background:linear-gradient(135deg,var(--bg-elevated) 0%,var(--bg-elevated) 100%);padding:20px">
          <nav class="login-nav">
            <div class="login-nav-logo" onclick="renderLogin()" style="cursor:pointer">
              <div class="login-nav-logo-icon"></div>
              <span>Horizon<span style="color:var(--green)">Star</span></span>
            </div>
            <div style="color:white;font-size:18px;font-weight:600">Application For Employment</div>
            <div class="login-nav-buttons">
              <button class="login-nav-btn login" onclick="renderLogin()"> BACK TO LOGIN</button>
            </div>
          </nav>

          <div style="max-width:900px;margin:20px auto">
            <!-- Company Header -->
            <div style="text-align:center;margin-bottom:24px">
              <div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:white">HORIZON STAR LLC</div>
              <div style="color:rgba(255,255,255,0.6);font-size:14px">225 Lincoln Highway, Suite 205, Fairless Hills, PA 19030</div>
            </div>

            <!-- Page Tabs -->
            <div style="display:flex;justify-content:center;flex-wrap:wrap;gap:4px;margin-bottom:24px;background:rgba(255,255,255,0.05);padding:8px;border-radius:12px">
              ${pageTabs}
            </div>

            <!-- Form Content -->
            <div style="background:rgba(255,255,255,0.98);border-radius:16px;padding:32px;box-shadow:0 20px 40px rgba(0,0,0,0.3)">
              ${pageContent}

              <!-- Navigation Buttons -->
              <div style="display:flex;justify-content:space-between;margin-top:32px;padding-top:24px;border-top:1px solid var(--border)">
                ${applicationPage > 1 ? '<button class="btn btn-secondary" onclick="prevAppPage()"> Back</button>' : '<div></div>'}
                ${applicationPage < 8
                  ? '<button class="btn btn-primary" onclick="nextAppPage()">Next </button>'
                  : '<button class="btn btn-primary" onclick="submitApplication()" style="background:var(--green)">Submit Application</button>'
                }
              </div>
            </div>
          </div>
        </div>
      `;

      // Initialize signature canvas if on a page with signature
      setTimeout(() => initSignatureCanvas(), 100);
    }

    function goToAppPage(page) {
      saveCurrentPageData();
      applicationPage = page;
      renderDriverApplication();
    }

    function prevAppPage() {
      saveCurrentPageData();
      if (applicationPage > 1) applicationPage--;
      renderDriverApplication();
    }

    function nextAppPage() {
      saveCurrentPageData();
      if (applicationPage < 8) applicationPage++;
      renderDriverApplication();
    }

    function saveCurrentPageData() {
      // Save form data from current page
      const form = document.getElementById('app-form');
      if (!form) return;

      const formData = new FormData(form);
      // File input fields to skip (handled separately by handleFileUpload)
      const fileFields = ['license_front', 'license_back', 'medical_card'];

      for (let [key, value] of formData.entries()) {
        // Skip file inputs - they're handled by handleFileUpload
        if (fileFields.includes(key)) continue;
        // Skip if value is a File object
        if (value instanceof File) continue;

        // Handle employment history fields (emp_0_name, emp_0_address, etc.)
        const empMatch = key.match(/^emp_(\d+)_(.+)$/);
        if (empMatch) {
          const index = parseInt(empMatch[1]);
          const field = empMatch[2];
          // Map form field names to employment_history object keys
          const fieldMap = {
            'name': 'employer_name', 'phone': 'phone', 'fax': 'fax', 'email': 'email',
            'address': 'address', 'city': 'city', 'state': 'state', 'zip': 'zip',
            'position': 'position', 'from': 'date_from', 'to': 'date_to',
            'reason': 'reason_leaving', 'equipment': 'equipment_class',
            'fmcsr': 'subject_fmcsr', 'dot': 'dot_regulated'
          };
          const actualField = fieldMap[field] || field;
          if (!applicationData.employment_history[index]) {
            applicationData.employment_history[index] = {};
          }
          // Handle checkbox values
          if (field === 'fmcsr' || field === 'dot') {
            applicationData.employment_history[index][actualField] = value === 'on';
          } else {
            applicationData.employment_history[index][actualField] = value;
          }
        } else if (key.includes('[]')) {
          // Handle arrays (endorsements)
          const actualKey = key.replace('[]', '');
          if (!applicationData[actualKey]) applicationData[actualKey] = [];
          if (!applicationData[actualKey].includes(value)) applicationData[actualKey].push(value);
        } else if (value === 'on') {
          applicationData[key] = true;
        } else {
          applicationData[key] = value;
        }
      }

      // Save signature if exists
      if (signatureCanvas) {
        const sigKey = 'page' + applicationPage + '_signature';
        applicationData[sigKey] = signatureCanvas.toDataURL();
      }
    }

    function getApplicationPage1() {
      const stateOptions = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'].map(s => `<option value="${s}" ${applicationData.state === s ? 'selected' : ''}>${s}</option>`).join('');
      const licenseStateOptions = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'].map(s => `<option value="${s}" ${applicationData.license_state === s ? 'selected' : ''}>${s}</option>`).join('');

      return `
        <form id="app-form">
          <h2 style="color:var(--text-primary);margin-bottom:24px;font-size:24px">Applicant Information</h2>

          <!-- Name -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
            <div class="form-group">
              <label>First Name *</label>
              <input type="text" name="first_name" value="${applicationData.first_name}" required>
            </div>
            <div class="form-group">
              <label>Last Name *</label>
              <input type="text" name="last_name" value="${applicationData.last_name}" required>
            </div>
          </div>

          <!-- DOB & SSN -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
            <div class="form-group">
              <label>Date of Birth *</label>
              <input type="date" name="date_of_birth" value="${applicationData.date_of_birth}" required>
            </div>
            <div class="form-group">
              <label>Social Security Number *</label>
              <input type="text" name="ssn" value="${applicationData.ssn}" placeholder="XXX-XX-XXXX" required>
            </div>
          </div>

          <!-- Phone & Email -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">
            <div class="form-group">
              <label>Phone *</label>
              <input type="tel" name="phone" value="${applicationData.phone}" required>
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input type="email" name="email" value="${applicationData.email}" required>
            </div>
          </div>

          <!-- Address -->
          <div class="form-group" style="margin-bottom:16px">
            <label>Address *</label>
            <input type="text" name="address" value="${applicationData.address}" placeholder="Street Address" required>
          </div>
          <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:16px;margin-bottom:20px">
            <div class="form-group">
              <label>City *</label>
              <input type="text" name="city" value="${applicationData.city}" required>
            </div>
            <div class="form-group">
              <label>State *</label>
              <select name="state" required>${stateOptions}</select>
            </div>
            <div class="form-group">
              <label>Zip Code *</label>
              <input type="text" name="zip" value="${applicationData.zip}" required>
            </div>
          </div>

          <div class="form-group" style="margin-bottom:24px">
            <label>Have you lived at this address for more than 3 years?</label>
            <div style="display:flex;gap:16px;margin-top:8px">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="lived_3_years" value="true" ${applicationData.lived_3_years ? 'checked' : ''}> Yes
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="lived_3_years" value="false" ${!applicationData.lived_3_years ? 'checked' : ''}> No
              </label>
            </div>
          </div>

          <hr style="border:none;border-top:2px solid var(--border);margin:32px 0">

          <!-- Driver's License Information -->
          <h3 style="color:var(--text-primary);margin-bottom:16px">Driver's License Information</h3>
          <p style="color:var(--text-muted);font-size:13px;margin-bottom:16px">Include all licenses held for the past 3 years. Start with the most current.</p>

          <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:16px;margin-bottom:20px">
            <div class="form-group">
              <label>License Number *</label>
              <input type="text" name="license_number" value="${applicationData.license_number}" required>
            </div>
            <div class="form-group">
              <label>State *</label>
              <select name="license_state" required>${licenseStateOptions}</select>
            </div>
            <div class="form-group">
              <label>Class *</label>
              <input type="text" name="license_class" value="${applicationData.license_class}" placeholder="A, B, C" required>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:20px">
            <div class="form-group">
              <label>Expires *</label>
              <input type="date" name="license_expires" value="${applicationData.license_expires}" required>
            </div>
            <div class="form-group">
              <label>Upload BACK of License</label>
              <input type="file" name="license_back" accept="image/*,.pdf" onchange="handleFileUpload(this, 'license_back_url')">
            </div>
            <div class="form-group">
              <label>Upload FRONT of License</label>
              <input type="file" name="license_front" accept="image/*,.pdf" onchange="handleFileUpload(this, 'license_front_url')">
            </div>
          </div>

          <!-- Endorsements -->
          <div class="form-group" style="margin-bottom:20px">
            <label>Endorsements</label>
            <div style="display:flex;flex-wrap:wrap;gap:16px;margin-top:8px">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="checkbox" name="endorsements[]" value="H" ${applicationData.endorsements.includes('H') ? 'checked' : ''}> H - Placarded Hazmat
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="checkbox" name="endorsements[]" value="N" ${applicationData.endorsements.includes('N') ? 'checked' : ''}> N - Tank Vehicles
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="checkbox" name="endorsements[]" value="P" ${applicationData.endorsements.includes('P') ? 'checked' : ''}> P - Passengers
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="checkbox" name="endorsements[]" value="T" ${applicationData.endorsements.includes('T') ? 'checked' : ''}> T - Double/Triple Trailers
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="checkbox" name="endorsements[]" value="S" ${applicationData.endorsements.includes('S') ? 'checked' : ''}> S - School Bus
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="checkbox" name="endorsements[]" value="X" ${applicationData.endorsements.includes('X') ? 'checked' : ''}> X - Placarded Hazmat & Tank
              </label>
            </div>
          </div>

          <div class="form-group" style="margin-bottom:24px">
            <label>Have you held any other licenses in the past 3 years?</label>
            <div style="display:flex;gap:16px;margin-top:8px">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="other_licenses_3_years" value="true" ${applicationData.other_licenses_3_years ? 'checked' : ''}> Yes
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="other_licenses_3_years" value="false" ${!applicationData.other_licenses_3_years ? 'checked' : ''}> No
              </label>
            </div>
          </div>

          <hr style="border:none;border-top:2px solid var(--border);margin:32px 0">

          <!-- Medical Card -->
          <h3 style="color:var(--text-primary);margin-bottom:16px">Medical Card</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px">
            <div class="form-group">
              <label>Upload Copy</label>
              <input type="file" name="medical_card" accept="image/*,.pdf" onchange="handleFileUpload(this, 'medical_card_url')">
            </div>
            <div class="form-group">
              <label>Medical Certificate Expiration Date *</label>
              <input type="date" name="medical_expires" value="${applicationData.medical_expires}" required>
            </div>
          </div>

          <hr style="border:none;border-top:2px solid var(--border);margin:32px 0">

          <!-- Accidents/Crashes -->
          <h3 style="color:var(--text-primary);margin-bottom:16px">Accidents/Crashes Previous 3 Years</h3>
          <div class="form-group" style="margin-bottom:24px">
            <label>Have you had any accidents/crashes in the last 3 years?</label>
            <div style="display:flex;gap:16px;margin-top:8px">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="accidents_3_years" value="true" ${applicationData.accidents_3_years ? 'checked' : ''}> Yes
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="accidents_3_years" value="false" ${!applicationData.accidents_3_years ? 'checked' : ''}> No
              </label>
            </div>
          </div>

          <!-- Moving Violations -->
          <h3 style="color:var(--text-primary);margin-bottom:16px">Moving Traffic Violations Previous 3 Years</h3>
          <div class="form-group" style="margin-bottom:24px">
            <label>Have you had any traffic violations in the last 3 years?</label>
            <div style="display:flex;gap:16px;margin-top:8px">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="violations_3_years" value="true" ${applicationData.violations_3_years ? 'checked' : ''}> Yes
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="violations_3_years" value="false" ${!applicationData.violations_3_years ? 'checked' : ''}> No
              </label>
            </div>
          </div>

          <!-- Forfeitures -->
          <h3 style="color:var(--text-primary);margin-bottom:16px">Forfeitures Previous 3 Years</h3>
          <div class="form-group" style="margin-bottom:16px">
            <label>A. Have you ever been denied a license, permit, or privilege to operate a motor vehicle?</label>
            <div style="display:flex;gap:16px;margin-top:8px">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="denied_license" value="true" ${applicationData.denied_license ? 'checked' : ''}> Yes
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="denied_license" value="false" ${!applicationData.denied_license ? 'checked' : ''}> No
              </label>
            </div>
          </div>
          <div class="form-group" style="margin-bottom:24px">
            <label>B. Has any license, permit or privilege ever been revoked or suspended?</label>
            <div style="display:flex;gap:16px;margin-top:8px">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="license_revoked" value="true" ${applicationData.license_revoked ? 'checked' : ''}> Yes
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="license_revoked" value="false" ${!applicationData.license_revoked ? 'checked' : ''}> No
              </label>
            </div>
          </div>

          <hr style="border:none;border-top:2px solid var(--border);margin:32px 0">

          <!-- Employment Record -->
          <h3 style="color:var(--text-primary);margin-bottom:16px">Employment Record Previous 10 Years</h3>
          <p style="color:var(--text-muted);font-size:13px;margin-bottom:16px">Any gaps in employment in excess of one (1) month must be explained. Start with the last or current position, including any military experience, and work backwards. You are required to list the complete mailing address, including street number, city, state, city, and complete all other information.</p>

          <div id="employment-items">
            ${applicationData.employment_history.map((emp, i) => getEmploymentItem(emp, i)).join('')}
          </div>
          <button type="button" class="btn btn-secondary" onclick="addEmploymentItem()" style="margin-bottom:24px">+ Add Employer</button>

          <div class="form-group" style="margin-bottom:24px">
            <label>Explain any gaps in employment that exceeds more than 1 month</label>
            <textarea name="employment_gaps" rows="3" style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px">${applicationData.employment_gaps}</textarea>
          </div>

          <hr style="border:none;border-top:2px solid var(--border);margin:32px 0">

          <!-- Certification -->
          <h3 style="color:var(--text-primary);margin-bottom:16px">TO BE READ AND SIGNED BY APPLICANT</h3>
          <div style="background:var(--bg-app);padding:20px;border-radius:8px;margin-bottom:24px;font-size:13px;color:var(--text-secondary);line-height:1.6">
            <p>I authorize you to make investigations (including contacting current and prior employers) into my personal, employment, financial, medical history, and other related matters as may be necessary in arriving at an employment decision. I hereby release employers, schools, health care providers, and other persons from all liability in responding to inquiries and releasing information in connection with my application.</p>
            <p style="margin-top:12px">In the event of employment, I understand that false or misleading information given in my application or interview(s) may result in discharge. I also understand that I am required to abide by all rules and regulations of the Company.</p>
            <p style="margin-top:12px">I understand that the information I provide regarding my current and/or prior employers may be used, and those employer(s) will be contacted for the purpose of investigating my safety performance history as required by 49 CFR 391.23. I understand that I have the right to:</p>
            <ul style="margin-top:8px;padding-left:20px">
              <li>Review information provided by current/previous employers</li>
              <li>Have errors in the information corrected by previous employers, and for those previous employers to resend the corrected information to the prospective employer; and</li>
              <li>Have a rebuttal statement attached to the alleged erroneous information, if the previous employer(s) and I cannot agree on the accuracy of the information.</li>
            </ul>
          </div>

          <p style="font-weight:600;color:var(--text-primary);margin-bottom:16px">This certifies that this application was completed by me, and all entries on it and information in it are true and complete to the best of my knowledge.</p>

          <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px">
            <div class="form-group">
              <label>Signature *</label>
              <div style="border:1px solid var(--border);border-radius:8px;background:var(--bg-card)">
                <canvas id="signature-canvas" width="400" height="150" style="width:100%;cursor:crosshair"></canvas>
                <div style="display:flex;justify-content:space-between;padding:8px;border-top:1px solid var(--border);font-size:12px">
                  <span style="color:var(--text-muted)"></span>
                  <div>
                    <button type="button" onclick="clearSignature()" style="background:none;border:none;color:var(--blue);cursor:pointer;font-size:12px">clear</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Date Signed *</label>
              <input type="date" name="page1_date" value="${applicationData.page1_date || new Date().toISOString().split('T')[0]}" required>
            </div>
          </div>
        </form>
      `;
    }

    function getEmploymentItem(emp, index) {
      const stateOptions = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'].map(s => `<option value="${s}" ${emp.state === s ? 'selected' : ''}>${s}</option>`).join('');
      return `
        <div class="employment-item" style="border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;background:var(--bg-app)">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <strong style="color:var(--text-primary)">Employer ${index + 1}</strong>
            ${index > 0 ? `<button type="button" onclick="removeEmploymentItem(${index})" style="background:var(--red-dim);color:var(--red);border:none;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:12px">Remove</button>` : ''}
          </div>
          <div style="display:grid;grid-template-columns:2fr 1fr 1fr 2fr;gap:12px;margin-bottom:12px">
            <div class="form-group"><label>Employer Name</label><input type="text" name="emp_${index}_name" value="${emp.employer_name || ''}"></div>
            <div class="form-group"><label>Phone</label><input type="text" name="emp_${index}_phone" value="${emp.phone || ''}"></div>
            <div class="form-group"><label>Fax</label><input type="text" name="emp_${index}_fax" value="${emp.fax || ''}"></div>
            <div class="form-group"><label>Email</label><input type="email" name="emp_${index}_email" value="${emp.email || ''}"></div>
          </div>
          <div class="form-group" style="margin-bottom:12px"><label>Address</label><input type="text" name="emp_${index}_address" value="${emp.address || ''}"></div>
          <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:12px;margin-bottom:12px">
            <div class="form-group"><label>City</label><input type="text" name="emp_${index}_city" value="${emp.city || ''}"></div>
            <div class="form-group"><label>State</label><select name="emp_${index}_state">${stateOptions}</select></div>
            <div class="form-group"><label>Zip Code</label><input type="text" name="emp_${index}_zip" value="${emp.zip || ''}"></div>
          </div>
          <div style="display:grid;grid-template-columns:2fr 1fr 1fr 2fr;gap:12px;margin-bottom:12px">
            <div class="form-group"><label>Position Held</label><input type="text" name="emp_${index}_position" value="${emp.position || ''}"></div>
            <div class="form-group"><label>Date From</label><input type="month" name="emp_${index}_from" value="${emp.date_from || ''}"></div>
            <div class="form-group"><label>Date To</label><input type="month" name="emp_${index}_to" value="${emp.date_to || ''}"></div>
            <div class="form-group"><label>Reason for Leaving</label><input type="text" name="emp_${index}_reason" value="${emp.reason_leaving || ''}"></div>
          </div>
          <div class="form-group" style="margin-bottom:12px"><label>Equipment Class</label><input type="text" name="emp_${index}_equipment" value="${emp.equipment_class || ''}"></div>
          <div style="display:flex;gap:24px">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px">
              <input type="checkbox" name="emp_${index}_fmcsr" ${emp.subject_fmcsr ? 'checked' : ''}> Subject to FMCSRs while employed?
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px">
              <input type="checkbox" name="emp_${index}_dot" ${emp.dot_regulated ? 'checked' : ''}> Safety-sensitive DOT regulated position (49 CFR Part 40)?
            </label>
          </div>
        </div>
      `;
    }

    function addEmploymentItem() {
      applicationData.employment_history.push({ employer_name: '', phone: '', fax: '', email: '', address: '', city: '', state: '', zip: '', position: '', date_from: '', date_to: '', reason_leaving: '', equipment_class: '', subject_fmcsr: false, dot_regulated: false });
      renderDriverApplication();
    }

    function removeEmploymentItem(index) {
      applicationData.employment_history.splice(index, 1);
      renderDriverApplication();
    }

    function getApplicationPage2() {
      return `
        <form id="app-form">
          <h2 style="color:var(--text-primary);margin-bottom:24px;font-size:24px">Fair Credit Reporting Act Disclosure Statement</h2>

          <div style="background:var(--bg-app);padding:24px;border-radius:8px;margin-bottom:24px;font-size:14px;color:var(--text-secondary);line-height:1.8">
            <p>In accordance with the provisions of Section 604 (b)(2)(A) of the Fair Credit Reporting Act, Public Law 91-508, as amended by the Consumer Credit Reporting Act of 1996 (Title II, Subtitle D, Chapter I, of Public Law 104-208), you are being informed that reports verifying your previous employment, previous drug and alcohol test results, and your driving record may be obtained on you for employment purposes. These reports are required by Sections 382.413 and 391.25 of the Federal Motor Carrier Safety Regulations. I acknowledge the receipt of the above disclosure and authorize to obtain a consumer report on me for employment purposes. This authorization is ongoing in the event such a report is needed in the future.</p>

            <p style="margin-top:16px">Pursuant to the federal Fair Credit Reporting Act, I, , hereby authorize this company and its designated agents and representatives to conduct a comprehensive review of my background through any consumer report for employment. I understand that the scope of the consumer report/investigative consumer report may include, but is not limited to, the following areas: verification of Social Security number; current and previous residences; employment history, including all personnel files; education; references; credit history and reports; criminal history, including records from any criminal justice agency in any or all federal, state or county jurisdictions; birth records; motor vehicle records, including traffic citations and registration; and any other public records.</p>
          </div>

          <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px">
            <div class="form-group">
              <label>Prospective Employee Signature *</label>
              <div style="border:1px solid var(--border);border-radius:8px;background:var(--bg-card)">
                <canvas id="signature-canvas" width="400" height="150" style="width:100%;cursor:crosshair"></canvas>
                <div style="display:flex;justify-content:space-between;padding:8px;border-top:1px solid var(--border);font-size:12px">
                  <span style="color:var(--text-muted)"></span>
                  <button type="button" onclick="clearSignature()" style="background:none;border:none;color:var(--blue);cursor:pointer;font-size:12px">clear</button>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Date Signed *</label>
              <input type="date" name="page2_date" value="${applicationData.page2_date || new Date().toISOString().split('T')[0]}" required>
            </div>
          </div>
        </form>
      `;
    }

    function getApplicationPage3() {
      return `
        <form id="app-form">
          <h2 style="color:var(--text-primary);margin-bottom:24px;font-size:24px">CERTIFICATION OF COMPLIANCE WITH DRIVER LICENSE REQUIREMENTS</h2>

          <div style="background:var(--bg-app);padding:24px;border-radius:8px;margin-bottom:24px;font-size:14px;color:var(--text-secondary);line-height:1.8">
            <p>The requirements in Part 383 apply to every contractor who operates in intrastate, interstate, or foreign commerce and operates a vehicle weighing 26,001 pounds or more, can transport more than 15 people, or transports hazardous materials that require placarding. The requirements in Part 391 apply to every driver who operates in interstate commerce and operates a vehicle weighing 10,001 pounds or more, can transport more than 15 people, or transports hazardous materials that require placarding.</p>

            <p style="margin-top:16px"><strong>DRIVER REQUIREMENTS:</strong> Parts 383 and 391 of the Federal Motor Carrier Safety Regulations contain some requirements that you as a contractor must comply with. They are as follows:</p>

            <p style="margin-top:16px"><strong>1. Possess only one license:</strong> You, as a commercial vehicle contractor, may not possess more than one motor vehicle operator's license. If you currently have more than one license, you should keep the license from your state of residence, and return the additional licenses to the states that issued them. Destroying a license does not close the record in the state that issued it: you must notify the state. If a multiple license has been lost, stolen, or destroyed, you should close your record by notifying the state of issuance that you no longer want to be licensed by that state.</p>

            <p style="margin-top:16px"><strong>2. Notification of license suspension, revocation or cancellation:</strong> Sections 392.42 and 383.33 of the Federal Motor Carrier Safety Regulations require that you notify the carrier the NEXT BUSINESS DAY of any revocation or suspension of your driver's license. In addition, Section 383.31 requires that any time you violate a state or local traffic law (other than parking), you must report it to motor carrier and the state that issued your license within 30 days.</p>

            <p style="margin-top:16px"><strong>I certify that I have read and understand the above requirements. The following license is the only one I will possess:</strong></p>
          </div>

          <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px">
            <div class="form-group">
              <label>Signature *</label>
              <div style="border:1px solid var(--border);border-radius:8px;background:var(--bg-card)">
                <canvas id="signature-canvas" width="400" height="150" style="width:100%;cursor:crosshair"></canvas>
                <div style="display:flex;justify-content:space-between;padding:8px;border-top:1px solid var(--border);font-size:12px">
                  <span style="color:var(--text-muted)"></span>
                  <button type="button" onclick="clearSignature()" style="background:none;border:none;color:var(--blue);cursor:pointer;font-size:12px">clear</button>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Date *</label>
              <input type="date" name="page3_date" value="${applicationData.page3_date || new Date().toISOString().split('T')[0]}" required>
            </div>
          </div>
        </form>
      `;
    }

    function getApplicationPage4() {
      return `
        <form id="app-form">
          <h2 style="color:var(--text-primary);margin-bottom:24px;font-size:24px">PRE-EMPLOYMENT EMPLOYEE ALCOHOL & DRUG TEST STATEMENT</h2>

          <div style="background:var(--bg-app);padding:24px;border-radius:8px;margin-bottom:24px;font-size:14px;color:var(--text-secondary);line-height:1.8">
            <p>49 CFR Part 40.25(j) states, as the employer, you must ask the employee whether he or she has tested positive, or refused to test, on any pre-employment drug or alcohol test administered by an employer to which the employee applied for, but did not obtain, safety-sensitive transportation work covered by DOT agency drug and alcohol testing rules during the past two years. If the employee admits that he or she had a positive test or a refusal to test, you must not use the employee to perform safety-sensitive functions for you, until and unless the employee documents successful completion of the return-to-duty process required in 49 CFR Subpart O.</p>
          </div>

          <h3 style="color:var(--text-primary);margin-bottom:16px">Drug and Alcohol Questions</h3>

          <div class="form-group" style="margin-bottom:16px">
            <label>A. Have you ever tested positive for a controlled substance?</label>
            <div style="display:flex;gap:16px;margin-top:8px">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="tested_positive" value="true" ${applicationData.tested_positive ? 'checked' : ''}> Yes
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="tested_positive" value="false" ${!applicationData.tested_positive ? 'checked' : ''}> No
              </label>
            </div>
          </div>

          <div class="form-group" style="margin-bottom:16px">
            <label>B. Have you ever had an alcohol concentration of .04 or greater?</label>
            <div style="display:flex;gap:16px;margin-top:8px">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="alcohol_concentration" value="true" ${applicationData.alcohol_concentration ? 'checked' : ''}> Yes
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="alcohol_concentration" value="false" ${!applicationData.alcohol_concentration ? 'checked' : ''}> No
              </label>
            </div>
          </div>

          <div class="form-group" style="margin-bottom:16px">
            <label>C. Have you ever refused a required test for drugs or alcohol?</label>
            <div style="display:flex;gap:16px;margin-top:8px">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="refused_test" value="true" ${applicationData.refused_test ? 'checked' : ''}> Yes
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="refused_test" value="false" ${!applicationData.refused_test ? 'checked' : ''}> No
              </label>
            </div>
          </div>

          <div class="form-group" style="margin-bottom:24px">
            <label>If you answered yes to the above question, can you provide documentation of successful completion of DOT return-to-duty requirements (including follow-up tests)?</label>
            <div style="display:flex;gap:16px;margin-top:8px">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="return_to_duty_docs" value="true" ${applicationData.return_to_duty_docs ? 'checked' : ''}> Yes
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="return_to_duty_docs" value="false" ${!applicationData.return_to_duty_docs ? 'checked' : ''}> No
              </label>
            </div>
          </div>

          <div style="background:var(--amber-dim);padding:20px;border-radius:8px;margin-bottom:24px;font-size:13px;color:var(--amber);line-height:1.6">
            <p>I understand that, as required by the Federal Motor Carrier Safety Regulations and Company policy, all drivers must submit to alcohol and controlled substance testing as a condition of employment. I also understand that any offer of employment will be contingent upon the results of an alcohol and controlled substance test. Therefore, I agree to submit to the following alcohol and controlled substance tests in accordance and as defined by the Federal Motor Carrier Safety Regulation and this Company's policies:</p>
            <ul style="margin-top:8px;padding-left:20px">
              <li>Pre-Employment, to determine employment eligibility</li>
              <li>Random</li>
              <li>Reasonable Suspicion</li>
              <li>Post-Accident</li>
            </ul>
          </div>

          <p style="font-weight:600;color:var(--text-primary);margin-bottom:16px">I certify that I have read, understand, and agree to abide by the conditions of this consent and release form.</p>

          <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px">
            <div class="form-group">
              <label>Prospective Employee Signature *</label>
              <div style="border:1px solid var(--border);border-radius:8px;background:var(--bg-card)">
                <canvas id="signature-canvas" width="400" height="150" style="width:100%;cursor:crosshair"></canvas>
                <div style="display:flex;justify-content:space-between;padding:8px;border-top:1px solid var(--border);font-size:12px">
                  <span style="color:var(--text-muted)"></span>
                  <button type="button" onclick="clearSignature()" style="background:none;border:none;color:var(--blue);cursor:pointer;font-size:12px">clear</button>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Date Signed *</label>
              <input type="date" name="page4_date" value="${applicationData.page4_date || new Date().toISOString().split('T')[0]}" required>
            </div>
          </div>
        </form>
      `;
    }

    function getApplicationPage5() {
      return `
        <form id="app-form">
          <h2 style="color:var(--text-primary);margin-bottom:24px;font-size:24px">SAFETY PERFORMANCE HISTORY INVESTIGATION</h2>

          <div style="background:var(--bg-app);padding:24px;border-radius:8px;margin-bottom:24px;font-size:13px;color:var(--text-secondary);line-height:1.8">
            <p>I, hereby authorize release of information to HORIZON STAR LLC from my employment file and my Department of Transportation regulated drug and alcohol testing records. This release is in accordance with DOT Regulation 49 CFR Parts 40.25/382.413/391.23. I understand that information to be released, by my previous employer, is limited to the previous three years. You are released from any and all liability which may result from releasing such information. Pursuant to the federal Fair Credit Reporting Act, I hereby authorize this company and its designated agents and representatives to conduct a comprehensive review of my background through any consumer report for employment. I understand that the scope of the consumer report/investigative consumer report may include, but is not limited to, the following areas: verification of Social Security number; current and previous residences; employment history, including all personnel files; education; references; credit history and reports; criminal history, including records from any criminal justice agency in any or all federal, state or county jurisdictions; birth records; motor vehicle records, including traffic citations and registration; and any other public records.</p>

            <p style="margin-top:16px">I understand that it is my right to review information provided by previous employers; to have errors in the information corrected by the previous employer and for that previous employer to re-send the corrected information; as well as the right to have a rebuttal statement attached to the alleged erroneous information if the previous employer and I cannot agree on the accuracy of the information. I understand that if I wish to review previous employer-provided investigative information, I must submit a written request, which may be done at any time, including when applying, or as late as 30 days after being employed or being notified of denial of employment. I understand that if I have not arranged to pick up or receive the requested records within thirty (30) days of them becoming available, it may be considered that I have waived my request to review the record(s).</p>

            <p style="margin-top:16px">I, , social security , hereby authorize the release of information from my Department of Transportation regulated drug and alcohol testing records by my previous employer, listed below, to HORIZON STAR LLC.</p>

            <p style="margin-top:16px">This release is in accordance with DOT Regulation 49 CFR Part 40, Section 40.25. I understand that information to be released by my previous employer is limited to the following DOT-regulated testing items:</p>
            <ol style="margin-top:8px;padding-left:20px">
              <li>Alcohol tests with a result of 0.04 or higher;</li>
              <li>Verified positive drug tests;</li>
              <li>Refusals to be tested;</li>
              <li>Other violations of DOT agency drug and alcohol testing regulations;</li>
              <li>Information obtained from previous employers of a drug and alcohol rule violation;</li>
              <li>Documentation, if any, of completion of the return-to-duty process following a rule violation.</li>
            </ol>

            <p style="margin-top:16px">I further authorize my former employer to release my safety performance history information to my prospective employer for investigation purposes as required by FMCSR 391.23, 382.405 (f) & 382.413(b) for the 3 years preceding this release. You are released from any and all liability that may result from furnishing such information. A photocopy of this release shall be as valid as the original.</p>
          </div>

          <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px">
            <div class="form-group">
              <label>Prospective Employee Signature *</label>
              <div style="border:1px solid var(--border);border-radius:8px;background:var(--bg-card)">
                <canvas id="signature-canvas" width="400" height="150" style="width:100%;cursor:crosshair"></canvas>
                <div style="display:flex;justify-content:space-between;padding:8px;border-top:1px solid var(--border);font-size:12px">
                  <span style="color:var(--text-muted)"></span>
                  <button type="button" onclick="clearSignature()" style="background:none;border:none;color:var(--blue);cursor:pointer;font-size:12px">clear</button>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Date Signed *</label>
              <input type="date" name="page5_date" value="${applicationData.page5_date || new Date().toISOString().split('T')[0]}" required>
            </div>
          </div>
        </form>
      `;
    }

    function getApplicationPage6() {
      return `
        <form id="app-form">
          <h2 style="color:var(--text-primary);margin-bottom:24px;font-size:24px">PSP DRIVER DISCLOSURE & AUTHORIZATION</h2>

          <div style="background:var(--amber-dim);border:1px solid var(--amber);padding:var(--spacing-4);border-radius:var(--radius);margin-bottom:16px;font-size:13px;color:var(--amber)">
            <strong>THE BELOW DISCLOSURE AND AUTHORIZATION LANGUAGE IS FOR MANDATORY USE BY ALL ACCOUNT HOLDERS IMPORTANT DISCLOSURE REGARDING BACKGROUND REPORTS FROM THE PSP Online Service.</strong>
          </div>

          <div style="background:var(--bg-app);padding:24px;border-radius:8px;margin-bottom:24px;font-size:12px;color:var(--text-secondary);line-height:1.8;max-height:400px;overflow-y:auto">
            <p>In connection with your application for employment with HORIZON STAR LLC, Prospective Employer, its employees, agents or contractors may obtain one or more reports regarding your driving, and safety inspection history from the Federal Motor Carrier Safety Administration (FMCSA).</p>

            <p style="margin-top:12px">When the application for employment is submitted in person, if the Prospective Employer uses any information it obtains from FMCSA in a decision to not hire you or to make any other adverse employment decision regarding you, the Prospective Employer will provide you with a copy of the report upon which its decision was based and a written summary of your rights under the Fair Credit Reporting Act before taking any final adverse action. If any final adverse action is taken against you based upon your driving history or safety report, the Prospective Employer will notify you that the action has been taken and that the action was based in part or in whole on this report.</p>

            <p style="margin-top:12px">When the application for employment is submitted by mail, telephone, computer, or other similar means, if the Prospective Employer uses any information it obtains from FMCSA in a decision to not hire you or to make any other adverse employment decision regarding you, the Prospective Employer must provide you within three business days of taking adverse action oral, written or electronic notification: that adverse action has been taken based in whole or in part on information obtained from FMCSA; the name, address, and the toll free telephone number of FMCSA; that the FMCSA did not make the decision to take the adverse action and is unable to provide you the specific reasons why the adverse action was taken; and that you may, upon providing proper identification, request a free copy of the report and may dispute with the FMCSA the accuracy or completeness of any information or report. If you request a copy of a driver record from the Prospective Employer who procured the report, then, within 3 business days of receiving your request, together with proper identification, the Prospective Employer must send or provide to you a copy of your report and a summary of your rights under the Fair Credit Reporting Act.</p>

            <p style="margin-top:12px">Neither the Prospective Employer nor the FMCSA contractor supplying the crash and safety information has the capability to correct any safety data that appears to be incorrect. You may challenge the accuracy of the data by submitting a request to https://dataqs.fmcsa.dot.gov. If you challenge crash or inspection information reported by a State, FMCSA cannot change or correct this data. Your request will be forwarded by the DataQs system to the appropriate State for adjudication.</p>

            <p style="margin-top:12px">Any crash or inspection in which you were involved will display on your PSP report. Since the PSP report does not report, or assign, or imply fault, it will include all Commercial Motor Vehicle (CMV) crashes where you were a driver or co-driver and where those crashes were reported to FMCSA, regardless of fault. Similarly, all inspections, with or without violations, appear on the PSP report. State citations associated with Federal Motor Carrier Safety Regulations (FMCSR) violations that have been adjudicated by a court of law will also appear, and remain, on a PSP report.</p>

            <p style="margin-top:12px">The Prospective Employer cannot obtain background reports from FMCSA without your authorization.</p>

            <p style="margin-top:16px"><strong>AUTHORIZATION</strong></p>
            <p>If you agree that the Prospective Employer may obtain such background reports, please read the following and sign below:</p>

            <p style="margin-top:12px">I authorize HORIZON STAR LLC ("Prospective Employer") to access the FMCSA Pre-Employment Screening Program (PSP) system to seek information regarding my commercial driving safety record and information regarding my safety inspection history. I understand that I am authorizing the release of safety performance information including crash data from the previous five (5) years and inspection history from the previous three (3) years. I understand and acknowledge that this release of information may assist the Prospective Employer to make a determination regarding my suitability as an employee.</p>

            <p style="margin-top:12px">I further understand that neither the Prospective Employer nor the FMCSA contractor supplying the crash and safety information has the capability to correct any safety data that appears to be incorrect. I understand I may challenge the accuracy of the data by submitting a request to https://dataqs.fmcsa.dot.gov. If I challenge crash or inspection information reported by a State, FMCSA cannot change or correct this data. I understand my request will be forwarded by the DataQs system to the appropriate State for adjudication.</p>

            <p style="margin-top:12px">I understand that any crash or inspection in which I was involved will display on my PSP report. Since the PSP report does not report, or assign, or imply fault, I acknowledge it will include all CMV crashes where I was a driver or co-driver and where those crashes were reported to FMCSA, regardless of fault. Similarly, I understand all inspections, with or without violations, will appear on my PSP report, and State citations associated with FMCSR violations that have been adjudicated by a court of law will also appear, and remain, on my PSP report.</p>

            <p style="margin-top:12px">I have read the above Disclosure Regarding Background Reports provided to me by Prospective Employer and I understand that if I sign this Disclosure and Authorization, Prospective Employer may obtain a report of my crash and inspection history. I hereby authorize Prospective Employer and its employees, authorized agents, and/or affiliates to obtain the information authorized above.</p>

            <p style="margin-top:12px"><strong>NOTICE:</strong> This form is made available to monthly account holders by NIC on behalf of the U.S. Department of Transportation, Federal Motor Carrier Safety Administration (FMCSA). Account holders are required by federal law to obtain an Applicant's written or electronic consent prior to accessing the Applicant's PSP report. Further, account holders are required by FMCSA to use the language contained in this Disclosure and Authorization form to obtain an Applicant's consent. The language must be used in whole, exactly as provided. Further, the language on this form must exist as one stand-alone document. The language may NOT be included with other consent forms or any other language.</p>

            <p style="margin-top:12px"><strong>NOTICE:</strong> The prospective employment concept referenced in this form contemplates the definition of "employee" contained at 49 C.F.R. 383.5.</p>
          </div>

          <div class="form-group" style="margin-bottom:24px">
            <label>Full Name *</label>
            <input type="text" name="page6_full_name" value="${applicationData.page6_full_name}" required>
          </div>

          <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px">
            <div class="form-group">
              <label>Signature *</label>
              <div style="border:1px solid var(--border);border-radius:8px;background:var(--bg-card)">
                <canvas id="signature-canvas" width="400" height="150" style="width:100%;cursor:crosshair"></canvas>
                <div style="display:flex;justify-content:space-between;padding:8px;border-top:1px solid var(--border);font-size:12px">
                  <span style="color:var(--text-muted)"></span>
                  <button type="button" onclick="clearSignature()" style="background:none;border:none;color:var(--blue);cursor:pointer;font-size:12px">clear</button>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Date Signed *</label>
              <input type="date" name="page6_date" value="${applicationData.page6_date || new Date().toISOString().split('T')[0]}" required>
            </div>
          </div>
        </form>
      `;
    }

    function getApplicationPage7() {
      return `
        <form id="app-form">
          <h2 style="color:var(--text-primary);margin-bottom:24px;font-size:24px">GENERAL CONSENT FOR LIMITED QUERIES OF THE FEDERAL MOTOR CARRIER SAFETY ADMINISTRATION (FMCSA) DRUG AND ALCOHOL CLEARINGHOUSE</h2>

          <div style="background:var(--bg-app);padding:24px;border-radius:8px;margin-bottom:24px;font-size:14px;color:var(--text-secondary);line-height:1.8">
            <p>I, , hereby provide consent to HORIZON STAR LLC to conduct a limited query of the FMCSA Commercial Driver's License Drug and Alcohol Clearinghouse (Clearinghouse) to determine whether drug or alcohol violation information about me exists in the Clearinghouse.</p>

            <p style="margin-top:16px">I am consenting to multiple limited queries for the duration of employment with HORIZON STAR LLC.</p>

            <p style="margin-top:16px">I understand that if the limited query conducted by HORIZON STAR LLC indicates that drug or alcohol violation information about me exists in the Clearinghouse, FMCSA will not disclose that information to HORIZON STAR LLC without first obtaining additional specific consent from me.</p>

            <p style="margin-top:16px">I further understand that if I refuse to provide consent for HORIZON STAR LLC to conduct a limited query of the Clearinghouse, HORIZON STAR LLC must prohibit me from performing safety-sensitive functions, including driving a commercial motor vehicle, as required by FMCSA's drug and alcohol program regulations.</p>
          </div>

          <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px;margin-bottom:24px">
            <div class="form-group">
              <label>Prospective Employee Signature *</label>
              <div style="border:1px solid var(--border);border-radius:8px;background:var(--bg-card)">
                <canvas id="signature-canvas" width="400" height="150" style="width:100%;cursor:crosshair"></canvas>
                <div style="display:flex;justify-content:space-between;padding:8px;border-top:1px solid var(--border);font-size:12px">
                  <span style="color:var(--text-muted)"></span>
                  <button type="button" onclick="clearSignature()" style="background:none;border:none;color:var(--blue);cursor:pointer;font-size:12px">clear</button>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Date Signed *</label>
              <input type="date" name="page7_date" value="${applicationData.page7_date || new Date().toISOString().split('T')[0]}" required>
            </div>
          </div>

          <div class="form-group">
            <label>Are you registered with FMCSA Clearinghouse?</label>
            <div style="display:flex;gap:16px;margin-top:8px">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="clearinghouse_registered" value="true" ${applicationData.clearinghouse_registered ? 'checked' : ''}> Yes
              </label>
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                <input type="radio" name="clearinghouse_registered" value="false" ${!applicationData.clearinghouse_registered ? 'checked' : ''}> No
              </label>
            </div>
          </div>
        </form>
      `;
    }

    function getApplicationPage8() {
      return `
        <form id="app-form">
          <h2 style="color:var(--text-primary);margin-bottom:24px;font-size:24px">MVR Release Consent</h2>

          <div style="background:var(--bg-app);padding:24px;border-radius:8px;margin-bottom:24px;font-size:14px;color:var(--text-secondary);line-height:1.8">
            <p>In conjunction with my potential employment HORIZON STAR LLC ("the company"), I (applicant) consent to the release of my Motor Vehicle Records (MVR) to the company. I understand the company will use these records to evaluate my suitability to fulfill driving duties that may be related to the position for which I am applying. I also consent to the review, evaluation, and other use of any MVR I may have provided to the company.</p>

            <p style="margin-top:16px">This consent is given in satisfaction of Public Law 18 USC 2721 et. Seq., "Federal Drivers Privacy Protection Act", and is intended to constitute "written consent" as required by this Act.</p>
          </div>

          <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px">
            <div class="form-group">
              <label>Prospective Employee Signature *</label>
              <div style="border:1px solid var(--border);border-radius:8px;background:var(--bg-card)">
                <canvas id="signature-canvas" width="400" height="150" style="width:100%;cursor:crosshair"></canvas>
                <div style="display:flex;justify-content:space-between;padding:8px;border-top:1px solid var(--border);font-size:12px">
                  <span style="color:var(--text-muted)"></span>
                  <button type="button" onclick="clearSignature()" style="background:none;border:none;color:var(--blue);cursor:pointer;font-size:12px">clear</button>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Date Signed *</label>
              <input type="date" name="page8_date" value="${applicationData.page8_date || new Date().toISOString().split('T')[0]}" required>
            </div>
          </div>

          <div style="background:var(--green-dim);padding:20px;border-radius:8px;margin-top:24px;text-align:center">
            <p style="color:var(--primary-800);font-size:16px;font-weight:600"> You're almost done!</p>
            <p style="color:var(--green);font-size:14px;margin-top:8px">Click "Submit Application" below to complete your application.</p>
          </div>
        </form>
      `;
    }

    // Signature Canvas Functions
    function initSignatureCanvas() {
      signatureCanvas = document.getElementById('signature-canvas');
      if (!signatureCanvas) return;

      signatureCtx = signatureCanvas.getContext('2d');
      signatureCtx.strokeStyle = 'var(--bg-elevated)';
      signatureCtx.lineWidth = 2;
      signatureCtx.lineCap = 'round';

      // Load existing signature if any
      const sigKey = 'page' + applicationPage + '_signature';
      if (applicationData[sigKey]) {
        const img = new Image();
        img.onload = () => signatureCtx.drawImage(img, 0, 0);
        img.src = applicationData[sigKey];
      }

      // Mouse events
      signatureCanvas.addEventListener('mousedown', startDrawing);
      signatureCanvas.addEventListener('mousemove', draw);
      signatureCanvas.addEventListener('mouseup', stopDrawing);
      signatureCanvas.addEventListener('mouseout', stopDrawing);

      // Touch events
      signatureCanvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDrawing(e.touches[0]); });
      signatureCanvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
      signatureCanvas.addEventListener('touchend', stopDrawing);
    }

    function startDrawing(e) {
      isDrawing = true;
      signatureCtx.beginPath();
      const rect = signatureCanvas.getBoundingClientRect();
      const scaleX = signatureCanvas.width / rect.width;
      const scaleY = signatureCanvas.height / rect.height;
      signatureCtx.moveTo((e.clientX - rect.left) * scaleX, (e.clientY - rect.top) * scaleY);
    }

    function draw(e) {
      if (!isDrawing) return;
      const rect = signatureCanvas.getBoundingClientRect();
      const scaleX = signatureCanvas.width / rect.width;
      const scaleY = signatureCanvas.height / rect.height;
      signatureCtx.lineTo((e.clientX - rect.left) * scaleX, (e.clientY - rect.top) * scaleY);
      signatureCtx.stroke();
    }

    function stopDrawing() {
      isDrawing = false;
    }

    function clearSignature() {
      if (signatureCtx) {
        signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
      }
    }

    // File upload handler
    async function handleFileUpload(input, fieldName) {
      const file = input.files[0];
      if (!file) return;

      // For now, store as base64 (in production, upload to Supabase Storage)
      const reader = new FileReader();
      reader.onload = (e) => {
        applicationData[fieldName] = e.target.result;
        showToast('File uploaded successfully');
      };
      reader.readAsDataURL(file);
    }

    // Submit application
    async function submitApplication() {
      saveCurrentPageData();

      // Validate required fields
      if (!applicationData.first_name || !applicationData.last_name || !applicationData.email) {
        showToast('Please complete all required fields on Page 1', 'error');
        applicationPage = 1;
        renderDriverApplication();
        return;
      }

      try {
        // Clean up any keys that shouldn't be in the database
        const invalidKeys = ['license_front', 'license_back', 'medical_card'];
        Object.keys(applicationData).forEach(key => {
          if (key.match(/^emp_\d+_/) || invalidKeys.includes(key)) {
            delete applicationData[key];
          }
        });

        // Insert into database
        const { data, error } = await sb.from('driver_applications').insert([applicationData]).select();

        if (error) throw error;

        // Show success message
        document.getElementById('app').innerHTML = `
          <div style="min-height:100vh;background:linear-gradient(135deg,var(--bg-elevated) 0%,var(--bg-elevated) 100%);display:flex;align-items:center;justify-content:center;padding:20px">
            <div style="background:var(--bg-card);border-radius:16px;padding:48px;text-align:center;max-width:500px">
              <div style="font-size:64px;margin-bottom:24px"></div>
              <h1 style="color:var(--text-primary);margin-bottom:16px">Application Submitted!</h1>
              <p style="color:var(--text-muted);margin-bottom:24px">Thank you for applying to HORIZON STAR LLC. We have received your application and will review it shortly.</p>
              <p style="color:var(--text-muted);font-size:14px;margin-bottom:32px">A confirmation email will be sent to <strong>${applicationData.email}</strong></p>
              <button class="btn btn-primary" onclick="renderLogin()">Return to Home</button>
            </div>
          </div>
        `;

        // Reset application data
        applicationPage = 1;
        applicationData = {
          first_name: '', last_name: '', date_of_birth: '', ssn: '',
          phone: '', email: '', address: '', city: '', state: '', zip: '',
          lived_3_years: false, previous_addresses: [],
          license_number: '', license_state: '', license_class: '',
          license_expires: '', license_front_url: '', license_back_url: '',
          endorsements: [], other_licenses_3_years: false, other_licenses_details: [],
          medical_card_url: '', medical_expires: '',
          accidents_3_years: false, accidents_details: [],
          violations_3_years: false, violations_details: [],
          denied_license: false, denied_license_details: '',
          license_revoked: false, license_revoked_details: '',
          employment_history: [{ employer_name: '', phone: '', fax: '', email: '', address: '', city: '', state: '', zip: '', position: '', date_from: '', date_to: '', reason_leaving: '', equipment_class: '', subject_fmcsr: false, dot_regulated: false }],
          employment_gaps: '',
          page1_signature: '', page1_date: '',
          page2_signature: '', page2_date: '',
          page3_signature: '', page3_date: '',
          page4_signature: '', page4_date: '',
          page5_signature: '', page5_date: '',
          page6_signature: '', page6_date: '', page6_full_name: '',
          page7_signature: '', page7_date: '', clearinghouse_registered: false,
          page8_signature: '', page8_date: '',
          tested_positive: false, alcohol_concentration: false, refused_test: false, return_to_duty_docs: false
        };

      } catch (err) {
        console.error('Submit error:', err);
        showToast('Error submitting application: ' + err.message, 'error');
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim().toLowerCase();
      const password = document.getElementById('login-password').value;
      const errorEl = document.getElementById('login-error');
      const btnEl = document.getElementById('login-btn');
      
      // Check if account is locked
      const lockStatus = isAccountLocked(email);
      if (lockStatus.locked) {
        errorEl.textContent = `Account locked. Try again in ${lockStatus.remainingMinutes} minutes.`;
        errorEl.style.display = 'block';
        return;
      }
      
      btnEl.textContent = 'Signing in...';
      btnEl.disabled = true;
      
      try {
        // Try Supabase Auth first
        const { data: authData, error: authError } = await sb.auth.signInWithPassword({
          email: email,
          password: password
        });
        
        if (!authError && authData.session) {
          // Supabase Auth success - store session
          authSession = authData.session;
          recordLoginAttempt(email, true);
          
          // Get user from our users table
          let users = await dbFetch('users', { filter: { email: 'eq.' + email } });
          
          if (users.length === 0) {
            // Create user record if doesn't exist (new Supabase Auth user)
            const newUser = await dbInsert('users', {
              auth_id: authData.user.id,
              email: email,
              first_name: authData.user.user_metadata?.first_name || email.split('@')[0],
              last_name: authData.user.user_metadata?.last_name || '',
              role: 'DISPATCHER',
              is_active: true
            });
            users = [newUser];
          } else if (!users[0].auth_id) {
            // Link existing user to Supabase Auth
            await dbUpdate('users', users[0].id, { auth_id: authData.user.id });
            users[0].auth_id = authData.user.id;
          }
          
          currentUser = users[0];
          localStorage.setItem('horizonstar_user', JSON.stringify(currentUser));
          startSessionMonitor();
          await logActivity('LOGIN_SUCCESS', { email, method: 'supabase_auth' });
          renderApp();
          return;
        }
        
        // Supabase Auth failed - try legacy login for migration
        const users = await dbFetch('users', { filter: { email: 'eq.' + email } });
        
        if (users.length === 0) {
          recordLoginAttempt(email, false);
          const attempts = getLoginAttempts(email);
          const remaining = LOGIN_ATTEMPT_LIMIT - attempts.count;
          errorEl.textContent = `Invalid credentials. ${remaining} attempts remaining.`;
          errorEl.style.display = 'block';
          btnEl.textContent = 'Sign In';
          btnEl.disabled = false;
          return;
        }
        
        const user = users[0];
        
        // Check if user is active
        if (user.is_active === false) {
          errorEl.textContent = 'Account deactivated.';
          errorEl.style.display = 'block';
          btnEl.textContent = 'Sign In';
          btnEl.disabled = false;
          return;
        }
        
        // Check legacy password (for users not yet migrated to Supabase Auth)
        const hashedPassword = await hashPassword(password);
        const passwordMatch = user.password === hashedPassword || user.password === password;
        
        if (!passwordMatch) {
          recordLoginAttempt(email, false);
          const attempts = getLoginAttempts(email);
          
          if (attempts.count >= LOGIN_ATTEMPT_LIMIT) {
            errorEl.textContent = `Too many attempts. Account locked for ${LOGIN_LOCKOUT_MINUTES} minutes.`;
          } else {
            const remaining = LOGIN_ATTEMPT_LIMIT - attempts.count;
            errorEl.textContent = `Invalid password. ${remaining} attempts remaining.`;
          }
          errorEl.style.display = 'block';
          btnEl.textContent = 'Sign In';
          btnEl.disabled = false;
          return;
        }
        
        // Legacy password matched - migrate to Supabase Auth
        recordLoginAttempt(email, true);
        
        // Try to sign in with Supabase Auth first (user might already exist there)
        let { data: signInData, error: signInError } = await sb.auth.signInWithPassword({
          email: email,
          password: password
        });
        
        if (signInError) {
          // User doesn't exist in Supabase Auth - create account
          const { data: signUpData, error: signUpError } = await sb.auth.signUp({
            email: email,
            password: password,
            options: {
              data: {
                first_name: user.first_name,
                last_name: user.last_name
              }
            }
          });
          
          if (signUpError) {
            console.error('Supabase Auth signup error:', signUpError);
            // Continue anyway with legacy session
          } else if (signUpData.user) {
            // Update user with auth_id
            try {
              await dbUpdate('users', user.id, { auth_id: signUpData.user.id });
              user.auth_id = signUpData.user.id;
            } catch (e) { console.error('Update auth_id error:', e); }
            
            // Sign in immediately after signup
            const { data: newSignIn } = await sb.auth.signInWithPassword({
              email: email,
              password: password
            });
            if (newSignIn?.session) {
              authSession = newSignIn.session;
            }
          }
        } else if (signInData?.session) {
          // Successfully signed in to existing Supabase Auth account
          authSession = signInData.session;
          
          // Link auth_id if not linked yet
          if (!user.auth_id && signInData.user) {
            try {
              await dbUpdate('users', user.id, { auth_id: signInData.user.id });
              user.auth_id = signInData.user.id;
            } catch (e) { console.error('Update auth_id error:', e); }
          }
        }
        
        currentUser = user;
        localStorage.setItem('horizonstar_user', JSON.stringify(currentUser));
        startSessionMonitor();
        await logActivity('LOGIN_SUCCESS', { email, method: 'legacy_migrated' });
        renderApp();
        
      } catch (err) {
        console.error('Login error:', err);
        errorEl.textContent = 'Connection error';
        errorEl.style.display = 'block';
        btnEl.textContent = 'Sign In';
        btnEl.disabled = false;
      }
    }

    // Privacy Policy Modal
    function showPrivacyPolicy() {
      const m = document.createElement('div');
      m.className = 'modal-overlay';
      m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = `
        <div class="modal" style="max-width:700px;max-height:90vh">
          <div class="modal-header">
            <h3> Privacy Policy</h3>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
          </div>
          <div class="modal-body" style="max-height:70vh;overflow-y:auto;font-size:14px;line-height:1.7">
            <p style="color:var(--text-secondary);margin-bottom:16px"><strong>Last Updated:</strong> January 9, 2026</p>

            <h4 style="color:var(--primary);margin:20px 0 12px">1. Introduction</h4>
            <p style="color:var(--text-secondary);margin-bottom:12px">
              Horizon Star LLC ("we", "our", or "us") operates the Horizon Star Driver mobile application and web-based Transportation Management System (TMS). This Privacy Policy explains how we collect, use, disclose, and safeguard your information.
            </p>

            <h4 style="color:var(--primary);margin:20px 0 12px">2. Information We Collect</h4>
            <p style="color:var(--text-secondary);margin-bottom:8px"><strong>Personal Information:</strong></p>
            <ul style="color:var(--text-secondary);margin-left:20px;margin-bottom:12px">
              <li>Name, email address, phone number</li>
              <li>Driver identification (PIN code)</li>
              <li>Employment information (cut percentage, assigned trips)</li>
            </ul>
            <p style="color:var(--text-secondary);margin-bottom:8px"><strong>Vehicle Inspection Data:</strong></p>
            <ul style="color:var(--text-secondary);margin-left:20px;margin-bottom:12px">
              <li>Photos and videos of vehicles during pickup/delivery inspections</li>
              <li>Vehicle condition reports and damage documentation</li>
              <li>Odometer readings and VIN numbers</li>
              <li>Digital signatures from drivers and customers</li>
            </ul>
            <p style="color:var(--text-secondary);margin-bottom:8px"><strong>Trip and Financial Data:</strong></p>
            <ul style="color:var(--text-secondary);margin-left:20px;margin-bottom:12px">
              <li>Trip assignments, routes, and delivery information</li>
              <li>Payment records and earnings history</li>
              <li>Expense reports and receipt images</li>
            </ul>

            <h4 style="color:var(--primary);margin:20px 0 12px">3. How We Use Your Information</h4>
            <ul style="color:var(--text-secondary);margin-left:20px;margin-bottom:12px">
              <li>To facilitate vehicle transportation and delivery services</li>
              <li>To document vehicle conditions for insurance and liability purposes</li>
              <li>To process driver payroll and track earnings</li>
              <li>To communicate trip assignments and updates</li>
              <li>To generate Bills of Lading and inspection reports</li>
              <li>To comply with transportation regulations (FMCSA, DOT)</li>
            </ul>

            <h4 style="color:var(--primary);margin:20px 0 12px">4. Data Storage and Security</h4>
            <p style="color:var(--text-secondary);margin-bottom:12px">
              Your data is stored securely using Supabase cloud infrastructure with encryption at rest and in transit. We implement industry-standard security measures including secure HTTPS connections, authenticated API access, and regular security audits.
            </p>

            <h4 style="color:var(--primary);margin:20px 0 12px">5. Data Sharing</h4>
            <p style="color:var(--text-secondary);margin-bottom:12px">
              We do not sell your personal information. We may share data with:
            </p>
            <ul style="color:var(--text-secondary);margin-left:20px;margin-bottom:12px">
              <li>Customers receiving vehicle deliveries (inspection reports, signatures)</li>
              <li>Insurance providers when required for claims</li>
              <li>Law enforcement when required by law</li>
              <li>Service providers who assist our operations (under confidentiality agreements)</li>
            </ul>

            <h4 style="color:var(--primary);margin:20px 0 12px">6. Data Retention</h4>
            <p style="color:var(--text-secondary);margin-bottom:12px">
              We retain inspection records, photos, and trip data for a minimum of 3 years to comply with transportation industry regulations. Payroll records are retained for 7 years per IRS requirements. You may request deletion of non-essential data at any time.
            </p>

            <h4 style="color:var(--primary);margin:20px 0 12px">7. Your Rights</h4>
            <p style="color:var(--text-secondary);margin-bottom:12px">You have the right to:</p>
            <ul style="color:var(--text-secondary);margin-left:20px;margin-bottom:12px">
              <li>Access your personal data</li>
              <li>Request correction of inaccurate data</li>
              <li>Request deletion of your data (subject to legal retention requirements)</li>
              <li>Withdraw consent for optional data processing</li>
            </ul>

            <h4 style="color:var(--primary);margin:20px 0 12px">8. Contact Us</h4>
            <p style="color:var(--text-secondary);margin-bottom:12px">
              For privacy-related questions or to exercise your rights, contact us at:<br>
              <strong>Email:</strong> privacy@horizonstarllc.com<br>
              <strong>Company:</strong> Horizon Star LLC
            </p>

            <h4 style="color:var(--primary);margin:20px 0 12px">9. Changes to This Policy</h4>
            <p style="color:var(--text-secondary);margin-bottom:12px">
              We may update this Privacy Policy from time to time. We will notify users of any material changes via the app or email.
            </p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(m);
    }

    // Forgot Password Flow
    function showForgotPassword() {
      const m = document.createElement('div');
      m.className = 'modal-overlay';
      m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = `
        <div class="modal" style="max-width:420px">
          <div class="modal-header">
            <h3> Reset Password</h3>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
          </div>
          <div class="modal-body">
            <div id="forgot-step-1">
              <p style="color:var(--text-secondary);margin-bottom:20px;font-size:14px">
                ${'Enter your email and we\'ll send you a reset code.'}
              </p>
              <div class="form-group">
                <label>Email</label>
                <input type="email" id="forgot-email" placeholder="your@email.com">
              </div>
              <div id="forgot-error" style="color:var(--red);font-size:13px;margin-bottom:12px;display:none"></div>
            </div>
            <div id="forgot-step-2" style="display:none">
              <p style="color:var(--text-secondary);margin-bottom:20px;font-size:14px">
                Enter your new password.
              </p>
              <div class="form-group">
                <label>New Password</label>
                <input type="password" id="forgot-new-password" placeholder="Min 6 characters">
              </div>
              <div class="form-group">
                <label>Confirm Password</label>
                <input type="password" id="forgot-confirm-password" placeholder="Confirm">
              </div>
              <div id="forgot-error-2" style="color:var(--red);font-size:13px;margin-bottom:12px;display:none"></div>
            </div>
            <div id="forgot-success" style="display:none;text-align:center;padding:20px">
              <div style="font-size:48px;margin-bottom:16px"></div>
              <p style="color:var(--accent-primary);font-weight:600">Password reset successful!</p>
            </div>
          </div>
          <div class="modal-footer" id="forgot-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
            <button class="btn btn-primary" id="forgot-btn" onclick="handleForgotStep1()">Continue</button>
          </div>
        </div>
      `;
      document.body.appendChild(m);
    }

    async function handleForgotStep1() {
      const email = document.getElementById('forgot-email').value.trim().toLowerCase();
      const errorEl = document.getElementById('forgot-error');
      const btn = document.getElementById('forgot-btn');
      
      if (!email) {
        errorEl.textContent = 'Please enter your email';
        errorEl.style.display = 'block';
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Verifying...';
      
      try {
        const users = await dbFetch('users', { filter: { email: 'eq.' + email } });
        
        if (users.length === 0) {
          errorEl.textContent = 'Email not found';
          errorEl.style.display = 'block';
          btn.disabled = false;
          btn.textContent = 'Continue';
          return;
        }
        
        // Store user for step 2
        window.forgotPasswordUser = users[0];
        
        // Log activity
        await logActivity('PASSWORD_RESET_REQUEST', { email });
        
        // Move to step 2 (In a real app, you'd send an email with a code)
        document.getElementById('forgot-step-1').style.display = 'none';
        document.getElementById('forgot-step-2').style.display = 'block';
        btn.textContent = 'Reset Password';
        btn.disabled = false;
        btn.onclick = handleForgotStep2;
        
      } catch (e) {
        errorEl.textContent = 'Error: ' + e.message;
        errorEl.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Continue';
      }
    }

    async function handleForgotStep2() {
      const newPassword = document.getElementById('forgot-new-password').value;
      const confirmPassword = document.getElementById('forgot-confirm-password').value;
      const errorEl = document.getElementById('forgot-error-2');
      const btn = document.getElementById('forgot-btn');
      
      if (newPassword.length < 6) {
        errorEl.textContent = 'Password must be at least 6 characters';
        errorEl.style.display = 'block';
        return;
      }
      
      if (newPassword !== confirmPassword) {
        errorEl.textContent = 'Passwords do not match';
        errorEl.style.display = 'block';
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Resetting...';
      
      try {
        const hashedPassword = await hashPassword(newPassword);
        await dbUpdate('users', window.forgotPasswordUser.id, { password: hashedPassword });
        
        // Log activity
        await logActivity('PASSWORD_RESET_SUCCESS', { email: window.forgotPasswordUser.email });
        
        // Clear login attempts for this user
        const attempts = JSON.parse(localStorage.getItem('login_attempts') || '{}');
        delete attempts[window.forgotPasswordUser.email];
        localStorage.setItem('login_attempts', JSON.stringify(attempts));
        
        // Show success
        document.getElementById('forgot-step-2').style.display = 'none';
        document.getElementById('forgot-success').style.display = 'block';
        document.getElementById('forgot-footer').innerHTML = `
          <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Close</button>
        `;
        
        delete window.forgotPasswordUser;
        
      } catch (e) {
        errorEl.textContent = 'Error: ' + e.message;
        errorEl.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Reset Password';
      }
    }

    async function logout() { 
      // Log activity before clearing user
      if (currentUser) {
        await logActivity('LOGOUT', { email: currentUser.email });
      }
      
      // Update loading message based on language
      document.getElementById('loading-message').textContent = 'Logging out';
      
      // Show loading animation
      document.getElementById('loading-overlay').classList.add('show');
      
      // Sign out from Supabase Auth
      try {
        await sb.auth.signOut();
      } catch (e) { /* Ignore signout errors */ }
      
      // Clear session monitor
      if (sessionTimeoutId) {
        clearInterval(sessionTimeoutId);
        sessionTimeoutId = null;
      }
      
      // Clear user data and session
      currentUser = null; 
      authSession = null;
      localStorage.removeItem('horizonstar_user'); 
      localStorage.removeItem('last_activity');
      protectedAccessGranted = false; 
      
      // Redirect after 2.5 seconds
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 2500);
    }

    // World Clocks - Live time display
    function updateWorldClocks() {
      const now = new Date();
      
      // New York (Eastern Time)
      const nyTime = now.toLocaleTimeString('en-US', { 
        timeZone: 'America/New_York', 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
      });
      
      // California (Pacific Time)
      const caTime = now.toLocaleTimeString('en-US', { 
        timeZone: 'America/Los_Angeles', 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
      });
      
      // Tbilisi, Georgia (Georgia Standard Time)
      const tbilisiTime = now.toLocaleTimeString('en-US', { 
        timeZone: 'Asia/Tbilisi', 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
      });
      
      const clockNY = document.getElementById('clockNY');
      const clockCA = document.getElementById('clockCA');
      const clockTbilisi = document.getElementById('clockTbilisi');
      
      if (clockNY) clockNY.textContent = nyTime;
      if (clockCA) clockCA.textContent = caTime;
      if (clockTbilisi) clockTbilisi.textContent = tbilisiTime;
    }
    
    // Start world clocks - update every second
    setInterval(updateWorldClocks, 1000);

    async function renderApp() {
      applyTheme();
      const themeIcon = isDarkTheme ? '' : '';
      const userInitials = (currentUser.first_name?.charAt(0) || '') + (currentUser.last_name?.charAt(0) || '');
      
      const isSidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
      
      // Top bar like Lovable
      const topBar = '<div class="topbar">' +
        '<div class="topbar-left">' +
        '<span class="welcome-text">' + 'Welcome back,' + ' <span class="welcome-name">' + currentUser.first_name + '</span></span>' +
        '</div>' +
        '<div class="topbar-center" id="worldClocks">' +
        '<div class="world-clock"><span class="clock-city"> NY</span><span class="clock-time" id="clockNY">--:--</span></div>' +
        '<div class="world-clock"><span class="clock-city"> CA</span><span class="clock-time" id="clockCA">--:--</span></div>' +
        '<div class="world-clock"><span class="clock-city"> Tbilisi</span><span class="clock-time" id="clockTbilisi">--:--</span></div>' +
        '</div>' +
        '<div class="topbar-right">' +
        '' +
        '<button onclick="toggleDarkTheme()" class="topbar-btn" title="Theme">' + themeIcon + '</button>' +
        '<div class="notification-wrapper">' +
        '<button onclick="toggleNotificationDropdown()" class="topbar-btn notification-btn" title="Notifications"><span class="notification-badge" id="notificationBadge" style="display:none">0</span></button>' +
        '<div class="notification-dropdown" id="notificationDropdown">' +
        '<div class="notification-header"><strong>' + 'Notifications' + '</strong><button onclick="markAllNotificationsRead()" style="background:none;border:none;color:var(--primary);cursor:pointer;font-size:12px">' + 'Mark all read' + '</button></div>' +
        '<div id="notificationList" class="notification-list"><div style="padding:20px;text-align:center;color:var(--text-muted)">Loading...</div></div>' +
        '</div>' +
        '</div>' +
        '<div class="topbar-user-wrapper">' +
        '<div class="topbar-user" onclick="toggleUserDropdown()">' +
        '<div class="topbar-avatar">' + userInitials + '</div>' +
        '<div class="topbar-user-info"><div class="topbar-user-name">' + currentUser.first_name + ' ' + currentUser.last_name + '</div><div class="topbar-user-role">' + currentUser.role + '</div></div>' +
        '<span class="topbar-user-arrow"></span>' +
        '</div>' +
        '<div class="topbar-dropdown" id="userDropdown">' +
        '<div class="topbar-dropdown-header"><div class="topbar-dropdown-avatar">' + userInitials + '</div><div><div class="topbar-dropdown-name">' + currentUser.first_name + ' ' + currentUser.last_name + '</div><div class="topbar-dropdown-email">' + (currentUser.email || currentUser.role) + '</div></div></div>' +
        '<div class="topbar-dropdown-divider"></div>' +
        '<button class="topbar-dropdown-item logout" onclick="logout()"><span></span> ' + t('logout') + '</button>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>';
      
      // Mobile header with hamburger menu
      const mobileHeader = '<div class="mobile-header">' +
        '<button class="hamburger" id="hamburger" onclick="toggleMobileMenu()" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="sidebar">' +
        '<span></span><span></span><span></span>' +
        '</button>' +
        '<span class="mobile-logo" style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:white"> Horizon<span style="color:var(--green)">Star</span></span>' +
        '<div class="user-avatar" style="width:36px;height:36px;font-size:12px;font-weight:700;background:var(--bg-card);color:var(--primary);border-radius:10px" aria-label="User profile">' + userInitials + '</div>' +
        '</div>';
      
      document.getElementById('app').innerHTML = mobileHeader + '<div class="app">' +
        '<div class="mobile-overlay" id="mobileOverlay" onclick="if(event.target===this)toggleMobileMenu()"></div>' +
        '<aside class="sidebar' + (isSidebarCollapsed ? ' collapsed' : '') + '" id="sidebar" role="navigation" aria-label="Main navigation" onclick="event.stopPropagation()" ontouchstart="event.stopPropagation()">' +
        '<button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle Sidebar" aria-label="Collapse sidebar" aria-expanded="' + (!isSidebarCollapsed) + '"></button>' +
        '<div class="logo"><span style="font-size:1.3rem;font-weight:700;color:var(--text-primary);">HORIZON STAR</span></div>' +
        '<nav id="nav" role="menubar" aria-label="Application navigation"></nav>' +
        '</aside>' +
        '<main class="main' + (isSidebarCollapsed ? ' sidebar-collapsed' : '') + '" role="main" aria-label="Main content">' + topBar + '<div id="main-content"><div class="loading" role="status" aria-live="polite"><div class="spinner" aria-hidden="true"></div> ' + t('loading') + '</div></div></main>' +
        '</div>';
      
      // Restore saved page from localStorage (persist across refresh)
      const savedPage = localStorage.getItem('tms_current_page');
      const validPages = ['dashboard', 'live_map', 'team_chat', 'trips', 'orders', 'future_cars', 'tasks', 'drivers', 'trucks', 'local_drivers', 'brokers', 'dispatchers', 'dispatcher_ranking', 'financials', 'billing', 'payroll', 'fuel', 'ifta', 'maintenance', 'compliance', 'settings', 'users', 'activity_log'];
      if (savedPage && validPages.includes(savedPage)) {
        currentPage = savedPage;
      }
      
      renderNav(); await loadAllData(); renderPage(); startNotificationPolling(); startSessionMonitor(); startRealtimeSync(); updateWorldClocks();
    }
    
    function toggleMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const hamburger = document.getElementById('hamburger');
      const overlay = document.getElementById('mobileOverlay');
      
      const isOpening = !sidebar.classList.contains('mobile-open');
      
      sidebar.classList.toggle('mobile-open');
      hamburger.classList.toggle('active');
      overlay.classList.toggle('active');
      
      // Prevent body scroll when menu is open
      if (isOpening) {
        document.body.classList.add('menu-open');
        // Setup touch handlers after menu opens
        setTimeout(setupMobileNavTouch, 50);
      } else {
        document.body.classList.remove('menu-open');
      }
    }
    
    // Close mobile menu when navigating
    function closeMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const hamburger = document.getElementById('hamburger');
      const overlay = document.getElementById('mobileOverlay');
      
      if (sidebar && sidebar.classList.contains('mobile-open')) {
        sidebar.classList.remove('mobile-open');
        hamburger?.classList.remove('active');
        overlay?.classList.remove('active');
        document.body.classList.remove('menu-open');
      }
    }
    
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const main = document.querySelector('.main'); // Target the actual main element, not main-content
      sidebar.classList.toggle('collapsed');
      main.classList.toggle('sidebar-collapsed');
      localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
    }
    
    function toggleUserDropdown() {
      const wrapper = document.querySelector('.topbar-user-wrapper');
      wrapper.classList.toggle('open');
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      const wrapper = document.querySelector('.topbar-user-wrapper');
      if (wrapper && !wrapper.contains(e.target)) {
        wrapper.classList.remove('open');
      }
    });

    // Navigation items with translation keys
    // SVG Line Icons
    const icons = {
      dashboard: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>',
      loadboard: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
      trips: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13" rx="2"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>',
      orders: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M7 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/><path d="M17 17m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/><path d="M5 17h-2v-6l2-5h9l4 5h1a2 2 0 0 1 2 2v4h-2m-4 0h-6m-6 -6h15m-6 0v-5"/></svg>',
      drivers: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
      local_drivers: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="7" r="4"/><path d="M5 21v-2a7 7 0 0 1 14 0v2"/></svg>',
      trucks: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13" rx="2"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>',
      brokers: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 21h18"/><path d="M9 8h1"/><path d="M9 12h1"/><path d="M9 16h1"/><path d="M14 8h1"/><path d="M14 12h1"/><path d="M14 16h1"/><path d="M5 21V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16"/></svg>',
      dispatchers: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
      dispatcher_ranking: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2z"/></svg>',
      fuel: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 22V5a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v17"/><path d="M15 22H3"/><path d="M15 10h2a2 2 0 0 1 2 2v3a2 2 0 0 0 2 2v0a2 2 0 0 0 2-2V9.83a2 2 0 0 0-.59-1.42L18 4"/><path d="M7 10h4"/></svg>',
      ifta: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>',
      compliance: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',
      tickets: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 002 2 2 2 0 010 4 2 2 0 00-2 2v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 00-2-2 2 2 0 010-4 2 2 0 002-2V7a2 2 0 00-2-2H5z"/></svg>',
      financials: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>',
      payroll: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="6" y1="12" x2="18" y2="12"/><line x1="6" y1="8" x2="12" y2="8"/><line x1="6" y1="16" x2="10" y2="16"/></svg>',
      reports: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>',
      ai_advisor: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a4 4 0 0 1 4 4v1a4 4 0 0 1-8 0V6a4 4 0 0 1 4-4z"/><path d="M12 11v3"/><circle cx="12" cy="18" r="4"/><path d="M9 18h6"/></svg>',
      fixed_costs: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/></svg>',
      variable_costs: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
      financial: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
      profitability: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
      executive: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>',
      maintenance: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
      claims: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
      settings: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>',
      users: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',
      tasks: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',
      activity: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
      live_map: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="10" r="3"/><path d="M12 21.7C17.3 17 20 13 20 10a8 8 0 1 0-16 0c0 3 2.7 7 8 11.7z"/></svg>',
      chat: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
      applications: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="M9 14l2 2 4-4"/></svg>',
      billing: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M12 9v6"/><path d="M9 12h6"/><line x1="6" y1="8" x2="6" y2="8.01"/><line x1="6" y1="12" x2="6" y2="12.01"/><line x1="6" y1="16" x2="6" y2="16.01"/></svg>'
    };
    
    const navItems = [
      // MAIN section
      { id: 'dashboard', labelKey: 'dashboard', icon: 'dashboard', section: 'MAIN' },
      { id: 'live_map', labelKey: 'live_map', icon: 'live_map', section: 'MAIN' },
      { id: 'team_chat', labelKey: 'team_chat', icon: 'chat', section: 'MAIN' },
      { id: 'trips', labelKey: 'trips', icon: 'trips', section: 'MAIN' },
      { id: 'orders', labelKey: 'orders', icon: 'orders', section: 'MAIN' },
      { id: 'loadboard', labelKey: 'loadboard', icon: 'loadboard', section: 'MAIN' },
      { id: 'tasks', labelKey: 'tasks', icon: 'tasks', section: 'MAIN' },
      
      // FLEET section
      { id: 'drivers', labelKey: 'drivers', icon: 'drivers', section: 'FLEET' },
      { id: 'trucks', labelKey: 'trucks', icon: 'trucks', section: 'FLEET' },
      { id: 'local_drivers', labelKey: 'local_drivers', icon: 'local_drivers', section: 'FLEET' },
      
      // PARTNERS section
      { id: 'brokers', labelKey: 'brokers', icon: 'brokers', section: 'PARTNERS' },
      { id: 'dealers', labelKey: 'dealers', icon: 'brokers', admin: true, section: 'PARTNERS' },
      { id: 'dispatchers', labelKey: 'dispatchers', icon: 'dispatchers', section: 'PARTNERS' },
      { id: 'dispatcher_ranking', labelKey: 'dispatcher_ranking', icon: 'dispatcher_ranking', section: 'PARTNERS' },
      
      // FINANCIALS section - Restricted to ADMIN and MANAGER only
      { id: 'financials', labelKey: 'financials', icon: 'financials', restricted: true, section: 'FINANCIALS' },
      { id: 'billing', labelKey: 'billing', icon: 'billing', restricted: true, section: 'FINANCIALS' },
      { id: 'trip_profitability', labelKey: 'trip_profitability', icon: 'profitability', restricted: true, section: 'FINANCIALS' },
      { id: 'payroll', labelKey: 'payroll', icon: 'payroll', restricted: true, section: 'FINANCIALS' },
      { id: 'fuel', labelKey: 'fuel', icon: 'fuel', restricted: true, section: 'FINANCIALS' },
      { id: 'ifta', labelKey: 'ifta', icon: 'ifta', restricted: true, section: 'FINANCIALS' },
      { id: 'reports', labelKey: 'reports', icon: 'reports', restricted: true, section: 'FINANCIALS' },
      { id: 'ai_advisor', labelKey: 'ai_advisor', icon: 'ai_advisor', restricted: true, section: 'FINANCIALS' },
      
      // OPERATIONS
      { id: 'maintenance', labelKey: 'maintenance', icon: 'maintenance', section: 'OPERATIONS' },
      { id: 'compliance', labelKey: 'compliance', icon: 'compliance', section: 'OPERATIONS' },
      { id: 'applications', labelKey: 'applications', icon: 'applications', admin: true, section: 'OPERATIONS' },

      // Settings (separate)
      { id: 'settings', labelKey: 'settings', icon: 'settings', admin: true, section: 'SETTINGS' },
      { id: 'users', labelKey: 'users', icon: 'users', admin: true, section: 'SETTINGS' },
      { id: 'activity_log', labelKey: 'activity_log', icon: 'activity', admin: true, section: 'SETTINGS' }
    ];
    
    let expandedMenus = { financials: false };
    
    // Role-restricted pages (visible only to ADMIN and MANAGER)
    const restrictedPages = ['fuel', 'ifta', 'payroll', 'billing', 'financials', 'trip_profitability', 'reports', 'ai_advisor'];

    function getNavLabel(item) {
      // If Georgian and has custom Georgian label, use it
      
      return t(item.labelKey);
    }
    
    function renderNav() {
      // Dealers get a simplified navigation
      if (currentUser && currentUser.role === 'DEALER') {
        renderDealerNav();
        return;
      }

      const sections = {
        'MAIN': 'MAIN',
        'FLEET': 'FLEET',
        'PARTNERS': 'PARTNERS',
        'FINANCIALS': 'FINANCIALS',
        'OPERATIONS': 'OPERATIONS',
        'SETTINGS': ''
      };

      let html = '';
      const isAdminOrManager = currentUser.role === 'ADMIN' || currentUser.role === 'MANAGER';
      const filteredItems = navItems.filter(i => {
        // Hide admin-only items from non-admins
        if (i.admin && currentUser.role !== 'ADMIN') return false;
        // Hide restricted items from non-admin/manager users
        if (i.restricted && !isAdminOrManager) return false;
        return true;
      });
      
      // Group items by section
      const groupedItems = {};
      filteredItems.forEach(item => {
        const section = item.section || 'OTHER';
        if (!groupedItems[section]) groupedItems[section] = [];
        groupedItems[section].push(item);
      });
      
      // Render each section
      Object.keys(sections).forEach(sectionKey => {
        const items = groupedItems[sectionKey];
        if (!items || items.length === 0) return;
        
        const sectionTitle = sections[sectionKey];
        html += '<div class="nav-section">';
        if (sectionTitle) {
          html += '<div class="nav-section-title">' + sectionTitle + '</div>';
        }
        
        items.forEach(i => {
          const label = getNavLabel(i);
          const iconSvg = icons[i.icon] || i.icon;

          // Chat badge for unread messages
          const chatBadge = (i.id === 'team_chat' && unreadChatCount > 0)
            ? '<span class="nav-badge" id="navChatBadge">' + (unreadChatCount > 99 ? '99+' : unreadChatCount) + '</span>'
            : '';

          if (i.submenu) {
            const isExpanded = expandedMenus[i.id];
            const hasActiveSub = i.submenu.some(sub => sub.id === currentPage);
            html += '<button class="nav-item submenu-toggle ' + (hasActiveSub ? 'active' : '') + '" onclick="toggleMenu(\'' + i.id + '\')" data-tooltip="' + label + '" role="menuitem" aria-haspopup="true" aria-expanded="' + (isExpanded ? 'true' : 'false') + '"><span class="nav-item-content"><span class="icon" aria-hidden="true">' + iconSvg + '</span> <span class="nav-item-text">' + label + '</span></span><span class="nav-item-text nav-arrow" aria-hidden="true">' + (isExpanded ? '' : '') + '</span></button>';
            if (isExpanded || hasActiveSub) {
              i.submenu.forEach(sub => {
                const subLabel = t(sub.labelKey);
                const subIconSvg = icons[sub.icon] || sub.icon;
                html += '<button class="nav-item nav-subitem ' + (currentPage === sub.id ? 'active' : '') + '" onclick="navigate(\'' + sub.id + '\')" data-tooltip="' + subLabel + '" role="menuitem" aria-current="' + (currentPage === sub.id ? 'page' : 'false') + '"><span class="icon" aria-hidden="true">' + subIconSvg + '</span> <span class="nav-item-text">' + subLabel + '</span></button>';
              });
            }
          } else {
            html += '<button class="nav-item ' + (currentPage === i.id ? 'active' : '') + '" onclick="navigate(\'' + i.id + '\')" data-tooltip="' + label + '" role="menuitem" aria-current="' + (currentPage === i.id ? 'page' : 'false') + '"><span class="icon" aria-hidden="true">' + iconSvg + '</span> <span class="nav-item-text">' + label + '</span>' + chatBadge + '</button>';
          }
        });
        
        html += '</div>';
      });
      
      document.getElementById('nav').innerHTML = html;
      setupNavTooltips();
      setupMobileNavTouch();
    }
    
    // Setup mobile touch handling for nav items
    function setupMobileNavTouch() {
      if (window.innerWidth > 768) return;
      
      document.querySelectorAll('.sidebar .nav-item').forEach(item => {
        // Add touch handler with capture to ensure it fires
        item.ontouchend = function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          // Get the page from onclick attribute
          const onclick = this.getAttribute('onclick');
          if (onclick) {
            // Extract page name from navigate('pagename') or toggleMenu('menuname')
            const navigateMatch = onclick.match(/navigate\(['"]([^'"]+)['"]\)/);
            const toggleMatch = onclick.match(/toggleMenu\(['"]([^'"]+)['"]\)/);
            
            if (navigateMatch) {
              navigate(navigateMatch[1]);
            } else if (toggleMatch) {
              toggleMenu(toggleMatch[1]);
            }
          }
          return false;
        };
      });
    }
    
    function handleNavTouch(e) {
      // Deprecated - using ontouchend directly now
    }
    
    // Tooltip element
    let navTooltip = null;
    
    function setupNavTooltips() {
      // Create tooltip element if it doesn't exist
      if (!navTooltip) {
        navTooltip = document.createElement('div');
        navTooltip.className = 'nav-tooltip';
        document.body.appendChild(navTooltip);
      }
      
      // Add event listeners to nav items
      document.querySelectorAll('.sidebar .nav-item').forEach(item => {
        item.addEventListener('mouseenter', showNavTooltip);
        item.addEventListener('mouseleave', hideNavTooltip);
      });
    }
    
    function showNavTooltip(e) {
      const sidebar = document.getElementById('sidebar');
      if (!sidebar.classList.contains('collapsed')) return;
      
      const text = e.currentTarget.getAttribute('data-tooltip');
      if (!text) return;
      
      const rect = e.currentTarget.getBoundingClientRect();
      navTooltip.textContent = text;
      navTooltip.style.left = (rect.right + 12) + 'px';
      navTooltip.style.top = (rect.top + rect.height / 2) + 'px';
      navTooltip.style.transform = 'translateY(-50%)';
      navTooltip.classList.add('visible');
    }
    
    function hideNavTooltip() {
      if (navTooltip) {
        navTooltip.classList.remove('visible');
      }
    }
    
    function toggleMenu(menuId) {
      expandedMenus[menuId] = !expandedMenus[menuId];
      renderNav();
    }

    function navigate(page) {
      // Cleanup live map if navigating away
      if (currentPage === 'live_map' && page !== 'live_map') {
        cleanupLiveMap();
      }
      // Cleanup chat if navigating away
      if (currentPage === 'team_chat' && page !== 'team_chat') {
        cleanupChat();
      }
      // Check if page is restricted to admin/manager only
      if (restrictedPages.includes(page)) {
        const isAdminOrManager = currentUser.role === 'ADMIN' || currentUser.role === 'MANAGER';
        if (!isAdminOrManager) {
          showToast('Access denied. This section is only available to Admins and Managers.', 'error');
          return;
        }
      }
      currentPage = page;
      // Reset pagination to page 1 when navigating to a new page
      Object.keys(pagination).forEach(key => { pagination[key].page = 1; });
      // Save current page to localStorage for persistence across refresh
      localStorage.setItem('tms_current_page', page);
      
      // On mobile, add slight delay before closing menu so user sees the selection
      const isMobile = window.innerWidth <= 768;
      if (isMobile) {
        // Immediately render nav to show active state
        renderNav();
        // Small delay then close menu and render page
        setTimeout(() => {
          closeMobileMenu();
          renderPage();
        }, 150);
      } else {
        closeMobileMenu();
        renderNav(); 
        renderPage(); 
      }
    }
    
    function goToPage(page) {
      navigate(page);
    }

    // Generic Modal Helper Functions
    function showModal(modalId, title, bodyContent, footerContent, maxWidth = '600px') {
      // Remove existing modal with same id if any
      const existingModal = document.getElementById(modalId);
      if (existingModal) existingModal.remove();
      
      const m = document.createElement('div');
      m.id = modalId;
      m.className = 'modal-overlay';
      m.onclick = e => { if (e.target === m) closeModal(modalId); };
      m.innerHTML = `
        <div class="modal" style="max-width:${maxWidth}">
          <div class="modal-header">
            <h3>${title}</h3>
            <button class="modal-close" onclick="closeModal('${modalId}')"></button>
          </div>
          <div class="modal-body">${bodyContent}</div>
          <div class="modal-footer">${footerContent}</div>
        </div>
      `;
      document.body.appendChild(m);
    }
    
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) modal.remove();
    }

    // ============ ORDER DETAIL MODAL ============
    // Comprehensive order view with inspections, photos, financials

    let orderDetailPhotos = []; // For photo gallery navigation
    let currentPhotoIndex = 0;
    let previousPage = 'orders'; // Track previous page for back navigation

    async function openOrderDetailPage(orderId) {
      const order = appData.orders.find(o => o.id === orderId);
      if (!order) {
        showToast('Order not found', 'error');
        return;
      }

      // Track previous page for back navigation
      previousPage = currentPage;
      currentPage = 'order-detail';

      // Get main content container
      const m = document.getElementById('main-content');

      // Show loading state in main content area
      m.innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px"><div class="loading-spinner" style="width:40px;height:40px;border-width:4px"></div><p style="margin-top:16px;color:var(--text-muted)">Loading order details...</p></div>';

      // Fetch related data
      const trip = order.trip_id ? appData.trips.find(t => t.id === order.trip_id) : null;
      const driver = trip?.driver_id
        ? appData.drivers.find(d => d.id === trip.driver_id)
        : (order.driver_id ? appData.drivers.find(d => d.id === order.driver_id) : null);
      const truck = trip?.truck_id ? appData.trucks.find(tr => tr.id === trip.truck_id) : null;
      const broker = appData.brokers?.find(b => b.name === order.broker_name);

      // Fetch inspections for this order from Supabase
      let inspections = [];
      let photos = [];
      let damages = [];

      let videos = [];
      try {
        inspections = await dbFetch('vehicle_inspections', { filter: { order_id: 'eq.' + orderId } }) || [];
        if (inspections.length > 0) {
          const inspectionIds = inspections.map(i => i.id);
          photos = await dbFetch('inspection_photos', { filter: { inspection_id: 'in.(' + inspectionIds.join(',') + ')' } }) || [];
          damages = await dbFetch('inspection_damages', { filter: { inspection_id: 'in.(' + inspectionIds.join(',') + ')' } }) || [];
          videos = await dbFetch('inspection_videos', { filter: { inspection_id: 'in.(' + inspectionIds.join(',') + ')' } }) || [];
        }
      } catch (e) {
        console.log('Could not load inspections:', e);
      }

      const pickupInspection = inspections.find(i => i.inspection_type === 'pickup');
      const deliveryInspection = inspections.find(i => i.inspection_type === 'delivery');
      const pickupPhotos = photos.filter(p => p.inspection_id === pickupInspection?.id);
      const deliveryPhotos = photos.filter(p => p.inspection_id === deliveryInspection?.id);
      const pickupDamages = damages.filter(d => d.inspection_id === pickupInspection?.id);
      const deliveryDamages = damages.filter(d => d.inspection_id === deliveryInspection?.id);
      const pickupVideos = videos.filter(v => v.inspection_id === pickupInspection?.id);
      const deliveryVideos = videos.filter(v => v.inspection_id === deliveryInspection?.id);

      // Store photos for gallery
      orderDetailPhotos = [...pickupPhotos, ...deliveryPhotos];

      // Build the modal content
      const vehicleTitle = order.vehicle_year + ' ' + order.vehicle_make + ' ' + order.vehicle_model;
      const statusBadge = getDeliveryStatusBadge(order.delivery_status || 'pending');

      const bodyContent = `
        <div class="order-detail-layout">
          <!-- Left Column: Main Content -->
          <div class="order-detail-main">

            <!-- Order Info Card -->
            <div class="order-detail-card">
              <div class="order-detail-card-header">
                <span> Order Information</span>
              </div>
              <div class="order-detail-card-body">
                <div class="order-info-grid">
                  <div class="order-info-item">
                    <div class="order-info-label">Order Number</div>
                    <div class="order-info-value">${order.order_number}</div>
                  </div>
                  <div class="order-info-item">
                    <div class="order-info-label">VIN</div>
                    <div class="order-info-value mono">${order.vehicle_vin || 'Not recorded'}</div>
                  </div>
                  <div class="order-info-item">
                    <div class="order-info-label">Color</div>
                    <div class="order-info-value">${order.vehicle_color || 'Not recorded'}</div>
                  </div>
                  <div class="order-info-item">
                    <div class="order-info-label">Broker</div>
                    <div class="order-info-value">${order.broker_name || '-'}</div>
                  </div>
                  <div class="order-info-item">
                    <div class="order-info-label">Payment Type</div>
                    <div class="order-info-value"><span class="badge badge-blue">${order.payment_type || '-'}</span></div>
                  </div>
                  <div class="order-info-item">
                    <div class="order-info-label">Payment Status</div>
                    <div class="order-info-value"><span class="badge ${order.payment_status === 'paid' ? 'badge-green' : 'badge-orange'}">${order.payment_status || 'pending'}</span></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Route Card - Side by Side -->
            <div class="route-side-by-side">
              <!-- Pickup Column -->
              <div class="route-column pickup">
                <div class="route-column-header">
                  <span class="route-column-badge pickup">PICKUP</span>
                </div>
                <div class="route-column-body">
                  <div class="route-location">
                    <div class="route-location-name">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                      <span>${order.pickup_name || 'No pickup name'}</span>
                    </div>
                    <div class="route-address">${order.pickup_full_address || order.origin || 'Address not recorded'}</div>
                  </div>
                  <div class="route-dates">
                    <div class="route-date-row">
                      <span class="route-date-label">Scheduled:</span>
                      <span class="route-date-value">${order.pickup_date ? formatDate(order.pickup_date) : 'Not scheduled'}</span>
                    </div>
                    ${pickupInspection ? '<div class="route-date-row"><span class="route-date-label">Picked up:</span><span class="route-date-value success">' + formatDate(pickupInspection.completed_at || pickupInspection.started_at || pickupInspection.created_at) + '</span></div>' : ''}
                    ${order.pickup_eta ? '<div class="route-date-row"><span class="route-date-label" style="color:var(--info)">ETA:</span><span class="route-date-value">' + formatDate(order.pickup_eta) + '</span></div>' : ''}
                  </div>
                  <div class="route-contact">
                    <div class="route-contact-title">Contact</div>
                    <div class="route-contact-row">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                      <span>${order.pickup_contact_name || 'No contact name'}</span>
                    </div>
                    <div class="route-contact-row">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                      <span>${order.pickup_phone || 'No phone'}</span>
                    </div>
                  </div>
                  ${order.pickup_notes ? '<div class="route-notes"><div class="route-notes-title">Notes</div><div class="route-notes-text">' + order.pickup_notes + '</div></div>' : ''}
                </div>
              </div>

              <!-- Delivery Column -->
              <div class="route-column delivery">
                <div class="route-column-header">
                  <span class="route-column-badge delivery">DELIVERY</span>
                </div>
                <div class="route-column-body">
                  <div class="route-location">
                    <div class="route-location-name">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                      <span>${order.delivery_name || 'No delivery name'}</span>
                    </div>
                    <div class="route-address">${order.delivery_full_address || order.destination || 'Address not recorded'}</div>
                  </div>
                  <div class="route-dates">
                    <div class="route-date-row">
                      <span class="route-date-label">Scheduled:</span>
                      <span class="route-date-value">${order.dropoff_date ? formatDate(order.dropoff_date) : 'Not scheduled'}</span>
                    </div>
                    ${deliveryInspection ? '<div class="route-date-row"><span class="route-date-label">Delivered:</span><span class="route-date-value success">' + formatDate(deliveryInspection.completed_at || deliveryInspection.started_at || deliveryInspection.created_at) + '</span></div>' : ''}
                    ${order.delivery_eta ? '<div class="route-date-row"><span class="route-date-label" style="color:var(--info)">ETA:</span><span class="route-date-value">' + formatDate(order.delivery_eta) + '</span></div>' : ''}
                  </div>
                  <div class="route-contact">
                    <div class="route-contact-title">Contact</div>
                    <div class="route-contact-row">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                      <span>${order.delivery_contact_name || 'No contact name'}</span>
                    </div>
                    <div class="route-contact-row">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                      <span>${order.delivery_phone || 'No phone'}</span>
                    </div>
                  </div>
                  ${order.delivery_notes ? '<div class="route-notes"><div class="route-notes-title">Notes</div><div class="route-notes-text">' + order.delivery_notes + '</div></div>' : ''}
                </div>
              </div>
            </div>

            <!-- Vehicle Section -->
            <div class="order-detail-card vehicle-section">
              <div class="order-detail-card-header">
                <span> 1 Vehicle</span>
                <span class="vehicle-total">${formatMoney(order.revenue || 0)}</span>
              </div>
              <div class="order-detail-card-body" style="padding:0;">
                <table class="vehicle-table">
                  <thead>
                    <tr>
                      <th>Vehicle</th>
                      <th>VIN</th>
                      <th>Color</th>
                      <th style="text-align:right;">Price</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td><strong>${order.vehicle_year || ''} ${order.vehicle_make || ''} ${order.vehicle_model || ''}</strong></td>
                      <td style="font-family:var(--font-mono);font-size:var(--text-xs);">${order.vehicle_vin || 'N/A'}</td>
                      <td>${order.vehicle_color || '-'}</td>
                      <td style="text-align:right;font-weight:600;">${formatMoney(order.revenue || 0)}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Inspections Section -->
            <div class="inspections-grid">
              ${renderInspectionCard('pickup', pickupInspection, pickupPhotos, pickupDamages, pickupVideos)}
              ${renderInspectionCard('delivery', deliveryInspection, deliveryPhotos, deliveryDamages, deliveryVideos)}
            </div>

          </div>

          <!-- Right Column: Sidebar -->
          <div class="order-detail-sidebar">

            <!-- Payment Card (First - Prominent) -->
            <div class="order-detail-card payment-card">
              <div class="order-detail-card-header">
                <span> Payment</span>
                <span class="payment-status-badge ${order.payment_status === 'paid' ? 'paid' : ''}">${order.payment_status === 'paid' ? 'Paid' : 'Unpaid'}</span>
              </div>
              <div class="order-detail-card-body">
                <div class="payment-amount">${formatMoney(order.revenue || 0)}</div>
                <div class="payment-details">
                  <div class="payment-row">
                    <span>Method</span>
                    <span>${order.payment_type || 'Not specified'}</span>
                  </div>
                  <div class="payment-row">
                    <span>Terms</span>
                    <span>${order.payment_type === 'COD' ? 'Cash on Delivery' : order.payment_type === 'COP' ? 'Check on Pickup' : order.payment_type || '-'}</span>
                  </div>
                  <div class="payment-row">
                    <span>Broker Fee</span>
                    <span class="negative">-${formatMoney(order.broker_fee || 0)}</span>
                  </div>
                  <div class="payment-row">
                    <span>Local Fee</span>
                    <span class="negative">-${formatMoney(order.local_fee || 0)}</span>
                  </div>
                  <div class="payment-row net">
                    <span>Net Revenue</span>
                    <span>${formatMoney((order.revenue || 0) - (order.broker_fee || 0) - (order.local_fee || 0))}</span>
                  </div>
                </div>
                ${order.payment_status !== 'paid' ? '<button class="btn btn-primary btn-sm" style="width:100%;margin-top:var(--spacing-3)" onclick="markOrderPaid(' + order.id + ')">Mark as Paid</button>' : ''}
              </div>
            </div>

            <!-- Customer Information Card -->
            <div class="order-detail-card">
              <div class="order-detail-card-header">
                <span> Customer Information</span>
              </div>
              <div class="order-detail-card-body">
                <div class="customer-info">
                  <div class="customer-name">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    ${broker?.name || order.broker_name || 'No broker assigned'}
                  </div>
                  ${broker?.email ? '<div class="customer-contact"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>' + broker.email + '</div>' : '<div class="customer-contact muted">No billing email</div>'}
                  ${broker?.phone ? '<div class="customer-contact"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>' + broker.phone + '</div>' : ''}
                </div>
              </div>
            </div>

            <!-- Assignment Card -->
            <div class="order-detail-card">
              <div class="order-detail-card-header">
                <span> Assignment</span>
              </div>
              <div class="order-detail-card-body">
                <div class="sidebar-info-list">
                  <div class="sidebar-info-row">
                    <span class="sidebar-info-label">Trip</span>
                    <span class="sidebar-info-value">${trip ? '<span class="badge badge-purple">' + trip.trip_number + '</span>' : '<span style="color:var(--text-muted)">Unassigned</span>'}</span>
                  </div>
                  <div class="sidebar-info-row">
                    <span class="sidebar-info-label">Driver</span>
                    <span class="sidebar-info-value">${driver ? driver.first_name + ' ' + driver.last_name : '-'}</span>
                  </div>
                  <div class="sidebar-info-row">
                    <span class="sidebar-info-label">Truck</span>
                    <span class="sidebar-info-value">${truck ? truck.truck_number : '-'}</span>
                  </div>
                  <div class="sidebar-info-row">
                    <span class="sidebar-info-label">Pickup Seq.</span>
                    <span class="sidebar-info-value">${order.pickup_sequence || '-'}</span>
                  </div>
                  <div class="sidebar-info-row">
                    <span class="sidebar-info-label">Delivery Seq.</span>
                    <span class="sidebar-info-value">${order.delivery_sequence || '-'}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Signatures Card -->
            ${renderSignaturesCard(pickupInspection, deliveryInspection)}

            <!-- Internal Notes Card (Editable) -->
            <div class="order-detail-card">
              <div class="order-detail-card-header">
                <span> Internal Notes</span>
                <button class="btn-icon-sm" onclick="editOrderNotes(${order.id})" title="Edit notes">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                </button>
              </div>
              <div class="order-detail-card-body">
                <div id="order-notes-content" class="internal-notes-content">
                  ${order.dispatcher_notes || order.notes ? '<p>' + (order.dispatcher_notes || order.notes) + '</p>' : '<p class="muted">No internal notes</p>'}
                </div>
              </div>
            </div>

            <!-- Activity Feed (Moved to Sidebar) -->
            <div class="order-detail-card activity-card">
              <div class="order-detail-card-header">
                <span> Activity</span>
              </div>
              <div class="order-detail-card-body">
                ${renderActivityFeedSidebar(order, trip, driver, pickupInspection, deliveryInspection)}
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="order-detail-card">
              <div class="order-detail-card-header">
                <span> Quick Actions</span>
              </div>
              <div class="order-detail-card-body">
                <div class="quick-actions-grid" style="grid-template-columns: repeat(3, 1fr);">
                  <button class="btn btn-secondary" onclick="openOrderModal(${order.id})"> Edit Order</button>
                  <button class="btn btn-secondary" onclick="generateBOLPDF(${order.id})"> View BOL</button>
                  <button class="btn btn-secondary" onclick="generateInvoicePDF(${order.id})"> View Invoice</button>
                  <button class="btn btn-secondary" onclick="openOrderAttachmentsModal(${order.id})"> Attachments</button>
                  <button class="btn btn-secondary" onclick="generateRouteSheetPDF(${order.id})"> Route Sheet</button>
                  <button class="btn btn-secondary" onclick="sendTrackingLinkToBroker(${order.id})"> Send Tracking</button>
                </div>
              </div>
            </div>

          </div>
        </div>
      `;

      // Get page label for back button
      const pageLabels = {
        'orders': 'Orders',
        'trips': 'Trips',
        'loadboard': 'Loadboard',
        'future_cars': 'Loadboard',
        'dashboard': 'Dashboard'
      };
      const backLabel = pageLabels[previousPage] || 'Back';

      // Render full page content
      m.innerHTML = `
        <div class="order-detail-page">
          <!-- Page Header - SuperDispatch Style -->
          <div class="order-detail-page-header">
            <div class="header-left">
              <button class="btn btn-secondary btn-back" onclick="navigate('${previousPage}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
              </button>
              <div class="header-title-group">
                <div class="header-title-row">
                  <h2>${order.order_number}</h2>
                  <div class="header-badges">
                    ${statusBadge}
                    ${trip ? '<span class="badge badge-purple">' + trip.trip_number + '</span>' : '<span class="badge badge-gray">Unassigned</span>'}
                  </div>
                </div>
                <div class="header-subtitle">${vehicleTitle}</div>
              </div>
            </div>
            <div class="header-right">
              <div class="assigned-to">
                <span class="assigned-label">Assigned to:</span>
                <span class="assigned-name">${driver ? driver.first_name + ' ' + driver.last_name : 'Unassigned'}</span>
              </div>
              <div class="header-actions">
                <button class="btn btn-primary" onclick="sendInvoiceToBroker(${order.id})">Send Invoice</button>
                <button class="btn btn-secondary" onclick="openOrderModal(${order.id})">Edit Load</button>
              </div>
            </div>
          </div>

          <!-- Main Content -->
          ${bodyContent}
        </div>
      `;
    }

    function getDeliveryStatusBadge(status) {
      const statusMap = {
        'pending': { bg: 'rgba(245,158,11,0.2)', color: 'var(--amber)', label: 'Pending' },
        'picked_up': { bg: 'rgba(59,130,246,0.2)', color: 'var(--blue)', label: 'Picked Up' },
        'delivered': { bg: 'rgba(34,197,94,0.2)', color: 'var(--green)', label: 'Delivered' }
      };
      const s = statusMap[status] || statusMap['pending'];
      return `<span style="background:${s.bg};color:${s.color};padding:6px 14px;border-radius:20px;font-size:13px;font-weight:600">${s.label}</span>`;
    }

    function renderInspectionCard(type, inspection, photos, damages, videos = []) {
      const isPickup = type === 'pickup';
      const icon = isPickup ? '' : '';
      const label = isPickup ? 'Pickup Inspection' : 'Delivery Inspection';
      const headerBg = isPickup ? 'var(--success)' : 'var(--info)';

      if (!inspection) {
        return `
          <div class="order-detail-card inspection-card">
            <div class="order-detail-card-header" style="background:${headerBg};color:white">
              <span>${icon} ${label}</span>
              <span class="badge" style="background:rgba(255,255,255,0.2);color:white">Not Started</span>
            </div>
            <div class="order-detail-card-body" style="text-align:center;padding:40px;color:var(--text-muted)">
              <p>No inspection recorded yet</p>
            </div>
          </div>
        `;
      }

      // Video section
      let videoSection = '';
      if (videos && videos.length > 0) {
        videoSection = `
          <div class="inspection-videos" style="margin-bottom:12px">
            <div style="font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:8px">Walkthrough Videos (${videos.length})</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              ${videos.map((v, idx) => `
                <div class="video-thumb" onclick="openVideoPlayer('${v.video_url}')" style="position:relative;width:120px;height:80px;background:var(--bg-elevated);border-radius:8px;cursor:pointer;overflow:hidden;display:flex;align-items:center;justify-content:center">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="white"><path d="M8 5v14l11-7z"/></svg>
                  ${v.duration_seconds ? `<span style="position:absolute;bottom:4px;right:4px;background:rgba(0,0,0,0.7);color:white;font-size:10px;padding:2px 6px;border-radius:4px">${Math.floor(v.duration_seconds/60)}:${String(v.duration_seconds%60).padStart(2,'0')}</span>` : ''}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      // Enhanced photo section with featured photo and 4-column grid
      let photoSection = '';
      if (photos.length > 0) {
        const featuredPhoto = photos[0];
        const gridPhotos = photos.slice(1, 9); // Show 8 more in grid
        const remainingCount = photos.length > 9 ? photos.length - 9 : 0;

        photoSection = `
          <div class="inspection-photos-enhanced">
            <div class="photos-header">
              <span class="photos-title">Photos${videos && videos.length > 0 ? '' : ' & Video'}</span>
              <button class="btn-download-all" onclick="downloadAllPhotos('${type}', ${inspection.id})">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Download All
              </button>
            </div>
            ${videoSection}
            <div class="photos-layout">
              <div class="featured-photo" onclick="openPhotoGallery(${orderDetailPhotos.indexOf(featuredPhoto)})">
                <img src="${featuredPhoto.photo_url}" alt="${featuredPhoto.photo_type || 'Featured'}" loading="lazy">
                <span class="photo-type-badge">${featuredPhoto.photo_type || ''}</span>
              </div>
              <div class="photos-grid-4col">
                ${gridPhotos.map((p, idx) => `
                  <div class="photo-thumb-small" onclick="openPhotoGallery(${orderDetailPhotos.indexOf(p)})">
                    <img src="${p.photo_url}" alt="${p.photo_type || 'Photo'}" loading="lazy">
                    ${idx === gridPhotos.length - 1 && remainingCount > 0 ? `<div class="more-photos-overlay">+${remainingCount}</div>` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
            <div class="inspection-additional">
              <div class="additional-title">Additional Inspection</div>
              <div class="additional-info">
                <div class="additional-row"><span>Odometer:</span><strong>${inspection.odometer ? inspection.odometer.toLocaleString() + ' mi' : 'N/A'}</strong></div>
              </div>
            </div>
          </div>
        `;
      } else {
        photoSection = '<p style="color:var(--text-muted);font-size:13px;padding:20px 0;text-align:center">No photos captured</p>';
      }

      const damageList = damages.length > 0 ? `
        <div class="damage-section">
          <div class="damage-header">
            <span class="damage-count">${damages.length} Damage${damages.length > 1 ? 's' : ''}</span>
          </div>
          <div class="damage-list">
            ${damages.map(d => `
              <span class="damage-badge">${d.damage_type}: ${d.view || 'Unknown'}</span>
            `).join('')}
          </div>
        </div>
      ` : '';

      const conditions = [];
      if (inspection.condition_dark) conditions.push(' Dark');
      if (inspection.condition_snow) conditions.push(' Snow');
      if (inspection.condition_rain) conditions.push(' Rain');
      if (inspection.condition_dirty_vehicle) conditions.push(' Dirty');

      return `
        <div class="order-detail-card inspection-card enhanced">
          <div class="inspection-card-header" style="background:${headerBg}">
            <div class="inspection-header-left">
              <span class="inspection-icon">${icon}</span>
              <span class="inspection-label">${label}</span>
            </div>
            <div class="inspection-header-right">
              <span class="badge-photos">${photos.length} Photos</span>
              ${damages.length > 0 ? '<span class="badge-damages">' + damages.length + ' Damages</span>' : ''}
            </div>
          </div>
          <div class="order-detail-card-body">
            ${photoSection}
            ${damageList}
            ${conditions.length > 0 ? `
              <div class="conditions-row">
                <span class="conditions-label">Conditions:</span>
                ${conditions.map(c => '<span class="condition-badge">' + c + '</span>').join('')}
              </div>
            ` : ''}
            ${inspection.customer_name ? `
              <div class="inspection-signer">
                <span> Signed by: <strong>${inspection.customer_name}</strong></span>
                ${inspection.customer_signed_at ? '<span class="signer-date">' + formatDate(inspection.customer_signed_at) + '</span>' : ''}
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    // Download all photos for an inspection
    async function downloadAllPhotos(type, inspectionId) {
      showToast('Preparing download...', 'info');
      const photos = orderDetailPhotos.filter(p => p.inspection_id === inspectionId);
      if (photos.length === 0) {
        showToast('No photos to download', 'warning');
        return;
      }
      // Download each photo
      for (const photo of photos) {
        const link = document.createElement('a');
        link.href = photo.photo_url;
        link.download = type + '_' + (photo.photo_type || 'photo') + '_' + photo.id + '.jpg';
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        await new Promise(r => setTimeout(r, 300)); // Small delay between downloads
      }
      showToast('Downloaded ' + photos.length + ' photos', 'success');
    }

    function renderActivityTimeline(order, trip, pickupInsp, deliveryInsp) {
      const events = [];

      // Order created
      if (order.created_at) {
        events.push({ date: order.created_at, icon: '', label: 'Order Created', status: 'completed' });
      }

      // Assigned to trip
      if (trip) {
        events.push({ date: trip.created_at || order.created_at, icon: '', label: 'Assigned to Trip ' + trip.trip_number, status: 'completed' });
      }

      // Pickup inspection
      if (pickupInsp) {
        events.push({ date: pickupInsp.created_at, icon: '', label: 'Pickup Inspection Completed', status: 'completed' });
      } else if (order.delivery_status === 'pending') {
        events.push({ date: null, icon: '', label: 'Pickup Inspection', status: 'pending' });
      }

      // In transit
      if (order.delivery_status === 'picked_up' || order.delivery_status === 'delivered') {
        events.push({ date: pickupInsp?.created_at, icon: '', label: 'In Transit', status: order.delivery_status === 'picked_up' ? 'current' : 'completed' });
      }

      // Delivery inspection
      if (deliveryInsp) {
        events.push({ date: deliveryInsp.created_at, icon: '', label: 'Delivery Inspection Completed', status: 'completed' });
      } else if (order.delivery_status !== 'delivered') {
        events.push({ date: null, icon: '', label: 'Delivery Inspection', status: 'pending' });
      }

      // Delivered
      if (order.delivery_status === 'delivered') {
        events.push({ date: deliveryInsp?.created_at || order.updated_at, icon: '', label: 'Delivered', status: 'completed' });
      }

      return `
        <div class="activity-timeline">
          ${events.map(e => `
            <div class="timeline-item ${e.status}">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <span class="timeline-icon">${e.icon}</span>
                <span class="timeline-label">${e.label}</span>
                ${e.date ? '<span class="timeline-date">' + formatDate(e.date) + '</span>' : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Sidebar Activity Feed - More compact format with user attribution
    function renderActivityFeedSidebar(order, trip, driver, pickupInsp, deliveryInsp) {
      const events = [];
      const driverName = driver ? driver.first_name + ' ' + driver.last_name : null;

      // Order created
      if (order.created_at) {
        events.push({
          date: order.created_at,
          text: 'Order ' + order.order_number + ' was created',
          user: null
        });
      }

      // Assigned to trip
      if (trip) {
        events.push({
          date: trip.created_at || order.created_at,
          text: 'Assigned to ' + (driverName || 'driver'),
          user: 'Dispatcher'
        });
      }

      // Pickup inspection
      if (pickupInsp) {
        events.push({
          date: pickupInsp.created_at,
          text: 'Pickup inspection completed',
          user: driverName
        });
        if (pickupInsp.customer_name) {
          events.push({
            date: pickupInsp.customer_signed_at || pickupInsp.created_at,
            text: 'Signed by ' + pickupInsp.customer_name,
            user: null
          });
        }
      }

      // Delivery inspection
      if (deliveryInsp) {
        events.push({
          date: deliveryInsp.created_at,
          text: 'Delivery inspection completed',
          user: driverName
        });
        if (deliveryInsp.customer_name) {
          events.push({
            date: deliveryInsp.customer_signed_at || deliveryInsp.created_at,
            text: 'Signed by ' + deliveryInsp.customer_name,
            user: null
          });
        }
      }

      // Delivered
      if (order.delivery_status === 'delivered') {
        events.push({
          date: deliveryInsp?.created_at || order.updated_at,
          text: 'Order marked as delivered',
          user: driverName
        });
      }

      // Sort by date descending (most recent first)
      events.sort((a, b) => new Date(b.date) - new Date(a.date));

      if (events.length === 0) {
        return '<p class="muted" style="font-size:13px;text-align:center;padding:12px 0">No activity yet</p>';
      }

      return `
        <div class="activity-feed-sidebar">
          ${events.map(e => `
            <div class="activity-feed-item">
              <div class="activity-feed-text">${e.text}</div>
              <div class="activity-feed-meta">
                ${e.user ? '<span class="activity-feed-user">' + e.user + '</span>' : ''}
                <span class="activity-feed-date">${formatDateTime(e.date)}</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // Format date with time
    function formatDateTime(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }

    // Edit order notes inline
    async function editOrderNotes(orderId) {
      const order = appData.orders.find(o => o.id === orderId);
      if (!order) return;

      const currentNotes = order.dispatcher_notes || order.notes || '';
      const newNotes = prompt('Edit internal notes:', currentNotes);

      if (newNotes !== null && newNotes !== currentNotes) {
        try {
          await dbUpdate('orders', orderId, { dispatcher_notes: newNotes });
          order.dispatcher_notes = newNotes;
          const notesContent = document.getElementById('order-notes-content');
          if (notesContent) {
            notesContent.innerHTML = newNotes ? '<p>' + newNotes + '</p>' : '<p class="muted">No internal notes</p>';
          }
          showToast('Notes updated', 'success');
        } catch (e) {
          showToast('Failed to update notes', 'error');
        }
      }
    }

    function renderSignaturesCard(pickupInsp, deliveryInsp) {
      // Check for signatures - stored as base64 in customer_signature/driver_signature fields
      const hasSignatures = pickupInsp?.customer_signature || pickupInsp?.driver_signature ||
                           deliveryInsp?.customer_signature || deliveryInsp?.driver_signature;

      if (!hasSignatures) return '';

      return `
        <div class="order-detail-card">
          <div class="order-detail-card-header">
            <span> Signatures</span>
          </div>
          <div class="order-detail-card-body">
            <div class="signatures-grid">
              ${pickupInsp?.customer_signature ? `
                <div class="signature-item">
                  <div class="signature-label">Pickup - Customer</div>
                  <img src="${pickupInsp.customer_signature}" alt="Customer signature" class="signature-img">
                  <div class="signature-name">${pickupInsp.customer_name || ''}</div>
                  ${pickupInsp.customer_signed_at ? '<div class="signature-time">' + formatDate(pickupInsp.customer_signed_at) + '</div>' : ''}
                </div>
              ` : ''}
              ${pickupInsp?.driver_signature ? `
                <div class="signature-item">
                  <div class="signature-label">Pickup - Driver</div>
                  <img src="${pickupInsp.driver_signature}" alt="Driver signature" class="signature-img">
                  ${pickupInsp.driver_signed_at ? '<div class="signature-time">' + formatDate(pickupInsp.driver_signed_at) + '</div>' : ''}
                </div>
              ` : ''}
              ${deliveryInsp?.customer_signature ? `
                <div class="signature-item">
                  <div class="signature-label">Delivery - Customer</div>
                  <img src="${deliveryInsp.customer_signature}" alt="Customer signature" class="signature-img">
                  <div class="signature-name">${deliveryInsp.customer_name || ''}</div>
                  ${deliveryInsp.customer_signed_at ? '<div class="signature-time">' + formatDate(deliveryInsp.customer_signed_at) + '</div>' : ''}
                </div>
              ` : ''}
              ${deliveryInsp?.driver_signature ? `
                <div class="signature-item">
                  <div class="signature-label">Delivery - Driver</div>
                  <img src="${deliveryInsp.driver_signature}" alt="Driver signature" class="signature-img">
                  ${deliveryInsp.driver_signed_at ? '<div class="signature-time">' + formatDate(deliveryInsp.driver_signed_at) + '</div>' : ''}
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    function openPhotoGallery(index) {
      if (orderDetailPhotos.length === 0) return;
      currentPhotoIndex = index >= 0 ? index : 0;
      renderPhotoGalleryModal();
    }

    function openVideoPlayer(videoUrl) {
      const existingVideo = document.getElementById('video-player-modal');
      if (existingVideo) existingVideo.remove();

      const m = document.createElement('div');
      m.id = 'video-player-modal';
      m.className = 'modal-overlay';
      m.style.background = 'rgba(0,0,0,0.9)';
      m.onclick = e => { if (e.target === m) closeModal('video-player-modal'); };
      m.innerHTML = `
        <div style="position:relative;max-width:90vw;max-height:90vh">
          <video src="${videoUrl}" controls autoplay style="max-width:100%;max-height:85vh;border-radius:8px"></video>
          <button onclick="closeModal('video-player-modal')" style="position:absolute;top:-15px;right:-15px;background:var(--bg-card);border:none;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:20px;box-shadow:0 2px 8px rgba(0,0,0,0.3)"></button>
        </div>
      `;
      document.body.appendChild(m);

      // ESC key to close
      const keyHandler = (e) => {
        if (e.key === 'Escape') {
          closeModal('video-player-modal');
          document.removeEventListener('keydown', keyHandler);
        }
      };
      document.addEventListener('keydown', keyHandler);
    }

    function renderPhotoGalleryModal() {
      const photo = orderDetailPhotos[currentPhotoIndex];
      if (!photo) return;

      const existingGallery = document.getElementById('photo-gallery-modal');
      if (existingGallery) existingGallery.remove();

      const m = document.createElement('div');
      m.id = 'photo-gallery-modal';
      m.className = 'modal-overlay';
      m.style.background = 'rgba(0,0,0,0.9)';
      m.onclick = e => { if (e.target === m) closeModal('photo-gallery-modal'); };
      m.innerHTML = `
        <div style="position:relative;max-width:90vw;max-height:90vh">
          <img src="${photo.photo_url}" alt="${photo.photo_type || 'Photo'}" style="max-width:100%;max-height:85vh;border-radius:8px">
          <div style="position:absolute;bottom:-40px;left:50%;transform:translateX(-50%);color:white;text-align:center">
            <span style="background:rgba(0,0,0,0.6);padding:6px 16px;border-radius:20px">${photo.photo_type || 'Photo'} (${currentPhotoIndex + 1}/${orderDetailPhotos.length})</span>
          </div>
          ${currentPhotoIndex > 0 ? `
            <button onclick="navigatePhoto(-1)" style="position:absolute;left:-60px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.2);border:none;color:white;width:50px;height:50px;border-radius:50%;cursor:pointer;font-size:24px"></button>
          ` : ''}
          ${currentPhotoIndex < orderDetailPhotos.length - 1 ? `
            <button onclick="navigatePhoto(1)" style="position:absolute;right:-60px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.2);border:none;color:white;width:50px;height:50px;border-radius:50%;cursor:pointer;font-size:24px"></button>
          ` : ''}
          <button onclick="closeModal('photo-gallery-modal')" style="position:absolute;top:-15px;right:-15px;background:var(--bg-card);border:none;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:20px;box-shadow:0 2px 8px rgba(0,0,0,0.3)"></button>
        </div>
      `;
      document.body.appendChild(m);

      // Keyboard navigation
      const keyHandler = (e) => {
        if (e.key === 'ArrowLeft') navigatePhoto(-1);
        else if (e.key === 'ArrowRight') navigatePhoto(1);
        else if (e.key === 'Escape') {
          closeModal('photo-gallery-modal');
          document.removeEventListener('keydown', keyHandler);
        }
      };
      document.addEventListener('keydown', keyHandler);
    }

    function navigatePhoto(direction) {
      currentPhotoIndex = Math.max(0, Math.min(orderDetailPhotos.length - 1, currentPhotoIndex + direction));
      renderPhotoGalleryModal();
    }

    async function markOrderPaid(orderId) {
      const order = appData.orders.find(o => o.id === orderId);
      if (!order) return;

      const newStatus = order.payment_status === 'paid' ? 'pending' : 'paid';
      try {
        await dbUpdate('orders', orderId, { payment_status: newStatus });
        showToast(newStatus === 'paid' ? 'Order marked as paid' : 'Order marked as unpaid');
        await loadAllData(true);
        openOrderDetailPage(orderId);
      } catch (e) {
        showToast('Failed to update payment status', 'error');
      }
    }

    function renderPage() {
      // Clear detail view flag when rendering a page (navigating away from detail)
      currentDetailView = null;

      const m = document.getElementById('main-content');

      // Remove FAB from previous page
      removeFloatingActionButton();

      // Handle dealer portal pages - dealers get their own restricted views
      if (currentUser && currentUser.role === 'DEALER') {
        if (currentPage === 'dealer_dashboard' || currentPage === 'dashboard') {
          renderDealerDashboard(m);
        } else if (currentPage === 'dealer_submit') {
          renderDealerSubmitVehicle(m);
        } else if (currentPage === 'dealer_orders') {
          renderDealerOrders(m);
        } else if (currentPage === 'dealer_spending') {
          renderDealerSpending(m);
        } else {
          // Default to dealer dashboard for any other page
          renderDealerDashboard(m);
        }
        return;
      }

      // Handle mini chat visibility
      if (currentPage === 'team_chat') {
        document.body.classList.add('on-team-chat');
        closeMiniChat();
        // Mark all messages as seen when entering team chat
        if (chatMessages.length > 0) {
          lastSeenChatId = Math.max(lastSeenChatId, ...chatMessages.map(m => m.id));
          localStorage.setItem('lastSeenChatId', lastSeenChatId.toString());
          unreadChatCount = 0;
          updateChatBadges();
        }
      } else {
        document.body.classList.remove('on-team-chat');
        initMiniChat();
      }

      if (currentPage === 'dashboard') renderDashboard(m);
      else if (currentPage === 'loadboard') renderLoadBoard(m);
      else if (currentPage === 'trips') renderTrips(m);
      else if (currentPage === 'orders') renderOrders(m);
      else if (currentPage === 'drivers') renderDrivers(m);
      else if (currentPage === 'local_drivers') renderLocalDrivers(m);
      else if (currentPage === 'trucks') renderTrucks(m);
      else if (currentPage === 'brokers') renderBrokers(m);
      else if (currentPage === 'dispatchers') renderDispatchers(m);
      else if (currentPage === 'dispatcher_ranking') renderDispatcherRanking(m);
      else if (currentPage === 'fuel') renderFuelTracking(m);
      else if (currentPage === 'ifta') renderIFTA(m);
      else if (currentPage === 'compliance') renderCompliance(m);
      else if (currentPage === 'driver_compliance') { complianceMainTab = 'driver_compliance'; renderCompliance(m); }
      else if (currentPage === 'claims') { dcTab = 'claims'; renderDriverCompliance(m); }
      else if (currentPage === 'payroll') renderPayroll(m);
      else if (currentPage === 'billing') renderBillingPage(m);
      else if (currentPage === 'financials') renderConsolidatedFinancials(m);
      else if (currentPage === 'reports') renderReports(m);
      else if (currentPage === 'ai_advisor') renderAIAdvisor(m);
      // Legacy routes redirect to consolidated
      else if (currentPage === 'fixed_costs') { finTab = 'costs'; renderConsolidatedFinancials(m); }
      else if (currentPage === 'variable_costs') { finTab = 'costs'; renderConsolidatedFinancials(m); }
      else if (currentPage === 'financial') { finTab = 'overview'; renderConsolidatedFinancials(m); }
      else if (currentPage === 'profitability') { finTab = 'trips'; renderConsolidatedFinancials(m); }
      else if (currentPage === 'executive_dashboard') { finTab = 'overview'; renderConsolidatedFinancials(m); }
      else if (currentPage === 'trip_profitability') renderTripProfitability(m);
      else if (currentPage === 'maintenance') renderMaintenance(m);
      else if (currentPage === 'tasks') renderTasks(m);
      else if (currentPage === 'settings') renderSettings(m);
      else if (currentPage === 'users') renderUsers(m);
      else if (currentPage === 'activity_log') renderActivityLog(m);
      else if (currentPage === 'live_map') renderLiveMap(m);
      else if (currentPage === 'team_chat') renderTeamChat(m);
      else if (currentPage === 'applications') renderApplications(m);
      else if (currentPage === 'tracking') renderTrackingPortal(m);
      else if (currentPage === 'dealers') renderDealersAdmin(m);
      
      // Add FAB for pages that support adding new items (mobile only)
      if (window.innerWidth <= 768) {
        const fabConfig = {
          'trips': { action: () => openTripModal(), icon: '' },
          'orders': { action: () => openOrderModal(), icon: '' },
          'drivers': { action: () => openDriverModal(), icon: '' },
          'trucks': { action: () => openTruckModal(), icon: '' },
          'tasks': { action: () => openTaskModal(), icon: '' },
          'maintenance': { action: () => openMaintenanceModal(), icon: '' },
          'claims': { action: () => openClaimModal(), icon: '' },
          'team_chat': null // No FAB for chat
        };
        
        if (fabConfig[currentPage]) {
          addFloatingActionButton(currentPage, fabConfig[currentPage].action, fabConfig[currentPage].icon);
        }
      }
    }

    // Dashboard period filter - defaults to current year
    let dashboardPeriod = 'year';  // 'all', 'year', 'month', 'q1', 'q2', 'q3', 'q4'
    let dashboardYear = new Date().getFullYear();
    let dashboardMonth = new Date().getMonth() + 1;  // 1-12

    function changeDashboardPeriod(period) {
      dashboardPeriod = period;
      renderDashboard(document.getElementById('main-content'));
    }

    function changeDashboardYear(year) {
      dashboardYear = parseInt(year);
      renderDashboard(document.getElementById('main-content'));
    }

    function changeDashboardMonth(month) {
      dashboardMonth = parseInt(month);
      renderDashboard(document.getElementById('main-content'));
    }

    function getTripYear(trip) {
      const dateStr = trip.trip_date || trip.period_start_date || trip.created_at;
      if (!dateStr) return null;
      const date = new Date(dateStr);
      return date.getFullYear();
    }

    function getTripQuarter(trip) {
      const dateStr = trip.trip_date || trip.period_start_date || trip.created_at;
      if (!dateStr) return null;
      const month = new Date(dateStr).getMonth();
      if (month >= 0 && month <= 2) return 1;
      if (month >= 3 && month <= 5) return 2;
      if (month >= 6 && month <= 8) return 3;
      return 4;
    }

    function getTripMonth(trip) {
      const dateStr = trip.trip_date || trip.period_start_date || trip.created_at;
      if (!dateStr) return null;
      return new Date(dateStr).getMonth() + 1;  // 1-12
    }

    function filterTripsByPeriod(trips) {
      return trips.filter(t => {
        if (dashboardPeriod === 'all') return true;
        const tripYear = getTripYear(t);
        if (tripYear !== dashboardYear) return false;
        if (dashboardPeriod === 'year') return true;
        if (dashboardPeriod === 'month') return getTripMonth(t) === dashboardMonth;
        const quarter = getTripQuarter(t);
        if (dashboardPeriod === 'q1') return quarter === 1;
        if (dashboardPeriod === 'q2') return quarter === 2;
        if (dashboardPeriod === 'q3') return quarter === 3;
        if (dashboardPeriod === 'q4') return quarter === 4;
        return true;
      });
    }

    const dashboardMonthNames = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    function getDashboardPeriodLabel() {
      if (dashboardPeriod === 'all') return 'All Time';
      if (dashboardPeriod === 'year') return dashboardYear;
      if (dashboardPeriod === 'month') return dashboardMonthNames[dashboardMonth] + ' ' + dashboardYear;
      if (dashboardPeriod === 'q1') return 'Q1 ' + dashboardYear;
      if (dashboardPeriod === 'q2') return 'Q2 ' + dashboardYear;
      if (dashboardPeriod === 'q3') return 'Q3 ' + dashboardYear;
      if (dashboardPeriod === 'q4') return 'Q4 ' + dashboardYear;
      return dashboardYear;
    }

    // Get date range for dashboard period
    function getDashboardDateRange() {
      const year = dashboardYear;
      if (dashboardPeriod === 'all') {
        // All Time: from earliest possible year to current date
        return { start: '2020-01-01', end: new Date().toISOString().split('T')[0] };
      }
      if (dashboardPeriod === 'year') {
        return { start: year + '-01-01', end: year + '-12-31' };
      }
      if (dashboardPeriod === 'month') {
        const lastDay = new Date(year, dashboardMonth, 0).getDate();
        return {
          start: year + '-' + String(dashboardMonth).padStart(2, '0') + '-01',
          end: year + '-' + String(dashboardMonth).padStart(2, '0') + '-' + lastDay
        };
      }
      if (dashboardPeriod === 'q1') return { start: year + '-01-01', end: year + '-03-31' };
      if (dashboardPeriod === 'q2') return { start: year + '-04-01', end: year + '-06-30' };
      if (dashboardPeriod === 'q3') return { start: year + '-07-01', end: year + '-09-30' };
      if (dashboardPeriod === 'q4') return { start: year + '-10-01', end: year + '-12-31' };
      return { start: year + '-01-01', end: year + '-12-31' };
    }

    function renderDashboard(c) {
      // Filter trips by selected period (year, quarter, or all time)
      const yearTrips = filterTripsByPeriod(appData.trips);
      const yearTripIds = yearTrips.map(t => t.id);

      // Filter orders to match the same period
      const yearOrders = appData.orders.filter(o => {
        if (yearTripIds.includes(o.trip_id)) return true;
        if (!o.trip_id) {
          // Standalone orders - filter by period
          const orderDate = new Date(o.created_at);
          const orderYear = orderDate.getFullYear();
          if (dashboardPeriod === 'all') return true;
          if (orderYear !== dashboardYear) return false;
          if (dashboardPeriod === 'year') return true;
          const month = orderDate.getMonth();
          const quarter = month >= 0 && month <= 2 ? 1 : month >= 3 && month <= 5 ? 2 : month >= 6 && month <= 8 ? 3 : 4;
          if (dashboardPeriod === 'q1') return quarter === 1;
          if (dashboardPeriod === 'q2') return quarter === 2;
          if (dashboardPeriod === 'q3') return quarter === 3;
          if (dashboardPeriod === 'q4') return quarter === 4;
        }
        return false;
      });

      // Calculate all metrics for selected year
      let totalRev = 0, totalProfit = 0, totalExpenses = 0, totalBrokerFees = 0, totalLocalFees = 0, totalDriverCut = 0, totalCars = 0;
      const completedTrips = yearTrips.filter(t => t.status === 'COMPLETED');
      const truckPerf = {};
      const dispPerf = {};

      // Get fleet miles from Samsara if available (preferred), otherwise use trip miles
      const dateRange = getDashboardDateRange();
      const fleetMilesResult = getFleetMiles(dateRange.start, dateRange.end);
      const totalMiles = fleetMilesResult.miles;
      const dashboardMilesSource = fleetMilesResult.source; // 'samsara' or 'trips'

      let tripFuelExpenses = 0; // Fuel from trip-level expenses
      yearTrips.forEach(t => {
        const f = getTripFin(t.id);
        totalRev += f.loadRevenue;
        totalProfit += f.netProfit;
        totalExpenses += f.totalExpenses;
        totalBrokerFees += f.brokerFee;
        totalLocalFees += f.localFees;
        totalDriverCut += f.driverCut;
        totalCars += f.vehicleCount;

        // Sum trip-level fuel expenses
        const tripExpenses = appData.expenses?.filter(e => e.trip_id === t.id) || [];
        tripFuelExpenses += tripExpenses.filter(e => e.category === 'FUEL').reduce((s, e) => s + parseFloat(e.amount || 0), 0);

        // Truck performance
        if (t.truck_id) {
          if (!truckPerf[t.truck_id]) truckPerf[t.truck_id] = { trips: 0, rev: 0, profit: 0 };
          truckPerf[t.truck_id].trips++;
          truckPerf[t.truck_id].rev += f.loadRevenue;
          truckPerf[t.truck_id].profit += f.netProfit;
        }
      });

      // Calculate fleet-wide fuel from Fuel Tracking (fuel_transactions table)
      const fleetFuelRecords = (appData.fuel_transactions || []).filter(f => {
        if (!f.transaction_date) return false;
        const fuelDate = f.transaction_date;
        return fuelDate >= dateRange.start && fuelDate <= dateRange.end;
      });
      // Use 'amount' field (same as Fuel Tracking page uses)
      const fleetFuelCost = fleetFuelRecords.reduce((s, f) => s + parseFloat(f.amount || 0), 0);
      const fleetFuelGallons = fleetFuelRecords.reduce((s, f) => s + parseFloat(f.gallons || 0), 0);
      
      // Dispatcher performance from orders (filtered by year)
      // Also add standalone orders (orders without trip_id) to revenue
      yearOrders.forEach(o => {
        if (o.dispatcher_id) {
          if (!dispPerf[o.dispatcher_id]) dispPerf[o.dispatcher_id] = { cars: 0, rev: 0 };
          dispPerf[o.dispatcher_id].cars++;
          dispPerf[o.dispatcher_id].rev += parseFloat(o.revenue || 0);
        }
        // Add standalone orders to revenue (orders not assigned to a trip)
        if (!o.trip_id) {
          const orderRev = parseFloat(o.revenue || 0);
          const orderBrokerFee = parseFloat(o.broker_fee || 0);
          const orderLocalFee = parseFloat(o.local_fee || 0);
          totalRev += orderRev;
          totalBrokerFees += orderBrokerFee;
          totalLocalFees += orderLocalFee;
          // Standalone orders contribute to profit (revenue - fees, no driver cut or expenses)
          totalProfit += orderRev - orderBrokerFee - orderLocalFee;
          totalCars++;
        }
      });

      // Find top/bottom performers
      const truckIds = Object.keys(truckPerf);
      let topTruck = null, bottomTruck = null;
      if (truckIds.length > 0) {
        topTruck = truckIds.reduce((a, b) => truckPerf[a].profit > truckPerf[b].profit ? a : b);
        bottomTruck = truckIds.reduce((a, b) => truckPerf[a].profit < truckPerf[b].profit ? a : b);
      }

      const dispIds = Object.keys(dispPerf);
      let topDisp = null, bottomDisp = null;
      if (dispIds.length > 0) {
        topDisp = dispIds.reduce((a, b) => dispPerf[a].cars > dispPerf[b].cars ? a : b);
        bottomDisp = dispIds.reduce((a, b) => dispPerf[a].cars < dispPerf[b].cars ? a : b);
      }

      // Most/Least profitable trips (filtered by year)
      let mostProfTrip = null, leastProfTrip = null, mostProf = -Infinity, leastProf = Infinity;
      yearTrips.forEach(t => {
        const f = getTripFin(t.id);
        if (f.netProfit > mostProf) { mostProf = f.netProfit; mostProfTrip = t; }
        if (f.netProfit < leastProf) { leastProf = f.netProfit; leastProfTrip = t; }
      });

      // COD collections - for split payments, only count cod_amount as COD, not full revenue (filtered by year)
      const codAmount = yearOrders.filter(o => o.payment_type === 'COD').reduce((s, o) => {
        if (parseFloat(o.bill_amount || 0) > 0) {
          return s + parseFloat(o.cod_amount || 0);
        }
        return s + parseFloat(o.revenue || 0);
      }, 0);
      const copAmount = yearOrders.filter(o => o.payment_type === 'COP').reduce((s, o) => {
        if (parseFloat(o.bill_amount || 0) > 0) {
          return s + parseFloat(o.cod_amount || 0);
        }
        return s + parseFloat(o.revenue || 0);
      }, 0);
      const localCodAmount = yearOrders.filter(o => o.payment_type === 'LOCAL_COD').reduce((s, o) => {
        if (parseFloat(o.bill_amount || 0) > 0) {
          return s + parseFloat(o.cod_amount || 0);
        }
        return s + parseFloat(o.revenue || 0);
      }, 0);
      const checkAmount = yearOrders.filter(o => o.payment_type === 'CHECK').reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
      // Bill amount = total revenue minus all cash/check collections
      const billAmount = totalRev - codAmount - copAmount - localCodAmount - checkAmount;
      
      // KPIs
      const profitMargin = totalRev > 0 ? ((totalProfit / totalRev) * 100).toFixed(1) : 0;
      const revenuePerMile = totalMiles > 0 ? (totalRev / totalMiles).toFixed(2) : 0;
      const profitPerMile = totalMiles > 0 ? (totalProfit / totalMiles).toFixed(2) : 0;
      const avgRevPerTrip = yearTrips.length > 0 ? (totalRev / yearTrips.length).toFixed(2) : 0;
      const avgProfitPerTrip = yearTrips.length > 0 ? (totalProfit / yearTrips.length).toFixed(2) : 0;
      const avgPricePerCar = totalCars > 0 ? (totalRev / totalCars).toFixed(2) : 0;

      // Clean gross (revenue - broker fees - local fees)
      const cleanGross = totalRev - totalBrokerFees - totalLocalFees;
      const truckGross = cleanGross - totalDriverCut;

      // Build year selector dropdown
      const currentYear = new Date().getFullYear();
      const availableYears = [...new Set(appData.trips.map(t => getTripYear(t)).filter(y => y))].sort((a, b) => b - a);
      if (!availableYears.includes(currentYear)) availableYears.unshift(currentYear);
      const yearOptions = availableYears.map(y => '<option value="' + y + '"' + (y === dashboardYear ? ' selected' : '') + '>' + y + '</option>').join('');

      // Period selector buttons
      const periodButtons = [
        { value: 'all', label: 'All Time' },
        { value: 'year', label: 'Year' },
        { value: 'month', label: 'Month' },
        { value: 'q1', label: 'Q1' },
        { value: 'q2', label: 'Q2' },
        { value: 'q3', label: 'Q3' },
        { value: 'q4', label: 'Q4' }
      ].map(p => '<button onclick="changeDashboardPeriod(\'' + p.value + '\')" style="padding:6px 12px;border-radius:var(--radius);border:1px solid ' + (dashboardPeriod === p.value ? 'var(--primary)' : 'var(--border)') + ';background:' + (dashboardPeriod === p.value ? 'var(--primary)' : 'var(--bg-secondary)') + ';color:' + (dashboardPeriod === p.value ? 'white' : 'var(--text-primary)') + ';font-size:var(--text-sm);font-weight:500;cursor:pointer">' + p.label + '</button>').join('');

      // Month selector options
      const monthOptions = dashboardMonthNames.slice(1).map((m, i) => '<option value="' + (i + 1) + '"' + (dashboardMonth === i + 1 ? ' selected' : '') + '>' + m + '</option>').join('');

      c.innerHTML = '<div class="header"><h2> Dashboard</h2><div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap"><div style="display:flex;gap:4px">' + periodButtons + '</div>' + (dashboardPeriod === 'month' ? '<select onchange="changeDashboardMonth(this.value)" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);font-weight:600;cursor:pointer">' + monthOptions + '</select>' : '') + (dashboardPeriod !== 'all' ? '<select onchange="changeDashboardYear(this.value)" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);font-weight:600;cursor:pointer">' + yearOptions + '</select>' : '') + '<button class="btn btn-secondary" onclick="showExportMenu()"> Export</button><button class="btn btn-secondary" onclick="loadAllData(true).then(()=>renderPage())"> Refresh</button></div></div>' +

        // Tasks Widget - TOP OF PAGE
        renderTasksWidget() +

        // Recent Trips Table - RIGHT AFTER TASKS (filtered by period)
        '<div class="card" style="margin-bottom:20px"><div class="card-header"><h3> Recent Trips (' + getDashboardPeriodLabel() + ')</h3></div><div class="table-wrapper"><table><thead><tr><th>Trip</th><th>Date</th><th>Driver</th><th>Truck</th><th>Cars</th><th>Revenue</th><th>Profit</th><th>Status</th></tr></thead><tbody>' + (yearTrips.length > 0 ? yearTrips.slice(0, 5).map(t => { const d = appData.drivers.find(x => x.id === t.driver_id); const tr = appData.trucks.find(x => x.id === t.truck_id); const f = getTripFin(t.id); return '<tr style="cursor:pointer" onclick="viewTrip(' + t.id + ')"><td><strong style="color:var(--blue)">' + t.trip_number + '</strong></td><td>' + formatDate(t.trip_date) + '</td><td>' + (d ? d.first_name + ' ' + d.last_name : '-') + '</td><td>' + (tr ? '#' + tr.truck_number : '-') + '</td><td>' + f.vehicleCount + '</td><td class="money">' + formatMoney(f.loadRevenue) + '</td><td class="money ' + (f.netProfit >= 0 ? 'positive' : 'negative') + '">' + formatMoney(f.netProfit) + '</td><td><span class="badge ' + getBadge(t.status) + '">' + t.status + '</span></td></tr>'; }).join('') : '<tr><td colspan="8" style="text-align:center;padding:var(--spacing-10);color:var(--text-muted)">No trips for ' + getDashboardPeriodLabel() + '</td></tr>') + '</tbody></table></div></div>' +
        
        // Top Stats Row
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:20px">' +
        '<div class="stat-card"><div class="stat-icon green"><i data-lucide="dollar-sign" class="ico"></i></div><div class="stat-label">Revenue Generated</div><div class="stat-value">' + formatMoney(totalRev) + '</div></div>' +
        '<div class="stat-card"><div class="stat-icon red"><i data-lucide="trending-down" class="ico"></i></div><div class="stat-label">Direct Trip Expenses</div><div class="stat-value">' + formatMoney(totalBrokerFees + totalLocalFees + totalDriverCut + totalExpenses) + '</div></div>' +
        '<div class="stat-card" style="background:' + (totalProfit >= 0 ? 'var(--green-dim)' : 'var(--red-dim)') + '"><div class="stat-icon ' + (totalProfit >= 0 ? 'green' : 'red') + '"><i data-lucide="' + (totalProfit >= 0 ? 'trending-up' : 'trending-down') + '" class="ico"></i></div><div class="stat-label">Net Profit</div><div class="stat-value" style="color:' + (totalProfit >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(totalProfit) + '</div><div style="font-size:var(--text-xs);color:' + (totalProfit >= 0 ? 'var(--green)' : 'var(--red)') + '">' + profitMargin + '% margin</div></div>' +
        '</div>' +
        
        // === QUICK VIEW - Company Profitability Metrics ===
        (function() {
          // Calculate Quick View metrics (using yearTrips for year-filtered data)
          const monthlyFixedCosts = (appData.fixed_costs || []).reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);
          const periodMonths = Math.max(1, Object.keys(calculateTripVolume(yearTrips).monthlyData).length);
          const totalFixedCosts = monthlyFixedCosts * periodMonths;
          // Filter maintenance by the same period as dashboard (respects Q1/Q2/month filters)
          const periodMaintenanceRecords = (appData.maintenance_records || []).filter(m => {
            const mDate = m.service_date || m.date || m.created_at;
            if (!mDate) return false;
            return mDate >= dateRange.start && mDate <= dateRange.end;
          });
          const maintenanceCosts = periodMaintenanceRecords.reduce((s, m) => s + parseFloat(m.total_cost || 0), 0);
          const totalOperatingCosts = totalBrokerFees + totalLocalFees + totalDriverCut + totalExpenses + totalFixedCosts + maintenanceCosts;
          const cpm = totalMiles > 0 ? (totalOperatingCosts / totalMiles) : 0;
          const rpm = totalMiles > 0 ? (totalRev / totalMiles) : 0;
          const marginPerMile = rpm - cpm;
          const breakEvenData = calculateBreakEven();
          const targetVehiclePrice = breakEvenData.profitablePPC || 0;
          const currentAvgPrice = totalCars > 0 ? totalRev / totalCars : 0;
          const priceGap = targetVehiclePrice - currentAvgPrice;

          // Check data quality
          const hasFixedCosts = monthlyFixedCosts > 0;
          const hasTrips = yearTrips.length >= 3;
          const hasMiles = totalMiles > 0;
          const dataQuality = (hasFixedCosts ? 1 : 0) + (hasTrips ? 1 : 0) + (hasMiles ? 1 : 0);
          
          // Warning banner if data incomplete
          const warningBanner = dataQuality < 3 ? 
            '<div style="padding:12px 20px;background:rgba(251,191,36,0.2);border-bottom:1px solid rgba(251,191,36,0.3);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">' +
            '<span style="color:var(--amber);font-size:12px"> ' + (!hasFixedCosts ? 'No fixed costs entered' : !hasTrips ? 'Need more trip data' : 'Missing miles data') + ' - metrics may be inaccurate</span>' +
            (!hasFixedCosts ? '<button onclick="openSetupWizard()" style="background:var(--amber);color:var(--amber);border:none;padding:6px 12px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer"> Setup Wizard</button>' : '') +
            '</div>' : '';
          
          return '<div class="card" style="margin-bottom:20px;background:linear-gradient(135deg,var(--bg-elevated),var(--bg-elevated));color:white;overflow:hidden">' +
            '<div style="padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.1)">' +
            '<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">' +
            '<h3 style="margin:0;color:white;font-size:16px"> Quick View - Company Profitability</h3>' +
            '<div style="display:flex;align-items:center;gap:12px">' +
            '<span style="background:rgba(255,255,255,0.15);padding:4px 10px;border-radius:12px;font-size:11px">' + totalMiles.toLocaleString() + ' mi ' + (dashboardMilesSource === 'samsara' ? '<span style="color:var(--blue-dim);font-size:9px"></span>' : '') + '  ' + totalCars + ' cars</span>' +
            '<button onclick="openSetupWizard()" style="background:rgba(59,130,246,0.3);color:var(--blue-dim);border:1px solid rgba(59,130,246,0.5);padding:4px 10px;border-radius:var(--radius);font-size:var(--text-xs);cursor:pointer"> Setup</button>' +
            '</div></div></div>' +
            warningBanner +
            '<div style="display:grid;grid-template-columns:repeat(6,1fr);gap:0">' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1)">' +
            '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Cost Per Mile</div>' +
            '<div style="font-size:var(--text-3xl);font-weight:var(--weight-bold);font-family:var(--font-mono);color:var(--red)">$' + cpm.toFixed(2) + '</div>' +
            '<div style="font-size:10px;color:var(--text-muted);margin-top:4px">Operating CPM</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1)">' +
            '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Revenue Per Mile</div>' +
            '<div style="font-size:var(--text-3xl);font-weight:var(--weight-bold);font-family:var(--font-mono);color:var(--primary-400)">$' + rpm.toFixed(2) + '</div>' +
            '<div style="font-size:10px;color:var(--text-muted);margin-top:4px">Gross RPM</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1);background:' + (marginPerMile >= 0 ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)') + '">' +
            '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Margin Per Mile</div>' +
            '<div style="font-size:var(--text-3xl);font-weight:var(--weight-bold);font-family:var(--font-mono);color:' + (marginPerMile >= 0 ? 'var(--primary-400)' : 'var(--red)') + '">$' + marginPerMile.toFixed(2) + '</div>' +
            '<div style="font-size:10px;color:' + (marginPerMile >= 0 ? 'var(--green)' : 'var(--red)') + ';margin-top:4px">' + (marginPerMile >= 0 ? ' Profitable' : ' Losing Money') + '</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1)">' +
            '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Avg Vehicle Price</div>' +
            '<div style="font-size:var(--text-3xl);font-weight:var(--weight-bold);font-family:var(--font-mono);color:var(--blue)">$' + currentAvgPrice.toFixed(0) + '</div>' +
            '<div style="font-size:10px;color:var(--text-muted);margin-top:4px">Current Average</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;border-right:1px solid rgba(255,255,255,0.1)">' +
            '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Break-Even Price</div>' +
            '<div style="font-size:var(--text-3xl);font-weight:var(--weight-bold);font-family:var(--font-mono);color:var(--purple)">$' + targetVehiclePrice.toFixed(0) + '</div>' +
            '<div style="font-size:10px;color:var(--text-muted);margin-top:4px">Min per vehicle</div>' +
            '</div>' +
            '<div style="padding:20px;text-align:center;background:' + (priceGap <= 0 ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)') + '">' +
            '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Profit Per Vehicle</div>' +
            '<div style="font-size:var(--text-3xl);font-weight:var(--weight-bold);font-family:var(--font-mono);color:' + (priceGap <= 0 ? 'var(--primary-400)' : 'var(--red)') + '">$' + Math.abs(currentAvgPrice - targetVehiclePrice).toFixed(0) + '</div>' +
            '<div style="font-size:10px;color:' + (priceGap <= 0 ? 'var(--green)' : 'var(--red)') + ';margin-top:4px">' + (priceGap <= 0 ? ' Profitable' : ' Losing $' + Math.abs(priceGap).toFixed(0) + '/car') + '</div>' +
            '</div>' +
            '</div></div>';
        })() +
        
        // Second row - Other Metrics and Expense Breakdown
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px">' +
        
        // Left column - Other Metrics
        '<div class="card" style="padding:20px">' +
        '<h3 style="margin-bottom:16px;color:var(--blue);border-bottom:2px solid var(--blue);padding-bottom:8px"> OTHER METRICS</h3>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:var(--text-sm)">' +
        '<div><span style="color:var(--text-muted)"># of Trucks in Service</span></div><div style="text-align:right;font-weight:600">' + appData.trucks.filter(t => t.status === 'ACTIVE').length + '</div>' +
        '<div><span style="color:var(--text-muted)">Total Miles Traveled</span></div><div style="text-align:right;font-weight:600">' + totalMiles.toLocaleString() + '</div>' +
        '<div><span style="color:var(--text-muted)"># of Trips</span></div><div style="text-align:right;font-weight:600">' + appData.trips.length + '</div>' +
        '<div><span style="color:var(--text-muted)"># of Cars Hauled</span></div><div style="text-align:right;font-weight:600">' + totalCars + '</div>' +
        '</div>' +
        
        // Most/Least Profitable Trips
        '<div style="margin-top:20px;padding:var(--spacing-3);background:var(--green-dim);border-radius:var(--radius)">' +
        '<div style="font-size:var(--text-xs);color:var(--green)"> Most Profitable Trip</div>' +
        '<div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--green)">' + (mostProfTrip ? mostProfTrip.trip_number : '-') + '</div>' +
        '<div style="font-size:var(--text-sm);color:var(--green)">' + formatMoney(mostProf !== -Infinity ? mostProf : 0) + '</div>' +
        '</div>' +
        '<div style="margin-top:12px;padding:var(--spacing-3);background:var(--red-dim);border-radius:var(--radius)">' +
        '<div style="font-size:var(--text-xs);color:var(--red)"> Least Profitable Trip</div>' +
        '<div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--red)">' + (leastProfTrip ? leastProfTrip.trip_number : '-') + '</div>' +
        '<div style="font-size:var(--text-sm);color:var(--red)">' + formatMoney(leastProf !== Infinity ? leastProf : 0) + '</div>' +
        '</div>' +
        '</div>' +
        
        // Right column - Direct Trip Expenses Breakdown
        '<div class="card" style="padding:20px">' +
        '<h3 style="margin-bottom:16px;color:var(--red);border-bottom:2px solid var(--red);padding-bottom:8px"> DIRECT TRIP EXPENSES</h3>' +
        '<div style="display:flex;flex-direction:column;gap:12px">' +
        '<div style="display:flex;justify-content:space-between;align-items:center"><span>Broker Fees</span><span style="font-weight:600;color:var(--red)">' + formatMoney(totalBrokerFees) + '</span></div>' +
        '<div style="background:var(--red-dim);height:8px;border-radius:4px"><div style="background:var(--red);height:100%;border-radius:4px;width:' + (totalRev > 0 ? (totalBrokerFees/totalRev*100) : 0) + '%"></div></div>' +
        '<div style="display:flex;justify-content:space-between;align-items:center"><span>Local Fees</span><span style="font-weight:600;color:var(--amber)">' + formatMoney(totalLocalFees) + '</span></div>' +
        '<div style="background:var(--amber-dim);height:8px;border-radius:4px"><div style="background:var(--amber);height:100%;border-radius:4px;width:' + (totalRev > 0 ? (totalLocalFees/totalRev*100) : 0) + '%"></div></div>' +
        '<div style="display:flex;justify-content:space-between;align-items:center"><span>Driver Cut</span><span style="font-weight:600;color:var(--purple)">' + formatMoney(totalDriverCut) + '</span></div>' +
        '<div style="background:var(--purple-dim);height:8px;border-radius:4px"><div style="background:var(--purple);height:100%;border-radius:4px;width:' + (totalRev > 0 ? (totalDriverCut/totalRev*100) : 0) + '%"></div></div>' +
        '<div style="display:flex;justify-content:space-between;align-items:center"><span>Trip Expenses</span><span style="font-weight:600;color:var(--text-muted)">' + formatMoney(totalExpenses) + '</span></div>' +
        '<div style="background:var(--border);height:8px;border-radius:4px"><div style="background:var(--text-secondary);height:100%;border-radius:4px;width:' + (totalRev > 0 ? (totalExpenses/totalRev*100) : 0) + '%"></div></div>' +
        '<div style="border-top:2px solid var(--border);padding-top:12px;margin-top:8px;display:flex;justify-content:space-between;align-items:center"><span style="font-weight:var(--weight-bold)">Total Direct Trip Expenses</span><span style="font-weight:var(--weight-bold);color:var(--red)">' + formatMoney(totalBrokerFees + totalLocalFees + totalDriverCut + totalExpenses) + '</span></div>' +
        '</div>' +
        '</div>' +
        '</div>' +

        // Fuel Tracking Comparison Card
        '<div class="card" style="padding:20px;margin-bottom:20px">' +
        '<h3 style="margin-bottom:16px;color:var(--amber);border-bottom:2px solid var(--amber);padding-bottom:8px"> FUEL TRACKING</h3>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">' +
        '<div style="background:var(--amber-dim);padding:var(--spacing-4);border-radius:var(--radius);border-left:4px solid var(--amber)">' +
        '<div style="font-size:12px;color:var(--amber);margin-bottom:4px">Trip-Level Fuel Expenses</div>' +
        '<div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--amber)">' + formatMoney(tripFuelExpenses) + '</div>' +
        '<div style="font-size:11px;color:var(--amber);margin-top:4px">From individual trip expenses</div>' +
        '</div>' +
        '<div style="background:var(--blue-dim);padding:var(--spacing-4);border-radius:var(--radius);border-left:4px solid var(--blue)">' +
        '<div style="font-size:12px;color:var(--blue);margin-bottom:4px">Fleet Fuel (Fuel Tracking)</div>' +
        '<div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--blue)">' + formatMoney(fleetFuelCost) + '</div>' +
        '<div style="font-size:11px;color:var(--blue);margin-top:4px">' + fleetFuelGallons.toLocaleString(undefined, {maximumFractionDigits: 0}) + ' gallons  ' + (fleetFuelGallons > 0 && totalMiles > 0 ? (totalMiles / fleetFuelGallons).toFixed(2) : '-') + ' MPG</div>' +
        '</div>' +
        '</div>' +
        (Math.abs(tripFuelExpenses - fleetFuelCost) > 100 ? '<div style="margin-top:12px;padding:12px;background:var(--amber-dim);border-radius:8px;font-size:13px;color:var(--amber)"> Trip fuel and Fleet fuel don\'t match. Trip fuel is per-trip expenses; Fleet fuel is from Fuel Tracking uploads.</div>' : '') +
        '</div>' +
        
        // Third row - KPIs and Performance
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px">' +
        
        // KPIs
        '<div class="card" style="padding:20px">' +
        '<h3 style="margin-bottom:16px;color:var(--purple);border-bottom:2px solid var(--purple);padding-bottom:8px"> KEY PERFORMANCE INDICATORS</h3>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">' +
        '<div style="background:var(--bg-app);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:var(--text-xs);color:var(--text-muted)">Revenue/Mile</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--text-primary)">$' + revenuePerMile + '</div></div>' +
        '<div style="background:var(--bg-app);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:var(--text-xs);color:var(--text-muted)">Profit/Mile</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:' + (profitPerMile >= 0 ? 'var(--green)' : 'var(--red)') + '">$' + profitPerMile + '</div></div>' +
        '<div style="background:var(--bg-app);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:var(--text-xs);color:var(--text-muted)">Avg Revenue/Trip</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--text-primary)">$' + parseFloat(avgRevPerTrip).toLocaleString() + '</div></div>' +
        '<div style="background:var(--bg-app);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:var(--text-xs);color:var(--text-muted)">Avg Profit/Trip</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:' + (avgProfitPerTrip >= 0 ? 'var(--green)' : 'var(--red)') + '">$' + parseFloat(avgProfitPerTrip).toLocaleString() + '</div></div>' +
        '<div style="background:var(--bg-app);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:var(--text-xs);color:var(--text-muted)">Avg Price/Car</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--text-primary)">$' + parseFloat(avgPricePerCar).toLocaleString() + '</div></div>' +
        '<div style="background:var(--bg-app);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:var(--text-xs);color:var(--text-muted)">Truck Gross</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--blue)">' + formatMoney(truckGross) + '</div></div>' +
        '</div>' +
        '</div>' +
        
        // Truck & Dispatcher Performance
        '<div class="card" style="padding:20px">' +
        '<h3 style="margin-bottom:16px;color:var(--green);border-bottom:2px solid var(--green);padding-bottom:8px"> TOP PERFORMERS</h3>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">' +
        '<div style="background:var(--green-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:11px;color:var(--green)">Top Earner Truck</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--green)">#' + (topTruck ? appData.trucks.find(t => t.id == topTruck)?.truck_number || '-' : '-') + '</div><div style="font-size:var(--text-sm);color:var(--green)">' + (topTruck ? formatMoney(truckPerf[topTruck].profit) : '-') + '</div></div>' +
        '<div style="background:var(--red-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:11px;color:var(--red)">Lowest Earner Truck</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--red)">#' + (bottomTruck ? appData.trucks.find(t => t.id == bottomTruck)?.truck_number || '-' : '-') + '</div><div style="font-size:var(--text-sm);color:var(--red)">' + (bottomTruck ? formatMoney(truckPerf[bottomTruck].profit) : '-') + '</div></div>' +
        '<div style="background:var(--blue-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:11px;color:var(--blue)">Top Dispatcher</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--blue)">' + (topDisp ? appData.dispatchers.find(d => d.id == topDisp)?.name || '-' : '-') + '</div><div style="font-size:14px;color:var(--blue)">' + (topDisp ? dispPerf[topDisp].cars + ' cars' : '-') + '</div></div>' +
        '<div style="background:var(--bg-card-hover);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:var(--text-xs);color:var(--text-muted)">Least Active Dispatcher</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--text-muted)">' + (bottomDisp ? appData.dispatchers.find(d => d.id == bottomDisp)?.name || '-' : '-') + '</div><div style="font-size:14px;color:var(--text-muted)">' + (bottomDisp ? dispPerf[bottomDisp].cars + ' cars' : '-') + '</div></div>' +
        '</div>' +
        '</div>' +
        '</div>' +
        
        // Fourth row - Payment Collections
        '<div class="card" style="padding:20px;margin-bottom:20px">' +
        '<h3 style="margin-bottom:16px;color:var(--blue);border-bottom:2px solid var(--blue);padding-bottom:8px"> PAYMENT COLLECTION</h3>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px">' +
        '<div style="background:var(--green-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:var(--text-xs);color:var(--green)">COD Collected</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--green)">' + formatMoney(codAmount) + '</div></div>' +
        '<div style="background:var(--green-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:12px;color:var(--primary-700)">COP Collected</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--primary-700)">' + formatMoney(copAmount) + '</div></div>' +
        '<div style="background:var(--amber-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:12px;color:var(--amber)">Local COD</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--amber)">' + formatMoney(localCodAmount) + '</div></div>' +
        '<div style="background:var(--blue-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:12px;color:var(--blue)">Check</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--blue)">' + formatMoney(checkAmount) + '</div></div>' +
        '<div style="background:var(--purple-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:12px;color:var(--purple)">Bill (Invoice)</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--purple)">' + formatMoney(billAmount) + '</div></div>' +
        '</div>' +
        '</div>' +
        
        // Cost Trend Sparklines Section
        (function() {
          // Get last 12 weeks of expense data
          const weeks = [];
          const today = new Date();
          for (let i = 11; i >= 0; i--) {
            const weekEnd = new Date(today);
            weekEnd.setDate(weekEnd.getDate() - (i * 7));
            const weekStart = new Date(weekEnd);
            weekStart.setDate(weekStart.getDate() - 6);
            weeks.push({ start: weekStart, end: weekEnd, label: 'W' + (12 - i) });
          }
          
          // Categories to track
          const categories = ['FUEL', 'TOLLS', 'MAINTENANCE', 'PERMITS', 'PARKING'];
          const categoryColors = { FUEL: 'var(--red)', TOLLS: 'var(--amber)', MAINTENANCE: 'var(--blue)', PERMITS: 'var(--purple)', PARKING: 'var(--green)' };
          const categoryIcons = { FUEL: '', TOLLS: '', MAINTENANCE: '', PERMITS: '', PARKING: '' };
          
          // Calculate weekly totals per category
          const weeklyData = {};
          categories.forEach(cat => {
            weeklyData[cat] = weeks.map(w => {
              return appData.expenses
                .filter(e => e.category === cat && e.expense_date)
                .filter(e => {
                  const d = new Date(e.expense_date);
                  return d >= w.start && d <= w.end;
                })
                .reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            });
          });
          
          // Calculate totals and trends
          const categoryStats = categories.map(cat => {
            const data = weeklyData[cat];
            const total = data.reduce((s, v) => s + v, 0);
            const recent4 = data.slice(-4).reduce((s, v) => s + v, 0);
            const prev4 = data.slice(-8, -4).reduce((s, v) => s + v, 0);
            const trend = prev4 > 0 ? ((recent4 - prev4) / prev4 * 100) : 0;
            const max = Math.max(...data, 1);
            const avg = total / 12;
            return { cat, data, total, trend, max, avg, color: categoryColors[cat], icon: categoryIcons[cat] };
          });
          
          // Generate SVG sparklines
          const generateSparkline = (data, max, color) => {
            const width = 120;
            const height = 32;
            const padding = 2;
            const points = data.map((v, i) => {
              const x = padding + (i / (data.length - 1)) * (width - 2 * padding);
              const y = height - padding - (v / max) * (height - 2 * padding);
              return x + ',' + y;
            }).join(' ');
            
            // Fill area
            const fillPoints = padding + ',' + (height - padding) + ' ' + points + ' ' + (width - padding) + ',' + (height - padding);
            
            return '<svg width="' + width + '" height="' + height + '" style="display:block">' +
              '<polygon points="' + fillPoints + '" fill="' + color + '" fill-opacity="0.15"/>' +
              '<polyline points="' + points + '" fill="none" stroke="' + color + '" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>' +
              '<circle cx="' + (padding + (11 / 11) * (width - 2 * padding)) + '" cy="' + (height - padding - (data[11] / max) * (height - 2 * padding)) + '" r="3" fill="' + color + '"/>' +
              '</svg>';
          };
          
          return '<div class="card" style="padding:20px;margin-bottom:20px">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">' +
            '<h3 style="margin:0;color:var(--text-muted);border-bottom:2px solid var(--text-secondary);padding-bottom:8px"> COST TRENDS (Last 12 Weeks)</h3>' +
            '<div style="font-size:var(--text-xs);color:var(--text-muted)">Hover for details</div>' +
            '</div>' +
            '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px">' +
            categoryStats.map(s => {
              const trendIcon = s.trend > 5 ? '' : s.trend < -5 ? '' : '';
              const trendColor = s.trend > 5 ? 'var(--red)' : s.trend < -5 ? 'var(--green)' : 'var(--text-secondary)';
              const trendBg = s.trend > 5 ? 'var(--red-dim)' : s.trend < -5 ? 'var(--green-dim)' : 'var(--bg-card-hover)';
              return '<div style="background:var(--bg-app);border-radius:var(--radius-lg);padding:var(--spacing-4);border:1px solid var(--border)" title="' + s.cat + ': Last 12 weeks data">' +
                '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">' +
                '<div style="display:flex;align-items:center;gap:8px">' +
                '<span style="font-size:20px">' + s.icon + '</span>' +
                '<span style="font-weight:600;color:var(--bg-elevated)">' + s.cat + '</span>' +
                '</div>' +
                '<span style="font-size:11px;padding:4px 8px;border-radius:12px;background:' + trendBg + ';color:' + trendColor + ';font-weight:600">' + trendIcon + ' ' + Math.abs(s.trend).toFixed(0) + '%</span>' +
                '</div>' +
                '<div style="margin-bottom:8px">' + generateSparkline(s.data, s.max, s.color) + '</div>' +
                '<div style="display:flex;justify-content:space-between;font-size:12px">' +
                '<div><span style="color:var(--text-muted)">Total:</span> <span style="font-weight:600;color:' + s.color + '">' + formatMoney(s.total) + '</span></div>' +
                '<div><span style="color:var(--text-muted)">Avg/wk:</span> <span style="font-weight:600">' + formatMoney(s.avg) + '</span></div>' +
                '</div>' +
                '</div>';
            }).join('') +
            '</div>' +
            '</div>';
        })();
    }
    
    function renderTasksWidget() {
      const tasks = appData.tasks || [];
      const today = new Date().toISOString().split('T')[0];
      
      // Get today's and overdue tasks
      const todayTasks = tasks.filter(t => t.due_date === today && t.status !== 'COMPLETED');
      const overdueTasks = tasks.filter(t => t.due_date < today && t.status !== 'COMPLETED');
      const urgentTasks = tasks.filter(t => t.priority === 'URGENT' && t.status !== 'COMPLETED');
      
      // Combine and sort: urgent first, then overdue, then today's
      let displayTasks = [...urgentTasks];
      overdueTasks.forEach(t => { if (!displayTasks.find(x => x.id === t.id)) displayTasks.push(t); });
      todayTasks.forEach(t => { if (!displayTasks.find(x => x.id === t.id)) displayTasks.push(t); });
      displayTasks = displayTasks.slice(0, 5); // Limit to 5
      
      const getPriorityIcon = (p) => {
        if (p === 'URGENT') return '';
        if (p === 'HIGH') return '';
        return '';
      };
      
      const isOverdue = (d) => d < today;
      
      return '<div class="card" style="margin-bottom:20px">' +
        '<div class="card-header" style="display:flex;justify-content:space-between;align-items:center">' +
        '<h3> Today\'s Tasks</h3>' +
        '<div style="display:flex;gap:8px;align-items:center">' +
        (overdueTasks.length > 0 ? '<span class="badge" style="background:var(--red);color:white">' + overdueTasks.length + ' Overdue</span>' : '') +
        (urgentTasks.length > 0 ? '<span class="badge" style="background:var(--amber);color:white">' + urgentTasks.length + ' Urgent</span>' : '') +
        '<button class="btn btn-secondary" style="padding:6px 12px;font-size:var(--text-xs)" onclick="navigate(\'tasks\')">View All </button>' +
        '</div></div>' +
        (displayTasks.length === 0 ? 
          '<div style="padding:30px;text-align:center;color:var(--text-muted)"> No pending tasks for today!</div>' :
          '<div style="padding:16px">' +
          displayTasks.map(t => {
            const assignee = appData.dispatchers.find(d => d.id === t.assigned_to);
            const bgColor = t.priority === 'URGENT' ? 'var(--amber-dim)' : isOverdue(t.due_date) ? 'var(--red-dim)' : 'var(--bg-app)';
            const borderColor = t.priority === 'URGENT' ? 'var(--amber)' : isOverdue(t.due_date) ? 'var(--red)' : 'var(--bg-elevated)';
            
            return '<div style="display:flex;align-items:center;gap:12px;padding:12px;background:' + bgColor + ';border:1px solid ' + borderColor + ';border-radius:var(--radius);margin-bottom:8px">' +
              '<input type="checkbox" style="width:18px;height:18px;cursor:pointer" onchange="quickCompleteTask(' + t.id + ',this.checked)" title="Mark as completed">' +
              '<div style="flex:1">' +
              '<div style="font-weight:600;display:flex;align-items:center;gap:8px">' + getPriorityIcon(t.priority) + t.title +
              (isOverdue(t.due_date) ? ' <span style="color:var(--red);font-size:var(--text-xs);font-weight:400">(OVERDUE)</span>' : '') +
              '</div>' +
              '<div style="font-size:var(--text-xs);color:var(--text-muted)"> ' + formatDate(t.due_date) + (assignee ? '   ' + assignee.name : '') + '</div>' +
              '</div>' +
              '<button class="action-btn edit" onclick="openTaskModal(' + t.id + ')">Edit</button>' +
              '</div>';
          }).join('') +
          '</div>') +
        '</div>';
    }
    
    async function quickCompleteTask(id, complete) {
      try {
        await dbUpdate('tasks', id, { 
          status: complete ? 'COMPLETED' : 'PENDING',
          completed_at: complete ? new Date().toISOString() : null
        });
        showToast(complete ? 'Task completed! ' : 'Task reopened');
        await loadAllData(true);
        renderDashboard(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    // ============ LOAD BOARD ============
    const loadBoardCategories = [
      { id: 'ny_to_home', name: 'NY to Home', color: 'var(--blue)', subs: [
        { id: 'ny_sf', name: 'San Francisco' },
        { id: 'ny_la', name: 'Los Angeles' },
        { id: 'ny_tn', name: 'Tennessee' },
        { id: 'ny_ar', name: 'Arkansas' },
        { id: 'ny_nv', name: 'Nevada' },
        { id: 'ny_ok', name: 'Oklahoma' }
      ]},
      { id: 'home_to_ny', name: 'Home to NY', color: 'var(--purple)', subs: [] },
      { id: 'home_to_ca', name: 'Home to CA', color: 'var(--blue)', subs: [
        { id: 'ca_sf', name: 'San Francisco' },
        { id: 'ca_la', name: 'Los Angeles' }
      ]},
      { id: 'ca_to_home', name: 'CA to Home', color: 'var(--green)', subs: [] },
      { id: 'fl_to_ca', name: 'FL to CA', color: 'var(--amber)', subs: [] },
      { id: 'fl_to_home', name: 'FL to Home', color: 'var(--red)', subs: [] },
      { id: 'ny_to_fl', name: 'NY to FL', color: 'var(--purple)', subs: [] }
    ];

    let selectedLoadCategory = 'ny_to_home';
    let selectedLoadSub = null;

    function renderLoadBoard(c) {
      // Get unassigned orders (no trip_id) grouped by load_category
      const unassignedOrders = appData.orders.filter(o => !o.trip_id);
      
      // Count per category
      const categoryCounts = {};
      loadBoardCategories.forEach(cat => {
        categoryCounts[cat.id] = unassignedOrders.filter(o => o.load_category === cat.id).length;
        cat.subs.forEach(sub => {
          categoryCounts[sub.id] = unassignedOrders.filter(o => o.load_category === cat.id && o.load_subcategory === sub.id).length;
        });
      });
      
      // Get current category
      const currentCat = loadBoardCategories.find(cat => cat.id === selectedLoadCategory) || loadBoardCategories[0];
      
      // Filter orders for display and sort by recently added first
      let displayOrders = unassignedOrders.filter(o => o.load_category === selectedLoadCategory)
        .sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
      if (selectedLoadSub) {
        displayOrders = displayOrders.filter(o => o.load_subcategory === selectedLoadSub);
      }
      
      // Total revenue
      const totalRevenue = displayOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
      
      c.innerHTML = '<div class="header"><h2> Future Cars</h2><div style="display:flex;gap:8px"><button class="btn btn-primary" onclick="openLoadBoardOrder()">+ Add Vehicle</button><button class="btn" style="background:var(--purple);color:white" onclick="openCreateNewLoad()"> AI Import</button></div></div>' +
        
        // Stats
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:var(--spacing-3) var(--spacing-4)"><div class="label">Total Unassigned</div><div class="value">' + unassignedOrders.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:var(--spacing-3) var(--spacing-4)"><div class="label">In ' + currentCat.name + '</div><div class="value">' + categoryCounts[currentCat.id] + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:140px;padding:var(--spacing-3) var(--spacing-4)"><div class="label">Revenue (Displayed)</div><div class="value">' + formatMoney(totalRevenue) + '</div></div>' +
        '</div>' +
        
        // Category tabs
        '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">' +
        loadBoardCategories.map(cat => {
          const isActive = cat.id === selectedLoadCategory;
          return '<button onclick="selectedLoadCategory=\'' + cat.id + '\';selectedLoadSub=null;renderLoadBoard(document.getElementById(\'main-content\'))" style="padding:var(--spacing-2-5) var(--spacing-4);border:2px solid ' + cat.color + ';background:' + (isActive ? cat.color : 'var(--bg-card)') + ';color:' + (isActive ? 'white' : cat.color) + ';border-radius:var(--radius);cursor:pointer;font-weight:var(--weight-semibold)">' + cat.name + ' (' + categoryCounts[cat.id] + ')</button>';
        }).join('') +
        '</div>' +
        
        // Subcategory tabs (if any)
        (currentCat.subs.length > 0 ? '<div style="display:flex;gap:8px;margin-bottom:16px;padding-left:20px;flex-wrap:wrap">' +
        '<button onclick="selectedLoadSub=null;renderLoadBoard(document.getElementById(\'main-content\'))" style="padding:var(--spacing-1-5) var(--spacing-3);border:1px solid var(--border);background:' + (!selectedLoadSub ? 'var(--blue)' : 'var(--bg-card)') + ';color:' + (!selectedLoadSub ? 'white' : 'var(--text-secondary)') + ';border-radius:var(--radius);cursor:pointer;font-size:var(--text-sm)">All</button>' +
        currentCat.subs.map(sub => {
          const isActive = sub.id === selectedLoadSub;
          return '<button onclick="selectedLoadSub=\'' + sub.id + '\';renderLoadBoard(document.getElementById(\'main-content\'))" style="padding:var(--spacing-1-5) var(--spacing-3);border:1px solid var(--border);background:' + (isActive ? 'var(--blue)' : 'var(--bg-card)') + ';color:' + (isActive ? 'white' : 'var(--text-secondary)') + ';border-radius:var(--radius);cursor:pointer;font-size:var(--text-sm)">' + sub.name + ' (' + categoryCounts[sub.id] + ')</button>';
        }).join('') +
        '</div>' : '') +
        
        // Orders table
        '<div class="card"><div class="card-header" style="background:' + currentCat.color + ';color:white;border-radius:var(--radius) var(--radius) 0 0"><h3 style="margin:0">' + currentCat.name + (selectedLoadSub ? '  ' + currentCat.subs.find(s => s.id === selectedLoadSub)?.name : '') + '</h3></div>' +
        (displayOrders.length === 0 ? '<div style="padding:var(--spacing-10);text-align:center;color:var(--text-muted)">No vehicles in this category</div>' :
        '<div class="table-wrapper"><table><thead><tr><th>Order</th><th>Broker</th><th>Vehicle</th><th>Origin</th><th>P</th><th>Destination</th><th>D</th><th>Pick-Up</th><th>Delivery</th><th>Payment</th><th>Broker Fee</th><th>Local Fee</th><th>Revenue</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        displayOrders.map(o => {
          const noteHtml = o.dispatcher_notes ? '<tr style="background:var(--amber-dim)"><td colspan="14" style="padding:var(--spacing-2) var(--spacing-4);font-size:var(--text-sm)"><span style="font-weight:var(--weight-semibold);color:var(--amber)"> Note:</span> ' + o.dispatcher_notes + '</td></tr>' : '';
          const pickupPhoneDisplay = o.pickup_phone ? '<a href="tel:' + o.pickup_phone + '" style="color:var(--blue)" title="' + o.pickup_phone + '"></a>' : '-';
          const deliveryPhoneDisplay = o.delivery_phone ? '<a href="tel:' + o.delivery_phone + '" style="color:var(--green)" title="' + o.delivery_phone + '"></a>' : '-';
          return '<tr><td><strong>' + o.order_number + '</strong></td><td>' + (o.broker_name || '-') + '</td><td>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</td><td title="' + (o.pickup_full_address || o.origin || '') + '">' + (o.origin || '-') + '</td><td>' + pickupPhoneDisplay + '</td><td title="' + (o.delivery_full_address || o.destination || '') + '">' + (o.destination || '-') + '</td><td>' + deliveryPhoneDisplay + '</td><td>' + (o.pickup_date ? formatDate(o.pickup_date) : '-') + '</td><td>' + (o.dropoff_date ? formatDate(o.dropoff_date) : '-') + '</td><td><span class="badge badge-blue">' + (o.payment_type || '-') + '</span></td><td class="money negative">' + formatMoney(o.broker_fee || 0) + '</td><td class="money negative">' + formatMoney(o.local_fee || 0) + '</td><td class="money">' + formatMoney(o.revenue) + '</td><td class="sticky-col"><div class="actions">' + (o.dispatcher_notes ? '<button class="action-btn" style="background:var(--amber-dim);color:var(--amber)" title="' + o.dispatcher_notes.replace(/"/g, '&quot;') + '"></button>' : '') + '<button class="action-btn" style="background:var(--blue-dim);color:var(--purple)" onclick="openOrderDetailPage(' + o.id + ')">View</button><button class="action-btn view" onclick="openAssignToTrip(' + o.id + ')">Assign</button><button class="action-btn edit" onclick="openLoadBoardOrder(' + o.id + ')">Edit</button><button class="action-btn delete" onclick="deleteLoadBoardOrder(' + o.id + ')">Del</button></div></td></tr>' + noteHtml;
        }).join('') +
        '</tbody></table></div>') +
        '</div>';
    }

    function openLoadBoardOrder(id = null) {
      const o = id ? appData.orders.find(x => x.id === id) : null;
      vehicleList = [];
      
      // Find dispatcher matching current user
      let userDispatcher = appData.dispatchers.find(d => d.user_id === currentUser.id);
      if (!userDispatcher) {
        userDispatcher = appData.dispatchers.find(d => d.email && d.email.toLowerCase() === currentUser.email.toLowerCase());
      }
      if (!userDispatcher) {
        const fullName = (currentUser.first_name + ' ' + currentUser.last_name).toLowerCase();
        userDispatcher = appData.dispatchers.find(d => d.name && d.name.toLowerCase() === fullName);
      }
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:700px;max-height:90vh;display:flex;flex-direction:column"><div class="modal-header"><h3>' + (o ? 'Edit' : 'Add') + ' Vehicle to Future Cars</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body" style="overflow-y:auto;flex:1">' +
        
        // Category Selection
        '<div class="form-row"><div class="form-group"><label>Category *</label><select id="lbCategory" onchange="toggleLoadBoardSub()" style="border:2px solid var(--green);font-weight:600">' + loadBoardCategories.map(cat => '<option value="' + cat.id + '"' + (o?.load_category === cat.id ? ' selected' : '') + '>' + cat.name + '</option>').join('') + '</select></div><div class="form-group" id="lbSubGroup" style="display:none"><label>Sub-Category</label><select id="lbSubCategory"></select></div></div>' +
        
        // Order # and Broker
        '<div class="form-row"><div class="form-group"><label>Order #</label><input id="lbOrderNum" value="' + (o?.order_number || 'ORD-' + Date.now().toString().slice(-4)) + '"></div><div class="form-group" style="position:relative"><label>Broker</label><input type="text" id="lbBrokerInput" placeholder="Start typing broker..." value="' + (o?.broker_name || '') + '" autocomplete="off"><input type="hidden" id="lbBrokerId" value="' + (o?.broker_id || '') + '"></div></div>' +
        '<div id="lbNewBrokerSection" style="display:none;background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:12px;border:1px solid var(--green-dim)"><div class="form-group" style="margin-bottom:0"><label>New Broker Name *</label><input id="lbNewBrokerName" placeholder="Enter broker name"></div></div>' +
        
        // Vehicle Info Section with separate Year, Make, Model
        '<div style="background:var(--bg-app);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:16px">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><label style="font-weight:600;margin:0"> Vehicle Info</label></div>' +
        '<div class="form-row" style="gap:12px;align-items:flex-end">' +
        '<div class="form-group" style="margin-bottom:0;flex:0 0 100px;position:relative"><label>Year</label><input type="text" id="lbYear" value="' + (o?.vehicle_year || new Date().getFullYear()) + '" placeholder="Year" autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>Make</label><input type="text" id="lbMake" value="' + (o?.vehicle_make || '') + '" placeholder="Start typing make..." autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>Model</label><input type="text" id="lbModel" value="' + (o?.vehicle_model || '') + '" placeholder="Start typing model..." autocomplete="off"></div>' +
        (!o ? '<button type="button" class="btn btn-secondary" onclick="addAnotherVehicleLB()" style="height:42px;white-space:nowrap">+ Add Another</button>' : '') + '</div>' +
        
        // Vehicle List (shows when multiple vehicles added) - only for new
        (!o ? '<div id="lbVehicleListSection" style="margin-top:12px;display:none"><div id="lbVehicleListItems"></div></div>' : '') + '</div>' +
        
        // Pickup Section
        '<div style="background:var(--blue-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px"> PICKUP</label>' +
        '<div class="form-row" style="gap:12px">' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>City/State</label><input type="text" id="lbOrigin" value="' + (o?.origin || '') + '" placeholder="Start typing city..." autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:0 0 140px"><label> Phone</label><input type="tel" id="lbPickupPhone" value="' + (o?.pickup_phone || '') + '" placeholder="(555) 123-4567"></div></div>' +
        '<div class="form-group" style="margin-bottom:0;margin-top:8px;position:relative"><label>Full Address</label><input type="text" id="lbPickupFullAddress" value="' + (o?.pickup_full_address || '') + '" placeholder="Full street address" autocomplete="off"></div></div>' +
        
        // Delivery Section
        '<div style="background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px"> DELIVERY</label>' +
        '<div class="form-row" style="gap:12px">' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>City/State</label><input type="text" id="lbDest" value="' + (o?.destination || '') + '" placeholder="Start typing city..." autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:0 0 140px"><label> Phone</label><input type="tel" id="lbDeliveryPhone" value="' + (o?.delivery_phone || '') + '" placeholder="(555) 123-4567"></div></div>' +
        '<div class="form-group" style="margin-bottom:0;margin-top:8px;position:relative"><label>Full Address</label><input type="text" id="lbDeliveryFullAddress" value="' + (o?.delivery_full_address || '') + '" placeholder="Full street address" autocomplete="off"></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Pick-Up Date</label><input type="date" id="lbPickup" value="' + (o?.pickup_date || '') + '"></div><div class="form-group"><label>Drop-Off Date</label><input type="date" id="lbDropoff" value="' + (o?.dropoff_date || '') + '"></div></div>' +
        
        // Payment Section with Split Payment
        '<div style="background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:16px"><label style="font-weight:600;margin-bottom:8px;display:block"> Payment</label>' +
        '<div class="form-row" style="gap:12px"><div class="form-group" style="margin-bottom:0"><label>Total Revenue $</label><input type="number" id="lbRevenue" value="' + (o?.revenue || '') + '" onchange="updateLBPaymentSplit()"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label>Payment Type</label><select id="lbPayment" onchange="toggleLBSplitPayment()"><option value="BILL"' + (o?.payment_type === 'BILL' ? ' selected' : '') + '>BILL (Invoice)</option><option value="COD"' + (o?.payment_type === 'COD' ? ' selected' : '') + '>COD (Cash on Delivery)</option><option value="COP"' + (o?.payment_type === 'COP' ? ' selected' : '') + '>COP (Cash on Pickup)</option><option value="LOCAL_COD"' + (o?.payment_type === 'LOCAL_COD' ? ' selected' : '') + '>LOCAL_COD (Local Driver)</option><option value="CHECK"' + (o?.payment_type === 'CHECK' ? ' selected' : '') + '>CHECK</option><option value="SPLIT"' + (o?.payment_type === 'SPLIT' ? ' selected' : '') + '>SPLIT (Multiple)</option></select></div></div>' +
        '<div id="lbSplitPaymentSection" style="display:' + (o?.payment_type === 'SPLIT' ? 'block' : 'none') + ';margin-top:12px;padding-top:12px;border-top:1px dashed var(--amber)">' +
        '<div class="form-row" style="grid-template-columns:1fr 1fr 1fr;gap:12px">' +
        '<div class="form-group" style="margin-bottom:0"><label>COD/COP Amount $</label><input type="number" id="lbSplitCodAmount" value="' + (o?.cod_amount || 0) + '" onchange="updateLBSplitBill()"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label>Bill Amount $</label><input type="number" id="lbSplitBillAmount" value="' + (o?.bill_amount || 0) + '" readonly style="background:var(--bg-card-hover)"></div>' +
        '</div></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Broker Fee $</label><input type="number" id="lbBrokerFee" value="' + (o?.broker_fee || 0) + '"></div><div class="form-group"><label>Local Fee $</label><input type="number" id="lbLocalFee" value="' + (o?.local_fee || 0) + '"></div></div>' +
        '<div class="form-group"><label> Notes for Dispatchers</label><textarea id="lbNotes" rows="2" placeholder="Add notes visible to all dispatchers..." style="resize:vertical">' + (o?.dispatcher_notes || '') + '</textarea></div>' +
        '<div class="form-group"><label>Booked By</label>' + 
        (currentUser.role === 'ADMIN' || currentUser.role === 'MANAGER' ? 
          '<select id="lbDispatcher"><option value="">Select Dispatcher</option>' + appData.dispatchers.map(d => '<option value="' + d.id + '"' + ((o?.dispatcher_id === d.id || (!o && userDispatcher && userDispatcher.id === d.id)) ? ' selected' : '') + '>' + d.name + '</option>').join('') + '</select>' :
          '<input type="text" id="lbDispatcherName" value="' + (userDispatcher ? userDispatcher.name : currentUser.first_name + ' ' + currentUser.last_name) + '" readonly style="background:var(--bg-card-hover);cursor:not-allowed"><input type="hidden" id="lbDispatcher" value="' + (userDispatcher ? userDispatcher.id : '') + '">'
        ) + '</div>' +
        
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveLoadBoardOrder(' + id + ')">' + (o ? 'Update' : 'Save') + '</button></div></div>';
      document.body.appendChild(m);
      
      // Setup broker autocomplete
      setupBrokerAutocomplete('lbBrokerInput');
      
      // Setup location autocomplete
      setupLocationAutocomplete('lbOrigin');
      setupLocationAutocomplete('lbDest');
      
      // Setup address autocomplete
      setupAddressAutocomplete('lbPickupFullAddress');
      setupAddressAutocomplete('lbDeliveryFullAddress');
      
      // Setup year autocomplete
      setupYearAutocomplete('lbYear');
      
      // Setup make autocomplete
      setupMakeAutocomplete('lbMake');
      
      // Setup model autocomplete (depends on make)
      setupModelAutocomplete('lbModel');
      
      // Initialize subcategory and set existing value if editing
      toggleLoadBoardSub();
      if (o?.load_subcategory) {
        setTimeout(() => {
          const subSelect = document.getElementById('lbSubCategory');
          if (subSelect) subSelect.value = o.load_subcategory;
        }, 100);
      }
    }
    
    // Vehicle list for Future Cars (multiple vehicles)
    let lbVehicleList = [];
    
    function addAnotherVehicleLB() {
      const year = document.getElementById('lbYear').value;
      const make = document.getElementById('lbMake').value;
      const model = document.getElementById('lbModel').value;
      
      if (!make || !model) {
        showToast('Please enter make and model first', 'error');
        return;
      }
      
      lbVehicleList.push({ year, make, model });
      updateLBVehicleListDisplay();
      
      // Clear inputs for next vehicle
      document.getElementById('lbYear').value = new Date().getFullYear();
      document.getElementById('lbMake').value = '';
      document.getElementById('lbModel').value = '';
      document.getElementById('lbMake').focus();
    }
    
    function updateLBVehicleListDisplay() {
      const section = document.getElementById('lbVehicleListSection');
      const container = document.getElementById('lbVehicleListItems');
      
      if (lbVehicleList.length === 0) {
        section.style.display = 'none';
        return;
      }
      
      section.style.display = 'block';
      const itemBg = 'var(--bg-card)';
      const itemBorder = 'var(--border)';
      container.innerHTML = '<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">' + lbVehicleList.length + ' vehicle(s) added:</div>' +
        lbVehicleList.map((v, i) => '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:' + itemBg + ';border-radius:6px;margin-bottom:4px;border:1px solid ' + itemBorder + '">' +
          '<span style="font-weight:500">' + v.year + ' ' + v.make + ' ' + v.model + '</span>' +
          '<button onclick="removeLBVehicle(' + i + ')" style="background:var(--red-dim);color:var(--red);border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px"></button></div>').join('');
    }
    
    function removeLBVehicle(index) {
      lbVehicleList.splice(index, 1);
      updateLBVehicleListDisplay();
    }
    
    function toggleLBSplitPayment() {
      const payType = document.getElementById('lbPayment').value;
      document.getElementById('lbSplitPaymentSection').style.display = payType === 'SPLIT' ? 'block' : 'none';
    }
    
    function updateLBPaymentSplit() {
      const total = parseFloat(document.getElementById('lbRevenue').value) || 0;
      const codAmount = parseFloat(document.getElementById('lbSplitCodAmount').value) || 0;
      document.getElementById('lbSplitBillAmount').value = Math.max(0, total - codAmount);
    }
    
    function updateLBSplitBill() {
      updateLBPaymentSplit();
    }

    function toggleLoadBoardSub() {
      const catSelect = document.getElementById('lbCategory');
      const subGroup = document.getElementById('lbSubGroup');
      const subSelect = document.getElementById('lbSubCategory');
      
      const selectedCat = loadBoardCategories.find(c => c.id === catSelect.value);
      
      if (selectedCat && selectedCat.subs.length > 0) {
        subGroup.style.display = 'block';
        subSelect.innerHTML = '<option value="">Select...</option>' + selectedCat.subs.map(s => '<option value="' + s.id + '">' + s.name + '</option>').join('');
      } else {
        subGroup.style.display = 'none';
        subSelect.innerHTML = '';
      }
    }

    async function saveLoadBoardOrder(id) {
      const loadCategory = document.getElementById('lbCategory').value;
      if (!loadCategory) { showToast('Please select a category', 'error'); return; }
      
      const subSelect = document.getElementById('lbSubCategory');
      const loadSubcategory = subSelect && subSelect.value ? subSelect.value : null;
      
      // Handle broker from autocomplete
      let brokerId = document.getElementById('lbBrokerId').value;
      let brokerName = document.getElementById('lbBrokerInput').value;
      
      // Check if we need to create a new broker
      if (brokerName && !brokerId) {
        const existingBroker = appData.brokers.find(b => b.name.toLowerCase() === brokerName.toLowerCase());
        if (existingBroker) {
          brokerId = existingBroker.id;
        } else {
          // Check if new broker section is visible
          const newBrokerName = document.getElementById('lbNewBrokerName')?.value?.trim();
          if (newBrokerName) {
            try {
              const newBroker = await dbInsert('brokers', { name: newBrokerName });
              brokerId = newBroker.id;
              brokerName = newBrokerName;
            } catch (e) { showToast('Failed to create broker', 'error'); return; }
          }
        }
      }
      
      // Get payment split data
      const paymentType = document.getElementById('lbPayment').value;
      const codAmount = paymentType === 'SPLIT' ? parseFloat(document.getElementById('lbSplitCodAmount').value) || 0 : null;
      const billAmount = paymentType === 'SPLIT' ? parseFloat(document.getElementById('lbSplitBillAmount').value) || 0 : null;
      
      // Get current vehicle from form
      const currentYear = document.getElementById('lbYear').value;
      const currentMake = document.getElementById('lbMake').value;
      const currentModel = document.getElementById('lbModel').value;
      
      // Build vehicles list - either the list or single vehicle
      let vehiclesToSave = [];
      if (lbVehicleList && lbVehicleList.length > 0) {
        vehiclesToSave = [...lbVehicleList];
        // Add current vehicle if filled
        if (currentMake && currentModel) {
          vehiclesToSave.push({ year: currentYear, make: currentMake, model: currentModel });
        }
      } else {
        if (!currentMake || !currentModel) {
          showToast('Please enter vehicle make and model', 'error');
          return;
        }
        vehiclesToSave.push({ year: currentYear, make: currentMake, model: currentModel });
      }
      
      const baseData = {
        order_number: document.getElementById('lbOrderNum').value,
        broker_id: brokerId ? parseInt(brokerId) : null,
        broker_name: brokerName || null,
        origin: document.getElementById('lbOrigin').value,
        destination: document.getElementById('lbDest').value,
        pickup_phone: document.getElementById('lbPickupPhone')?.value || null,
        delivery_phone: document.getElementById('lbDeliveryPhone')?.value || null,
        pickup_full_address: document.getElementById('lbPickupFullAddress')?.value || null,
        delivery_full_address: document.getElementById('lbDeliveryFullAddress')?.value || null,
        pickup_date: document.getElementById('lbPickup').value || null,
        dropoff_date: document.getElementById('lbDropoff').value || null,
        revenue: parseFloat(document.getElementById('lbRevenue').value) || 0,
        broker_fee: parseFloat(document.getElementById('lbBrokerFee').value) || 0,
        local_fee: parseFloat(document.getElementById('lbLocalFee').value) || 0,
        payment_type: paymentType,
        cod_amount: codAmount,
        bill_amount: billAmount,
        load_category: loadCategory,
        load_subcategory: loadSubcategory,
        dispatcher_id: document.getElementById('lbDispatcher').value ? parseInt(document.getElementById('lbDispatcher').value) : null,
        dispatcher_notes: document.getElementById('lbNotes').value || null,
        trip_id: null,
        status: 'PENDING'
      };
      
      try {
        if (id) {
          // Editing single vehicle
          const data = { ...baseData, vehicle_year: parseInt(vehiclesToSave[0].year), vehicle_make: vehiclesToSave[0].make, vehicle_model: vehiclesToSave[0].model };
          await dbUpdate('orders', id, data);
          showToast('Vehicle updated!');
        } else {
          // Creating new - possibly multiple vehicles
          // Revenue/fees apply to ORDER as whole, stored only on FIRST vehicle
          const orderGroupId = baseData.order_number;
          
          for (let i = 0; i < vehiclesToSave.length; i++) {
            const v = vehiclesToSave[i];
            const data = { 
              ...baseData, 
              vehicle_year: parseInt(v.year), 
              vehicle_make: v.make, 
              vehicle_model: v.model,
              order_number: vehiclesToSave.length > 1 ? baseData.order_number + '-' + (i + 1) : baseData.order_number,
              order_group_id: orderGroupId,
              // Only first vehicle gets revenue/fees
              revenue: i === 0 ? baseData.revenue : 0,
              broker_fee: i === 0 ? baseData.broker_fee : 0,
              local_fee: i === 0 ? baseData.local_fee : 0,
              cod_amount: i === 0 ? baseData.cod_amount : 0,
              bill_amount: i === 0 ? baseData.bill_amount : 0
            };
            await dbInsert('orders', data);
          }
          const totalRev = baseData.revenue || 0;
          showToast(vehiclesToSave.length > 1 ? vehiclesToSave.length + ' vehicles added! Order total: $' + totalRev : 'Vehicle saved!');
        }
        
        // Reset vehicle list
        lbVehicleList = [];
        
        document.querySelector('.modal-overlay').remove();
        await loadAllData(true);
        renderLoadBoard(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteLoadBoardOrder(id) {
      if (!confirm('Delete this vehicle?')) return;
      try {
        await dbDelete('orders', id);
        showToast('Deleted');
        await loadAllData(true);
        renderLoadBoard(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    // ============ IMPORT LOAD FUNCTION ============
    function openImportLoad() {
      const m = document.createElement('div'); 
      m.className = 'modal-overlay'; 
      m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:800px;max-height:95vh;display:flex;flex-direction:column"><div class="modal-header" style="background:var(--purple);color:white"><h3 style="margin:0"> Import Load from Rate Confirmation</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()" style="color:white"></button></div><div class="modal-body" style="overflow-y:auto;flex:1;padding:20px">' +
        
        // Step 1: Paste Rate Confirmation
        '<div id="importStep1">' +
        '<div style="background:var(--purple-dim);padding:var(--spacing-4);border-radius:var(--radius);margin-bottom:16px">' +
        '<div style="font-weight:600;color:var(--purple);margin-bottom:8px">Step 1: Paste Rate Confirmation</div>' +
        '<div style="color:var(--text-secondary);font-size:13px">Copy the text from your rate confirmation email or document and paste it below. AI will extract all vehicle and order information.</div></div>' +
        '<div class="form-group"><textarea id="importRateText" rows="10" placeholder="Paste rate confirmation text here...\n\nExample:\nOrder #12345\nBroker: ABC Transport\n2024 BMW X5\nPickup: New York, NY\nDelivery: Los Angeles, CA\nRate: $1,200\n..." style="resize:vertical;width:100%;font-family:monospace;font-size:13px"></textarea></div>' +
        '<button class="btn" style="background:var(--purple);color:white;width:100%" onclick="extractLoadInfo()"> Extract Information</button>' +
        '</div>' +
        
        // Step 2: Preview & Category (hidden initially)
        '<div id="importStep2" style="display:none">' +
        '<div style="background:var(--green-dim);padding:var(--spacing-4);border-radius:var(--radius);margin-bottom:16px">' +
        '<div style="font-weight:600;color:var(--green);margin-bottom:8px"> Step 2: Review & Assign Category</div>' +
        '<div style="color:var(--text-secondary);font-size:13px">Review the extracted information, select the correct category, and adjust any fields if needed.</div></div>' +
        
        // Category Selection
        '<div style="background:var(--amber-dim);padding:var(--spacing-4);border-radius:var(--radius);margin-bottom:16px">' +
        '<div class="form-row"><div class="form-group" style="margin-bottom:0"><label style="font-weight:600"> Category *</label><select id="importCategory" onchange="toggleImportSubcategory()" style="border:2px solid var(--amber);font-weight:600">' + loadBoardCategories.map(cat => '<option value="' + cat.id + '">' + cat.name + '</option>').join('') + '</select></div>' +
        '<div class="form-group" style="margin-bottom:0" id="importSubGroup"><label style="font-weight:600">Sub-Category</label><select id="importSubCategory"></select></div></div></div>' +
        
        // Extracted Info Preview
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">' +
        
        // Left Column - Order & Vehicle
        '<div>' +
        '<div style="background:var(--bg-app);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px"> Order Info</label>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Order #</label><input type="text" id="importOrderNum" style="font-size:14px"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Broker</label><input type="text" id="importBroker" style="font-size:14px"></div></div>' +
        
        '<div style="background:var(--bg-app);padding:var(--spacing-3);border-radius:var(--radius)">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px"> Vehicle</label>' +
        '<div class="form-row" style="gap:8px"><div class="form-group" style="margin-bottom:8px;flex:0 0 80px"><label style="font-size:12px">Year</label><input type="text" id="importYear" style="font-size:14px"></div>' +
        '<div class="form-group" style="margin-bottom:8px;flex:1"><label style="font-size:12px">Make</label><input type="text" id="importMake" style="font-size:14px"></div></div>' +
        '<div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Model</label><input type="text" id="importModel" style="font-size:14px"></div></div>' +
        '</div>' +
        
        // Right Column - Locations & Payment
        '<div>' +
        '<div style="background:var(--blue-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px"> Pickup</label>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">City, State</label><input type="text" id="importOrigin" style="font-size:14px"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Phone</label><input type="text" id="importPickupPhone" style="font-size:14px"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Date</label><input type="date" id="importPickupDate" style="font-size:14px"></div></div>' +
        
        '<div style="background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px"> Delivery</label>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">City, State</label><input type="text" id="importDestination" style="font-size:14px"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Phone</label><input type="text" id="importDeliveryPhone" style="font-size:14px"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Date</label><input type="date" id="importDeliveryDate" style="font-size:14px"></div></div>' +
        '</div></div>' +
        
        // Payment Row
        '<div style="background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-top:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px"> Payment</label>' +
        '<div class="form-row" style="gap:12px">' +
        '<div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Revenue $</label><input type="number" id="importRevenue" style="font-size:14px"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Payment Type</label><select id="importPaymentType" style="font-size:14px"><option value="BILL">BILL</option><option value="COD">COD</option><option value="COP">COP</option><option value="LOCAL_COD">LOCAL_COD</option><option value="CHECK">CHECK</option><option value="SPLIT">SPLIT</option></select></div>' +
        '<div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Broker Fee $</label><input type="number" id="importBrokerFee" value="0" style="font-size:14px"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Local Fee $</label><input type="number" id="importLocalFee" value="0" style="font-size:14px"></div>' +
        '</div></div>' +
        
        // Notes
        '<div class="form-group" style="margin-top:12px"><label style="font-size:12px"> Notes</label><textarea id="importNotes" rows="2" style="font-size:14px"></textarea></div>' +
        
        // Back button
        '<button class="btn btn-secondary" style="margin-top:12px" onclick="document.getElementById(\'importStep1\').style.display=\'block\';document.getElementById(\'importStep2\').style.display=\'none\'"> Back to Edit Text</button>' +
        '</div>' +
        
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn" style="background:var(--purple);color:white" id="importSaveBtn" onclick="saveImportedLoad()" disabled>Import to Future Cars</button></div></div>';
      document.body.appendChild(m);
      toggleImportSubcategory();
    }

    function toggleImportSubcategory() {
      const catSelect = document.getElementById('importCategory');
      const subGroup = document.getElementById('importSubGroup');
      const subSelect = document.getElementById('importSubCategory');
      const cat = loadBoardCategories.find(c => c.id === catSelect.value);
      
      if (cat && cat.subs && cat.subs.length > 0) {
        subGroup.style.display = 'block';
        subSelect.innerHTML = '<option value="">-- None --</option>' + cat.subs.map(s => '<option value="' + s.id + '">' + s.name + '</option>').join('');
      } else {
        subGroup.style.display = 'none';
        subSelect.innerHTML = '';
      }
    }

    async function extractLoadInfo() {
      const rateText = document.getElementById('importRateText').value.trim();
      if (!rateText) {
        showToast('Please paste the rate confirmation text', 'error');
        return;
      }

      // Check if API key is configured
      const apiKey = getApiKey();
      if (!apiKey) {
        showToast('Please add your Anthropic API key in Settings first', 'error');
        return;
      }

      // Show loading state
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = ' Extracting...';
      btn.disabled = true;
      
      try {
        // Call Anthropic API to extract information
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': getApiKey(),
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1024,
            messages: [{
              role: 'user',
              content: `Extract the following information from this rate confirmation. Return ONLY a JSON object with these exact fields (use null for missing values):

{
  "order_number": "string or null",
  "broker_name": "string or null", 
  "vehicle_year": "number or null",
  "vehicle_make": "string or null",
  "vehicle_model": "string or null",
  "origin_city_state": "string like 'New York, NY' or null",
  "destination_city_state": "string like 'Los Angeles, CA' or null",
  "pickup_phone": "string or null",
  "delivery_phone": "string or null",
  "pickup_date": "string in YYYY-MM-DD format or null",
  "delivery_date": "string in YYYY-MM-DD format or null",
  "revenue": "number or null",
  "payment_type": "BILL or COD or COP or LOCAL_COD or CHECK or null",
  "broker_fee": "number or null",
  "notes": "string with special instructions or null"
}

Rate Confirmation Text:
${rateText}`
            }]
          })
        });
        
        if (!response.ok) {
          throw new Error('API request failed');
        }
        
        const data = await response.json();
        const content = data.content[0].text;
        
        // Parse JSON from response
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (!jsonMatch) {
          throw new Error('Could not parse response');
        }
        
        const extracted = JSON.parse(jsonMatch[0]);
        
        // Populate form fields
        document.getElementById('importOrderNum').value = extracted.order_number || 'ORD-' + Date.now().toString().slice(-4);
        document.getElementById('importBroker').value = extracted.broker_name || '';
        document.getElementById('importYear').value = extracted.vehicle_year || new Date().getFullYear();
        document.getElementById('importMake').value = extracted.vehicle_make || '';
        document.getElementById('importModel').value = extracted.vehicle_model || '';
        document.getElementById('importOrigin').value = extracted.origin_city_state || '';
        document.getElementById('importDestination').value = extracted.destination_city_state || '';
        document.getElementById('importPickupPhone').value = extracted.pickup_phone || '';
        document.getElementById('importDeliveryPhone').value = extracted.delivery_phone || '';
        document.getElementById('importPickupDate').value = extracted.pickup_date || '';
        document.getElementById('importDeliveryDate').value = extracted.delivery_date || '';
        document.getElementById('importRevenue').value = extracted.revenue || '';
        const validPaymentTypes = ['BILL', 'COD', 'COP', 'LOCAL_COD', 'CHECK', 'SPLIT'];
        const extractedPayment = extracted.payment_type?.toUpperCase();
        document.getElementById('importPaymentType').value = validPaymentTypes.includes(extractedPayment) ? extractedPayment : 'BILL';
        document.getElementById('importBrokerFee').value = extracted.broker_fee || 0;
        document.getElementById('importNotes').value = extracted.notes || '';
        
        // Show step 2
        document.getElementById('importStep1').style.display = 'none';
        document.getElementById('importStep2').style.display = 'block';
        document.getElementById('importSaveBtn').disabled = false;
        
        showToast('Information extracted! Please review and select category.');
        
      } catch (e) {
        console.error('Extraction error:', e);
        showToast('Failed to extract: ' + e.message, 'error');
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    async function saveImportedLoad() {
      const category = document.getElementById('importCategory').value;
      const subcategory = document.getElementById('importSubCategory')?.value || null;
      
      // Find dispatcher for current user
      let userDispatcher = appData.dispatchers.find(d => d.user_id === currentUser.id);
      if (!userDispatcher) {
        userDispatcher = appData.dispatchers.find(d => d.email && d.email.toLowerCase() === currentUser.email.toLowerCase());
      }
      
      // Validate payment type
      const validPaymentTypes = ['BILL', 'COD', 'COP', 'LOCAL_COD', 'CHECK', 'SPLIT'];
      const selectedPayment = document.getElementById('importPaymentType').value;
      const paymentType = validPaymentTypes.includes(selectedPayment) ? selectedPayment : 'BILL';
      
      const orderData = {
        order_number: document.getElementById('importOrderNum').value || 'ORD-' + Date.now().toString().slice(-4),
        broker_name: document.getElementById('importBroker').value || null,
        vehicle_year: parseInt(document.getElementById('importYear').value) || new Date().getFullYear(),
        vehicle_make: document.getElementById('importMake').value || '',
        vehicle_model: document.getElementById('importModel').value || '',
        origin: document.getElementById('importOrigin').value || '',
        destination: document.getElementById('importDestination').value || '',
        pickup_phone: document.getElementById('importPickupPhone').value || null,
        delivery_phone: document.getElementById('importDeliveryPhone').value || null,
        pickup_date: document.getElementById('importPickupDate').value || null,
        dropoff_date: document.getElementById('importDeliveryDate').value || null,
        revenue: parseFloat(document.getElementById('importRevenue').value) || 0,
        payment_type: paymentType,
        broker_fee: parseFloat(document.getElementById('importBrokerFee').value) || 0,
        local_fee: parseFloat(document.getElementById('importLocalFee').value) || 0,
        dispatcher_notes: document.getElementById('importNotes').value || null,
        load_category: category,
        load_subcategory: subcategory,
        status: 'PENDING',
        trip_id: null,
        dispatcher_id: userDispatcher?.id || null
      };
      
      try {
        await dbInsert('orders', orderData);
        await logActivity('LOAD_IMPORTED', { order_number: orderData.order_number, category: category, vehicle: orderData.vehicle_year + ' ' + orderData.vehicle_make + ' ' + orderData.vehicle_model });
        document.querySelector('.modal-overlay').remove();
        showToast(' Load imported to ' + loadBoardCategories.find(c => c.id === category)?.name + '!');
        await loadAllData(true);
        
        // Switch to the imported category
        selectedLoadCategory = category;
        selectedLoadSub = subcategory;
        renderLoadBoard(document.getElementById('main-content'));
      } catch (e) {
        showToast('Failed to import: ' + e.message, 'error');
      }
    }

    function openAssignToTrip(orderId) {
      const o = appData.orders.find(x => x.id === orderId);
      const isHomeToNY = o.load_category === 'home_to_ny';
      
      // Build direction options
      const directionOptions = vehicleDirections.map(d => 
        '<option value="' + d.id + '"' + (o.vehicle_direction === d.id ? ' selected' : '') + '>' + d.label + '</option>'
      ).join('');
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3>Assign Vehicle</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div style="background:var(--bg-card-hover);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:16px"><strong>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</strong><br><span style="color:var(--text-muted)">' + o.origin + '  ' + o.destination + '</span></div>' +
        
        // Assignment type tabs (only show for Home to NY)
        (isHomeToNY ? '<div style="display:flex;gap:8px;margin-bottom:16px">' +
        '<button id="assignTypeTrip" onclick="toggleAssignType(\'trip\')" style="flex:1;padding:12px;border:2px solid var(--blue);background:var(--blue);color:white;border-radius:8px;font-weight:600;cursor:pointer"> Assign to Trip</button>' +
        '<button id="assignTypeLocal" onclick="toggleAssignType(\'local\')" style="flex:1;padding:12px;border:2px solid var(--purple);background:var(--bg-card);color:var(--purple);border-radius:8px;font-weight:600;cursor:pointer"> Assign to Local Driver</button>' +
        '</div>' : '') +
        
        // Trip selection (shown by default)
        '<div id="tripAssignSection">' +
        // Direction selection (NEW)
        '<div class="form-group"><label> Vehicle Direction</label><select id="assignDirectionSelect" style="border-color:var(--amber)">' +
        '<option value="">-- Select Direction --</option>' + directionOptions + '</select>' +
        '<p style="font-size:var(--text-xs);color:var(--text-muted);margin-top:4px">Choose the route direction for this vehicle</p></div>' +
        // Trip selection
        '<div class="form-group"><label>Select Trip</label><select id="assignTripSelect"><option value="">Select a trip...</option>' + 
        appData.trips.filter(t => t.status !== 'COMPLETED').map(t => {
          const truck = appData.trucks.find(tr => tr.id === t.truck_id);
          const driver = appData.drivers.find(d => d.id === t.driver_id);
          const orderCount = appData.orders.filter(ord => ord.trip_id === t.id).length;
          return '<option value="' + t.id + '">' + t.trip_number + ' - ' + (truck ? 'Truck #' + truck.truck_number : 'No truck') + ' - ' + (driver ? driver.first_name : 'No driver') + ' (' + orderCount + ' cars)</option>';
        }).join('') + '</select></div>' +
        '</div>' +
        
        // Local Driver selection (hidden by default, only for Home to NY)
        (isHomeToNY ? '<div id="localAssignSection" style="display:none">' +
        '<div class="form-group"><label>Select Local Driver</label><select id="assignLocalSelect"><option value="">Select a local driver...</option>' + 
        (appData.local_drivers || []).map(ld => {
          const assignedCount = appData.orders.filter(ord => ord.local_driver_id === ld.id && !ord.trip_id).length;
          return '<option value="' + ld.id + '">' + ld.name + (ld.phone ? ' (' + ld.phone + ')' : '') + ' - ' + assignedCount + ' cars assigned</option>';
        }).join('') + '</select></div>' +
        '<div class="form-group"><label>Local Driver Fee $ <span style="color:var(--text-muted);font-weight:normal">(optional)</span></label><input type="number" id="localDriverFee" value="' + (o.local_fee || 0) + '" placeholder="0"></div>' +
        '</div>' : '') +
        
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" id="assignBtn" onclick="assignOrderToTrip(' + orderId + ')">Assign to Trip</button></div></div>';
      document.body.appendChild(m);
    }
    
    let currentAssignType = 'trip';
    
    function toggleAssignType(type) {
      currentAssignType = type;
      const tripBtn = document.getElementById('assignTypeTrip');
      const localBtn = document.getElementById('assignTypeLocal');
      const tripSection = document.getElementById('tripAssignSection');
      const localSection = document.getElementById('localAssignSection');
      const assignBtn = document.getElementById('assignBtn');
      
      if (type === 'trip') {
        tripBtn.style.background = 'var(--blue)';
        tripBtn.style.color = 'white';
        localBtn.style.background = 'white';
        localBtn.style.color = 'var(--purple)';
        tripSection.style.display = 'block';
        localSection.style.display = 'none';
        assignBtn.textContent = 'Assign to Trip';
        assignBtn.onclick = () => assignOrderToTrip(parseInt(assignBtn.closest('.modal').querySelector('[onclick*="assignOrderToTrip"]')?.getAttribute('onclick')?.match(/\d+/)?.[0]));
      } else {
        tripBtn.style.background = 'white';
        tripBtn.style.color = 'var(--blue)';
        localBtn.style.background = 'var(--purple)';
        localBtn.style.color = 'white';
        tripSection.style.display = 'none';
        localSection.style.display = 'block';
        assignBtn.textContent = 'Assign to Local Driver';
      }
    }

    async function assignOrderToTrip(orderId) {
      if (currentAssignType === 'local') {
        // Assign to Local Driver
        const localDriverId = parseInt(document.getElementById('assignLocalSelect').value);
        const localFee = parseFloat(document.getElementById('localDriverFee').value) || 0;
        
        if (!localDriverId) { showToast('Please select a local driver', 'error'); return; }
        
        try {
          await dbUpdate('orders', orderId, { 
            local_driver_id: localDriverId, 
            local_fee: localFee,
            load_category: null, 
            load_subcategory: null 
          });
          document.querySelector('.modal-overlay').remove();
          showToast('Vehicle assigned to local driver!');
          await loadAllData(true);
          renderLoadBoard(document.getElementById('main-content'));
        } catch (e) { showToast(e.message, 'error'); }
      } else {
        // Assign to Trip (original behavior)
        const tripId = parseInt(document.getElementById('assignTripSelect').value);
        const direction = document.getElementById('assignDirectionSelect')?.value || null;
        
        if (!tripId) { showToast('Please select a trip', 'error'); return; }
        if (!direction) { showToast('Please select a vehicle direction', 'error'); return; }
        
        try {
          const selectedTrip = appData.trips.find(t => t.id === tripId);
          const orderData = appData.orders.find(o => o.id === orderId);
          await dbUpdate('orders', orderId, {
            trip_id: tripId,
            driver_id: selectedTrip?.driver_id || null,
            vehicle_direction: direction,
            load_category: null,
            load_subcategory: null
          });

          // Notify driver about new vehicle assignment
          if (selectedTrip?.driver_id && orderData) {
            try {
              await dbInsert('driver_notifications', {
                driver_id: selectedTrip.driver_id,
                type: 'trip_assigned',
                title: 'New Vehicle Assigned',
                body: `${orderData.vehicle_year || ''} ${orderData.vehicle_make || ''} ${orderData.vehicle_model || ''} assigned to trip ${selectedTrip.trip_number}`.trim(),
                order_id: orderId,
                trip_id: tripId,
                is_read: false
              });
            } catch (e) { /* silent */ }
          }

          document.querySelector('.modal-overlay').remove();
          showToast('Vehicle assigned to trip!');
          await loadAllData(true);
          renderLoadBoard(document.getElementById('main-content'));
        } catch (e) { showToast(e.message, 'error'); }
      }
      
      // Reset for next time
      currentAssignType = 'trip';
    }

    async function unassignOrderFromTrip(orderId) {
      const o = appData.orders.find(x => x.id === orderId);
      if (!o) { showToast('Order not found', 'error'); return; }

      if (!confirm('Unassign this vehicle from trip ' + (appData.trips.find(t => t.id === o.trip_id)?.trip_number || '') + '?')) {
        return;
      }

      try {
        await dbUpdate('orders', orderId, {
          trip_id: null,
          driver_id: null,
          vehicle_direction: null,
          pickup_sequence: null,
          delivery_sequence: null
        });
        showToast('Vehicle unassigned from trip!');
        await loadAllData(true);
        renderOrders(document.getElementById('ordersPage'));
      } catch (e) {
        showToast(e.message, 'error');
      }
    }

    let selectedTruckTab = null;
    // Trips page year filter (default to current year)
    let tripsYear = new Date().getFullYear();
    // Trips status filter: 'active', 'completed', 'all'
    let tripStatusFilter = 'active';

    function renderTrips(c) {
      // Clear detail view flag when going back to trips list
      currentDetailView = null;

      // Year filter for trips
      const yearStart = tripsYear + '-01-01';
      const yearEnd = tripsYear + '-12-31';
      let yearFilteredTrips = appData.trips.filter(t => t.trip_date >= yearStart && t.trip_date <= yearEnd);

      // Status filter counts (before applying status filter)
      const activeCount = yearFilteredTrips.filter(t => t.status !== 'COMPLETED').length;
      const completedCount = yearFilteredTrips.filter(t => t.status === 'COMPLETED').length;
      const allCount = yearFilteredTrips.length;

      // Apply status filter
      if (tripStatusFilter === 'active') {
        yearFilteredTrips = yearFilteredTrips.filter(t => t.status !== 'COMPLETED');
      } else if (tripStatusFilter === 'completed') {
        yearFilteredTrips = yearFilteredTrips.filter(t => t.status === 'COMPLETED');
      }

      // Get trucks that have trips or are active
      const trucksWithTrips = appData.trucks.filter(t => t.status === 'ACTIVE' || yearFilteredTrips.some(tr => tr.truck_id === t.id)).sort((a,b) => String(a.truck_number).localeCompare(String(b.truck_number)));

      // If no truck selected, select first one
      if (!selectedTruckTab && trucksWithTrips.length > 0) {
        selectedTruckTab = trucksWithTrips[0].id;
      }

      // Get trips for selected truck (filtered by year)
      const truckTrips = selectedTruckTab ? yearFilteredTrips.filter(t => t.truck_id === selectedTruckTab).sort((a,b) => new Date(b.trip_date) - new Date(a.trip_date)) : [];
      const selectedTruck = appData.trucks.find(t => t.id === selectedTruckTab);

      // Build truck tabs (showing year-filtered trip counts)
      const truckTabs = trucksWithTrips.map(t => {
        const tripCount = yearFilteredTrips.filter(tr => tr.truck_id === t.id).length;
        const isActive = t.id === selectedTruckTab;
        const inactiveBg = 'var(--bg-card)';
        const inactiveColor = 'var(--text-secondary)';
        const inactiveBorder = 'var(--border)';
        const badgeBg = isActive ? 'rgba(255,255,255,0.2)' : 'var(--bg-elevated)';
        return '<button class="truck-tab" onclick="selectedTruckTab=' + t.id + ';renderTrips(document.getElementById(\'main-content\'))" style="padding:var(--spacing-2-5) var(--spacing-4);border:2px solid ' + (isActive ? 'var(--blue)' : inactiveBorder) + ';cursor:pointer;font-weight:var(--weight-semibold);border-radius:var(--radius);margin:var(--spacing-1);transition:all 0.2s;background:' + (isActive ? 'var(--blue)' : inactiveBg) + ';color:' + (isActive ? 'white' : inactiveColor) + '"> ' + t.truck_number + ' <span style="background:' + badgeBg + ';padding:var(--spacing-0-5) var(--spacing-2);border-radius:var(--radius-full);font-size:var(--text-xs);margin-left:4px">' + tripCount + '</span></button>';
      }).join('');
      
      // Build trip rows
      let tripRows = '';
      truckTrips.forEach(trip => {
        const orders = appData.orders.filter(o => o.trip_id === trip.id);
        const driver = appData.drivers.find(d => d.id === trip.driver_id);
        const driverName = driver ? driver.first_name + ' ' + driver.last_name : '-';
        const f = getTripFin(trip.id);
        const completeBtn = trip.status !== 'COMPLETED' ? '<button class="action-btn" style="background:var(--green);color:white" onclick="event.stopPropagation();markTripCompleted(' + trip.id + ',true)"></button>' : '';
        
        tripRows += '<tr><td><strong>' + trip.trip_number + '</strong></td><td>' + formatDate(trip.trip_date) + '</td><td>' + orders.length + '</td><td>' + driverName + '</td><td class="money">' + formatMoney(f.loadRevenue) + '</td><td><span class="badge ' + getBadge(trip.status) + '">' + trip.status + '</span></td><td class="sticky-col"><div class="actions">' + completeBtn + '<button class="action-btn view" onclick="viewTrip(' + trip.id + ')">View</button><button class="action-btn edit" onclick="openTripModal(' + trip.id + ')">Edit</button><button class="action-btn delete" onclick="deleteTrip(' + trip.id + ')">Del</button></div></td></tr>';
      });
      
      // Year selector options for Trips page
      const currentYear = new Date().getFullYear();
      const tripsYearOptions = [currentYear, currentYear - 1, currentYear - 2, currentYear - 3].map(y =>
        '<option value="' + y + '"' + (tripsYear === y ? ' selected' : '') + '>' + y + '</option>'
      ).join('');

      // Status filter tabs
      const statusTabStyle = (isActive) => 'padding:var(--spacing-2) var(--spacing-4);border:none;cursor:pointer;font-weight:var(--weight-semibold);border-radius:var(--radius);transition:all 0.2s;background:' + (isActive ? 'var(--blue)' : 'var(--bg-card-hover)') + ';color:' + (isActive ? 'white' : 'var(--text-secondary)');
      const statusTabs = '<div style="display:flex;gap:var(--spacing-2);margin-bottom:var(--spacing-4)">' +
        '<button onclick="tripStatusFilter=\'active\';renderTrips(document.getElementById(\'main-content\'))" style="' + statusTabStyle(tripStatusFilter === 'active') + '">Active <span style="background:' + (tripStatusFilter === 'active' ? 'rgba(255,255,255,0.2)' : 'var(--bg-elevated)') + ';padding:var(--spacing-0-5) var(--spacing-2);border-radius:var(--radius-full);font-size:var(--text-xs);margin-left:4px">' + activeCount + '</span></button>' +
        '<button onclick="tripStatusFilter=\'completed\';renderTrips(document.getElementById(\'main-content\'))" style="' + statusTabStyle(tripStatusFilter === 'completed') + '">Completed <span style="background:' + (tripStatusFilter === 'completed' ? 'rgba(255,255,255,0.2)' : 'var(--bg-elevated)') + ';padding:var(--spacing-0-5) var(--spacing-2);border-radius:var(--radius-full);font-size:var(--text-xs);margin-left:4px">' + completedCount + '</span></button>' +
        '<button onclick="tripStatusFilter=\'all\';renderTrips(document.getElementById(\'main-content\'))" style="' + statusTabStyle(tripStatusFilter === 'all') + '">All <span style="background:' + (tripStatusFilter === 'all' ? 'rgba(255,255,255,0.2)' : 'var(--bg-elevated)') + ';padding:var(--spacing-0-5) var(--spacing-2);border-radius:var(--radius-full);font-size:var(--text-xs);margin-left:4px">' + allCount + '</span></button>' +
        '</div>';

      c.innerHTML = '<div class="header"><h2> Trips by Truck</h2><div style="display:flex;align-items:center;gap:12px"><div style="display:flex;align-items:center;gap:8px;background:var(--bg-app);padding:var(--spacing-2) var(--spacing-3);border-radius:var(--radius)"><label style="font-weight:600;color:var(--text-secondary);font-size:var(--text-sm)">Year:</label><select onchange="tripsYear=parseInt(this.value);renderTrips(document.getElementById(\'main-content\'))" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:14px">' + tripsYearOptions + '</select></div><button class="btn btn-primary" onclick="openTripModal()">+ New Trip</button></div></div>' +
        statusTabs +
        '<div style="display:flex;flex-wrap:wrap;margin-bottom:16px">' + truckTabs + '</div>' +
        '<div class="card"><div style="padding:var(--spacing-4);background:var(--bg-app);border-bottom:1px solid var(--border)"><div><strong style="font-size:var(--text-lg)">TRUCK ' + (selectedTruck ? selectedTruck.truck_number : '-') + '</strong><span style="color:var(--text-muted);margin-left:var(--spacing-3)">' + truckTrips.length + ' trips | Home: Fairless Hills, PA</span></div></div><div class="table-wrapper"><table><thead><tr><th>Trip #</th><th>Date</th><th>Cars</th><th>Driver</th><th>Revenue</th><th>Status</th><th class="sticky-col">Actions</th></tr></thead><tbody>' + 
        (tripRows || '<tr><td colspan="7" style="text-align:center;padding:var(--spacing-10)">No trips for this truck yet</td></tr>') + 
        '</tbody></table></div></div>';
    }

    function openTripModal(id = null) {
      const t = id ? appData.trips.find(x => x.id === id) : null;
      // Track editing start time for conflict detection
      if (t) startEditing('trips', id, t.updated_at);
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) { clearEditing('trips', id); m.remove(); } };
      const today = new Date().toISOString().split('T')[0];
      const periodStart = t?.period_start_date || t?.trip_date || today;
      const periodEnd = t?.period_end_date || '';
      m.innerHTML = '<div class="modal"><div class="modal-header"><h3>' + (t ? 'Edit' : 'New') + ' Trip</h3><button class="modal-close" onclick="clearEditing(\'trips\',' + id + ');this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body"><div class="form-row"><div class="form-group"><label>Truck (select first)</label><select id="tripTruck" onchange="updateTripNumber(' + id + ')"><option value="">Select Truck</option>' + appData.trucks.filter(x => x.status === 'ACTIVE').map(x => '<option value="' + x.id + '" data-num="' + x.truck_number + '"' + (t?.truck_id === x.id ? ' selected' : '') + '>#' + x.truck_number + '</option>').join('') + '</select></div><div class="form-group"><label>Trip Number</label><input id="tripNumber" value="' + (t?.trip_number || '') + '" readonly style="background:var(--bg-card-hover)"></div></div><div class="form-row"><div class="form-group"><label>Date</label><input type="date" id="tripDate" value="' + (t?.trip_date || today) + '"></div><div class="form-group"><label>Status</label><select id="tripStatus"><option value="PLANNED"' + (t?.status === 'PLANNED' ? ' selected' : '') + '>Planned</option><option value="IN_PROGRESS"' + (t?.status === 'IN_PROGRESS' ? ' selected' : '') + '>In Progress</option><option value="COMPLETED"' + (t?.status === 'COMPLETED' ? ' selected' : '') + '>Completed</option></select></div></div><div class="form-row"><div class="form-group"><label>Driver</label><select id="tripDriver" onchange="updateDriverCut()"><option value="">Select</option>' + appData.drivers.filter(d => d.status === 'ACTIVE').map(d => '<option value="' + d.id + '" data-cut="' + (d.cut_percent || 32) + '"' + (t?.driver_id === d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('') + '</select></div><div class="form-group"><label>Driver Cut %</label><input type="number" id="tripCut" value="' + (t?.driver_cut_percent || 32) + '"></div></div><div style="border-top:1px solid var(--border);margin:16px 0;padding-top:16px"><div style="font-weight:600;color:var(--text-secondary);margin-bottom:12px"> Pay Period</div><div class="form-row"><div class="form-group"><label>Period Start</label><input type="date" id="tripPeriodStart" value="' + periodStart + '"></div><div class="form-group"><label>Period End</label><input type="date" id="tripPeriodEnd" value="' + periodEnd + '" placeholder="Set when completed"></div></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="clearEditing(\'trips\',' + id + ');this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveTrip(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
      if (!id && t === null) { document.getElementById('tripNumber').value = ''; }
      else if (t?.truck_id) { updateTripNumber(id); }
    }
    
    function updateDriverCut() {
      const driverSelect = document.getElementById('tripDriver');
      const cutInput = document.getElementById('tripCut');
      const selectedOption = driverSelect.options[driverSelect.selectedIndex];
      
      if (selectedOption && selectedOption.value) {
        const driverCut = selectedOption.getAttribute('data-cut');
        if (driverCut) {
          cutInput.value = driverCut;
        }
      }
    }

    function getNextTripNumberForTruck(truckId, excludeTripId = null) {
      const truck = appData.trucks.find(t => t.id === truckId);
      if (!truck) return '';
      const truckNum = truck.truck_number;
      const currentYear = new Date().getFullYear();
      
      // Find all trips for this truck in the current year and extract their sequence numbers
      const truckTrips = appData.trips.filter(t => t.truck_id === truckId && t.id !== excludeTripId);
      let maxSeq = 0;
      
      truckTrips.forEach(trip => {
        // Parse trip number like "TRIP 5 - 77 - 2025" to get sequence 5
        const match = trip.trip_number.match(/TRIP\s*(\d+)\s*-\s*(\d+)\s*-\s*(\d{4})/i);
        if (match) {
          const seq = parseInt(match[1]);
          const year = parseInt(match[3]);
          // Only count trips from current year
          if (year === currentYear && seq > maxSeq) maxSeq = seq;
        }
      });
      
      return 'TRIP ' + (maxSeq + 1) + ' - ' + truckNum + ' - ' + currentYear;
    }

    function updateTripNumber(editingTripId) {
      const truckSelect = document.getElementById('tripTruck');
      const tripNumberInput = document.getElementById('tripNumber');
      const truckId = parseInt(truckSelect.value);
      
      if (!truckId) {
        tripNumberInput.value = '';
        return;
      }
      
      // If editing existing trip with same truck, keep the number
      if (editingTripId) {
        const existingTrip = appData.trips.find(t => t.id === editingTripId);
        if (existingTrip && existingTrip.truck_id === truckId) {
          tripNumberInput.value = existingTrip.trip_number;
          return;
        }
      }
      
      tripNumberInput.value = getNextTripNumberForTruck(truckId, editingTripId);
    }

    async function saveTrip(id) {
      const truckId = parseInt(document.getElementById('tripTruck').value) || null;
      if (!truckId) { showToast('Please select a truck first', 'error'); return; }
      const driverId = parseInt(document.getElementById('tripDriver').value) || null;
      // Validate driver_id if provided
      if (driverId && !appData.drivers.find(d => d.id === driverId)) {
        showToast('Invalid driver selected', 'error');
        return;
      }
      // Validate truck_id
      if (!appData.trucks.find(t => t.id === truckId)) {
        showToast('Invalid truck selected', 'error');
        return;
      }
      const periodStart = document.getElementById('tripPeriodStart').value || null;
      const periodEnd = document.getElementById('tripPeriodEnd').value || null;
      const newStatus = document.getElementById('tripStatus').value;
      const data = { trip_number: document.getElementById('tripNumber').value, trip_date: document.getElementById('tripDate').value, trip_type: 'STANDARD', status: newStatus, driver_id: driverId, truck_id: truckId, driver_cut_percent: parseFloat(document.getElementById('tripCut').value) || 32, period_start_date: periodStart, period_end_date: periodEnd };
      try { 
        if (id) { 
          await dbUpdate('trips', id, data); 
          await logActivity('TRIP_UPDATED', { trip_id: id, trip_number: data.trip_number, truck_id: truckId, changes: data });
          showToast('Saved!');
        } else { 
          // For new trips, set period_start_date to today if not set
          if (!data.period_start_date) data.period_start_date = new Date().toISOString().split('T')[0];
          const newTrip = await dbInsert('trips', data); 
          await logActivity('TRIP_CREATED', { trip_id: newTrip.id, trip_number: data.trip_number, truck_id: truckId, data: data });
          showToast('Saved!');
        } 
        document.querySelector('.modal-overlay').remove(); await loadAllData(true); renderTrips(document.getElementById('main-content')); 
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteTrip(id) {
      if (!confirm('Delete this trip?')) return;
      const trip = appData.trips.find(t => t.id === id);
      // Check for attached orders
      const attachedOrders = appData.orders.filter(o => o.trip_id === id);
      if (attachedOrders.length > 0) {
        if (!confirm('This trip has ' + attachedOrders.length + ' order(s) attached. They will be unassigned. Continue?')) return;
        // Unassign orders from trip before deleting
        for (const order of attachedOrders) {
          await dbUpdate('orders', order.id, { trip_id: null, driver_id: null, vehicle_direction: null, pickup_sequence: null, delivery_sequence: null });
        }
      }
      try {
        await dbDelete('trips', id);
        await logActivity('TRIP_DELETED', { trip_id: id, trip_number: trip?.trip_number });
        showToast('Deleted'); await loadAllData(true); renderTrips(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    // Vehicle directions for trips
    const vehicleDirections = [
      { id: 'HOME_TO_CA', label: 'HOME TO CA', color: 'var(--green)' },
      { id: 'CA_TO_HOME', label: 'CA TO HOME', color: 'var(--green)' },
      { id: 'HOME_TO_FL', label: 'HOME TO FL', color: 'var(--blue)' },
      { id: 'FL_TO_HOME', label: 'FL TO HOME', color: 'var(--blue)' },
      { id: 'FL_TO_CA', label: 'FL TO CA', color: 'var(--amber)' },
      { id: 'CA_TO_FL', label: 'CA TO FL', color: 'var(--amber)' }
    ];

    // Auto-detect vehicle direction based on origin/destination
    function detectVehicleDirection(origin, destination) {
      if (!origin || !destination) return null;

      const originState = extractState(origin);
      const destState = extractState(destination);

      if (!originState || !destState) return null;

      // East Coast states (HOME region - Fairless Hills, PA)
      const EAST_STATES = ['PA', 'NJ', 'NY', 'CT', 'MA', 'MD', 'DE', 'VA', 'WV', 'OH', 'MI', 'IN', 'RI', 'NH', 'VT', 'ME', 'DC'];

      const originIsEast = EAST_STATES.includes(originState);
      const destIsEast = EAST_STATES.includes(destState);

      // Simple: East to West = HOME_TO_CA, West to East = CA_TO_HOME
      if (originIsEast && !destIsEast) return 'HOME_TO_CA';
      if (!originIsEast && destIsEast) return 'CA_TO_HOME';

      return null; // Can't auto-detect, let dispatcher choose manually
    }

    // Vehicle Years (1920 to current year + 1)
    const vehicleYears = [];
    for (let y = new Date().getFullYear() + 1; y >= 1920; y--) { vehicleYears.push(y); }
    
    // Vehicle Makes and Models (including classic/vintage from 1920s+)
    const vehicleMakes = {
      'Acura': ['ILX', 'Integra', 'MDX', 'NSX', 'RDX', 'RLX', 'TLX', 'TSX', 'ZDX', 'Legend', 'Vigor', 'CL', 'RL', 'RSX', 'SLX'],
      'Alfa Romeo': ['4C', 'Giulia', 'Stelvio', 'Tonale', 'Spider', 'GTV', '164', '156', '147', '159', 'Giulietta', 'MiTo', '8C Competizione', '33 Stradale', 'Montreal', '1750', '2000'],
      'AMC': ['Javelin', 'AMX', 'Gremlin', 'Pacer', 'Hornet', 'Matador', 'Ambassador', 'Rebel', 'Marlin', 'Rambler', 'Eagle'],
      'Aston Martin': ['DB11', 'DB12', 'DBX', 'DBS', 'Vantage', 'Vanquish', 'DB9', 'DB7', 'DB6', 'DB5', 'DB4', 'DB2', 'V8 Vantage', 'Virage', 'Lagonda', 'Rapide'],
      'Auburn': ['8-115', '851', '852', 'Speedster', '12-161', '8-100', 'Cabin Speedster', '120', '653'],
      'Audi': ['A3', 'A4', 'A5', 'A6', 'A7', 'A8', 'e-tron', 'e-tron GT', 'Q3', 'Q4', 'Q5', 'Q7', 'Q8', 'R8', 'RS3', 'RS5', 'RS6', 'RS7', 'S3', 'S4', 'S5', 'S6', 'S7', 'S8', 'SQ5', 'SQ7', 'SQ8', 'TT', '100', '200', '80', '90', '4000', '5000', 'Coupe GT', 'Quattro'],
      'Austin': ['Mini', 'Healey', 'A40', 'A30', 'A35', 'Cambridge', 'Westminster', 'Princess', 'Allegro', 'Maxi', 'Metro', '1100', '1300', '1800', 'Seven', 'Sheerline'],
      'Austin-Healey': ['100', '100-6', '3000', 'Sprite'],
      'Bentley': ['Bentayga', 'Continental GT', 'Flying Spur', 'Mulsanne', 'Arnage', 'Azure', 'Brooklands', 'Continental R', 'Continental T', 'Eight', 'Turbo R', 'Speed Six', 'Mark VI', 'R-Type', 'S1', 'S2', 'S3', 'T1', 'T2'],
      'BMW': ['2 Series', '3 Series', '4 Series', '5 Series', '6 Series', '7 Series', '8 Series', 'i3', 'i4', 'i5', 'i7', 'iX', 'M2', 'M3', 'M4', 'M5', 'M8', 'X1', 'X2', 'X3', 'X4', 'X5', 'X6', 'X7', 'XM', 'Z4', 'Z3', 'Z8', '1 Series', '2002', '1600', '1602', '3.0 CS', '3.0 CSL', '507', '503', '502', '501', '327', '328', '326', 'Isetta', 'M1', 'E9', 'E30', 'E36', 'E46', 'E39', 'E60'],
      'Buick': ['Enclave', 'Encore', 'Encore GX', 'Envision', 'LaCrosse', 'Regal', 'Century', 'LeSabre', 'Park Avenue', 'Riviera', 'Skylark', 'Electra', 'Wildcat', 'Roadmaster', 'Super', 'Special', 'Limited', 'Reatta', 'Grand National', 'GNX', 'GSX', 'Centurion'],
      'Cadillac': ['ATS', 'CT4', 'CT5', 'CT6', 'CTS', 'Escalade', 'Escalade ESV', 'Lyriq', 'XT4', 'XT5', 'XT6', 'DeVille', 'Eldorado', 'Fleetwood', 'Seville', 'Allante', 'Cimarron', 'Catera', 'XLR', 'STS', 'DTS', 'Series 62', 'Series 60', 'Series 61', 'Series 75', 'LaSalle', 'V-16', 'V-12', 'V-8'],
      'Chevrolet': ['Blazer', 'Bolt EUV', 'Bolt EV', 'Camaro', 'Colorado', 'Corvette', 'Equinox', 'Express', 'Impala', 'Malibu', 'Silverado 1500', 'Silverado 2500HD', 'Silverado 3500HD', 'Spark', 'Suburban', 'Tahoe', 'Trailblazer', 'Traverse', 'Trax', 'Chevelle', 'Nova', 'Monte Carlo', 'El Camino', 'Caprice', 'Bel Air', 'Biscayne', 'Nomad', 'Delray', 'Lumina', 'Celebrity', 'Cavalier', 'Beretta', 'Corsica', 'Citation', 'Monza', 'Vega', 'Chevette', 'Sprint', 'Spectrum', 'SSR', 'HHR', 'Cobalt', 'Cruze', 'Sonic', 'Aveo', 'Master', 'Standard Six', 'Confederate', 'Independence', 'Eagle', 'Mercury', 'Superior', 'Fleetline', 'Stylemaster', 'Special Deluxe', '150', '210', '3100', 'Apache', 'Task Force', 'C10', 'C20', 'K5', 'K10', 'S10', 'LUV', 'Astro', 'Venture', 'Uplander'],
      'Chrysler': ['300', 'Pacifica', 'Voyager', 'Town & Country', 'PT Cruiser', 'Sebring', 'Crossfire', 'LHS', 'Concorde', 'New Yorker', 'Fifth Avenue', 'Imperial', 'Newport', 'Cordoba', 'LeBaron', 'Laser', 'Conquest', 'TC by Maserati', 'Airflow', 'Airstream', 'Royal', 'Windsor', 'Saratoga', 'Crown Imperial', 'C-300', '300 Letter Series'],
      'Cord': ['L-29', '810', '812', 'Sportsman', 'Phaeton', 'Brougham', 'Sedan', 'Convertible'],
      'Datsun': ['240Z', '260Z', '280Z', '280ZX', '510', '610', '710', '810', '1200', '1600', 'B210', 'F10', '200SX', '310', 'Roadster', 'Fairlady', '411', '520', '521', '620', '720', 'Bluebird'],
      'DeLorean': ['DMC-12'],
      'DeSoto': ['Adventurer', 'Firesweep', 'Fireflite', 'Firedome', 'Powermaster', 'Deluxe', 'Custom', 'Airflow', 'Airstream', 'S-6', 'S-7', 'S-8', 'S-10', 'S-11'],
      'Dodge': ['Challenger', 'Charger', 'Durango', 'Grand Caravan', 'Hornet', 'Journey', 'Viper', 'Dart', 'Neon', 'Avenger', 'Intrepid', 'Stratus', 'Stealth', 'Daytona', 'Omni', 'Colt', 'Lancer', 'Mirada', 'Diplomat', 'Monaco', 'Polara', 'Coronet', 'Super Bee', 'Demon', 'Swinger', 'Custom 880', 'Aspen', 'St. Regis', 'Magnum', 'Spirit', 'Shadow', 'Dynasty', 'Aries', 'Caliber', 'Nitro', 'Ram', 'Dakota', 'Power Wagon', 'D100', 'D150', 'W100', 'W150', 'Ramcharger', 'Warlock', 'Li\'l Red Express'],
      'Duesenberg': ['Model J', 'Model SJ', 'Model X', 'Model A', 'SSJ', 'JN', 'Mormon Meteor'],
      'Edsel': ['Citation', 'Corsair', 'Pacer', 'Ranger', 'Bermuda', 'Roundup', 'Villager'],
      'Ferrari': ['296 GTB', '488', '812', 'F8', 'Portofino', 'Purosangue', 'Roma', 'SF90', '458', '488', 'California', 'LaFerrari', 'Enzo', 'F40', 'F50', 'Testarossa', '308', '328', '348', '355', '360', 'F430', '512', '550', '575', '599', '612', 'FF', 'GTC4Lusso', 'Mondial', '250', '275', '330', '365', 'Daytona', 'Dino', '166', '195', '212', '225', '250 GT', '250 GTO'],
      'Fiat': ['500', '500L', '500X', '124 Spider', 'Spider 2000', 'X1/9', '128', '131', '850', 'Strada', 'Brava', 'Punto', 'Panda', 'Uno', 'Tipo', 'Croma', 'Multipla', 'Stilo', 'Bravo', 'Linea', 'Doblo', 'Ducato', 'Topolino'],
      'Ford': ['Bronco', 'Bronco Sport', 'E-Series', 'EcoSport', 'Edge', 'Escape', 'Expedition', 'Explorer', 'F-150', 'F-150 Lightning', 'F-250', 'F-350', 'Fiesta', 'Flex', 'Focus', 'Fusion', 'Maverick', 'Mustang', 'Mustang Mach-E', 'Ranger', 'Taurus', 'Transit', 'Transit Connect', 'Thunderbird', 'Crown Victoria', 'LTD', 'Fairlane', 'Galaxie', 'Torino', 'Gran Torino', 'Pinto', 'Maverick', 'Granada', 'Elite', 'Tempo', 'Contour', 'Five Hundred', 'Freestyle', 'Probe', 'Festiva', 'Aspire', 'EXP', 'Escort', 'ZX2', 'Focus', 'C-Max', 'GT', 'GT40', 'Model T', 'Model A', 'Model B', 'Model 18', 'Model 40', 'Model 48', 'Model 68', 'Model 78', 'Model 81A', 'Deluxe', 'Super Deluxe', 'Custom', 'Customline', 'Mainline', 'Crestline', 'Sunliner', 'Skyliner', 'Starliner', 'Victoria', 'Ranchero', 'Falcon', 'Comet', 'Fairmont', 'Festiva', 'Courier', 'Club Wagon'],
      'Genesis': ['G70', 'G80', 'G90', 'GV60', 'GV70', 'GV80'],
      'GMC': ['Acadia', 'Canyon', 'Hummer EV', 'Sierra 1500', 'Sierra 2500HD', 'Sierra 3500HD', 'Terrain', 'Yukon', 'Yukon XL', 'Jimmy', 'Envoy', 'Safari', 'Sonoma', 'Syclone', 'Typhoon', 'C/K Series', 'S-15', 'Caballero', 'Sprint'],
      'Honda': ['Accord', 'Civic', 'CR-V', 'CR-Z', 'Fit', 'HR-V', 'Insight', 'Odyssey', 'Passport', 'Pilot', 'Prologue', 'Ridgeline', 'Prelude', 'CRX', 'del Sol', 'S2000', 'Element', 'Crosstour', 'FCX Clarity'],
      'Hudson': ['Hornet', 'Wasp', 'Jet', 'Commodore', 'Super Six', 'Pacemaker', 'Hollywood', 'Italia', 'Terraplane', 'Essex', 'Greater Eight', 'Eight', 'Six'],
      'Hummer': ['H1', 'H2', 'H3', 'H3T'],
      'Hyundai': ['Accent', 'Elantra', 'Ioniq', 'Ioniq 5', 'Ioniq 6', 'Kona', 'Nexo', 'Palisade', 'Santa Cruz', 'Santa Fe', 'Sonata', 'Tucson', 'Veloster', 'Venue', 'Genesis Coupe', 'Azera', 'Equus', 'XG350', 'Tiburon', 'Excel', 'Scoupe'],
      'Imperial': ['Crown', 'LeBaron', 'Custom', 'Southampton', 'Ghia'],
      'Infiniti': ['Q50', 'Q60', 'QX50', 'QX55', 'QX60', 'QX80', 'G35', 'G37', 'M35', 'M45', 'FX35', 'FX45', 'QX4', 'QX56', 'J30', 'I30', 'I35', 'Q45', 'EX35'],
      'International': ['Scout', 'Scout II', 'Travelall', 'Harvester'],
      'Isuzu': ['Trooper', 'Rodeo', 'Amigo', 'VehiCROSS', 'Axiom', 'Ascender', 'Hombre', 'i-Series', 'Impulse', 'Stylus', 'I-Mark'],
      'Jaguar': ['E-PACE', 'F-PACE', 'F-TYPE', 'I-PACE', 'XE', 'XF', 'XJ', 'XK', 'XKR', 'XJR', 'S-Type', 'X-Type', 'XJS', 'XJ6', 'XJ12', 'E-Type', 'D-Type', 'C-Type', 'Mark 2', 'Mark VII', 'Mark VIII', 'Mark IX', 'Mark X', 'XK120', 'XK140', 'XK150', 'SS100', 'SS1', 'SS Jaguar'],
      'Jeep': ['Cherokee', 'Compass', 'Gladiator', 'Grand Cherokee', 'Grand Cherokee L', 'Grand Wagoneer', 'Renegade', 'Wagoneer', 'Wrangler', 'Liberty', 'Commander', 'Patriot', 'Grand Wagoneer', 'Wagoneer', 'CJ-5', 'CJ-7', 'CJ-8', 'Willys', 'Jeepster', 'Commando', 'J-10', 'J-20', 'Honcho', 'Scrambler', 'Comanche'],
      'Kaiser': ['Manhattan', 'Carolina', 'Virginian', 'Dragon', 'Traveler', 'Special', 'Deluxe', 'Darrin'],
      'Kia': ['Carnival', 'EV6', 'EV9', 'Forte', 'K5', 'Niro', 'Rio', 'Seltos', 'Sorento', 'Soul', 'Sportage', 'Stinger', 'Telluride', 'Optima', 'Cadenza', 'K900', 'Amanti', 'Spectra', 'Sephia', 'Sedona', 'Borrego', 'Rondo'],
      'Lamborghini': ['Aventador', 'Huracan', 'Revuelto', 'Urus', 'Gallardo', 'Murcielago', 'Diablo', 'Countach', 'Miura', 'Espada', 'Jarama', 'Islero', 'Urraco', 'Silhouette', 'Jalpa', 'LM002', '350 GT', '400 GT'],
      'Land Rover': ['Defender', 'Discovery', 'Discovery Sport', 'Range Rover', 'Range Rover Evoque', 'Range Rover Sport', 'Range Rover Velar', 'Freelander', 'LR2', 'LR3', 'LR4', 'Series I', 'Series II', 'Series III'],
      'LaSalle': ['Series 303', 'Series 328', 'Series 340', 'Series 345', 'Series 350', 'Series 37-50', 'Series 38-50', 'Series 39-50', 'Series 40-50', 'Series 40-52'],
      'Lexus': ['ES', 'GS', 'GX', 'IS', 'LC', 'LS', 'LX', 'NX', 'RC', 'RX', 'RZ', 'TX', 'UX', 'CT', 'HS', 'LFA', 'SC'],
      'Lincoln': ['Aviator', 'Continental', 'Corsair', 'MKZ', 'Nautilus', 'Navigator', 'MKC', 'MKS', 'MKT', 'MKX', 'Town Car', 'LS', 'Mark VIII', 'Mark VII', 'Mark VI', 'Mark V', 'Mark IV', 'Mark III', 'Mark II', 'Continental Mark Series', 'Capri', 'Versailles', 'Premier', 'Blackwood', 'Zephyr', 'Cosmopolitan', 'Custom', 'K-Series'],
      'Lotus': ['Elise', 'Evora', 'Exige', 'Emira', 'Esprit', 'Europa', 'Elan', 'Elite', 'Eclat', 'Seven', 'Eleven', 'Carlton'],
      'Lucid': ['Air'],
      'Maserati': ['Ghibli', 'GranTurismo', 'Grecale', 'Levante', 'MC20', 'Quattroporte', 'GranCabrio', 'Coupe', 'Spyder', 'MC12', '3200 GT', 'Biturbo', 'Merak', 'Bora', 'Khamsin', 'Indy', 'Mexico', 'Mistral', 'Sebring', '3500 GT', '5000 GT', 'A6'],
      'Mazda': ['CX-3', 'CX-30', 'CX-5', 'CX-50', 'CX-9', 'CX-90', 'Mazda3', 'Mazda6', 'MX-30', 'MX-5 Miata', 'RX-7', 'RX-8', '323', '626', '929', 'Millenia', 'MPV', 'Tribute', 'CX-7', 'B-Series', 'Navajo', 'Protege', 'MX-3', 'MX-6', 'Cosmo'],
      'McLaren': ['720S', '750S', 'Artura', 'GT', '570S', '600LT', '650S', '675LT', '12C', 'P1', 'Senna', 'Speedtail', 'Elva', 'F1'],
      'Mercedes-Benz': ['A-Class', 'AMG GT', 'C-Class', 'CLA', 'CLS', 'E-Class', 'EQB', 'EQE', 'EQS', 'G-Class', 'GLA', 'GLB', 'GLC', 'GLE', 'GLS', 'Maybach', 'S-Class', 'SL', 'Sprinter', 'SLK', 'SLC', 'SLR McLaren', 'SLS AMG', 'CLK', 'ML', 'GL', 'GLK', 'R-Class', '190', '200', '220', '230', '240', '250', '260', '280', '300', '320', '350', '380', '400', '420', '450', '500', '560', '600', '107', '108', '109', '114', '115', '116', '123', '124', '126', '129', '140', '170', '180', '220 Ponton', '300 Adenauer', 'Gullwing', '300SL', '190SL', '230SL', '250SL', '280SL', '350SL', '450SL', '500SL', '560SL'],
      'Mercury': ['Grand Marquis', 'Cougar', 'Mountaineer', 'Mariner', 'Milan', 'Marauder', 'Sable', 'Tracer', 'Mystique', 'Villager', 'Monterey', 'Colony Park', 'Marquis', 'Montego', 'Comet', 'Capri', 'Bobcat', 'Lynx', 'Topaz', 'Zephyr', 'Monarch', 'Cyclone', 'Park Lane', 'Breezeway', 'Eight', 'Custom'],
      'MG': ['MGA', 'MGB', 'MGB GT', 'MGC', 'Midget', 'TD', 'TF', 'TC', 'TA', 'TB', 'PA', 'PB', 'J2', 'K3', 'Magnette', 'ZA', 'ZB'],
      'Mini': ['Clubman', 'Convertible', 'Cooper', 'Countryman', 'Hardtop', 'Paceman', 'Roadster', 'Coupe', 'Classic Mini'],
      'Mitsubishi': ['Eclipse Cross', 'Mirage', 'Outlander', 'Outlander Sport', 'Eclipse', 'Galant', 'Lancer', 'Diamante', 'Montero', '3000GT', 'Starion', 'Cordia', 'Tredia', 'Sigma', 'Expo', 'Precis', 'Mighty Max', 'Raider', 'Endeavor', 'i-MiEV'],
      'Nash': ['Ambassador', 'Statesman', 'Rambler', 'Metropolitan', 'Airflyte', '600', 'Lafayette', 'Advanced Six', 'Special Six', 'Standard Six', 'Big Six', 'Eight', 'Twin Ignition Six'],
      'Nissan': ['370Z', 'Altima', 'Armada', 'Ariya', 'Frontier', 'GT-R', 'Kicks', 'Leaf', 'Maxima', 'Murano', 'Pathfinder', 'Rogue', 'Sentra', 'Titan', 'Versa', 'Z', '300ZX', '350Z', '240SX', 'Silvia', 'Pulsar', 'NX', 'Stanza', '200SX', 'Axxess', 'Quest', 'Xterra', 'Juke', 'Cube'],
      'Oldsmobile': ['Cutlass', '442', 'Toronado', '98', '88', 'Delta 88', 'Ninety-Eight', 'Starfire', 'F-85', 'Vista Cruiser', 'Custom Cruiser', 'Omega', 'Firenza', 'Calais', 'Achieva', 'Alero', 'Aurora', 'Intrigue', 'Bravada', 'Silhouette', 'Curved Dash', 'Six', 'Eight', 'Rocket'],
      'Opel': ['GT', 'Kadett', 'Manta', 'Ascona', 'Rekord', 'Commodore', 'Admiral', 'Diplomat', 'Kapitn'],
      'Packard': ['Clipper', 'Caribbean', 'Patrician', 'Cavalier', '400', 'Hawk', 'Super Eight', 'One-Twenty', 'One-Ten', 'Twelve', 'Standard Eight', 'Custom Eight', 'Deluxe Eight', 'Senior', 'Light Eight', 'Single Six', 'Twin Six'],
      'Pierce-Arrow': ['Series 80', 'Series 81', 'Series 836', 'Series 1240', 'Series 1245', 'Model 48', 'Model 66', 'Model 38', 'Model 36', 'Model 33'],
      'Plymouth': ['Barracuda', 'Road Runner', 'GTX', 'Satellite', 'Belvedere', 'Fury', 'Valiant', 'Duster', 'Cuda', 'Superbird', 'Prowler', 'Neon', 'Breeze', 'Acclaim', 'Sundance', 'Laser', 'Horizon', 'TC3', 'Sapporo', 'Champ', 'Turismo', 'Reliant', 'Caravelle', 'Gran Fury', 'Volare', 'Trail Duster', 'Voyager', 'Colt', 'Cricket', 'Arrow', 'Scamp', 'Special Deluxe', 'Deluxe', 'Cranbrook', 'Cambridge', 'Savoy', 'Plaza', 'Sport Fury', 'Suburban'],
      'Polestar': ['1', '2', '3'],
      'Pontiac': ['GTO', 'Firebird', 'Trans Am', 'Grand Prix', 'Bonneville', 'Catalina', 'LeMans', 'Tempest', 'Grand Am', 'Sunfire', 'Sunbird', 'Fiero', 'Grand Safari', '6000', 'Phoenix', 'J2000', 'Solstice', 'G8', 'G6', 'G5', 'G3', 'Vibe', 'Torrent', 'Montana', 'Aztek', 'Star Chief', 'Chieftain', 'Streamliner', 'Torpedo', 'Executive', 'Ventura', 'Astre'],
      'Porsche': ['718 Boxster', '718 Cayman', '911', 'Cayenne', 'Macan', 'Panamera', 'Taycan', '928', '944', '968', '924', '914', '912', '356', '550 Spyder', '959', 'Carrera GT', '918 Spyder', 'Boxster', 'Cayman'],
      'Ram': ['1500', '2500', '3500', 'ProMaster', 'ProMaster City'],
      'Renault': ['Alliance', 'Encore', 'Fuego', 'Le Car', 'Medallion', 'Premier', 'Dauphine', 'Caravelle', 'Gordini', 'R5 Turbo', 'R8', 'R10', 'R12', 'R15', 'R16', 'R17', 'R18'],
      'REO': ['Flying Cloud', 'Royale', 'Wolverine', 'Speed Wagon', 'Six', 'Eight', 'Gold Comet'],
      'Rivian': ['R1S', 'R1T'],
      'Rolls-Royce': ['Cullinan', 'Dawn', 'Ghost', 'Phantom', 'Spectre', 'Wraith', 'Silver Shadow', 'Silver Spirit', 'Silver Spur', 'Silver Seraph', 'Corniche', 'Camargue', 'Silver Cloud', 'Silver Dawn', 'Silver Wraith', 'Phantom I', 'Phantom II', 'Phantom III', 'Phantom IV', 'Phantom V', 'Phantom VI', 'Twenty', 'Springfield', 'Park Ward'],
      'Saab': ['900', '9000', '9-3', '9-5', '9-7X', '9-2X', '92', '93', '95', '96', '97', '99', 'Sonett'],
      'Saturn': ['S-Series', 'L-Series', 'Ion', 'Vue', 'Relay', 'Sky', 'Aura', 'Outlook', 'SC', 'SL', 'SW'],
      'Scion': ['tC', 'xA', 'xB', 'xD', 'FR-S', 'iA', 'iM', 'iQ'],
      'Shelby': ['GT350', 'GT500', 'GT40', 'Cobra', 'Series 1', 'Daytona Coupe'],
      'Studebaker': ['Avanti', 'Hawk', 'Lark', 'Champion', 'Commander', 'President', 'Dictator', 'Land Cruiser', 'Starlight', 'Starliner', 'Golden Hawk', 'Sky Hawk', 'Power Hawk', 'Flight Hawk', 'Silver Hawk', 'Gran Turismo Hawk', 'Champ', 'Transtar', 'Scotsman', 'Wagonaire'],
      'Subaru': ['Ascent', 'BRZ', 'Crosstrek', 'Forester', 'Impreza', 'Legacy', 'Outback', 'Solterra', 'WRX', 'STI', 'SVX', 'Baja', 'Tribeca', 'XT', 'GL', 'DL', 'Justy', 'Loyale', '360', 'Leone', 'BRAT'],
      'Sunbeam': ['Tiger', 'Alpine', 'Rapier', 'Imp', 'Talbot', 'Avenger'],
      'Tesla': ['Cybertruck', 'Model 3', 'Model S', 'Model X', 'Model Y', 'Roadster'],
      'Toyota': ['4Runner', '86', 'Avalon', 'bZ4X', 'Camry', 'C-HR', 'Corolla', 'Corolla Cross', 'Crown', 'GR Supra', 'Grand Highlander', 'Highlander', 'Land Cruiser', 'Mirai', 'Prius', 'RAV4', 'Sequoia', 'Sienna', 'Tacoma', 'Tundra', 'Venza', 'Supra', 'MR2', 'Celica', 'Matrix', 'Yaris', 'Echo', 'Tercel', 'Paseo', 'Cressida', 'Corona', 'Starlet', 'Previa', 'Van', 'T100', 'Pickup', 'FJ Cruiser', 'Solara', 'Avalon', '2000GT'],
      'Triumph': ['TR2', 'TR3', 'TR4', 'TR5', 'TR6', 'TR7', 'TR8', 'Spitfire', 'GT6', 'Stag', 'Herald', 'Vitesse', 'Dolomite', '2000', '2500', '1800', 'Acclaim'],
      'Tucker': ['48'],
      'Volkswagen': ['Arteon', 'Atlas', 'Atlas Cross Sport', 'Beetle', 'Golf', 'GTI', 'ID.4', 'Jetta', 'Passat', 'Taos', 'Tiguan', 'CC', 'Eos', 'Touareg', 'Routan', 'Rabbit', 'Fox', 'Corrado', 'Scirocco', 'Cabriolet', 'Karmann Ghia', 'Thing', 'Bus', 'Van', 'Type 1', 'Type 2', 'Type 3', 'Type 4', 'Squareback', 'Fastback', 'Dasher', 'Quantum', 'Super Beetle', 'Phaeton'],
      'Volvo': ['C40', 'S60', 'S90', 'V60', 'V90', 'XC40', 'XC60', 'XC90', 'C30', 'C70', 'S40', 'S70', 'S80', 'V40', 'V50', 'V70', 'XC70', '240', '260', '740', '760', '780', '850', '940', '960', '1800', 'P1800', 'Amazon', 'PV444', 'PV544', 'PV', '120', '140', '164', '240 Turbo', 'Bertone Coupe'],
      'Willys': ['Jeep', 'Jeepster', 'Station Wagon', 'Pickup', 'Panel', 'Knight', 'Whippet', 'Overland', 'Americar']
    };
    
    // Build flat list of all vehicle makes and models for autocomplete
    const allVehiclesFlat = [];
    Object.keys(vehicleMakes).forEach(make => {
      allVehiclesFlat.push(make); // Add make by itself
      vehicleMakes[make].forEach(model => {
        allVehiclesFlat.push(make + ' ' + model);
      });
    });
    allVehiclesFlat.sort();
    
    function setupVehicleAutocomplete(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      
      let dropdown = document.getElementById(inputId + '-dropdown');
      if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = inputId + '-dropdown';
        dropdown.style.cssText = 'position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:var(--bg-card);border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;z-index:1000;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.1)';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(dropdown);
      }

      input.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        if (val.length < 1) {
          dropdown.style.display = 'none';
          return;
        }

        const matches = allVehiclesFlat.filter(v => v.toLowerCase().includes(val)).slice(0, 20);
        
        if (matches.length === 0) {
          dropdown.style.display = 'none';
          return;
        }
        
        dropdown.innerHTML = matches.map(m => {
          const highlighted = m.replace(new RegExp('(' + val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi'), '<strong>$1</strong>');
          return '<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid var(--border);font-size:14px" onmouseover="this.style.background=\'var(--bg-card-hover)\'" onmouseout="this.style.background=\'var(--bg-card)\'" onclick="selectVehicle(\'' + inputId + '\', \'' + m.replace(/'/g, "\\'") + '\')">' + highlighted + '</div>';
        }).join('');
        dropdown.style.display = 'block';
      });
      
      input.addEventListener('blur', function() {
        setTimeout(() => { dropdown.style.display = 'none'; }, 200);
      });
      
      input.addEventListener('focus', function() {
        if (this.value.length >= 1) {
          this.dispatchEvent(new Event('input'));
        }
      });
    }
    
    function selectVehicle(inputId, value) {
      document.getElementById(inputId).value = value;
      document.getElementById(inputId + '-dropdown').style.display = 'none';
    }
    
    // US States
    const usStates = [
      { abbr: 'AL', name: 'Alabama' }, { abbr: 'AK', name: 'Alaska' }, { abbr: 'AZ', name: 'Arizona' },
      { abbr: 'AR', name: 'Arkansas' }, { abbr: 'CA', name: 'California' }, { abbr: 'CO', name: 'Colorado' },
      { abbr: 'CT', name: 'Connecticut' }, { abbr: 'DE', name: 'Delaware' }, { abbr: 'FL', name: 'Florida' },
      { abbr: 'GA', name: 'Georgia' }, { abbr: 'HI', name: 'Hawaii' }, { abbr: 'ID', name: 'Idaho' },
      { abbr: 'IL', name: 'Illinois' }, { abbr: 'IN', name: 'Indiana' }, { abbr: 'IA', name: 'Iowa' },
      { abbr: 'KS', name: 'Kansas' }, { abbr: 'KY', name: 'Kentucky' }, { abbr: 'LA', name: 'Louisiana' },
      { abbr: 'ME', name: 'Maine' }, { abbr: 'MD', name: 'Maryland' }, { abbr: 'MA', name: 'Massachusetts' },
      { abbr: 'MI', name: 'Michigan' }, { abbr: 'MN', name: 'Minnesota' }, { abbr: 'MS', name: 'Mississippi' },
      { abbr: 'MO', name: 'Missouri' }, { abbr: 'MT', name: 'Montana' }, { abbr: 'NE', name: 'Nebraska' },
      { abbr: 'NV', name: 'Nevada' }, { abbr: 'NH', name: 'New Hampshire' }, { abbr: 'NJ', name: 'New Jersey' },
      { abbr: 'NM', name: 'New Mexico' }, { abbr: 'NY', name: 'New York' }, { abbr: 'NC', name: 'North Carolina' },
      { abbr: 'ND', name: 'North Dakota' }, { abbr: 'OH', name: 'Ohio' }, { abbr: 'OK', name: 'Oklahoma' },
      { abbr: 'OR', name: 'Oregon' }, { abbr: 'PA', name: 'Pennsylvania' }, { abbr: 'RI', name: 'Rhode Island' },
      { abbr: 'SC', name: 'South Carolina' }, { abbr: 'SD', name: 'South Dakota' }, { abbr: 'TN', name: 'Tennessee' },
      { abbr: 'TX', name: 'Texas' }, { abbr: 'UT', name: 'Utah' }, { abbr: 'VT', name: 'Vermont' },
      { abbr: 'VA', name: 'Virginia' }, { abbr: 'WA', name: 'Washington' }, { abbr: 'WV', name: 'West Virginia' },
      { abbr: 'WI', name: 'Wisconsin' }, { abbr: 'WY', name: 'Wyoming' }, { abbr: 'DC', name: 'Washington DC' }
    ];
    
    // Major US Cities by State (most common for auto transport)
    const usCities = {
      'AL': ['Birmingham', 'Montgomery', 'Mobile', 'Huntsville', 'Tuscaloosa'],
      'AK': ['Anchorage', 'Fairbanks', 'Juneau'],
      'AZ': ['Phoenix', 'Tucson', 'Mesa', 'Scottsdale', 'Chandler', 'Gilbert', 'Tempe', 'Glendale', 'Peoria'],
      'AR': ['Little Rock', 'Fort Smith', 'Fayetteville', 'Springdale'],
      'CA': ['Los Angeles', 'San Diego', 'San Jose', 'San Francisco', 'Fresno', 'Sacramento', 'Long Beach', 'Oakland', 'Bakersfield', 'Anaheim', 'Santa Ana', 'Riverside', 'Stockton', 'Irvine', 'Chula Vista', 'Fremont', 'San Bernardino', 'Modesto', 'Fontana', 'Moreno Valley', 'Glendale', 'Huntington Beach', 'Santa Clarita', 'Garden Grove', 'Oceanside', 'Rancho Cucamonga', 'Ontario', 'Santa Rosa', 'Elk Grove', 'Corona', 'Lancaster', 'Palmdale', 'Salinas', 'Pomona', 'Hayward', 'Escondido', 'Sunnyvale', 'Torrance', 'Pasadena', 'Orange', 'Fullerton', 'Thousand Oaks', 'Roseville', 'Concord', 'Simi Valley', 'Santa Clara', 'Victorville', 'Vallejo', 'Berkeley', 'El Monte', 'Downey', 'Costa Mesa', 'Inglewood', 'Carlsbad', 'Fairfield', 'Ventura', 'Temecula', 'Antioch', 'Murrieta', 'Richmond', 'Norwalk', 'Burbank', 'El Cajon', 'Daly City', 'Rialto', 'West Covina', 'Clovis', 'Compton', 'Jurupa Valley', 'Vista', 'South Gate', 'Mission Viejo', 'Vacaville', 'Carson', 'Hesperia', 'Santa Maria', 'Redding', 'Westminster', 'Santa Monica', 'Chico', 'Newport Beach', 'San Leandro', 'San Marcos', 'Whittier', 'Hawthorne', 'Citrus Heights', 'Alhambra', 'Tracy', 'Livermore', 'Buena Park', 'Menifee', 'Hemet', 'Lakewood', 'Merced', 'Chino', 'Indio', 'Redwood City', 'Lake Forest', 'Napa', 'Tustin', 'Bellflower', 'Mountain View', 'Chino Hills', 'Baldwin Park', 'Alameda', 'Upland', 'San Ramon', 'Folsom', 'Pleasanton', 'Lynwood', 'Union City', 'Apple Valley', 'Redlands', 'Turlock', 'Perris', 'Manteca', 'Milpitas', 'Redondo Beach', 'Davis'],
      'CO': ['Denver', 'Colorado Springs', 'Aurora', 'Fort Collins', 'Lakewood', 'Thornton', 'Arvada', 'Westminster', 'Pueblo', 'Boulder'],
      'CT': ['Bridgeport', 'New Haven', 'Stamford', 'Hartford', 'Waterbury', 'Norwalk', 'Danbury'],
      'DE': ['Wilmington', 'Dover', 'Newark'],
      'FL': ['Jacksonville', 'Miami', 'Tampa', 'Orlando', 'St. Petersburg', 'Hialeah', 'Port St. Lucie', 'Cape Coral', 'Tallahassee', 'Fort Lauderdale', 'Pembroke Pines', 'Hollywood', 'Gainesville', 'Miramar', 'Coral Springs', 'Palm Bay', 'West Palm Beach', 'Clearwater', 'Lakeland', 'Pompano Beach', 'Davie', 'Miami Gardens', 'Sunrise', 'Boca Raton', 'Deltona', 'Plantation', 'Fort Myers', 'Palm Coast', 'Deerfield Beach', 'Melbourne', 'Boynton Beach', 'Lauderhill', 'Weston', 'Kissimmee', 'Homestead', 'Delray Beach', 'Tamarac', 'Daytona Beach', 'Wellington', 'North Port', 'Jupiter', 'Ocala', 'Port Orange', 'Margate', 'Coconut Creek', 'Sanford', 'Sarasota', 'Pensacola', 'Bradenton', 'Palm Beach Gardens', 'Pinellas Park', 'Coral Gables', 'Doral', 'Bonita Springs', 'Apopka', 'Titusville', 'North Miami', 'Oakland Park', 'Fort Pierce', 'North Miami Beach', 'North Lauderdale', 'Cutler Bay', 'Altamonte Springs', 'St. Cloud', 'Greenacres', 'Ormond Beach', 'Ocoee', 'Hallandale Beach', 'Winter Garden', 'Aventura'],
      'GA': ['Atlanta', 'Augusta', 'Columbus', 'Macon', 'Savannah', 'Athens', 'Sandy Springs', 'Roswell', 'Johns Creek', 'Albany', 'Warner Robins', 'Alpharetta', 'Marietta', 'Valdosta', 'Smyrna', 'Dunwoody'],
      'HI': ['Honolulu', 'Pearl City', 'Hilo', 'Kailua', 'Waipahu'],
      'ID': ['Boise', 'Meridian', 'Nampa', 'Idaho Falls', 'Pocatello'],
      'IL': ['Chicago', 'Aurora', 'Rockford', 'Joliet', 'Naperville', 'Springfield', 'Peoria', 'Elgin', 'Waukegan', 'Champaign', 'Bloomington', 'Decatur', 'Evanston', 'Schaumburg', 'Bolingbrook', 'Palatine', 'Skokie', 'Des Plaines', 'Orland Park', 'Tinley Park', 'Oak Lawn', 'Berwyn', 'Mount Prospect', 'Normal', 'Wheaton', 'Hoffman Estates', 'Oak Park', 'Downers Grove', 'Elmhurst', 'Glenview', 'DeKalb', 'Lombard', 'Belleville', 'Moline', 'Buffalo Grove', 'Bartlett', 'Urbana', 'Crystal Lake', 'Quincy', 'Streamwood', 'Carol Stream', 'Romeoville', 'Plainfield', 'Hanover Park', 'Carpentersville', 'Wheeling', 'Park Ridge', 'Addison', 'Calumet City'],
      'IN': ['Indianapolis', 'Fort Wayne', 'Evansville', 'South Bend', 'Carmel', 'Fishers', 'Bloomington', 'Hammond', 'Gary', 'Lafayette', 'Muncie', 'Terre Haute', 'Kokomo', 'Noblesville', 'Anderson', 'Greenwood', 'Elkhart', 'Mishawaka', 'Lawrence', 'Jeffersonville', 'Columbus', 'Portage'],
      'IA': ['Des Moines', 'Cedar Rapids', 'Davenport', 'Sioux City', 'Iowa City', 'Waterloo', 'Ames', 'West Des Moines', 'Council Bluffs', 'Ankeny', 'Dubuque', 'Urbandale', 'Cedar Falls'],
      'KS': ['Wichita', 'Overland Park', 'Kansas City', 'Olathe', 'Topeka', 'Lawrence', 'Shawnee', 'Manhattan', 'Lenexa', 'Salina', 'Hutchinson'],
      'KY': ['Louisville', 'Lexington', 'Bowling Green', 'Owensboro', 'Covington', 'Richmond', 'Georgetown', 'Florence', 'Hopkinsville', 'Nicholasville', 'Elizabethtown'],
      'LA': ['New Orleans', 'Baton Rouge', 'Shreveport', 'Lafayette', 'Lake Charles', 'Kenner', 'Bossier City', 'Monroe', 'Alexandria'],
      'ME': ['Portland', 'Lewiston', 'Bangor', 'South Portland', 'Auburn'],
      'MD': ['Baltimore', 'Frederick', 'Rockville', 'Gaithersburg', 'Bowie', 'Hagerstown', 'Annapolis', 'College Park', 'Salisbury', 'Laurel'],
      'MA': ['Boston', 'Worcester', 'Springfield', 'Lowell', 'Cambridge', 'New Bedford', 'Brockton', 'Quincy', 'Lynn', 'Fall River', 'Newton', 'Lawrence', 'Somerville', 'Framingham', 'Haverhill', 'Waltham', 'Malden', 'Brookline', 'Plymouth', 'Medford', 'Taunton', 'Chicopee', 'Weymouth', 'Revere', 'Peabody'],
      'MI': ['Detroit', 'Grand Rapids', 'Warren', 'Sterling Heights', 'Ann Arbor', 'Lansing', 'Flint', 'Dearborn', 'Livonia', 'Troy', 'Westland', 'Farmington Hills', 'Kalamazoo', 'Wyoming', 'Southfield', 'Rochester Hills', 'Taylor', 'Pontiac', 'St. Clair Shores', 'Royal Oak', 'Novi', 'Dearborn Heights', 'Battle Creek', 'Saginaw', 'Kentwood', 'East Lansing', 'Roseville', 'Portage', 'Midland', 'Lincoln Park'],
      'MN': ['Minneapolis', 'St. Paul', 'Rochester', 'Duluth', 'Bloomington', 'Brooklyn Park', 'Plymouth', 'St. Cloud', 'Eagan', 'Woodbury', 'Maple Grove', 'Eden Prairie', 'Coon Rapids', 'Burnsville', 'Blaine', 'Lakeville', 'Minnetonka', 'Apple Valley', 'Edina', 'St. Louis Park', 'Mankato', 'Maplewood', 'Moorhead', 'Shakopee'],
      'MS': ['Jackson', 'Gulfport', 'Southaven', 'Hattiesburg', 'Biloxi', 'Meridian', 'Tupelo', 'Greenville', 'Olive Branch', 'Horn Lake'],
      'MO': ['Kansas City', 'St. Louis', 'Springfield', 'Independence', 'Columbia', "Lee's Summit", "O'Fallon", 'St. Joseph', 'St. Charles', 'St. Peters', 'Blue Springs', 'Florissant', 'Joplin', 'Chesterfield', 'Jefferson City', 'Cape Girardeau'],
      'MT': ['Billings', 'Missoula', 'Great Falls', 'Bozeman', 'Butte', 'Helena'],
      'NE': ['Omaha', 'Lincoln', 'Bellevue', 'Grand Island', 'Kearney', 'Fremont', 'Hastings', 'Norfolk', 'North Platte', 'Papillion'],
      'NV': ['Las Vegas', 'Henderson', 'Reno', 'North Las Vegas', 'Sparks', 'Carson City', 'Fernley', 'Elko', 'Mesquite', 'Boulder City'],
      'NH': ['Manchester', 'Nashua', 'Concord', 'Derry', 'Dover', 'Rochester', 'Salem', 'Merrimack', 'Hudson', 'Londonderry'],
      'NJ': ['Newark', 'Jersey City', 'Paterson', 'Elizabeth', 'Edison', 'Woodbridge', 'Lakewood', 'Toms River', 'Hamilton', 'Trenton', 'Clifton', 'Camden', 'Brick', 'Cherry Hill', 'Passaic', 'Middletown', 'Union City', 'Old Bridge', 'Gloucester', 'East Orange', 'Bayonne', 'Franklin', 'North Bergen', 'Vineland', 'Union', 'Piscataway', 'New Brunswick', 'Jackson', 'Wayne', 'Irvington', 'Parsippany', 'Howell', 'Perth Amboy', 'Hoboken', 'Plainfield', 'West New York', 'Washington', 'East Brunswick', 'Bloomfield', 'West Orange', 'Evesham', 'Bridgewater', 'South Brunswick', 'Egg Harbor', 'Manchester', 'Hackensack', 'Sayreville', 'Mount Laurel', 'Berkeley', 'North Brunswick', 'Kearny', 'Linden', 'Marlboro', 'Teaneck', 'Atlantic City', 'Secaucus', 'Monroe', 'Rahway', 'Bergenfield', 'Paramus', 'Livingston', 'Nutley', 'Fort Lee', 'Englewood', 'Garfield', 'Lodi', 'Orange', 'Belleville', 'Fair Lawn', 'Long Branch', 'Westfield', 'Millville', 'Montclair', 'Summit', 'Maplewood', 'South Orange', 'Morristown', 'Red Bank', 'Princeton', 'Freehold', 'Asbury Park', 'Point Pleasant', 'Somerville', 'Metuchen', 'Cranford', 'Hillside', 'Roselle', 'Clark', 'Scotch Plains', 'Fanwood'],
      'NM': ['Albuquerque', 'Las Cruces', 'Rio Rancho', 'Santa Fe', 'Roswell', 'Farmington', 'Clovis'],
      'NY': ['New York', 'Buffalo', 'Rochester', 'Yonkers', 'Syracuse', 'Albany', 'New Rochelle', 'Mount Vernon', 'Schenectady', 'Utica', 'White Plains', 'Hempstead', 'Troy', 'Niagara Falls', 'Binghamton', 'Freeport', 'Valley Stream', 'Long Beach', 'Spring Valley', 'Rome', 'Ithaca', 'Poughkeepsie', 'Elmira', 'Lindenhurst', 'Auburn', 'Watertown', 'Glen Cove', 'Saratoga Springs', 'Jamestown', 'Harrison', 'Ossining', 'Peekskill', 'Kingston', 'Middletown', 'Newburgh', 'Port Chester', 'Mamaroneck', 'Rye', 'Larchmont', 'Tarrytown', 'Sleepy Hollow', 'Dobbs Ferry', 'Eastchester', 'Scarsdale', 'Bronxville', 'Pelham', 'Tuckahoe', 'Croton-on-Hudson', 'Pleasantville', 'Chappaqua', 'Bedford', 'Katonah', 'Armonk', 'Mount Kisco', 'Yorktown Heights', 'Carmel', 'Brewster', 'Mahopac', 'Cortlandt', 'Verplanck', 'Buchanan', 'Haverstraw', 'Nyack', 'Pearl River', 'Nanuet', 'Suffern', 'Monsey', 'New City', 'Stony Point', 'West Haverstraw', 'Congers', 'Valley Cottage', 'Orangeburg', 'Blauvelt', 'Tappan', 'Piermont', 'Brooklyn', 'Queens', 'Bronx', 'Staten Island', 'Manhattan', 'Astoria', 'Flushing', 'Jamaica', 'Bayside', 'Forest Hills', 'Woodside', 'Jackson Heights', 'Corona', 'Elmhurst', 'Rego Park', 'Ridgewood', 'Fresh Meadows', 'Whitestone', 'College Point', 'Little Neck', 'Douglaston', 'Hollis', 'St. Albans', 'Cambria Heights', 'Springfield Gardens', 'Laurelton', 'Rosedale', 'Far Rockaway', 'Rockaway Beach', 'Howard Beach', 'Ozone Park', 'Richmond Hill', 'South Ozone Park', 'Woodhaven', 'Kew Gardens', 'Long Island City', 'Sunnyside', 'Maspeth', 'Middle Village', 'Glendale', 'Bay Ridge', 'Bensonhurst', 'Borough Park', 'Flatbush', 'Flatlands', 'Canarsie', 'East New York', 'Brownsville', 'Bushwick', 'Williamsburg', 'Greenpoint', 'Bedford-Stuyvesant', 'Crown Heights', 'Park Slope', 'Cobble Hill', 'Brooklyn Heights', 'DUMBO', 'Red Hook', 'Sunset Park', 'Dyker Heights', 'Gravesend', 'Sheepshead Bay', 'Brighton Beach', 'Coney Island', 'Marine Park', 'Mill Basin', 'Garden City', 'Mineola', 'Westbury', 'Carle Place', 'Hicksville', 'Jericho', 'Syosset', 'Oyster Bay', 'Plainview', 'Woodbury', 'Melville', 'Huntington', 'Huntington Station', 'Cold Spring Harbor', 'Northport', 'Commack', 'Kings Park', 'Smithtown', 'St. James', 'Setauket', 'Port Jefferson', 'Mount Sinai', 'Miller Place', 'Sound Beach', 'Rocky Point', 'Shoreham', 'Wading River', 'Riverhead', 'Calverton', 'Manorville', 'Eastport', 'Center Moriches', 'Moriches', 'Shirley', 'Mastic', 'Mastic Beach', 'East Moriches', 'Westhampton', 'Westhampton Beach', 'Quogue', 'Hampton Bays', 'Southampton', 'Bridgehampton', 'Sag Harbor', 'East Hampton', 'Amagansett', 'Montauk', 'Greenport', 'Southold', 'Mattituck', 'Cutchogue', 'Peconic', 'Aquebogue', 'Jamesport', 'Laurel', 'New Suffolk', 'Orient', 'East Marion', 'Shelter Island', 'Massapequa', 'Massapequa Park', 'Amityville', 'Copiague', 'Lindenhurst', 'Babylon', 'West Babylon', 'North Babylon', 'West Islip', 'Bay Shore', 'Islip', 'Islip Terrace', 'East Islip', 'Great River', 'Oakdale', 'Sayville', 'Bayport', 'Blue Point', 'Patchogue', 'Bellport', 'Brookhaven', 'Medford', 'Farmingville', 'Selden', 'Centereach', 'Lake Grove', 'Holbrook', 'Ronkonkoma', 'Lake Ronkonkoma', 'Bohemia', 'Hauppauge', 'Islandia', 'Central Islip', 'Brentwood', 'Bay Shore', 'Deer Park', 'Wyandanch', 'Wheatley Heights', 'Dix Hills', 'East Northport', 'Greenlawn', 'Elwood', 'Plainedge', 'Bethpage', 'Farmingdale', 'East Farmingdale', 'Levittown', 'Wantagh', 'Seaford', 'Bellmore', 'Merrick', 'Roosevelt', 'Uniondale', 'East Meadow', 'North Merrick', 'North Bellmore', 'North Massapequa', 'Oceanside', 'Rockville Centre', 'Baldwin', 'Freeport', 'Franklin Square', 'Malverne', 'Lynbrook', 'East Rockaway', 'Hewlett', 'Woodmere', 'Cedarhurst', 'Lawrence', 'Inwood', 'Atlantic Beach', 'Lido Beach', 'Point Lookout', 'Island Park', 'Elmont', 'Floral Park', 'New Hyde Park', 'Stewart Manor', 'Garden City Park', 'Herricks', 'Manhasset', 'Great Neck', 'Port Washington', 'Roslyn', 'Roslyn Heights', 'Albertson', 'Williston Park', 'East Williston', 'Muttontown', 'Brookville', 'Old Westbury', 'Glen Head', 'Sea Cliff', 'Locust Valley', 'Bayville', 'Mill Neck', 'Lattingtown', 'Centre Island', 'Cove Neck'],
      'NC': ['Charlotte', 'Raleigh', 'Greensboro', 'Durham', 'Winston-Salem', 'Fayetteville', 'Cary', 'Wilmington', 'High Point', 'Greenville', 'Asheville', 'Concord', 'Gastonia', 'Jacksonville', 'Chapel Hill', 'Rocky Mount', 'Burlington', 'Huntersville', 'Kannapolis', 'Apex', 'Hickory', 'Goldsboro'],
      'ND': ['Fargo', 'Bismarck', 'Grand Forks', 'Minot', 'West Fargo', 'Williston', 'Dickinson', 'Mandan'],
      'OH': ['Columbus', 'Cleveland', 'Cincinnati', 'Toledo', 'Akron', 'Dayton', 'Parma', 'Canton', 'Youngstown', 'Lorain', 'Hamilton', 'Springfield', 'Kettering', 'Elyria', 'Lakewood', 'Cuyahoga Falls', 'Middletown', 'Euclid', 'Newark', 'Mansfield', 'Mentor', 'Beavercreek', 'Cleveland Heights', 'Strongsville', 'Dublin', 'Fairfield', 'Findlay', 'Warren', 'Lancaster', 'Lima', 'Huber Heights', 'Westerville', 'Marion', 'Grove City'],
      'OK': ['Oklahoma City', 'Tulsa', 'Norman', 'Broken Arrow', 'Lawton', 'Edmond', 'Moore', 'Midwest City', 'Enid', 'Stillwater', 'Muskogee'],
      'OR': ['Portland', 'Eugene', 'Salem', 'Gresham', 'Hillsboro', 'Beaverton', 'Bend', 'Medford', 'Springfield', 'Corvallis', 'Albany', 'Tigard', 'Lake Oswego', 'Keizer'],
      'PA': ['Philadelphia', 'Pittsburgh', 'Allentown', 'Reading', 'Scranton', 'Bethlehem', 'Lancaster', 'Harrisburg', 'Altoona', 'Erie', 'York', 'Wilkes-Barre', 'Chester', 'Williamsport', 'Easton', 'Lebanon', 'Hazleton', 'New Castle', 'Johnstown', 'McKeesport', 'Hermitage', 'Greensburg', 'Pottsville', 'Sharon', 'Fairless Hills', 'Levittown', 'Bensalem', 'Bristol', 'Morrisville', 'Langhorne', 'Newtown', 'Doylestown', 'Quakertown', 'Warminster', 'Willow Grove', 'Jenkintown', 'Abington', 'Norristown', 'King of Prussia', 'Conshohocken', 'Lansdale', 'Hatboro', 'Ambler', 'Blue Bell', 'Plymouth Meeting', 'Collegeville', 'Pottstown', 'West Chester', 'Malvern', 'Exton', 'Downingtown', 'Coatesville', 'Phoenixville', 'Media', 'Springfield', 'Broomall', 'Drexel Hill', 'Havertown', 'Upper Darby', 'Darby', 'Collingdale', 'Yeadon', 'Lansdowne', 'Clifton Heights', 'Ridley Park', 'Folsom', 'Sharon Hill', 'Glenolden', 'Prospect Park', 'Norwood', 'Tinicum', 'Essington', 'Eddystone', 'Marcus Hook', 'Trainer', 'Boothwyn', 'Aston', 'Brookhaven', 'Glen Mills', 'Concordville', 'Chadds Ford', 'Kennett Square', 'Oxford', 'Parkesburg', 'Atglen', 'Christiana', 'Gap', 'Strasburg', 'Paradise', 'Bird-in-Hand', 'Intercourse', 'Ephrata', 'Lititz', 'Manheim', 'Mount Joy', 'Elizabethtown', 'Hershey', 'Hummelstown', 'Palmyra', 'Annville', 'Cleona', 'Myerstown', 'Womelsdorf', 'Robesonia', 'Wernersville', 'Sinking Spring', 'Wyomissing', 'Shillington', 'Mohnton', 'Birdsboro', 'Boyertown', 'Gilbertsville', 'Sassamansville', 'Red Hill', 'Pennsburg', 'East Greenville', 'Souderton', 'Telford', 'Sellersville', 'Perkasie', 'Dublin', 'Bedminster', 'Plumsteadville', 'Pipersville', 'Point Pleasant', 'Erwinna', 'Upper Black Eddy', 'Riegelsville', 'Easton', 'Nazareth', 'Bath', 'Wind Gap', 'Pen Argyl', 'Bangor', 'Stroudsburg', 'East Stroudsburg', 'Tannersville', 'Mount Pocono', 'Pocono Summit', 'Tobyhanna', 'Blakeslee', 'Jim Thorpe', 'Lehighton', 'Palmerton', 'Slatington', 'Walnutport', 'Northampton', 'Catasauqua', 'Whitehall', 'Coplay', 'Egypt', 'Macungie', 'Emmaus', 'Alburtis', 'Kutztown', 'Topton', 'Fleetwood'],
      'RI': ['Providence', 'Warwick', 'Cranston', 'Pawtucket', 'East Providence', 'Woonsocket', 'Coventry', 'Cumberland', 'North Providence', 'South Kingstown'],
      'SC': ['Charleston', 'Columbia', 'North Charleston', 'Mount Pleasant', 'Rock Hill', 'Greenville', 'Summerville', 'Sumter', 'Goose Creek', 'Hilton Head Island', 'Florence', 'Spartanburg', 'Myrtle Beach', 'Aiken', 'Anderson'],
      'SD': ['Sioux Falls', 'Rapid City', 'Aberdeen', 'Brookings', 'Watertown', 'Mitchell', 'Yankton', 'Pierre', 'Huron'],
      'TN': ['Nashville', 'Memphis', 'Knoxville', 'Chattanooga', 'Clarksville', 'Murfreesboro', 'Franklin', 'Jackson', 'Johnson City', 'Bartlett', 'Hendersonville', 'Kingsport', 'Collierville', 'Smyrna', 'Cleveland', 'Brentwood', 'Germantown', 'Columbia'],
      'TX': ['Houston', 'San Antonio', 'Dallas', 'Austin', 'Fort Worth', 'El Paso', 'Arlington', 'Corpus Christi', 'Plano', 'Laredo', 'Lubbock', 'Garland', 'Irving', 'Amarillo', 'Grand Prairie', 'Brownsville', 'McKinney', 'Frisco', 'Pasadena', 'Mesquite', 'Killeen', 'McAllen', 'Waco', 'Denton', 'Carrollton', 'Midland', 'Abilene', 'Beaumont', 'Round Rock', 'Odessa', 'Wichita Falls', 'Richardson', 'Lewisville', 'Tyler', 'College Station', 'Pearland', 'San Angelo', 'Allen', 'League City', 'Sugar Land', 'Longview', 'Edinburg', 'Mission', 'Bryan', 'Baytown', 'Pharr', 'Temple', 'Missouri City', 'Flower Mound', 'Harlingen', 'North Richland Hills', 'Victoria', 'Conroe', 'New Braunfels', 'Mansfield', 'Cedar Park', 'Rowlett', 'Port Arthur', 'Euless', 'Georgetown', 'Pflugerville', 'DeSoto', 'San Marcos', 'Grapevine', 'Bedford', 'Galveston', 'Cedar Hill', 'Texas City', 'Wylie', 'Haltom City', 'Keller', 'Coppell', 'Rockwall', 'Huntsville', 'Duncanville', 'Sherman', 'The Colony', 'Burleson', 'Hurst', 'Lancaster', 'Texarkana', 'Friendswood', 'Weslaco'],
      'UT': ['Salt Lake City', 'West Valley City', 'Provo', 'West Jordan', 'Orem', 'Sandy', 'Ogden', 'St. George', 'Layton', 'Taylorsville', 'South Jordan', 'Lehi', 'Logan', 'Murray', 'Draper', 'Bountiful', 'Riverton', 'Herriman', 'Spanish Fork', 'Roy', 'Pleasant Grove', 'Kearns', 'Tooele', 'Cottonwood Heights', 'Springville', 'Cedar City', 'Midvale', 'Kaysville', 'Holladay', 'American Fork'],
      'VT': ['Burlington', 'South Burlington', 'Rutland', 'Barre', 'Montpelier', 'Winooski', 'St. Albans', 'Newport', 'Vergennes'],
      'VA': ['Virginia Beach', 'Norfolk', 'Chesapeake', 'Richmond', 'Newport News', 'Alexandria', 'Hampton', 'Roanoke', 'Portsmouth', 'Suffolk', 'Lynchburg', 'Harrisonburg', 'Leesburg', 'Charlottesville', 'Danville', 'Blacksburg', 'Manassas'],
      'WA': ['Seattle', 'Spokane', 'Tacoma', 'Vancouver', 'Bellevue', 'Kent', 'Everett', 'Renton', 'Spokane Valley', 'Federal Way', 'Yakima', 'Kirkland', 'Bellingham', 'Kennewick', 'Auburn', 'Pasco', 'Marysville', 'Lakewood', 'Redmond', 'Shoreline', 'Richland', 'Sammamish', 'Burien', 'Olympia', 'Lacey', 'Edmonds', 'Bremerton', 'Puyallup'],
      'WV': ['Charleston', 'Huntington', 'Morgantown', 'Parkersburg', 'Wheeling', 'Weirton', 'Fairmont', 'Martinsburg', 'Beckley', 'Clarksburg'],
      'WI': ['Milwaukee', 'Madison', 'Green Bay', 'Kenosha', 'Racine', 'Appleton', 'Waukesha', 'Eau Claire', 'Oshkosh', 'Janesville', 'West Allis', 'La Crosse', 'Sheboygan', 'Wauwatosa', 'Fond du Lac', 'New Berlin', 'Wausau', 'Brookfield', 'Greenfield', 'Beloit', 'Menomonee Falls', 'Franklin', 'Oak Creek', 'Manitowoc', 'West Bend', 'Sun Prairie', 'Superior', 'Stevens Point', 'Neenah'],
      'WY': ['Cheyenne', 'Casper', 'Laramie', 'Gillette', 'Rock Springs', 'Sheridan', 'Green River', 'Evanston', 'Riverton', 'Cody'],
      'DC': ['Washington']
    };

    function updateModels() {
      const makeSelect = document.getElementById('vehMake');
      const modelSelect = document.getElementById('vehModel');
      const selectedMake = makeSelect.value;
      
      modelSelect.innerHTML = '<option value="">Select Model</option>';
      if (selectedMake && vehicleMakes[selectedMake]) {
        vehicleMakes[selectedMake].forEach(model => {
          modelSelect.innerHTML += '<option value="' + model + '">' + model + '</option>';
        });
      }
    }
    
    // Build flat list of all cities for autocomplete
    const allCitiesFlat = [];
    Object.keys(usCities).forEach(state => {
      usCities[state].forEach(city => {
        allCitiesFlat.push(city + ', ' + state);
      });
    });
    allCitiesFlat.sort();
    
    function setupLocationAutocomplete(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      
      // Create dropdown container
      let dropdown = document.getElementById(inputId + '-dropdown');
      if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = inputId + '-dropdown';
        dropdown.style.cssText = 'position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:var(--bg-card);border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;z-index:1000;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.1)';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(dropdown);
      }
      
      const hoverBg = 'var(--bg-card-hover)';
      const normalBg = 'var(--bg-card)';
      const borderColor = 'var(--border)';
      
      input.addEventListener('input', function() {
        const val = this.value.toLowerCase().trim();
        if (val.length < 1) {
          dropdown.style.display = 'none';
          return;
        }
        
        // Prioritize starts-with matches
        const startsWithMatches = allCitiesFlat.filter(c => c.toLowerCase().startsWith(val));
        const containsMatches = allCitiesFlat.filter(c => c.toLowerCase().includes(val) && !c.toLowerCase().startsWith(val));
        const matches = startsWithMatches.concat(containsMatches).slice(0, 15);
        
        if (matches.length === 0) {
          dropdown.style.display = 'none';
          return;
        }
        
        dropdown.innerHTML = matches.map(m => {
          const highlighted = m.replace(new RegExp('(' + val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi'), '<strong>$1</strong>');
          return '<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid ' + borderColor + ';font-size:14px" onmouseover="this.style.background=\'' + hoverBg + '\'" onmouseout="this.style.background=\'' + normalBg + '\'" onclick="selectLocation(\'' + inputId + '\', \'' + m.replace(/'/g, "\\'") + '\')">' + highlighted + '</div>';
        }).join('');
        dropdown.style.display = 'block';
      });
      
      input.addEventListener('blur', function() {
        setTimeout(() => { dropdown.style.display = 'none'; }, 200);
      });
      
      input.addEventListener('focus', function() {
        if (this.value.length >= 1) {
          this.dispatchEvent(new Event('input'));
        }
      });
    }
    
    function selectLocation(inputId, value) {
      const input = document.getElementById(inputId);
      input.value = value;
      document.getElementById(inputId + '-dropdown').style.display = 'none';
      // Dispatch change event to trigger auto-direction detection
      input.dispatchEvent(new Event('change', { bubbles: true }));
    }
    
    // Address autocomplete - combines street addresses with city database
    function setupAddressAutocomplete(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      
      // Create dropdown container
      let dropdown = document.getElementById(inputId + '-dropdown');
      if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = inputId + '-dropdown';
        dropdown.style.cssText = 'position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:var(--bg-card);border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;z-index:1000;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.1)';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(dropdown);
      }
      
      const hoverBg = 'var(--bg-card-hover)';
      const normalBg = 'var(--bg-card)';
      const borderColor = 'var(--border)';
      
      input.addEventListener('input', function() {
        const val = this.value.toLowerCase().trim();
        if (val.length < 2) {
          dropdown.style.display = 'none';
          return;
        }
        
        // Check if user typed a city/state - suggest formatting it
        const cityMatches = allCitiesFlat.filter(c => c.toLowerCase().includes(val)).slice(0, 8);
        
        if (cityMatches.length === 0) {
          dropdown.style.display = 'none';
          return;
        }
        
        dropdown.innerHTML = cityMatches.map(m => {
          const highlighted = m.replace(new RegExp('(' + val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi'), '<strong>$1</strong>');
          return '<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid ' + borderColor + ';font-size:14px" onmouseover="this.style.background=\'' + hoverBg + '\'" onmouseout="this.style.background=\'' + normalBg + '\'" onclick="selectAddress(\'' + inputId + '\', \'' + m.replace(/'/g, "\\'") + '\')">' + highlighted + '</div>';
        }).join('');
        dropdown.style.display = 'block';
      });
      
      input.addEventListener('blur', function() {
        setTimeout(() => { dropdown.style.display = 'none'; }, 200);
      });
      
      input.addEventListener('focus', function() {
        if (this.value.length >= 2) {
          this.dispatchEvent(new Event('input'));
        }
      });
    }
    
    function selectAddress(inputId, cityState) {
      const input = document.getElementById(inputId);
      const currentVal = input.value.trim();
      
      // If user already typed street address, append city/state
      // Otherwise just set the city/state
      if (currentVal && !allCitiesFlat.some(c => currentVal.toLowerCase().includes(c.toLowerCase().split(',')[0]))) {
        // Has content but no recognized city - append city/state
        input.value = currentVal + ', ' + cityState;
      } else {
        input.value = cityState;
      }
      document.getElementById(inputId + '-dropdown').style.display = 'none';
    }
    
    function updateCities(prefix) {
      const stateSelect = document.getElementById(prefix + 'State');
      const citySelect = document.getElementById(prefix + 'City');
      const selectedState = stateSelect.value;
      
      citySelect.innerHTML = '<option value="">Select City</option>';
      if (selectedState && usCities[selectedState]) {
        usCities[selectedState].forEach(city => {
          citySelect.innerHTML += '<option value="' + city + '">' + city + '</option>';
        });
      }
    }
    
    function formatLocation(prefix) {
      const city = document.getElementById(prefix + 'City').value;
      const state = document.getElementById(prefix + 'State').value;
      return city && state ? city + ', ' + state : '';
    }

    function viewTrip(id) {
      // Mark that we're viewing a trip detail (prevents background re-renders from kicking us out)
      currentDetailView = { type: 'trip', id: id };

      const t = appData.trips.find(x => x.id === id);
      if (!t) {
        // Trip was deleted or not found - go back to list
        currentDetailView = null;
        renderTrips(document.getElementById('main-content'));
        return;
      }
      const d = appData.drivers.find(x => x.id === t.driver_id);
      const tr = appData.trucks.find(x => x.id === t.truck_id);
      const orders = appData.orders.filter(o => o.trip_id === id);
      const expenses = appData.expenses.filter(e => e.trip_id === id);
      const f = getTripFin(id);
      
      // Group orders by vehicle_direction
      const ordersByDirection = {};
      vehicleDirections.forEach(dir => {
        ordersByDirection[dir.id] = orders.filter(o => o.vehicle_direction === dir.id);
      });
      const unassignedOrders = orders.filter(o => !o.vehicle_direction);
      
      // Build vehicle sections by direction
      let vehicleSections = '';
      
      vehicleDirections.forEach(dir => {
        const dirOrders = ordersByDirection[dir.id];
        if (dirOrders.length === 0) return;
        
        const dirRevenue = dirOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
        const dirBrokerFee = dirOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
        const dirLocalFee = dirOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
        const dirCleanRevenue = dirRevenue - dirBrokerFee - dirLocalFee;
        
        vehicleSections += '<div style="background:' + dir.color + ';color:white;padding:var(--space-3) var(--space-4);font-weight:var(--weight-bold);margin-top:var(--space-4);border-radius:var(--radius) var(--radius) 0 0;display:flex;justify-content:space-between;align-items:center"><span>' + dir.label + ' (' + dirOrders.length + ' cars)</span><span>Revenue: ' + formatMoney(dirRevenue) + ' | Clean Revenue: ' + formatMoney(dirCleanRevenue) + '</span></div>' +
          '<div class="table-wrapper" style="border:2px solid ' + dir.color + ';border-top:none;border-radius:0 0 var(--radius) var(--radius);margin-bottom:var(--space-2)"><table><thead><tr><th>Order</th><th>Broker</th><th>Vehicle</th><th>Origin</th><th>P</th><th>Destination</th><th>D</th><th>Pick-Up</th><th>Delivery</th><th>Payment</th><th>Broker Fee</th><th>Local Fee</th><th>Revenue</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
          dirOrders.map(o => {
            const noteHtml = o.dispatcher_notes ? '<tr style="background:var(--amber-dim)"><td colspan="14" style="padding:var(--space-2) var(--space-4);font-size:var(--text-sm)"><span style="font-weight:var(--weight-semibold);color:var(--amber)"> Note:</span> ' + o.dispatcher_notes + '</td></tr>' : '';
            const pickupPhoneDisplay = o.pickup_phone ? '<a href="tel:' + o.pickup_phone + '" style="color:var(--blue)" title="' + o.pickup_phone + '"></a>' : '-';
            const deliveryPhoneDisplay = o.delivery_phone ? '<a href="tel:' + o.delivery_phone + '" style="color:var(--green)" title="' + o.delivery_phone + '"></a>' : '-';
            // Payment status with driver collection indicator
            const isCashPayment = ['COD', 'COP', 'LOCAL_COD'].includes(o.payment_type);
            const isCollected = o.driver_paid_status === 'PAID';
            const collectedBadge = isCashPayment ? (isCollected ? '<span class="badge" style="background:var(--green);color:white;margin-left:4px" title="Driver collected $' + (o.driver_paid_amount || 0) + ' via ' + (o.driver_paid_method || 'N/A') + '"> $' + (o.driver_paid_amount || 0) + '</span>' : '<span class="badge" style="background:var(--amber);color:white;margin-left:4px"> Pending</span>') : '';
            return '<tr><td><strong>' + o.order_number + '</strong></td><td>' + (o.broker_name || '-') + '</td><td>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</td><td title="' + (o.pickup_full_address || o.origin || '') + '">' + (o.origin || '-') + '</td><td>' + pickupPhoneDisplay + '</td><td title="' + (o.delivery_full_address || o.destination || '') + '">' + (o.destination || '-') + '</td><td>' + deliveryPhoneDisplay + '</td><td>' + (o.pickup_date ? formatDate(o.pickup_date) : '-') + '</td><td>' + (o.dropoff_date ? formatDate(o.dropoff_date) : '-') + '</td><td><span class="badge badge-blue">' + (o.payment_type || '-') + '</span>' + collectedBadge + '</td><td class="money negative">' + formatMoney(o.broker_fee || 0) + '</td><td class="money negative">' + formatMoney(o.local_fee || 0) + '</td><td class="money">' + formatMoney(o.revenue) + '</td><td class="sticky-col"><div class="actions">' + (o.dispatcher_notes ? '<button class="action-btn" style="background:var(--amber-dim);color:var(--amber)" title="' + o.dispatcher_notes.replace(/"/g, '&quot;') + '"></button>' : '') + '<button class="action-btn" style="background:var(--blue-dim);color:var(--purple)" onclick="openOrderDetailPage(' + o.id + ')">View</button><button class="action-btn edit" onclick="openEditVehicle(' + o.id + ',' + id + ')">Edit</button><button class="action-btn delete" onclick="removeOrder(' + o.id + ',' + id + ')">Del</button></div></td></tr>' + noteHtml;
          }).join('') +
          '<tr style="background:var(--bg-app);font-weight:600"><td colspan="10" style="text-align:right">Subtotal:</td><td class="money negative">' + formatMoney(dirBrokerFee) + '</td><td class="money negative">' + formatMoney(dirLocalFee) + '</td><td class="money">' + formatMoney(dirRevenue) + '</td><td class="sticky-col"></td></tr>' +
          '</tbody></table></div>';
      });
      
      // Add unassigned orders section if any
      if (unassignedOrders.length > 0) {
        const unassignedRevenue = unassignedOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
        const unassignedBrokerFee = unassignedOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
        const unassignedLocalFee = unassignedOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
        const unassignedCleanRevenue = unassignedRevenue - unassignedBrokerFee - unassignedLocalFee;
        
        vehicleSections += '<div style="background:var(--text-secondary);color:white;padding:var(--space-3) var(--space-4);font-weight:var(--weight-bold);margin-top:var(--space-4);border-radius:var(--radius) var(--radius) 0 0;display:flex;justify-content:space-between;align-items:center"><span>UNASSIGNED DIRECTION (' + unassignedOrders.length + ' cars)</span><span>Revenue: ' + formatMoney(unassignedRevenue) + ' | Clean Revenue: ' + formatMoney(unassignedCleanRevenue) + '</span></div>' +
          '<div class="table-wrapper" style="border:2px solid var(--text-secondary);border-top:none;border-radius:0 0 var(--radius) var(--radius)"><table><thead><tr><th>Order</th><th>Broker</th><th>Vehicle</th><th>Origin</th><th>P</th><th>Destination</th><th>D</th><th>Pick-Up</th><th>Delivery</th><th>Payment</th><th>Broker Fee</th><th>Local Fee</th><th>Revenue</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
          unassignedOrders.map(o => {
            const noteHtml = o.dispatcher_notes ? '<tr style="background:var(--amber-dim)"><td colspan="14" style="padding:var(--spacing-2) var(--spacing-4);font-size:var(--text-sm)"><span style="font-weight:var(--weight-semibold);color:var(--amber)"> Note:</span> ' + o.dispatcher_notes + '</td></tr>' : '';
            const pickupPhoneDisplay = o.pickup_phone ? '<a href="tel:' + o.pickup_phone + '" style="color:var(--blue)" title="' + o.pickup_phone + '"></a>' : '-';
            const deliveryPhoneDisplay = o.delivery_phone ? '<a href="tel:' + o.delivery_phone + '" style="color:var(--green)" title="' + o.delivery_phone + '"></a>' : '-';
            // Payment status with driver collection indicator
            const isCashPayment = ['COD', 'COP', 'LOCAL_COD'].includes(o.payment_type);
            const isCollected = o.driver_paid_status === 'PAID';
            const collectedBadge = isCashPayment ? (isCollected ? '<span class="badge" style="background:var(--green);color:white;margin-left:4px" title="Driver collected $' + (o.driver_paid_amount || 0) + ' via ' + (o.driver_paid_method || 'N/A') + '"> $' + (o.driver_paid_amount || 0) + '</span>' : '<span class="badge" style="background:var(--amber);color:white;margin-left:4px"> Pending</span>') : '';
            return '<tr><td><strong>' + o.order_number + '</strong></td><td>' + (o.broker_name || '-') + '</td><td>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</td><td title="' + (o.pickup_full_address || o.origin || '') + '">' + (o.origin || '-') + '</td><td>' + pickupPhoneDisplay + '</td><td title="' + (o.delivery_full_address || o.destination || '') + '">' + (o.destination || '-') + '</td><td>' + deliveryPhoneDisplay + '</td><td>' + (o.pickup_date ? formatDate(o.pickup_date) : '-') + '</td><td>' + (o.dropoff_date ? formatDate(o.dropoff_date) : '-') + '</td><td><span class="badge badge-blue">' + (o.payment_type || '-') + '</span>' + collectedBadge + '</td><td class="money negative">' + formatMoney(o.broker_fee || 0) + '</td><td class="money negative">' + formatMoney(o.local_fee || 0) + '</td><td class="money">' + formatMoney(o.revenue) + '</td><td class="sticky-col"><div class="actions">' + (o.dispatcher_notes ? '<button class="action-btn" style="background:var(--amber-dim);color:var(--amber)" title="' + o.dispatcher_notes.replace(/"/g, '&quot;') + '"></button>' : '') + '<button class="action-btn" style="background:var(--blue-dim);color:var(--purple)" onclick="openOrderDetailPage(' + o.id + ')">View</button><button class="action-btn edit" onclick="openEditVehicle(' + o.id + ',' + id + ')">Edit</button><button class="action-btn delete" onclick="removeOrder(' + o.id + ',' + id + ')">Del</button></div></td></tr>' + noteHtml;
          }).join('') +
          '</tbody></table></div>';
      }

      const cleanRevenue = f.loadRevenue - f.brokerFee - f.localFees;
      const payPeriodText = (t.period_start_date ? formatDate(t.period_start_date) : '-') + '  ' + (t.period_end_date ? formatDate(t.period_end_date) : 'In Progress');
      
      // Get pricing guidance for dispatchers
      const pricingGuidance = getDispatcherPricingGuidance(id);
      const pricingWidget = pricingGuidance ? `
        <div style="background:linear-gradient(135deg,${pricingGuidance.statusColor}15,${pricingGuidance.statusColor}05);border:2px solid ${pricingGuidance.statusColor}40;border-radius:16px;padding:20px;margin-bottom:20px">
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;margin-bottom:16px">
            <div>
              <div style="font-size:12px;color:${pricingGuidance.statusColor};font-weight:600;text-transform:uppercase;letter-spacing:0.5px">Trip Status</div>
              <div style="font-size:24px;font-weight:800;color:${pricingGuidance.statusColor}">${pricingGuidance.tripStatus.replace('_', ' ')}</div>
              <div style="font-size:13px;color:var(--text-secondary);margin-top:4px">${pricingGuidance.statusMessage}</div>
            </div>
            <div style="display:flex;gap:16px;flex-wrap:wrap">
              <div style="text-align:center;background:var(--bg-secondary);padding:12px 16px;border-radius:12px;min-width:100px">
                <div style="font-size:10px;color:var(--text-muted);font-weight:600">LOADED</div>
                <div style="font-size:24px;font-weight:800;color:var(--text-primary)">${pricingGuidance.currentCars}/${pricingGuidance.maxCapacity}</div>
                <div style="font-size:var(--text-xs);color:var(--text-muted)">${pricingGuidance.remainingSlots} slots left</div>
              </div>
              <div style="text-align:center;background:var(--bg-secondary);padding:12px 16px;border-radius:12px;min-width:100px">
                <div style="font-size:10px;color:var(--text-muted);font-weight:600">CURRENT PPC</div>
                <div style="font-size:24px;font-weight:800;color:${pricingGuidance.currentPPC >= pricingGuidance.pricing.target ? 'var(--green)' : 'var(--amber)'}">${formatMoney(pricingGuidance.currentPPC)}</div>
                <div style="font-size:var(--text-xs);color:var(--text-muted)">avg per car</div>
              </div>
              <div style="text-align:center;background:var(--bg-secondary);padding:12px 16px;border-radius:12px;min-width:100px">
                <div style="font-size:10px;color:var(--text-muted);font-weight:600">TRIP PROFIT</div>
                <div style="font-size:24px;font-weight:800;color:${pricingGuidance.currentProfit >= 0 ? 'var(--green)' : 'var(--red)'}">${formatMoney(pricingGuidance.currentProfit)}</div>
                <div style="font-size:var(--text-xs);color:var(--text-muted)">current</div>
              </div>
            </div>
          </div>
          
          <div style="background:var(--bg-secondary);border-radius:var(--radius-lg);padding:var(--spacing-4)">
            <div style="font-size:13px;font-weight:700;color:var(--text-primary);margin-bottom:12px"> DISPATCHER PRICING GUIDANCE</div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px">
              <div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius);text-align:center">
                <div style="font-size:10px;color:var(--red);font-weight:600">MINIMUM PPC</div>
                <div style="font-size:20px;font-weight:800;color:var(--red)">${formatMoney(pricingGuidance.pricing.minimum)}</div>
                <div style="font-size:10px;color:var(--red)">Break-even</div>
              </div>
              <div style="background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);text-align:center;border:2px solid var(--green)">
                <div style="font-size:10px;color:var(--primary-800);font-weight:600">TARGET PPC</div>
                <div style="font-size:20px;font-weight:800;color:var(--green)">${formatMoney(pricingGuidance.pricing.target)}</div>
                <div style="font-size:10px;color:var(--primary-800)">Profitable</div>
              </div>
              <div style="background:var(--blue-dim);padding:var(--spacing-3);border-radius:var(--radius);text-align:center">
                <div style="font-size:10px;color:var(--blue);font-weight:600">MARKET AVG</div>
                <div style="font-size:20px;font-weight:800;color:var(--blue)">${formatMoney(pricingGuidance.pricing.marketAvg)}</div>
                <div style="font-size:10px;color:var(--blue)">Historical</div>
              </div>
              ${pricingGuidance.remainingSlots > 0 ? `
              <div style="background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius);text-align:center">
                <div style="font-size:10px;color:var(--amber);font-weight:600">NEED FOR REMAINING</div>
                <div style="font-size:20px;font-weight:800;color:var(--amber)">${formatMoney(pricingGuidance.pricing.recommendedForRemaining)}</div>
                <div style="font-size:10px;color:var(--amber)">${pricingGuidance.remainingSlots} cars @ this price</div>
              </div>
              ` : ''}
            </div>
            <div style="margin-top:12px;padding:10px;background:var(--bg-tertiary);border-radius:8px;font-size:12px;color:var(--text-secondary)">
              <strong> Tip:</strong> Fixed cost allocation per trip: ${formatMoney(pricingGuidance.breakEvenInfo.fixedCostAllocation)}. 
              Truck gross ratio: ${(pricingGuidance.breakEvenInfo.truckGrossRatio * 100).toFixed(1)}% of revenue stays after fees and driver cut.
            </div>
          </div>
        </div>
      ` : '';
      
      const c = document.getElementById('main-content');
      c.innerHTML = '<div class="header"><div style="display:flex;align-items:center;gap:var(--space-4);flex-wrap:wrap"><button class="btn btn-secondary" onclick="renderTrips(document.getElementById(\'main-content\'))"> Back</button><h2>' + t.trip_number + '</h2><span class="badge ' + getBadge(t.status) + '">' + t.status + '</span>' + (t.status === 'COMPLETED' ? '<span style="color:var(--green);font-weight:var(--weight-semibold)"> Trip Completed</span>' : (t.status === 'AT_TERMINAL' ? '<button class="btn btn-primary" style="background:var(--green)" onclick="markTripCompleted(' + id + ')"> Mark Completed</button>' : '<button class="btn btn-primary" style="background:var(--amber)" onclick="markTripAtTerminal(' + id + ')"> Mark At Terminal</button><button class="btn btn-primary" style="background:var(--green)" onclick="markTripCompleted(' + id + ')"> Mark Completed</button>')) + '</div><div style="display:flex;gap:var(--space-3)"><button class="btn btn-primary" onclick="openAddVehicle(' + id + ')">+ Add Vehicle</button><button class="btn btn-secondary" onclick="openAddExpense(' + id + ')">+ Expense</button><button class="btn btn-secondary" onclick="openTripMap(' + id + ')"> Trip Map</button></div></div>' +
        
        '<div style="display:flex;flex-wrap:wrap;gap:var(--space-3);margin-bottom:var(--space-5)"><div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:var(--space-3) var(--space-4)"><div class="label">Date</div><div class="value" style="font-size:var(--text-lg)">' + formatDate(t.trip_date) + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:150px;padding:var(--space-3) var(--space-4);background:var(--purple-dim);cursor:pointer" onclick="openTripModal(' + id + ')"><div class="label"> Pay Period </div><div class="value" style="font-size:var(--text-xs);color:var(--purple)">' + payPeriodText + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:var(--space-3) var(--space-4);cursor:pointer" onclick="openAssignDriver(' + id + ')"><div class="label">Driver </div><div class="value" style="font-size:var(--text-sm)">' + (d ? d.first_name + ' ' + d.last_name : 'Not Assigned') + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:80px;padding:var(--space-3) var(--space-4);cursor:pointer" onclick="openAssignTruck(' + id + ')"><div class="label">Truck </div><div class="value" style="font-size:var(--text-lg)">' + (tr ? '#' + tr.truck_number : '-') + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:70px;padding:var(--space-3) var(--space-4)"><div class="label">Cars</div><div class="value" style="font-size:var(--text-lg)">' + orders.length + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:var(--space-3) var(--space-4)"><div class="label">Broker Fees</div><div class="value" style="font-size:var(--text-sm);color:var(--red)">' + formatMoney(f.brokerFee) + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:var(--space-3) var(--space-4)"><div class="label">Local Fees</div><div class="value" style="font-size:var(--text-sm);color:var(--red)">' + formatMoney(f.localFees) + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:var(--space-3) var(--space-4)"><div class="label">Revenue</div><div class="value" style="font-size:var(--text-sm)">' + formatMoney(f.loadRevenue) + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:var(--space-3) var(--space-4);background:var(--blue-dim)"><div class="label">Clean Revenue</div><div class="value" style="font-size:var(--text-sm);color:var(--blue)">' + formatMoney(cleanRevenue) + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:var(--space-3) var(--space-4);background:var(--amber-dim);border:2px solid var(--amber)"><div class="label">Driver Cut (' + (t.driver_cut_percent || 32) + '%)</div><div class="value" style="font-size:var(--text-sm);color:var(--amber)">' + formatMoney(f.driverCut) + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:var(--space-3) var(--space-4);background:' + (f.netProfit >= 0 ? 'var(--green-dim)' : 'var(--red-dim)') + '"><div class="label">Net Profit</div><div class="value" style="font-size:var(--text-sm)">' + formatMoney(f.netProfit) + '</div></div></div>' +
        
        pricingWidget +
        
        '<div class="card"><div class="card-header"><h3> Vehicles by Direction (' + orders.length + ' total)</h3></div>' +
        (orders.length === 0 ? '<div style="padding:40px;text-align:center">No vehicles yet. Click "+ Add Vehicle" to add cars to this trip.</div>' : '<div style="padding:var(--space-4)">' + vehicleSections + '</div>') +
        '</div>' +
        
        '<div class="card"><div class="card-header"><h3> Expenses (' + expenses.length + ')</h3><button class="btn btn-primary btn-sm" onclick="openAddExpense(' + id + ')">+ Add Expense</button></div>' + (expenses.length === 0 ? '<div style="padding:40px;text-align:center">No expenses yet. Click "+ Add Expense" to record expenses.</div>' : '<div class="table-wrapper"><table><thead><tr><th>Category</th><th>Description</th><th>Amount</th><th>Actions</th></tr></thead><tbody>' + expenses.map(e => '<tr><td><span class="badge badge-blue">' + e.category + '</span></td><td>' + (e.description || '-') + '</td><td class="money negative">' + formatMoney(e.amount) + '</td><td><button class="action-btn delete" onclick="deleteExpense(' + e.id + ',' + id + ')">Delete</button></td></tr>').join('') + '</tbody></table></div>') + '</div>' +
        
        '<div class="card"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center"><h3> Trip Miles</h3><button class="btn btn-secondary btn-sm" onclick="openEditMiles(' + id + ')"> Edit Miles</button></div><div style="padding:var(--space-5);display:flex;align-items:center;gap:var(--space-5)"><div style="font-size:32px;font-weight:var(--weight-bold);color:var(--blue)">' + (t.miles || 0).toLocaleString() + '</div><div style="color:var(--text-muted)">miles</div></div></div>';
    }

    function openEditMiles(tripId) {
      const t = appData.trips.find(x => x.id === tripId);
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:350px"><div class="modal-header"><h3> Edit Trip Miles</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body"><div class="form-group"><label>Total Miles for this Trip</label><input type="number" id="editTripMiles" value="' + (t.miles || 0) + '" placeholder="e.g., 2800"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveTripMiles(' + tripId + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    async function saveTripMiles(tripId) {
      const miles = parseFloat(document.getElementById('editTripMiles').value) || 0;
      try { await dbUpdate('trips', tripId, { miles }); document.querySelector('.modal-overlay').remove(); showToast('Miles updated!'); await loadAllData(true); viewTrip(tripId); } catch (e) { showToast(e.message, 'error'); }
    }

    // ============ ROUTE SEQUENCE FUNCTIONS ============

    // Store current trip ID for route sequence operations
    let routeSequenceTripId = null;

    function openRouteSequence(tripId) {
      routeSequenceTripId = tripId;
      const trip = appData.trips.find(t => t.id === tripId);
      const tripOrders = appData.orders.filter(o => o.trip_id === tripId);

      if (tripOrders.length === 0) {
        showToast('No vehicles in this trip to sequence', 'warning');
        return;
      }

      // Create array of stops
      // If local_fee > 0, skip PICKUP (local driver already brought vehicle to terminal)
      // Only show DELIVERY for those vehicles
      let stops = [];
      tripOrders.forEach(order => {
        const hasLocalFee = parseFloat(order.local_fee || 0) > 0;

        // Only add PICKUP if no local fee (semi driver picks up themselves)
        if (!hasLocalFee) {
          stops.push({
            orderId: order.id,
            type: 'PICKUP',
            location: order.origin || 'Unknown',
            vehicle: (order.vehicle_year || '') + ' ' + (order.vehicle_make || '') + ' ' + (order.vehicle_model || ''),
            currentSequence: order.pickup_sequence
          });
        }

        // Always add DELIVERY
        stops.push({
          orderId: order.id,
          type: 'DELIVERY',
          location: order.destination || 'Unknown',
          vehicle: (order.vehicle_year || '') + ' ' + (order.vehicle_make || '') + ' ' + (order.vehicle_model || ''),
          currentSequence: order.delivery_sequence,
          isTerminalPickup: hasLocalFee  // Flag to indicate this was a terminal pickup
        });
      });

      // Sort by existing sequence (if set) or by order added
      stops.sort((a, b) => {
        const seqA = a.currentSequence || 999;
        const seqB = b.currentSequence || 999;
        return seqA - seqB;
      });

      // Render modal with sortable list
      const m = document.createElement('div');
      m.className = 'modal-overlay';
      m.onclick = e => { if (e.target === m) m.remove(); };

      m.innerHTML = '<div class="modal" style="max-width:700px;max-height:90vh;display:flex;flex-direction:column">' +
        '<div class="modal-header"><h3> Route Sequence</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div>' +
        '<div class="modal-body" style="overflow-y:auto;flex:1;padding:16px">' +
        '<div style="margin-bottom:16px;display:flex;gap:8px;flex-wrap:wrap">' +
        '<button class="btn btn-secondary" onclick="autoFillSequence()"> Auto-Sort (EastWest)</button>' +
        '<button class="btn btn-secondary" onclick="clearSequence()"> Clear Sequence</button>' +
        '</div>' +
        '<p style="font-size:13px;color:var(--text-muted);margin-bottom:12px">Drag or use arrows to reorder stops. Pickup must come before delivery for each vehicle.</p>' +
        '<div id="sequenceList" class="sequence-container">' + renderSequenceList(stops) + '</div>' +
        '</div>' +
        '<div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveRouteSequence()">Save Sequence</button></div>' +
        '</div>';

      document.body.appendChild(m);

      // Validate initial state
      validateSequence();
    }

    function renderSequenceList(stops) {
      return stops.map((stop, index) => {
        const bgColor = stop.type === 'PICKUP' ? 'rgba(34,197,94,0.15)' : 'rgba(249,115,22,0.15)';
        const borderColor = stop.type === 'PICKUP' ? 'var(--green)' : 'var(--amber)';
        const typeLabel = stop.type === 'PICKUP' ? ' PICKUP' : ' DELIVERY';

        return '<div class="sequence-item" data-order-id="' + stop.orderId + '" data-type="' + stop.type + '" ' +
          'style="background:' + bgColor + ';border-left:4px solid ' + borderColor + ';padding:12px 16px;margin-bottom:8px;border-radius:8px;display:flex;align-items:center;gap:12px">' +
          '<span class="drag-handle" style="color:var(--text-muted);font-size:18px;cursor:grab"></span>' +
          '<span class="sequence-number" style="font-weight:700;font-size:18px;min-width:30px">' + (index + 1) + '.</span>' +
          '<div style="flex:1">' +
          '<div style="font-weight:600;color:' + borderColor + '">' + typeLabel + '</div>' +
          '<div style="font-size:15px;font-weight:500;color:var(--text-primary)">' + stop.vehicle.trim() + '</div>' +
          '<div style="font-size:13px;color:var(--text-muted)"> ' + stop.location + '</div>' +
          '</div>' +
          '<div style="display:flex;flex-direction:column;gap:4px">' +
          '<button onclick="moveSequenceItem(this, -1)" class="btn btn-secondary" style="padding:4px 8px;font-size:14px;min-width:32px"></button>' +
          '<button onclick="moveSequenceItem(this, 1)" class="btn btn-secondary" style="padding:4px 8px;font-size:14px;min-width:32px"></button>' +
          '</div>' +
          '</div>';
      }).join('');
    }

    function moveSequenceItem(btn, direction) {
      const item = btn.closest('.sequence-item');
      const container = document.getElementById('sequenceList');
      const items = Array.from(container.children);
      const currentIndex = items.indexOf(item);
      const newIndex = currentIndex + direction;

      if (newIndex < 0 || newIndex >= items.length) return;

      // Swap elements
      if (direction === -1) {
        container.insertBefore(item, items[newIndex]);
      } else {
        container.insertBefore(items[newIndex], item);
      }

      // Update sequence numbers
      updateSequenceNumbers();

      // Validate pickup before delivery
      validateSequence();
    }

    function updateSequenceNumbers() {
      const items = document.querySelectorAll('#sequenceList .sequence-item');
      items.forEach((item, index) => {
        item.querySelector('.sequence-number').textContent = (index + 1) + '.';
      });
    }

    function validateSequence() {
      const items = Array.from(document.querySelectorAll('#sequenceList .sequence-item'));
      const orderPositions = {};
      let errors = [];

      items.forEach((item, index) => {
        const orderId = item.dataset.orderId;
        const type = item.dataset.type;

        if (!orderPositions[orderId]) {
          orderPositions[orderId] = {};
        }
        orderPositions[orderId][type] = index;
      });

      // Check each order: pickup must come before delivery
      // Skip orders that only have DELIVERY (terminal pickups with local_fee > 0)
      Object.keys(orderPositions).forEach(orderId => {
        const pos = orderPositions[orderId];
        // Only validate if order has BOTH pickup and delivery
        if (pos.PICKUP !== undefined && pos.DELIVERY !== undefined) {
          if (pos.PICKUP >= pos.DELIVERY) {
            errors.push(orderId);
          }
        }
      });

      // Update visual indicators
      items.forEach(item => {
        const orderId = item.dataset.orderId;
        if (errors.includes(orderId)) {
          item.style.boxShadow = '0 0 0 2px var(--red)';
        } else {
          item.style.boxShadow = 'none';
        }
      });

      if (errors.length > 0) {
        showToast(' Pickup must come before delivery for each vehicle', 'warning');
        return false;
      }
      return true;
    }

    async function saveRouteSequence() {
      // Validate first
      if (!validateSequence()) {
        return;
      }

      const items = Array.from(document.querySelectorAll('#sequenceList .sequence-item'));
      const updates = {};

      // Build update map: orderId -> {pickup_sequence, delivery_sequence}
      items.forEach((item, index) => {
        const orderId = item.dataset.orderId;
        const type = item.dataset.type;
        const sequence = index + 1; // 1-based

        if (!updates[orderId]) {
          // Initialize with null for pickup (in case it's a terminal pickup with no pickup stop)
          updates[orderId] = { pickup_sequence: null };
        }

        if (type === 'PICKUP') {
          updates[orderId].pickup_sequence = sequence;
        } else {
          updates[orderId].delivery_sequence = sequence;
        }
      });

      // Update each order in database
      try {
        for (const [orderId, data] of Object.entries(updates)) {
          await dbUpdate('orders', parseInt(orderId), data, true); // Skip conflict check
        }

        showToast(' Route sequence saved!', 'success');
        document.querySelector('.modal-overlay').remove();
        await loadAllData(true);
        viewTrip(routeSequenceTripId);
      } catch (e) {
        showToast(' Failed to save sequence: ' + e.message, 'error');
      }
    }

    async function clearSequence() {
      if (!confirm('Clear route sequence? The Driver App will use its own algorithm instead.')) return;

      const tripOrders = appData.orders.filter(o => o.trip_id === routeSequenceTripId);

      try {
        for (const order of tripOrders) {
          await dbUpdate('orders', order.id, {
            pickup_sequence: null,
            delivery_sequence: null
          }, true); // Skip conflict check
        }

        showToast('Sequence cleared', 'info');
        document.querySelector('.modal-overlay').remove();
        await loadAllData(true);
        viewTrip(routeSequenceTripId);
      } catch (e) {
        showToast('Failed to clear sequence: ' + e.message, 'error');
      }
    }

    function autoFillSequence() {
      // Simple east-to-west sort based on state abbreviations
      const stateOrder = {
        'ME':1,'NH':2,'VT':3,'MA':4,'RI':5,'CT':6,'NY':7,'NJ':8,'PA':9,'DE':10,
        'MD':11,'VA':12,'WV':13,'NC':14,'SC':15,'GA':16,'FL':17,'OH':18,'MI':19,
        'IN':20,'IL':21,'WI':22,'MN':23,'IA':24,'MO':25,'KY':26,'TN':27,'AL':28,
        'MS':29,'AR':30,'LA':31,'TX':32,'OK':33,'KS':34,'NE':35,'SD':36,'ND':37,
        'MT':38,'WY':39,'CO':40,'NM':41,'AZ':42,'UT':43,'NV':44,'ID':45,'WA':46,
        'OR':47,'CA':48,'AK':49,'HI':50
      };

      const container = document.getElementById('sequenceList');
      const items = Array.from(container.children);

      // Extract state from location and sort
      items.sort((a, b) => {
        const locA = a.querySelector('[style*=""]')?.textContent || '';
        const locB = b.querySelector('[style*=""]')?.textContent || '';
        const stateA = locA.match(/,\s*([A-Z]{2})/)?.[1] || 'ZZ';
        const stateB = locB.match(/,\s*([A-Z]{2})/)?.[1] || 'ZZ';
        return (stateOrder[stateA] || 50) - (stateOrder[stateB] || 50);
      });

      // Re-append in sorted order
      items.forEach(item => container.appendChild(item));
      updateSequenceNumbers();
      validateSequence();

      showToast('Sorted east to west by state', 'info');
    }

    async function markTripCompleted(tripId, fromList = false) {
      if (!confirm('Mark this trip as completed? Orders will NOT go to pending local deliveries.')) return;
      try {
        const trip = appData.trips.find(t => t.id === tripId);
        const today = new Date().toISOString().split('T')[0];
        const updateData = { status: 'COMPLETED' };
        // Set period_end_date to today if not already set
        if (!trip.period_end_date) {
          updateData.period_end_date = today;
        }
        await dbUpdate('trips', tripId, updateData);

        // Notify driver that trip is completed
        if (trip?.driver_id) {
          try {
            const tripOrders = appData.orders.filter(o => o.trip_id === tripId);
            await dbInsert('driver_notifications', {
              driver_id: trip.driver_id,
              type: 'trip_completed',
              title: 'Trip Completed',
              body: `Trip ${trip.trip_number} with ${tripOrders.length} vehicle(s) has been marked as completed`,
              trip_id: tripId,
              is_read: false
            });
          } catch (e) { /* silent */ }
        }

        // Set not_for_local_delivery on qualifying local delivery orders so they don't appear in Pending Local Deliveries
        const qualifyingOrders = appData.orders.filter(o =>
          o.trip_id === tripId &&
          parseFloat(o.local_fee || 0) > 0 &&
          isLocalDeliveryState(o.destination, o.delivery_state) &&
          (!o.local_driver_id || o.local_delivery_status === 'UNASSIGNED')
        );
        for (const order of qualifyingOrders) {
          try { await dbUpdate('orders', order.id, { not_for_local_delivery: true }); } catch (e) { /* column may not exist yet */ }
        }

        showToast('Trip marked as completed!');

        await loadAllData(true);
        // If called from list, refresh list; otherwise show trip detail
        if (fromList || !document.querySelector('.header h2')?.textContent?.includes('TRIP')) {
          renderTrips(document.getElementById('main-content'));
        } else {
          viewTrip(tripId);
        }
      } catch (e) { showToast('Failed to update', 'error'); }
    }

    async function markTripAtTerminal(tripId) {
      if (!confirm('Mark trip at terminal? Local delivery orders will be sent to pending local deliveries.')) return;
      try {
        await dbUpdate('trips', tripId, { status: 'AT_TERMINAL' });

        // Clear not_for_local_delivery on qualifying orders so they appear in Pending Local Deliveries
        const qualifyingOrders = appData.orders.filter(o =>
          o.trip_id === tripId &&
          parseFloat(o.local_fee || 0) > 0 &&
          isLocalDeliveryState(o.destination, o.delivery_state) &&
          (!o.local_driver_id || o.local_delivery_status === 'UNASSIGNED')
        );
        for (const order of qualifyingOrders) {
          try { await dbUpdate('orders', order.id, { not_for_local_delivery: false }); } catch (e) { /* column may not exist yet */ }
        }

        showToast('Trip marked at terminal!');

        await loadAllData(true);
        viewTrip(tripId);
      } catch (e) { showToast('Failed to update', 'error'); }
    }

    function openAssignDriver(tripId) {
      const t = appData.trips.find(x => x.id === tripId);
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:400px"><div class="modal-header"><h3>Assign Driver</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body"><div class="form-group"><label>Driver</label><select id="assignDriver" onchange="updateAssignDriverCut()"><option value="">Select</option>' + appData.drivers.filter(d => d.status === 'ACTIVE').map(d => '<option value="' + d.id + '" data-cut="' + (d.cut_percent || 32) + '"' + (t.driver_id === d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('') + '</select></div><div class="form-group"><label>Driver Cut %</label><input type="number" id="assignCut" value="' + (t.driver_cut_percent || 32) + '"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="assignDriver(' + tripId + ')">Assign</button></div></div>';
      document.body.appendChild(m);
    }
    
    function updateAssignDriverCut() {
      const driverSelect = document.getElementById('assignDriver');
      const cutInput = document.getElementById('assignCut');
      const selectedOption = driverSelect.options[driverSelect.selectedIndex];
      
      if (selectedOption && selectedOption.value) {
        const driverCut = selectedOption.getAttribute('data-cut');
        if (driverCut) {
          cutInput.value = driverCut;
        }
      }
    }

    async function assignDriver(tripId) {
      try {
        const driverId = parseInt(document.getElementById('assignDriver').value) || null;
        const tripData = appData.trips.find(t => t.id === tripId);
        const oldDriverId = tripData?.driver_id;
        await dbUpdate('trips', tripId, { driver_id: driverId, driver_cut_percent: parseFloat(document.getElementById('assignCut').value) || 32 });
        // Sync driver_id to all orders on this trip
        const tripOrders = appData.orders.filter(o => o.trip_id === tripId);
        for (const order of tripOrders) {
          await dbUpdate('orders', order.id, { driver_id: driverId });
        }

        // Notify the new driver about all orders on this trip
        if (driverId && tripData) {
          for (const order of tripOrders) {
            try {
              await dbInsert('driver_notifications', {
                driver_id: driverId,
                type: 'trip_assigned',
                title: 'New Vehicle Assigned',
                body: `${order.vehicle_year || ''} ${order.vehicle_make || ''} ${order.vehicle_model || ''} assigned to trip ${tripData.trip_number}`.trim(),
                order_id: order.id,
                trip_id: tripId,
                is_read: false
              });
            } catch (e) { /* silent */ }
          }
        }

        // Notify the old driver they've been unassigned
        if (oldDriverId && oldDriverId !== driverId) {
          try {
            await dbInsert('driver_notifications', {
              driver_id: oldDriverId,
              type: 'trip_unassigned',
              title: 'Removed from Trip',
              body: `You have been removed from trip ${tripData.trip_number}`,
              trip_id: tripId,
              is_read: false
            });
          } catch (e) { /* silent */ }
        }

        document.querySelector('.modal-overlay').remove(); showToast('Driver assigned'); await loadAllData(true); viewTrip(tripId);
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    function openAssignTruck(tripId) {
      const t = appData.trips.find(x => x.id === tripId);
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:400px"><div class="modal-header"><h3>Assign Truck</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body"><div class="form-group"><label>Truck</label><select id="assignTruck"><option value="">Select</option>' + appData.trucks.filter(x => x.status === 'ACTIVE').map(x => '<option value="' + x.id + '"' + (t.truck_id === x.id ? ' selected' : '') + '>#' + x.truck_number + ' - ' + x.truck_type + '</option>').join('') + '</select></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="assignTruck(' + tripId + ')">Assign</button></div></div>';
      document.body.appendChild(m);
    }

    async function assignTruck(tripId) {
      try {
        await dbUpdate('trips', tripId, { truck_id: parseInt(document.getElementById('assignTruck').value) || null });
        document.querySelector('.modal-overlay').remove(); showToast('Truck assigned'); await loadAllData(true); viewTrip(tripId);
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    // Vehicle list for multi-vehicle orders
    let vehicleList = [];
    
    function openAddVehicle(tripId) {
      vehicleList = [];
      
      // Find dispatcher matching current user by user_id OR by email/name
      let userDispatcher = appData.dispatchers.find(d => d.user_id === currentUser.id);
      if (!userDispatcher) {
        userDispatcher = appData.dispatchers.find(d => d.email && d.email.toLowerCase() === currentUser.email.toLowerCase());
      }
      if (!userDispatcher) {
        const fullName = (currentUser.first_name + ' ' + currentUser.last_name).toLowerCase();
        userDispatcher = appData.dispatchers.find(d => d.name && d.name.toLowerCase() === fullName);
      }
      
      const directionOptions = vehicleDirections.map(d => '<option value="' + d.id + '">' + d.label + '</option>').join('');
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:750px;max-height:90vh;display:flex;flex-direction:column"><div class="modal-header"><h3>Add Vehicle</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body" style="overflow-y:auto;flex:1">' +
        '<div class="form-group"><label>Vehicle Direction *</label><select id="orderDirection" style="border:2px solid var(--green);font-weight:600">' + directionOptions + '</select></div>' +
        '<div class="form-row"><div class="form-group"><label>Order #</label><input id="orderNum" value="ORD-' + Date.now().toString().slice(-4) + '"></div><div class="form-group" style="position:relative"><label>Broker</label><input type="text" id="orderBrokerInput" placeholder="Start typing broker..." autocomplete="off"><input type="hidden" id="orderBrokerId"></div></div>' +
        '<div id="newBrokerSection" style="display:none;background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:12px;border:1px solid var(--green-dim)"><div class="form-group" style="margin-bottom:0"><label>New Broker Name *</label><input id="newBrokerName" placeholder="Enter broker name"></div></div>' +
        
        // Vehicle Info Section with separate Year, Make, Model
        '<div style="background:var(--bg-app);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:16px">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><label style="font-weight:600;margin:0"> Vehicle Info</label></div>' +
        '<div class="form-row" style="gap:12px;align-items:flex-end">' +
        '<div class="form-group" style="margin-bottom:0;flex:0 0 100px;position:relative"><label>Year</label><input type="text" id="vehYear" value="' + new Date().getFullYear() + '" placeholder="Year" autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>Make</label><input type="text" id="vehMake" placeholder="Start typing make..." autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>Model</label><input type="text" id="vehModel" placeholder="Start typing model..." autocomplete="off"></div>' +
        '<button type="button" class="btn btn-secondary" onclick="addAnotherVehicle()" style="height:42px;white-space:nowrap">+ Add Another</button></div>' +
        
        // Vehicle List (shows when multiple vehicles added)
        '<div id="vehicleListSection" style="margin-top:12px;display:none">' +
        '<div id="vehicleListItems"></div>' +
        '</div></div>' +
        
        // Pickup Section (Origin + Address + Phone)
        '<div style="background:var(--blue-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px"> PICKUP</label>' +
        '<div class="form-row" style="gap:12px">' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>City/State</label><input type="text" id="orderOrigin" placeholder="Start typing city..." autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:0 0 140px"><label> Phone</label><input type="tel" id="pickupPhone" placeholder="(555) 123-4567"></div></div>' +
        '<div class="form-group" style="margin-bottom:0;margin-top:8px;position:relative"><label>Full Address</label><input type="text" id="pickupFullAddress" placeholder="Start typing full address..." autocomplete="off"></div></div>' +
        
        // Delivery Section (Destination + Address + Phone)
        '<div style="background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px"> DELIVERY</label>' +
        '<div class="form-row" style="gap:12px">' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>City/State</label><input type="text" id="orderDest" placeholder="Start typing city..." autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:0 0 140px"><label> Phone</label><input type="tel" id="deliveryPhone" placeholder="(555) 123-4567"></div></div>' +
        '<div class="form-group" style="margin-bottom:0;margin-top:8px;position:relative"><label>Full Address</label><input type="text" id="deliveryFullAddress" placeholder="Start typing full address..." autocomplete="off"></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Pick-Up Date</label><input type="date" id="orderPickup" value="' + new Date().toISOString().split('T')[0] + '"></div><div class="form-group"><label>Drop-Off Date</label><input type="date" id="orderDropoff"></div></div>' +
        
        // Payment Section with Split Payment
        '<div style="background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:16px"><label style="font-weight:600;margin-bottom:8px;display:block"> Payment (Total for ALL vehicles)</label>' +
        '<div class="form-row" style="gap:12px"><div class="form-group" style="margin-bottom:0"><label>Total Revenue $</label><input type="number" id="orderRev" onchange="updatePaymentSplit()"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label>Payment Type</label><select id="orderPay" onchange="toggleSplitPayment();togglePaymentTerms()"><option value="BILL">BILL (Invoice)</option><option value="COD">COD (Cash on Delivery)</option><option value="COP">COP (Cash on Pickup)</option><option value="LOCAL_COD">LOCAL_COD (Local Driver)</option><option value="CHECK">CHECK</option><option value="SPLIT">SPLIT (Multiple)</option></select></div></div>' +
        '<div id="paymentTermsSection" style="margin-top:12px;padding-top:12px;border-top:1px dashed var(--amber)">' +
        '<div class="form-row" style="grid-template-columns:1fr 1fr 1fr;gap:12px">' +
        '<div class="form-group" style="margin-bottom:0"><label>Payment Terms</label><select id="orderPaymentTerms" onchange="updateOrderDueDate()"><option value="QUICK_PAY">Quick Pay (3 days)</option><option value="NET7">NET 7</option><option value="NET10">NET 10</option><option value="NET15">NET 15</option><option value="NET30" selected>NET 30</option><option value="NET45">NET 45</option><option value="NET60">NET 60</option><option value="CUSTOM">Custom</option></select></div>' +
        '<div class="form-group" style="margin-bottom:0" id="customTermsGroup" style="display:none"><label>Custom Days</label><input type="number" id="orderCustomDays" min="1" max="365" placeholder="Days" onchange="updateOrderDueDate()"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label>Due Date</label><input type="date" id="orderDueDate" readonly style="background:var(--bg-card-hover)"></div></div></div>' +
        '<div id="splitPaymentSection" style="display:none;margin-top:12px;padding-top:12px;border-top:1px dashed var(--amber)">' +
        '<div class="form-row" style="grid-template-columns:1fr 1fr 1fr;gap:12px">' +
        '<div class="form-group" style="margin-bottom:0"><label>COD/COP Amount $</label><input type="number" id="splitCodAmount" value="0" onchange="updateSplitBill()"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label>Bill Amount $</label><input type="number" id="splitBillAmount" value="0" readonly style="background:var(--bg-card-hover)"></div>' +
        '<div class="form-group" style="margin-bottom:0"><label>COD/COP Type</label><select id="splitCodType"><option value="COD">COD</option><option value="COP">COP</option><option value="LOCAL_COD">LOCAL_COD</option></select></div></div></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Broker Fee $</label><input type="number" id="orderBrokerFee" value="0"></div><div class="form-group"><label>Local Fee $</label><input type="number" id="orderFee" value="0"></div></div>' +
        '<div class="form-group"><label> Notes for Dispatchers</label><textarea id="orderNotes" rows="2" placeholder="Add notes visible to all dispatchers..." style="resize:vertical"></textarea></div>' +
        '<div class="form-row"><div class="form-group"><label>Status</label><select id="orderStatus"><option>PENDING</option><option>IN_TRANSIT</option><option>DELIVERED</option></select></div><div class="form-group"><label>Booked By</label>' +
        (currentUser.role === 'ADMIN' || currentUser.role === 'MANAGER' ?
          '<select id="orderDispatcher"><option value="">Select Dispatcher</option>' + appData.dispatchers.map(d => '<option value="' + d.id + '"' + (userDispatcher && userDispatcher.id === d.id ? ' selected' : '') + '>' + d.name + '</option>').join('') + '</select>' :
          '<input type="text" value="' + (userDispatcher ? userDispatcher.name : currentUser.first_name + ' ' + currentUser.last_name) + '" readonly style="background:var(--bg-card-hover);cursor:not-allowed"><input type="hidden" id="orderDispatcher" value="' + (userDispatcher ? userDispatcher.id : '') + '">'
        ) + '</div></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveVehicle(' + tripId + ')">Save</button></div></div>';
      document.body.appendChild(m);
      
      // Setup broker autocomplete
      setupBrokerAutocomplete('orderBrokerInput');
      
      // Setup location autocomplete for city/state
      setupLocationAutocomplete('orderOrigin');
      setupLocationAutocomplete('orderDest');
      
      // Setup address autocomplete for full addresses
      setupAddressAutocomplete('pickupFullAddress');
      setupAddressAutocomplete('deliveryFullAddress');
      
      // Setup year autocomplete
      setupYearAutocomplete('vehYear');

      // Setup make autocomplete
      setupMakeAutocomplete('vehMake');

      // Setup model autocomplete (depends on make)
      setupModelAutocomplete('vehModel');

      // Auto-detect direction when origin/destination changes
      const originInput = document.getElementById('orderOrigin');
      const destInput = document.getElementById('orderDest');
      const directionSelect = document.getElementById('orderDirection');

      function updateAutoDirection() {
        const origin = originInput?.value || '';
        const dest = destInput?.value || '';
        const detected = detectVehicleDirection(origin, dest);
        if (detected && directionSelect) {
          directionSelect.value = detected;
        }
      }

      originInput?.addEventListener('change', updateAutoDirection);
      destInput?.addEventListener('change', updateAutoDirection);
      // Also trigger on blur in case autocomplete doesn't fire change
      originInput?.addEventListener('blur', updateAutoDirection);
      destInput?.addEventListener('blur', updateAutoDirection);
    }
    
    function setupBrokerAutocomplete(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      
      let dropdown = document.getElementById(inputId + '-dropdown');
      if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = inputId + '-dropdown';
        dropdown.style.cssText = 'position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:var(--bg-card);border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;z-index:1000;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.1)';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(dropdown);
      }
      
      input.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        const brokers = appData.brokers || [];
        
        let matches = [];
        if (val.length >= 1) {
          matches = brokers.filter(b => b.name.toLowerCase().includes(val)).slice(0, 10);
        }
        
        // Always add "Add New Broker" option
        const showNew = val.length >= 2 && !brokers.some(b => b.name.toLowerCase() === val);
        
        if (matches.length === 0 && !showNew) {
          dropdown.style.display = 'none';
          return;
        }
        
        dropdown.innerHTML = matches.map(b => {
          const highlighted = b.name.replace(new RegExp('(' + val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi'), '<strong>$1</strong>');
          return '<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid var(--border);font-size:14px" onmouseover="this.style.background=\'var(--bg-card-hover)\'" onmouseout="this.style.background=\'var(--bg-card)\'" onclick="selectBroker(\'' + inputId + '\', ' + b.id + ', \'' + b.name.replace(/'/g, "\\'") + '\')">' + highlighted + '</div>';
        }).join('');
        
        if (showNew) {
          dropdown.innerHTML += '<div style="padding:10px 12px;cursor:pointer;background:var(--green-dim);color:var(--green);font-weight:600;font-size:14px" onmouseover="this.style.background=\'var(--green-dim)\'" onmouseout="this.style.background=\'var(--green-dim)\'" onclick="showNewBrokerField()">+ Add New Broker: "' + input.value + '"</div>';
        }
        
        dropdown.style.display = 'block';
      });
      
      input.addEventListener('blur', function() {
        setTimeout(() => { dropdown.style.display = 'none'; }, 200);
      });
    }
    
    function selectBroker(inputId, brokerId, brokerName) {
      document.getElementById(inputId).value = brokerName;
      document.getElementById('orderBrokerId').value = brokerId;
      document.getElementById(inputId + '-dropdown').style.display = 'none';
      document.getElementById('newBrokerSection').style.display = 'none';
      // Auto-fill payment terms from broker default
      const broker = appData.brokers.find(b => b.id === brokerId);
      const termsSelect = document.getElementById('orderPaymentTerms');
      if (broker && broker.payment_terms && termsSelect) {
        termsSelect.value = broker.payment_terms;
        updateOrderDueDate();
      }
    }
    
    function showNewBrokerField() {
      document.getElementById('newBrokerSection').style.display = 'block';
      document.getElementById('newBrokerName').value = document.getElementById('orderBrokerInput').value;
      document.getElementById('orderBrokerId').value = '__NEW__';
    }
    
    function setupYearAutocomplete(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      
      let dropdown = document.getElementById(inputId + '-dropdown');
      if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = inputId + '-dropdown';
        dropdown.style.cssText = 'position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:var(--bg-card);border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;z-index:1000;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.1)';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(dropdown);
      }
      
      input.addEventListener('input', function() {
        const val = this.value;
        if (val.length < 2) {
          dropdown.style.display = 'none';
          return;
        }
        
        const matches = vehicleYears.filter(y => y.toString().includes(val)).slice(0, 15);
        
        if (matches.length === 0) {
          dropdown.style.display = 'none';
          return;
        }
        
        dropdown.innerHTML = matches.map(y => {
          return '<div style="padding:8px 12px;cursor:pointer;border-bottom:1px solid var(--border);font-size:14px" onmouseover="this.style.background=\'var(--bg-card-hover)\'" onmouseout="this.style.background=\'var(--bg-card)\'" onclick="document.getElementById(\'' + inputId + '\').value=\'' + y + '\';this.parentElement.style.display=\'none\'">' + y + '</div>';
        }).join('');
        dropdown.style.display = 'block';
      });
      
      input.addEventListener('blur', function() {
        setTimeout(() => { dropdown.style.display = 'none'; }, 200);
      });
    }
    
    function setupMakeAutocomplete(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      
      const allMakes = Object.keys(vehicleMakes).sort();
      
      let dropdown = document.getElementById(inputId + '-dropdown');
      if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = inputId + '-dropdown';
        dropdown.style.cssText = 'position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:var(--bg-card);border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;z-index:1000;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.1)';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(dropdown);
      }
      
      // Determine the corresponding model input ID
      const modelInputId = inputId.replace('Make', 'Model');
      
      input.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        
        // Show dropdown on focus with some content even without typing
        const matches = val.length < 1 
          ? allMakes.slice(0, 15) 
          : allMakes.filter(m => m.toLowerCase().startsWith(val)).concat(
              allMakes.filter(m => m.toLowerCase().includes(val) && !m.toLowerCase().startsWith(val))
            ).slice(0, 15);
        
        if (matches.length === 0) {
          dropdown.style.display = 'none';
          return;
        }
        
        const hoverBg = 'var(--bg-card-hover)';
        const normalBg = 'var(--bg-card)';
        
        dropdown.innerHTML = matches.map(m => {
          const highlighted = val.length > 0 ? m.replace(new RegExp('(' + val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi'), '<strong>$1</strong>') : m;
          return '<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid var(--border);font-size:14px" onmouseover="this.style.background=\'' + hoverBg + '\'" onmouseout="this.style.background=\'' + normalBg + '\'" onclick="selectMakeFor(\'' + inputId + '\', \'' + modelInputId + '\', \'' + m.replace(/'/g, "\\'") + '\')">' + highlighted + '</div>';
        }).join('');
        dropdown.style.display = 'block';
      });
      
      input.addEventListener('focus', function() {
        this.dispatchEvent(new Event('input'));
      });
      
      input.addEventListener('blur', function() {
        setTimeout(() => { dropdown.style.display = 'none'; }, 200);
      });
    }
    
    function selectMakeFor(makeInputId, modelInputId, make) {
      document.getElementById(makeInputId).value = make;
      document.getElementById(makeInputId + '-dropdown').style.display = 'none';
      // Clear and focus model field
      const modelInput = document.getElementById(modelInputId);
      if (modelInput) {
        modelInput.value = '';
        modelInput.focus();
      }
    }
    
    // Keep old function for backward compatibility
    function selectMake(make) {
      selectMakeFor('vehMake', 'vehModel', make);
    }
    
    function setupModelAutocomplete(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      
      // Determine the corresponding make input ID
      const makeInputId = inputId.replace('Model', 'Make');
      
      let dropdown = document.getElementById(inputId + '-dropdown');
      if (!dropdown) {
        dropdown = document.createElement('div');
        dropdown.id = inputId + '-dropdown';
        dropdown.style.cssText = 'position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:var(--bg-card);border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;z-index:1000;display:none;box-shadow:0 4px 6px rgba(0,0,0,0.1)';
        input.parentElement.style.position = 'relative';
        input.parentElement.appendChild(dropdown);
      }
      
      const hoverBg = 'var(--bg-card-hover)';
      const normalBg = 'var(--bg-card)';
      const borderColor = 'var(--border)';
      
      input.addEventListener('input', function() {
        const makeInput = document.getElementById(makeInputId);
        const make = makeInput ? makeInput.value : '';
        const val = this.value.toLowerCase();
        
        let models = [];
        if (make && vehicleMakes[make]) {
          models = vehicleMakes[make];
        } else {
          // If no make selected, search all models
          Object.values(vehicleMakes).forEach(m => models = models.concat(m));
          models = [...new Set(models)].sort();
        }
        
        // Show models even with no input if make is selected
        let matches;
        if (val.length < 1) {
          if (make && vehicleMakes[make]) {
            matches = vehicleMakes[make].slice(0, 15);
          } else {
            dropdown.style.display = 'none';
            return;
          }
        } else {
          // Prioritize starts-with matches
          matches = models.filter(m => m.toLowerCase().startsWith(val)).concat(
            models.filter(m => m.toLowerCase().includes(val) && !m.toLowerCase().startsWith(val))
          ).slice(0, 15);
        }
        
        if (matches.length === 0) {
          dropdown.style.display = 'none';
          return;
        }
        
        dropdown.innerHTML = matches.map(m => {
          const highlighted = val.length > 0 ? m.replace(new RegExp('(' + val.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi'), '<strong>$1</strong>') : m;
          return '<div style="padding:10px 12px;cursor:pointer;border-bottom:1px solid ' + borderColor + ';font-size:14px" onmouseover="this.style.background=\'' + hoverBg + '\'" onmouseout="this.style.background=\'' + normalBg + '\'" onclick="document.getElementById(\'' + inputId + '\').value=\'' + m.replace(/'/g, "\\'") + '\';this.parentElement.style.display=\'none\'">' + highlighted + '</div>';
        }).join('');
        dropdown.style.display = 'block';
      });
      
      input.addEventListener('focus', function() {
        this.dispatchEvent(new Event('input'));
      });
      
      input.addEventListener('blur', function() {
        setTimeout(() => { dropdown.style.display = 'none'; }, 200);
      });
    }
    
    function addAnotherVehicle() {
      const year = document.getElementById('vehYear').value;
      const make = document.getElementById('vehMake').value.trim();
      const model = document.getElementById('vehModel').value.trim();
      
      if (!make) {
        showToast('Please enter vehicle make first', 'error');
        return;
      }
      
      vehicleList.push({
        year: parseInt(year) || new Date().getFullYear(),
        make: make,
        model: model,
        makeModel: make + (model ? ' ' + model : '')
      });
      
      // Clear input for next vehicle
      document.getElementById('vehMake').value = '';
      document.getElementById('vehModel').value = '';
      document.getElementById('vehYear').value = new Date().getFullYear();
      
      updateVehicleListDisplay();
      showToast('Vehicle added - add more or click Save');
    }
    
    function removeVehicleFromList(index) {
      vehicleList.splice(index, 1);
      updateVehicleListDisplay();
    }
    
    function updateVehicleListDisplay() {
      const section = document.getElementById('vehicleListSection');
      const container = document.getElementById('vehicleListItems');
      
      if (!container) return;
      
      if (vehicleList.length === 0) {
        section.style.display = 'none';
        return;
      }
      
      section.style.display = 'block';
      
      container.innerHTML = '<div style="background:var(--blue-dim);padding:8px 12px;border-radius:6px;margin-bottom:8px;font-weight:600;font-size:13px;color:var(--purple)"> Vehicles in this order: ' + vehicleList.length + '</div>' +
        vehicleList.map((v, i) => {
        return '<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:var(--bg-card);border-radius:6px;margin-bottom:6px;border:1px solid var(--border)">' +
          '<div style="display:flex;align-items:center;gap:10px">' +
          '<span style="background:var(--purple);color:white;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:11px">' + (i + 1) + '</span>' +
          '<span style="font-size:13px"><strong>' + v.year + ' ' + v.makeModel + '</strong></span></div>' +
          '<button onclick="removeVehicleFromList(' + i + ')" style="background:var(--red-dim);color:var(--red);border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-size:11px"></button></div>';
      }).join('');
    }
    
    function toggleSplitPayment() {
      const payType = document.getElementById('orderPay').value;
      const splitSection = document.getElementById('splitPaymentSection');
      if (payType === 'SPLIT') {
        splitSection.style.display = 'block';
        updatePaymentSplit();
      } else {
        splitSection.style.display = 'none';
      }
    }

    function togglePaymentTerms() {
      const payType = document.getElementById('orderPay').value;
      const termsSection = document.getElementById('paymentTermsSection');
      if (termsSection) {
        // Show payment terms for BILL and SPLIT types
        termsSection.style.display = (payType === 'BILL' || payType === 'SPLIT') ? 'block' : 'none';
        if (payType === 'BILL' || payType === 'SPLIT') {
          updateOrderDueDate();
        }
      }
    }

    function updateOrderDueDate() {
      const terms = document.getElementById('orderPaymentTerms')?.value;
      const customDaysEl = document.getElementById('orderCustomDays');
      const customGroup = document.getElementById('customTermsGroup');
      const dueDateEl = document.getElementById('orderDueDate');
      const dropoffDate = document.getElementById('orderDropoff')?.value;

      // Show/hide custom days input
      if (customGroup) {
        customGroup.style.display = terms === 'CUSTOM' ? 'block' : 'none';
      }

      // Calculate due date
      let days = 30; // default
      switch (terms) {
        case 'QUICK_PAY': days = 3; break;
        case 'NET7': days = 7; break;
        case 'NET10': days = 10; break;
        case 'NET15': days = 15; break;
        case 'NET30': days = 30; break;
        case 'NET45': days = 45; break;
        case 'NET60': days = 60; break;
        case 'CUSTOM':
          days = parseInt(customDaysEl?.value) || 30;
          break;
      }

      // Base date is dropoff date or today
      const baseDate = dropoffDate ? new Date(dropoffDate) : new Date();
      const dueDate = new Date(baseDate);
      dueDate.setDate(dueDate.getDate() + days);

      if (dueDateEl) {
        dueDateEl.value = dueDate.toISOString().split('T')[0];
      }
    }

    function updatePaymentSplit() {
      const totalRev = parseFloat(document.getElementById('orderRev').value) || 0;
      const codAmount = parseFloat(document.getElementById('splitCodAmount')?.value) || 0;
      const billAmountEl = document.getElementById('splitBillAmount');
      if (billAmountEl) {
        billAmountEl.value = Math.max(0, totalRev - codAmount);
      }
    }
    
    function updateSplitBill() {
      const totalRev = parseFloat(document.getElementById('orderRev').value) || 0;
      const codAmount = parseFloat(document.getElementById('splitCodAmount').value) || 0;
      document.getElementById('splitBillAmount').value = Math.max(0, totalRev - codAmount);
    }

    async function saveVehicle(tripId) {
      let brokerId = null;
      let brokerName = null;
      
      const brokerIdField = document.getElementById('orderBrokerId');
      const brokerInputField = document.getElementById('orderBrokerInput');
      
      // Check if adding new broker
      if (brokerIdField.value === '__NEW__') {
        const newName = document.getElementById('newBrokerName').value.trim();
        if (!newName) {
          showToast('Please enter broker name', 'error');
          return;
        }
        
        // Create new broker
        try {
          const newBroker = await dbInsert('brokers', { name: newName });
          brokerId = newBroker.id;
          brokerName = newName;
          showToast('Broker "' + newName + '" added!');
          // Reload brokers
          appData.brokers = await dbFetch('brokers', { order: 'name' });
        } catch (e) {
          showToast('Failed to create broker: ' + e.message, 'error');
          return;
        }
      } else if (brokerIdField.value) {
        brokerId = parseInt(brokerIdField.value) || null;
        const broker = brokerId ? appData.brokers.find(b => b.id === brokerId) : null;
        brokerName = broker ? broker.name : null;
      } else if (brokerInputField.value.trim()) {
        // User typed a name but didn't select - try to find match or create new
        const typedName = brokerInputField.value.trim();
        const existingBroker = appData.brokers.find(b => b.name.toLowerCase() === typedName.toLowerCase());
        if (existingBroker) {
          brokerId = existingBroker.id;
          brokerName = existingBroker.name;
        } else {
          // Create new broker
          try {
            const newBroker = await dbInsert('brokers', { name: typedName });
            brokerId = newBroker.id;
            brokerName = typedName;
            showToast('Broker "' + typedName + '" added!');
            appData.brokers = await dbFetch('brokers', { order: 'name' });
          } catch (e) {
            showToast('Failed to create broker: ' + e.message, 'error');
            return;
          }
        }
      }
      
      // Get shared order info
      const orderNum = document.getElementById('orderNum').value;
      const origin = document.getElementById('orderOrigin').value;
      const destination = document.getElementById('orderDest').value;
      const pickupDate = document.getElementById('orderPickup').value || null;
      const dropoffDate = document.getElementById('orderDropoff').value || null;
      const brokerFee = parseFloat(document.getElementById('orderBrokerFee').value) || 0;
      const localFee = parseFloat(document.getElementById('orderFee').value) || 0;
      const status = document.getElementById('orderStatus').value;
      const dispatcherId = parseInt(document.getElementById('orderDispatcher').value) || null;
      const direction = document.getElementById('orderDirection').value;
      const dispatcherNotes = document.getElementById('orderNotes').value || null;
      
      // Get phone numbers and full addresses
      const pickupPhone = document.getElementById('pickupPhone')?.value || null;
      const deliveryPhone = document.getElementById('deliveryPhone')?.value || null;
      const pickupFullAddress = document.getElementById('pickupFullAddress')?.value || null;
      const deliveryFullAddress = document.getElementById('deliveryFullAddress')?.value || null;
      
      // Handle payment type (including split)
      let paymentType = document.getElementById('orderPay').value;
      let codAmount = 0;
      let billAmount = 0;
      const totalRevenue = parseFloat(document.getElementById('orderRev').value) || 0;

      // Payment terms (for BILL and SPLIT types)
      let paymentTerms = null;
      let dueDate = null;
      let customTermsDays = null;

      if (paymentType === 'BILL' || paymentType === 'SPLIT') {
        paymentTerms = document.getElementById('orderPaymentTerms')?.value || 'NET30';
        dueDate = document.getElementById('orderDueDate')?.value || null;
        if (paymentTerms === 'CUSTOM') {
          customTermsDays = parseInt(document.getElementById('orderCustomDays')?.value) || null;
        }
      }

      if (paymentType === 'SPLIT') {
        codAmount = parseFloat(document.getElementById('splitCodAmount').value) || 0;
        billAmount = totalRevenue - codAmount;
        const codType = document.getElementById('splitCodType').value;
        paymentType = codType; // Store as COD or COP, the split amounts tell the story
      }
      
      // Check if there's a current vehicle in the form that hasn't been added to list
      const currentMake = document.getElementById('vehMake').value.trim();
      const currentModel = document.getElementById('vehModel').value.trim();
      
      if (currentMake) {
        // Add the current form vehicle to list
        const year = document.getElementById('vehYear').value;
        
        vehicleList.push({
          year: parseInt(year) || new Date().getFullYear(),
          make: currentMake,
          model: currentModel,
          makeModel: currentMake + (currentModel ? ' ' + currentModel : '')
        });
      }
      
      // Validate we have at least one vehicle
      if (vehicleList.length === 0) {
        showToast('Please enter vehicle info', 'error');
        return;
      }
      
      try {
        const vehicleCount = vehicleList.length;
        const orderGroupId = orderNum; // Group all vehicles under same order number
        
        // Revenue/fees apply to the ORDER as a whole, stored on first vehicle only
        // This ensures total order revenue is NOT multiplied by vehicle count
        
        // Save each vehicle - revenue/fees only on FIRST vehicle (shared for entire order)
        for (let i = 0; i < vehicleCount; i++) {
          const v = vehicleList[i];
          const vehicleOrderNum = vehicleCount > 1 ? orderNum + '-' + (i + 1) : orderNum;
          
          const data = {
            trip_id: tripId,
            order_number: vehicleOrderNum,
            order_group_id: orderGroupId,
            broker_id: brokerId,
            broker_name: brokerName,
            vehicle_year: v.year,
            vehicle_make: v.make,
            vehicle_model: v.model,
            origin: origin,
            destination: destination,
            pickup_date: pickupDate,
            dropoff_date: dropoffDate,
            pickup_phone: pickupPhone,
            delivery_phone: deliveryPhone,
            pickup_full_address: pickupFullAddress,
            delivery_full_address: deliveryFullAddress,
            revenue: i === 0 ? totalRevenue : 0, // Only first vehicle gets total order revenue
            broker_fee: i === 0 ? brokerFee : 0, // Only first vehicle gets broker fee
            local_fee: i === 0 ? localFee : 0, // Only first vehicle gets local fee
            payment_type: paymentType,
            cod_amount: i === 0 ? codAmount : 0,
            bill_amount: i === 0 ? billAmount : 0,
            payment_terms: paymentTerms,
            due_date: dueDate,
            custom_terms_days: customTermsDays,
            status: status,
            dispatcher_id: dispatcherId,
            vehicle_direction: direction,
            dispatcher_notes: dispatcherNotes
          };
          
          const newOrder = await dbInsert('orders', data);
          await logActivity('VEHICLE_ADDED', { 
            order_id: newOrder.id, 
            trip_id: tripId, 
            vehicle: v.year + ' ' + v.make + ' ' + v.model, 
            origin: origin, 
            destination: destination, 
            revenue: i === 0 ? totalRevenue : 0,
            broker: brokerName 
          });
        }
        
        document.querySelector('.modal-overlay').remove();
        showToast(vehicleCount + ' vehicle' + (vehicleCount > 1 ? 's' : '') + ' added! Order total: $' + totalRevenue);
        vehicleList = [];
        await loadAllData(true); // Force refresh to get new orders
        viewTrip(tripId);
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    async function removeOrder(orderId, tripId) {
      if (!confirm('Remove?')) return;
      const order = appData.orders.find(o => o.id === orderId);
      const trip = appData.trips.find(t => t.id === tripId);
      if (trip?.driver_id && order) {
        try {
          await dbInsert('driver_notifications', {
            driver_id: trip.driver_id,
            type: 'order_removed',
            title: 'Vehicle Removed from Trip',
            body: `${order.vehicle_year || ''} ${order.vehicle_make || ''} ${order.vehicle_model || ''} removed from trip ${trip.trip_number}`.trim(),
            order_id: orderId,
            trip_id: tripId,
            is_read: false
          });
        } catch (e) { /* silent */ }
      }
      try {
        await dbUpdate('orders', orderId, {
          trip_id: null,
          driver_id: null,
          vehicle_direction: null,
          pickup_sequence: null,
          delivery_sequence: null
        });
        await logActivity('VEHICLE_REMOVED_FROM_TRIP', { order_id: orderId, trip_id: tripId, vehicle: order?.vehicle_year + ' ' + order?.vehicle_make + ' ' + order?.vehicle_model });
        showToast('Removed'); await loadAllData(true); viewTrip(tripId);
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    function openEditVehicle(orderId, tripId) {
      const o = appData.orders.find(x => x.id === orderId);
      const brokerOptions = (appData.brokers || []).map(b => '<option value="' + b.id + '"' + (o.broker_id === b.id ? ' selected' : '') + '>' + b.name + '</option>').join('');
      const directionOptions = vehicleDirections.map(d => '<option value="' + d.id + '"' + (o.vehicle_direction === d.id ? ' selected' : '') + '>' + d.label + '</option>').join('');
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      const currentDispatcher = appData.dispatchers.find(d => d.id === o.dispatcher_id);
      const dispatcherField = (currentUser.role === 'ADMIN' || currentUser.role === 'MANAGER') ?
        '<select id="editOrderDispatcher"><option value="">Select Dispatcher</option>' + appData.dispatchers.map(d => '<option value="' + d.id + '"' + (o.dispatcher_id === d.id ? ' selected' : '') + '>' + d.name + '</option>').join('') + '</select>' :
        '<input type="text" value="' + (currentDispatcher ? currentDispatcher.name : '-') + '" readonly style="background:var(--bg-card-hover);cursor:not-allowed"><input type="hidden" id="editOrderDispatcher" value="' + (o.dispatcher_id || '') + '">';
      m.innerHTML = '<div class="modal" style="max-width:700px;max-height:90vh;display:flex;flex-direction:column"><div class="modal-header"><h3>Edit Vehicle</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body" style="overflow-y:auto;flex:1">' +
        '<div class="form-group"><label>Vehicle Direction *</label><select id="editOrderDirection" style="border:2px solid var(--green);font-weight:600">' + directionOptions + '</select></div>' +
        '<div class="form-row"><div class="form-group"><label>Order #</label><input id="editOrderNum" value="' + o.order_number + '"></div><div class="form-group"><label>Broker</label><select id="editOrderBroker"><option value="">Select Broker</option>' + brokerOptions + '<option value="__NEW__">+ Add New Broker</option></select></div></div>' +
        '<div id="editNewBrokerSection" style="display:none;background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:12px;border:1px solid var(--green-dim)"><div class="form-group" style="margin-bottom:0"><label>New Broker Name *</label><input id="editNewBrokerName" placeholder="Enter broker name"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Year</label><input type="number" id="editVehYear" value="' + o.vehicle_year + '"></div><div class="form-group"><label>Make</label><input id="editVehMake" value="' + o.vehicle_make + '"></div></div>' +
        '<div class="form-group"><label>Model</label><input id="editVehModel" value="' + o.vehicle_model + '"></div>' +
        
        // Pickup Section
        '<div style="background:var(--blue-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px"> PICKUP</label>' +
        '<div class="form-row" style="gap:12px">' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>City/State</label><input type="text" id="editOrderOrigin" value="' + (o.origin || '') + '" placeholder="City, State" autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:0 0 140px"><label> Phone</label><input type="tel" id="editPickupPhone" value="' + (o.pickup_phone || '') + '" placeholder="(555) 123-4567"></div></div>' +
        '<div class="form-row" style="gap:12px;margin-top:8px"><div class="form-group" style="margin-bottom:0;flex:1"><label> Contact Name</label><input id="editPickupContactName" value="' + (o.pickup_contact_name || '') + '" placeholder="Pickup contact name"></div><div class="form-group" style="margin-bottom:0;flex:1"><label> Contact Phone</label><input type="tel" id="editPickupContactPhone" value="' + (o.pickup_contact_phone || '') + '" placeholder="Contact phone"></div></div>' +
        '<div class="form-group" style="margin-bottom:0;margin-top:8px"><label> Pickup ETA</label><input type="datetime-local" id="editPickupEta" value="' + (o.pickup_eta ? new Date(o.pickup_eta).toISOString().slice(0,16) : '') + '"></div>' +
        '<div class="form-group" style="margin-bottom:0;margin-top:8px;position:relative"><label>Full Address</label><input type="text" id="editPickupFullAddress" value="' + (o.pickup_full_address || '') + '" placeholder="Full street address" autocomplete="off"></div></div>' +
        
        // Delivery Section
        '<div style="background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:12px">' +
        '<label style="font-weight:600;display:block;margin-bottom:8px"> DELIVERY</label>' +
        '<div class="form-row" style="gap:12px">' +
        '<div class="form-group" style="margin-bottom:0;flex:1;position:relative"><label>City/State</label><input type="text" id="editOrderDest" value="' + (o.destination || '') + '" placeholder="City, State" autocomplete="off"></div>' +
        '<div class="form-group" style="margin-bottom:0;flex:0 0 140px"><label> Phone</label><input type="tel" id="editDeliveryPhone" value="' + (o.delivery_phone || '') + '" placeholder="(555) 123-4567"></div></div>' +
        '<div class="form-row" style="gap:12px;margin-top:8px"><div class="form-group" style="margin-bottom:0;flex:1"><label> Contact Name</label><input id="editDeliveryContactName" value="' + (o.delivery_contact_name || '') + '" placeholder="Delivery contact name"></div><div class="form-group" style="margin-bottom:0;flex:1"><label> Contact Phone</label><input type="tel" id="editDeliveryContactPhone" value="' + (o.delivery_contact_phone || '') + '" placeholder="Contact phone"></div></div>' +
        '<div class="form-group" style="margin-bottom:0;margin-top:8px"><label> Delivery ETA</label><input type="datetime-local" id="editDeliveryEta" value="' + (o.delivery_eta ? new Date(o.delivery_eta).toISOString().slice(0,16) : '') + '"></div>' +
        '<div class="form-group" style="margin-bottom:0;margin-top:8px;position:relative"><label>Full Address</label><input type="text" id="editDeliveryFullAddress" value="' + (o.delivery_full_address || '') + '" placeholder="Full street address" autocomplete="off"></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Pick-Up Date</label><input type="date" id="editOrderPickup" value="' + (o.pickup_date || '') + '"></div><div class="form-group"><label>Drop-Off Date</label><input type="date" id="editOrderDropoff" value="' + (o.dropoff_date || '') + '"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Revenue $</label><input type="number" id="editOrderRev" value="' + o.revenue + '"></div><div class="form-group"><label>Broker Fee $</label><input type="number" id="editOrderBrokerFee" value="' + (o.broker_fee || 0) + '"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Local Fee $</label><input type="number" id="editOrderFee" value="' + (o.local_fee || 0) + '"></div><div class="form-group"><label>Payment</label><select id="editOrderPay"><option' + (o.payment_type === 'BILL' ? ' selected' : '') + '>BILL</option><option' + (o.payment_type === 'COD' ? ' selected' : '') + '>COD</option><option' + (o.payment_type === 'COP' ? ' selected' : '') + '>COP</option><option' + (o.payment_type === 'CHECK' ? ' selected' : '') + '>CHECK</option><option' + (o.payment_type === 'LOCAL_COD' ? ' selected' : '') + '>LOCAL_COD</option></select></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Status</label><select id="editOrderStatus"><option' + (o.status === 'PENDING' ? ' selected' : '') + '>PENDING</option><option' + (o.status === 'IN_TRANSIT' ? ' selected' : '') + '>IN_TRANSIT</option><option' + (o.status === 'DELIVERED' ? ' selected' : '') + '>DELIVERED</option></select></div><div class="form-group"><label>Booked By</label>' + dispatcherField + '</div></div>' +
        '<div class="form-group"><label> Notes for Dispatchers</label><textarea id="editOrderNotes" rows="2" placeholder="Add notes visible to all dispatchers..." style="resize:vertical">' + (o.dispatcher_notes || '') + '</textarea></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="updateVehicle(' + orderId + ',' + tripId + ')">Save</button></div></div>';
      document.body.appendChild(m);
      
      // Setup location autocomplete
      setupLocationAutocomplete('editOrderOrigin');
      setupLocationAutocomplete('editOrderDest');
      setupAddressAutocomplete('editPickupFullAddress');
      setupAddressAutocomplete('editDeliveryFullAddress');
      
      // Handle broker selection change
      document.getElementById('editOrderBroker').addEventListener('change', function() {
        const newBrokerSection = document.getElementById('editNewBrokerSection');
        if (this.value === '__NEW__') {
          newBrokerSection.style.display = 'block';
        } else {
          newBrokerSection.style.display = 'none';
        }
      });
    }

    async function updateVehicle(orderId, tripId) {
      let brokerId = null;
      let brokerName = null;
      
      const brokerSelect = document.getElementById('editOrderBroker');
      
      // Check if adding new broker
      if (brokerSelect.value === '__NEW__') {
        const newName = document.getElementById('editNewBrokerName').value.trim();
        if (!newName) {
          showToast('Please enter broker name', 'error');
          return;
        }
        
        // Create new broker
        try {
          const newBroker = await dbInsert('brokers', { name: newName });
          brokerId = newBroker.id;
          brokerName = newName;
          showToast('Broker "' + newName + '" added!');
        } catch (e) {
          showToast('Failed to create broker: ' + e.message, 'error');
          return;
        }
      } else {
        brokerId = parseInt(brokerSelect.value) || null;
        const broker = brokerId ? appData.brokers.find(b => b.id === brokerId) : null;
        brokerName = broker ? broker.name : null;
      }
      
      const data = { 
        order_number: document.getElementById('editOrderNum').value, 
        broker_id: brokerId, 
        broker_name: brokerName,
        vehicle_year: parseInt(document.getElementById('editVehYear').value) || null,
        vehicle_make: document.getElementById('editVehMake').value, 
        vehicle_model: document.getElementById('editVehModel').value, 
        origin: document.getElementById('editOrderOrigin').value, 
        destination: document.getElementById('editOrderDest').value, 
        pickup_phone: document.getElementById('editPickupPhone')?.value || null,
        delivery_phone: document.getElementById('editDeliveryPhone')?.value || null,
        pickup_full_address: document.getElementById('editPickupFullAddress')?.value || null,
        delivery_full_address: document.getElementById('editDeliveryFullAddress')?.value || null,
        pickup_date: document.getElementById('editOrderPickup').value || null, 
        dropoff_date: document.getElementById('editOrderDropoff').value || null, 
        revenue: parseFloat(document.getElementById('editOrderRev').value) || 0, 
        broker_fee: parseFloat(document.getElementById('editOrderBrokerFee').value) || 0, 
        local_fee: parseFloat(document.getElementById('editOrderFee').value) || 0, 
        payment_type: document.getElementById('editOrderPay').value, 
        status: document.getElementById('editOrderStatus').value, 
        dispatcher_id: parseInt(document.getElementById('editOrderDispatcher').value) || null, 
        vehicle_direction: document.getElementById('editOrderDirection').value,
        dispatcher_notes: document.getElementById('editOrderNotes').value || null,
        pickup_contact_name: document.getElementById('editPickupContactName')?.value || null,
        pickup_contact_phone: document.getElementById('editPickupContactPhone')?.value || null,
        delivery_contact_name: document.getElementById('editDeliveryContactName')?.value || null,
        delivery_contact_phone: document.getElementById('editDeliveryContactPhone')?.value || null,
        pickup_eta: document.getElementById('editPickupEta')?.value ? new Date(document.getElementById('editPickupEta').value).toISOString() : null,
        delivery_eta: document.getElementById('editDeliveryEta')?.value ? new Date(document.getElementById('editDeliveryEta').value).toISOString() : null
      };
      try { 
        await dbUpdate('orders', orderId, data); 
        await logActivity('VEHICLE_UPDATED', { order_id: orderId, trip_id: tripId, vehicle: data.vehicle_year + ' ' + data.vehicle_make + ' ' + data.vehicle_model, revenue: data.revenue, status: data.status });
        document.querySelector('.modal-overlay').remove(); showToast('Vehicle updated'); await loadAllData(true); viewTrip(tripId); 
      } catch (e) { showToast('Update failed: ' + e.message, 'error'); console.error(e); }
    }

    function openAddExpense(tripId) {
      const m = document.createElement('div'); 
      m.className = 'modal-overlay'; 
      m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:450px"><div class="modal-header"><h3>Add Expense</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body"><div class="form-row"><div class="form-group"><label>Category</label><select id="expCat"><option>FUEL</option><option>TOLLS</option><option>PERMITS</option><option>PARKING</option><option>MAINTENANCE</option><option>OTHER</option></select></div><div class="form-group"><label>Amount $</label><input type="number" id="expAmt" step="0.01" placeholder="0.00"></div></div><div class="form-group"><label>Description</label><input id="expDesc" placeholder="e.g., Diesel - Newark"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveExpense(' + tripId + ')">Add Expense</button></div></div>';
      document.body.appendChild(m);
    }

    function previewExpenseReceipt(input) {
      const preview = document.getElementById('expReceiptPreview');
      if (input.files && input.files[0]) {
        const file = input.files[0];
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = e => {
            preview.innerHTML = '<img src="' + e.target.result + '" style="max-width:100%;max-height:150px;border-radius:8px;border:1px solid var(--border)">';
          };
          reader.readAsDataURL(file);
        } else {
          preview.innerHTML = '<div style="padding:12px;background:var(--bg-tertiary);border-radius:8px;display:flex;align-items:center;gap:8px"><span></span> ' + file.name + '</div>';
        }
      } else {
        preview.innerHTML = '';
      }
    }

    async function saveExpense(tripId) {
      // Get form values
      const amtValue = document.getElementById('expAmt')?.value;
      const amount = parseFloat(amtValue) || 0;
      
      // Validate amount
      if (amount <= 0) {
        showToast('Please enter a valid amount', 'error');
        return;
      }
      
      // Show saving indicator
      showToast('Saving expense...');
      
      try {
        const expenseData = { 
          trip_id: tripId, 
          category: document.getElementById('expCat')?.value || 'OTHER', 
          amount: amount, 
          description: document.getElementById('expDesc')?.value || null, 
          expense_date: new Date().toISOString().split('T')[0]
        };
        
        const newExpense = await dbInsert('expenses', expenseData);
        await logActivity('EXPENSE_CREATED', { expense_id: newExpense.id, trip_id: tripId, category: expenseData.category, amount: expenseData.amount });
        
        // Close modal
        document.querySelector('.modal-overlay')?.remove();
        
        showToast('Expense added!'); 
        await loadAllData(true); 
        viewTrip(tripId);
      } catch (e) {
        console.error('Save expense error:', e);
        showToast('Error: ' + (e.message || 'Could not save expense'), 'error');
      }
    }

    async function deleteExpense(id, tripId) {
      if (!confirm('Delete?')) return;
      const expense = appData.expenses.find(e => e.id === id);
      try {
        await dbDelete('expenses', id);
        await logActivity('EXPENSE_DELETED', { expense_id: id, trip_id: tripId, category: expense?.category, amount: expense?.amount });
        showToast('Deleted'); await loadAllData(true); viewTrip(tripId);
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    let selectedOrders = [];

    let ordersFilter = { search: '', status: 'all', broker: 'all', dispatcher: 'all', driver: 'all' };
    // Orders page year filter (default to current year)
    let ordersYear = new Date().getFullYear();
    
    // Debounced search functions
    const debouncedOrderSearch = debounce((value) => {
      ordersFilter.search = value;
      renderOrders(document.getElementById('main-content'));
    }, 300);
    
    const debouncedTripSearch = debounce((value) => {
      tripsSearch = value;
      renderTrips(document.getElementById('main-content'));
    }, 300);
    
    const debouncedMaintenanceSearch = debounce((value) => {
      maintenanceSearch = value;
      renderMaintenance(document.getElementById('main-content'));
    }, 300);
    
    let tripsSearch = '';
    let maintenanceSearch = '';
    
    function renderOrders(c) {
      selectedOrders = [];

      // Year filter for orders (by linked trip date or created_at)
      const yearStart = ordersYear + '-01-01';
      const yearEnd = ordersYear + '-12-31';
      const yearFilteredOrders = appData.orders.filter(o => {
        // If order has a trip, use trip date
        if (o.trip_id) {
          const trip = appData.trips.find(t => t.id === o.trip_id);
          if (trip && trip.trip_date) {
            return trip.trip_date >= yearStart && trip.trip_date <= yearEnd;
          }
        }
        // Otherwise use pickup_date or created_at
        if (o.pickup_date) return o.pickup_date >= yearStart && o.pickup_date <= yearEnd;
        if (o.created_at) return o.created_at >= yearStart && o.created_at <= yearEnd;
        return true; // Include orders without dates
      });

      // Sort orders by ID descending (newest first)
      let filteredOrders = [...yearFilteredOrders].sort((a, b) => b.id - a.id);

      // Apply search filter
      if (ordersFilter.search) {
        const searchLower = ordersFilter.search.toLowerCase();
        filteredOrders = filteredOrders.filter(o => 
          (o.order_number && o.order_number.toLowerCase().includes(searchLower)) ||
          (o.broker_name && o.broker_name.toLowerCase().includes(searchLower)) ||
          (o.vehicle_make && o.vehicle_make.toLowerCase().includes(searchLower)) ||
          (o.vehicle_model && o.vehicle_model.toLowerCase().includes(searchLower))
        );
      }
      
      // Apply status filter (with new unassigned/assigned options)
      if (ordersFilter.status === 'unassigned') {
        filteredOrders = filteredOrders.filter(o => !o.trip_id);
      } else if (ordersFilter.status === 'assigned') {
        filteredOrders = filteredOrders.filter(o => o.trip_id);
      } else if (ordersFilter.status !== 'all') {
        filteredOrders = filteredOrders.filter(o => o.status === ordersFilter.status);
      }

      // Apply dispatcher filter
      if (ordersFilter.dispatcher !== 'all') {
        filteredOrders = filteredOrders.filter(o => String(o.dispatcher_id) === ordersFilter.dispatcher);
      }

      // Apply driver filter (via trip)
      if (ordersFilter.driver !== 'all') {
        filteredOrders = filteredOrders.filter(o => {
          const trip = appData.trips.find(t => t.id === o.trip_id);
          return trip && String(trip.driver_id) === ordersFilter.driver;
        });
      }

      // Apply broker filter
      if (ordersFilter.broker !== 'all') {
        filteredOrders = filteredOrders.filter(o => o.broker_name === ordersFilter.broker);
      }

      // Get unique brokers for filter
      const uniqueBrokers = [...new Set(appData.orders.map(o => o.broker_name).filter(b => b))];
      const brokerOptions = uniqueBrokers.map(b => '<option value="' + b + '"' + (ordersFilter.broker === b ? ' selected' : '') + '>' + b + '</option>').join('');

      // Get dispatchers for filter
      const dispatcherOptions = appData.dispatchers.map(d => '<option value="' + d.id + '"' + (ordersFilter.dispatcher === String(d.id) ? ' selected' : '') + '>' + d.name + '</option>').join('');

      // Get drivers with orders for filter
      const driversWithOrders = [...new Set(appData.orders.filter(o => o.trip_id).map(o => {
        const trip = appData.trips.find(t => t.id === o.trip_id);
        return trip?.driver_id;
      }).filter(Boolean))];
      const driverOptions = driversWithOrders.map(dId => {
        const d = appData.drivers.find(dr => dr.id === dId);
        return d ? '<option value="' + d.id + '"' + (ordersFilter.driver === String(d.id) ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>' : '';
      }).join('');

      // Year selector options for Orders page
      const currentYear = new Date().getFullYear();
      const ordersYearOptions = [currentYear, currentYear - 1, currentYear - 2, currentYear - 3].map(y =>
        '<option value="' + y + '"' + (ordersYear === y ? ' selected' : '') + '>' + y + '</option>'
      ).join('');

      c.innerHTML = '<div class="header"><h2>Vehicles / Orders</h2><div style="display:flex;align-items:center;gap:12px"><div style="display:flex;align-items:center;gap:8px;background:var(--bg-app);padding:var(--spacing-2) var(--spacing-3);border-radius:var(--radius)"><label style="font-weight:var(--weight-semibold);color:var(--text-secondary);font-size:var(--text-sm)">Year:</label><select onchange="ordersYear=parseInt(this.value);renderOrders(document.getElementById(\'main-content\'))" style="padding:var(--spacing-1-5) var(--spacing-2-5);border:1px solid var(--border);border-radius:var(--radius);font-size:var(--text-sm)">' + ordersYearOptions + '</select></div><button class="btn btn-secondary" onclick="exportOrders()"> Export</button><button class="btn" style="background:var(--purple);color:white" onclick="openCreateNewLoad()"> AI Import</button><button class="btn btn-primary" onclick="openOrderModal()">+ New Order</button><button class="btn btn-secondary" id="bulkDeleteBtn" style="display:none;background:var(--red-dim);color:var(--red);border-color:var(--red-dim)" onclick="bulkDeleteOrders()"> Delete Selected (<span id="selectedCount">0</span>)</button></div></div>' +

        // Search and Filters
        '<div style="display:flex;gap:var(--spacing-4);margin-bottom:var(--spacing-5);flex-wrap:wrap;align-items:center;background:var(--bg-app);padding:var(--spacing-4);border-radius:var(--radius)">' +
        '<div style="flex:1;min-width:200px"><input type="text" id="orderSearch" placeholder=" Search by Order ID, Broker, or Vehicle..." value="' + ordersFilter.search + '" oninput="debouncedOrderSearch(this.value)" style="width:100%;padding:var(--spacing-2-5) var(--spacing-3-5);border:1px solid var(--border);border-radius:var(--radius);font-size:var(--text-sm)"></div>' +
        '<div style="display:flex;align-items:center;gap:8px"><label style="font-weight:var(--weight-semibold);color:var(--text-secondary)">Status:</label><select onchange="ordersFilter.status=this.value;renderOrders(document.getElementById(\'main-content\'))" style="padding:var(--spacing-2) var(--spacing-3);border:1px solid var(--border);border-radius:var(--radius);font-size:var(--text-sm)"><option value="all"' + (ordersFilter.status === 'all' ? ' selected' : '') + '>All</option><option value="unassigned"' + (ordersFilter.status === 'unassigned' ? ' selected' : '') + '>Unassigned</option><option value="assigned"' + (ordersFilter.status === 'assigned' ? ' selected' : '') + '>Assigned</option><option value="PENDING"' + (ordersFilter.status === 'PENDING' ? ' selected' : '') + '>Pending</option><option value="IN_TRANSIT"' + (ordersFilter.status === 'IN_TRANSIT' ? ' selected' : '') + '>Picked Up</option><option value="DELIVERED"' + (ordersFilter.status === 'DELIVERED' ? ' selected' : '') + '>Delivered</option></select></div>' +
        '<div style="display:flex;align-items:center;gap:8px"><label style="font-weight:var(--weight-semibold);color:var(--text-secondary)">Dispatcher:</label><select onchange="ordersFilter.dispatcher=this.value;renderOrders(document.getElementById(\'main-content\'))" style="padding:var(--spacing-2) var(--spacing-3);border:1px solid var(--border);border-radius:var(--radius);font-size:var(--text-sm)"><option value="all"' + (ordersFilter.dispatcher === 'all' ? ' selected' : '') + '>All</option>' + dispatcherOptions + '</select></div>' +
        '<div style="display:flex;align-items:center;gap:8px"><label style="font-weight:var(--weight-semibold);color:var(--text-secondary)">Driver:</label><select onchange="ordersFilter.driver=this.value;renderOrders(document.getElementById(\'main-content\'))" style="padding:var(--spacing-2) var(--spacing-3);border:1px solid var(--border);border-radius:var(--radius);font-size:var(--text-sm)"><option value="all"' + (ordersFilter.driver === 'all' ? ' selected' : '') + '>All</option>' + driverOptions + '</select></div>' +
        '<div style="display:flex;align-items:center;gap:8px"><label style="font-weight:var(--weight-semibold);color:var(--text-secondary)">Broker:</label><select onchange="ordersFilter.broker=this.value;renderOrders(document.getElementById(\'main-content\'))" style="padding:var(--spacing-2) var(--spacing-3);border:1px solid var(--border);border-radius:var(--radius);font-size:var(--text-sm)"><option value="all"' + (ordersFilter.broker === 'all' ? ' selected' : '') + '>All Brokers</option>' + brokerOptions + '</select></div>' +
        '<button class="btn btn-secondary" style="padding:var(--spacing-2) var(--spacing-4)" onclick="ordersFilter={search:\'\',status:\'all\',broker:\'all\',dispatcher:\'all\',driver:\'all\'};renderOrders(document.getElementById(\'main-content\'))">Clear</button>' +
        '<span style="color:var(--text-muted);font-size:var(--text-sm)">Showing ' + filteredOrders.length + ' of ' + yearFilteredOrders.length + '</span>' +
        '</div>' +
        
        '<div class="card"><div class="table-wrapper"><table><thead><tr><th style="width:40px"><input type="checkbox" id="selectAllOrders" onchange="toggleSelectAllOrders(this.checked)"></th><th>Order</th><th>Trip</th><th>Driver</th><th>Broker</th><th>Vehicle</th><th>Origin</th><th>Destination</th><th></th><th>Pick-Up</th><th>Delivery</th><th>Payment</th><th>Broker Fee</th><th>Local Fee</th><th>Revenue</th><th>Status</th><th class="sticky-col">Actions</th></tr></thead><tbody>' + 
        (filteredOrders.length === 0 ? '<tr><td colspan="18" style="text-align:center;padding:var(--spacing-10)">No orders found</td></tr>' : 
        filteredOrders.map(o => { 
          const t = appData.trips.find(x => x.id === o.trip_id);
          const driver = t ? appData.drivers.find(d => d.id === t.driver_id) : null;
          const driverName = driver ? driver.first_name.charAt(0) + '. ' + driver.last_name : '-';
          const phoneInfo = (o.pickup_phone || o.delivery_phone) ? '<span title="P: ' + (o.pickup_phone || '-') + '&#10;D: ' + (o.delivery_phone || '-') + '" style="cursor:help"></span>' : '-';
          const noteHtml = o.dispatcher_notes ? '<tr style="background:var(--amber-dim)"><td></td><td colspan="17" style="padding:var(--spacing-2) var(--spacing-4);font-size:var(--text-sm)"><span style="font-weight:600;color:var(--amber)"> Note:</span> ' + o.dispatcher_notes + '</td></tr>' : '';
          const assignBtn = t ? '<button class="action-btn" style="background:var(--red-dim);color:var(--red)" onclick="unassignOrderFromTrip(' + o.id + ')" title="Unassign from trip"></button>' : '<button class="action-btn" style="background:var(--blue-dim);color:var(--blue)" onclick="openAssignToTrip(' + o.id + ')" title="Assign to trip">+</button>';
          return '<tr><td><input type="checkbox" class="order-checkbox" data-id="' + o.id + '" onchange="toggleOrderSelection(' + o.id + ')"></td><td><strong>' + o.order_number + '</strong></td><td>' + (t ? '<span class="badge badge-purple">' + t.trip_number + '</span>' : '<span style="color:var(--text-muted)">Unassigned</span>') + '</td><td>' + (driver ? '<span class="badge badge-green">' + driverName + '</span>' : '<span style="color:var(--text-muted)">-</span>') + '</td><td>' + (o.broker_name || '-') + '</td><td>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</td><td title="' + (o.pickup_full_address || o.origin || '') + '">' + (o.origin || '-') + '</td><td title="' + (o.delivery_full_address || o.destination || '') + '">' + (o.destination || '-') + '</td><td>' + phoneInfo + '</td><td>' + (o.pickup_date ? formatDate(o.pickup_date) : '-') + '</td><td>' + (o.dropoff_date ? formatDate(o.dropoff_date) : '-') + '</td><td><span class="badge badge-blue">' + (o.payment_type || '-') + '</span></td><td class="money negative">' + formatMoney(o.broker_fee || 0) + '</td><td class="money negative">' + formatMoney(o.local_fee || 0) + '</td><td class="money">' + formatMoney(o.revenue) + '</td><td><span class="badge ' + getBadge(o.status) + '">' + o.status + '</span></td><td class="sticky-col"><div class="actions">' + assignBtn + (o.dispatcher_notes ? '<button class="action-btn" style="background:var(--amber-dim);color:var(--amber)" title="' + o.dispatcher_notes.replace(/"/g, '&quot;') + '"></button>' : '') + '<button class="action-btn" style="background:var(--blue-dim);color:var(--purple)" onclick="openOrderDetailPage(' + o.id + ')">View</button><button class="action-btn edit" onclick="openOrderModal(' + o.id + ')">Edit</button><button class="action-btn delete" onclick="deleteOrder(' + o.id + ')">Del</button></div></td></tr>' + noteHtml; 
        }).join('')) + 
        '</tbody></table></div></div>';
    }

    function toggleSelectAllOrders(checked) {
      const checkboxes = document.querySelectorAll('.order-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = checked;
        const id = parseInt(cb.dataset.id);
        if (checked) {
          if (!selectedOrders.includes(id)) selectedOrders.push(id);
        } else {
          selectedOrders = [];
        }
      });
      updateBulkDeleteBtn();
    }

    function toggleOrderSelection(orderId) {
      const idx = selectedOrders.indexOf(orderId);
      if (idx > -1) {
        selectedOrders.splice(idx, 1);
      } else {
        selectedOrders.push(orderId);
      }
      
      // Update select all checkbox
      const checkboxes = document.querySelectorAll('.order-checkbox');
      const selectAll = document.getElementById('selectAllOrders');
      selectAll.checked = selectedOrders.length === checkboxes.length && checkboxes.length > 0;
      
      updateBulkDeleteBtn();
    }

    function updateBulkDeleteBtn() {
      const btn = document.getElementById('bulkDeleteBtn');
      const count = document.getElementById('selectedCount');
      if (selectedOrders.length > 0) {
        btn.style.display = 'inline-block';
        count.textContent = selectedOrders.length;
      } else {
        btn.style.display = 'none';
      }
    }

    async function bulkDeleteOrders() {
      if (selectedOrders.length === 0) return;
      
      if (!confirm('Delete ' + selectedOrders.length + ' selected order(s)?\n\nThis cannot be undone!')) return;
      
      showToast('Deleting ' + selectedOrders.length + ' orders...');
      
      let deleted = 0;
      for (const id of selectedOrders) {
        try {
          await dbDelete('orders', id);
          deleted++;
        } catch (e) {
          console.error('Failed to delete order', id, e);
        }
      }
      
      selectedOrders = [];
      showToast('Deleted ' + deleted + ' orders');
      await loadAllData(true);
      renderOrders(document.getElementById('main-content'));
    }

    function openOrderModal(id = null) {
      const o = id ? appData.orders.find(x => x.id === id) : null;
      // Track editing start time for conflict detection
      if (o) startEditing('orders', id, o.updated_at);
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) { clearEditing('orders', id); m.remove(); } };
      m.innerHTML = '<div class="modal"><div class="modal-header"><h3>' + (o ? 'Edit' : 'New') + ' Order</h3><button class="modal-close" onclick="clearEditing(\'orders\',' + id + ');this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body"><div class="form-row"><div class="form-group"><label>Order #</label><input id="orderNum" value="' + (o?.order_number || 'ORD-' + Date.now().toString().slice(-4)) + '"></div><div class="form-group"><label>Trip</label><select id="orderTrip"><option value="">Unassigned</option>' + appData.trips.map(t => '<option value="' + t.id + '"' + (o?.trip_id === t.id ? ' selected' : '') + '>' + t.trip_number + '</option>').join('') + '</select></div></div><div class="form-row"><div class="form-group"><label>Driver</label><select id="orderDriver"><option value="">Unassigned</option>' + appData.drivers.filter(d => d.status === 'ACTIVE').map(d => '<option value="' + d.id + '"' + (o?.driver_id === d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('') + '</select></div><div class="form-group"><label>Broker</label><input id="orderBroker" value="' + (o?.broker_name || '') + '"></div></div><div class="form-row"><div class="form-group"><label>Year</label><input type="number" id="vehYear" value="' + (o?.vehicle_year || 2024) + '"></div><div class="form-group"><label>Make</label><input id="vehMake" value="' + (o?.vehicle_make || '') + '"></div></div><div class="form-row"><div class="form-group"><label>Model</label><input id="vehModel" value="' + (o?.vehicle_model || '') + '"></div><div class="form-group"><label>Color</label><input id="vehColor" value="' + (o?.vehicle_color || '') + '"></div><div class="form-group"><label>Body Type</label><input id="vehBodyType" value="' + (o?.vehicle_body_type || '') + '" placeholder="e.g. Sedan, SUV, Truck"></div></div><div class="form-row"><div class="form-group"><label>Origin</label><input id="orderOrigin" value="' + (o?.origin || '') + '"></div><div class="form-group"><label>Destination</label><input id="orderDest" value="' + (o?.destination || '') + '"></div></div><div class="form-row"><div class="form-group"><label>Revenue $</label><input type="number" id="orderRev" value="' + (o?.revenue || '') + '"></div><div class="form-group"><label>Local Fee $</label><input type="number" id="orderFee" value="' + (o?.local_fee || 0) + '"></div></div><div class="form-row"><div class="form-group"><label>Payment</label><select id="orderPay"><option' + (o?.payment_type === 'BILL' ? ' selected' : '') + '>BILL</option><option' + (o?.payment_type === 'COD' ? ' selected' : '') + '>COD</option><option' + (o?.payment_type === 'COP' ? ' selected' : '') + '>COP</option><option' + (o?.payment_type === 'CHECK' ? ' selected' : '') + '>CHECK</option><option' + (o?.payment_type === 'LOCAL_COD' ? ' selected' : '') + '>LOCAL_COD</option></select></div><div class="form-group"><label>Status</label><select id="orderStatus"><option' + (o?.status === 'PENDING' ? ' selected' : '') + '>PENDING</option><option' + (o?.status === 'IN_TRANSIT' ? ' selected' : '') + '>IN_TRANSIT</option><option' + (o?.status === 'DELIVERED' ? ' selected' : '') + '>DELIVERED</option></select></div></div><div class="form-group"><label> Notes for Dispatchers</label><textarea id="orderNotes" rows="2" placeholder="Add notes visible to all dispatchers..." style="resize:vertical">' + (o?.dispatcher_notes || '') + '</textarea></div><div style="border-top:1px solid var(--border);margin:16px 0 8px;padding-top:12px"><strong style="font-size:13px;color:var(--text-secondary)"> Pickup Contact</strong></div><div class="form-row"><div class="form-group"><label>Contact Name</label><input id="pickupContactName" value="' + (o?.pickup_contact_name || '') + '" placeholder="Pickup contact name"></div><div class="form-group"><label>Contact Phone</label><input id="pickupContactPhone" value="' + (o?.pickup_contact_phone || '') + '" placeholder="Phone number"></div></div><div style="border-top:1px solid var(--border);margin:16px 0 8px;padding-top:12px"><strong style="font-size:13px;color:var(--text-secondary)"> Delivery Contact</strong></div><div class="form-row"><div class="form-group"><label>Contact Name</label><input id="deliveryContactName" value="' + (o?.delivery_contact_name || '') + '" placeholder="Delivery contact name"></div><div class="form-group"><label>Contact Phone</label><input id="deliveryContactPhone" value="' + (o?.delivery_contact_phone || '') + '" placeholder="Phone number"></div></div><div style="border-top:1px solid var(--border);margin:16px 0 8px;padding-top:12px"><strong style="font-size:13px;color:var(--text-secondary)"> ETA</strong></div><div class="form-row"><div class="form-group"><label>Pickup ETA</label><input type="datetime-local" id="pickupEta" value="' + (o?.pickup_eta ? new Date(o.pickup_eta).toISOString().slice(0,16) : '') + '"></div><div class="form-group"><label>Delivery ETA</label><input type="datetime-local" id="deliveryEta" value="' + (o?.delivery_eta ? new Date(o.delivery_eta).toISOString().slice(0,16) : '') + '"></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="clearEditing(\'orders\',' + id + ');this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveOrder(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    async function saveOrder(id) {
      const tripId = parseInt(document.getElementById('orderTrip').value) || null;
      // Validate trip_id if provided
      if (tripId && !appData.trips.find(t => t.id === tripId)) {
        showToast('Invalid trip selected', 'error');
        return;
      }
      const orderNumber = document.getElementById('orderNum').value;
      // Check for duplicate order number (excluding current order if editing)
      const duplicate = appData.orders.find(o => o.order_number === orderNumber && o.id !== id);
      if (duplicate) {
        showToast('Order number already exists', 'error');
        return;
      }
      const pickupEtaVal = document.getElementById('pickupEta').value;
      const deliveryEtaVal = document.getElementById('deliveryEta').value;
      const data = { order_number: orderNumber, trip_id: tripId, driver_id: parseInt(document.getElementById('orderDriver').value) || null, broker_name: document.getElementById('orderBroker').value || null, vehicle_year: parseInt(document.getElementById('vehYear').value) || null, vehicle_make: document.getElementById('vehMake').value, vehicle_model: document.getElementById('vehModel').value, vehicle_color: document.getElementById('vehColor').value || null, vehicle_body_type: document.getElementById('vehBodyType').value || null, origin: document.getElementById('orderOrigin').value, destination: document.getElementById('orderDest').value, revenue: parseFloat(document.getElementById('orderRev').value) || 0, local_fee: parseFloat(document.getElementById('orderFee').value) || 0, payment_type: document.getElementById('orderPay').value, status: document.getElementById('orderStatus').value, pickup_contact_name: document.getElementById('pickupContactName').value || null, pickup_contact_phone: document.getElementById('pickupContactPhone').value || null, delivery_contact_name: document.getElementById('deliveryContactName').value || null, delivery_contact_phone: document.getElementById('deliveryContactPhone').value || null, pickup_eta: pickupEtaVal ? new Date(pickupEtaVal).toISOString() : null, delivery_eta: deliveryEtaVal ? new Date(deliveryEtaVal).toISOString() : null, dispatcher_notes: document.getElementById('orderNotes').value || null };
      try { 
        if (id) { 
          await dbUpdate('orders', id, data); 
          await logActivity('ORDER_UPDATED', { order_id: id, order_number: data.order_number, vehicle: data.vehicle_year + ' ' + data.vehicle_make + ' ' + data.vehicle_model, revenue: data.revenue });
        } else { 
          const newOrder = await dbInsert('orders', data); 
          await logActivity('ORDER_CREATED', { order_id: newOrder.id, order_number: data.order_number, vehicle: data.vehicle_year + ' ' + data.vehicle_make + ' ' + data.vehicle_model, revenue: data.revenue });
        } 
        document.querySelector('.modal-overlay').remove(); showToast('Saved!'); await loadAllData(true); renderOrders(document.getElementById('main-content')); 
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteOrder(id) {
      if (!confirm('Delete?')) return;
      const order = appData.orders.find(o => o.id === id);
      try {
        await dbDelete('orders', id);
        await logActivity('ORDER_DELETED', { order_id: id, order_number: order?.order_number });
        showToast('Deleted'); await loadAllData(true); renderOrders(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    function renderDrivers(c) {
      // Clear detail view flag when going back to drivers list
      currentDetailView = null;
      
      // Check for document expiration alerts
      const today = new Date();
      const alerts = [];
      appData.drivers.forEach(d => {
        const driverFiles = (appData.driver_files || []).filter(f => f.driver_id === d.id && f.expiration_date);
        driverFiles.forEach(f => {
          const expDate = new Date(f.expiration_date);
          const daysUntil = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
          if (daysUntil <= 7 && daysUntil >= 0) {
            alerts.push({ driver: d.first_name + ' ' + d.last_name, doc: f.file_type, days: daysUntil, expired: false });
          } else if (daysUntil < 0) {
            alerts.push({ driver: d.first_name + ' ' + d.last_name, doc: f.file_type, days: Math.abs(daysUntil), expired: true });
          }
        });
      });
      
      const alertsHtml = alerts.length > 0 ? '<div style="background:var(--red-dim);border:1px solid var(--red-dim);border-radius:8px;padding:16px;margin-bottom:24px"><strong style="color:var(--red)"> Document Expiration Alerts</strong><div style="margin-top:12px">' + alerts.map(a => '<div style="padding:8px;background:var(--bg-card);border-radius:4px;margin-top:8px;display:flex;justify-content:space-between;align-items:center"><span><strong>' + a.driver + '</strong> - ' + a.doc + '</span><span class="badge ' + (a.expired ? 'badge-red' : 'badge-amber') + '">' + (a.expired ? 'EXPIRED ' + a.days + ' days ago' : a.days === 0 ? 'EXPIRES TODAY' : 'Expires in ' + a.days + ' days') + '</span></div>').join('') + '</div></div>' : '';
      
      c.innerHTML = '<div class="header"><h2> Drivers</h2><div style="display:flex;gap:8px"><button class="btn btn-primary" onclick="openDriverModal()">+ New Driver</button><button class="btn btn-primary" style="background:var(--amber)" onclick="openDriverModal(null, \'OWNER_OP\')">+ Add Owner-OP</button></div></div>' + alertsHtml + '<div class="drivers-grid">' + (appData.drivers.length === 0 ? '<div style="text-align:center;padding:60px;grid-column:1/-1">No drivers yet</div>' : appData.drivers.map(d => { 
        const trips = appData.trips.filter(t => t.driver_id === d.id); 
        let earn = 0; 
        trips.forEach(t => earn += getTripFin(t.id).driverCut); 
        const driverFiles = (appData.driver_files || []).filter(f => f.driver_id === d.id);
        const qualFiles = driverFiles.filter(f => f.category === 'QUALIFICATION').length;
        const persFiles = driverFiles.filter(f => f.category === 'PERSONAL').length;
        const expiredCount = driverFiles.filter(f => f.expiration_date && new Date(f.expiration_date) < today).length;
        const openTickets = (appData.tickets || []).filter(t => t.driver_id === d.id && !['RESOLVED', 'DISMISSED'].includes(t.status)).length;
        const openViolations = (appData.violations || []).filter(v => v.driver_id === d.id && !['RESOLVED', 'DISMISSED'].includes(v.status)).length;
        const openClaims = (appData.claims || []).filter(c => c.driver_id === d.id && !['SETTLED', 'DENIED'].includes(c.status)).length;
        
        const isOwnerOp = d.driver_type === 'OWNER_OP';
        const percentLabel = isOwnerOp ? (d.dispatch_fee_percent || 0) + '% dispatch fee' : (d.cut_percent || 32) + '% cut';
        const typeBadge = isOwnerOp ? '<span class="badge" style="background:var(--amber);color:white;font-size:10px;margin-left:8px">Owner-OP</span>' : '';
        return '<div class="driver-card"><div style="display:flex;align-items:center;gap:12px;margin-bottom:16px"><div class="driver-avatar">' + d.first_name[0] + d.last_name[0] + '</div><div><h4 style="margin:0">' + d.first_name + ' ' + d.last_name + typeBadge + '</h4><p style="color:var(--text-muted);font-size:12px;margin:0">' + percentLabel + '</p></div><span class="badge ' + getBadge(d.status) + '" style="margin-left:auto">' + d.status + '</span></div><p style="color:var(--text-muted);font-size:13px"> ' + d.phone + '</p>' + (d.email ? '<p style="color:var(--text-muted);font-size:13px"> ' + d.email + '</p>' : '') + '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px"><span style="font-size:11px;background:var(--blue-dim);color:var(--blue);padding:4px 8px;border-radius:4px"> ' + qualFiles + ' Qual</span><span style="font-size:11px;background:var(--purple-dim);color:var(--purple);padding:4px 8px;border-radius:4px"> ' + persFiles + ' Pers</span>' + (expiredCount > 0 ? '<span style="font-size:11px;background:var(--red-dim);color:var(--red);padding:4px 8px;border-radius:4px"> ' + expiredCount + ' Exp</span>' : '') + (openTickets > 0 ? '<span style="font-size:11px;background:var(--amber-dim);color:var(--amber);padding:4px 8px;border-radius:4px"> ' + openTickets + '</span>' : '') + (openViolations > 0 ? '<span style="font-size:11px;background:var(--purple-dim);color:var(--purple);padding:4px 8px;border-radius:4px"> ' + openViolations + '</span>' : '') + (openClaims > 0 ? '<span style="font-size:11px;background:var(--amber-dim);color:var(--amber);padding:4px 8px;border-radius:4px"> ' + openClaims + '</span>' : '') + '</div><div style="display:flex;justify-content:space-between;margin-top:16px;padding-top:16px;border-top:1px solid var(--border)"><div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold)">' + trips.length + '</div><div style="font-size:var(--text-xs);color:var(--text-muted)">Trips</div></div><div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--green)">' + formatMoney(earn) + '</div><div style="font-size:var(--text-xs);color:var(--text-muted)">Earnings</div></div><div class="actions"><button class="action-btn view" onclick="viewDriverProfile(' + d.id + ')">View</button><button class="action-btn edit" onclick="openDriverModal(' + d.id + ')">Edit</button><button class="action-btn delete" onclick="deleteDriver(' + d.id + ')">Del</button></div></div></div>'; 
      }).join('')) + '</div>';
    }

    function viewDriverProfile(driverId) {
      // Mark that we're viewing a driver detail (prevents background re-renders)
      currentDetailView = { type: 'driver', id: driverId };

      const d = appData.drivers.find(x => x.id === driverId);
      if (!d) {
        // Driver was deleted or not found - go back to list
        currentDetailView = null;
        renderDrivers(document.getElementById('main-content'));
        return;
      }
      const trips = appData.trips.filter(t => t.driver_id === driverId);
      let earn = 0; trips.forEach(t => earn += getTripFin(t.id).driverCut);
      const driverFiles = (appData.driver_files || []).filter(f => f.driver_id === driverId);
      const qualFiles = driverFiles.filter(f => f.category === 'QUALIFICATION');
      const persFiles = driverFiles.filter(f => f.category === 'PERSONAL');
      const customFiles = driverFiles.filter(f => f.category === 'CUSTOM');
      const today = new Date();
      
      const qualFileTypes = [
        { type: 'CDL', hasExpiry: true },
        { type: 'MEDICAL_CARD', hasExpiry: true },
        { type: 'MEDICAL_EXAMINER_VERIFICATION', hasExpiry: false },
        { type: 'MVR', hasExpiry: true },
        { type: 'PSP_REPORT', hasExpiry: true },
        { type: 'EMPLOYMENT_VERIFICATION', hasExpiry: false },
        { type: 'APPLICATION_OF_EMPLOYMENT', hasExpiry: false },
        { type: 'CLEARING_HOUSE_QUERY', hasExpiry: false },
        { type: 'DRUG_TEST_RESULT', hasExpiry: false },
        { type: 'CHAIN_OF_CUSTODY', hasExpiry: false }
      ];
      
      const persFileTypes = ['SSN', 'BANKING_INFO', 'W9'];
      
      // Get unique custom folder names
      const customFolders = [...new Set(customFiles.map(f => f.folder_name || 'Uncategorized'))];
      
      const formatFileType = (t) => t.replace(/_/g, ' ');
      
      const getExpiryBadge = (file) => {
        if (!file || !file.expiration_date) return '';
        const expDate = new Date(file.expiration_date);
        const daysUntil = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
        if (daysUntil < 0) return '<span class="badge badge-red">EXPIRED</span>';
        if (daysUntil === 0) return '<span class="badge badge-red">EXPIRES TODAY</span>';
        if (daysUntil <= 3) return '<span class="badge badge-red">Expires in ' + daysUntil + 'd</span>';
        if (daysUntil <= 7) return '<span class="badge badge-amber">Expires in ' + daysUntil + 'd</span>';
        return '<span class="badge badge-green">Valid until ' + formatDate(file.expiration_date) + '</span>';
      };
      
      const c = document.getElementById('main-content');
      c.innerHTML = '<div class="header"><div style="display:flex;align-items:center;gap:16px"><button class="btn btn-secondary" onclick="renderDrivers(document.getElementById(\'main-content\'))"> Back</button><div class="driver-avatar" style="width:50px;height:50px;font-size:20px">' + d.first_name[0] + d.last_name[0] + '</div><div><h2 style="margin:0">' + d.first_name + ' ' + d.last_name + '</h2><p style="margin:0;color:var(--text-muted)">' + d.phone + (d.email ? ' | ' + d.email : '') + '</p></div><span class="badge ' + getBadge(d.status) + '">' + d.status + '</span></div><button class="btn btn-primary" onclick="openDriverModal(' + driverId + ')"> Edit Driver</button></div>' +
        
        // Stats
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px"><div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Driver Cut</div><div class="value">' + d.cut_percent + '%</div></div><div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Total Trips</div><div class="value">' + trips.length + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:12px 16px;background:var(--green-dim)"><div class="label">Total Earnings</div><div class="value" style="color:var(--green)">' + formatMoney(earn) + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:12px 16px"><div class="label">Qualification Files</div><div class="value">' + qualFiles.length + '/10</div></div><div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Personal Files</div><div class="value">' + persFiles.length + '/3</div></div><div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px;background:var(--blue-dim)"><div class="label">Custom Folders</div><div class="value" style="color:var(--blue)">' + customFolders.length + '</div></div></div>' +
        
        // Qualification Files Section
        '<div class="card" style="margin-bottom:24px"><div class="card-header" style="background:var(--blue);color:white;border-radius:8px 8px 0 0"><h3 style="margin:0"> Driver Qualification Files (DQ Files)</h3></div><div class="table-wrapper"><table><thead><tr><th>Document Type</th><th>Status</th><th>Expiration</th><th>Uploaded</th><th>Actions</th></tr></thead><tbody>' +
        qualFileTypes.map(ft => {
          const file = qualFiles.find(f => f.file_type === ft.type);
          return '<tr><td><strong>' + formatFileType(ft.type) + '</strong></td><td>' + (file ? '<span class="badge badge-green"> Uploaded</span>' : '<span class="badge badge-gray">Missing</span>') + '</td><td>' + (ft.hasExpiry ? (file ? getExpiryBadge(file) : '<span style="color:var(--text-muted)">-</span>') : '<span style="color:var(--text-muted)">N/A</span>') + '</td><td>' + (file ? formatDate(file.created_at) : '-') + '</td><td><div class="actions">' + (file ? '<button class="action-btn view" onclick="viewFile(' + file.id + ')">View</button><button class="action-btn delete" onclick="deleteDriverFile(' + file.id + ',' + driverId + ')">Del</button>' : '<button class="action-btn edit" onclick="openUploadFileModal(' + driverId + ',\'' + ft.type + '\',\'QUALIFICATION\',' + ft.hasExpiry + ')">Upload</button>') + '</div></td></tr>';
        }).join('') +
        '</tbody></table></div></div>' +
        
        // Personal Files Section
        '<div class="card" style="margin-bottom:24px"><div class="card-header" style="background:var(--purple);color:white;border-radius:8px 8px 0 0"><h3 style="margin:0"> Driver Personal Files</h3></div><div class="table-wrapper"><table><thead><tr><th>Document Type</th><th>Status</th><th>Uploaded</th><th>Actions</th></tr></thead><tbody>' +
        persFileTypes.map(ft => {
          const file = persFiles.find(f => f.file_type === ft);
          return '<tr><td><strong>' + formatFileType(ft) + '</strong></td><td>' + (file ? '<span class="badge badge-green"> Uploaded</span>' : '<span class="badge badge-gray">Missing</span>') + '</td><td>' + (file ? formatDate(file.created_at) : '-') + '</td><td><div class="actions">' + (file ? '<button class="action-btn view" onclick="viewFile(' + file.id + ')">View</button><button class="action-btn delete" onclick="deleteDriverFile(' + file.id + ',' + driverId + ')">Del</button>' : '<button class="action-btn edit" onclick="openUploadFileModal(' + driverId + ',\'' + ft + '\',\'PERSONAL\',false)">Upload</button>') + '</div></td></tr>';
        }).join('') +
        '</tbody></table></div></div>' +
        
        // Custom Folders Section
        '<div class="card"><div class="card-header" style="background:var(--blue);color:white;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0"> Custom Folders</h3><button class="btn" style="background:var(--bg-card);color:var(--blue);padding:6px 12px;font-size:13px" onclick="openCustomFolderModal(' + driverId + ',\'driver\')">+ New Folder</button></div>' +
        (customFolders.length === 0 ? '<div style="padding:40px;text-align:center;color:var(--text-muted)">No custom folders yet. Click "+ New Folder" to create one.</div>' :
        '<div style="padding:16px">' +
        customFolders.map(folder => {
          const folderFiles = customFiles.filter(f => (f.folder_name || 'Uncategorized') === folder);
          return '<div style="margin-bottom:16px;border:1px solid var(--bg-elevated);border-radius:8px"><div style="background:var(--blue-dim);padding:12px 16px;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center"><strong> ' + folder + ' (' + folderFiles.length + ' files)</strong><button class="action-btn edit" onclick="openCustomFileUpload(' + driverId + ',\'' + folder.replace(/'/g, "\\'") + '\',\'driver\')">+ Add File</button></div>' +
            '<div class="table-wrapper"><table><thead><tr><th>File Name</th><th>Type</th><th>Uploaded</th><th>Notes</th><th>Actions</th></tr></thead><tbody>' +
            folderFiles.map(f => '<tr><td>' + f.file_name + '</td><td>' + (f.file_type || '-') + '</td><td>' + formatDate(f.created_at) + '</td><td>' + (f.notes || '-') + '</td><td><div class="actions"><button class="action-btn view" onclick="viewFile(' + f.id + ')">View</button><button class="action-btn delete" onclick="deleteDriverFile(' + f.id + ',' + driverId + ')">Del</button></div></td></tr>').join('') +
            '</tbody></table></div></div>';
        }).join('') +
        '</div>') +
        '</div>' +
        
        // Tickets & Violations Section
        renderDriverTicketsViolationsSection(driverId);
    }
    
    function renderDriverTicketsViolationsSection(driverId) {
      const driverTickets = (appData.tickets || []).filter(t => t.driver_id === driverId);
      const driverViolations = (appData.violations || []).filter(v => v.driver_id === driverId);
      const driverClaims = (appData.claims || []).filter(c => c.driver_id === driverId);
      const openTickets = driverTickets.filter(t => !['RESOLVED', 'DISMISSED'].includes(t.status)).length;
      const openViolations = driverViolations.filter(v => !['RESOLVED', 'DISMISSED'].includes(v.status)).length;
      const openClaims = driverClaims.filter(c => !['SETTLED', 'DENIED'].includes(c.status)).length;
      const driverFaultPaid = driverClaims.filter(c => c.fault_party === 'DRIVER' && c.status === 'SETTLED')
        .reduce((s, c) => s + parseFloat(c.settlement_amount || c.claim_amount || 0), 0);
      
      return '<div class="card" style="margin-top:24px"><div class="card-header" style="background:var(--red);color:white;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0"> Compliance Record</h3><div style="display:flex;gap:8px"><button class="btn" style="background:var(--bg-card);color:var(--red);padding:6px 12px;font-size:13px" onclick="openTicketModal(null,' + driverId + ')">+ Ticket</button><button class="btn" style="background:var(--bg-card);color:var(--purple);padding:6px 12px;font-size:13px" onclick="openViolationModal(null,' + driverId + ')">+ Violation</button><button class="btn" style="background:var(--bg-card);color:var(--amber);padding:6px 12px;font-size:13px" onclick="openClaimModalForDriver(' + driverId + ')">+ Claim</button></div></div>' +
        
        // Summary badges
        '<div style="padding:16px;background:var(--bg-darker);display:flex;gap:16px;flex-wrap:wrap">' +
        '<div style="display:flex;align-items:center;gap:8px"><span style="font-weight:600">Tickets:</span><span class="badge badge-red">' + openTickets + ' Open</span><span class="badge badge-green">' + (driverTickets.length - openTickets) + ' Closed</span></div>' +
        '<div style="display:flex;align-items:center;gap:8px"><span style="font-weight:600">Violations:</span><span class="badge" style="background:var(--purple);color:white">' + openViolations + ' Open</span><span class="badge badge-blue">' + (driverViolations.length - openViolations) + ' Closed</span></div>' +
        '<div style="display:flex;align-items:center;gap:8px"><span style="font-weight:600">Claims:</span><span class="badge badge-amber">' + openClaims + ' Open</span><span class="badge badge-gray">' + (driverClaims.length - openClaims) + ' Closed</span></div>' +
        (driverFaultPaid > 0 ? '<div style="display:flex;align-items:center;gap:8px;margin-left:auto"><span class="badge badge-red" style="font-size:12px"> Driver Fault Paid: ' + formatMoney(driverFaultPaid) + '</span></div>' : '') +
        '</div>' +
        
        // Tickets table
        (driverTickets.length > 0 ? '<div style="padding:16px;border-bottom:1px solid var(--border)"><h4 style="margin:0 0 12px"> Tickets (' + driverTickets.length + ')</h4>' +
        '<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Description</th><th>Status</th><th>Court Date</th><th>Decision</th><th>Actions</th></tr></thead><tbody>' +
        driverTickets.sort((a, b) => (b.ticket_date || '').localeCompare(a.ticket_date || '')).map(t => 
          '<tr><td>' + (t.ticket_date ? formatDate(t.ticket_date) : '-') + '</td>' +
          '<td style="max-width:200px">' + (t.ticket_description || '-') + '</td>' +
          '<td>' + getTicketStatusBadge(t.status) + '</td>' +
          '<td>' + (t.court_date ? formatDate(t.court_date) : '-') + '</td>' +
          '<td>' + (t.court_decision ? getCourtDecisionBadge(t.court_decision) : '-') + '</td>' +
          '<td><div class="actions"><button class="action-btn edit" onclick="openTicketModal(' + t.id + ')">Edit</button></div></td></tr>'
        ).join('') +
        '</tbody></table></div></div>' : '<div style="padding:16px;border-bottom:1px solid var(--border);color:var(--text-muted)">No tickets on record </div>') +
        
        // Violations table
        (driverViolations.length > 0 ? '<div style="padding:16px;border-bottom:1px solid var(--border)"><h4 style="margin:0 0 12px"> Violations (' + driverViolations.length + ')</h4>' +
        '<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Type</th><th>Description</th><th>Severity</th><th>Status</th><th>Actions</th></tr></thead><tbody>' +
        driverViolations.sort((a, b) => (b.violation_date || '').localeCompare(a.violation_date || '')).map(v => 
          '<tr><td>' + (v.violation_date ? formatDate(v.violation_date) : '-') + '</td>' +
          '<td>' + getViolationTypeBadge(v.violation_type) + '</td>' +
          '<td style="max-width:200px">' + (v.description || '-') + '</td>' +
          '<td>' + getSeverityBadge(v.severity) + '</td>' +
          '<td>' + getViolationStatusBadge(v.status) + '</td>' +
          '<td><div class="actions"><button class="action-btn edit" onclick="openViolationModal(' + v.id + ')">Edit</button></div></td></tr>'
        ).join('') +
        '</tbody></table></div></div>' : '<div style="padding:16px;border-bottom:1px solid var(--border);color:var(--text-muted)">No violations on record </div>') +
        
        // Claims table
        (driverClaims.length > 0 ? '<div style="padding:16px"><h4 style="margin:0 0 12px"> Claims (' + driverClaims.length + ')</h4>' +
        '<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Type</th><th>Fault</th><th>Amount</th><th>Status</th><th>Actions</th></tr></thead><tbody>' +
        driverClaims.sort((a, b) => (b.incident_date || '').localeCompare(a.incident_date || '')).map(c => 
          '<tr><td>' + (c.incident_date ? formatDate(c.incident_date) : '-') + '</td>' +
          '<td>' + (c.damage_type || '-') + '</td>' +
          '<td>' + getFaultBadge(c.fault_party) + '</td>' +
          '<td class="money">' + formatMoney(c.claim_amount) + '</td>' +
          '<td>' + getClaimStatusBadge(c.status) + '</td>' +
          '<td><div class="actions"><button class="action-btn view" onclick="viewClaim(' + c.id + ')">View</button><button class="action-btn edit" onclick="openClaimModal(' + c.id + ')">Edit</button></div></td></tr>'
        ).join('') +
        '</tbody></table></div></div>' : '<div style="padding:16px;color:var(--text-muted)">No claims on record </div>') +
        
        '</div>';
    }
    
    function openClaimModalForDriver(driverId) {
      // Pre-select driver when opening claim modal from driver profile
      openClaimModal();
      setTimeout(() => {
        const driverSelect = document.querySelector('select[name="driver_id"]');
        if (driverSelect) driverSelect.value = driverId;
      }, 100);
    }

    function openUploadFileModal(driverId, fileType, category, hasExpiry) {
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:450px"><div class="modal-header"><h3> Upload ' + fileType.replace(/_/g, ' ') + '</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div class="form-group"><label>File (PDF, Image, etc.)</label><input type="file" id="fileUpload" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"></div>' +
        '<div class="form-group"><label>Notes (Optional)</label><input id="fileNotes" placeholder="Any additional notes..."></div>' +
        (hasExpiry ? '<div class="form-group"><label>Expiration Date</label><input type="date" id="fileExpiry"></div><div style="background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius);font-size:13px;color:var(--amber)"> You will receive reminders at 7 days, 3 days, 1 day, and on expiration date.</div>' : '') +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="uploadDriverFile(' + driverId + ',\'' + fileType + '\',\'' + category + '\',' + hasExpiry + ')">Upload</button></div></div>';
      document.body.appendChild(m);
    }

    async function uploadDriverFile(driverId, fileType, category, hasExpiry) {
      const fileInput = document.getElementById('fileUpload');
      const notes = document.getElementById('fileNotes').value;
      const expiry = hasExpiry ? document.getElementById('fileExpiry').value : null;
      
      if (!fileInput.files || fileInput.files.length === 0) {
        showToast('Please select a file', 'error');
        return;
      }
      
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      reader.onload = async function(e) {
        const fileData = e.target.result; // Base64 data
        
        const data = {
          driver_id: driverId,
          file_type: fileType,
          category: category,
          file_name: file.name,
          file_data: fileData,
          notes: notes || null,
          expiration_date: expiry || null
        };
        
        try {
          await dbInsert('driver_files', data);
          document.querySelector('.modal-overlay').remove();
          showToast('File uploaded successfully!');
          await loadAllData(true);
          viewDriverProfile(driverId);
        } catch (e) {
          showToast('Upload failed: ' + e.message, 'error');
        }
      };
      
      reader.readAsDataURL(file);
    }

    function viewFile(fileId) {
      const file = appData.driver_files.find(f => f.id === fileId);
      if (!file || !file.file_data) {
        showToast('File not found', 'error');
        return;
      }
      
      // Open file in new tab
      const win = window.open();
      if (file.file_data.startsWith('data:application/pdf') || file.file_data.startsWith('data:image')) {
        win.document.write('<iframe src="' + file.file_data + '" style="width:100%;height:100%;border:none"></iframe>');
      } else {
        // For other files, create download link
        win.document.write('<html><body><h2>' + file.file_name + '</h2><p>File type: ' + file.file_type.replace(/_/g, ' ') + '</p><p>Notes: ' + (file.notes || 'None') + '</p><a href="' + file.file_data + '" download="' + file.file_name + '">Download File</a></body></html>');
      }
    }

    async function deleteDriverFile(fileId, driverId) {
      if (!confirm('Delete this file?')) return;
      try {
        await dbDelete('driver_files', fileId);
        showToast('File deleted');
        await loadAllData(true);
        viewDriverProfile(driverId);
      } catch (e) {
        showToast('Delete failed: ' + e.message, 'error');
      }
    }
    
    function openCustomFolderModal(entityId, entityType) {
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:400px"><div class="modal-header"><h3> Create New Folder</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div class="form-group"><label>Folder Name *</label><input id="folderName" placeholder="e.g., Training Records, Contracts, etc."></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="createCustomFolder(' + entityId + ',\'' + entityType + '\')">Create & Add File</button></div></div>';
      document.body.appendChild(m);
    }
    
    function createCustomFolder(entityId, entityType) {
      const folderName = document.getElementById('folderName').value.trim();
      if (!folderName) { showToast('Please enter folder name', 'error'); return; }
      document.querySelector('.modal-overlay').remove();
      openCustomFileUpload(entityId, folderName, entityType);
    }
    
    function openCustomFileUpload(entityId, folderName, entityType) {
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:450px"><div class="modal-header"><h3> Upload to "' + folderName + '"</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div class="form-group"><label>File *</label><input type="file" id="customFileUpload" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx,.txt"></div>' +
        '<div class="form-group"><label>File Type/Label</label><input id="customFileType" placeholder="e.g., Certificate, Agreement, Report"></div>' +
        '<div class="form-group"><label>Notes (Optional)</label><input id="customFileNotes" placeholder="Any additional notes..."></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="uploadCustomFile(' + entityId + ',\'' + folderName.replace(/'/g, "\\'") + '\',\'' + entityType + '\')">Upload</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function uploadCustomFile(entityId, folderName, entityType) {
      const fileInput = document.getElementById('customFileUpload');
      const fileType = document.getElementById('customFileType').value || 'Custom';
      const notes = document.getElementById('customFileNotes').value;
      
      if (!fileInput.files || fileInput.files.length === 0) {
        showToast('Please select a file', 'error');
        return;
      }
      
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      reader.onload = async function(e) {
        const fileData = e.target.result;
        
        const data = {
          file_type: fileType,
          category: 'CUSTOM',
          folder_name: folderName,
          file_name: file.name,
          file_data: fileData,
          notes: notes || null
        };
        
        if (entityType === 'driver') {
          data.driver_id = entityId;
        } else {
          data.truck_id = entityId;
        }
        
        try {
          const table = entityType === 'driver' ? 'driver_files' : 'truck_files';
          await dbInsert(table, data);
          document.querySelector('.modal-overlay').remove();
          showToast('File uploaded successfully!');
          await loadAllData(true);
          if (entityType === 'driver') {
            viewDriverProfile(entityId);
          } else {
            viewTruckProfile(entityId);
          }
        } catch (e) {
          showToast('Upload failed: ' + e.message, 'error');
        }
      };
      
      reader.readAsDataURL(file);
    }

    function openDriverModal(id = null, driverType = null) {
      const d = id ? appData.drivers.find(x => x.id === id) : null;
      // Determine driver type: from existing driver, parameter, or default to COMPANY
      const isOwnerOp = d ? d.driver_type === 'OWNER_OP' : driverType === 'OWNER_OP';
      const typeValue = isOwnerOp ? 'OWNER_OP' : 'COMPANY';
      const states = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];
      const stateOpts = states.map(s => '<option value="' + s + '"' + (d?.cdl_state === s ? ' selected' : '') + '>' + s + '</option>').join('');
      const modalTitle = d ? 'Edit' : (isOwnerOp ? 'New Owner-Operator' : 'New Company Driver');
      const headerColor = isOwnerOp ? 'background:var(--amber-dim);border-bottom:3px solid var(--amber)' : '';

      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:700px"><div class="modal-header" style="' + headerColor + '"><h3>' + modalTitle + (isOwnerOp ? ' <span class="badge" style="background:var(--amber);color:white;font-size:12px">Owner-OP</span>' : '') + '</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body" style="max-height:75vh;overflow-y:auto">' +
        '<input type="hidden" id="dDriverType" value="' + typeValue + '">' +
        
        // Basic Info Section
        '<h4 style="margin:0 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)"> Basic Information</h4>' +
        '<div class="form-row"><div class="form-group"><label>First Name *</label><input id="dFirst" value="' + (d?.first_name || '') + '"></div><div class="form-group"><label>Last Name *</label><input id="dLast" value="' + (d?.last_name || '') + '"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Phone</label><input id="dPhone" value="' + (d?.phone || '') + '" placeholder="(555) 123-4567"></div><div class="form-group"><label>Email</label><input type="email" id="dEmail" value="' + (d?.email || '') + '" placeholder="driver@email.com"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Date of Birth</label><input type="date" id="dDOB" value="' + (d?.date_of_birth || '') + '"></div><div class="form-group"><label>EIN or SSN #</label><input id="dSSN" value="' + (d?.ssn_ein || '') + '" placeholder="XXX-XX-XXXX"></div></div>' +
        
        // Employment Section
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)"> Employment</h4>' +
        '<div class="form-row"><div class="form-group"><label>Hire Date</label><input type="date" id="dHireDate" value="' + (d?.hire_date || '') + '"></div><div class="form-group"><label>Termination Date</label><input type="date" id="dTermDate" value="' + (d?.termination_date || '') + '"></div></div>' +
        '<div class="form-row">' +
        (isOwnerOp
          ? '<div class="form-group"><label style="color:var(--amber);font-weight:600">Dispatch Fee %</label><input type="number" id="dDispatchFee" value="' + (d?.dispatch_fee_percent || 5) + '" step="0.5" style="border-color:var(--amber)"><small style="color:var(--amber)">% charged to owner-operator (your profit)</small></div>'
          : '<div class="form-group"><label>Cut %</label><input type="number" id="dCut" value="' + (d?.cut_percent || 32) + '" step="0.5"><small style="color:var(--text-muted)">% driver receives from clean revenue</small></div>'
        ) +
        '<div class="form-group"><label>Status</label><select id="dStatus"><option value="ACTIVE"' + (d?.status === 'ACTIVE' ? ' selected' : '') + '>ACTIVE</option><option value="INACTIVE"' + (d?.status === 'INACTIVE' ? ' selected' : '') + '>INACTIVE</option><option value="ON_LEAVE"' + (d?.status === 'ON_LEAVE' ? ' selected' : '') + '>ON LEAVE</option><option value="TERMINATED"' + (d?.status === 'TERMINATED' ? ' selected' : '') + '>TERMINATED</option></select></div></div>' +

        // Driver App Access Section
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)"> Driver App Access</h4>' +
        '<div class="form-row"><div class="form-group"><label>App PIN (6 digits)</label><input type="text" id="dPinCode" value="' + (d?.pin_code || '') + '" placeholder="123456" maxlength="6" pattern="[0-9]{6}" inputmode="numeric" oninput="this.value=this.value.replace(/[^0-9]/g,\'\').slice(0,6)"><small style="color:var(--text-muted)">Driver uses this PIN to log into the mobile app</small></div><div class="form-group"><label>&nbsp;</label><button type="button" class="btn btn-secondary" onclick="document.getElementById(\'dPinCode\').value = String(Math.floor(100000 + Math.random() * 900000))">Generate PIN</button></div></div>' +

        // CDL Section
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)"> CDL Information</h4>' +
        '<div class="form-row"><div class="form-group"><label>CDL Number</label><input id="dCDL" value="' + (d?.cdl_number || '') + '" placeholder="License number"></div><div class="form-group"><label>CDL State</label><select id="dCDLState"><option value="">Select State</option>' + stateOpts + '</select></div></div>' +
        '<div class="form-row"><div class="form-group"><label>CDL Endorsements</label><input id="dEndorsements" value="' + (d?.cdl_endorsements || '') + '" placeholder="e.g., H, N, T, P, S, X"></div><div class="form-group"><label>CDL Restrictions</label><input id="dRestrictions" value="' + (d?.cdl_restrictions || '') + '" placeholder="e.g., L, Z, E, O, M, N, V"></div></div>' +
        
        // Banking Section
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)"> Banking Information</h4>' +
        '<div class="form-group"><label>Bank Name</label><input id="dBankName" value="' + (d?.bank_name || '') + '" placeholder="e.g., Chase, Bank of America"></div>' +
        '<div class="form-row"><div class="form-group"><label>Account Number</label><input id="dAccountNum" value="' + (d?.account_number || '') + '" placeholder="Account #"></div><div class="form-group"><label>Routing Number</label><input id="dRoutingNum" value="' + (d?.routing_number || '') + '" placeholder="9 digit routing #"></div></div>' +

        // Payment Info Section
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)"> Payment Information</h4>' +
        '<div class="form-row"><div class="form-group"><label>Pay To</label><input id="dPayToName" value="' + (d?.pay_to_name || '') + '" placeholder="Name to pay to (if different)"></div><div class="form-group"><label>Company</label><input id="dPayToCompany" value="' + (d?.pay_to_company || '') + '" placeholder="Company name (if paid as company)"></div></div>' +
        '<div class="form-group"><label>Company EIN #</label><input id="dPayToCompanyEIN" value="' + (d?.pay_to_company_ein || '') + '" placeholder="XX-XXXXXXX"></div>' +
        '<div class="form-group"><label>Street Address</label><input id="dPayToStreet" value="' + (d?.pay_to_street || '') + '" placeholder="123 Main St"></div>' +
        '<div class="form-row"><div class="form-group"><label>City</label><input id="dPayToCity" value="' + (d?.pay_to_city || '') + '" placeholder="City"></div><div class="form-group"><label>State</label><select id="dPayToState"><option value="">Select</option>' + states.map(s => '<option value="' + s + '"' + (d?.pay_to_state === s ? ' selected' : '') + '>' + s + '</option>').join('') + '</select></div><div class="form-group"><label>Zip Code</label><input id="dPayToZip" value="' + (d?.pay_to_zip || '') + '" placeholder="12345" maxlength="10"></div></div>' +

        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveDriver(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    async function saveDriver(id) {
      const driverType = document.getElementById('dDriverType').value;
      const isOwnerOp = driverType === 'OWNER_OP';
      const data = {
        first_name: document.getElementById('dFirst').value,
        last_name: document.getElementById('dLast').value,
        phone: document.getElementById('dPhone').value,
        email: document.getElementById('dEmail').value || null,
        date_of_birth: document.getElementById('dDOB').value || null,
        ssn_ein: document.getElementById('dSSN').value || null,
        hire_date: document.getElementById('dHireDate').value || null,
        termination_date: document.getElementById('dTermDate').value || null,
        driver_type: driverType,
        cut_percent: isOwnerOp ? null : (parseFloat(document.getElementById('dCut')?.value) || 32),
        dispatch_fee_percent: isOwnerOp ? (parseFloat(document.getElementById('dDispatchFee')?.value) || 5) : null,
        status: document.getElementById('dStatus').value,
        cdl_number: document.getElementById('dCDL').value || null,
        cdl_state: document.getElementById('dCDLState').value || null,
        cdl_endorsements: document.getElementById('dEndorsements').value || null,
        cdl_restrictions: document.getElementById('dRestrictions').value || null,
        bank_name: document.getElementById('dBankName').value || null,
        account_number: document.getElementById('dAccountNum').value || null,
        routing_number: document.getElementById('dRoutingNum').value || null,
        pay_to_name: document.getElementById('dPayToName').value || null,
        pay_to_company: document.getElementById('dPayToCompany').value || null,
        pay_to_company_ein: document.getElementById('dPayToCompanyEIN').value || null,
        pay_to_street: document.getElementById('dPayToStreet').value || null,
        pay_to_city: document.getElementById('dPayToCity').value || null,
        pay_to_state: document.getElementById('dPayToState').value || null,
        pay_to_zip: document.getElementById('dPayToZip').value || null,
        pin_code: document.getElementById('dPinCode').value || null
      };
      try { 
        if (id) { 
          await dbUpdate('drivers', id, data); 
          await logActivity('DRIVER_UPDATED', { driver_id: id, driver_name: data.first_name + ' ' + data.last_name, changes: data });
        } else { 
          const newDriver = await dbInsert('drivers', data); 
          await logActivity('DRIVER_CREATED', { driver_id: newDriver.id, driver_name: data.first_name + ' ' + data.last_name, data: data });
        } 
        document.querySelector('.modal-overlay').remove(); showToast('Saved!'); await loadAllData(true); renderDrivers(document.getElementById('main-content')); 
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteDriver(id) {
      const d = appData.drivers.find(x => x.id === id);
      if (!d) return;
      const trips = appData.trips.filter(t => t.driver_id === id);
      if (trips.length > 0) {
        showToast('Cannot delete driver with ' + trips.length + ' assigned trips. Reassign or delete trips first.', 'error');
        return;
      }
      if (!confirm('Delete driver ' + d.first_name + ' ' + d.last_name + '? This cannot be undone.')) return;
      try {
        await dbDelete('drivers', id);
        await logActivity('DRIVER_DELETED', { driver_id: id, driver_name: d.first_name + ' ' + d.last_name });
        showToast('Driver deleted');
        await loadAllData(true);
        renderDrivers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    function renderTrucks(c) {
      // Clear detail view flag when going back to trucks list
      currentDetailView = null;
      const today = new Date().toISOString().split('T')[0];
      
      c.innerHTML = '<div class="header"><h2> Fleet</h2><button class="btn btn-primary" onclick="openTruckModal()">+ New Unit</button></div>' +
        '<div class="card"><div class="table-wrapper"><table><thead><tr><th>Unit #</th><th>Type</th><th>Year/Make/Model</th><th>VIN</th><th>Plate</th><th>Ownership</th><th>Compliance</th><th>Status</th><th class="sticky-col">Actions</th></tr></thead><tbody>' + 
        (appData.trucks.length === 0 ? '<tr><td colspan="9" style="text-align:center;padding:40px">No trucks yet</td></tr>' : 
        appData.trucks.map(t => {
          const yearMakeModel = [t.year, t.make, t.model].filter(Boolean).join(' ') || '-';
          const cabCardExpired = t.cab_card_exp && t.cab_card_exp < today;
          const annualExpired = t.annual_insp_exp && t.annual_insp_exp < today;
          const complianceIssues = (cabCardExpired ? 1 : 0) + (annualExpired ? 1 : 0) + (!t.is_2290_paid ? 1 : 0) + (!t.has_ifta_decal ? 1 : 0);

          // Get assigned trailer info for trucks
          const assignedTrailer = t.vehicle_type === 'TRUCK' && t.assigned_trailer_id ?
            appData.trucks.find(tr => tr.id === t.assigned_trailer_id) : null;
          const trailerBadge = assignedTrailer ?
            '<br><span class="badge badge-blue" style="font-size:10px;cursor:pointer" onclick="event.stopPropagation();openTruckModal(\'' + assignedTrailer.id + '\')" title="Click to edit trailer"> ' + assignedTrailer.truck_number + '</span>' :
            (t.vehicle_type === 'TRUCK' ? '<br><span class="badge badge-gray" style="font-size:10px;opacity:0.5">No Trailer</span>' : '');

          return '<tr>' +
            '<td><strong>#' + t.truck_number + '</strong>' + (t.vehicle_type === 'TRAILER' ? '<br><span class="badge badge-gray" style="font-size:10px">TRAILER</span>' : trailerBadge) + '</td>' +
            '<td>' + (t.truck_type || '-') + '<br><span style="font-size:var(--text-xs);color:var(--text-muted)">' + (t.capacity || 0) + ' cars</span></td>' +
            '<td style="font-size:12px">' + yearMakeModel + (t.color ? '<br><span style="color:var(--text-muted)">' + t.color + '</span>' : '') + '</td>' +
            '<td style="font-size:11px;font-family:monospace">' + (t.vin ? t.vin.slice(-6) : '-') + '</td>' +
            '<td>' + (t.license_plate || '-') + (t.plate_state ? '<br><span class="badge badge-blue" style="font-size:10px">' + t.plate_state + '</span>' : '') + '</td>' +
            '<td><span class="badge ' + (t.ownership === 'OWNED' ? 'badge-green' : t.ownership === 'LEASED' ? 'badge-amber' : 'badge-blue') + '">' + (t.ownership || 'OWNED') + '</span></td>' +
            '<td>' + (complianceIssues === 0 ? '<span class="badge badge-green"> OK</span>' : '<span class="badge badge-red">' + complianceIssues + ' Issues</span>') + '</td>' +
            '<td><span class="badge ' + getBadge(t.status) + '">' + t.status + '</span></td>' +
            '<td class="sticky-col"><div class="actions"><button class="action-btn view" onclick="viewTruckCompliance(' + t.id + ')">Files</button><button class="action-btn edit" onclick="openTruckModal(' + t.id + ')">Edit</button><button class="action-btn delete" onclick="deleteTruck(' + t.id + ')">Del</button></div></td>' +
            '</tr>';
        }).join('')) + 
        '</tbody></table></div></div>';
    }

    function openTruckModal(id = null) {
      const t = id ? appData.trucks.find(x => x.id === id) : null;
      const states = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];
      const stateOpts = states.map(s => '<option value="' + s + '"' + (t?.plate_state === s ? ' selected' : '') + '>' + s + '</option>').join('');
      const currentYear = new Date().getFullYear();
      const years = [];
      for (let y = currentYear + 1; y >= 1990; y--) years.push(y);
      const yearOpts = years.map(y => '<option value="' + y + '"' + (t?.year == y ? ' selected' : '') + '>' + y + '</option>').join('');

      // Get available trailers for assignment (trailers not assigned to other trucks, or assigned to this truck)
      const availableTrailers = appData.trucks.filter(tr =>
        tr.vehicle_type === 'TRAILER' &&
        tr.status === 'ACTIVE' &&
        (!tr.assigned_trailer_id || appData.trucks.every(truck => truck.assigned_trailer_id !== tr.id || truck.id === id))
      );
      // Also include the currently assigned trailer if editing
      const currentlyAssignedTrailer = t?.assigned_trailer_id ? appData.trucks.find(tr => tr.id === t.assigned_trailer_id) : null;
      if (currentlyAssignedTrailer && !availableTrailers.find(tr => tr.id === currentlyAssignedTrailer.id)) {
        availableTrailers.unshift(currentlyAssignedTrailer);
      }
      const trailerOpts = availableTrailers.map(tr =>
        '<option value="' + tr.id + '"' + (t?.assigned_trailer_id === tr.id ? ' selected' : '') + '>' +
        tr.truck_number + (tr.year ? ' - ' + tr.year : '') + (tr.make ? ' ' + tr.make : '') +
        '</option>'
      ).join('');

      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:750px"><div class="modal-header"><h3>' + (t ? 'Edit' : 'New') + ' Truck</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body" style="max-height:75vh;overflow-y:auto">' +

        // Basic Info
        '<h4 style="margin:0 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)"> Basic Information</h4>' +
        '<div class="form-row"><div class="form-group"><label>Unit # *</label><input type="text" id="tNum" value="' + (t?.truck_number || '') + '" placeholder="e.g., 101"></div><div class="form-group"><label>Vehicle Type *</label><select id="tVehicleType" onchange="toggleTrailerAssignment()"><option value="TRUCK"' + (t?.vehicle_type === 'TRUCK' ? ' selected' : '') + '>Truck</option><option value="TRAILER"' + (t?.vehicle_type === 'TRAILER' ? ' selected' : '') + '>Trailer</option></select></div><div class="form-group"><label>Hauler Type</label><select id="tType"><option value="7-Car Hauler"' + (t?.truck_type === '7-Car Hauler' ? ' selected' : '') + '>7-Car Hauler</option><option value="8-Car Hauler"' + (t?.truck_type === '8-Car Hauler' || !t ? ' selected' : '') + '>8-Car Hauler</option><option value="9-Car Hauler"' + (t?.truck_type === '9-Car Hauler' ? ' selected' : '') + '>9-Car Hauler</option><option value="Flatbed"' + (t?.truck_type === 'Flatbed' ? ' selected' : '') + '>Flatbed</option><option value="Enclosed"' + (t?.truck_type === 'Enclosed' ? ' selected' : '') + '>Enclosed</option></select></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Capacity (Cars)</label><input type="number" id="tCap" value="' + (t?.capacity || 8) + '"></div><div class="form-group"><label>Status</label><select id="tStatus"><option value="ACTIVE"' + (t?.status === 'ACTIVE' ? ' selected' : '') + '>ACTIVE</option><option value="INACTIVE"' + (t?.status === 'INACTIVE' ? ' selected' : '') + '>INACTIVE</option><option value="MAINTENANCE"' + (t?.status === 'MAINTENANCE' ? ' selected' : '') + '>MAINTENANCE</option><option value="SOLD"' + (t?.status === 'SOLD' ? ' selected' : '') + '>SOLD</option></select></div></div>' +

        // Trailer Assignment (only for trucks)
        '<div id="trailerAssignmentSection" style="' + (t?.vehicle_type === 'TRAILER' ? 'display:none' : '') + '">' +
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)"> Trailer Assignment</h4>' +
        '<div class="form-row"><div class="form-group"><label>Assigned Trailer</label><select id="tAssignedTrailer"><option value="">No Trailer Assigned</option>' + trailerOpts + '</select></div></div>' +
        '</div>' +
        
        // Vehicle Details
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)"> Vehicle Details</h4>' +
        '<div class="form-row"><div class="form-group"><label>Year</label><select id="tYear"><option value="">Select Year</option>' + yearOpts + '</select></div><div class="form-group"><label>Make</label><input id="tMake" value="' + (t?.make || '') + '" placeholder="e.g., Peterbilt, Freightliner"></div><div class="form-group"><label>Model</label><input id="tModel" value="' + (t?.model || '') + '" placeholder="e.g., 389, Cascadia"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Color</label><input id="tColor" value="' + (t?.color || '') + '" placeholder="e.g., White, Blue"></div><div class="form-group"><label>VIN</label><input id="tVIN" value="' + (t?.vin || '') + '" placeholder="17 character VIN" maxlength="17"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>GVWR (lbs)</label><input type="number" id="tGVWR" value="' + (t?.gvwr || '') + '" placeholder="e.g., 80000"></div><div class="form-group"><label>Tire Size</label><input id="tTireSize" value="' + (t?.tire_size || '') + '" placeholder="e.g., 295/75R22.5"></div></div>' +
        
        // Registration
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)"> Registration</h4>' +
        '<div class="form-row"><div class="form-group"><label>Plate Number</label><input id="tPlate" value="' + (t?.license_plate || '') + '" placeholder="License plate"></div><div class="form-group"><label>Plate State</label><select id="tPlateState"><option value="">Select State</option>' + stateOpts + '</select></div></div>' +
        
        // Fleet Dates
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)"> Fleet Dates</h4>' +
        '<div class="form-row"><div class="form-group"><label>Date Added to Fleet</label><input type="date" id="tDateAdded" value="' + (t?.date_added || '') + '"></div><div class="form-group"><label>Date Removed from Fleet</label><input type="date" id="tDateRemoved" value="' + (t?.date_removed || '') + '"></div></div>' +
        
        // Compliance Dates
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)"> Compliance</h4>' +
        '<div class="form-row"><div class="form-group"><label>Cab Card Expiration</label><input type="date" id="tCabCardExp" value="' + (t?.cab_card_exp || '') + '"></div><div class="form-group"><label>Annual Inspection Exp</label><input type="date" id="tAnnualInspExp" value="' + (t?.annual_insp_exp || '') + '"></div></div>' +
        
        // Ownership & Financial
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)"> Ownership & Financial</h4>' +
        '<div class="form-row"><div class="form-group"><label>Ownership</label><select id="tOwnership"><option value="OWNED"' + (t?.ownership === 'OWNED' || !t ? ' selected' : '') + '>Owned</option><option value="LEASED"' + (t?.ownership === 'LEASED' ? ' selected' : '') + '>Leased</option><option value="FINANCED"' + (t?.ownership === 'FINANCED' ? ' selected' : '') + '>Financed</option></select></div><div class="form-group"><label>Market Value ($)</label><input type="number" id="tMarketValue" value="' + (t?.market_value || '') + '" placeholder="0.00" step="0.01"></div></div>' +
        
        // Compliance Checkboxes
        '<h4 style="margin:20px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)"> Compliance Status</h4>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">' +
        '<label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="t2290Paid"' + (t?.is_2290_paid ? ' checked' : '') + '> 2290 Paid (Y' + currentYear + ')</label>' +
        '<label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="tIFTADecal"' + (t?.has_ifta_decal ? ' checked' : '') + '> IFTA Decal</label>' +
        '<label style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="tInspectorQual"' + (t?.inspector_qual_uploaded ? ' checked' : '') + '> Inspector Qualification Uploaded</label>' +
        '</div>' +
        
        // Notes
        '<div class="form-group" style="margin-top:16px"><label>Notes</label><textarea id="tNotes" rows="2" placeholder="Additional notes...">' + (t?.notes || '') + '</textarea></div>' +
        
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveTruck(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    function toggleTrailerAssignment() {
      const vehicleType = document.getElementById('tVehicleType').value;
      const section = document.getElementById('trailerAssignmentSection');
      if (section) {
        section.style.display = vehicleType === 'TRUCK' ? '' : 'none';
        if (vehicleType === 'TRAILER') {
          document.getElementById('tAssignedTrailer').value = '';
        }
      }
    }

    async function saveTruck(id) {
      const vehicleType = document.getElementById('tVehicleType').value;
      const assignedTrailerId = vehicleType === 'TRUCK' ? (document.getElementById('tAssignedTrailer').value || null) : null;

      const data = {
        truck_number: document.getElementById('tNum').value.trim(),
        vehicle_type: vehicleType,
        truck_type: document.getElementById('tType').value,
        capacity: parseInt(document.getElementById('tCap').value) || 8,
        status: document.getElementById('tStatus').value,
        year: document.getElementById('tYear').value ? parseInt(document.getElementById('tYear').value) : null,
        make: document.getElementById('tMake').value || null,
        model: document.getElementById('tModel').value || null,
        color: document.getElementById('tColor').value || null,
        vin: document.getElementById('tVIN').value || null,
        gvwr: document.getElementById('tGVWR').value ? parseInt(document.getElementById('tGVWR').value) : null,
        tire_size: document.getElementById('tTireSize').value || null,
        license_plate: document.getElementById('tPlate').value || null,
        plate_state: document.getElementById('tPlateState').value || null,
        date_added: document.getElementById('tDateAdded').value || null,
        date_removed: document.getElementById('tDateRemoved').value || null,
        cab_card_exp: document.getElementById('tCabCardExp').value || null,
        annual_insp_exp: document.getElementById('tAnnualInspExp').value || null,
        ownership: document.getElementById('tOwnership').value,
        market_value: document.getElementById('tMarketValue').value ? parseFloat(document.getElementById('tMarketValue').value) : null,
        is_2290_paid: document.getElementById('t2290Paid').checked,
        has_ifta_decal: document.getElementById('tIFTADecal').checked,
        inspector_qual_uploaded: document.getElementById('tInspectorQual').checked,
        notes: document.getElementById('tNotes').value || null,
        assigned_trailer_id: assignedTrailerId
      };
      if (!data.truck_number) { showToast('Unit # is required', 'error'); return; }
      // Check for duplicate truck number (excluding current truck if editing)
      const duplicate = appData.trucks.find(t => t.truck_number === data.truck_number && t.id !== id);
      if (duplicate) { showToast('Truck number already exists', 'error'); return; }

      try {
        // If assigning a trailer, clear it from any other truck first (exclusive assignment)
        if (assignedTrailerId) {
          const otherTruckWithTrailer = appData.trucks.find(t => t.assigned_trailer_id === assignedTrailerId && t.id !== id);
          if (otherTruckWithTrailer) {
            await dbUpdate('trucks', otherTruckWithTrailer.id, { assigned_trailer_id: null });
          }
        }

        if (id) {
          await dbUpdate('trucks', id, data);
          await logActivity('TRUCK_UPDATED', { truck_id: id, truck_number: data.truck_number, changes: data });
        } else {
          const newTruck = await dbInsert('trucks', data);
          await logActivity('TRUCK_CREATED', { truck_id: newTruck.id, truck_number: data.truck_number, data: data });
        } 
        document.querySelector('.modal-overlay').remove(); showToast('Saved!'); await loadAllData(true); renderTrucks(document.getElementById('main-content')); 
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteTruck(id) {
      if (!confirm('Delete?')) return;
      const truck = appData.trucks.find(t => t.id === id);
      // Check for trips using this truck
      const attachedTrips = appData.trips.filter(t => t.truck_id === id);
      if (attachedTrips.length > 0) {
        showToast('Cannot delete: This truck is assigned to ' + attachedTrips.length + ' trip(s). Unassign the truck first.', 'error');
        return;
      }
      try {
        await dbDelete('trucks', id);
        await logActivity('TRUCK_DELETED', { truck_id: id, truck_number: truck?.truck_number });
        showToast('Deleted'); await loadAllData(true); renderTrucks(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    // ============ LOCAL DRIVERS SECTION ============
    // Helper function to check if destination is in NY/NJ/PA
    function isLocalDeliveryState(destination, deliveryState) {
      // Check destination field (e.g., "Brooklyn, NY")
      if (destination) {
        const dest = destination.toUpperCase();
        if (dest.includes(', NY') || dest.includes(', NJ') || dest.includes(', PA') ||
            dest.includes('NEW YORK') || dest.includes('NEW JERSEY') || dest.includes('PENNSYLVANIA') ||
            dest.endsWith(' NY') || dest.endsWith(' NJ') || dest.endsWith(' PA')) {
          return true;
        }
      }
      // Also check delivery_state field (e.g., "NY")
      if (deliveryState) {
        const state = deliveryState.toUpperCase().trim();
        if (state === 'NY' || state === 'NJ' || state === 'PA' ||
            state === 'NEW YORK' || state === 'NEW JERSEY' || state === 'PENNSYLVANIA') {
          return true;
        }
      }
      return false;
    }

    // Local Drivers page year filter (default to current year)
    let localDriversYear = new Date().getFullYear();

    function renderLocalDrivers(c) {
      // Clear detail view flag when going back to local drivers list
      currentDetailView = null;

      // Year filter for local drivers earnings
      const yearStart = localDriversYear + '-01-01';
      const yearEnd = localDriversYear + '-12-31';

      // Filter orders by year (using pickup_date or created_at)
      const yearFilteredOrders = appData.orders.filter(o => {
        if (o.pickup_date) return o.pickup_date >= yearStart && o.pickup_date <= yearEnd;
        if (o.created_at) return o.created_at >= yearStart && o.created_at <= yearEnd;
        return true;
      });

      // Get completed trip IDs (year-filtered for stats) and terminal/completed IDs (all years for pending deliveries)
      const yearFilteredTrips = appData.trips.filter(t => t.trip_date >= yearStart && t.trip_date <= yearEnd);
      const completedTripIds = yearFilteredTrips.filter(t => t.status === 'COMPLETED').map(t => t.id);
      const terminalOrCompletedTripIds = appData.trips.filter(t => t.status === 'COMPLETED' || t.status === 'AT_TERMINAL').map(t => t.id);

      // Pending local delivery: trip is COMPLETED or AT_TERMINAL, destination is NY/NJ/PA, has local_fee > 0, not assigned, not marked as "not for local"
      // Sorted by earliest delivery date first
      const pendingLocalDelivery = appData.orders.filter(o =>
        terminalOrCompletedTripIds.includes(o.trip_id) &&
        parseFloat(o.local_fee || 0) > 0 &&
        isLocalDeliveryState(o.destination, o.delivery_state) &&
        (!o.local_driver_id || o.local_delivery_status === 'UNASSIGNED') &&
        !o.not_for_local_delivery
      ).sort((a, b) => (a.dropoff_date || '').localeCompare(b.dropoff_date || ''));
      
      // Pending local pickup: cars in Load Board with "NY to Home" or "NY to FL" category, not assigned to local driver, not marked as "not for local"
      // Sorted by earliest pickup date first
      const pendingLocalPickup = appData.orders.filter(o =>
        (o.load_category === 'ny_to_home' || o.load_category === 'ny_to_fl') &&
        (!o.local_driver_id || o.local_delivery_status === 'UNASSIGNED') &&
        !o.not_for_local_delivery
      ).sort((a, b) => (a.pickup_date || '').localeCompare(b.pickup_date || ''));
      
      const assignedToLocal = appData.orders.filter(o => o.local_driver_id);
      
      // Calculate stats per local driver (filtered by year)
      const localDriverStats = (appData.local_drivers || []).map(ld => {
        const driverOrders = yearFilteredOrders.filter(o => o.local_driver_id === ld.id);
        const completedOrders = driverOrders.filter(o => o.local_delivery_status === 'DELIVERED');
        const pendingOrders = driverOrders.filter(o => o.local_delivery_status !== 'DELIVERED' && o.local_delivery_status !== 'UNASSIGNED');
        const totalEarnings = driverOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
        return { ...ld, totalOrders: driverOrders.length, completedOrders: completedOrders.length, pendingOrders: pendingOrders.length, totalEarnings };
      });
      
      const totalPendingDeliveryFees = pendingLocalDelivery.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
      const totalPendingPickupFees = pendingLocalPickup.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
      const totalPendingDeliveryRevenue = pendingLocalDelivery.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
      const totalPendingPickupRevenue = pendingLocalPickup.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
      
      // Year selector options for Local Drivers page
      const currentYear = new Date().getFullYear();
      const localDriversYearOptions = [currentYear, currentYear - 1, currentYear - 2, currentYear - 3].map(y =>
        '<option value="' + y + '"' + (localDriversYear === y ? ' selected' : '') + '>' + y + '</option>'
      ).join('');

      c.innerHTML = '<div class="header"><h2> Local Drivers</h2><div style="display:flex;align-items:center;gap:12px"><div style="display:flex;align-items:center;gap:8px;background:var(--bg-app);padding:var(--spacing-2) var(--spacing-3);border-radius:var(--radius)"><label style="font-weight:600;color:var(--text-secondary);font-size:var(--text-sm)">Year:</label><select onchange="localDriversYear=parseInt(this.value);renderLocalDrivers(document.getElementById(\'main-content\'))" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:14px">' + localDriversYearOptions + '</select></div><button class="btn btn-primary" onclick="openLocalDriverModal()">+ Add Local Driver</button></div></div>' +

        // Stats
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px"><div class="label">Local Drivers</div><div class="value">' + (appData.local_drivers || []).length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:12px 16px;background:var(--blue-dim)"><div class="label">Pending Pickup</div><div class="value" style="color:var(--blue)">' + pendingLocalPickup.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:12px 16px;background:var(--amber-dim)"><div class="label">Pending Delivery</div><div class="value" style="color:var(--amber)">' + pendingLocalDelivery.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:130px;padding:12px 16px"><div class="label">Total Pending Fees</div><div class="value" style="color:var(--red)">' + formatMoney(totalPendingDeliveryFees + totalPendingPickupFees) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:140px;padding:12px 16px;background:var(--green-dim)"><div class="label">Total Delivery Revenue</div><div class="value" style="color:var(--green)">' + formatMoney(totalPendingDeliveryRevenue) + '</div></div>' +
        '</div>' +
        
        // Local Drivers List
        '<div class="card" style="margin-bottom:24px"><div class="card-header"><h3> Local Drivers</h3></div>' +
        ((appData.local_drivers || []).length === 0 ? '<div style="padding:40px;text-align:center;color:var(--text-muted)">No local drivers yet. Add your first local driver!</div>' :
        '<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Phone</th><th>Area</th><th>Total Jobs</th><th>Pending</th><th>Total Earnings</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        localDriverStats.map(ld => '<tr><td><strong>' + ld.name + '</strong></td><td>' + (ld.phone || '-') + '</td><td>' + (ld.service_area || '-') + '</td><td>' + ld.totalOrders + '</td><td>' + ld.pendingOrders + '</td><td class="money">' + formatMoney(ld.totalEarnings) + '</td><td class="sticky-col"><div class="actions"><button class="action-btn view" onclick="viewLocalDriverDetails(' + ld.id + ')">View</button><button class="action-btn edit" onclick="openLocalDriverModal(' + ld.id + ')">Edit</button><button class="action-btn delete" onclick="deleteLocalDriver(' + ld.id + ')">Del</button></div></td></tr>').join('') +
        '</tbody></table></div>') +
        '</div>' +
        
        // Pending Local Pickup (from Load Board NY to Home)
        '<div class="card" style="margin-bottom:24px"><div class="card-header" style="background:var(--blue);color:white;border-radius:8px 8px 0 0"><h3 style="margin:0"> Pending Local Pickup (' + pendingLocalPickup.length + ')</h3></div>' +
        '<div style="padding:12px;background:var(--blue-dim);border-bottom:1px solid var(--blue-dim);font-size:13px;color:var(--blue)">Cars from <strong>Load Board  NY to Home</strong> that need pickup from NY/NJ to terminal. <span style="margin-left:12px"> Pending |  Scheduled |  Confirmed |  Ready |  Issue</span></div>' +
        (pendingLocalPickup.length === 0 ? '<div style="padding:40px;text-align:center;color:var(--text-muted)">No cars pending local pickup</div>' :
        '<div class="table-wrapper"><table><thead><tr><th>Status</th><th>Order</th><th>Broker</th><th>Vehicle</th><th>Origin</th><th>P</th><th>Destination</th><th>Pick-Up</th><th>Delivery</th><th>Payment</th><th>Broker Fee</th><th>Local Fee</th><th>Revenue</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        pendingLocalPickup.map(o => {
          const confirmStatus = o.local_confirmation_status || 'pending';
          const rowColors = { pending: 'var(--blue-dim)', scheduled: 'var(--amber-dim)', confirmed: 'var(--amber-dim)', ready: 'var(--green-dim)', issue: 'var(--red-dim)' };
          const statusIcons = { pending: '', scheduled: '', confirmed: '', ready: '', issue: '' };
          const rowColor = rowColors[confirmStatus] || 'var(--blue-dim)';
          const statusIcon = statusIcons[confirmStatus] || '';
          const pickupPhoneDisplay = o.pickup_phone ? '<a href="tel:' + o.pickup_phone + '" style="color:var(--blue)" title="' + o.pickup_phone + '"></a>' : '-';
          const noteBtn = o.local_notes ? 
            '<button class="action-btn" style="background:var(--purple);color:white" onclick="openLocalNote(' + o.id + ')" title="' + o.local_notes.replace(/"/g, '&quot;').replace(/\n/g, ' ') + '"></button>' : 
            '<button class="action-btn" style="background:var(--purple-dim);color:var(--purple)" onclick="openLocalNote(' + o.id + ')" title="Add note">+</button>';
          const noteHtml = o.local_notes ? '<tr style="background:var(--purple-dim)"><td colspan="14" style="padding:8px 16px;font-size:13px"><span style="font-weight:600;color:var(--purple)"> Local Note:</span> ' + o.local_notes + '</td></tr>' : '';
          return '<tr style="background:' + rowColor + '"><td style="text-align:center"><button onclick="cycleConfirmationStatus(' + o.id + ')" style="background:none;border:none;font-size:18px;cursor:pointer" title="Click to change status">' + statusIcon + '</button></td><td><strong>' + o.order_number + '</strong></td><td>' + (o.broker_name || '-') + '</td><td>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</td><td title="' + (o.pickup_full_address || o.origin || '') + '">' + (o.origin || '-') + '</td><td>' + pickupPhoneDisplay + '</td><td title="' + (o.delivery_full_address || o.destination || '') + '">' + (o.destination || '-') + '</td><td>' + (o.pickup_date ? formatDate(o.pickup_date) : '-') + '</td><td>' + (o.dropoff_date ? formatDate(o.dropoff_date) : '-') + '</td><td><span class="badge badge-blue">' + (o.payment_type || '-') + '</span></td><td class="money negative">' + formatMoney(o.broker_fee || 0) + '</td><td class="money negative">' + formatMoney(o.local_fee || 0) + '</td><td class="money">' + formatMoney(o.revenue || 0) + '</td><td class="sticky-col"><div class="actions">' + noteBtn + '<button class="action-btn" style="background:var(--green);color:white" onclick="openAssignLocalDriver(' + o.id + ',\'pickup\')">Assign</button><button class="action-btn" style="background:var(--text-secondary);color:white" onclick="markNotForLocalDelivery(' + o.id + ')">Not Local</button></div></td></tr>' + noteHtml;
        }).join('') +
        '</tbody></table></div>') +
        '</div>' +
        
        // Pending Local Delivery (from completed trips)
        '<div class="card"><div class="card-header" style="background:var(--amber);color:white;border-radius:8px 8px 0 0"><h3 style="margin:0"> Pending Local Delivery (' + pendingLocalDelivery.length + ')</h3></div>' +
        '<div style="padding:12px;background:var(--amber-dim);border-bottom:1px solid var(--amber-dim);font-size:13px;color:var(--amber)">Cars from <strong>COMPLETED</strong> trips with destinations in <strong>NY, NJ, or PA</strong>. <span style="margin-left:12px"> Pending |  Scheduled |  Confirmed |  Ready |  Issue</span></div>' +
        (pendingLocalDelivery.length === 0 ? '<div style="padding:40px;text-align:center;color:var(--text-muted)">No orders pending local delivery</div>' :
        '<div class="table-wrapper"><table><thead><tr><th>Status</th><th>Order</th><th>Broker</th><th>Vehicle</th><th>Origin</th><th>Destination</th><th>D</th><th>Pick-Up</th><th>Delivery</th><th>Payment</th><th>Broker Fee</th><th>Local Fee</th><th>Revenue</th><th>Trip</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        pendingLocalDelivery.map(o => {
          const trip = appData.trips.find(t => t.id === o.trip_id);
          const confirmStatus = o.local_confirmation_status || 'pending';
          const rowColors = { pending: 'var(--blue-dim)', scheduled: 'var(--amber-dim)', confirmed: 'var(--amber-dim)', ready: 'var(--green-dim)', issue: 'var(--red-dim)' };
          const statusIcons = { pending: '', scheduled: '', confirmed: '', ready: '', issue: '' };
          const rowColor = rowColors[confirmStatus] || 'var(--blue-dim)';
          const statusIcon = statusIcons[confirmStatus] || '';
          const deliveryPhoneDisplay = o.delivery_phone ? '<a href="tel:' + o.delivery_phone + '" style="color:var(--green)" title="' + o.delivery_phone + '"></a>' : '-';
          const noteBtn = o.local_notes ? 
            '<button class="action-btn" style="background:var(--purple);color:white" onclick="openLocalNote(' + o.id + ')" title="' + o.local_notes.replace(/"/g, '&quot;').replace(/\n/g, ' ') + '"></button>' : 
            '<button class="action-btn" style="background:var(--purple-dim);color:var(--purple)" onclick="openLocalNote(' + o.id + ')" title="Add note">+</button>';
          const noteHtml = o.local_notes ? '<tr style="background:var(--purple-dim)"><td colspan="15" style="padding:8px 16px;font-size:13px"><span style="font-weight:600;color:var(--purple)"> Local Note:</span> ' + o.local_notes + '</td></tr>' : '';
          return '<tr style="background:' + rowColor + '"><td style="text-align:center"><button onclick="cycleConfirmationStatus(' + o.id + ')" style="background:none;border:none;font-size:18px;cursor:pointer" title="Click to change status">' + statusIcon + '</button></td><td><strong>' + o.order_number + '</strong></td><td>' + (o.broker_name || '-') + '</td><td>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</td><td title="' + (o.pickup_full_address || o.origin || '') + '">' + (o.origin || '-') + '</td><td title="' + (o.delivery_full_address || o.destination || '') + '">' + o.destination + '</td><td>' + deliveryPhoneDisplay + '</td><td>' + (o.pickup_date ? formatDate(o.pickup_date) : '-') + '</td><td>' + (o.dropoff_date ? formatDate(o.dropoff_date) : '-') + '</td><td><span class="badge badge-blue">' + (o.payment_type || '-') + '</span></td><td class="money negative">' + formatMoney(o.broker_fee || 0) + '</td><td class="money negative">' + formatMoney(o.local_fee) + '</td><td class="money">' + formatMoney(o.revenue || 0) + '</td><td>' + (trip ? trip.trip_number : '-') + '</td><td class="sticky-col"><div class="actions">' + noteBtn + '<button class="action-btn" style="background:var(--green);color:white" onclick="openAssignLocalDriver(' + o.id + ',\'delivery\')">Assign</button><button class="action-btn" style="background:var(--text-secondary);color:white" onclick="markNotForLocalDelivery(' + o.id + ')">Not Local</button></div></td></tr>' + noteHtml;
        }).join('') +
        '</tbody></table></div>') +
        '</div>';
    }

    function openLocalDriverModal(id = null) {
      const ld = id ? (appData.local_drivers || []).find(x => x.id === id) : null;
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:450px"><div class="modal-header"><h3>' + (ld ? 'Edit' : 'Add') + ' Local Driver</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div class="form-group"><label>Name *</label><input id="ldName" value="' + (ld?.name || '') + '" placeholder="Driver name"></div>' +
        '<div class="form-row"><div class="form-group"><label>Phone</label><input id="ldPhone" value="' + (ld?.phone || '') + '" placeholder="(555) 123-4567"></div><div class="form-group"><label>Service Area</label><input id="ldArea" value="' + (ld?.service_area || '') + '" placeholder="e.g., NY/NJ"></div></div>' +
        '<div class="form-group"><label>Notes</label><textarea id="ldNotes" rows="2" placeholder="Any notes...">' + (ld?.notes || '') + '</textarea></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveLocalDriver(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    async function saveLocalDriver(id) {
      const name = document.getElementById('ldName').value.trim();
      if (!name) { showToast('Name is required', 'error'); return; }
      
      const data = {
        name: name,
        phone: document.getElementById('ldPhone').value || null,
        service_area: document.getElementById('ldArea').value || null,
        notes: document.getElementById('ldNotes').value || null
      };
      
      try {
        if (id) {
          await dbUpdate('local_drivers', id, data);
          await logActivity('LOCAL_DRIVER_UPDATED', { local_driver_id: id, driver_name: name });
        } else {
          const newDriver = await dbInsert('local_drivers', data);
          await logActivity('LOCAL_DRIVER_CREATED', { local_driver_id: newDriver.id, driver_name: name, service_area: data.service_area });
        }
        document.querySelector('.modal-overlay').remove();
        showToast('Local driver saved!');
        await loadAllData(true);
        renderLocalDrivers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteLocalDriver(id) {
      if (!confirm('Delete this local driver?')) return;
      try {
        const driver = (appData.local_drivers || []).find(d => d.id === id);
        await dbDelete('local_drivers', id);
        await logActivity('LOCAL_DRIVER_DELETED', { local_driver_id: id, driver_name: driver?.name });
        showToast('Deleted');
        await loadAllData(true);
        renderLocalDrivers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    // Cycle through confirmation statuses: pending (blue) -> scheduled (orange) -> confirmed (yellow) -> ready (green) -> issue (red) -> pending
    async function cycleConfirmationStatus(orderId) {
      const order = appData.orders.find(o => o.id === orderId);
      if (!order) return;
      
      const currentStatus = order.local_confirmation_status || 'pending';
      let newStatus;
      
      // Cycle: pending -> scheduled -> confirmed -> ready -> issue -> pending
      if (currentStatus === 'pending') {
        newStatus = 'scheduled';
      } else if (currentStatus === 'scheduled') {
        newStatus = 'confirmed';
      } else if (currentStatus === 'confirmed') {
        newStatus = 'ready';
      } else if (currentStatus === 'ready') {
        newStatus = 'issue';
      } else {
        newStatus = 'pending';
      }
      
      try {
        await dbUpdate('orders', orderId, { local_confirmation_status: newStatus });
        
        // Update local data
        order.local_confirmation_status = newStatus;
        
        const statusLabels = { pending: 'Pending', scheduled: 'Scheduled', confirmed: 'Confirmed', ready: 'Ready', issue: 'Issue' };
        showToast('Status changed to: ' + statusLabels[newStatus]);
        
        // Re-render the page
        renderLocalDrivers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    // Quick note for Local Drivers page
    function openLocalNote(orderId) {
      const o = appData.orders.find(x => x.id === orderId);
      if (!o) return;
      
      const m = document.createElement('div'); 
      m.className = 'modal-overlay'; 
      m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header" style="background:var(--purple);color:white"><h3 style="margin:0"> Local Note</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()" style="color:white"></button></div><div class="modal-body">' +
        '<div style="background:var(--purple-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:16px">' +
        '<strong>' + o.order_number + '</strong> - ' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + 
        '<br><span style="color:var(--purple)">' + (o.origin || '-') + '  ' + (o.destination || '-') + '</span></div>' +
        '<div class="form-group"><label>Note</label><textarea id="localNoteText" rows="4" placeholder="Add note about this vehicle..." style="resize:vertical;width:100%">' + (o.local_notes || '') + '</textarea></div>' +
        '</div><div class="modal-footer">' +
        (o.local_notes ? '<button class="btn" style="background:var(--red-dim);color:var(--red);border:1px solid var(--red-dim);margin-right:auto" onclick="clearLocalNote(' + orderId + ')">Clear Note</button>' : '') +
        '<button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button>' +
        '<button class="btn" style="background:var(--purple);color:white" onclick="saveLocalNote(' + orderId + ')">Save Note</button></div></div>';
      document.body.appendChild(m);
      
      // Focus on textarea
      setTimeout(() => document.getElementById('localNoteText')?.focus(), 100);
    }

    async function saveLocalNote(orderId) {
      const noteText = document.getElementById('localNoteText').value.trim();
      
      try {
        await dbUpdate('orders', orderId, { local_notes: noteText || null });
        
        // Update local data
        const order = appData.orders.find(o => o.id === orderId);
        if (order) order.local_notes = noteText || null;
        
        document.querySelector('.modal-overlay').remove();
        showToast(noteText ? 'Note saved!' : 'Note cleared');
        renderLocalDrivers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function clearLocalNote(orderId) {
      if (!confirm('Clear this note?')) return;
      
      try {
        await dbUpdate('orders', orderId, { local_notes: null });
        
        // Update local data
        const order = appData.orders.find(o => o.id === orderId);
        if (order) order.local_notes = null;
        
        document.querySelector('.modal-overlay').remove();
        showToast('Note cleared');
        renderLocalDrivers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function markNotForLocalDelivery(orderId) {
      if (!confirm('Mark this order as NOT for local delivery? It will be removed from the pending list.')) return;
      try {
        await dbUpdate('orders', orderId, { not_for_local_delivery: true });
        showToast('Marked as not for local delivery');
        await loadAllData(true);
        renderLocalDrivers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    function openAssignLocalDriver(orderId, type = null) {
      const o = appData.orders.find(x => x.id === orderId);
      const isPickup = type === 'pickup';
      const isDelivery = type === 'delivery';
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:450px"><div class="modal-header"><h3>Assign Local Driver</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div style="background:var(--bg-card-hover);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:16px"><strong>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</strong><br><span style="color:var(--text-muted)">' + (o.origin || '-') + '  ' + (o.destination || '-') + '</span><br><span style="color:var(--green);font-weight:600">Local Fee: ' + formatMoney(o.local_fee || 0) + '</span></div>' +
        '<div class="form-group"><label>Local Driver *</label><select id="selectLocalDriver"><option value="">Select local driver...</option>' + 
        (appData.local_drivers || []).map(ld => '<option value="' + ld.id + '">' + ld.name + (ld.service_area ? ' (' + ld.service_area + ')' : '') + '</option>').join('') +
        '</select></div>' +
        '<div class="form-group"><label>Job Type *</label><select id="selectLocalType"><option value="TO_TERMINAL"' + (isPickup ? ' selected' : '') + '> Pickup: NY/NJ  Terminal</option><option value="FROM_TERMINAL"' + (isDelivery ? ' selected' : '') + '> Delivery: Terminal  NY/NJ/PA</option></select></div>' +
        '<div class="form-group"><label>Assigned Date</label><input type="date" id="localAssignedDate" value="' + new Date().toISOString().split('T')[0] + '"></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="assignLocalDriverToOrder(' + orderId + ')">Assign</button></div></div>';
      document.body.appendChild(m);
    }

    async function assignLocalDriverToOrder(orderId) {
      const localDriverId = parseInt(document.getElementById('selectLocalDriver').value);
      if (!localDriverId) { showToast('Please select a local driver', 'error'); return; }
      
      const localType = document.getElementById('selectLocalType').value;
      const assignedDate = document.getElementById('localAssignedDate').value;
      
      try {
        await dbUpdate('orders', orderId, { 
          local_driver_id: localDriverId, 
          local_delivery_status: 'ASSIGNED',
          local_delivery_type: localType,
          local_assigned_date: assignedDate || new Date().toISOString().split('T')[0]
        });
        document.querySelector('.modal-overlay').remove();
        showToast('Local driver assigned!');
        await loadAllData(true);
        renderLocalDrivers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    function viewLocalDriverDetails(localDriverId) {
      // Mark that we're viewing a local driver detail (prevents background re-renders)
      currentDetailView = { type: 'local_driver', id: localDriverId };

      const ld = (appData.local_drivers || []).find(x => x.id === localDriverId);
      if (!ld) {
        // Local driver was deleted or not found - go back to list
        currentDetailView = null;
        renderLocalDrivers(document.getElementById('main-content'));
        return;
      }

      // Filter by localDriversYear
      const yearStart = localDriversYear + '-01-01';
      const yearEnd = localDriversYear + '-12-31';
      const yearFilteredOrders = appData.orders.filter(o => {
        if (o.pickup_date) return o.pickup_date >= yearStart && o.pickup_date <= yearEnd;
        if (o.created_at) return o.created_at >= yearStart && o.created_at <= yearEnd;
        return true;
      });

      const driverOrders = yearFilteredOrders.filter(o => o.local_driver_id === localDriverId);
      const totalEarnings = driverOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
      const pendingOrders = driverOrders.filter(o => o.local_delivery_status !== 'DELIVERED' && o.local_delivery_status !== 'UNASSIGNED');
      const completedOrders = driverOrders.filter(o => o.local_delivery_status === 'DELIVERED');
      const toTerminalOrders = driverOrders.filter(o => o.local_delivery_type === 'TO_TERMINAL');
      const fromTerminalOrders = driverOrders.filter(o => o.local_delivery_type === 'FROM_TERMINAL');
      
      const getTypeBadge = (type) => {
        if (type === 'TO_TERMINAL') return '<span class="badge" style="background:var(--amber-dim);color:var(--amber)"> Pickup</span>';
        if (type === 'FROM_TERMINAL') return '<span class="badge" style="background:var(--bg-elevated);color:var(--text-secondary)"> Delivery</span>';
        return '<span class="badge badge-gray">-</span>';
      };
      
      const c = document.getElementById('main-content');
      c.innerHTML = '<div class="header"><div style="display:flex;align-items:center;gap:16px"><button class="btn btn-secondary" onclick="renderLocalDrivers(document.getElementById(\'main-content\'))"> Back</button><h2> ' + ld.name + '</h2></div></div>' +
        
        // Stats
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:20px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px"><div class="label">Total Deliveries</div><div class="value">' + driverOrders.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Completed</div><div class="value" style="color:var(--green)">' + completedOrders.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px"><div class="label">Pending</div><div class="value" style="color:var(--amber)">' + pendingOrders.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px;background:var(--amber-dim)"><div class="label"> Pickups</div><div class="value">' + toTerminalOrders.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px;background:var(--bg-elevated)"><div class="label"> Deliveries</div><div class="value">' + fromTerminalOrders.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px;background:var(--green-dim)"><div class="label">Total Earnings</div><div class="value" style="color:var(--green)">' + formatMoney(totalEarnings) + '</div></div>' +
        '</div>' +
        
        // Driver Info
        '<div class="card" style="margin-bottom:24px;padding:20px"><div style="display:flex;gap:24px;flex-wrap:wrap">' +
        '<div><span style="color:var(--text-muted)">Phone:</span> <strong>' + (ld.phone || '-') + '</strong></div>' +
        '<div><span style="color:var(--text-muted)">Service Area:</span> <strong>' + (ld.service_area || '-') + '</strong></div>' +
        (ld.notes ? '<div style="width:100%"><span style="color:var(--text-muted)">Notes:</span> ' + ld.notes + '</div>' : '') +
        '</div></div>' +
        
        // Assigned Orders
        '<div class="card"><div class="card-header"><h3> Assigned Orders</h3></div>' +
        '<div style="padding:12px;background:var(--bg-app);border-bottom:1px solid var(--border);font-size:13px;color:var(--text-secondary)"> Pending |  Scheduled |  Confirmed |  Ready |  Issue</div>' +
        (driverOrders.length === 0 ? '<div style="padding:40px;text-align:center;color:var(--text-muted)">No orders assigned yet</div>' :
        '<div class="table-wrapper"><table><thead><tr><th>Status</th><th>Order</th><th>Broker</th><th>Vehicle</th><th>Origin</th><th>P</th><th>Destination</th><th>D</th><th>Type</th><th>Broker Fee</th><th>Local Fee</th><th>Revenue</th><th>Delivery</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        driverOrders.map(o => {
          const confirmStatus = o.local_confirmation_status || 'pending';
          const rowColors = { pending: 'var(--blue-dim)', scheduled: 'var(--amber-dim)', confirmed: 'var(--amber-dim)', ready: 'var(--green-dim)', issue: 'var(--red-dim)' };
          const statusIcons = { pending: '', scheduled: '', confirmed: '', ready: '', issue: '' };
          const rowColor = rowColors[confirmStatus] || 'var(--blue-dim)';
          const statusIcon = statusIcons[confirmStatus] || '';
          const pickupPhoneDisplay = o.pickup_phone ? '<a href="tel:' + o.pickup_phone + '" style="color:var(--blue)" title="' + o.pickup_phone + '"></a>' : '-';
          const deliveryPhoneDisplay = o.delivery_phone ? '<a href="tel:' + o.delivery_phone + '" style="color:var(--green)" title="' + o.delivery_phone + '"></a>' : '-';
          const noteBtn = o.local_notes ? 
            '<button class="action-btn" style="background:var(--purple);color:white" onclick="openLocalNoteFromDriver(' + o.id + ',' + localDriverId + ')" title="' + o.local_notes.replace(/"/g, '&quot;').replace(/\n/g, ' ') + '"></button>' : 
            '<button class="action-btn" style="background:var(--purple-dim);color:var(--purple)" onclick="openLocalNoteFromDriver(' + o.id + ',' + localDriverId + ')" title="Add note">+</button>';
          const noteHtml = o.local_notes ? '<tr style="background:var(--purple-dim)"><td colspan="14" style="padding:8px 16px;font-size:13px"><span style="font-weight:600;color:var(--purple)"> Local Note:</span> ' + o.local_notes + '</td></tr>' : '';
          return '<tr style="background:' + rowColor + '"><td style="text-align:center"><button onclick="cycleConfirmationStatusFromDriver(' + o.id + ',' + localDriverId + ')" style="background:none;border:none;font-size:18px;cursor:pointer" title="Click to change status">' + statusIcon + '</button></td><td><strong>' + o.order_number + '</strong>' + (o.trip_id ? ' <span class="badge badge-blue" style="font-size:10px">On Trip</span>' : '') + '</td><td>' + (o.broker_name || '-') + '</td><td>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</td><td title="' + (o.pickup_full_address || o.origin || '') + '">' + (o.origin || '-') + '</td><td>' + pickupPhoneDisplay + '</td><td title="' + (o.delivery_full_address || o.destination || '') + '">' + (o.destination || '-') + '</td><td>' + deliveryPhoneDisplay + '</td><td>' + getTypeBadge(o.local_delivery_type) + '</td><td class="money negative">' + formatMoney(o.broker_fee || 0) + '</td><td class="money negative">' + formatMoney(o.local_fee || 0) + '</td><td class="money">' + formatMoney(o.revenue || 0) + '</td><td><span class="badge ' + (o.local_delivery_status === 'DELIVERED' ? 'badge-green' : o.local_delivery_status === 'UNASSIGNED' ? 'badge-gray' : 'badge-amber') + '">' + (o.local_delivery_status || 'ASSIGNED') + '</span></td><td class="sticky-col"><div class="actions">' + noteBtn + (o.local_delivery_status !== 'DELIVERED' && o.local_delivery_status !== 'UNASSIGNED' ? '<button class="action-btn edit" style="background:var(--green);color:white" onclick="markLocalDelivered(' + o.id + ',' + localDriverId + ')"></button>' : '') + (o.local_delivery_status !== 'UNASSIGNED' ? '<button class="action-btn delete" onclick="unassignLocalDriver(' + o.id + ',' + localDriverId + ')"></button>' : '') + '</div></td></tr>' + noteHtml;
        }).join('') +
        '</tbody></table></div>') +
        '</div>';
    }

    async function markLocalDelivered(orderId, localDriverId) {
      try {
        await dbUpdate('orders', orderId, { local_delivery_status: 'DELIVERED' });
        showToast('Marked as delivered!');
        await loadAllData(true);
        viewLocalDriverDetails(localDriverId);
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function unassignLocalDriver(orderId, localDriverId) {
      if (!confirm('Unassign this order from local driver?')) return;
      try {
        await dbUpdate('orders', orderId, { local_delivery_status: 'UNASSIGNED' });
        showToast('Unassigned');
        await loadAllData(true);
        viewLocalDriverDetails(localDriverId);
      } catch (e) { showToast(e.message, 'error'); }
    }

    // Cycle confirmation status from driver details view
    async function cycleConfirmationStatusFromDriver(orderId, localDriverId) {
      const order = appData.orders.find(o => o.id === orderId);
      if (!order) return;
      
      const currentStatus = order.local_confirmation_status || 'pending';
      let newStatus;
      
      if (currentStatus === 'pending') newStatus = 'scheduled';
      else if (currentStatus === 'scheduled') newStatus = 'confirmed';
      else if (currentStatus === 'confirmed') newStatus = 'ready';
      else if (currentStatus === 'ready') newStatus = 'issue';
      else newStatus = 'pending';
      
      try {
        await dbUpdate('orders', orderId, { local_confirmation_status: newStatus });
        order.local_confirmation_status = newStatus;
        const statusLabels = { pending: 'Pending', scheduled: 'Scheduled', confirmed: 'Confirmed', ready: 'Ready', issue: 'Issue' };
        showToast('Status changed to: ' + statusLabels[newStatus]);
        viewLocalDriverDetails(localDriverId);
      } catch (e) { showToast(e.message, 'error'); }
    }

    // Open local note from driver details view
    function openLocalNoteFromDriver(orderId, localDriverId) {
      const o = appData.orders.find(x => x.id === orderId);
      if (!o) return;
      
      const m = document.createElement('div'); 
      m.className = 'modal-overlay'; 
      m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header" style="background:var(--purple);color:white"><h3 style="margin:0"> Local Note</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()" style="color:white"></button></div><div class="modal-body">' +
        '<div style="background:var(--purple-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:16px">' +
        '<strong>' + o.order_number + '</strong> - ' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + 
        '<br><span style="color:var(--purple)">' + (o.origin || '-') + '  ' + (o.destination || '-') + '</span></div>' +
        '<div class="form-group"><label>Note</label><textarea id="localNoteText" rows="4" placeholder="Add note about this vehicle..." style="resize:vertical;width:100%">' + (o.local_notes || '') + '</textarea></div>' +
        '</div><div class="modal-footer">' +
        (o.local_notes ? '<button class="btn" style="background:var(--red-dim);color:var(--red);border:1px solid var(--red-dim);margin-right:auto" onclick="clearLocalNoteFromDriver(' + orderId + ',' + localDriverId + ')">Clear Note</button>' : '') +
        '<button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button>' +
        '<button class="btn" style="background:var(--purple);color:white" onclick="saveLocalNoteFromDriver(' + orderId + ',' + localDriverId + ')">Save Note</button></div></div>';
      document.body.appendChild(m);
      setTimeout(() => document.getElementById('localNoteText')?.focus(), 100);
    }

    async function saveLocalNoteFromDriver(orderId, localDriverId) {
      const noteText = document.getElementById('localNoteText').value.trim();
      try {
        await dbUpdate('orders', orderId, { local_notes: noteText || null });
        const order = appData.orders.find(o => o.id === orderId);
        if (order) order.local_notes = noteText || null;
        document.querySelector('.modal-overlay').remove();
        showToast(noteText ? 'Note saved!' : 'Note cleared');
        viewLocalDriverDetails(localDriverId);
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function clearLocalNoteFromDriver(orderId, localDriverId) {
      if (!confirm('Clear this note?')) return;
      try {
        await dbUpdate('orders', orderId, { local_notes: null });
        const order = appData.orders.find(o => o.id === orderId);
        if (order) order.local_notes = null;
        document.querySelector('.modal-overlay').remove();
        showToast('Note cleared');
        viewLocalDriverDetails(localDriverId);
      } catch (e) { showToast(e.message, 'error'); }
    }

    // ============ BROKERS SECTION ============
    function renderBrokers(c) {
      // Calculate comprehensive stats per broker
      const brokerStats = (appData.brokers || []).map(b => {
        const brokerOrders = appData.orders.filter(o => o.broker_id === b.id);
        const totalRevenue = brokerOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
        const totalBrokerFee = brokerOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
        const avgRevenue = brokerOrders.length > 0 ? totalRevenue / brokerOrders.length : 0;
        const avgBrokerFee = brokerOrders.length > 0 ? totalBrokerFee / brokerOrders.length : 0;
        const feePercent = totalRevenue > 0 ? (totalBrokerFee / totalRevenue * 100) : 0;
        
        // Calculate profit (revenue - broker fees - estimated driver cut 32%)
        const cleanRevenue = totalRevenue - totalBrokerFee;
        const estimatedDriverCut = cleanRevenue * 0.32;
        const estimatedProfit = cleanRevenue - estimatedDriverCut;
        const profitPerLoad = brokerOrders.length > 0 ? estimatedProfit / brokerOrders.length : 0;
        
        // Get unique trips for this broker
        const tripIds = [...new Set(brokerOrders.filter(o => o.trip_id).map(o => o.trip_id))];
        
        // Find most recent order date
        const orderDates = brokerOrders.filter(o => o.pickup_date).map(o => new Date(o.pickup_date));
        const lastOrderDate = orderDates.length > 0 ? new Date(Math.max(...orderDates)) : null;
        const daysSinceLastOrder = lastOrderDate ? Math.floor((new Date() - lastOrderDate) / (1000 * 60 * 60 * 24)) : null;
        
        // Calculate load frequency (orders per month)
        const firstOrderDate = orderDates.length > 0 ? new Date(Math.min(...orderDates)) : null;
        let ordersPerMonth = 0;
        if (firstOrderDate && brokerOrders.length > 1) {
          const monthsActive = Math.max(1, (new Date() - firstOrderDate) / (1000 * 60 * 60 * 24 * 30));
          ordersPerMonth = brokerOrders.length / monthsActive;
        }
        
        // Reliability score (based on fee consistency and volume)
        let reliabilityScore = 0;
        if (brokerOrders.length >= 10) reliabilityScore += 30;
        else if (brokerOrders.length >= 5) reliabilityScore += 20;
        else if (brokerOrders.length >= 1) reliabilityScore += 10;
        if (feePercent <= 8) reliabilityScore += 30;
        else if (feePercent <= 12) reliabilityScore += 20;
        else if (feePercent <= 15) reliabilityScore += 10;
        if (profitPerLoad >= 500) reliabilityScore += 40;
        else if (profitPerLoad >= 300) reliabilityScore += 30;
        else if (profitPerLoad >= 100) reliabilityScore += 20;
        else if (profitPerLoad > 0) reliabilityScore += 10;
        
        return { 
          ...b, 
          orderCount: brokerOrders.length, 
          tripCount: tripIds.length,
          totalRevenue, 
          totalBrokerFee,
          avgRevenue,
          avgBrokerFee,
          feePercent,
          cleanRevenue,
          estimatedProfit,
          profitPerLoad,
          lastOrderDate,
          daysSinceLastOrder,
          ordersPerMonth,
          reliabilityScore
        };
      }).sort((a, b) => b.estimatedProfit - a.estimatedProfit); // Sort by profit
      
      // Calculate totals for summary
      const totalBrokersRevenue = brokerStats.reduce((s, b) => s + b.totalRevenue, 0);
      const totalBrokersFees = brokerStats.reduce((s, b) => s + b.totalBrokerFee, 0);
      const totalBrokersProfit = brokerStats.reduce((s, b) => s + b.estimatedProfit, 0);
      const avgFeePercent = totalBrokersRevenue > 0 ? (totalBrokersFees / totalBrokersRevenue * 100) : 0;
      
      const getScoreColor = (score) => {
        if (score >= 80) return 'var(--green)';
        if (score >= 60) return 'var(--blue)';
        if (score >= 40) return 'var(--amber)';
        return 'var(--red)';
      };
      
      const getScoreLabel = (score) => {
        if (score >= 80) return 'Excellent';
        if (score >= 60) return 'Good';
        if (score >= 40) return 'Fair';
        return 'New';
      };
      
      const getActivityStatus = (days) => {
        if (days === null) return { label: 'No orders', color: 'var(--text-muted)', bg: 'var(--bg-card-hover)' };
        if (days <= 7) return { label: 'Active', color: 'var(--green)', bg: 'var(--green-dim)' };
        if (days <= 30) return { label: 'Recent', color: 'var(--blue)', bg: 'var(--blue-dim)' };
        if (days <= 90) return { label: 'Inactive', color: 'var(--amber)', bg: 'var(--amber-dim)' };
        return { label: 'Dormant', color: 'var(--red)', bg: 'var(--red-dim)' };
      };
      
      c.innerHTML = '<div class="header"><h2> Brokers</h2><div style="display:flex;gap:12px"><button class="btn btn-primary" onclick="openBrokerModal()">+ New Broker</button></div></div>' +
        
        // Summary Cards
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px">' +
        '<div style="background:linear-gradient(135deg,var(--blue),var(--blue));color:white;padding:20px;border-radius:12px;text-align:center">' +
        '<div style="font-size:12px;opacity:0.9">Total Brokers</div>' +
        '<div style="font-size:32px;font-weight:800">' + brokerStats.length + '</div></div>' +
        '<div style="background:linear-gradient(135deg,var(--green),var(--green));color:white;padding:20px;border-radius:12px;text-align:center">' +
        '<div style="font-size:12px;opacity:0.9">Total Revenue</div>' +
        '<div style="font-size:24px;font-weight:800">' + formatMoney(totalBrokersRevenue) + '</div></div>' +
        '<div style="background:linear-gradient(135deg,var(--amber),var(--amber));color:white;padding:20px;border-radius:12px;text-align:center">' +
        '<div style="font-size:12px;opacity:0.9">Avg Fee %</div>' +
        '<div style="font-size:32px;font-weight:800">' + avgFeePercent.toFixed(1) + '%</div></div>' +
        '<div style="background:linear-gradient(135deg,var(--purple),var(--purple));color:white;padding:20px;border-radius:12px;text-align:center">' +
        '<div style="font-size:12px;opacity:0.9">Est. Total Profit</div>' +
        '<div style="font-size:24px;font-weight:800">' + formatMoney(totalBrokersProfit) + '</div></div>' +
        '</div>' +
        
        // Broker Cards Grid
        '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:20px">' +
        (brokerStats.length === 0 ? '<div style="grid-column:1/-1;text-align:center;padding:60px;background:var(--bg-app);border-radius:12px">No brokers yet. Add your first broker!</div>' :
        brokerStats.map((b, idx) => {
          const activity = getActivityStatus(b.daysSinceLastOrder);
          const scoreColor = getScoreColor(b.reliabilityScore);
          const scoreLabel = getScoreLabel(b.reliabilityScore);
          const rankBadge = idx === 0 ? '' : idx === 1 ? '' : idx === 2 ? '' : '';
          
          return '<div class="card" style="padding:0;overflow:hidden;transition:transform 0.2s,box-shadow 0.2s" onmouseover="this.style.transform=\'translateY(-4px)\';this.style.boxShadow=\'0 8px 25px rgba(0,0,0,0.15)\'" onmouseout="this.style.transform=\'none\';this.style.boxShadow=\'var(--shadow)\'">' +
            // Header
            '<div style="background:linear-gradient(135deg,var(--bg-elevated),var(--bg-elevated));color:white;padding:16px 20px;display:flex;justify-content:space-between;align-items:center">' +
            '<div style="display:flex;align-items:center;gap:12px">' +
            (rankBadge ? '<span style="font-size:24px">' + rankBadge + '</span>' : '') +
            '<div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold)">' + b.name + '</div>' +
            '<div style="font-size:12px;opacity:0.8">' + b.orderCount + ' loads  ' + b.tripCount + ' trips</div></div></div>' +
            '<div style="text-align:right">' +
            '<div style="font-size:11px;padding:4px 10px;border-radius:12px;background:' + activity.bg + ';color:' + activity.color + ';font-weight:600">' + activity.label + '</div>' +
            '</div></div>' +
            
            // Score Bar
            '<div style="padding:12px 20px;background:var(--bg-app);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px">' +
            '<div style="flex:1">' +
            '<div style="display:flex;justify-content:space-between;margin-bottom:4px">' +
            '<span style="font-size:var(--text-xs);color:var(--text-muted)">Reliability Score</span>' +
            '<span style="font-size:11px;font-weight:600;color:' + scoreColor + '">' + scoreLabel + ' (' + b.reliabilityScore + '/100)</span></div>' +
            '<div style="height:8px;background:var(--border);border-radius:4px;overflow:hidden">' +
            '<div style="height:100%;width:' + b.reliabilityScore + '%;background:' + scoreColor + ';border-radius:4px;transition:width 0.3s"></div></div></div></div>' +
            
            // Stats Grid
            '<div style="padding:16px 20px">' +
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">' +
            
            // Avg Rate
            '<div style="background:var(--blue-dim);padding:var(--spacing-3);border-radius:var(--radius)">' +
            '<div style="font-size:10px;color:var(--blue);text-transform:uppercase;letter-spacing:0.5px">Avg Rate/Load</div>' +
            '<div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--blue)">' + formatMoney(b.avgRevenue) + '</div></div>' +
            
            // Avg Fee
            '<div style="background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius)">' +
            '<div style="font-size:10px;color:var(--amber);text-transform:uppercase;letter-spacing:0.5px">Avg Fee</div>' +
            '<div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--amber)">' + formatMoney(b.avgBrokerFee) + ' <span style="font-size:12px;font-weight:500">(' + b.feePercent.toFixed(1) + '%)</span></div></div>' +
            
            // Profit/Load
            '<div style="background:' + (b.profitPerLoad >= 0 ? 'var(--green-dim)' : 'var(--red-dim)') + ';padding:var(--spacing-3);border-radius:var(--radius)">' +
            '<div style="font-size:10px;color:' + (b.profitPerLoad >= 0 ? 'var(--green)' : 'var(--red)') + ';text-transform:uppercase;letter-spacing:0.5px">Est. Profit/Load</div>' +
            '<div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:' + (b.profitPerLoad >= 0 ? 'var(--primary-700)' : 'var(--red)') + '">' + formatMoney(b.profitPerLoad) + '</div></div>' +
            
            // Total Revenue
            '<div style="background:var(--bg-card-hover);padding:var(--spacing-3);border-radius:var(--radius)">' +
            '<div style="font-size:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.5px">Total Revenue</div>' +
            '<div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--bg-elevated)">' + formatMoney(b.totalRevenue) + '</div></div>' +
            
            '</div>' +
            
            // Additional Stats Row
            '<div style="display:flex;justify-content:space-between;padding:12px 0;border-top:1px solid var(--border);font-size:12px;color:var(--text-muted)">' +
            '<div><span> Loads/Month:</span> <strong style="color:var(--bg-elevated)">' + b.ordersPerMonth.toFixed(1) + '</strong></div>' +
            '<div><span> Total Fees:</span> <strong style="color:var(--amber)">' + formatMoney(b.totalBrokerFee) + '</strong></div>' +
            '</div>' +
            
            // Last Order Info
            (b.lastOrderDate ? '<div style="font-size:var(--text-xs);color:var(--text-muted);text-align:center;padding-top:8px;border-top:1px dashed var(--border)">Last order: ' + b.lastOrderDate.toLocaleDateString() + ' (' + b.daysSinceLastOrder + ' days ago)</div>' : '') +
            
            '</div>' +
            
            // Actions Footer
            '<div style="padding:12px 20px;background:var(--bg-app);border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px">' +
            '<button class="action-btn edit" onclick="openBrokerModal(' + b.id + ')">Edit</button>' +
            '<button class="action-btn delete" onclick="deleteBroker(' + b.id + ')">Delete</button>' +
            '</div></div>';
        }).join('')) +
        '</div>';
    }

    function openBrokerModal(id = null) {
      const b = id ? appData.brokers.find(x => x.id === id) : null;
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      const currentTerms = b?.payment_terms || 'NET30';
      m.innerHTML = '<div class="modal" style="max-width:400px"><div class="modal-header"><h3>' + (b ? 'Edit' : 'New') + ' Broker</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div class="form-group"><label>Broker Name</label><input id="brokerName" value="' + (b?.name || '') + '" placeholder="e.g., Central Dispatch"></div>' +
        '<div class="form-group"><label>Default Payment Terms</label><select id="brokerPaymentTerms"><option value="QUICK_PAY"' + (currentTerms === 'QUICK_PAY' ? ' selected' : '') + '>Quick Pay (3 days)</option><option value="NET7"' + (currentTerms === 'NET7' ? ' selected' : '') + '>Net 7</option><option value="NET10"' + (currentTerms === 'NET10' ? ' selected' : '') + '>Net 10</option><option value="NET15"' + (currentTerms === 'NET15' ? ' selected' : '') + '>Net 15</option><option value="NET30"' + (currentTerms === 'NET30' ? ' selected' : '') + '>Net 30</option><option value="NET45"' + (currentTerms === 'NET45' ? ' selected' : '') + '>Net 45</option><option value="NET60"' + (currentTerms === 'NET60' ? ' selected' : '') + '>Net 60</option></select></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveBroker(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    async function saveBroker(id) {
      const name = document.getElementById('brokerName').value;
      if (!name) { showToast('Broker name is required', 'error'); return; }

      const data = { name: name, payment_terms: document.getElementById('brokerPaymentTerms').value };
      
      try {
        if (id) {
          await dbUpdate('brokers', id, data);
          await logActivity('BROKER_UPDATED', { broker_id: id, broker_name: name });
        } else {
          const newBroker = await dbInsert('brokers', data);
          await logActivity('BROKER_CREATED', { broker_id: newBroker.id, broker_name: name });
        }
        document.querySelector('.modal-overlay').remove();
        showToast('Broker saved!');
        await loadAllData(true);
        renderBrokers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteBroker(id) {
      if (!confirm('Delete this broker?')) return;
      try {
        const broker = appData.brokers.find(b => b.id === id);
        await dbDelete('brokers', id);
        await logActivity('BROKER_DELETED', { broker_id: id, broker_name: broker?.name });
        showToast('Broker deleted');
        await loadAllData(true);
        renderBrokers(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }

    function renderDispatchers(c) {
      c.innerHTML = '<div class="header"><h2>Dispatchers</h2><button class="btn btn-primary" onclick="openDispModal()">+ New Dispatcher</button></div><div class="card"><div class="table-wrapper"><table><thead><tr><th>Code</th><th>Name</th><th>Cars Booked</th><th>Revenue Generated</th><th>Actions</th></tr></thead><tbody>' + (appData.dispatchers.length === 0 ? '<tr><td colspan="5" style="text-align:center;padding:40px">No dispatchers yet</td></tr>' : appData.dispatchers.map(d => { const dispOrders = appData.orders.filter(o => o.dispatcher_id === d.id); const cars = dispOrders.length; const rev = dispOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0); return '<tr><td><strong>' + d.code + '</strong></td><td>' + d.name + '</td><td>' + cars + '</td><td class="money positive">' + formatMoney(rev) + '</td><td><div class="actions"><button class="action-btn edit" onclick="openDispModal(' + d.id + ')">Edit</button><button class="action-btn delete" onclick="deleteDisp(' + d.id + ')">Del</button></div></td></tr>'; }).join('')) + '</tbody></table></div></div>';
    }

    function openDispModal(id = null) {
      const d = id ? appData.dispatchers.find(x => x.id === id) : null;
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:400px"><div class="modal-header"><h3>' + (d ? 'Edit' : 'New') + ' Dispatcher</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body"><div class="form-group"><label>Code</label><input id="dispCode" value="' + (d?.code || 'D' + (appData.dispatchers.length + 1)) + '"></div><div class="form-group"><label>Name</label><input id="dispName" value="' + (d?.name || '') + '"></div><div class="form-group"><label>Link to User Account</label><select id="dispUser"><option value="">No User Account</option>' + appData.users.map(u => '<option value="' + u.id + '"' + (d?.user_id === u.id ? ' selected' : '') + '>' + u.first_name + ' ' + u.last_name + ' (' + u.email + ')</option>').join('') + '</select></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveDisp(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    async function saveDisp(id) {
      const data = { code: document.getElementById('dispCode').value, name: document.getElementById('dispName').value, user_id: parseInt(document.getElementById('dispUser').value) || null };
      try { 
        if (id) { 
          await dbUpdate('dispatchers', id, data); 
          await logActivity('DISPATCHER_UPDATED', { dispatcher_id: id, dispatcher_name: data.name, dispatcher_code: data.code });
        } else { 
          const newDisp = await dbInsert('dispatchers', data); 
          await logActivity('DISPATCHER_CREATED', { dispatcher_id: newDisp.id, dispatcher_name: data.name, dispatcher_code: data.code });
        } 
        document.querySelector('.modal-overlay').remove(); showToast('Saved!'); await loadAllData(true); renderDispatchers(document.getElementById('main-content')); 
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteDisp(id) {
      if (!confirm('Delete?')) return;
      const disp = appData.dispatchers.find(d => d.id === id);
      try {
        await dbDelete('dispatchers', id);
        await logActivity('DISPATCHER_DELETED', { dispatcher_id: id, dispatcher_name: disp?.name });
        showToast('Deleted'); await loadAllData(true); renderDispatchers(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    // ============ DISPATCHER RANKING SECTION ============
    let dispRankPeriod = 'month';
    let dispRankMonth = new Date().getMonth() + 1;
    let dispRankYear = new Date().getFullYear();

    function getDispRankDateRange() {
      if (dispRankPeriod === 'all') return { start: null, end: null };
      if (dispRankPeriod === 'month') {
        const start = dispRankYear + '-' + String(dispRankMonth).padStart(2, '0') + '-01';
        const lastDay = new Date(dispRankYear, dispRankMonth, 0).getDate();
        const end = dispRankYear + '-' + String(dispRankMonth).padStart(2, '0') + '-' + lastDay;
        return { start, end };
      } else if (dispRankPeriod === 'q1') {
        return { start: dispRankYear + '-01-01', end: dispRankYear + '-03-31' };
      } else if (dispRankPeriod === 'q2') {
        return { start: dispRankYear + '-04-01', end: dispRankYear + '-06-30' };
      } else if (dispRankPeriod === 'q3') {
        return { start: dispRankYear + '-07-01', end: dispRankYear + '-09-30' };
      } else if (dispRankPeriod === 'q4') {
        return { start: dispRankYear + '-10-01', end: dispRankYear + '-12-31' };
      } else { // year
        return { start: dispRankYear + '-01-01', end: dispRankYear + '-12-31' };
      }
    }

    function getDispRankPeriodLabel() {
      const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      if (dispRankPeriod === 'all') return 'All Time';
      if (dispRankPeriod === 'month') return months[dispRankMonth] + ' ' + dispRankYear;
      if (dispRankPeriod === 'q1') return 'Q1 (Jan-Mar) ' + dispRankYear;
      if (dispRankPeriod === 'q2') return 'Q2 (Apr-Jun) ' + dispRankYear;
      if (dispRankPeriod === 'q3') return 'Q3 (Jul-Sep) ' + dispRankYear;
      if (dispRankPeriod === 'q4') return 'Q4 (Oct-Dec) ' + dispRankYear;
      return 'Year ' + dispRankYear;
    }

    function renderDispatcherRanking(c) {
      const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const range = getDispRankDateRange();
      
      // Filter orders by date range (use pickup_date or created_at)
      let filteredOrders = appData.orders;
      if (range.start && range.end) {
        filteredOrders = appData.orders.filter(o => {
          const orderDate = o.pickup_date || o.created_at?.split('T')[0];
          if (!orderDate) return false;
          return orderDate >= range.start && orderDate <= range.end;
        });
      }
      
      // Calculate stats for each dispatcher
      const dispStats = {};
      appData.dispatchers.forEach(d => {
        dispStats[d.id] = {
          id: d.id,
          name: d.name,
          code: d.code || '-',
          cars: 0,
          revenue: 0,
          brokerFees: 0,
          localFees: 0,
          cleanRevenue: 0,
          avgPricePerCar: 0
        };
      });
      
      // Aggregate orders by dispatcher
      filteredOrders.forEach(o => {
        if (o.dispatcher_id && dispStats[o.dispatcher_id]) {
          const rev = parseFloat(o.revenue || 0);
          const brokerFee = parseFloat(o.broker_fee || 0);
          const localFee = parseFloat(o.local_fee || 0);
          dispStats[o.dispatcher_id].cars++;
          dispStats[o.dispatcher_id].revenue += rev;
          dispStats[o.dispatcher_id].brokerFees += brokerFee;
          dispStats[o.dispatcher_id].localFees += localFee;
          dispStats[o.dispatcher_id].cleanRevenue += (rev - brokerFee - localFee);
        }
      });
      
      // Calculate averages and convert to array
      const dispArray = Object.values(dispStats).map(d => {
        d.avgPricePerCar = d.cars > 0 ? d.revenue / d.cars : 0;
        return d;
      });
      
      // Sort by cars booked (descending) for ranking
      const rankedByCars = [...dispArray].sort((a, b) => b.cars - a.cars);
      const rankedByRevenue = [...dispArray].sort((a, b) => b.revenue - a.revenue);
      const rankedByCleanRevenue = [...dispArray].sort((a, b) => b.cleanRevenue - a.cleanRevenue);
      
      // Totals
      const totalCars = dispArray.reduce((s, d) => s + d.cars, 0);
      const totalRevenue = dispArray.reduce((s, d) => s + d.revenue, 0);
      const totalCleanRevenue = dispArray.reduce((s, d) => s + d.cleanRevenue, 0);
      const avgPriceOverall = totalCars > 0 ? totalRevenue / totalCars : 0;
      
      // Find top performer
      const topDispatcher = rankedByRevenue[0];
      const bottomDispatcher = rankedByRevenue[rankedByRevenue.length - 1];
      
      // Build ranking table rows with medals
      const getMedal = (rank) => {
        if (rank === 0) return '<span style="font-size:20px"></span>';
        if (rank === 1) return '<span style="font-size:20px"></span>';
        if (rank === 2) return '<span style="font-size:20px"></span>';
        return '<span style="color:var(--text-muted);font-weight:700">#' + (rank + 1) + '</span>';
      };
      
      const getProgressBar = (value, max, color) => {
        const percent = max > 0 ? (value / max * 100) : 0;
        return '<div style="background:rgba(255,255,255,0.1);border-radius:4px;height:8px;width:100%;min-width:60px"><div style="background:' + color + ';height:100%;border-radius:4px;width:' + percent + '%"></div></div>';
      };
      
      const maxCars = Math.max(...dispArray.map(d => d.cars), 1);
      const maxRevenue = Math.max(...dispArray.map(d => d.revenue), 1);
      
      c.innerHTML = '<div class="header"><h2> Dispatcher Performance Ranking</h2></div>' +
        
        // Period selector
        '<div class="card" style="padding:16px;margin-bottom:24px"><div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">' +
        '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Period</label><select id="dispRankPeriod" onchange="dispRankPeriod=this.value;renderDispatcherRanking(document.getElementById(\'main-content\'))"><option value="all"' + (dispRankPeriod === 'all' ? ' selected' : '') + '>All Time</option><option value="month"' + (dispRankPeriod === 'month' ? ' selected' : '') + '>Monthly</option><option value="q1"' + (dispRankPeriod === 'q1' ? ' selected' : '') + '>Q1 (Jan-Mar)</option><option value="q2"' + (dispRankPeriod === 'q2' ? ' selected' : '') + '>Q2 (Apr-Jun)</option><option value="q3"' + (dispRankPeriod === 'q3' ? ' selected' : '') + '>Q3 (Jul-Sep)</option><option value="q4"' + (dispRankPeriod === 'q4' ? ' selected' : '') + '>Q4 (Oct-Dec)</option><option value="year"' + (dispRankPeriod === 'year' ? ' selected' : '') + '>Full Year</option></select></div>' +
        (dispRankPeriod === 'month' ? '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Month</label><select id="dispRankMonth" onchange="dispRankMonth=parseInt(this.value);renderDispatcherRanking(document.getElementById(\'main-content\'))">' + months.slice(1).map((m, i) => '<option value="' + (i+1) + '"' + (dispRankMonth === i+1 ? ' selected' : '') + '>' + m + '</option>').join('') + '</select></div>' : '') +
        (dispRankPeriod !== 'all' ? '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Year</label><select id="dispRankYear" onchange="dispRankYear=parseInt(this.value);renderDispatcherRanking(document.getElementById(\'main-content\'))"><option value="2024"' + (dispRankYear === 2024 ? ' selected' : '') + '>2024</option><option value="2025"' + (dispRankYear === 2025 ? ' selected' : '') + '>2025</option><option value="2026"' + (dispRankYear === 2026 ? ' selected' : '') + '>2026</option><option value="2027"' + (dispRankYear === 2027 ? ' selected' : '') + '>2027</option></select></div>' : '') +
        '<div style="margin-left:auto;font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--blue)"> ' + getDispRankPeriodLabel() + '</div></div></div>' +
        
        // Summary stats
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:12px 16px"><div class="label">Total Dispatchers</div><div class="value">' + appData.dispatchers.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:12px 16px"><div class="label">Total Cars Booked</div><div class="value">' + totalCars + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px"><div class="label">Total Revenue</div><div class="value">' + formatMoney(totalRevenue) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px;background:rgba(59,130,246,0.15);border:1px solid rgba(59,130,246,0.3)"><div class="label">Clean Revenue</div><div class="value" style="color:var(--blue)">' + formatMoney(totalCleanRevenue) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Avg Price/Car</div><div class="value">' + formatMoney(avgPriceOverall) + '</div></div>' +
        '</div>' +
        
        // Top & Bottom performers cards
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:24px">' +
        '<div class="card" style="padding:20px;border-left:4px solid var(--green)">' +
        '<div style="display:flex;align-items:center;gap:12px"><span style="font-size:32px"></span><div><div style="font-size:12px;color:var(--text-muted)">TOP PERFORMER</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--primary-400)">' + (topDispatcher?.name || '-') + '</div></div></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px">' +
        '<div style="background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:11px;color:var(--primary-400)">Cars</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--primary-400)">' + (topDispatcher?.cars || 0) + '</div></div>' +
        '<div style="background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:11px;color:var(--primary-400)">Revenue</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--primary-400)">' + formatMoney(topDispatcher?.revenue || 0) + '</div></div>' +
        '</div></div>' +
        
        '<div class="card" style="padding:20px;border-left:4px solid var(--amber)">' +
        '<div style="display:flex;align-items:center;gap:12px"><span style="font-size:32px"></span><div><div style="font-size:12px;color:var(--text-muted)">NEEDS IMPROVEMENT</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--amber)">' + (bottomDispatcher?.name || '-') + '</div></div></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px">' +
        '<div style="background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.3);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:11px;color:var(--amber)">Cars</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--amber)">' + (bottomDispatcher?.cars || 0) + '</div></div>' +
        '<div style="background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.3);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:11px;color:var(--amber)">Revenue</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--amber)">' + formatMoney(bottomDispatcher?.revenue || 0) + '</div></div>' +
        '</div></div>' +
        '</div>' +
        
        // Full ranking table
        '<div class="card"><div class="card-header"><h3> Full Ranking (by Revenue)</h3></div><div class="table-wrapper"><table><thead><tr><th style="width:60px">Rank</th><th>Dispatcher</th><th style="text-align:center">Cars Booked</th><th style="text-align:center">Cars Progress</th><th style="text-align:right">Revenue</th><th style="text-align:center">Revenue Progress</th><th style="text-align:right">Broker Fees</th><th style="text-align:right">Local Fees</th><th style="text-align:right">Clean Revenue</th><th style="text-align:right">Avg $/Car</th></tr></thead><tbody>' +
        (rankedByRevenue.length === 0 ? '<tr><td colspan="10" style="text-align:center;padding:40px">No dispatcher data for this period</td></tr>' :
        rankedByRevenue.map((d, i) =>
          '<tr style="' + (i === 0 ? 'background:rgba(34,197,94,0.1)' : i === rankedByRevenue.length - 1 && rankedByRevenue.length > 1 ? 'background:rgba(245,158,11,0.1)' : '') + '">' +
          '<td style="text-align:center">' + getMedal(i) + '</td>' +
          '<td><strong>' + d.name + '</strong><span style="color:var(--text-muted);margin-left:8px;font-size:12px">' + d.code + '</span></td>' +
          '<td style="text-align:center;font-weight:600">' + d.cars + '</td>' +
          '<td>' + getProgressBar(d.cars, maxCars, 'var(--blue)') + '</td>' +
          '<td style="text-align:right" class="money">' + formatMoney(d.revenue) + '</td>' +
          '<td>' + getProgressBar(d.revenue, maxRevenue, 'var(--green)') + '</td>' +
          '<td style="text-align:right" class="money negative">' + formatMoney(d.brokerFees) + '</td>' +
          '<td style="text-align:right" class="money negative">' + formatMoney(d.localFees) + '</td>' +
          '<td style="text-align:right;font-weight:600;color:var(--blue)">' + formatMoney(d.cleanRevenue) + '</td>' +
          '<td style="text-align:right">' + formatMoney(d.avgPricePerCar) + '</td>' +
          '</tr>'
        ).join('')) +
        '<tr style="background:rgba(255,255,255,0.05);font-weight:700"><td colspan="2" style="text-align:right">TOTALS:</td><td style="text-align:center">' + totalCars + '</td><td></td><td style="text-align:right">' + formatMoney(totalRevenue) + '</td><td></td><td style="text-align:right;color:var(--red)">' + formatMoney(dispArray.reduce((s,d) => s + d.brokerFees, 0)) + '</td><td style="text-align:right;color:var(--red)">' + formatMoney(dispArray.reduce((s,d) => s + d.localFees, 0)) + '</td><td style="text-align:right;color:var(--blue)">' + formatMoney(totalCleanRevenue) + '</td><td style="text-align:right">' + formatMoney(avgPriceOverall) + '</td></tr>' +
        '</tbody></table></div></div>' +
        
        // Visual comparison cards
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:24px">' +
        
        // Cars leaderboard
        '<div class="card" style="padding:20px"><h3 style="margin-bottom:16px;color:var(--blue)"> Cars Booked Leaderboard</h3>' +
        rankedByCards(rankedByRevenue.slice(0, 5).map((d, i) => ({
          rank: i,
          name: d.name,
          value: d.cars,
          label: d.cars + ' cars',
          percent: maxCars > 0 ? (d.cars / maxCars * 100) : 0,
          color: 'var(--blue)'
        }))) + '</div>' +
        
        // Revenue leaderboard
        '<div class="card" style="padding:20px"><h3 style="margin-bottom:16px;color:var(--green)"> Revenue Leaderboard</h3>' +
        rankedByCards(rankedByRevenue.slice(0, 5).map((d, i) => ({
          rank: i,
          name: d.name,
          value: d.revenue,
          label: formatMoney(d.revenue),
          percent: maxRevenue > 0 ? (d.revenue / maxRevenue * 100) : 0,
          color: 'var(--green)'
        }))) + '</div>' +
        '</div>';
    }
    
    function rankedByCards(items) {
      const getMedal = (rank) => {
        if (rank === 0) return '';
        if (rank === 1) return '';
        if (rank === 2) return '';
        return '#' + (rank + 1);
      };
      
      return items.map(item => 
        '<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">' +
        '<span style="font-size:16px;width:30px">' + getMedal(item.rank) + '</span>' +
        '<div style="flex:1"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-weight:600">' + item.name + '</span><span style="color:var(--text-muted)">' + item.label + '</span></div>' +
        '<div style="background:rgba(255,255,255,0.1);border-radius:4px;height:8px"><div style="background:' + item.color + ';height:100%;border-radius:4px;width:' + item.percent + '%"></div></div></div></div>'
      ).join('');
    }

    // ============ FUEL TRACKING SECTION ============
    let fuelPeriod = 'month'; // 'month', 'q1', 'q2', 'q3', 'q4', 'year'
    let fuelAnalyticsTab = 'overview'; // 'overview', 'analytics', 'efficiency', 'prices'
    let fuelMonth = new Date().getMonth() + 1;
    let fuelYear = new Date().getFullYear();

    function getFuelDateRange() {
      if (fuelPeriod === 'month') {
        const start = fuelYear + '-' + String(fuelMonth).padStart(2, '0') + '-01';
        const lastDay = new Date(fuelYear, fuelMonth, 0).getDate();
        const end = fuelYear + '-' + String(fuelMonth).padStart(2, '0') + '-' + lastDay;
        return { start, end };
      } else if (fuelPeriod === 'q1') {
        return { start: fuelYear + '-01-01', end: fuelYear + '-03-31' };
      } else if (fuelPeriod === 'q2') {
        return { start: fuelYear + '-04-01', end: fuelYear + '-06-30' };
      } else if (fuelPeriod === 'q3') {
        return { start: fuelYear + '-07-01', end: fuelYear + '-09-30' };
      } else if (fuelPeriod === 'q4') {
        return { start: fuelYear + '-10-01', end: fuelYear + '-12-31' };
      } else { // year
        return { start: fuelYear + '-01-01', end: fuelYear + '-12-31' };
      }
    }

    function getFuelPeriodLabel() {
      const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      if (fuelPeriod === 'month') return months[fuelMonth] + ' ' + fuelYear;
      if (fuelPeriod === 'q1') return 'Q1 (Jan-Mar) ' + fuelYear;
      if (fuelPeriod === 'q2') return 'Q2 (Apr-Jun) ' + fuelYear;
      if (fuelPeriod === 'q3') return 'Q3 (Jul-Sep) ' + fuelYear;
      if (fuelPeriod === 'q4') return 'Q4 (Oct-Dec) ' + fuelYear;
      return 'Year ' + fuelYear;
    }

    // Fuel tracking filter variables
    let selectedFuelTruck = null;
    let fuelFilterTruck = '';
    let fuelFilterState = '';
    let fuelFilterProduct = '';
    let fuelFilterDriver = '';
    
    function clearFuelFilters() {
      fuelFilterTruck = '';
      fuelFilterState = '';
      fuelFilterProduct = '';
      fuelFilterDriver = '';
      selectedFuelTruck = null;
      renderFuelTracking(document.getElementById('main-content'));
    }
    
    function renderFuelTracking(c) {
      const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const range = getFuelDateRange();
      
      // Get all transactions for the period (before filters) for dropdown options
      const periodTxns = (appData.fuel_transactions || []).filter(t => {
        if (!t.transaction_date) return false;
        const d = t.transaction_date;
        return d >= range.start && d <= range.end;
      });
      
      // Get unique values for filter dropdowns
      const uniqueTrucks = [...new Set(periodTxns.map(t => t.truck_number).filter(Boolean))].sort((a, b) => a - b);
      const uniqueStates = [...new Set(periodTxns.map(t => t.state).filter(Boolean))].sort();
      const uniqueProducts = [...new Set(periodTxns.map(t => t.product).filter(t => t !== 'Txn Fee'))];
      const uniqueDrivers = [...new Set(periodTxns.map(t => t.driver_name).filter(Boolean))].sort();
      
      // Apply all filters
      let filteredTxns = periodTxns;
      
      // Apply truck filter (either from dropdown or drill-down)
      if (selectedFuelTruck) {
        filteredTxns = filteredTxns.filter(t => t.truck_number == selectedFuelTruck);
      } else if (fuelFilterTruck) {
        filteredTxns = filteredTxns.filter(t => t.truck_number == fuelFilterTruck);
      }
      
      // Apply state filter
      if (fuelFilterState) {
        filteredTxns = filteredTxns.filter(t => t.state === fuelFilterState);
      }
      
      // Apply product filter
      if (fuelFilterProduct) {
        filteredTxns = filteredTxns.filter(t => t.product === fuelFilterProduct);
      }
      
      // Apply driver filter
      if (fuelFilterDriver) {
        filteredTxns = filteredTxns.filter(t => t.driver_name === fuelFilterDriver);
      }
      
      // Check if any filters are active
      const hasActiveFilters = fuelFilterTruck || fuelFilterState || fuelFilterProduct || fuelFilterDriver || selectedFuelTruck;
      
      // Calculate stats
      const dieselTxns = filteredTxns.filter(t => t.product === 'ULSD');
      const defTxns = filteredTxns.filter(t => t.product === 'DEF');
      const feeTxns = filteredTxns.filter(t => t.product === 'Txn Fee');
      
      const totalDieselGal = dieselTxns.reduce((s, t) => s + parseFloat(t.gallons || 0), 0);
      const totalDieselCost = dieselTxns.reduce((s, t) => s + parseFloat(t.amount || 0), 0);
      const totalDefGal = defTxns.reduce((s, t) => s + parseFloat(t.gallons || 0), 0);
      const totalDefCost = defTxns.reduce((s, t) => s + parseFloat(t.amount || 0), 0);
      const totalFees = feeTxns.reduce((s, t) => s + parseFloat(t.amount || 0), 0);
      const totalSavings = filteredTxns.reduce((s, t) => s + parseFloat(t.savings || 0), 0);
      const avgPricePerGal = totalDieselGal > 0 ? totalDieselCost / totalDieselGal : 0;
      const avgDiscountPerGal = totalDieselGal > 0 ? (totalSavings / totalDieselGal) * 100 : 0;
      const totalCost = totalDieselCost + totalDefCost + totalFees;
      
      // Calculate miles for the period (from trips)
      // Get fleet miles - prefer Samsara data, fallback to trip miles
      let periodMiles = 0;
      let milesSource = 'trips'; // 'samsara' or 'trips'
      const activeTruckFilter = selectedFuelTruck || fuelFilterTruck;

      if (activeTruckFilter) {
        // Single truck - check Samsara data first
        const samsaraTruckData = getFleetMilesByTruck();
        if (samsaraTruckData && samsaraTruckData[activeTruckFilter]) {
          periodMiles = samsaraTruckData[activeTruckFilter].distance;
          milesSource = 'samsara';
        } else {
          // Fall back to trip miles for this truck
          const truck = appData.trucks.find(tr => tr.truck_number == activeTruckFilter);
          if (truck) {
            const truckTrips = appData.trips.filter(t => t.truck_id === truck.id && t.trip_date >= range.start && t.trip_date <= range.end);
            periodMiles = truckTrips.reduce((s, t) => s + parseFloat(t.miles || 0), 0);
          }
        }
      } else {
        // All trucks - use getFleetMiles()
        const fleetMilesResult = getFleetMiles(range.start, range.end);
        periodMiles = fleetMilesResult.miles;
        milesSource = fleetMilesResult.source;
      }
      
      const mpg = periodMiles > 0 && totalDieselGal > 0 ? periodMiles / totalDieselGal : 0;
      const costPerMile = periodMiles > 0 ? totalDieselCost / periodMiles : 0;
      const fillUps = dieselTxns.length;
      const avgGallonsPerFillUp = fillUps > 0 ? totalDieselGal / fillUps : 0;
      
      // Group by truck
      const truckStats = {};
      (appData.fuel_transactions || []).filter(t => {
        if (!t.transaction_date) return false;
        const d = t.transaction_date;
        return d >= range.start && d <= range.end;
      }).forEach(t => {
        if (!truckStats[t.truck_number]) truckStats[t.truck_number] = { diesel: 0, def: 0, cost: 0, savings: 0, fillUps: 0 };
        if (t.product === 'ULSD') { 
          truckStats[t.truck_number].diesel += parseFloat(t.gallons || 0); 
          truckStats[t.truck_number].cost += parseFloat(t.amount || 0); 
          truckStats[t.truck_number].fillUps++;
        }
        if (t.product === 'DEF') { 
          truckStats[t.truck_number].def += parseFloat(t.gallons || 0); 
          truckStats[t.truck_number].cost += parseFloat(t.amount || 0); 
        }
        truckStats[t.truck_number].savings += parseFloat(t.savings || 0);
      });
      
      // Calculate miles per truck - prefer Samsara data
      const samsaraTruckMiles = getFleetMilesByTruck();
      Object.keys(truckStats).forEach(tn => {
        // Check Samsara data first
        if (samsaraTruckMiles && samsaraTruckMiles[tn]) {
          truckStats[tn].miles = samsaraTruckMiles[tn].distance;
          truckStats[tn].milesSource = 'samsara';
        } else {
          // Fall back to trip miles
          const truck = appData.trucks.find(t => t.truck_number == tn);
          if (truck) {
            const truckTrips = appData.trips.filter(t => t.truck_id === truck.id && t.trip_date >= range.start && t.trip_date <= range.end);
            truckStats[tn].miles = truckTrips.reduce((s, t) => s + parseFloat(t.miles || 0), 0);
          }
          truckStats[tn].milesSource = 'trips';
        }
        truckStats[tn].mpg = truckStats[tn].miles > 0 && truckStats[tn].diesel > 0 ? truckStats[tn].miles / truckStats[tn].diesel : 0;
        truckStats[tn].costPerMile = truckStats[tn].miles > 0 ? truckStats[tn].cost / truckStats[tn].miles : 0;
      });
      
      // Group by state
      const stateStats = {};
      filteredTxns.filter(t => t.product === 'ULSD').forEach(t => {
        if (!stateStats[t.state]) stateStats[t.state] = { gallons: 0, cost: 0, fillUps: 0 };
        stateStats[t.state].gallons += parseFloat(t.gallons || 0);
        stateStats[t.state].cost += parseFloat(t.amount || 0);
        stateStats[t.state].fillUps++;
      });
      
      // Top locations
      const locationStats = {};
      filteredTxns.filter(t => t.product === 'ULSD').forEach(t => {
        const loc = t.location || 'Unknown';
        if (!locationStats[loc]) locationStats[loc] = { gallons: 0, cost: 0, visits: 0, city: t.city, state: t.state };
        locationStats[loc].gallons += parseFloat(t.gallons || 0);
        locationStats[loc].cost += parseFloat(t.amount || 0);
        locationStats[loc].visits++;
      });
      const topLocations = Object.entries(locationStats)
        .sort((a, b) => b[1].visits - a[1].visits)
        .slice(0, 5);
      
      // Monthly trend (for yearly view)
      const monthlyTrend = {};
      if (fuelPeriod === 'year' || fuelPeriod.startsWith('q')) {
        filteredTxns.filter(t => t.product === 'ULSD').forEach(t => {
          const month = t.transaction_date.substring(0, 7);
          if (!monthlyTrend[month]) monthlyTrend[month] = { gallons: 0, cost: 0, fillUps: 0 };
          monthlyTrend[month].gallons += parseFloat(t.gallons || 0);
          monthlyTrend[month].cost += parseFloat(t.amount || 0);
          monthlyTrend[month].fillUps++;
        });
      }
      
      // Build header with filter indicator
      let filterLabel = '';
      if (selectedFuelTruck) filterLabel = ' - Truck #' + selectedFuelTruck;
      else if (hasActiveFilters) filterLabel = ' (Filtered)';
      
      let headerContent = '<div class="header"><h2> Fuel Tracking' + filterLabel + '</h2><div style="display:flex;gap:12px">';
      if (selectedFuelTruck) {
        headerContent += '<button class="btn btn-secondary" onclick="selectedFuelTruck=null;renderFuelTracking(document.getElementById(\'main-content\'))"> Back to All Trucks</button>';
      }
      headerContent += '<button class="btn btn-primary" onclick="openFuelUploadModal()"> Fuel Report</button>';
      headerContent += '<button class="btn" onclick="openFleetMileageModal()" style="background:var(--blue);color:white;border:none"> Samsara Mileage</button>';
      if (filteredTxns.length > 0 && !selectedFuelTruck) {
        headerContent += '<button class="btn btn-secondary" style="background:var(--red-dim);color:var(--red);border-color:var(--red-dim)" onclick="deletePeriodFuelData()"> Delete Period Data</button>';
      }
      headerContent += '</div></div>';
      
      c.innerHTML = headerContent +
        
        // Period selector and Filters
        '<div class="card" style="padding:16px;margin-bottom:24px">' +
        '<div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin-bottom:16px">' +
        '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Period</label><select id="fuelPeriod" onchange="fuelPeriod=this.value;renderFuelTracking(document.getElementById(\'main-content\'))"><option value="month"' + (fuelPeriod === 'month' ? ' selected' : '') + '>Monthly</option><option value="q1"' + (fuelPeriod === 'q1' ? ' selected' : '') + '>Q1 (Jan-Mar)</option><option value="q2"' + (fuelPeriod === 'q2' ? ' selected' : '') + '>Q2 (Apr-Jun)</option><option value="q3"' + (fuelPeriod === 'q3' ? ' selected' : '') + '>Q3 (Jul-Sep)</option><option value="q4"' + (fuelPeriod === 'q4' ? ' selected' : '') + '>Q4 (Oct-Dec)</option><option value="year"' + (fuelPeriod === 'year' ? ' selected' : '') + '>Full Year</option></select></div>' +
        (fuelPeriod === 'month' ? '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Month</label><select id="fuelMonth" onchange="fuelMonth=parseInt(this.value);renderFuelTracking(document.getElementById(\'main-content\'))">' + months.slice(1).map((m, i) => '<option value="' + (i+1) + '"' + (fuelMonth === i+1 ? ' selected' : '') + '>' + m + '</option>').join('') + '</select></div>' : '') +
        '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Year</label><select id="fuelYear" onchange="fuelYear=parseInt(this.value);renderFuelTracking(document.getElementById(\'main-content\'))"><option value="2024"' + (fuelYear === 2024 ? ' selected' : '') + '>2024</option><option value="2025"' + (fuelYear === 2025 ? ' selected' : '') + '>2025</option><option value="2026"' + (fuelYear === 2026 ? ' selected' : '') + '>2026</option><option value="2027"' + (fuelYear === 2027 ? ' selected' : '') + '>2027</option></select></div>' +
        '<div style="margin-left:auto;font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--blue)"> ' + getFuelPeriodLabel() + '</div></div>' +
        
        // Filter row
        '<div style="display:flex;gap:12px;align-items:end;flex-wrap:wrap;padding-top:16px;border-top:1px solid var(--border)">' +
        '<div style="font-weight:600;color:var(--text-secondary);display:flex;align-items:center;gap:6px"><span></span> Filters:</div>' +
        '<div class="form-group" style="margin:0;min-width:120px"><label style="margin-bottom:4px;font-size:12px">Truck</label><select onchange="fuelFilterTruck=this.value;selectedFuelTruck=null;renderFuelTracking(document.getElementById(\'main-content\'))" style="padding:6px 10px"><option value="">All Trucks</option>' + 
        uniqueTrucks.map(tn => '<option value="' + tn + '"' + (fuelFilterTruck == tn ? ' selected' : '') + '>#' + tn + '</option>').join('') + '</select></div>' +
        '<div class="form-group" style="margin:0;min-width:100px"><label style="margin-bottom:4px;font-size:12px">State</label><select onchange="fuelFilterState=this.value;renderFuelTracking(document.getElementById(\'main-content\'))" style="padding:6px 10px"><option value="">All States</option>' + 
        uniqueStates.map(st => '<option value="' + st + '"' + (fuelFilterState === st ? ' selected' : '') + '>' + st + '</option>').join('') + '</select></div>' +
        '<div class="form-group" style="margin:0;min-width:100px"><label style="margin-bottom:4px;font-size:12px">Product</label><select onchange="fuelFilterProduct=this.value;renderFuelTracking(document.getElementById(\'main-content\'))" style="padding:6px 10px"><option value="">All Products</option>' + 
        uniqueProducts.map(p => '<option value="' + p + '"' + (fuelFilterProduct === p ? ' selected' : '') + '>' + p + '</option>').join('') + '</select></div>' +
        '<div class="form-group" style="margin:0;min-width:140px"><label style="margin-bottom:4px;font-size:12px">Driver</label><select onchange="fuelFilterDriver=this.value;renderFuelTracking(document.getElementById(\'main-content\'))" style="padding:6px 10px"><option value="">All Drivers</option>' + 
        uniqueDrivers.map(d => '<option value="' + d + '"' + (fuelFilterDriver === d ? ' selected' : '') + '>' + d + '</option>').join('') + '</select></div>' +
        (hasActiveFilters ? '<button class="btn btn-secondary" style="padding:6px 12px;font-size:13px" onclick="clearFuelFilters()"> Clear Filters</button>' : '') +
        '<div style="margin-left:auto;font-size:13px;color:var(--text-muted)">' + filteredTxns.length + ' of ' + periodTxns.length + ' transactions</div>' +
        '</div></div>' +
        
        // Analytics Tabs
        '<div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap">' +
        '<button class="btn ' + (fuelAnalyticsTab === 'overview' ? 'btn-primary' : 'btn-secondary') + '" onclick="fuelAnalyticsTab=\'overview\';renderFuelTracking(document.getElementById(\'main-content\'))"> Overview</button>' +
        '<button class="btn ' + (fuelAnalyticsTab === 'analytics' ? 'btn-primary' : 'btn-secondary') + '" onclick="fuelAnalyticsTab=\'analytics\';renderFuelTracking(document.getElementById(\'main-content\'))"> Analytics</button>' +
        '<button class="btn ' + (fuelAnalyticsTab === 'efficiency' ? 'btn-primary' : 'btn-secondary') + '" onclick="fuelAnalyticsTab=\'efficiency\';renderFuelTracking(document.getElementById(\'main-content\'))"> Efficiency</button>' +
        '<button class="btn ' + (fuelAnalyticsTab === 'prices' ? 'btn-primary' : 'btn-secondary') + '" onclick="fuelAnalyticsTab=\'prices\';renderFuelTracking(document.getElementById(\'main-content\'))"> Price Analysis</button>' +
        '</div>' +
        
        // Tab Content
        (fuelAnalyticsTab === 'overview' ? (
        // Fleet Mileage Status Card (if data uploaded)
        (fleetMileageData.length > 0 ?
        '<div class="card" style="margin-bottom:20px;padding:16px;background:linear-gradient(135deg,var(--blue-dim) 0%,var(--blue-dim) 100%);border:1px solid var(--blue-dim)">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">' +
        '<div>' +
        '<div style="font-size:14px;font-weight:700;color:var(--blue);margin-bottom:4px"> Samsara Fleet Mileage Loaded</div>' +
        '<div style="font-size:13px;color:var(--blue)">' + fleetMileageData.length + ' trucks  ' + fleetMileageData.reduce((s,t) => s + t.distance, 0).toLocaleString(undefined, {maximumFractionDigits: 0}) + ' total miles</div>' +
        '<div style="font-size:11px;color:var(--blue);margin-top:2px">Period: ' + fleetMileagePeriod.start + ' to ' + fleetMileagePeriod.end + '</div>' +
        '</div>' +
        '<button onclick="clearFleetMileage()" class="btn btn-secondary" style="background:var(--red-dim);color:var(--red);border-color:var(--red-dim);padding:6px 12px;font-size:12px"> Clear</button>' +
        '</div></div>' : '') +

        // PRIMARY STATS CARDS - OVERVIEW TAB
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="padding:16px;border-left:4px solid var(--amber)"><div class="label">Total Diesel</div><div class="value" style="font-size:20px">' + totalDieselGal.toFixed(1) + ' gal</div></div>' +
        '<div class="stat-card" style="padding:16px;border-left:4px solid var(--red)"><div class="label">Diesel Cost</div><div class="value" style="font-size:20px;color:var(--red)">' + formatMoney(totalDieselCost) + '</div></div>' +
        '<div class="stat-card" style="padding:16px;border-left:4px solid var(--purple)"><div class="label">Avg $/Gallon</div><div class="value" style="font-size:20px">' + formatMoney(avgPricePerGal) + '</div></div>' +
        '<div class="stat-card" style="padding:16px;border-left:4px solid var(--green);background:var(--green-dim)"><div class="label">Total Savings</div><div class="value" style="font-size:20px;color:var(--green)">' + formatMoney(totalSavings) + '</div></div>' +
        '<div class="stat-card" style="padding:16px;border-left:4px solid var(--blue)"><div class="label">Total DEF</div><div class="value" style="font-size:20px">' + totalDefGal.toFixed(1) + ' gal</div></div>' +
        '<div class="stat-card" style="padding:16px;border-left:4px solid var(--text-secondary);background:var(--red-dim)"><div class="label">Total Cost</div><div class="value" style="font-size:20px;color:var(--red)">' + formatMoney(totalCost) + '</div></div>' +
        '</div>' +
        
        // Efficiency metrics
        '<div class="card" style="margin-bottom:24px;padding:20px">' +
        '<h3 style="margin-bottom:16px;color:var(--purple);border-bottom:2px solid var(--purple);padding-bottom:8px"> EFFICIENCY METRICS</h3>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px">' +
        '<div style="background:' + (milesSource === 'samsara' ? 'var(--blue-dim)' : 'var(--bg-app)') + ';padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:12px;color:var(--text-muted)">Miles Traveled</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold)">' + periodMiles.toLocaleString() + '</div>' + (milesSource === 'samsara' ? '<div style="font-size:10px;color:var(--blue);margin-top:4px"> Samsara</div>' : '<div style="font-size:10px;color:var(--text-muted);margin-top:4px"> Trip Data</div>') + '</div>' +
        '<div style="background:' + (mpg >= 6 ? 'var(--green-dim)' : mpg >= 5 ? 'var(--amber-dim)' : 'var(--red-dim)') + ';padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:12px;color:var(--text-muted)">Fuel Economy (MPG)</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:' + (mpg >= 6 ? 'var(--green)' : mpg >= 5 ? 'var(--amber)' : 'var(--red)') + '">' + mpg.toFixed(2) + '</div></div>' +
        '<div style="background:var(--bg-app);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:12px;color:var(--text-muted)">Cost Per Mile</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--red)">' + formatMoney(costPerMile) + '</div></div>' +
        '<div style="background:var(--bg-app);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:12px;color:var(--text-muted)">Fill-Ups</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold)">' + fillUps + '</div></div>' +
        '<div style="background:var(--bg-app);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:12px;color:var(--text-muted)">Avg Gal/Fill-Up</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold)">' + avgGallonsPerFillUp.toFixed(1) + '</div></div>' +
        '<div style="background:var(--blue-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:12px;color:var(--blue)">Avg Discount/Gal</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--blue)">' + avgDiscountPerGal.toFixed(1) + '</div></div>' +
        '</div></div>' +
        
        // Two column layout for insights
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px;margin-bottom:24px">' +
        
        // By Truck summary (clickable) - only show if not viewing specific truck
        (selectedFuelTruck ? '' : 
        '<div class="card"><div class="card-header"><h3> By Truck (click for details)</h3></div><div class="table-wrapper"><table><thead><tr><th>Truck</th><th>Diesel</th><th>MPG</th><th>$/Mile</th><th>Cost</th></tr></thead><tbody>' +
        (Object.keys(truckStats).length === 0 ? '<tr><td colspan="5" style="text-align:center;padding:20px">No fuel data</td></tr>' :
        Object.keys(truckStats).sort((a, b) => truckStats[b].cost - truckStats[a].cost).map(tn => 
          '<tr style="cursor:pointer" onclick="selectedFuelTruck=\'' + tn + '\';renderFuelTracking(document.getElementById(\'main-content\'))">' +
          '<td><strong style="color:var(--blue)">#' + tn + '</strong></td>' +
          '<td>' + truckStats[tn].diesel.toFixed(0) + ' gal</td>' +
          '<td style="color:' + (truckStats[tn].mpg >= 6 ? 'var(--green)' : truckStats[tn].mpg >= 5 ? 'var(--amber)' : 'var(--red)') + ';font-weight:600">' + truckStats[tn].mpg.toFixed(2) + '</td>' +
          '<td class="money">' + formatMoney(truckStats[tn].costPerMile) + '</td>' +
          '<td class="money">' + formatMoney(truckStats[tn].cost) + '</td>' +
          '</tr>'
        ).join('')) +
        '</tbody></table></div></div>') +
        
        // By State
        '<div class="card"><div class="card-header"><h3> By State</h3></div><div class="table-wrapper"><table><thead><tr><th>State</th><th>Gallons</th><th>Avg $/Gal</th><th>Cost</th></tr></thead><tbody>' +
        (Object.keys(stateStats).length === 0 ? '<tr><td colspan="4" style="text-align:center;padding:20px">No data</td></tr>' :
        Object.keys(stateStats).sort((a, b) => stateStats[b].gallons - stateStats[a].gallons).map(st => 
          '<tr><td><strong>' + st + '</strong></td>' +
          '<td>' + stateStats[st].gallons.toFixed(1) + '</td>' +
          '<td class="money">' + formatMoney(stateStats[st].cost / stateStats[st].gallons) + '</td>' +
          '<td class="money">' + formatMoney(stateStats[st].cost) + '</td></tr>'
        ).join('')) +
        '</tbody></table></div></div>' +
        
        // Top Locations
        '<div class="card"><div class="card-header"><h3> Top Fuel Stops</h3></div><div class="table-wrapper"><table><thead><tr><th>Location</th><th>Visits</th><th>Gallons</th><th>Cost</th></tr></thead><tbody>' +
        (topLocations.length === 0 ? '<tr><td colspan="4" style="text-align:center;padding:20px">No data</td></tr>' :
        topLocations.map(([loc, data]) => 
          '<tr><td><strong>' + loc + '</strong><br><span style="font-size:var(--text-xs);color:var(--text-muted)">' + data.city + ', ' + data.state + '</span></td>' +
          '<td>' + data.visits + '</td>' +
          '<td>' + data.gallons.toFixed(1) + '</td>' +
          '<td class="money">' + formatMoney(data.cost) + '</td></tr>'
        ).join('')) +
        '</tbody></table></div></div>' +
        
        '</div>' +
        
        // Monthly Trend (for quarterly/yearly views)
        (Object.keys(monthlyTrend).length > 1 ? 
        '<div class="card" style="margin-bottom:24px"><div class="card-header"><h3> Monthly Trend</h3></div><div class="table-wrapper"><table><thead><tr><th>Month</th><th>Fill-Ups</th><th>Gallons</th><th>Cost</th><th>Avg $/Gal</th></tr></thead><tbody>' +
        Object.keys(monthlyTrend).sort().map(month => {
          const data = monthlyTrend[month];
          const avgPrice = data.gallons > 0 ? data.cost / data.gallons : 0;
          return '<tr><td><strong>' + month + '</strong></td>' +
            '<td>' + data.fillUps + '</td>' +
            '<td>' + data.gallons.toFixed(1) + '</td>' +
            '<td class="money">' + formatMoney(data.cost) + '</td>' +
            '<td class="money">' + formatMoney(avgPrice) + '</td></tr>';
        }).join('') +
        '</tbody></table></div></div>' : '') +
        
        // Transactions table
        '<div class="card"><div class="card-header"><h3> Transactions (' + filteredTxns.filter(t => t.product !== 'Txn Fee').length + ')</h3></div><div class="table-wrapper"><table><thead><tr><th>Date</th><th>Truck</th><th>Driver</th><th>Location</th><th>Product</th><th>Gallons</th><th>Amount</th><th>Savings</th></tr></thead><tbody>' +
        (filteredTxns.filter(t => t.product !== 'Txn Fee').length === 0 ? '<tr><td colspan="8" style="text-align:center;padding:40px">No transactions. Upload a fuel report to get started!</td></tr>' :
        filteredTxns.filter(t => t.product !== 'Txn Fee').map(t => '<tr><td>' + formatDate(t.transaction_date) + '</td><td><strong>#' + t.truck_number + '</strong></td><td>' + (t.driver_name || '-') + '</td><td>' + t.city + ', ' + t.state + '<br><span style="font-size:var(--text-xs);color:var(--text-muted)">' + t.location + '</span></td><td><span class="badge ' + (t.product === 'ULSD' ? 'badge-amber' : 'badge-blue') + '">' + t.product + '</span></td><td>' + parseFloat(t.gallons || 0).toFixed(2) + '</td><td class="money">' + formatMoney(t.amount) + '</td><td class="money positive">' + formatMoney(t.savings || 0) + '</td></tr>').join('')) +
        '</tbody></table></div></div>'
        ) : '') + // End overview tab
        
        // ANALYTICS TAB
        (fuelAnalyticsTab === 'analytics' ? renderFuelAnalyticsTab(filteredTxns, periodTxns, truckStats, stateStats, range) : '') +
        
        // EFFICIENCY TAB
        (fuelAnalyticsTab === 'efficiency' ? renderFuelEfficiencyTab(filteredTxns, truckStats, periodMiles, totalDieselGal, mpg) : '') +
        
        // PRICES TAB
        (fuelAnalyticsTab === 'prices' ? renderFuelPricesTab(filteredTxns, stateStats, avgPricePerGal) : '');
    }
    
    // Fuel Analytics Tab
    function renderFuelAnalyticsTab(txns, allTxns, truckStats, stateStats, range) {
      // Calculate trends
      const weeklyData = {};
      txns.filter(t => t.product === 'ULSD').forEach(t => {
        const d = new Date(t.transaction_date);
        const weekStart = new Date(d);
        weekStart.setDate(d.getDate() - d.getDay());
        const key = weekStart.toISOString().split('T')[0];
        if (!weeklyData[key]) weeklyData[key] = { gallons: 0, cost: 0, count: 0 };
        weeklyData[key].gallons += parseFloat(t.gallons || 0);
        weeklyData[key].cost += parseFloat(t.amount || 0);
        weeklyData[key].count++;
      });
      
      const weeks = Object.keys(weeklyData).sort();
      const avgWeeklyGallons = weeks.length > 0 ? weeks.reduce((s, w) => s + weeklyData[w].gallons, 0) / weeks.length : 0;
      const avgWeeklyCost = weeks.length > 0 ? weeks.reduce((s, w) => s + weeklyData[w].cost, 0) / weeks.length : 0;
      
      // Predict next month
      const projectedMonthlyGallons = avgWeeklyGallons * 4.33;
      const projectedMonthlyCost = avgWeeklyCost * 4.33;
      
      // Day of week analysis
      const dayStats = {0:'Sun',1:'Mon',2:'Tue',3:'Wed',4:'Thu',5:'Fri',6:'Sat'};
      const byDay = {};
      txns.filter(t => t.product === 'ULSD').forEach(t => {
        const day = new Date(t.transaction_date).getDay();
        if (!byDay[day]) byDay[day] = { count: 0, gallons: 0, cost: 0 };
        byDay[day].count++;
        byDay[day].gallons += parseFloat(t.gallons || 0);
        byDay[day].cost += parseFloat(t.amount || 0);
      });
      
      // Find anomalies (trucks with significantly different MPG)
      const truckMPGs = Object.values(truckStats).filter(t => t.mpg > 0).map(t => t.mpg);
      const avgMPG = truckMPGs.length > 0 ? truckMPGs.reduce((s, m) => s + m, 0) / truckMPGs.length : 0;
      const anomalies = Object.entries(truckStats).filter(([tn, data]) => data.mpg > 0 && Math.abs(data.mpg - avgMPG) > avgMPG * 0.2);
      
      return '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px">' +
        
        // Forecast Card
        '<div class="card"><div class="card-header"><h3> Fuel Forecast</h3></div><div style="padding:20px">' +
        '<div style="background:linear-gradient(135deg,var(--blue),var(--blue));padding:20px;border-radius:12px;color:white;margin-bottom:16px">' +
        '<div style="font-size:13px;opacity:0.8;margin-bottom:4px">Projected Next Month</div>' +
        '<div style="font-size:28px;font-weight:700">' + formatMoney(projectedMonthlyCost) + '</div>' +
        '<div style="font-size:13px;opacity:0.8;margin-top:8px">' + projectedMonthlyGallons.toFixed(0) + ' gallons estimated</div>' +
        '</div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">' +
        '<div style="background:var(--bg-darker);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:var(--text-xs);color:var(--text-muted)">Avg Weekly Cost</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold)">' + formatMoney(avgWeeklyCost) + '</div></div>' +
        '<div style="background:var(--bg-darker);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:var(--text-xs);color:var(--text-muted)">Avg Weekly Gallons</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold)">' + avgWeeklyGallons.toFixed(0) + '</div></div>' +
        '</div></div></div>' +
        
        // Weekly Trend
        '<div class="card"><div class="card-header"><h3> Weekly Trend</h3></div><div style="padding:20px">' +
        '<div style="display:flex;gap:4px;align-items:flex-end;height:120px;margin-bottom:12px">' +
        weeks.slice(-8).map(function(w) {
          const maxCost = Math.max.apply(null, weeks.map(function(wk) { return weeklyData[wk].cost; }));
          const height = maxCost > 0 ? (weeklyData[w].cost / maxCost) * 100 : 0;
          return '<div style="flex:1;display:flex;flex-direction:column;align-items:center"><div style="background:var(--blue);width:100%;height:' + height + 'px;border-radius:4px 4px 0 0;min-height:4px"></div><div style="font-size:9px;color:var(--text-muted);margin-top:4px;transform:rotate(-45deg)">' + w.slice(5) + '</div></div>';
        }).join('') +
        '</div></div></div>' +
        
        // Day of Week Analysis
        '<div class="card"><div class="card-header"><h3> Fill-Up Patterns</h3></div><div style="padding:20px">' +
        '<div style="display:flex;gap:8px">' +
        [0,1,2,3,4,5,6].map(function(d) {
          const data = byDay[d] || { count: 0 };
          const maxCount = Math.max.apply(null, Object.values(byDay).map(function(x) { return x.count || 0; }));
          const height = maxCount > 0 ? (data.count / maxCount) * 60 : 0;
          return '<div style="flex:1;text-align:center"><div style="height:60px;display:flex;align-items:flex-end;justify-content:center"><div style="background:' + (d === 0 || d === 6 ? 'var(--amber)' : 'var(--green)') + ';width:80%;height:' + height + 'px;border-radius:4px 4px 0 0;min-height:4px"></div></div><div style="font-size:var(--text-xs);color:var(--text-muted);margin-top:4px">' + dayStats[d] + '</div><div style="font-size:12px;font-weight:600">' + data.count + '</div></div>';
        }).join('') +
        '</div>' +
        '<div style="margin-top:16px;font-size:13px;color:var(--text-muted)"> ' + ((byDay[0]?.count || 0) > (byDay[1]?.count || 0) ? 'Consider weekday fill-ups for potential savings' : 'Good job avoiding weekend fill-ups!') + '</div>' +
        '</div></div>' +
        
        // Anomaly Detection
        '<div class="card"><div class="card-header"><h3> Anomaly Detection</h3></div><div style="padding:20px">' +
        (anomalies.length === 0 ? '<div style="background:var(--green-dim);padding:20px;border-radius:8px;text-align:center"><div style="font-size:24px"></div><div style="color:var(--primary-800);font-weight:600;margin-top:8px">All trucks performing normally</div><div style="font-size:13px;color:var(--primary-700)">Average MPG: ' + avgMPG.toFixed(2) + '</div></div>' :
        anomalies.map(function(item) {
          const tn = item[0], data = item[1];
          const diff = ((data.mpg - avgMPG) / avgMPG * 100);
          const isLow = diff < 0;
          return '<div style="display:flex;gap:12px;padding:12px;background:' + (isLow ? 'var(--red-dim)' : 'var(--green-dim)') + ';border-radius:8px;margin-bottom:8px">' +
            '<span style="font-size:20px">' + (isLow ? '' : '') + '</span>' +
            '<div><div style="font-weight:600;color:' + (isLow ? 'var(--red)' : 'var(--primary-800)') + '">Truck #' + tn + '</div>' +
            '<div style="font-size:12px;color:' + (isLow ? 'var(--red)' : 'var(--primary-700)') + '">MPG: ' + data.mpg.toFixed(2) + ' (' + (diff > 0 ? '+' : '') + diff.toFixed(0) + '% vs avg)</div>' +
            (isLow ? '<div style="font-size:11px;color:var(--red);margin-top:4px">Check tire pressure, air filter, or driving habits</div>' : '') +
            '</div></div>';
        }).join('')) +
        '</div></div>' +
        
        '</div>';
    }
    
    // Fuel Efficiency Tab
    function renderFuelEfficiencyTab(txns, truckStats, totalMiles, totalGallons, avgMPG) {
      // Rank trucks by efficiency
      const rankedTrucks = Object.entries(truckStats)
        .filter(function(item) { return item[1].mpg > 0; })
        .sort(function(a, b) { return b[1].mpg - a[1].mpg; });
      
      // Calculate potential savings
      const bestMPG = rankedTrucks.length > 0 ? rankedTrucks[0][1].mpg : 0;
      const potentialSavings = rankedTrucks.reduce(function(total, item) {
        const data = item[1];
        if (data.mpg < bestMPG && data.miles > 0) {
          const gallonsAtBestMPG = data.miles / bestMPG;
          const savedGallons = data.diesel - gallonsAtBestMPG;
          const savedCost = savedGallons * (data.cost / data.diesel);
          return total + Math.max(0, savedCost);
        }
        return total;
      }, 0);
      
      // Driver efficiency
      const driverStats = {};
      txns.filter(function(t) { return t.product === 'ULSD' && t.driver_name; }).forEach(function(t) {
        if (!driverStats[t.driver_name]) driverStats[t.driver_name] = { gallons: 0, cost: 0, fillups: 0 };
        driverStats[t.driver_name].gallons += parseFloat(t.gallons || 0);
        driverStats[t.driver_name].cost += parseFloat(t.amount || 0);
        driverStats[t.driver_name].fillups++;
      });
      
      return '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px">' +
        
        // Efficiency Summary
        '<div class="card"><div class="card-header"><h3> Efficiency Summary</h3></div><div style="padding:20px">' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">' +
        '<div style="background:' + (avgMPG >= 6 ? 'var(--green-dim)' : avgMPG >= 5 ? 'var(--amber-dim)' : 'var(--red-dim)') + ';padding:20px;border-radius:12px;text-align:center">' +
        '<div style="font-size:12px;color:var(--text-muted)">Fleet Average MPG</div>' +
        '<div style="font-size:36px;font-weight:700;color:' + (avgMPG >= 6 ? 'var(--green)' : avgMPG >= 5 ? 'var(--amber)' : 'var(--red)') + '">' + avgMPG.toFixed(2) + '</div>' +
        '<div style="font-size:12px;color:var(--text-muted);margin-top:4px">' + (avgMPG >= 6 ? ' Excellent' : avgMPG >= 5 ? ' Good' : ' Needs Work') + '</div>' +
        '</div>' +
        '<div style="background:var(--blue-dim);padding:20px;border-radius:12px;text-align:center">' +
        '<div style="font-size:12px;color:var(--blue)">Potential Monthly Savings</div>' +
        '<div style="font-size:36px;font-weight:700;color:var(--blue)">' + formatMoney(potentialSavings) + '</div>' +
        '<div style="font-size:12px;color:var(--text-muted);margin-top:4px">If all trucks matched best performer</div>' +
        '</div>' +
        '</div>' +
        '<div style="font-size:13px;color:var(--text-muted)"> Tips: Maintain tire pressure (35-75 PSI), reduce idling, use cruise control on highways</div>' +
        '</div></div>' +
        
        // Truck Efficiency Ranking
        '<div class="card"><div class="card-header"><h3> Truck Efficiency Ranking</h3></div><div style="padding:20px">' +
        (rankedTrucks.length === 0 ? '<div style="text-align:center;padding:20px;color:var(--text-muted)">No efficiency data available</div>' :
        rankedTrucks.map(function(item, i) {
          const tn = item[0], data = item[1];
          const medal = i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : '';
          const barWidth = bestMPG > 0 ? (data.mpg / bestMPG) * 100 : 0;
          return '<div style="margin-bottom:16px">' +
            '<div style="display:flex;justify-content:space-between;margin-bottom:4px">' +
            '<span style="font-weight:600">' + medal + ' Truck #' + tn + '</span>' +
            '<span style="font-weight:700;color:' + (data.mpg >= 6 ? 'var(--green)' : data.mpg >= 5 ? 'var(--amber)' : 'var(--red)') + '">' + data.mpg.toFixed(2) + ' MPG</span>' +
            '</div>' +
            '<div style="background:var(--bg-card);height:24px;border-radius:4px;overflow:hidden">' +
            '<div style="background:' + (data.mpg >= 6 ? 'var(--green)' : data.mpg >= 5 ? 'var(--amber)' : 'var(--red)') + ';height:100%;width:' + barWidth + '%;display:flex;align-items:center;justify-content:flex-end;padding-right:8px">' +
            '<span style="font-size:11px;color:white;font-weight:600">' + data.miles.toLocaleString() + ' mi</span>' +
            '</div></div></div>';
        }).join('')) +
        '</div></div>' +
        
        // Driver Analysis
        '<div class="card"><div class="card-header"><h3> Driver Fuel Usage</h3></div><div style="padding:20px">' +
        (Object.keys(driverStats).length === 0 ? '<div style="text-align:center;padding:20px;color:var(--text-muted)">No driver data available</div>' :
        '<table style="width:100%;font-size:13px"><thead><tr style="border-bottom:2px solid var(--border)"><th style="text-align:left;padding:8px">Driver</th><th style="text-align:right;padding:8px">Fill-ups</th><th style="text-align:right;padding:8px">Gallons</th><th style="text-align:right;padding:8px">Cost</th></tr></thead><tbody>' +
        Object.entries(driverStats).sort(function(a, b) { return b[1].cost - a[1].cost; }).slice(0, 8).map(function(item) {
          const name = item[0], data = item[1];
          return '<tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">' + name + '</td><td style="text-align:right;padding:8px">' + data.fillups + '</td><td style="text-align:right;padding:8px">' + data.gallons.toFixed(0) + '</td><td style="text-align:right;padding:8px;color:var(--red)">' + formatMoney(data.cost) + '</td></tr>';
        }).join('') +
        '</tbody></table>') +
        '</div></div>' +
        
        '</div>';
    }
    
    // Fuel Prices Tab
    function renderFuelPricesTab(txns, stateStats, avgPrice) {
      // Price by state with comparison
      const statePrices = Object.entries(stateStats)
        .map(function(item) {
          const state = item[0], data = item[1];
          const avg = data.gallons > 0 ? data.cost / data.gallons : 0;
          const taxRate = iftaTaxRates[state] || 0;
          return { state: state, avgPrice: avg, gallons: data.gallons, cost: data.cost, taxRate: taxRate, effectiveCost: avg - taxRate };
        })
        .filter(function(s) { return s.avgPrice > 0; })
        .sort(function(a, b) { return a.effectiveCost - b.effectiveCost; });
      
      const cheapestState = statePrices[0];
      const expensiveState = statePrices[statePrices.length - 1];
      
      // Recent price trend
      const recentTxns = txns.filter(function(t) { return t.product === 'ULSD'; }).sort(function(a, b) { return new Date(b.transaction_date) - new Date(a.transaction_date); }).slice(0, 20);
      const recentAvgPrice = recentTxns.reduce(function(s, t) { return s + (parseFloat(t.amount || 0) / parseFloat(t.gallons || 1)); }, 0) / Math.max(recentTxns.length, 1);
      const priceTrend = recentAvgPrice - avgPrice;
      
      // Price alerts
      const priceAlerts = [];
      if (cheapestState && expensiveState && cheapestState.state !== expensiveState.state) {
        const savings = (expensiveState.effectiveCost - cheapestState.effectiveCost) * 100;
        if (savings > 10) {
          priceAlerts.push({ type: 'tip', msg: 'Save ' + savings.toFixed(0) + '/gal (IFTA-adjusted) by filling in ' + cheapestState.state + ' instead of ' + expensiveState.state });
        }
      }
      if (Math.abs(priceTrend) > 0.10) {
        priceAlerts.push({ type: priceTrend > 0 ? 'warning' : 'good', msg: 'Prices ' + (priceTrend > 0 ? 'up' : 'down') + ' ' + Math.abs(priceTrend * 100).toFixed(0) + '/gal recently' });
      }
      // IFTA flip alert: when cheapest by effective cost has higher pump price than cheapest by pump price
      if (statePrices.length > 1) {
        const cheapestByPump = statePrices.slice().sort(function(a, b) { return a.avgPrice - b.avgPrice; })[0];
        if (cheapestByPump.state !== cheapestState.state) {
          const flipSavings = (cheapestByPump.effectiveCost - cheapestState.effectiveCost) * 100;
          priceAlerts.push({ type: 'tip', msg: cheapestState.state + ' has higher pump price but is ' + flipSavings.toFixed(0) + '/gal cheaper after IFTA vs ' + cheapestByPump.state });
        }
      }
      
      return '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px">' +
        
        // Price Alerts
        (priceAlerts.length > 0 ? '<div class="card" style="grid-column:1/-1"><div style="padding:16px">' +
        priceAlerts.map(function(a) { return '<div style="display:flex;gap:12px;padding:12px;background:' + (a.type === 'warning' ? 'var(--red-dim)' : a.type === 'good' ? 'var(--green-dim)' : 'var(--blue-dim)') + ';border-radius:8px;margin-bottom:8px">' +
          '<span style="font-size:20px">' + (a.type === 'warning' ? '' : a.type === 'good' ? '' : '') + '</span>' +
          '<div style="font-weight:600;color:' + (a.type === 'warning' ? 'var(--red)' : a.type === 'good' ? 'var(--primary-800)' : 'var(--blue)') + '">' + a.msg + '</div></div>'; }).join('') +
        '</div></div>' : '') +

        // IFTA Smart Pick hero card
        (cheapestState ? '<div class="card" style="grid-column:1/-1;border:2px solid var(--green);background:linear-gradient(135deg,var(--green-dim),var(--green-dim))">' +
        '<div style="padding:20px">' +
        '<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">' +
        '<span style="font-size:24px"></span>' +
        '<div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--primary-800)">IFTA Smart Pick</div>' +
        '<div style="font-size:12px;color:var(--primary-700)">Best value after IFTA tax adjustment</div></div></div>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px">' +
        '<div style="text-align:center"><div style="font-size:11px;color:var(--primary-700);font-weight:600">WINNING STATE</div>' +
        '<div style="font-size:32px;font-weight:800;color:var(--green)">' + cheapestState.state + '</div></div>' +
        '<div style="text-align:center"><div style="font-size:11px;color:var(--primary-700);font-weight:600">PUMP PRICE</div>' +
        '<div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--primary-800)">' + formatMoney(cheapestState.avgPrice) + '</div></div>' +
        '<div style="text-align:center"><div style="font-size:11px;color:var(--primary-700);font-weight:600">IFTA TAX RATE</div>' +
        '<div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--primary-800)">-' + formatMoney(cheapestState.taxRate) + '</div></div>' +
        '<div style="text-align:center"><div style="font-size:11px;color:var(--primary-700);font-weight:600">EFFECTIVE COST</div>' +
        '<div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--green)">' + formatMoney(cheapestState.effectiveCost) + '</div></div>' +
        (expensiveState && cheapestState.state !== expensiveState.state ?
        '<div style="text-align:center"><div style="font-size:11px;color:var(--primary-700);font-weight:600">SAVES VS ' + expensiveState.state + '</div>' +
        '<div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--green)">' + ((expensiveState.effectiveCost - cheapestState.effectiveCost) * 100).toFixed(0) + '/gal</div></div>' : '') +
        '</div></div></div>' : '') +

        // Price Summary
        '<div class="card"><div class="card-header"><h3> Price Summary</h3></div><div style="padding:20px">' +
        '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:20px">' +
        '<div style="background:var(--bg-darker);padding:var(--spacing-4);border-radius:var(--radius);text-align:center">' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted)">Average Price</div>' +
        '<div style="font-size:var(--text-2xl);font-weight:var(--weight-bold)">' + formatMoney(avgPrice) + '</div>' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted)">per gallon</div></div>' +
        (cheapestState ? '<div style="background:var(--green-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center">' +
        '<div style="font-size:11px;color:var(--primary-800)">Cheapest (IFTA-Adjusted)</div>' +
        '<div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--green)">' + cheapestState.state + '</div>' +
        '<div style="font-size:13px;font-weight:600;color:var(--green)">' + formatMoney(cheapestState.effectiveCost) + '/gal eff.</div>' +
        '<div style="font-size:11px;color:var(--primary-800)">pump: ' + formatMoney(cheapestState.avgPrice) + '/gal</div></div>' : '') +
        (expensiveState ? '<div style="background:var(--red-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center">' +
        '<div style="font-size:11px;color:var(--red)">Most Expensive (IFTA-Adjusted)</div>' +
        '<div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--red)">' + expensiveState.state + '</div>' +
        '<div style="font-size:13px;font-weight:600;color:var(--red)">' + formatMoney(expensiveState.effectiveCost) + '/gal eff.</div>' +
        '<div style="font-size:11px;color:var(--red)">pump: ' + formatMoney(expensiveState.avgPrice) + '/gal</div></div>' : '') +
        '</div>' +
        '<div style="font-size:13px;color:var(--text-muted)">Recent trend: <strong style="color:' + (priceTrend > 0 ? 'var(--red)' : 'var(--green)') + '">' + (priceTrend > 0 ? '' : '') + ' ' + formatMoney(Math.abs(priceTrend)) + '/gal</strong></div>' +
        '</div></div>' +
        
        // Price by State
        '<div class="card"><div class="card-header"><h3> Price by State (IFTA-Adjusted)</h3></div><div style="padding:20px">' +
        (statePrices.length === 0 ? '<div style="text-align:center;padding:20px;color:var(--text-muted)">No state data</div>' :
        statePrices.map(function(s, i) {
          const isLowest = i === 0;
          const isHighest = i === statePrices.length - 1 && statePrices.length > 1;
          const maxEffective = expensiveState ? expensiveState.effectiveCost : s.effectiveCost;
          return '<div style="display:flex;align-items:center;gap:12px;padding:12px;background:' + (isLowest ? 'var(--green-dim)' : isHighest ? 'var(--red-dim)' : 'var(--bg-darker)') + ';border-radius:8px;margin-bottom:8px">' +
            '<div style="font-size:var(--text-xl);font-weight:var(--weight-bold);width:50px">' + s.state + '</div>' +
            '<div style="flex:1"><div style="background:var(--bg-card);height:20px;border-radius:4px;overflow:hidden">' +
            '<div style="background:' + (isLowest ? 'var(--green)' : isHighest ? 'var(--red)' : 'var(--blue)') + ';height:100%;width:' + (maxEffective > 0 ? s.effectiveCost / maxEffective * 100 : 100) + '%"></div></div></div>' +
            '<div style="text-align:right;min-width:140px">' +
            '<div style="font-weight:700;color:' + (isLowest ? 'var(--green)' : isHighest ? 'var(--red)' : 'inherit') + '">' + formatMoney(s.effectiveCost) + ' <span style="font-size:10px;font-weight:600;opacity:0.7">eff.</span></div>' +
            '<div style="font-size:var(--text-xs);color:var(--text-muted)">' + formatMoney(s.avgPrice) + ' pump | ' + formatMoney(s.taxRate) + ' tax</div></div></div>';
        }).join('')) +
        '</div></div>' +
        
        // Recent Transactions with Price
        '<div class="card"><div class="card-header"><h3> Recent Fill-ups</h3></div><div style="padding:20px;max-height:400px;overflow-y:auto">' +
        recentTxns.slice(0, 10).map(function(t) {
          const pricePerGal = parseFloat(t.gallons) > 0 ? parseFloat(t.amount) / parseFloat(t.gallons) : 0;
          const txnTaxRate = iftaTaxRates[t.state] || 0;
          const effectivePrice = pricePerGal - txnTaxRate;
          const diff = effectivePrice - avgPrice;
          return '<div style="display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid var(--border)">' +
            '<div><div style="font-weight:600">' + t.city + ', ' + t.state + '</div><div style="font-size:var(--text-xs);color:var(--text-muted)">' + formatDate(t.transaction_date) + '  Truck #' + t.truck_number + '</div></div>' +
            '<div style="text-align:right"><div style="font-weight:700">' + formatMoney(effectivePrice) + '/gal <span style="font-size:10px;font-weight:600;opacity:0.7">eff.</span></div>' +
            '<div style="font-size:var(--text-xs);color:var(--text-muted)">' + formatMoney(pricePerGal) + ' pump - ' + formatMoney(txnTaxRate) + ' tax</div>' +
            '<div style="font-size:11px;color:' + (diff <= 0 ? 'var(--green)' : 'var(--red)') + '">' + (diff <= 0 ? '' : '') + formatMoney(Math.abs(diff)) + ' vs avg</div></div></div>';
        }).join('') +
        '</div></div>' +
        
        '</div>';
    }

    async function deletePeriodFuelData() {
      const range = getFuelDateRange();
      const periodLabel = getFuelPeriodLabel();
      
      // Get transactions for this period
      const toDelete = (appData.fuel_transactions || []).filter(t => {
        if (!t.transaction_date) return false;
        const d = t.transaction_date;
        return d >= range.start && d <= range.end;
      });
      
      if (toDelete.length === 0) {
        showToast('No data to delete for this period', 'error');
        return;
      }
      
      if (!confirm('Delete all ' + toDelete.length + ' fuel transactions for ' + periodLabel + '?\n\nThis cannot be undone!')) {
        return;
      }
      
      showToast('Deleting ' + toDelete.length + ' transactions...');
      
      let deleted = 0;
      for (const txn of toDelete) {
        try {
          await dbDelete('fuel_transactions', txn.id);
          deleted++;
        } catch (e) {
          console.error('Failed to delete', txn.id, e);
        }
      }
      
      showToast('Deleted ' + deleted + ' transactions');
      await loadAllData(true);
      renderFuelTracking(document.getElementById('main-content'));
    }

    function openFuelUploadModal() {
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3> Upload Fuel Report</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div style="background:var(--blue-dim);padding:var(--spacing-4);border-radius:var(--radius);margin-bottom:16px"><strong style="color:var(--blue)">Supported Formats:</strong><p style="color:var(--blue);margin-top:8px;font-size:14px"> <strong>CSV</strong> (Recommended) - More reliable<br> <strong>PDF</strong> - Love\'s / TA Transaction Reports</p></div>' +
        '<div class="form-group"><label>Select File (CSV or PDF)</label><input type="file" id="fuelFile" accept=".csv,.pdf"></div>' +
        '<div id="fuelParsePreview" style="display:none;margin-top:16px;max-height:300px;overflow-y:auto"></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="parseFuelFile()"> Parse File</button><button class="btn btn-primary" id="saveFuelBtn" style="display:none;background:var(--green)" onclick="saveFuelTransactions()"> Save Transactions</button></div></div>';
      document.body.appendChild(m);
    }

    let parsedFuelData = [];

    async function parseFuelFile() {
      const fileInput = document.getElementById('fuelFile');
      if (!fileInput.files || fileInput.files.length === 0) {
        showToast('Please select a file', 'error');
        return;
      }
      
      const file = fileInput.files[0];
      const fileName = file.name.toLowerCase();
      
      if (fileName.endsWith('.csv')) {
        parseFuelCsv(file);
      } else if (fileName.endsWith('.pdf')) {
        parseFuelPdf(file);
      } else {
        showToast('Please select a CSV or PDF file', 'error');
      }
    }

    function parseFuelCsv(file) {
      showToast('Parsing CSV... Please wait');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const lines = text.split('\n');
          
          // Valid US state codes
          const validStates = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY','DC'];
          
          // Find header row to determine column positions
          let headerIdx = -1;
          let headers = [];
          
          for (let i = 0; i < Math.min(10, lines.length); i++) {
            const line = lines[i].toLowerCase();
            if (line.includes('txn') || line.includes('transaction') || line.includes('unit') || line.includes('gallons')) {
              headerIdx = i;
              headers = parseCSVLine(lines[i]);
              break;
            }
          }
          
          if (headerIdx === -1) {
            // No header found, assume standard format
            headerIdx = 0;
            headers = ['txn', 'unit', 'card', 'cardholder', 'date', 'city', 'st', 'location', 'code', 'gallons', 'product', 'retail', 'disc', 'svgs'];
          }
          
          // Map header names to indices
          const colMap = {};
          headers.forEach((h, i) => {
            const lh = h.toLowerCase().trim();
            if (lh.includes('txn') || lh.includes('transaction')) colMap.txn = i;
            else if (lh.includes('unit')) colMap.unit = i;
            else if (lh.includes('card') && !lh.includes('holder')) colMap.card = i;
            else if (lh.includes('holder') || lh.includes('driver') || lh.includes('nic')) colMap.driver = i;
            else if (lh.includes('date')) colMap.date = i;
            else if (lh.includes('city')) colMap.city = i;
            else if (lh === 'st' || lh === 'st.' || lh.includes('state')) colMap.state = i;
            else if (lh.includes('location')) colMap.location = i;
            else if (lh.includes('code')) colMap.code = i;
            else if (lh.includes('gallon')) colMap.gallons = i;
            else if (lh.includes('product')) colMap.product = i;
            else if (lh.includes('retail')) colMap.retail = i;
            else if (lh.includes('disc')) colMap.disc = i;
            else if (lh.includes('svg') || lh.includes('saving')) colMap.savings = i;
          });
          
          console.log('Column mapping:', colMap);
          
          const transactions = [];
          
          for (let i = headerIdx + 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const cols = parseCSVLine(line);
            if (cols.length < 5) continue;
            
            // Get values
            const txnNum = cols[colMap.txn] || cols[0] || '';
            const unitNum = cols[colMap.unit] || cols[1] || '';
            const cardNum = cols[colMap.card] || cols[2] || '';
            const driverName = cols[colMap.driver] || cols[3] || '';
            let dateStr = cols[colMap.date] || cols[4] || '';
            const city = cols[colMap.city] || cols[5] || '';
            let state = (cols[colMap.state] || cols[6] || '').toUpperCase().trim();
            const location = cols[colMap.location] || cols[7] || '';
            const gallonsStr = cols[colMap.gallons] || cols[9] || '';
            const product = (cols[colMap.product] || cols[10] || '').toUpperCase().trim();
            const discStr = cols[colMap.disc] || cols[12] || '';
            const savingsStr = cols[colMap.savings] || cols[13] || '';
            
            // Validate
            if (!txnNum || !/^\d+$/.test(txnNum.trim())) continue;
            if (!unitNum || !/^\d+$/.test(unitNum.trim())) continue;
            if (!product || (product !== 'ULSD' && product !== 'DEF' && !product.includes('TXN') && !product.includes('FEE'))) continue;
            
            // Parse date (MM/DD/YYYY -> YYYY-MM-DD)
            let formattedDate = '';
            const dateMatch = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
            if (dateMatch) {
              formattedDate = dateMatch[3] + '-' + dateMatch[1].padStart(2, '0') + '-' + dateMatch[2].padStart(2, '0');
            } else {
              continue;
            }
            
            // Validate state
            if (!validStates.includes(state)) {
              // Try to find state in location or city
              for (const s of validStates) {
                if (location.toUpperCase().includes(' ' + s + ' ') || city.toUpperCase().includes(s)) {
                  state = s;
                  break;
                }
              }
            }
            
            // Parse amounts
            const parseNum = (s) => parseFloat((s || '').replace(/[$,]/g, '')) || 0;
            const gallons = parseNum(gallonsStr);
            const disc = parseNum(discStr);
            const savings = parseNum(savingsStr);
            
            // Determine product type
            let productType = product;
            if (product.includes('TXN') || product.includes('FEE')) {
              productType = 'Txn Fee';
            }
            
            transactions.push({
              txn_number: txnNum.trim(),
              truck_number: unitNum.trim(),
              card_number: cardNum.trim(),
              driver_name: driverName.trim(),
              transaction_date: formattedDate,
              city: city.trim(),
              state: state,
              location: location.trim(),
              product: productType,
              gallons: gallons,
              retail_amount: 0,
              amount: disc,
              savings: savings
            });
          }
          
          parsedFuelData = transactions;
          showFuelPreview();
          
        } catch (err) {
          showToast('Error parsing CSV: ' + err.message, 'error');
          console.error(err);
        }
      };
      reader.readAsText(file);
    }
    
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }
    
    function showFuelPreview() {
      const preview = document.getElementById('fuelParsePreview');
      if (parsedFuelData.length > 0) {
        // Calculate totals for preview
        const ulsd = parsedFuelData.filter(t => t.product === 'ULSD');
        const def = parsedFuelData.filter(t => t.product === 'DEF');
        const totalUlsdGal = ulsd.reduce((s, t) => s + t.gallons, 0);
        const totalDefGal = def.reduce((s, t) => s + t.gallons, 0);
        const totalCost = parsedFuelData.reduce((s, t) => s + t.amount, 0);
        
        preview.style.display = 'block';
        preview.innerHTML = '<div style="background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:12px"><strong style="color:var(--green)"> Found ' + parsedFuelData.length + ' transactions</strong><br><span style="font-size:12px">ULSD: ' + totalUlsdGal.toFixed(2) + ' gal | DEF: ' + totalDefGal.toFixed(2) + ' gal | Total: $' + totalCost.toFixed(2) + '</span></div>' +
          '<table style="width:100%;font-size:12px"><thead><tr><th>Date</th><th>Truck</th><th>State</th><th>Product</th><th>Gallons</th><th>Amount</th></tr></thead><tbody>' +
          parsedFuelData.filter(t => t.product !== 'Txn Fee').slice(0, 10).map(t => '<tr><td>' + t.transaction_date + '</td><td>#' + t.truck_number + '</td><td><strong>' + t.state + '</strong></td><td>' + t.product + '</td><td>' + t.gallons.toFixed(2) + '</td><td>$' + t.amount.toFixed(2) + '</td></tr>').join('') +
          (parsedFuelData.filter(t => t.product !== 'Txn Fee').length > 10 ? '<tr><td colspan="6" style="text-align:center;color:var(--text-muted)">... and ' + (parsedFuelData.filter(t => t.product !== 'Txn Fee').length - 10) + ' more</td></tr>' : '') +
          '</tbody></table>';
        document.getElementById('saveFuelBtn').style.display = 'inline-block';
      } else {
        preview.style.display = 'block';
        preview.innerHTML = '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius)"><strong style="color:var(--red)">No transactions found. Make sure this is a valid fuel report.</strong></div>';
      }
    }

    async function parseFuelPdf(file) {
      showToast('Parsing PDF... Please wait');
      
      // Load PDF.js from CDN
      if (!window.pdfjsLib) {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
        document.head.appendChild(script);
        await new Promise(resolve => script.onload = resolve);
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      }
      
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const typedarray = new Uint8Array(e.target.result);
          const pdf = await pdfjsLib.getDocument(typedarray).promise;
          let fullText = '';
          
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            
            // Group text items by their Y position to reconstruct lines
            let lastY = null;
            let lineText = '';
            
            for (const item of textContent.items) {
              const y = Math.round(item.transform[5]); // Y position
              
              if (lastY !== null && Math.abs(y - lastY) > 5) {
                // New line detected
                fullText += lineText + '\n';
                lineText = item.str;
              } else {
                // Same line, add space if needed
                if (lineText && !lineText.endsWith(' ') && !item.str.startsWith(' ')) {
                  lineText += ' ';
                }
                lineText += item.str;
              }
              lastY = y;
            }
            // Add last line
            if (lineText) {
              fullText += lineText + '\n';
            }
          }
          
          console.log('Extracted text:', fullText.substring(0, 2000)); // Debug
          
          // Parse the text
          parsedFuelData = parseFuelText(fullText);
          showFuelPreview();
          
        } catch (err) {
          showToast('Error parsing PDF: ' + err.message, 'error');
          console.error(err);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function parseFuelText(text) {
      const transactions = [];
      
      // Valid US state codes
      const validStates = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY','DC'];
      const statePattern = validStates.join('|');
      
      // Try line-by-line parsing first (more reliable)
      const lines = text.split('\n');
      
      for (const line of lines) {
        // Check if line starts with 10-digit transaction number
        const txnMatch = line.match(/^(\d{10})\s+(\d+)\s+(\d+)\s+/);
        if (!txnMatch) continue;
        
        const txnNum = txnMatch[1];
        const unitNum = txnMatch[2];
        const cardNum = txnMatch[3];
        
        // Find date
        const dateMatch = line.match(/(\d{2}\/\d{2}\/\d{4})/);
        if (!dateMatch) continue;
        
        const dateStr = dateMatch[1];
        const [month, day, year] = dateStr.split('/');
        const formattedDate = year + '-' + month + '-' + day;
        
        // Extract driver name (between card# and date)
        const afterCard = line.substring(line.indexOf(cardNum) + cardNum.length);
        const beforeDate = afterCard.substring(0, afterCard.indexOf(dateStr));
        const driverName = beforeDate.trim();
        
        // Find state - look for 2-letter state code
        const afterDate = line.substring(line.indexOf(dateStr) + 10).trim();
        const words = afterDate.split(/\s+/);
        
        let state = '';
        let city = '';
        let stateIdx = -1;
        
        for (let i = 0; i < words.length && i < 15; i++) {
          const word = words[i].toUpperCase();
          if (word.length === 2 && validStates.includes(word)) {
            state = word;
            city = words.slice(0, i).join(' ');
            stateIdx = i;
            break;
          }
        }
        
        if (!state) continue;
        
        // Determine product and parse amounts
        let product = '';
        let gallons = 0;
        let amount = 0;
        let savings = 0;
        let location = '';
        
        // Get location (words after state until we hit numbers or product)
        const afterState = words.slice(stateIdx + 1);
        const locParts = [];
        for (const w of afterState) {
          if (/^[\d.]+$/.test(w) || w === 'ULSD' || w === 'DEF' || w === 'Txn' || w === '--') break;
          locParts.push(w);
        }
        location = locParts.join(' ');
        
        if (line.includes('ULSD')) {
          product = 'ULSD';
          // Match: gallons ULSD $retail $disc $savings
          const ulsdMatch = line.match(/([\d.]+)\s+ULSD\s+\$?([\d.]+)\s+\$?([\d.]+)\s+\$?([\d.]+)/);
          if (ulsdMatch) {
            gallons = parseFloat(ulsdMatch[1]) || 0;
            amount = parseFloat(ulsdMatch[3]) || 0; // Disc price
            savings = parseFloat(ulsdMatch[4]) || 0;
          }
        } else if (line.includes(' DEF ') && !line.includes('Txn Fee')) {
          product = 'DEF';
          // Match: gallons DEF $retail $disc $savings (savings might be $0.000)
          const defMatch = line.match(/([\d.]+)\s+DEF\s+\$?([\d.]+)\s+\$?([\d.]+)/);
          if (defMatch) {
            gallons = parseFloat(defMatch[1]) || 0;
            amount = parseFloat(defMatch[3]) || 0;
          }
        } else if (line.includes('Txn Fee')) {
          product = 'Txn Fee';
          const feeMatch = line.match(/Txn\s+Fee\s+\$?([\d.]+)/);
          if (feeMatch) {
            amount = parseFloat(feeMatch[1]) || 0;
          }
        } else {
          continue;
        }
        
        // Only add if we have valid data
        if (product && unitNum && /^\d+$/.test(unitNum)) {
          transactions.push({
            txn_number: txnNum,
            truck_number: unitNum,
            card_number: cardNum,
            driver_name: driverName,
            transaction_date: formattedDate,
            city: city,
            state: state,
            location: location,
            product: product,
            gallons: gallons,
            retail_amount: 0,
            amount: amount,
            savings: savings
          });
        }
      }
      
      // If line-by-line didn't work, text might not have line breaks - use regex on full text
      if (transactions.length === 0) {
        // Find all 10-digit transaction numbers and process surrounding text
        const txnRegex = /(\d{10})\s+(\d+)\s+(\d+)\s+([A-Za-z\s]+?)\s+(\d{2}\/\d{2}\/\d{4})/g;
        let match;
        
        while ((match = txnRegex.exec(text)) !== null) {
          const txnNum = match[1];
          const unitNum = match[2];
          const cardNum = match[3];
          const driverName = match[4].trim();
          const dateStr = match[5];
          
          const [month, day, year] = dateStr.split('/');
          const formattedDate = year + '-' + month + '-' + day;
          
          // Get text after this match until next transaction or end
          const afterMatch = text.substring(match.index + match[0].length, match.index + match[0].length + 200);
          
          // Find state
          let state = '';
          let city = '';
          const stateMatch = afterMatch.match(new RegExp('(.+?)\\s+(' + statePattern + ')\\s+', 'i'));
          if (stateMatch) {
            city = stateMatch[1].trim();
            state = stateMatch[2].toUpperCase();
          }
          
          if (!state) continue;
          
          // Find product
          let product = '';
          let gallons = 0;
          let amount = 0;
          let savings = 0;
          
          if (afterMatch.includes('ULSD')) {
            product = 'ULSD';
            const ulsdMatch = afterMatch.match(/([\d.]+)\s+ULSD\s+\$?([\d.]+)\s+\$?([\d.]+)\s+\$?([\d.]+)/);
            if (ulsdMatch) {
              gallons = parseFloat(ulsdMatch[1]) || 0;
              amount = parseFloat(ulsdMatch[3]) || 0;
              savings = parseFloat(ulsdMatch[4]) || 0;
            }
          } else if (afterMatch.includes('DEF') && !afterMatch.includes('Txn Fee')) {
            product = 'DEF';
            const defMatch = afterMatch.match(/([\d.]+)\s+DEF\s+\$?([\d.]+)\s+\$?([\d.]+)/);
            if (defMatch) {
              gallons = parseFloat(defMatch[1]) || 0;
              amount = parseFloat(defMatch[3]) || 0;
            }
          } else if (afterMatch.includes('Txn Fee')) {
            product = 'Txn Fee';
            const feeMatch = afterMatch.match(/Txn\s+Fee\s+\$?([\d.]+)/);
            if (feeMatch) {
              amount = parseFloat(feeMatch[1]) || 0;
            }
          }
          
          if (product) {
            transactions.push({
              txn_number: txnNum,
              truck_number: unitNum,
              card_number: cardNum,
              driver_name: driverName,
              transaction_date: formattedDate,
              city: city,
              state: state,
              location: '',
              product: product,
              gallons: gallons,
              retail_amount: 0,
              amount: amount,
              savings: savings
            });
          }
        }
      }
      
      return transactions;
    }

    async function saveFuelTransactions() {
      if (parsedFuelData.length === 0) {
        showToast('No transactions to save', 'error');
        return;
      }
      
      showToast('Saving ' + parsedFuelData.length + ' transactions...');
      
      let saved = 0;
      let skipped = 0;
      
      for (const txn of parsedFuelData) {
        // Check if transaction already exists
        const existing = (appData.fuel_transactions || []).find(t => t.txn_number === txn.txn_number);
        if (existing) {
          skipped++;
          continue;
        }
        
        try {
          await dbInsert('fuel_transactions', txn);
          saved++;
        } catch (e) {
          console.error('Failed to save txn', txn.txn_number, e);
        }
      }
      
      document.querySelector('.modal-overlay').remove();
      showToast('Saved ' + saved + ' transactions' + (skipped > 0 ? ' (' + skipped + ' duplicates skipped)' : ''));
      parsedFuelData = [];
      await loadAllData(true);
      renderFuelTracking(document.getElementById('main-content'));
    }

    // ============ IFTA REPORT SECTION ============
    let iftaQuarter = Math.ceil((new Date().getMonth() + 1) / 3);
    let iftaYear = new Date().getFullYear();
    let iftaMileageData = [];
    let fleetMPG = 6.0; // Default MPG for car haulers

    // Fleet mileage data from Samsara Vehicle Activity Report
    // This is the source of truth for fleet-wide mileage (not trip miles)
    let fleetMileageData = []; // Array of { truck_number, distance, driving_hours, stops, start_odometer, end_odometer, period_start, period_end }
    let fleetMileagePeriod = { start: null, end: null }; // Period of uploaded data

    // Get fleet miles for a date range - uses Samsara data if available, falls back to trip miles
    function getFleetMiles(startDate, endDate) {
      // Check if we have Samsara fleet mileage data for this period
      if (fleetMileageData.length > 0 && fleetMileagePeriod.start && fleetMileagePeriod.end) {
        // Check if requested period overlaps with uploaded data
        if (startDate <= fleetMileagePeriod.end && endDate >= fleetMileagePeriod.start) {
          // Use Samsara data - sum all truck distances
          const totalMiles = fleetMileageData.reduce((sum, t) => sum + (parseFloat(t.distance) || 0), 0);
          return { miles: totalMiles, source: 'samsara', period: fleetMileagePeriod };
        }
      }

      // Fallback to trip miles if no Samsara data
      const periodTrips = (appData.trips || []).filter(t => {
        const d = t.trip_date;
        return d && d >= startDate && d <= endDate;
      });
      const tripMiles = periodTrips.reduce((sum, t) => sum + parseFloat(t.miles || 0), 0);
      return { miles: tripMiles, source: 'trips', period: { start: startDate, end: endDate } };
    }

    // Get per-truck fleet miles from Samsara data
    function getFleetMilesByTruck() {
      if (fleetMileageData.length === 0) return null;

      const byTruck = {};
      fleetMileageData.forEach(t => {
        const truckNum = t.truck_number;
        byTruck[truckNum] = {
          distance: parseFloat(t.distance) || 0,
          driving_hours: parseFloat(t.driving_hours) || 0,
          stops: parseInt(t.stops) || 0,
          start_odometer: parseFloat(t.start_odometer) || 0,
          end_odometer: parseFloat(t.end_odometer) || 0
        };
      });
      return byTruck;
    }

    // 2024 IFTA Tax Rates (cents per gallon) - Diesel
    const iftaTaxRates = {
      'AL': 0.29, 'AZ': 0.26, 'AR': 0.285, 'CA': 0.8945, 'CO': 0.205,
      'CT': 0.441, 'DE': 0.22, 'FL': 0.35, 'GA': 0.354, 'ID': 0.32,
      'IL': 0.467, 'IN': 0.56, 'IA': 0.325, 'KS': 0.26, 'KY': 0.246,
      'LA': 0.20, 'ME': 0.312, 'MD': 0.3705, 'MA': 0.26, 'MI': 0.267,
      'MN': 0.285, 'MS': 0.18, 'MO': 0.17, 'MT': 0.2975, 'NE': 0.287,
      'NV': 0.27, 'NH': 0.222, 'NJ': 0.494, 'NM': 0.21, 'NY': 0.3005,
      'NC': 0.382, 'ND': 0.23, 'OH': 0.47, 'OK': 0.19, 'OR': 0.38,
      'PA': 0.741, 'RI': 0.34, 'SC': 0.22, 'SD': 0.28, 'TN': 0.27,
      'TX': 0.20, 'UT': 0.315, 'VT': 0.31, 'VA': 0.296, 'WA': 0.494,
      'WV': 0.352, 'WI': 0.329, 'WY': 0.24, 'DC': 0.235,
      // Canadian Provinces
      'AB': 0.13, 'BC': 0.2767, 'MB': 0.14, 'NB': 0.217, 'NL': 0.165,
      'NS': 0.154, 'ON': 0.143, 'PE': 0.137, 'QC': 0.202, 'SK': 0.15
    };

    function getQuarterDateRange(quarter, year) {
      const ranges = {
        1: { start: year + '-01-01', end: year + '-03-31', label: 'Q1 (Jan-Mar)' },
        2: { start: year + '-04-01', end: year + '-06-30', label: 'Q2 (Apr-Jun)' },
        3: { start: year + '-07-01', end: year + '-09-30', label: 'Q3 (Jul-Sep)' },
        4: { start: year + '-10-01', end: year + '-12-31', label: 'Q4 (Oct-Dec)' }
      };
      return ranges[quarter];
    }

    function renderIFTA(c) {
      const qRange = getQuarterDateRange(iftaQuarter, iftaYear);
      
      // Get fuel data for the quarter from fuel_transactions
      const quarterFuel = (appData.fuel_transactions || []).filter(t => {
        if (!t.transaction_date) return false;
        const d = t.transaction_date;
        return d >= qRange.start && d <= qRange.end && t.product === 'ULSD';
      });
      
      // Group fuel by state
      const fuelByState = {};
      quarterFuel.forEach(t => {
        const state = t.state?.toUpperCase();
        if (state) {
          if (!fuelByState[state]) fuelByState[state] = 0;
          fuelByState[state] += parseFloat(t.gallons || 0);
        }
      });
      
      const totalFuelGallons = Object.values(fuelByState).reduce((s, v) => s + v, 0);
      
      // Calculate actual MPG - prioritize IFTA uploaded miles over trip miles
      const quarterTrips = (appData.trips || []).filter(t => {
        if (!t.trip_date) return false;
        return t.trip_date >= qRange.start && t.trip_date <= qRange.end;
      });
      const tripMilesTotal = quarterTrips.reduce((s, t) => s + parseFloat(t.miles || 0), 0);
      const iftaMilesTotal = iftaMileageData.reduce((s, m) => s + m.miles, 0);
      // Use IFTA miles if available (more accurate), otherwise fall back to trip miles
      const milesForMPG = iftaMilesTotal > 0 ? iftaMilesTotal : tripMilesTotal;
      const milesSource = iftaMilesTotal > 0 ? 'IFTA' : 'trip';
      const calculatedMPG = totalFuelGallons > 0 && milesForMPG > 0 ? (milesForMPG / totalFuelGallons) : 0;
      const hasCalcData = milesForMPG > 0 && totalFuelGallons > 0;
      
      // Calculate IFTA if we have mileage data
      let iftaResults = [];
      let totalMiles = 0;
      let totalTaxableGallons = 0;
      let totalTaxOwed = 0;
      let totalTaxCredit = 0;
      
      if (iftaMileageData.length > 0) {
        totalMiles = iftaMileageData.reduce((s, m) => s + m.miles, 0);
        totalTaxableGallons = fleetMPG > 0 ? (totalMiles / fleetMPG) : 0;
        
        iftaMileageData.forEach(m => {
          const state = m.state.toUpperCase();
          const stateMiles = m.miles;
          const percentOfMiles = totalMiles > 0 ? stateMiles / totalMiles : 0;
          const taxableGallons = totalTaxableGallons * percentOfMiles;
          const fuelPurchased = fuelByState[state] || 0;
          const netTaxableGallons = taxableGallons - fuelPurchased;
          const taxRate = iftaTaxRates[state] || 0;
          const taxDue = netTaxableGallons * taxRate;
          
          if (taxDue > 0) totalTaxOwed += taxDue;
          else totalTaxCredit += Math.abs(taxDue);
          
          iftaResults.push({
            state,
            miles: stateMiles,
            percentOfMiles: percentOfMiles * 100,
            taxableGallons,
            fuelPurchased,
            netTaxableGallons,
            taxRate,
            taxDue
          });
        });
        
        // Sort by state
        iftaResults.sort((a, b) => a.state.localeCompare(b.state));
      }
      
      const netTax = totalTaxOwed - totalTaxCredit;
      
      c.innerHTML = '<div class="header"><h2> IFTA Report</h2><div style="display:flex;gap:12px"><button class="btn btn-primary" onclick="openIFTAUploadModal()"> Upload Samsara Mileage</button>' + (iftaMileageData.length > 0 ? '<button class="btn btn-secondary" style="background:var(--red-dim);color:var(--red);border-color:var(--red-dim)" onclick="clearIFTAMileage()"> Clear Mileage Data</button>' : '') + '</div></div>' +
        
        // Quarter selector
        '<div class="card" style="padding:16px;margin-bottom:24px"><div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">' +
        '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Quarter</label><select id="iftaQuarter" onchange="iftaQuarter=parseInt(this.value);renderIFTA(document.getElementById(\'main-content\'))"><option value="1"' + (iftaQuarter === 1 ? ' selected' : '') + '>Q1 (Jan-Mar)</option><option value="2"' + (iftaQuarter === 2 ? ' selected' : '') + '>Q2 (Apr-Jun)</option><option value="3"' + (iftaQuarter === 3 ? ' selected' : '') + '>Q3 (Jul-Sep)</option><option value="4"' + (iftaQuarter === 4 ? ' selected' : '') + '>Q4 (Oct-Dec)</option></select></div>' +
        '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Year</label><select id="iftaYear" onchange="iftaYear=parseInt(this.value);renderIFTA(document.getElementById(\'main-content\'))"><option value="2024"' + (iftaYear === 2024 ? ' selected' : '') + '>2024</option><option value="2025"' + (iftaYear === 2025 ? ' selected' : '') + '>2025</option><option value="2026"' + (iftaYear === 2026 ? ' selected' : '') + '>2026</option><option value="2027"' + (iftaYear === 2027 ? ' selected' : '') + '>2027</option></select></div>' +
        '<div class="form-group" style="margin:0"><label style="margin-bottom:4px">Fleet MPG</label><div style="display:flex;gap:8px;align-items:center"><input type="number" step="0.1" value="' + fleetMPG + '" style="width:80px" onchange="fleetMPG=parseFloat(this.value)||6;renderIFTA(document.getElementById(\'main-content\'))">' +
        (hasCalcData ? '<button class="btn btn-secondary" style="padding:6px 10px;font-size:12px" onclick="fleetMPG=' + calculatedMPG.toFixed(2) + ';renderIFTA(document.getElementById(\'main-content\'))" title="Use calculated MPG from your ' + milesSource + ' miles and fuel data">Use ' + calculatedMPG.toFixed(2) + '</button>' : '') +
        '</div></div>' +
        '<div style="margin-left:auto;font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--blue)"> ' + qRange.label + ' ' + iftaYear + '</div></div>' +

        // Auto MPG Info Box
        (hasCalcData ? '<div style="background:var(--blue-dim);border:1px solid var(--blue);border-radius:6px;padding:12px;margin-top:12px;display:flex;align-items:center;gap:16px;flex-wrap:wrap">' +
        '<span style="font-size:14px;color:var(--blue)"> <strong>Auto-Calculated MPG:</strong> ' + calculatedMPG.toFixed(2) + ' MPG</span>' +
        '<span style="font-size:12px;color:var(--blue)">(' + milesForMPG.toLocaleString() + ' ' + milesSource + ' miles  ' + totalFuelGallons.toFixed(1) + ' gallons = ' + calculatedMPG.toFixed(2) + ' MPG)</span>' +
        (Math.abs(calculatedMPG - fleetMPG) > 0.5 ? '<span style="font-size:var(--text-xs);color:var(--red);background:var(--red-dim);padding:4px 8px;border-radius:4px"> Differs from current setting by ' + Math.abs(calculatedMPG - fleetMPG).toFixed(2) + ' MPG</span>' : '<span style="font-size:var(--text-xs);color:var(--green)"> Close to current setting</span>') +
        '</div>' :
        '<div style="background:var(--amber-dim);border:1px solid var(--amber);border-radius:6px;padding:12px;margin-top:12px">' +
        '<span style="font-size:13px;color:var(--amber)"> <strong>Tip:</strong> Upload IFTA mileage or add trip miles and fuel transactions to auto-calculate your actual fleet MPG.</span></div>') +
        '</div>' +
        
        // Summary Stats
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Total Miles</div><div class="value">' + totalMiles.toLocaleString(undefined, {maximumFractionDigits: 0}) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:80px;padding:12px 16px"><div class="label">Fleet MPG</div><div class="value">' + fleetMPG.toFixed(1) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px"><div class="label">Taxable Gallons</div><div class="value">' + totalTaxableGallons.toFixed(2) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px"><div class="label">Fuel Purchased</div><div class="value">' + totalFuelGallons.toFixed(2) + ' gal</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px;background:var(--red-dim)"><div class="label">Tax Owed</div><div class="value" style="color:var(--red)">' + formatMoney(totalTaxOwed) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px;background:var(--green-dim)"><div class="label">Tax Credit</div><div class="value" style="color:var(--green)">' + formatMoney(totalTaxCredit) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px;background:' + (netTax >= 0 ? 'var(--red-dim)' : 'var(--green-dim)') + '"><div class="label">Net Tax Due</div><div class="value" style="color:' + (netTax >= 0 ? 'var(--red)' : 'var(--green)') + ';font-size:20px">' + (netTax >= 0 ? '' : '-') + formatMoney(Math.abs(netTax)) + '</div></div>' +
        '</div>' +
        
        // Instructions if no mileage data
        (iftaMileageData.length === 0 ? 
          '<div style="background:var(--amber-dim);border:1px solid var(--amber);border-radius:8px;padding:24px;margin-bottom:24px;text-align:center">' +
          '<h3 style="color:var(--amber);margin:0 0 12px 0"> Upload Samsara Mileage Report</h3>' +
          '<p style="color:var(--amber);margin:0">Click the button above to upload your Samsara IFTA CSV file with mileage by state.</p>' +
          '</div>' : '') +
        
        // Fuel by State (from fuel tracking)
        '<div class="card" style="margin-bottom:24px"><div class="card-header"><h3> Fuel Purchased by State (from Fuel Tracking)</h3></div><div class="table-wrapper"><table><thead><tr><th>State</th><th>Gallons Purchased</th></tr></thead><tbody>' +
        (Object.keys(fuelByState).length === 0 ? '<tr><td colspan="2" style="text-align:center;padding:20px">No fuel data for this quarter. Upload fuel reports in Fuel Tracking.</td></tr>' :
        Object.entries(fuelByState).sort((a, b) => a[0].localeCompare(b[0])).map(([st, gal]) => '<tr><td><strong>' + st + '</strong></td><td>' + gal.toFixed(2) + '</td></tr>').join('')) +
        '<tr style="background:var(--bg-card-hover);font-weight:700"><td>TOTAL</td><td>' + totalFuelGallons.toFixed(2) + '</td></tr>' +
        '</tbody></table></div></div>' +
        
        // IFTA Calculation Table
        (iftaMileageData.length > 0 ?
          '<div class="card"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center"><h3> IFTA Calculation by Jurisdiction</h3><button class="btn btn-secondary" onclick="exportIFTA()"> Export CSV</button></div><div class="table-wrapper"><table><thead><tr><th>State</th><th>Miles</th><th>% of Miles</th><th>Taxable Gal</th><th>Fuel Purchased</th><th>Net Taxable</th><th>Tax Rate</th><th>Tax Due</th></tr></thead><tbody>' +
          iftaResults.map(r => '<tr><td><strong>' + r.state + '</strong></td><td>' + r.miles.toLocaleString(undefined, {maximumFractionDigits: 0}) + '</td><td>' + r.percentOfMiles.toFixed(2) + '%</td><td>' + r.taxableGallons.toFixed(2) + '</td><td>' + r.fuelPurchased.toFixed(2) + '</td><td style="color:' + (r.netTaxableGallons >= 0 ? 'var(--red)' : 'var(--green)') + '">' + r.netTaxableGallons.toFixed(2) + '</td><td>$' + r.taxRate.toFixed(4) + '</td><td class="money" style="color:' + (r.taxDue >= 0 ? 'var(--red)' : 'var(--green)') + '">' + (r.taxDue >= 0 ? '' : '-') + formatMoney(Math.abs(r.taxDue)) + '</td></tr>').join('') +
          '<tr style="background:var(--bg-card-hover);font-weight:700"><td>TOTAL</td><td>' + totalMiles.toLocaleString(undefined, {maximumFractionDigits: 0}) + '</td><td>100%</td><td>' + totalTaxableGallons.toFixed(2) + '</td><td>' + totalFuelGallons.toFixed(2) + '</td><td>' + (totalTaxableGallons - totalFuelGallons).toFixed(2) + '</td><td>-</td><td style="color:' + (netTax >= 0 ? 'var(--red)' : 'var(--green)') + '">' + (netTax >= 0 ? '' : '-') + formatMoney(Math.abs(netTax)) + '</td></tr>' +
          '</tbody></table></div></div>' : '');
    }

    function openIFTAUploadModal() {
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3> Upload Samsara IFTA Mileage</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div style="background:var(--blue-dim);padding:var(--spacing-4);border-radius:var(--radius);margin-bottom:16px"><strong style="color:var(--blue)">Supported Format:</strong><p style="color:var(--blue);margin-top:8px;font-size:14px">Samsara IFTA CSV export with columns: Jurisdiction, Fuel Type, Taxable Miles, Total Miles</p></div>' +
        '<div class="form-group"><label>Select CSV File</label><input type="file" id="iftaCsvFile" accept=".csv"></div>' +
        '<div id="iftaParsePreview" style="display:none;margin-top:16px;max-height:300px;overflow-y:auto"></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="parseIFTACsv()"> Parse CSV</button></div></div>';
      document.body.appendChild(m);
    }

    function clearIFTAMileage() {
      if (!confirm('Clear all uploaded mileage data?\n\nYou will need to re-upload the Samsara CSV.')) {
        return;
      }
      iftaMileageData = [];
      showToast('Mileage data cleared');
      renderIFTA(document.getElementById('main-content'));
    }

    async function parseIFTACsv() {
      const fileInput = document.getElementById('iftaCsvFile');
      if (!fileInput.files || fileInput.files.length === 0) {
        showToast('Please select a CSV file', 'error');
        return;
      }
      
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n');
        const data = [];
        
        // Skip header
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          
          const cols = line.split(',');
          if (cols.length >= 4) {
            const state = cols[0].trim().toUpperCase();
            const miles = parseFloat(cols[2]) || parseFloat(cols[3]) || 0; // Taxable Miles or Total Miles
            
            if (state && miles > 0) {
              data.push({ state, miles });
            }
          }
        }
        
        if (data.length > 0) {
          iftaMileageData = data;
          document.querySelector('.modal-overlay').remove();
          showToast('Loaded ' + data.length + ' jurisdictions');
          renderIFTA(document.getElementById('main-content'));
        } else {
          const preview = document.getElementById('iftaParsePreview');
          preview.style.display = 'block';
          preview.innerHTML = '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius)"><strong style="color:var(--red)">No valid data found. Check CSV format.</strong></div>';
        }
      };
      
      reader.readAsText(file);
    }

    // ============ FLEET MILEAGE UPLOAD (Samsara Vehicle Activity Report) ============
    function openFleetMileageModal() {
      const samsaraKey = getSamsaraApiKey();
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:650px"><div class="modal-header"><h3> Fleet Mileage (Samsara)</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +

        // Date range section
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px">' +
        '<div class="form-group" style="margin:0"><label>Period Start</label><input type="date" id="fleetMileageStart" value="' + new Date(Date.now() - 30*24*60*60*1000).toISOString().split('T')[0] + '"></div>' +
        '<div class="form-group" style="margin:0"><label>Period End</label><input type="date" id="fleetMileageEnd" value="' + new Date().toISOString().split('T')[0] + '"></div>' +
        '</div>' +

        // Option 1: Fetch from Samsara API
        (samsaraKey ?
          '<div style="background:linear-gradient(135deg,var(--green-dim),var(--green-dim));padding:20px;border-radius:12px;margin-bottom:16px;border:1px solid var(--green)">' +
          '<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">' +
          '<span style="font-size:24px"></span>' +
          '<div><strong style="color:var(--primary-800);font-size:16px">Fetch from Samsara API</strong><br>' +
          '<span style="color:var(--primary-700);font-size:13px">Automatically pull mileage data for selected period</span></div>' +
          '</div>' +
          '<button class="btn" style="background:var(--green);color:white;border:none;width:100%;padding:12px;font-weight:600" onclick="fetchAndSaveFleetMileage(document.getElementById(\'fleetMileageStart\').value, document.getElementById(\'fleetMileageEnd\').value)"> Fetch Mileage from Samsara</button>' +
          '<div id="samsaraFetchStatus" style="margin-top:12px"></div>' +
          '</div>'
        :
          '<div style="background:var(--amber-dim);padding:16px;border-radius:12px;margin-bottom:16px;border:1px solid var(--amber)">' +
          '<strong style="color:var(--amber)"> Samsara Not Connected</strong>' +
          '<p style="color:var(--amber);margin-top:8px;font-size:14px">Connect your Samsara API in Settings to enable automatic mileage fetch.</p>' +
          '</div>'
        ) +

        // Option 2: Manual CSV Upload
        '<div style="background:var(--bg-card);padding:16px;border-radius:12px;border:1px solid var(--border)">' +
        '<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">' +
        '<span style="font-size:24px"></span>' +
        '<div><strong style="color:var(--text)">Upload CSV (Manual)</strong><br>' +
        '<span style="color:var(--text-muted);font-size:13px">Samsara: Reports  Vehicle Activity Report</span></div>' +
        '</div>' +
        '<div class="form-group" style="margin:0"><input type="file" id="fleetMileageCsvFile" accept=".csv"></div>' +
        '<button class="btn btn-secondary" style="width:100%;margin-top:12px" onclick="parseFleetMileageCsv()"> Upload & Import CSV</button>' +
        '<div id="fleetMileagePreview" style="display:none;margin-top:12px"></div>' +
        '</div>' +

        // Current data display
        (fleetMileageData.length > 0 ? '<div style="background:var(--blue-dim);padding:16px;border-radius:12px;margin-top:16px;border:1px solid var(--blue-dim)">' +
          '<div style="display:flex;justify-content:space-between;align-items:center">' +
          '<div><strong style="color:var(--blue)"> Current Data Loaded</strong><br>' +
          '<span style="color:var(--blue);font-size:14px">' + fleetMileageData.length + ' trucks  ' + fleetMileageData.reduce((s,t) => s + parseFloat(t.distance || 0), 0).toLocaleString(undefined, {maximumFractionDigits: 0}) + ' total miles</span><br>' +
          '<span style="color:var(--blue);font-size:12px">Period: ' + (fleetMileagePeriod.start || 'N/A') + ' to ' + (fleetMileagePeriod.end || 'N/A') + '</span></div>' +
          '<button class="btn" style="background:var(--red-dim);color:var(--red);border-color:var(--red-dim)" onclick="clearFleetMileage()"> Clear</button>' +
          '</div></div>' : '') +

        '</div><div class="modal-footer">' +
        '<button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Close</button>' +
        '</div></div>';
      document.body.appendChild(m);
    }

    async function clearFleetMileage() {
      if (!confirm('Clear uploaded fleet mileage data?')) return;

      try {
        // Delete from database using sb (the Supabase client)
        await sb.from('fleet_mileage').delete().neq('id', '00000000-0000-0000-0000-000000000000');

        // Clear local state
        fleetMileageData = [];
        fleetMileagePeriod = { start: null, end: null };
        showToast('Fleet mileage data cleared');
        document.querySelector('.modal-overlay')?.remove();
        renderFuelTracking(document.getElementById('main-content'));
      } catch (err) {
        console.error('Error clearing fleet mileage:', err);
        showToast('Error clearing data', 'error');
      }
    }

    function parseFleetMileageCsv() {
      const fileInput = document.getElementById('fleetMileageCsvFile');
      const periodStart = document.getElementById('fleetMileageStart').value;
      const periodEnd = document.getElementById('fleetMileageEnd').value;

      if (!fileInput.files || fileInput.files.length === 0) {
        showToast('Please select a CSV file', 'error');
        return;
      }

      if (!periodStart || !periodEnd) {
        showToast('Please enter report period dates', 'error');
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.split('\n');
        const data = [];

        // Parse header to find column indices
        const headerLine = lines[0].toLowerCase();
        const headers = headerLine.split(',').map(h => h.trim());

        // Find column indices (flexible matching)
        const vehicleIdx = headers.findIndex(h => h.includes('vehicle') || h.includes('name') || h.includes('unit'));
        const distanceIdx = headers.findIndex(h => h.includes('distance'));
        const drivingIdx = headers.findIndex(h => h.includes('driving') && h.includes('time'));
        const stopsIdx = headers.findIndex(h => h.includes('stop'));
        const startOdoIdx = headers.findIndex(h => h.includes('start') && h.includes('odometer'));
        const endOdoIdx = headers.findIndex(h => h.includes('end') && h.includes('odometer'));

        if (vehicleIdx === -1 || distanceIdx === -1) {
          document.getElementById('fleetMileagePreview').style.display = 'block';
          document.getElementById('fleetMileagePreview').innerHTML = '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius)"><strong style="color:var(--red)">Could not find required columns (Vehicle Name, Distance).</strong><br><span style="font-size:12px">Found headers: ' + headers.join(', ') + '</span></div>';
          return;
        }

        // Parse data rows
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          const cols = line.split(',').map(c => c.trim());
          const vehicleName = cols[vehicleIdx] || '';
          const distance = parseFloat(cols[distanceIdx]) || 0;

          // Extract truck number from vehicle name (e.g., "Unit 55" -> 55, "Unit 005" -> 5)
          const truckMatch = vehicleName.match(/(\d+)/);
          const truckNumber = truckMatch ? parseInt(truckMatch[1]) : null;

          if (truckNumber && distance > 0) {
            data.push({
              vehicle_name: vehicleName,
              truck_number: truckNumber,
              distance: distance,
              driving_hours: drivingIdx !== -1 ? (parseFloat(cols[drivingIdx]) || 0) : 0,
              stops: stopsIdx !== -1 ? (parseInt(cols[stopsIdx]) || 0) : 0,
              start_odometer: startOdoIdx !== -1 ? (parseFloat(cols[startOdoIdx]) || 0) : 0,
              end_odometer: endOdoIdx !== -1 ? (parseFloat(cols[endOdoIdx]) || 0) : 0
            });
          }
        }

        if (data.length > 0) {
          // Save to Supabase database
          saveFleetMileageToDb(data, periodStart, periodEnd);
        } else {
          document.getElementById('fleetMileagePreview').style.display = 'block';
          document.getElementById('fleetMileagePreview').innerHTML = '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius)"><strong style="color:var(--red)">No valid data found.</strong><br><span style="font-size:12px">Make sure the CSV has Vehicle Name and Distance columns with data.</span></div>';
        }
      };

      reader.readAsText(file);
    }

    async function saveFleetMileageToDb(data, periodStart, periodEnd) {
      try {
        // First, delete existing data (only keep latest upload) using sb (the Supabase client)
        await sb.from('fleet_mileage').delete().neq('id', '00000000-0000-0000-0000-000000000000');

        // Insert new data
        const records = data.map(d => ({
          period_start: periodStart,
          period_end: periodEnd,
          truck_number: d.truck_number,
          vehicle_name: d.vehicle_name,
          distance: d.distance,
          driving_hours: d.driving_hours,
          stops: d.stops,
          start_odometer: d.start_odometer,
          end_odometer: d.end_odometer
        }));

        const { error } = await sb.from('fleet_mileage').insert(records);

        if (error) {
          console.error('Error saving fleet mileage:', error);
          showToast('Error saving to database: ' + error.message, 'error');
          return;
        }

        // Update local state
        fleetMileageData = data;
        fleetMileagePeriod = { start: periodStart, end: periodEnd };

        const totalMiles = data.reduce((s, t) => s + t.distance, 0);
        document.querySelector('.modal-overlay')?.remove();
        showToast('Saved ' + data.length + ' trucks, ' + totalMiles.toLocaleString(undefined, {maximumFractionDigits: 0}) + ' total miles');
        renderFuelTracking(document.getElementById('main-content'));

      } catch (err) {
        console.error('Error saving fleet mileage:', err);
        showToast('Error saving data', 'error');
      }
    }

    function exportIFTA() {
      const qRange = getQuarterDateRange(iftaQuarter, iftaYear);
      
      // Get fuel data
      const quarterFuel = (appData.fuel_transactions || []).filter(t => {
        if (!t.transaction_date) return false;
        const d = t.transaction_date;
        return d >= qRange.start && d <= qRange.end && t.product === 'ULSD';
      });
      
      const fuelByState = {};
      quarterFuel.forEach(t => {
        const state = t.state?.toUpperCase();
        if (state) {
          if (!fuelByState[state]) fuelByState[state] = 0;
          fuelByState[state] += parseFloat(t.gallons || 0);
        }
      });
      
      const totalMiles = iftaMileageData.reduce((s, m) => s + m.miles, 0);
      const totalTaxableGallons = totalMiles / fleetMPG;
      
      let csv = 'Jurisdiction,Miles,Percent of Miles,Taxable Gallons,Fuel Purchased,Net Taxable Gallons,Tax Rate,Tax Due\n';
      
      iftaMileageData.forEach(m => {
        const state = m.state.toUpperCase();
        const stateMiles = m.miles;
        const percentOfMiles = totalMiles > 0 ? stateMiles / totalMiles : 0;
        const taxableGallons = totalTaxableGallons * percentOfMiles;
        const fuelPurchased = fuelByState[state] || 0;
        const netTaxableGallons = taxableGallons - fuelPurchased;
        const taxRate = iftaTaxRates[state] || 0;
        const taxDue = netTaxableGallons * taxRate;
        
        csv += state + ',' + stateMiles.toFixed(2) + ',' + (percentOfMiles * 100).toFixed(4) + ',' + taxableGallons.toFixed(2) + ',' + fuelPurchased.toFixed(2) + ',' + netTaxableGallons.toFixed(2) + ',' + taxRate.toFixed(4) + ',' + taxDue.toFixed(2) + '\n';
      });
      
      // Download
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'IFTA_Report_Q' + iftaQuarter + '_' + iftaYear + '.csv';
      a.click();
      URL.revokeObjectURL(url);
      showToast('IFTA Report exported!');
    }

    // ============ TASKS SECTION ============
    let taskFilter = 'all'; // all, today, upcoming, overdue, completed
    
    function renderTasks(c) {
      const tasks = appData.tasks || [];
      const today = new Date().toISOString().split('T')[0];
      
      // Filter tasks
      let filteredTasks = tasks;
      if (taskFilter === 'today') {
        filteredTasks = tasks.filter(t => t.due_date === today && t.status !== 'COMPLETED');
      } else if (taskFilter === 'upcoming') {
        filteredTasks = tasks.filter(t => t.due_date > today && t.status !== 'COMPLETED');
      } else if (taskFilter === 'overdue') {
        filteredTasks = tasks.filter(t => t.due_date < today && t.status !== 'COMPLETED');
      } else if (taskFilter === 'urgent') {
        filteredTasks = tasks.filter(t => t.priority === 'URGENT' && t.status !== 'COMPLETED');
      } else if (taskFilter === 'completed') {
        filteredTasks = tasks.filter(t => t.status === 'COMPLETED');
      } else {
        filteredTasks = tasks.filter(t => t.status !== 'COMPLETED');
      }
      
      // Sort: urgent first, then by due date
      filteredTasks.sort((a, b) => {
        if (a.priority === 'URGENT' && b.priority !== 'URGENT') return -1;
        if (b.priority === 'URGENT' && a.priority !== 'URGENT') return 1;
        return new Date(a.due_date) - new Date(b.due_date);
      });
      
      // Stats
      const totalPending = tasks.filter(t => t.status !== 'COMPLETED').length;
      const todayTasks = tasks.filter(t => t.due_date === today && t.status !== 'COMPLETED').length;
      const overdueTasks = tasks.filter(t => t.due_date < today && t.status !== 'COMPLETED').length;
      const urgentTasks = tasks.filter(t => t.priority === 'URGENT' && t.status !== 'COMPLETED').length;
      
      const getPriorityBadge = (p) => {
        if (p === 'URGENT') return '<span class="badge" style="background:var(--red);color:white"> URGENT</span>';
        if (p === 'HIGH') return '<span class="badge" style="background:var(--amber);color:white">HIGH</span>';
        if (p === 'NORMAL') return '<span class="badge badge-blue">NORMAL</span>';
        return '<span class="badge badge-gray">LOW</span>';
      };
      
      const getStatusBadge = (s) => {
        if (s === 'COMPLETED') return '<span class="badge badge-green"> COMPLETED</span>';
        if (s === 'IN_PROGRESS') return '<span class="badge badge-amber">IN PROGRESS</span>';
        return '<span class="badge badge-gray">PENDING</span>';
      };
      
      const isOverdue = (d, s) => d < today && s !== 'COMPLETED';
      
      c.innerHTML = '<div class="header"><h2> Tasks</h2><button class="btn btn-primary" onclick="openTaskModal()">+ New Task</button></div>' +
        
        // Stats cards
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px;cursor:pointer;' + (taskFilter === 'all' ? 'border:2px solid var(--blue)' : '') + '" onclick="taskFilter=\'all\';renderTasks(document.getElementById(\'main-content\'))"><div class="label">Pending Tasks</div><div class="value">' + totalPending + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px;cursor:pointer;background:var(--blue-dim);' + (taskFilter === 'today' ? 'border:2px solid var(--blue)' : '') + '" onclick="taskFilter=\'today\';renderTasks(document.getElementById(\'main-content\'))"><div class="label">Due Today</div><div class="value" style="color:var(--blue)">' + todayTasks + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px;cursor:pointer;background:var(--red-dim);' + (taskFilter === 'overdue' ? 'border:2px solid var(--red)' : '') + '" onclick="taskFilter=\'overdue\';renderTasks(document.getElementById(\'main-content\'))"><div class="label">Overdue</div><div class="value" style="color:var(--red)">' + overdueTasks + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px;cursor:pointer;background:var(--amber-dim);' + (taskFilter === 'urgent' ? 'border:2px solid var(--amber)' : '') + '" onclick="taskFilter=\'urgent\';renderTasks(document.getElementById(\'main-content\'))"><div class="label"> Urgent</div><div class="value" style="color:var(--amber)">' + urgentTasks + '</div></div>' +
        '</div>' +
        
        // Filter tabs
        '<div style="display:flex;gap:8px;margin-bottom:16px">' +
        '<button class="btn ' + (taskFilter === 'all' ? 'btn-primary' : 'btn-secondary') + '" onclick="taskFilter=\'all\';renderTasks(document.getElementById(\'main-content\'))">All Pending</button>' +
        '<button class="btn ' + (taskFilter === 'today' ? 'btn-primary' : 'btn-secondary') + '" onclick="taskFilter=\'today\';renderTasks(document.getElementById(\'main-content\'))">Today</button>' +
        '<button class="btn ' + (taskFilter === 'upcoming' ? 'btn-primary' : 'btn-secondary') + '" onclick="taskFilter=\'upcoming\';renderTasks(document.getElementById(\'main-content\'))">Upcoming</button>' +
        '<button class="btn ' + (taskFilter === 'overdue' ? 'btn-primary' : 'btn-secondary') + '" style="' + (taskFilter === 'overdue' ? '' : 'background:var(--red-dim);color:var(--red);border-color:var(--red-dim)') + '" onclick="taskFilter=\'overdue\';renderTasks(document.getElementById(\'main-content\'))">Overdue</button>' +
        '<button class="btn ' + (taskFilter === 'completed' ? 'btn-primary' : 'btn-secondary') + '" onclick="taskFilter=\'completed\';renderTasks(document.getElementById(\'main-content\'))">Completed</button>' +
        '</div>' +
        
        // Tasks list
        '<div class="card"><div class="card-header"><h3>' + (taskFilter === 'completed' ? 'Completed Tasks' : taskFilter === 'overdue' ? 'Overdue Tasks' : taskFilter === 'today' ? "Today's Tasks" : 'Tasks') + ' (' + filteredTasks.length + ')</h3></div>' +
        (filteredTasks.length === 0 ? '<div style="padding:40px;text-align:center;color:var(--text-muted)">' + (taskFilter === 'completed' ? 'No completed tasks yet' : 'No tasks found') + '</div>' :
        '<div style="padding:16px">' +
        filteredTasks.map(t => {
          const assignee = appData.dispatchers.find(d => d.id === t.assigned_to);
          const creator = appData.users.find(u => u.id === t.created_by);
          const overdueStyle = isOverdue(t.due_date, t.status) ? 'border-left:4px solid var(--red);background:var(--red-dim)' : '';
          const urgentStyle = t.priority === 'URGENT' && t.status !== 'COMPLETED' ? 'border-left:4px solid var(--amber);background:var(--amber-dim)' : '';
          
          return '<div style="padding:16px;border:1px solid var(--bg-elevated);border-radius:8px;margin-bottom:12px;' + (overdueStyle || urgentStyle) + '">' +
            '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px">' +
            '<div style="flex:1">' +
            '<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">' +
            (t.status !== 'COMPLETED' ? '<input type="checkbox" style="width:20px;height:20px;cursor:pointer" onchange="toggleTaskComplete(' + t.id + ',this.checked)" title="Mark as completed">' : '<span style="color:var(--green);font-size:20px"></span>') +
            '<strong style="font-size:16px;' + (t.status === 'COMPLETED' ? 'text-decoration:line-through;color:var(--text-muted)' : '') + '">' + t.title + '</strong>' +
            getPriorityBadge(t.priority) +
            getStatusBadge(t.status) +
            '</div>' +
            (t.description ? '<p style="color:var(--text-muted);margin:0 0 8px 32px;font-size:14px">' + t.description + '</p>' : '') +
            '<div style="display:flex;gap:16px;margin-left:32px;font-size:13px;color:var(--text-muted)">' +
            '<span> ' + (isOverdue(t.due_date, t.status) ? '<span style="color:var(--red);font-weight:600">OVERDUE: </span>' : '') + formatDate(t.due_date) + '</span>' +
            (assignee ? '<span> ' + assignee.name + '</span>' : '') +
            (creator ? '<span>Created by: ' + (creator.first_name || creator.email) + '</span>' : '') +
            '</div>' +
            '</div>' +
            '<div class="actions">' +
            (t.status !== 'COMPLETED' ? '<button class="action-btn" style="background:var(--green);color:white" onclick="toggleTaskComplete(' + t.id + ',true)" title="Complete"></button>' : '<button class="action-btn" style="background:var(--amber);color:white" onclick="toggleTaskComplete(' + t.id + ',false)" title="Reopen"></button>') +
            '<button class="action-btn edit" onclick="openTaskModal(' + t.id + ')">Edit</button>' +
            '<button class="action-btn delete" onclick="deleteTask(' + t.id + ')">Del</button>' +
            '</div></div></div>';
        }).join('') +
        '</div>') +
        '</div>';
    }
    
    function openTaskModal(id = null) {
      const t = id ? (appData.tasks || []).find(x => x.id === id) : null;
      const today = new Date().toISOString().split('T')[0];
      
      const dispatcherOptions = appData.dispatchers.map(d => '<option value="' + d.id + '"' + (t?.assigned_to === d.id ? ' selected' : '') + '>' + d.name + '</option>').join('');
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3>' + (t ? 'Edit Task' : 'New Task') + '</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div class="form-group"><label>Task Title *</label><input id="taskTitle" value="' + (t?.title || '') + '" placeholder="What needs to be done?"></div>' +
        '<div class="form-group"><label>Description</label><textarea id="taskDesc" rows="3" placeholder="Additional details...">' + (t?.description || '') + '</textarea></div>' +
        '<div class="form-row"><div class="form-group"><label>Due Date *</label><input type="date" id="taskDue" value="' + (t?.due_date || today) + '"></div><div class="form-group"><label>Priority</label><select id="taskPriority"><option value="LOW"' + (t?.priority === 'LOW' ? ' selected' : '') + '>Low</option><option value="NORMAL"' + (!t || t?.priority === 'NORMAL' ? ' selected' : '') + '>Normal</option><option value="HIGH"' + (t?.priority === 'HIGH' ? ' selected' : '') + '>High</option><option value="URGENT"' + (t?.priority === 'URGENT' ? ' selected' : '') + '> Urgent</option></select></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Assign To</label><select id="taskAssignee"><option value="">Everyone / Unassigned</option>' + dispatcherOptions + '</select></div><div class="form-group"><label>Status</label><select id="taskStatus"><option value="PENDING"' + (!t || t?.status === 'PENDING' ? ' selected' : '') + '>Pending</option><option value="IN_PROGRESS"' + (t?.status === 'IN_PROGRESS' ? ' selected' : '') + '>In Progress</option><option value="COMPLETED"' + (t?.status === 'COMPLETED' ? ' selected' : '') + '>Completed</option></select></div></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveTask(' + id + ')">Save Task</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function saveTask(id) {
      const title = document.getElementById('taskTitle').value.trim();
      if (!title) { showToast('Please enter task title', 'error'); return; }
      
      const data = {
        title: title,
        description: document.getElementById('taskDesc').value || null,
        due_date: document.getElementById('taskDue').value,
        priority: document.getElementById('taskPriority').value,
        assigned_to: parseInt(document.getElementById('taskAssignee').value) || null,
        status: document.getElementById('taskStatus').value,
        created_by: currentUser.id
      };
      
      try {
        if (id) {
          await dbUpdate('tasks', id, data);
          await logActivity('TASK_UPDATED', { task_id: id, task_title: title, status: data.status, priority: data.priority });
        } else {
          const newTask = await dbInsert('tasks', data);
          await logActivity('TASK_CREATED', { task_id: newTask.id, task_title: title, status: data.status, priority: data.priority });
        }
        document.querySelector('.modal-overlay').remove();
        showToast(id ? 'Task updated!' : 'Task created!');
        await loadAllData(true);
        renderTasks(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    async function toggleTaskComplete(id, complete) {
      try {
        const task = (appData.tasks || []).find(t => t.id === id);
        await dbUpdate('tasks', id, { 
          status: complete ? 'COMPLETED' : 'PENDING',
          completed_at: complete ? new Date().toISOString() : null
        });
        await logActivity(complete ? 'TASK_COMPLETED' : 'TASK_REOPENED', { task_id: id, task_title: task?.title });
        showToast(complete ? 'Task completed! ' : 'Task reopened');
        await loadAllData(true);
        renderTasks(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    async function deleteTask(id) {
      if (!confirm('Delete this task?')) return;
      try {
        const task = (appData.tasks || []).find(t => t.id === id);
        await dbDelete('tasks', id);
        await logActivity('TASK_DELETED', { task_id: id, task_title: task?.title });
        showToast('Task deleted');
        await loadAllData(true);
        renderTasks(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    // ============ COMPLIANCE SECTION ============
    let complianceTab = 'drivers';

    // Compliance tab state
    let complianceMainTab = 'dashboard'; // dashboard, tasks, driver_files, truck_files, company_files, driver_compliance, accidents

    function renderCompliance(c) {
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];

      // Tab buttons
      const tabs = [
        { id: 'dashboard', label: ' Dashboard', color: 'var(--blue)' },
        { id: 'tasks', label: ' Compliance Tasks', color: 'var(--purple)' },
        { id: 'driver_files', label: ' Driver Files', color: 'var(--blue)' },
        { id: 'truck_files', label: ' Truck Files', color: 'var(--blue)' },
        { id: 'company_files', label: ' Company Files', color: 'var(--green)' },
        { id: 'driver_compliance', label: ' Tickets/Violations', color: 'var(--red)' },
        { id: 'accidents', label: ' Accident Registry', color: 'var(--amber)' }
      ];
      
      const tabsHtml = '<div style="display:flex;gap:4px;margin-bottom:20px;flex-wrap:wrap">' +
        tabs.map(t => '<button onclick="complianceMainTab=\'' + t.id + '\';renderCompliance(document.getElementById(\'main-content\'))" style="padding:10px 16px;border:none;cursor:pointer;font-weight:600;border-radius:8px;font-size:13px;' + (complianceMainTab === t.id ? 'background:' + t.color + ';color:white' : 'background:var(--border);color:var(--text-secondary)') + '">' + t.label + '</button>').join('') +
        '</div>';
      
      c.innerHTML = '<div class="header"><h2> Compliance Center</h2></div>' + tabsHtml + '<div id="complianceContent"></div>';
      
      const content = document.getElementById('complianceContent');
      if (complianceMainTab === 'dashboard') renderComplianceDashboard(content);
      else if (complianceMainTab === 'tasks') renderComplianceTasks(content);
      else if (complianceMainTab === 'driver_files') renderComplianceDriverFiles(content);
      else if (complianceMainTab === 'truck_files') renderComplianceTruckFiles(content);
      else if (complianceMainTab === 'company_files') renderComplianceCompanyFiles(content);
      else if (complianceMainTab === 'driver_compliance') renderComplianceDriverSection(content);
      else if (complianceMainTab === 'accidents') renderAccidentRegistry(content);
    }
    
    // ========== COMPLIANCE DASHBOARD ==========
    async function renderComplianceDashboard(c) {
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      const next7Days = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
      const next30Days = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

      // Ensure secondary data is loaded (may not be ready on first render)
      let tickets = appData.tickets || [];
      let claims = appData.claims || [];
      let accidents = appData.accidents || [];
      let compTasks = appData.compliance_tasks || [];
      let driverFiles = appData.driver_files || [];
      let truckFiles = appData.truck_files || [];
      let companyFiles = appData.company_files || [];

      // Check if secondary data needs loading
      if (tickets.length === 0 && claims.length === 0 && accidents.length === 0 && compTasks.length === 0 && driverFiles.length === 0 && truckFiles.length === 0 && companyFiles.length === 0) {
        try {
          const [t, cl, acc, ct, df, tf, cf] = await Promise.all([
            dbFetch('tickets', { order: 'ticket_date.desc' }).catch(() => []),
            dbFetch('claims', { order: 'incident_date.desc' }).catch(() => []),
            dbFetch('accidents', { order: 'accident_date.desc' }).catch(() => []),
            dbFetch('compliance_tasks', { order: 'next_due_date.asc' }).catch(() => []),
            dbFetch('driver_files', { order: 'id.desc' }).catch(() => []),
            dbFetch('truck_files', { order: 'id.desc' }).catch(() => []),
            dbFetch('company_files', { order: 'id.desc' }).catch(() => [])
          ]);
          tickets = t || []; appData.tickets = tickets;
          claims = cl || []; appData.claims = claims;
          accidents = acc || []; appData.accidents = accidents;
          compTasks = ct || []; appData.compliance_tasks = compTasks;
          driverFiles = df || []; appData.driver_files = driverFiles;
          truckFiles = tf || []; appData.truck_files = truckFiles;
          companyFiles = cf || []; appData.company_files = companyFiles;
        } catch(e) { console.error('Failed to fetch compliance dashboard data:', e); }
      }
      
      // Stats
      const openTickets = tickets.filter(t => !['RESOLVED', 'DISMISSED'].includes(t.status)).length;
      const openClaims = claims.filter(cl => !['SETTLED', 'DENIED'].includes(cl.status)).length;
      
      // Days without accidents
      const lastAccident = accidents.sort((a, b) => (b.accident_date || '').localeCompare(a.accident_date || ''))[0];
      const daysWithoutAccident = lastAccident?.accident_date ? Math.floor((today - new Date(lastAccident.accident_date)) / (1000 * 60 * 60 * 24)) : 'N/A';
      
      // Upcoming driver tasks (file expirations)
      const driverTasks = [];
      appData.drivers.forEach(d => {
        const files = driverFiles.filter(f => f.driver_id === d.id && f.expiration_date);
        files.forEach(f => {
          const expDate = new Date(f.expiration_date);
          if (expDate >= today && expDate <= new Date(next7Days)) {
            driverTasks.push({ driver: d.first_name + ' ' + d.last_name, task: f.file_type.replace(/_/g, ' '), due: f.expiration_date });
          }
        });
      });
      
      // Driver birthdays in next 7 days
      const birthdays = appData.drivers.filter(d => {
        if (!d.date_of_birth) return false;
        const dob = new Date(d.date_of_birth);
        const thisYearBday = new Date(today.getFullYear(), dob.getMonth(), dob.getDate());
        const diff = Math.ceil((thisYearBday - today) / (1000 * 60 * 60 * 24));
        return diff >= 0 && diff <= 7;
      }).map(d => {
        const dob = new Date(d.date_of_birth);
        const thisYearBday = new Date(today.getFullYear(), dob.getMonth(), dob.getDate());
        return { driver: d.first_name + ' ' + d.last_name, date: thisYearBday.toISOString().split('T')[0] };
      });
      
      // Vehicle tasks (truck file expirations)
      const vehicleTasks = [];
      appData.trucks.forEach(t => {
        const files = truckFiles.filter(f => f.truck_id === t.id && f.expiration_date);
        files.forEach(f => {
          const expDate = new Date(f.expiration_date);
          if (expDate >= today && expDate <= new Date(next7Days)) {
            vehicleTasks.push({ unit: '#' + t.truck_number, task: f.file_type.replace(/_/g, ' '), due: f.expiration_date });
          }
        });
      });
      
      // Court dates in next 30 days
      const courtDates = tickets.filter(t => t.court_date && new Date(t.court_date) >= today && new Date(t.court_date) <= new Date(next30Days) && !['RESOLVED', 'DISMISSED'].includes(t.status))
        .map(t => {
          const driver = appData.drivers.find(d => d.id === t.driver_id);
          return { driver: driver ? driver.first_name + ' ' + driver.last_name : 'Unknown', date: t.court_date };
        });
      
      // Compliance tasks due in next 30 days
      const upcomingCompTasks = compTasks.filter(t => t.next_due_date && new Date(t.next_due_date) >= today && new Date(t.next_due_date) <= new Date(next30Days))
        .map(t => ({ task: t.task_name, due: t.next_due_date }));
      
      c.innerHTML = '<div class="card" style="margin-bottom:24px;background:linear-gradient(135deg,var(--blue),var(--blue));color:white;padding:24px"><h3 style="margin:0 0 16px"> Compliance Report</h3>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">' +
        '<div style="background:rgba(255,255,255,0.15);padding:20px;border-radius:12px;text-align:center"><div style="font-size:14px;opacity:0.9">Open Tickets</div><div style="font-size:36px;font-weight:700">' + openTickets + '</div></div>' +
        '<div style="background:rgba(255,255,255,0.15);padding:20px;border-radius:12px;text-align:center"><div style="font-size:14px;opacity:0.9">Open Claims</div><div style="font-size:36px;font-weight:700">' + openClaims + '</div></div>' +
        '<div style="background:rgba(255,255,255,0.15);padding:20px;border-radius:12px;text-align:center"><div style="font-size:14px;opacity:0.9">Days Without Accidents</div><div style="font-size:36px;font-weight:700;color:var(--primary-400)">' + daysWithoutAccident + '</div></div>' +
        '</div></div>' +
        
        // Grid of upcoming items
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px">' +
        
        // Driver Tasks
        '<div class="card"><div class="card-header"><h4 style="margin:0"> Driver Tasks (Next 7 Days)</h4></div><div style="padding:16px;max-height:200px;overflow-y:auto">' +
        (driverTasks.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:20px">No tasks due</div>' :
        driverTasks.map(t => '<div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-darker);border-radius:6px;margin-bottom:8px"><div><strong>' + t.driver + '</strong><br><span style="font-size:12px;color:var(--text-muted)">' + t.task + '</span></div><div style="font-size:12px;color:var(--amber)">' + formatDate(t.due) + '</div></div>').join('')) +
        '</div></div>' +
        
        // Birthdays
        '<div class="card"><div class="card-header"><h4 style="margin:0"> Birthdays (Next 7 Days)</h4></div><div style="padding:16px;max-height:200px;overflow-y:auto">' +
        (birthdays.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:20px">No birthdays this week</div>' :
        birthdays.map(b => '<div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-darker);border-radius:6px;margin-bottom:8px"><div><strong>' + b.driver + '</strong></div><div style="font-size:12px;color:var(--purple)">' + formatDate(b.date) + '</div></div>').join('')) +
        '</div></div>' +
        
        // Vehicle Tasks
        '<div class="card"><div class="card-header"><h4 style="margin:0"> Vehicle Tasks (Next 7 Days)</h4></div><div style="padding:16px;max-height:200px;overflow-y:auto">' +
        (vehicleTasks.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:20px">No tasks due</div>' :
        vehicleTasks.map(t => '<div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-darker);border-radius:6px;margin-bottom:8px"><div><strong>' + t.unit + '</strong><br><span style="font-size:12px;color:var(--text-muted)">' + t.task + '</span></div><div style="font-size:12px;color:var(--amber)">' + formatDate(t.due) + '</div></div>').join('')) +
        '</div></div>' +

        // Company Files Tasks
        (function() {
          const companyFileTasks = [];
          companyFiles.forEach(f => {
            if (f.expiration_date && f.category !== 'CUSTOM') {
              const expDate = new Date(f.expiration_date);
              const daysUntil = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
              if (daysUntil <= 7) {
                companyFileTasks.push({ doc: f.file_type.replace(/_/g, ' '), due: f.expiration_date, days: daysUntil });
              }
            }
          });
          return '<div class="card"><div class="card-header"><h4 style="margin:0"> Company Files (Next 7 Days)</h4></div><div style="padding:16px;max-height:200px;overflow-y:auto">' +
            (companyFileTasks.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:20px">No files expiring</div>' :
            companyFileTasks.map(t => '<div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-darker);border-radius:6px;margin-bottom:8px"><div><strong>' + t.doc + '</strong></div><div style="font-size:12px;color:' + (t.days < 0 ? 'var(--red)' : 'var(--green)') + '">' + (t.days < 0 ? 'EXPIRED' : formatDate(t.due)) + '</div></div>').join('')) +
            '</div></div>';
        })() +

        // Court Dates
        '<div class="card"><div class="card-header"><h4 style="margin:0"> Court Dates (Next 30 Days)</h4></div><div style="padding:16px;max-height:200px;overflow-y:auto">' +
        (courtDates.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:20px">No court dates found</div>' :
        courtDates.map(cd => '<div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-darker);border-radius:6px;margin-bottom:8px"><div><strong>' + cd.driver + '</strong></div><div style="font-size:var(--text-xs);color:var(--red)">' + formatDate(cd.date) + '</div></div>').join('')) +
        '</div></div>' +
        
        // Compliance Tasks
        '<div class="card"><div class="card-header"><h4 style="margin:0"> Compliance Tasks (Next 30 Days)</h4></div><div style="padding:16px;max-height:200px;overflow-y:auto">' +
        (upcomingCompTasks.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:20px">No tasks found</div>' :
        upcomingCompTasks.map(t => '<div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-darker);border-radius:6px;margin-bottom:8px"><div><strong>' + t.task + '</strong></div><div style="font-size:12px;color:var(--purple)">' + formatDate(t.due) + '</div></div>').join('')) +
        '</div></div>' +
        
        '</div>';
    }
    
    // ========== COMPLIANCE TASKS ==========
    async function renderComplianceTasks(c) {
      let tasks = appData.compliance_tasks || [];
      const today = new Date().toISOString().split('T')[0];

      // Ensure compliance_tasks is loaded
      if (tasks.length === 0) {
        try {
          tasks = await dbFetch('compliance_tasks', { order: 'next_due_date.asc' }) || [];
          appData.compliance_tasks = tasks;
        } catch(e) { console.error('Failed to fetch compliance_tasks:', e); }
      }
      
      // Default compliance tasks
      const defaultTasks = [
        { name: 'BOC-3 Form', frequency: 'ANNUALLY', description: 'Blanket of Coverage form filed with FMCSA' },
        { name: 'Biennial MCS-150 Update Filing', frequency: 'BIENNIALLY', description: 'Update company info every 2 years' },
        { name: 'Liability Insurance Renewal', frequency: 'ANNUALLY', description: 'Renew liability insurance policy' },
        { name: 'Accident Register', frequency: 'AS_NEEDED', description: 'Document all accidents within 30 days' },
        { name: 'Annual Report with SOS', frequency: 'ANNUALLY', description: 'Secretary of State annual report' },
        { name: 'UCR (Unified Carrier Registration)', frequency: 'ANNUALLY', description: 'Annual UCR registration' },
        { name: 'IFTA Quarterly Filing', frequency: 'QUARTERLY', description: 'File IFTA fuel tax returns' },
        { name: 'NM Quarterly Filing', frequency: 'QUARTERLY', description: 'New Mexico quarterly filing if applicable' },
        { name: 'Purchase NM Permits', frequency: 'ANNUALLY', description: 'New Mexico trip permits' },
        { name: 'Order IFTA Decals', frequency: 'ANNUALLY', description: 'Order new IFTA decals' },
        { name: 'Clearinghouse Annual Queries', frequency: 'ANNUALLY', description: 'Run annual queries on all drivers' },
        { name: 'IRP Renewal - Truck Registration', frequency: 'ANNUALLY', description: 'International Registration Plan renewal' },
        { name: 'Pay 2290 Heavy Vehicle Use Tax', frequency: 'ANNUALLY', description: 'Due by Aug 31 for tax year' },
        { name: 'Arkansas Ad Valorem (If Needed)', frequency: 'ANNUALLY', description: 'Arkansas property tax if applicable' },
        { name: 'Drug and Alcohol Random Consortium Renewal', frequency: 'ANNUALLY', description: 'Consortium membership renewal' }
      ];
      
      // IFTA due dates calculation
      const getIFTADueDates = () => {
        const year = new Date().getFullYear();
        return [
          { quarter: 'Q1', period: 'Jan-Mar', due: year + '-04-30' },
          { quarter: 'Q2', period: 'Apr-Jun', due: year + '-07-31' },
          { quarter: 'Q3', period: 'Jul-Sep', due: year + '-10-31' },
          { quarter: 'Q4', period: 'Oct-Dec', due: (year + 1) + '-01-31' }
        ];
      };
      
      const iftaDates = getIFTADueDates();
      const nextIFTA = iftaDates.find(d => d.due >= today) || iftaDates[0];
      
      c.innerHTML = '<div class="card" style="margin-bottom:24px;background:var(--blue-dim);padding:16px;border:1px solid var(--blue)"><strong> Next IFTA Filing:</strong> ' + nextIFTA.quarter + ' (' + nextIFTA.period + ') - Due: <strong>' + formatDate(nextIFTA.due) + '</strong></div>' +
        
        '<div class="card" style="margin-bottom:24px"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center"><h3> Compliance Tasks</h3><button class="btn btn-primary" onclick="openComplianceTaskModal()">+ Add Task</button></div>' +
        '<div class="table-wrapper"><table><thead><tr><th>Task</th><th>Frequency</th><th>Last Completed</th><th>Next Due</th><th>Status</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        (tasks.length === 0 ? '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-muted)">No tasks added. Click "+ Add Task" or use default tasks below.</td></tr>' :
        tasks.map(t => {
          const isOverdue = t.next_due_date && t.next_due_date < today;
          const isDueSoon = t.next_due_date && !isOverdue && t.next_due_date <= new Date(new Date().getTime() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
          return '<tr><td><strong>' + t.task_name + '</strong>' + (t.description ? '<br><span style="font-size:var(--text-xs);color:var(--text-muted)">' + t.description + '</span>' : '') + '</td>' +
            '<td><span class="badge badge-blue">' + (t.frequency || 'ANNUALLY') + '</span></td>' +
            '<td>' + (t.last_completed ? formatDate(t.last_completed) : '-') + '</td>' +
            '<td>' + (t.next_due_date ? formatDate(t.next_due_date) : '-') + '</td>' +
            '<td>' + (t.is_completed ? '<span class="badge badge-green"> Done</span>' : isOverdue ? '<span class="badge badge-red">OVERDUE</span>' : isDueSoon ? '<span class="badge badge-amber">Due Soon</span>' : '<span class="badge badge-gray">Pending</span>') + '</td>' +
            '<td class="sticky-col"><div class="actions"><button class="action-btn edit" onclick="markComplianceTaskDone(' + t.id + ')"> Done</button><button class="action-btn edit" onclick="openComplianceTaskModal(' + t.id + ')">Edit</button><button class="action-btn delete" onclick="deleteComplianceTask(' + t.id + ')">Del</button></div></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>' +
        
        // Default tasks helper
        '<div class="card"><div class="card-header"><h4> Standard Compliance Tasks Reference</h4></div><div class="table-wrapper"><table><thead><tr><th>Task</th><th>Frequency</th><th>Action</th></tr></thead><tbody>' +
        defaultTasks.map(dt => {
          const exists = tasks.find(t => t.task_name === dt.name);
          return '<tr><td><strong>' + dt.name + '</strong><br><span style="font-size:var(--text-xs);color:var(--text-muted)">' + dt.description + '</span></td><td><span class="badge badge-blue">' + dt.frequency + '</span></td><td>' + (exists ? '<span class="badge badge-green">Added</span>' : '<button class="btn btn-secondary btn-sm" onclick="addDefaultComplianceTask(\'' + dt.name.replace(/'/g, "\\'") + '\',\'' + dt.frequency + '\',\'' + dt.description.replace(/'/g, "\\'") + '\')">+ Add</button>') + '</td></tr>';
        }).join('') +
        '</tbody></table></div></div>';
    }
    
    function openComplianceTaskModal(id) {
      const t = id ? (appData.compliance_tasks || []).find(x => x.id === id) : null;
      const today = new Date().toISOString().split('T')[0];
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3>' + (t ? 'Edit' : 'Add') + ' Compliance Task</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div class="form-group"><label>Task Name *</label><input id="ctName" value="' + (t?.task_name || '') + '" placeholder="e.g., IFTA Quarterly Filing"></div>' +
        '<div class="form-group"><label>Description</label><input id="ctDesc" value="' + (t?.description || '') + '" placeholder="Brief description"></div>' +
        '<div class="form-row"><div class="form-group"><label>Frequency</label><select id="ctFreq"><option value="QUARTERLY"' + (t?.frequency === 'QUARTERLY' ? ' selected' : '') + '>Quarterly</option><option value="ANNUALLY"' + (!t || t?.frequency === 'ANNUALLY' ? ' selected' : '') + '>Annually</option><option value="BIENNIALLY"' + (t?.frequency === 'BIENNIALLY' ? ' selected' : '') + '>Biennially</option><option value="AS_NEEDED"' + (t?.frequency === 'AS_NEEDED' ? ' selected' : '') + '>As Needed</option></select></div><div class="form-group"><label>Next Due Date</label><input type="date" id="ctDue" value="' + (t?.next_due_date || '') + '"></div></div>' +
        '<div class="form-group"><label>Last Completed</label><input type="date" id="ctLast" value="' + (t?.last_completed || '') + '"></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveComplianceTask(' + (id || 'null') + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function saveComplianceTask(id) {
      const data = {
        task_name: document.getElementById('ctName').value,
        description: document.getElementById('ctDesc').value || null,
        frequency: document.getElementById('ctFreq').value,
        next_due_date: document.getElementById('ctDue').value || null,
        last_completed: document.getElementById('ctLast').value || null,
        is_completed: false
      };
      if (!data.task_name) { showToast('Task name required', 'error'); return; }
      try {
        if (id) { await dbUpdate('compliance_tasks', id, data); }
        else { await dbInsert('compliance_tasks', data); }
        document.querySelector('.modal-overlay').remove();
        showToast('Saved!');
        await loadAllData(true);
        renderCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    async function addDefaultComplianceTask(name, frequency, description) {
      try {
        await dbInsert('compliance_tasks', { task_name: name, frequency: frequency, description: description, is_completed: false });
        showToast('Task added!');
        await loadAllData(true);
        renderCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    async function markComplianceTaskDone(id) {
      const today = new Date().toISOString().split('T')[0];
      const task = (appData.compliance_tasks || []).find(t => t.id === id);
      if (!task) return;
      
      // Calculate next due date based on frequency
      let nextDue = null;
      const lastDate = new Date();
      if (task.frequency === 'QUARTERLY') {
        lastDate.setMonth(lastDate.getMonth() + 3);
        nextDue = lastDate.toISOString().split('T')[0];
      } else if (task.frequency === 'ANNUALLY') {
        lastDate.setFullYear(lastDate.getFullYear() + 1);
        nextDue = lastDate.toISOString().split('T')[0];
      } else if (task.frequency === 'BIENNIALLY') {
        lastDate.setFullYear(lastDate.getFullYear() + 2);
        nextDue = lastDate.toISOString().split('T')[0];
      }
      
      try {
        await dbUpdate('compliance_tasks', id, { last_completed: today, next_due_date: nextDue, is_completed: false });
        showToast('Marked complete!');
        await loadAllData(true);
        renderCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    async function deleteComplianceTask(id) {
      if (!confirm('Delete this task?')) return;
      try {
        await dbDelete('compliance_tasks', id);
        showToast('Deleted');
        await loadAllData(true);
        renderCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    // ========== DRIVER FILES TAB ==========
    async function renderComplianceDriverFiles(c) {
      const today = new Date();

      // Ensure driver_files is loaded
      let driverFilesData = appData.driver_files || [];
      if (driverFilesData.length === 0) {
        try {
          driverFilesData = await dbFetch('driver_files', { order: 'id.desc' }) || [];
          appData.driver_files = driverFilesData;
        } catch(e) { console.error('Failed to fetch driver_files:', e); }
      }

      // Alerts
      const alerts = [];
      appData.drivers.forEach(d => {
        const driverFiles = driverFilesData.filter(f => f.driver_id === d.id && f.expiration_date);
        driverFiles.forEach(f => {
          const expDate = new Date(f.expiration_date);
          const daysUntil = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
          if (daysUntil <= 7) {
            alerts.push({ name: d.first_name + ' ' + d.last_name, doc: f.file_type.replace(/_/g, ' '), days: daysUntil });
          }
        });
      });
      
      const alertsHtml = alerts.length > 0 ? '<div style="background:var(--red-dim);border:1px solid var(--red-dim);border-radius:8px;padding:16px;margin-bottom:24px"><strong style="color:var(--red)"> Expiring Soon (' + alerts.length + ')</strong><div style="margin-top:8px">' + alerts.slice(0, 5).map(a => '<span class="badge badge-amber" style="margin:4px">' + a.name + ' - ' + a.doc + ' (' + (a.days < 0 ? 'EXPIRED' : a.days + 'd') + ')</span>').join('') + '</div></div>' : '';
      
      c.innerHTML = alertsHtml +
        '<div class="card"><div class="table-wrapper"><table><thead><tr><th>Driver</th><th>CDL</th><th>Medical Card</th><th>MVR</th><th>PSP Report</th><th>Other</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        (appData.drivers.length === 0 ? '<tr><td colspan="7" style="text-align:center;padding:40px">No drivers</td></tr>' :
        appData.drivers.map(d => {
          const files = driverFilesData.filter(f => f.driver_id === d.id);
          const getStatus = (type) => {
            const file = files.find(f => f.file_type === type);
            if (!file) return '<span class="badge badge-gray">Missing</span>';
            if (!file.expiration_date) return '<span class="badge badge-green"></span>';
            const exp = new Date(file.expiration_date);
            const days = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
            if (days < 0) return '<span class="badge badge-red">Expired</span>';
            if (days <= 7) return '<span class="badge badge-amber">' + days + 'd</span>';
            return '<span class="badge badge-green"></span>';
          };
          const otherCount = files.filter(f => !['CDL', 'MEDICAL_CARD', 'MVR', 'PSP_REPORT'].includes(f.file_type)).length;
          return '<tr><td><strong>' + d.first_name + ' ' + d.last_name + '</strong></td><td>' + getStatus('CDL') + '</td><td>' + getStatus('MEDICAL_CARD') + '</td><td>' + getStatus('MVR') + '</td><td>' + getStatus('PSP_REPORT') + '</td><td>' + otherCount + '</td><td class="sticky-col"><button class="action-btn view" onclick="viewDriverProfile(' + d.id + ')">Manage</button></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }

    // ========== TRUCK FILES TAB ==========
    async function renderComplianceTruckFiles(c) {
      const today = new Date();

      // Ensure truck_files is loaded
      let truckFilesData = appData.truck_files || [];
      if (truckFilesData.length === 0) {
        try {
          truckFilesData = await dbFetch('truck_files', { order: 'id.desc' }) || [];
          appData.truck_files = truckFilesData;
        } catch(e) { console.error('Failed to fetch truck_files:', e); }
      }
      
      c.innerHTML = '<div class="card"><div class="table-wrapper"><table><thead><tr><th>Truck</th><th>Registration</th><th>Annual Insp</th><th>PA Insp</th><th>IRP</th><th>Insurance</th><th>Actions</th></tr></thead><tbody>' +
        (appData.trucks.length === 0 ? '<tr><td colspan="7" style="text-align:center;padding:40px">No trucks</td></tr>' :
        appData.trucks.map(t => {
          const files = truckFilesData.filter(f => f.truck_id === t.id);
          const getStatus = (type) => {
            const file = files.find(f => f.file_type === type);
            if (!file) return '<span class="badge badge-gray">-</span>';
            if (!file.expiration_date) return '<span class="badge badge-green"></span>';
            const exp = new Date(file.expiration_date);
            const days = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
            if (days < 0) return '<span class="badge badge-red">Exp</span>';
            if (days <= 7) return '<span class="badge badge-amber">' + days + 'd</span>';
            return '<span class="badge badge-green"></span>';
          };
          return '<tr><td><strong>#' + t.truck_number + '</strong></td><td>' + getStatus('VEHICLE_REGISTRATION') + '</td><td>' + getStatus('ANNUAL_INSPECTION') + '</td><td>' + getStatus('PA_INSPECTION') + '</td><td>' + getStatus('IRP_CAB_CARD') + '</td><td>' + getStatus('INSURANCE_CARD') + '</td><td><button class="action-btn view" onclick="viewTruckCompliance(' + t.id + ')">Manage</button></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }

    // ========== COMPANY FILES TAB ==========
    // Company file types configuration
    const COMPANY_FILE_TYPES = [
      { key: 'OPERATING_AUTHORITY', label: 'Operating Authority (MC/FF)', hasExpiry: true },
      { key: 'USDOT_REGISTRATION', label: 'USDOT Registration', hasExpiry: true },
      { key: 'LIABILITY_INSURANCE', label: 'General Liability Insurance', hasExpiry: true },
      { key: 'CARGO_INSURANCE', label: 'Cargo Insurance', hasExpiry: true },
      { key: 'BOC3', label: 'BOC-3 Filing', hasExpiry: false },
      { key: 'UCR_REGISTRATION', label: 'UCR Registration', hasExpiry: true },
      { key: 'IFTA_LICENSE', label: 'IFTA License', hasExpiry: true },
      { key: 'IRP_CREDENTIALS', label: 'IRP Credentials', hasExpiry: true }
    ];

    async function renderComplianceCompanyFiles(c) {
      const today = new Date();
      let files = appData.company_files || [];

      // If no files loaded yet, try fetching directly
      if (files.length === 0) {
        try {
          files = await dbFetch('company_files', { order: 'id.desc' }) || [];
          appData.company_files = files;
        } catch(e) { console.error('Failed to fetch company_files:', e); }
      }

      // Calculate alerts for expiring files
      const alerts = [];
      files.forEach(f => {
        if (f.expiration_date && f.category !== 'CUSTOM') {
          const expDate = new Date(f.expiration_date);
          const daysUntil = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
          if (daysUntil <= 7) {
            const fileType = COMPANY_FILE_TYPES.find(t => t.key === f.file_type);
            alerts.push({ doc: fileType?.label || f.file_type.replace(/_/g, ' '), days: daysUntil });
          }
        }
      });

      // Get custom folders
      const customFiles = files.filter(f => f.category === 'CUSTOM');
      const customFolders = [...new Set(customFiles.map(f => f.folder_name).filter(Boolean))];

      const alertsHtml = alerts.length > 0 ? '<div style="background:var(--red-dim);border:1px solid var(--red-dim);border-radius:8px;padding:16px;margin-bottom:24px"><strong style="color:var(--red)"> Expiring Soon (' + alerts.length + ')</strong><div style="margin-top:8px">' + alerts.slice(0, 5).map(a => '<span class="badge badge-amber" style="margin:4px">' + a.doc + ' (' + (a.days < 0 ? 'EXPIRED' : a.days + 'd') + ')</span>').join('') + '</div></div>' : '';

      // Build file status rows
      const getFileStatus = (fileType) => {
        const file = files.find(f => f.file_type === fileType.key && f.category !== 'CUSTOM');
        if (!file) return { status: '<span class="badge badge-gray">Missing</span>', expires: '-', hasFile: false, fileId: null };
        if (!file.expiration_date || !fileType.hasExpiry) return { status: '<span class="badge badge-green"></span>', expires: fileType.hasExpiry ? '-' : 'N/A', hasFile: true, fileId: file.id };
        const exp = new Date(file.expiration_date);
        const days = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
        let statusBadge;
        if (days < 0) statusBadge = '<span class="badge badge-red">EXPIRED</span>';
        else if (days <= 7) statusBadge = '<span class="badge badge-amber">' + days + 'd</span>';
        else statusBadge = '<span class="badge badge-green"></span>';
        return { status: statusBadge, expires: formatDate(file.expiration_date), hasFile: true, fileId: file.id };
      };

      c.innerHTML = alertsHtml +
        '<div class="card" style="margin-bottom:24px"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center"><h3> Company Qualification Files</h3></div>' +
        '<div class="table-wrapper"><table><thead><tr><th>Document</th><th>Status</th><th>Expires</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        COMPANY_FILE_TYPES.map(ft => {
          const status = getFileStatus(ft);
          return '<tr><td><strong>' + ft.label + '</strong></td><td>' + status.status + '</td><td>' + status.expires + '</td><td class="sticky-col">' +
            (status.hasFile ?
              '<div class="actions"><button class="action-btn view" onclick="viewCompanyFile(' + status.fileId + ')">View</button><button class="action-btn delete" onclick="deleteCompanyFile(' + status.fileId + ')">Del</button></div>' :
              '<button class="action-btn edit" onclick="openCompanyFileUploadModal(\'' + ft.key + '\', ' + ft.hasExpiry + ')">Upload</button>') +
            '</td></tr>';
        }).join('') +
        '</tbody></table></div></div>' +

        // Custom Folders Section
        '<div class="card"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center"><h3> Custom Folders</h3><button class="btn btn-primary btn-sm" onclick="openCompanyFolderModal()">+ New Folder</button></div>' +
        '<div style="padding:16px">' +
        (customFolders.length === 0 ? '<div style="text-align:center;color:var(--text-muted);padding:20px">No custom folders. Click "+ New Folder" to create one.</div>' :
        customFolders.map(folder => {
          const folderFiles = customFiles.filter(f => f.folder_name === folder);
          return '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-darker);border-radius:8px;margin-bottom:8px"><div><strong> ' + folder + '</strong><span style="margin-left:8px;font-size:12px;color:var(--text-muted)">(' + folderFiles.length + ' file' + (folderFiles.length !== 1 ? 's' : '') + ')</span></div><div class="actions"><button class="action-btn view" onclick="viewCompanyFolder(\'' + folder.replace(/'/g, "\\'") + '\')">Manage</button></div></div>';
        }).join('')) +
        '</div></div>';
    }

    // View a company file (opens in new tab)
    function viewCompanyFile(fileId) {
      const file = (appData.company_files || []).find(f => f.id === fileId);
      if (!file) { showToast('File not found', 'error'); return; }

      const w = window.open('', '_blank');
      if (file.file_data.startsWith('data:application/pdf') || file.file_data.startsWith('data:image')) {
        w.document.write('<html><head><title>' + file.file_name + '</title></head><body style="margin:0"><iframe src="' + file.file_data + '" style="width:100%;height:100vh;border:none"></iframe></body></html>');
      } else {
        w.document.write('<html><head><title>' + file.file_name + '</title><style>body{font-family:system-ui;padding:40px;max-width:600px;margin:0 auto}</style></head><body><h2>' + file.file_name + '</h2><p><strong>Type:</strong> ' + file.file_type.replace(/_/g, ' ') + '</p>' + (file.notes ? '<p><strong>Notes:</strong> ' + file.notes + '</p>' : '') + (file.expiration_date ? '<p><strong>Expires:</strong> ' + formatDate(file.expiration_date) + '</p>' : '') + '<a href="' + file.file_data + '" download="' + file.file_name + '" style="display:inline-block;padding:10px 20px;background:var(--blue);color:white;text-decoration:none;border-radius:6px;margin-top:20px">Download File</a></body></html>');
      }
      w.document.close();
    }

    // Delete a company file
    async function deleteCompanyFile(fileId) {
      if (!confirm('Delete this file?')) return;
      try {
        await dbDelete('company_files', fileId);
        showToast('File deleted');
        await loadAllData(true);
        renderCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    // Upload modal for company files
    function openCompanyFileUploadModal(fileType, hasExpiry) {
      const fileTypeInfo = COMPANY_FILE_TYPES.find(t => t.key === fileType);
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3>Upload ' + (fileTypeInfo?.label || fileType.replace(/_/g, ' ')) + '</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div class="form-group"><label>File *</label><input type="file" id="companyFileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"></div>' +
        '<div class="form-group"><label>Notes</label><input id="companyFileNotes" placeholder="Optional notes"></div>' +
        (hasExpiry ? '<div class="form-group"><label>Expiration Date</label><input type="date" id="companyFileExpiry"></div>' : '') +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="uploadCompanyFile(\'' + fileType + '\', ' + hasExpiry + ')">Upload</button></div></div>';
      document.body.appendChild(m);
    }

    // Upload company file
    async function uploadCompanyFile(fileType, hasExpiry) {
      const fileInput = document.getElementById('companyFileInput');
      const notes = document.getElementById('companyFileNotes')?.value || null;
      const expiry = hasExpiry ? document.getElementById('companyFileExpiry')?.value || null : null;

      if (!fileInput.files.length) { showToast('Please select a file', 'error'); return; }

      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = {
            file_type: fileType,
            category: 'QUALIFICATION',
            file_name: file.name,
            file_data: e.target.result,
            notes: notes,
            expiration_date: expiry
          };
          await dbInsert('company_files', data);
          document.querySelector('.modal-overlay').remove();
          showToast('File uploaded!');
          await loadAllData(true);
          renderCompliance(document.getElementById('main-content'));
        } catch (err) { showToast('Error: ' + err.message, 'error'); }
      };
      reader.readAsDataURL(file);
    }

    // Create new custom folder modal
    function openCompanyFolderModal() {
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:400px"><div class="modal-header"><h3>Create Custom Folder</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div class="form-group"><label>Folder Name *</label><input id="companyFolderName" placeholder="e.g., Contracts, Permits, Agreements"></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="createCompanyFolder()">Create & Upload File</button></div></div>';
      document.body.appendChild(m);
    }

    // Create folder and open file upload
    function createCompanyFolder() {
      const folderName = document.getElementById('companyFolderName')?.value?.trim();
      if (!folderName) { showToast('Please enter a folder name', 'error'); return; }
      document.querySelector('.modal-overlay').remove();
      openCompanyCustomFileUpload(folderName);
    }

    // Upload to custom folder modal
    function openCompanyCustomFileUpload(folderName) {
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3>Upload to: ' + folderName + '</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div class="form-group"><label>File *</label><input type="file" id="customCompanyFileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"></div>' +
        '<div class="form-group"><label>File Label/Type</label><input id="customCompanyFileType" placeholder="e.g., Service Agreement, Permit"></div>' +
        '<div class="form-group"><label>Notes</label><input id="customCompanyFileNotes" placeholder="Optional notes"></div>' +
        '<div class="form-group"><label>Expiration Date (optional)</label><input type="date" id="customCompanyFileExpiry"></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="uploadCompanyCustomFile(\'' + folderName.replace(/'/g, "\\'") + '\')">Upload</button></div></div>';
      document.body.appendChild(m);
    }

    // Upload custom folder file
    async function uploadCompanyCustomFile(folderName) {
      const fileInput = document.getElementById('customCompanyFileInput');
      const fileType = document.getElementById('customCompanyFileType')?.value || 'CUSTOM_FILE';
      const notes = document.getElementById('customCompanyFileNotes')?.value || null;
      const expiry = document.getElementById('customCompanyFileExpiry')?.value || null;

      if (!fileInput.files.length) { showToast('Please select a file', 'error'); return; }

      const file = fileInput.files[0];
      const reader = new FileReader();
      reader.onload = async function(e) {
        try {
          const data = {
            file_type: fileType.toUpperCase().replace(/\s+/g, '_'),
            category: 'CUSTOM',
            folder_name: folderName,
            file_name: file.name,
            file_data: e.target.result,
            notes: notes,
            expiration_date: expiry || null
          };
          await dbInsert('company_files', data);
          document.querySelector('.modal-overlay').remove();
          showToast('File uploaded!');
          await loadAllData(true);
          renderCompliance(document.getElementById('main-content'));
        } catch (err) { showToast('Error: ' + err.message, 'error'); }
      };
      reader.readAsDataURL(file);
    }

    // View files in a custom folder
    function viewCompanyFolder(folderName) {
      const today = new Date();
      const files = (appData.company_files || []).filter(f => f.category === 'CUSTOM' && f.folder_name === folderName);

      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:700px"><div class="modal-header"><h3> ' + folderName + '</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body" style="max-height:60vh;overflow-y:auto">' +
        '<div style="margin-bottom:16px"><button class="btn btn-primary btn-sm" onclick="this.closest(\'.modal-overlay\').remove();openCompanyCustomFileUpload(\'' + folderName.replace(/'/g, "\\'") + '\')">+ Add File</button></div>' +
        (files.length === 0 ? '<div style="text-align:center;padding:40px;color:var(--text-muted)">No files in this folder</div>' :
        '<table style="width:100%"><thead><tr><th>File</th><th>Type</th><th>Expires</th><th>Actions</th></tr></thead><tbody>' +
        files.map(f => {
          let expStatus = '-';
          if (f.expiration_date) {
            const exp = new Date(f.expiration_date);
            const days = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
            if (days < 0) expStatus = '<span class="badge badge-red">EXPIRED</span>';
            else if (days <= 7) expStatus = '<span class="badge badge-amber">' + days + 'd</span>';
            else expStatus = formatDate(f.expiration_date);
          }
          return '<tr><td><strong>' + f.file_name + '</strong>' + (f.notes ? '<br><span style="font-size:var(--text-xs);color:var(--text-muted)">' + f.notes + '</span>' : '') + '</td><td>' + f.file_type.replace(/_/g, ' ') + '</td><td>' + expStatus + '</td><td><div class="actions"><button class="action-btn view" onclick="viewCompanyFile(' + f.id + ')">View</button><button class="action-btn delete" onclick="deleteCompanyFileFromFolder(' + f.id + ',\'' + folderName.replace(/'/g, "\\'") + '\')">Del</button></div></td></tr>';
        }).join('') +
        '</tbody></table>') +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Close</button></div></div>';
      document.body.appendChild(m);
    }

    // Delete file from folder view (refreshes folder view)
    async function deleteCompanyFileFromFolder(fileId, folderName) {
      if (!confirm('Delete this file?')) return;
      try {
        await dbDelete('company_files', fileId);
        showToast('File deleted');
        await loadAllData(true);
        document.querySelector('.modal-overlay').remove();
        viewCompanyFolder(folderName);
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    // ========== DRIVER COMPLIANCE (TICKETS/VIOLATIONS/CLAIMS) ==========
    async function renderComplianceDriverSection(c) {
      // Render the driver compliance content here (reuse from driver_compliance page)
      dcTab = dcTab || 'tickets';
      let tickets = appData.tickets || [];
      let violations = appData.violations || [];
      let claims = (appData.claims || []).filter(cl => cl.driver_id);

      // Ensure secondary data is loaded (may not be ready on first render)
      if (tickets.length === 0 && violations.length === 0 && claims.length === 0) {
        try {
          const [t, v, cl] = await Promise.all([
            dbFetch('tickets', { order: 'ticket_date.desc' }),
            dbFetch('violations', { order: 'violation_date.desc' }),
            dbFetch('claims', { order: 'incident_date.desc' })
          ]);
          tickets = t || [];
          violations = v || [];
          claims = (cl || []).filter(c => c.driver_id);
          appData.tickets = tickets;
          appData.violations = violations;
          appData.claims = cl || [];
        } catch(e) { console.error('Failed to fetch driver compliance data:', e); }
      }
      
      c.innerHTML = '<div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap">' +
        '<button class="btn ' + (dcTab === 'tickets' ? 'btn-primary' : 'btn-secondary') + '" onclick="dcTab=\'tickets\';renderCompliance(document.getElementById(\'main-content\'))"> Tickets (' + tickets.length + ')</button>' +
        '<button class="btn ' + (dcTab === 'violations' ? 'btn-primary' : 'btn-secondary') + '" style="' + (dcTab === 'violations' ? 'background:var(--purple);border-color:var(--purple)' : '') + '" onclick="dcTab=\'violations\';renderCompliance(document.getElementById(\'main-content\'))"> Violations (' + violations.length + ')</button>' +
        '<button class="btn ' + (dcTab === 'claims' ? 'btn-primary' : 'btn-secondary') + '" style="' + (dcTab === 'claims' ? 'background:var(--amber);border-color:var(--amber)' : '') + '" onclick="dcTab=\'claims\';renderCompliance(document.getElementById(\'main-content\'))"> Claims (' + claims.length + ')</button>' +
        '<div style="margin-left:auto;display:flex;gap:8px">' +
        '<button class="btn btn-primary btn-sm" onclick="openTicketModal()">+ Ticket</button>' +
        '<button class="btn btn-sm" style="background:var(--purple);border-color:var(--purple);color:white" onclick="openViolationModal()">+ Violation</button>' +
        '<button class="btn btn-sm" style="background:var(--amber);border-color:var(--amber);color:white" onclick="openClaimModal()">+ Claim</button>' +
        '</div></div>' +
        '<div id="dcSubContent"></div>';
      
      const subContent = document.getElementById('dcSubContent');
      if (dcTab === 'tickets') renderTicketsTab(subContent);
      else if (dcTab === 'violations') renderViolationsTab(subContent);
      else renderClaimsTab(subContent);
    }
    
    // ========== ACCIDENT REGISTRY ==========
    async function renderAccidentRegistry(c) {
      let accidents = appData.accidents || [];

      // Ensure accidents data is loaded
      if (accidents.length === 0) {
        try {
          accidents = await dbFetch('accidents', { order: 'accident_date.desc' }) || [];
          appData.accidents = accidents;
        } catch(e) { console.error('Failed to fetch accidents:', e); }
      }

      c.innerHTML = '<div class="card"><div class="card-header" style="display:flex;justify-content:space-between;align-items:center"><h3> Accident Registry</h3><button class="btn btn-primary" onclick="openAccidentModal()">+ Log Accident</button></div>' +
        '<div class="table-wrapper"><table><thead><tr><th>Date/Time</th><th>Driver</th><th>Type</th><th>Location</th><th>Deaths</th><th>Injuries</th><th>HAZMAT</th><th>Drug Test</th><th>Report</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        (accidents.length === 0 ? '<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-muted)">No accidents recorded </td></tr>' :
        accidents.sort((a, b) => (b.accident_date || '').localeCompare(a.accident_date || '')).map(a => {
          const driver = appData.drivers.find(d => d.id === a.driver_id);
          return '<tr>' +
            '<td>' + (a.accident_date ? formatDate(a.accident_date) : '-') + (a.accident_time ? '<br><span style="font-size:var(--text-xs);color:var(--text-muted)">' + a.accident_time + '</span>' : '') + '</td>' +
            '<td><strong>' + (driver ? driver.first_name + ' ' + driver.last_name : '-') + '</strong></td>' +
            '<td><span class="badge badge-gray">' + (a.accident_type || '-') + '</span></td>' +
            '<td style="max-width:150px;font-size:12px">' + [a.street_address, a.city, a.state].filter(Boolean).join(', ') + '</td>' +
            '<td style="text-align:center;color:' + (a.num_deaths > 0 ? 'var(--red)' : 'inherit') + '">' + (a.num_deaths || 0) + '</td>' +
            '<td style="text-align:center;color:' + (a.num_injuries > 0 ? 'var(--amber)' : 'inherit') + '">' + (a.num_injuries || 0) + '</td>' +
            '<td>' + (a.hazmat_involved ? '<span class="badge badge-red">YES</span>' : '<span class="badge badge-gray">NO</span>') + '</td>' +
            '<td>' + getDrugTestBadge(a.drug_test_result) + '</td>' +
            '<td>' + (a.report_filed ? '<span class="badge badge-green">Filed</span>' : '<span class="badge badge-gray">-</span>') + '</td>' +
            '<td class="sticky-col"><div class="actions"><button class="action-btn edit" onclick="openAccidentModal(' + a.id + ')">Edit</button><button class="action-btn delete" onclick="deleteAccident(' + a.id + ')">Del</button></div></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }
    
    function getDrugTestBadge(result) {
      if (!result) return '<span class="badge badge-gray">N/A</span>';
      const badges = {
        'NEGATIVE': '<span class="badge badge-green">NEGATIVE</span>',
        'POSITIVE': '<span class="badge badge-red">POSITIVE</span>',
        'PENDING': '<span class="badge badge-amber">PENDING</span>',
        'NOT_REQUIRED': '<span class="badge badge-gray">Not Req</span>'
      };
      return badges[result] || '<span class="badge badge-gray">' + result + '</span>';
    }
    
    function openAccidentModal(id) {
      const a = id ? (appData.accidents || []).find(x => x.id === id) : null;
      const today = new Date().toISOString().split('T')[0];
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:650px"><div class="modal-header"><h3> ' + (a ? 'Edit' : 'Log') + ' Accident</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body" style="max-height:70vh;overflow-y:auto">' +
        
        '<div class="form-row"><div class="form-group"><label>Driver *</label><select id="accDriver"><option value="">Select Driver</option>' +
        appData.drivers.map(d => '<option value="' + d.id + '"' + (a?.driver_id === d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('') +
        '</select></div><div class="form-group"><label>Accident Type</label><select id="accType"><option value="">Select Type</option><option value="Collision"' + (a?.accident_type === 'Collision' ? ' selected' : '') + '>Collision</option><option value="Rollover"' + (a?.accident_type === 'Rollover' ? ' selected' : '') + '>Rollover</option><option value="Jackknife"' + (a?.accident_type === 'Jackknife' ? ' selected' : '') + '>Jackknife</option><option value="Cargo Spill"' + (a?.accident_type === 'Cargo Spill' ? ' selected' : '') + '>Cargo Spill</option><option value="Hit and Run"' + (a?.accident_type === 'Hit and Run' ? ' selected' : '') + '>Hit and Run</option><option value="Other"' + (a?.accident_type === 'Other' ? ' selected' : '') + '>Other</option></select></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Accident Date *</label><input type="date" id="accDate" value="' + (a?.accident_date || today) + '"></div><div class="form-group"><label>Time</label><input type="time" id="accTime" value="' + (a?.accident_time || '') + '"></div></div>' +
        
        '<h4 style="margin:16px 0 8px;padding-top:12px;border-top:1px solid var(--border)"> Location</h4>' +
        '<div class="form-group"><label>Street Address</label><input id="accStreet" value="' + (a?.street_address || '') + '" placeholder="123 Main St"></div>' +
        '<div class="form-row"><div class="form-group"><label>City</label><input id="accCity" value="' + (a?.city || '') + '"></div><div class="form-group"><label>State</label><input id="accState" value="' + (a?.state || '') + '" maxlength="2" placeholder="PA"></div></div>' +
        
        '<h4 style="margin:16px 0 8px;padding-top:12px;border-top:1px solid var(--border)"> Incident Details</h4>' +
        '<div class="form-row"><div class="form-group"><label>No. of Deaths</label><input type="number" id="accDeaths" value="' + (a?.num_deaths || 0) + '" min="0"></div><div class="form-group"><label>No. of Injuries</label><input type="number" id="accInjuries" value="' + (a?.num_injuries || 0) + '" min="0"></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>HAZMAT Involved?</label><select id="accHazmat"><option value="false"' + (!a?.hazmat_involved ? ' selected' : '') + '>No</option><option value="true"' + (a?.hazmat_involved ? ' selected' : '') + '>Yes</option></select></div><div class="form-group"><label>Report Filed?</label><select id="accReport"><option value="false"' + (!a?.report_filed ? ' selected' : '') + '>No</option><option value="true"' + (a?.report_filed ? ' selected' : '') + '>Yes</option></select></div></div>' +
        
        '<div class="form-group"><label>Drug/Alcohol Test Result</label><select id="accDrug"><option value="">Select</option><option value="NOT_REQUIRED"' + (a?.drug_test_result === 'NOT_REQUIRED' ? ' selected' : '') + '>Not Required</option><option value="PENDING"' + (a?.drug_test_result === 'PENDING' ? ' selected' : '') + '>Pending</option><option value="NEGATIVE"' + (a?.drug_test_result === 'NEGATIVE' ? ' selected' : '') + '>Negative</option><option value="POSITIVE"' + (a?.drug_test_result === 'POSITIVE' ? ' selected' : '') + '>Positive</option></select></div>' +
        
        '<div class="form-group"><label>Notes</label><textarea id="accNotes" rows="2" placeholder="Additional details...">' + (a?.notes || '') + '</textarea></div>' +
        
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveAccident(' + (id || 'null') + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function saveAccident(id) {
      const driverId = parseInt(document.getElementById('accDriver').value);
      if (!driverId) { showToast('Please select a driver', 'error'); return; }
      
      const data = {
        driver_id: driverId,
        accident_type: document.getElementById('accType').value || null,
        accident_date: document.getElementById('accDate').value || null,
        accident_time: document.getElementById('accTime').value || null,
        street_address: document.getElementById('accStreet').value || null,
        city: document.getElementById('accCity').value || null,
        state: document.getElementById('accState').value || null,
        num_deaths: parseInt(document.getElementById('accDeaths').value) || 0,
        num_injuries: parseInt(document.getElementById('accInjuries').value) || 0,
        hazmat_involved: document.getElementById('accHazmat').value === 'true',
        report_filed: document.getElementById('accReport').value === 'true',
        drug_test_result: document.getElementById('accDrug').value || null,
        notes: document.getElementById('accNotes').value || null
      };
      
      try {
        if (id) { await dbUpdate('accidents', id, data); }
        else { await dbInsert('accidents', data); }
        document.querySelector('.modal-overlay').remove();
        showToast('Accident saved!');
        await loadAllData(true);
        renderCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    async function deleteAccident(id) {
      if (!confirm('Delete this accident record?')) return;
      try {
        await dbDelete('accidents', id);
        showToast('Deleted');
        await loadAllData(true);
        renderCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    function renderComplianceDrivers() {
      const today = new Date();
      return '<div class="table-wrapper"><table><thead><tr><th>Driver</th><th>CDL</th><th>Medical Card</th><th>MVR</th><th>PSP Report</th><th>Other Files</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        (appData.drivers.length === 0 ? '<tr><td colspan="7" style="text-align:center;padding:40px">No drivers yet</td></tr>' :
        appData.drivers.map(d => {
          const files = (appData.driver_files || []).filter(f => f.driver_id === d.id);
          const getStatus = (type) => {
            const file = files.find(f => f.file_type === type);
            if (!file) return '<span class="badge badge-gray">Missing</span>';
            if (!file.expiration_date) return '<span class="badge badge-green"></span>';
            const exp = new Date(file.expiration_date);
            const days = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
            if (days < 0) return '<span class="badge badge-red">Expired</span>';
            if (days <= 7) return '<span class="badge badge-amber">' + days + 'd</span>';
            return '<span class="badge badge-green"></span>';
          };
          const otherCount = files.filter(f => !['CDL', 'MEDICAL_CARD', 'MVR', 'PSP_REPORT'].includes(f.file_type)).length;
          return '<tr><td><strong>' + d.first_name + ' ' + d.last_name + '</strong></td><td>' + getStatus('CDL') + '</td><td>' + getStatus('MEDICAL_CARD') + '</td><td>' + getStatus('MVR') + '</td><td>' + getStatus('PSP_REPORT') + '</td><td>' + otherCount + ' files</td><td class="sticky-col"><button class="action-btn view" onclick="viewDriverProfile(' + d.id + ')">Manage</button></td></tr>';
        }).join('')) +
        '</tbody></table></div>';
    }

    function renderComplianceTrucks() {
      const today = new Date();
      return '<div class="table-wrapper"><table><thead><tr><th>Truck</th><th>Registration</th><th>Annual Inspection</th><th>PA Inspection</th><th>Actions</th></tr></thead><tbody>' +
        (appData.trucks.length === 0 ? '<tr><td colspan="5" style="text-align:center;padding:40px">No trucks yet</td></tr>' :
        appData.trucks.map(t => {
          const files = (appData.truck_files || []).filter(f => f.truck_id === t.id);
          const getStatus = (type) => {
            const file = files.find(f => f.file_type === type);
            if (!file) return '<span class="badge badge-gray">Missing</span>';
            if (!file.expiration_date) return '<span class="badge badge-green"></span>';
            const exp = new Date(file.expiration_date);
            const days = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
            if (days < 0) return '<span class="badge badge-red">Expired</span>';
            if (days <= 7) return '<span class="badge badge-amber">' + days + 'd</span>';
            return '<span class="badge badge-green"></span>';
          };
          return '<tr><td><strong>#' + t.truck_number + '</strong><br><span style="color:var(--text-muted);font-size:12px">' + t.truck_type + '</span></td><td>' + getStatus('VEHICLE_REGISTRATION') + '</td><td>' + getStatus('ANNUAL_INSPECTION') + '</td><td>' + getStatus('PA_INSPECTION') + '</td><td><button class="action-btn view" onclick="viewTruckCompliance(' + t.id + ')">Manage</button></td></tr>';
        }).join('')) +
        '</tbody></table></div>';
    }

    function viewTruckCompliance(truckId) {
      // Mark that we're viewing a truck detail (prevents background re-renders)
      currentDetailView = { type: 'truck', id: truckId };

      const t = appData.trucks.find(x => x.id === truckId);
      if (!t) {
        // Truck was deleted or not found - go back to list
        currentDetailView = null;
        renderTrucks(document.getElementById('main-content'));
        return;
      }
      const truckFiles = (appData.truck_files || []).filter(f => f.truck_id === truckId);
      const complianceFiles = truckFiles.filter(f => f.category !== 'CUSTOM');
      const customFiles = truckFiles.filter(f => f.category === 'CUSTOM');
      const customFolders = [...new Set(customFiles.map(f => f.folder_name || 'Uncategorized'))];
      const today = new Date();
      
      const truckFileTypes = [
        { type: 'VEHICLE_REGISTRATION', hasExpiry: true },
        { type: 'ANNUAL_INSPECTION', hasExpiry: true },
        { type: 'PA_INSPECTION', hasExpiry: true },
        { type: 'INSURANCE_CARD', hasExpiry: true },
        { type: 'TITLE', hasExpiry: false },
        { type: 'LEASE_AGREEMENT', hasExpiry: true },
        { type: 'IRP_CAB_CARD', hasExpiry: true },
        { type: 'IFTA_PERMIT', hasExpiry: true }
      ];
      
      const formatFileType = (t) => t.replace(/_/g, ' ');
      
      const getExpiryBadge = (file) => {
        if (!file || !file.expiration_date) return '';
        const expDate = new Date(file.expiration_date);
        const daysUntil = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
        if (daysUntil < 0) return '<span class="badge badge-red">EXPIRED</span>';
        if (daysUntil === 0) return '<span class="badge badge-red">EXPIRES TODAY</span>';
        if (daysUntil <= 3) return '<span class="badge badge-red">Expires in ' + daysUntil + 'd</span>';
        if (daysUntil <= 7) return '<span class="badge badge-amber">Expires in ' + daysUntil + 'd</span>';
        return '<span class="badge badge-green">Valid until ' + formatDate(file.expiration_date) + '</span>';
      };
      
      const c = document.getElementById('main-content');
      
      // Get maintenance records for this truck
      const maintenanceRecords = (appData.maintenance_records || []).filter(m => m.truck_id === truckId);
      const totalMaintenanceCost = maintenanceRecords.reduce((s, m) => s + parseFloat(m.total_cost || 0), 0);
      
      c.innerHTML = '<div class="header"><div style="display:flex;align-items:center;gap:16px"><button class="btn btn-secondary" onclick="renderCompliance(document.getElementById(\'main-content\'))"> Back</button><h2> Truck #' + t.truck_number + ' Compliance Files</h2><span class="badge ' + getBadge(t.status) + '">' + t.status + '</span></div></div>' +
        
        // Stats
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px"><div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Truck Type</div><div class="value" style="font-size:14px">' + t.truck_type + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px"><div class="label">Capacity</div><div class="value">' + t.capacity + ' cars</div></div><div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Documents</div><div class="value">' + complianceFiles.length + '/' + truckFileTypes.length + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:130px;padding:12px 16px"><div class="label">Maintenance Records</div><div class="value">' + maintenanceRecords.length + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:140px;padding:12px 16px;background:var(--red-dim)"><div class="label">Total Maintenance Cost</div><div class="value" style="color:var(--red)">' + formatMoney(totalMaintenanceCost) + '</div></div><div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px;background:var(--blue-dim)"><div class="label">Custom Folders</div><div class="value" style="color:var(--blue)">' + customFolders.length + '</div></div></div>' +
        
        // Truck Files Section
        '<div class="card" style="margin-bottom:24px"><div class="card-header" style="background:var(--amber);color:white;border-radius:8px 8px 0 0"><h3 style="margin:0"> Truck Compliance Files</h3></div><div class="table-wrapper"><table><thead><tr><th>Document Type</th><th>Status</th><th>Expiration</th><th>Uploaded</th><th>Actions</th></tr></thead><tbody>' +
        truckFileTypes.map(ft => {
          const file = complianceFiles.find(f => f.file_type === ft.type);
          return '<tr><td><strong>' + formatFileType(ft.type) + '</strong></td><td>' + (file ? '<span class="badge badge-green"> Uploaded</span>' : '<span class="badge badge-gray">Missing</span>') + '</td><td>' + (ft.hasExpiry ? (file ? getExpiryBadge(file) : '<span style="color:var(--text-muted)">-</span>') : '<span style="color:var(--text-muted)">N/A</span>') + '</td><td>' + (file ? formatDate(file.created_at) : '-') + '</td><td><div class="actions">' + (file ? '<button class="action-btn view" onclick="viewTruckFile(' + file.id + ')">View</button><button class="action-btn delete" onclick="deleteTruckFile(' + file.id + ',' + truckId + ')">Del</button>' : '<button class="action-btn edit" onclick="openUploadTruckFileModal(' + truckId + ',\'' + ft.type + '\',' + ft.hasExpiry + ')">Upload</button>') + '</div></td></tr>';
        }).join('') +
        '</tbody></table></div></div>' +
        
        // Custom Folders Section
        '<div class="card" style="margin-bottom:24px"><div class="card-header" style="background:var(--blue);color:white;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0"> Custom Folders</h3><button class="btn" style="background:var(--bg-card);color:var(--blue);padding:6px 12px;font-size:13px" onclick="openCustomFolderModal(' + truckId + ',\'truck\')">+ New Folder</button></div>' +
        (customFolders.length === 0 ? '<div style="padding:40px;text-align:center;color:var(--text-muted)">No custom folders yet. Click "+ New Folder" to create one.</div>' :
        '<div style="padding:16px">' +
        customFolders.map(folder => {
          const folderFiles = customFiles.filter(f => (f.folder_name || 'Uncategorized') === folder);
          return '<div style="margin-bottom:16px;border:1px solid var(--bg-elevated);border-radius:8px"><div style="background:var(--blue-dim);padding:12px 16px;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center"><strong> ' + folder + ' (' + folderFiles.length + ' files)</strong><button class="action-btn edit" onclick="openCustomFileUpload(' + truckId + ',\'' + folder.replace(/'/g, "\\'") + '\',\'truck\')">+ Add File</button></div>' +
            '<div class="table-wrapper"><table><thead><tr><th>File Name</th><th>Type</th><th>Uploaded</th><th>Notes</th><th>Actions</th></tr></thead><tbody>' +
            folderFiles.map(f => '<tr><td>' + f.file_name + '</td><td>' + (f.file_type || '-') + '</td><td>' + formatDate(f.created_at) + '</td><td>' + (f.notes || '-') + '</td><td><div class="actions"><button class="action-btn view" onclick="viewTruckFile(' + f.id + ')">View</button><button class="action-btn delete" onclick="deleteTruckFile(' + f.id + ',' + truckId + ')">Del</button></div></td></tr>').join('') +
            '</tbody></table></div></div>';
        }).join('') +
        '</div>') +
        '</div>' +
        
        // Maintenance Records Section
        '<div class="card"><div class="card-header" style="background:var(--green);color:white;border-radius:8px 8px 0 0;display:flex;justify-content:space-between;align-items:center"><h3 style="margin:0"> Maintenance Records</h3><button class="btn" style="background:var(--bg-card);color:var(--green);padding:8px 16px" onclick="openMaintenanceModal(' + truckId + ')">+ Add Service Record</button></div>' +
        (maintenanceRecords.length === 0 ? '<div style="padding:40px;text-align:center;color:var(--text-muted)">No maintenance records yet. Add a service record or upload an invoice.</div>' :
        '<div class="table-wrapper"><table><thead><tr><th>Date</th><th>Service Type</th><th>Shop</th><th>Description</th><th>Odometer</th><th>Cost</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        maintenanceRecords.map(m => '<tr><td>' + formatDate(m.service_date) + '</td><td><span class="badge badge-blue">' + (m.service_type || '-') + '</span></td><td>' + (m.shop_name || '-') + '</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + (m.description || '-') + '</td><td>' + (m.odometer ? m.odometer.toLocaleString() + ' mi' : '-') + '</td><td class="money">' + formatMoney(m.total_cost) + '</td><td class="sticky-col"><div class="actions">' + (m.invoice_file ? '<button class="action-btn view" onclick="viewMaintenanceInvoice(' + m.id + ')">Invoice</button>' : '') + '<button class="action-btn edit" onclick="openMaintenanceModal(' + truckId + ',' + m.id + ')">Edit</button><button class="action-btn delete" onclick="deleteMaintenanceRecord(' + m.id + ',' + truckId + ')">Del</button></div></td></tr>').join('') +
        '</tbody></table></div>') +
        '</div>';
    }

    function openUploadTruckFileModal(truckId, fileType, hasExpiry) {
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:450px"><div class="modal-header"><h3> Upload ' + fileType.replace(/_/g, ' ') + '</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div class="form-group"><label>File (PDF, Image, etc.)</label><input type="file" id="truckFileUpload" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"></div>' +
        '<div class="form-group"><label>Notes (Optional)</label><input id="truckFileNotes" placeholder="Any additional notes..."></div>' +
        (hasExpiry ? '<div class="form-group"><label>Expiration Date</label><input type="date" id="truckFileExpiry"></div><div style="background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius);font-size:13px;color:var(--amber)"> You will receive reminders at 7 days, 3 days, 1 day, and on expiration date.</div>' : '') +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="uploadTruckFile(' + truckId + ',\'' + fileType + '\',' + hasExpiry + ')">Upload</button></div></div>';
      document.body.appendChild(m);
    }

    async function uploadTruckFile(truckId, fileType, hasExpiry) {
      const fileInput = document.getElementById('truckFileUpload');
      const notes = document.getElementById('truckFileNotes').value;
      const expiry = hasExpiry ? document.getElementById('truckFileExpiry').value : null;
      
      if (!fileInput.files || fileInput.files.length === 0) {
        showToast('Please select a file', 'error');
        return;
      }
      
      const file = fileInput.files[0];
      const reader = new FileReader();
      
      reader.onload = async function(e) {
        const fileData = e.target.result;
        
        const data = {
          truck_id: truckId,
          file_type: fileType,
          file_name: file.name,
          file_data: fileData,
          notes: notes || null,
          expiration_date: expiry || null
        };
        
        try {
          await dbInsert('truck_files', data);
          document.querySelector('.modal-overlay').remove();
          showToast('File uploaded successfully!');
          await loadAllData(true);
          viewTruckCompliance(truckId);
        } catch (e) {
          showToast('Upload failed: ' + e.message, 'error');
        }
      };
      
      reader.readAsDataURL(file);
    }

    function viewTruckFile(fileId) {
      const file = appData.truck_files.find(f => f.id === fileId);
      if (!file || !file.file_data) {
        showToast('File not found', 'error');
        return;
      }
      
      const win = window.open();
      if (file.file_data.startsWith('data:application/pdf') || file.file_data.startsWith('data:image')) {
        win.document.write('<iframe src="' + file.file_data + '" style="width:100%;height:100%;border:none"></iframe>');
      } else {
        win.document.write('<html><body><h2>' + file.file_name + '</h2><p>File type: ' + file.file_type.replace(/_/g, ' ') + '</p><p>Notes: ' + (file.notes || 'None') + '</p><a href="' + file.file_data + '" download="' + file.file_name + '">Download File</a></body></html>');
      }
    }

    async function deleteTruckFile(fileId, truckId) {
      if (!confirm('Delete this file?')) return;
      try {
        await dbDelete('truck_files', fileId);
        showToast('File deleted');
        await loadAllData(true);
        viewTruckCompliance(truckId);
      } catch (e) {
        showToast('Delete failed: ' + e.message, 'error');
      }
    }

    // ============ MAINTENANCE RECORDS ============
    const maintenanceServiceTypes = [
      'Oil & Filter Change',
      'Air Filter Change',
      'Fuel Filter Change',
      'Transmission Fluid & Filter',
      'Engine Coolant',
      'Cooling System Flush',
      'Tire Repair or Replacement',
      'Tire',
      'Rotation or Balance',
      'Hose',
      'Replacement',
      'Brake Repair',
      'Engine',
      'Tune-Up',
      'Front End Alignment',
      'Power Steering / Brake Fluid',
      'A/C or Heater Repair',
      'Replace Belts',
      'Electrical Repairs',
      'Battery Replacement',
      'Battery Cables / Terminals',
      'Headlights or Light Bulbs',
      'Windshield Wiper Blades',
      'Wash & Wax',
      'Miscellaneous Service',
      'DOT Inspection',
      'Annual Inspection',
      'Trailer Repair',
      'Suspension',
      'Exhaust System',
      'DEF System',
      'EGR/DPF Service'
    ];

    function openMaintenanceModal(truckId, recordId = null) {
      const record = recordId ? appData.maintenance_records.find(m => m.id === recordId) : null;
      if (!truckId && record) truckId = record.truck_id;
      const hasApiKey = !!getApiKey();
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      
      const truckSelector = !truckId ? '<div class="form-group"><label>Truck *</label><select id="maintTruckSelect"><option value="">Select Truck</option>' + appData.trucks.map(t => '<option value="' + t.id + '">' + t.truck_number + '</option>').join('') + '</select></div>' : '';
      
      m.innerHTML = '<div class="modal" style="max-width:550px;max-height:90vh;overflow-y:auto"><div class="modal-header"><h3> ' + (record ? 'Edit' : 'Add') + ' Maintenance Record</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        
        // Upload Invoice Section
        '<div style="background:var(--blue-dim);padding:var(--spacing-4);border-radius:var(--radius);margin-bottom:16px"><strong style="color:var(--blue)"> ' + (hasApiKey ? 'Upload Invoice to Auto-Fill' : 'Attach Invoice') + '</strong><p style="font-size:13px;color:var(--blue);margin:8px 0 12px 0">' + (hasApiKey ? 'Upload shop invoice (PDF or image) and AI will extract the details' : 'Upload shop invoice to keep on record') + '</p><input type="file" id="maintenanceInvoice" accept=".pdf,.jpg,.jpeg,.png"><div id="invoicePreview" style="margin-top:8px"></div>' + (hasApiKey ? '<button type="button" id="extractBtn" class="btn btn-primary" style="display:none;margin-top:12px;background:var(--green)" onclick="extractInvoiceData(' + (truckId || 'null') + ')"> Extract Invoice Data</button>' : '') + '</div>' +
        
        '<div id="extractingStatus" style="display:none;background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:16px;text-align:center"><span style="color:var(--amber)"> Reading invoice... Please wait...</span></div>' +
        
        truckSelector +
        
        '<div class="form-row"><div class="form-group"><label>Service Date *</label><input type="date" id="maintDate" value="' + (record?.service_date || new Date().toISOString().split('T')[0]) + '"></div><div class="form-group"><label>Odometer</label><input type="number" id="maintOdometer" value="' + (record?.odometer || '') + '" placeholder="e.g., 125000"></div></div>' +
        
        '<div class="form-group"><label>Service Type *</label><select id="maintType"><option value="">Select Service Type</option>' + maintenanceServiceTypes.map(st => '<option value="' + st + '"' + (record?.service_type === st ? ' selected' : '') + '>' + st + '</option>').join('') + '</select></div>' +
        
        '<div class="form-group"><label>Shop Name</label><input id="maintShop" value="' + (record?.shop_name || '') + '" placeholder="e.g., Love\'s Truck Care"></div>' +
        
        '<div class="form-group"><label>Description / Work Performed</label><textarea id="maintDesc" rows="5" placeholder="Detailed list of all services performed, parts replaced, work done...">' + (record?.description || '') + '</textarea></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Parts Cost</label><input type="number" step="0.01" id="maintParts" value="' + (record?.parts_cost || '') + '" placeholder="0.00"></div><div class="form-group"><label>Labor Cost</label><input type="number" step="0.01" id="maintLabor" value="' + (record?.labor_cost || '') + '" placeholder="0.00"></div><div class="form-group"><label>Total Cost *</label><input type="number" step="0.01" id="maintTotal" value="' + (record?.total_cost || '') + '" placeholder="0.00"></div></div>' +
        
        '<div class="form-group"><label>Notes</label><input id="maintNotes" value="' + (record?.notes || '') + '" placeholder="Any additional notes..."></div>' +
        
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveMaintenanceRecord(' + (truckId || 'null') + ',' + recordId + ')">Save</button></div></div>';
      
      document.body.appendChild(m);
      
      // Show file name and extract button when selected
      document.getElementById('maintenanceInvoice').addEventListener('change', function() {
        const preview = document.getElementById('invoicePreview');
        const extractBtn = document.getElementById('extractBtn');
        this.dataset.aiScanned = 'false'; // Reset scan status
        if (this.files && this.files[0]) {
          preview.innerHTML = '<span style="color:var(--green)"> ' + this.files[0].name + ' selected</span><br><span style="font-size:var(--text-xs);color:var(--text-muted)"> Invoice will be saved with record</span>';
          if (extractBtn) extractBtn.style.display = 'inline-block';
        } else {
          preview.innerHTML = '';
          if (extractBtn) extractBtn.style.display = 'none';
        }
      });
      
      // Auto-calculate total when parts/labor change
      document.getElementById('maintParts').addEventListener('input', calcMaintenanceTotal);
      document.getElementById('maintLabor').addEventListener('input', calcMaintenanceTotal);
    }

    async function extractInvoiceData(truckId) {
      const fileInput = document.getElementById('maintenanceInvoice');
      const apiKey = getApiKey();
      
      if (!apiKey) {
        showToast('API key not configured. Go to Settings.', 'error');
        return;
      }
      
      if (!fileInput.files || !fileInput.files[0]) {
        showToast('Please select an invoice file first', 'error');
        return;
      }
      
      const file = fileInput.files[0];
      const statusDiv = document.getElementById('extractingStatus');
      const extractBtn = document.getElementById('extractBtn');
      
      // Show loading
      statusDiv.style.display = 'block';
      extractBtn.disabled = true;
      extractBtn.textContent = ' Extracting...';
      
      try {
        // Convert file to base64
        const base64Data = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.onerror = () => reject(new Error('Failed to read file'));
          reader.readAsDataURL(file);
        });
        
        // Determine media type
        let mediaType = 'image/jpeg';
        if (file.type === 'image/png') {
          mediaType = 'image/png';
        } else if (file.type === 'image/jpeg' || file.type === 'image/jpg') {
          mediaType = 'image/jpeg';
        } else if (file.type === 'application/pdf') {
          mediaType = 'application/pdf';
        }
        
        // Build content array
        const content = [];
        if (mediaType === 'application/pdf') {
          content.push({
            type: 'document',
            source: { type: 'base64', media_type: mediaType, data: base64Data }
          });
        } else {
          content.push({
            type: 'image',
            source: { type: 'base64', media_type: mediaType, data: base64Data }
          });
        }
        content.push({
          type: 'text',
          text: 'Extract ALL information from this truck/vehicle repair invoice. Return ONLY valid JSON (no markdown):\n\n{"truck_number":"string - look for Unit #, Truck #, Vehicle #, Equipment #, or any identifying number","shop_name":"string - the repair shop/service center name","service_date":"YYYY-MM-DD - invoice date or service date","odometer":number|null - mileage/odometer reading,"service_type":"string - main category of service","services_performed":"string - LIST ALL individual services, parts, and work items performed (be detailed, include everything listed)","description":"string - brief summary","parts_cost":number|null,"labor_cost":number|null,"total_cost":number - grand total}\n\nFor service_type use the BEST match from: Oil & Filter Change, Brake Repair, Tire Repair or Replacement, Engine, Transmission Fluid & Filter, Electrical Repairs, DOT Inspection, Annual Inspection, Suspension, A/C or Heater Repair, Trailer Repair, DEF System, EGR/DPF Service, Miscellaneous Service\n\nIMPORTANT: For services_performed, list EVERY line item of work done, parts replaced, and services rendered. Be thorough.'
        });
        
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1000,
            messages: [{ role: 'user', content: content }]
          })
        });
        
        const data = await response.json();
        console.log('API Response:', data);
        
        if (data.error) {
          throw new Error(data.error.message || 'API Error');
        }
        
        if (data.content && data.content[0] && data.content[0].text) {
          let jsonText = data.content[0].text.trim();
          jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
          
          const extracted = JSON.parse(jsonText);
          console.log('Extracted data:', extracted);
          
          // Fill in the form fields
          if (extracted.shop_name) document.getElementById('maintShop').value = extracted.shop_name;
          if (extracted.service_date) document.getElementById('maintDate').value = extracted.service_date;
          if (extracted.odometer) document.getElementById('maintOdometer').value = extracted.odometer;
          
          // Use detailed services_performed if available, otherwise use description
          const detailedDesc = extracted.services_performed || extracted.description || '';
          document.getElementById('maintDesc').value = detailedDesc;
          
          if (extracted.parts_cost) document.getElementById('maintParts').value = parseFloat(extracted.parts_cost).toFixed(2);
          if (extracted.labor_cost) document.getElementById('maintLabor').value = parseFloat(extracted.labor_cost).toFixed(2);
          if (extracted.total_cost) document.getElementById('maintTotal').value = parseFloat(extracted.total_cost).toFixed(2);
          
          // Try to match truck number from invoice to trucks in system
          if (extracted.truck_number) {
            const truckSelect = document.getElementById('maintTruckSelect');
            if (truckSelect) {
              const invoiceTruckNum = extracted.truck_number.toString().replace(/[^0-9]/g, '');
              let matched = false;
              for (let i = 0; i < truckSelect.options.length; i++) {
                const optVal = truckSelect.options[i].text.replace(/[^0-9]/g, '');
                if (optVal && invoiceTruckNum && (optVal === invoiceTruckNum || optVal.includes(invoiceTruckNum) || invoiceTruckNum.includes(optVal))) {
                  truckSelect.selectedIndex = i;
                  matched = true;
                  break;
                }
              }
              if (matched) {
                showToast(' Matched truck #' + extracted.truck_number + ' from invoice!');
              } else {
                showToast(' Truck #' + extracted.truck_number + ' found on invoice - please select manually', 'error');
              }
            }
          }
          
          // Match service type
          if (extracted.service_type) {
            const typeSelect = document.getElementById('maintType');
            const searchType = extracted.service_type.toLowerCase();
            for (let i = 0; i < typeSelect.options.length; i++) {
              const optVal = typeSelect.options[i].value.toLowerCase();
              if (optVal === searchType || optVal.includes(searchType) || searchType.includes(optVal)) {
                typeSelect.selectedIndex = i;
                break;
              }
            }
          }
          
          // Mark invoice as scanned - it will be auto-saved with the record
          fileInput.dataset.aiScanned = 'true';
          
          // Update preview to show it will be saved
          const preview = document.getElementById('invoicePreview');
          preview.innerHTML = '<span style="color:var(--green)"> ' + file.name + '</span><br><span style="font-size:11px;color:var(--green);background:var(--green-dim);padding:2px 8px;border-radius:4px;margin-top:4px;display:inline-block"> Invoice will be saved with record</span>';
          
          showToast(' Invoice data extracted! Invoice will be saved automatically.');
        } else {
          throw new Error('Could not extract data from response');
        }
        
      } catch (error) {
        console.error('Extract error:', error);
        showToast('Could not read invoice: ' + error.message, 'error');
      } finally {
        statusDiv.style.display = 'none';
        extractBtn.disabled = false;
        extractBtn.textContent = ' Extract Invoice Data';
      }
    }

    function calcMaintenanceTotal() {
      const parts = parseFloat(document.getElementById('maintParts').value) || 0;
      const labor = parseFloat(document.getElementById('maintLabor').value) || 0;
      const totalInput = document.getElementById('maintTotal');
      // Only auto-calculate if total is empty or was auto-calculated before
      if (!totalInput.value || totalInput.dataset.autoCalc === 'true') {
        totalInput.value = (parts + labor).toFixed(2);
        totalInput.dataset.autoCalc = 'true';
      }
    }
    
    // Mark total as manually entered when user types
    document.addEventListener('input', function(e) {
      if (e.target && e.target.id === 'maintTotal') {
        e.target.dataset.autoCalc = 'false';
      }
    });

    async function saveMaintenanceRecord(truckId, recordId) {
      if (!truckId) {
        const truckSelect = document.getElementById('maintTruckSelect');
        if (truckSelect) {
          truckId = parseInt(truckSelect.value);
          if (!truckId) { showToast('Please select a truck', 'error'); return; }
        }
      }
      
      const serviceDate = document.getElementById('maintDate').value;
      const serviceType = document.getElementById('maintType').value;
      const totalCost = parseFloat(document.getElementById('maintTotal').value) || 0;
      
      if (!serviceDate) { showToast('Please enter service date', 'error'); return; }
      if (!serviceType) { showToast('Please select service type', 'error'); return; }
      if (!totalCost) { showToast('Please enter total cost', 'error'); return; }
      
      const data = {
        truck_id: truckId,
        service_date: serviceDate,
        service_type: serviceType,
        shop_name: document.getElementById('maintShop').value || null,
        description: document.getElementById('maintDesc').value || null,
        odometer: parseInt(document.getElementById('maintOdometer').value) || null,
        parts_cost: parseFloat(document.getElementById('maintParts').value) || 0,
        labor_cost: parseFloat(document.getElementById('maintLabor').value) || 0,
        total_cost: totalCost,
        notes: document.getElementById('maintNotes').value || null
      };
      
      // Handle invoice file upload
      const invoiceInput = document.getElementById('maintenanceInvoice');
      if (invoiceInput.files && invoiceInput.files[0]) {
        const file = invoiceInput.files[0];
        const reader = new FileReader();
        
        reader.onload = async function(e) {
          data.invoice_file = e.target.result;
          data.invoice_filename = file.name;
          await doSaveMaintenanceRecord(truckId, recordId, data);
        };
        reader.readAsDataURL(file);
      } else {
        await doSaveMaintenanceRecord(truckId, recordId, data);
      }
    }

    async function doSaveMaintenanceRecord(truckId, recordId, data) {
      try {
        const hasInvoice = !!data.invoice_file;
        const truck = appData.trucks.find(t => t.id === truckId);
        if (recordId) {
          await dbUpdate('maintenance_records', recordId, data);
          await logActivity('MAINTENANCE_UPDATED', { record_id: recordId, truck_id: truckId, truck_number: truck?.truck_number, service_type: data.service_type, total_cost: data.total_cost });
        } else {
          const newRecord = await dbInsert('maintenance_records', data);
          await logActivity('MAINTENANCE_CREATED', { record_id: newRecord.id, truck_id: truckId, truck_number: truck?.truck_number, service_type: data.service_type, total_cost: data.total_cost, shop: data.shop_name });
        }
        document.querySelector('.modal-overlay').remove();
        showToast(hasInvoice ? ' Maintenance record saved with invoice!' : 'Maintenance record saved!');
        await loadAllData(true);
        // Stay on current page - if on maintenance page, refresh it; otherwise go to truck compliance
        if (currentPage === 'maintenance') {
          renderMaintenance(document.getElementById('main-content'));
        } else if (truckId && typeof viewTruckCompliance === 'function') {
          viewTruckCompliance(truckId);
        }
      } catch (e) {
        showToast('Save failed: ' + e.message, 'error');
      }
    }

    function viewMaintenanceInvoice(recordId) {
      const record = appData.maintenance_records.find(m => m.id === recordId);
      if (!record || !record.invoice_file) {
        showToast('Invoice not found', 'error');
        return;
      }
      
      const win = window.open();
      if (record.invoice_file.startsWith('data:application/pdf') || record.invoice_file.startsWith('data:image')) {
        win.document.write('<iframe src="' + record.invoice_file + '" style="width:100%;height:100%;border:none"></iframe>');
      } else {
        win.document.write('<html><body><h2>' + (record.invoice_filename || 'Invoice') + '</h2><a href="' + record.invoice_file + '" download="' + (record.invoice_filename || 'invoice') + '">Download File</a></body></html>');
      }
    }

    async function deleteMaintenanceRecord(recordId, truckId) {
      if (!confirm('Delete this maintenance record?')) return;
      try {
        const record = appData.maintenance_records.find(m => m.id === recordId);
        const truck = appData.trucks.find(t => t.id === truckId);
        await dbDelete('maintenance_records', recordId);
        await logActivity('MAINTENANCE_DELETED', { record_id: recordId, truck_id: truckId, truck_number: truck?.truck_number, service_type: record?.service_type, total_cost: record?.total_cost });
        showToast('Record deleted');
        await loadAllData(true);
        if (truckId && typeof viewTruckCompliance === 'function') {
          viewTruckCompliance(truckId);
        } else if (currentPage === 'maintenance') {
          renderMaintenance(document.getElementById('main-content'));
        }
      } catch (e) {
        showToast('Delete failed: ' + e.message, 'error');
      }
    }

    // ============ DRIVER COMPLIANCE (TICKETS, VIOLATIONS & CLAIMS) ============
    let dcTab = 'tickets'; // 'tickets', 'violations', or 'claims'
    let dcFilterStatus = '';
    let dcFilterDriver = '';
    
    function renderDriverCompliance(c) {
      const tickets = appData.tickets || [];
      const violations = appData.violations || [];
      const claims = (appData.claims || []).filter(cl => cl.driver_id); // Only driver-assigned claims
      const today = new Date().toISOString().split('T')[0];
      
      // Combined stats
      const openTickets = tickets.filter(t => ['OPEN', 'IN_PROGRESS', 'ATTORNEY_HIRED', 'PENDING_COURT', 'PENDING_DATAQ'].includes(t.status)).length;
      const openViolations = violations.filter(v => ['OPEN', 'IN_PROGRESS', 'PENDING_REVIEW'].includes(v.status)).length;
      const openClaims = claims.filter(cl => ['OPEN', 'UNDER_REVIEW'].includes(cl.status)).length;
      const resolvedTickets = tickets.filter(t => ['RESOLVED', 'DISMISSED'].includes(t.status)).length;
      const resolvedViolations = violations.filter(v => ['RESOLVED', 'DISMISSED'].includes(v.status)).length;
      
      // Financial impact of claims
      const totalClaimsPaid = claims.filter(cl => cl.status === 'SETTLED' && cl.fault_party === 'DRIVER')
        .reduce((s, cl) => s + parseFloat(cl.settlement_amount || cl.claim_amount || 0), 0);
      
      // Upcoming court dates
      const upcomingCourt = tickets.filter(t => t.court_date && t.court_date >= today && !['RESOLVED', 'DISMISSED'].includes(t.status))
        .sort((a, b) => a.court_date.localeCompare(b.court_date));
      
      c.innerHTML = '<div class="header"><h2> Driver Compliance</h2><div style="display:flex;gap:12px;flex-wrap:wrap">' +
        '<button class="btn btn-primary" onclick="openTicketModal()">+ Ticket</button>' +
        '<button class="btn btn-secondary" style="background:var(--purple);border-color:var(--purple);color:white" onclick="openViolationModal()">+ Violation</button>' +
        '<button class="btn btn-secondary" style="background:var(--amber);border-color:var(--amber);color:white" onclick="openClaimModal()">+ Claim</button>' +
        '</div></div>' +
        
        // Stats
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="border-left:4px solid var(--red)"><div class="label">Open Tickets</div><div class="value" style="color:var(--red)">' + openTickets + '</div></div>' +
        '<div class="stat-card" style="border-left:4px solid var(--purple)"><div class="label">Open Violations</div><div class="value" style="color:var(--purple)">' + openViolations + '</div></div>' +
        '<div class="stat-card" style="border-left:4px solid var(--amber)"><div class="label">Open Claims</div><div class="value" style="color:var(--amber)">' + openClaims + '</div></div>' +
        '<div class="stat-card" style="border-left:4px solid var(--green)"><div class="label">Resolved</div><div class="value" style="color:var(--green)">' + (resolvedTickets + resolvedViolations) + '</div></div>' +
        (totalClaimsPaid > 0 ? '<div class="stat-card" style="border-left:4px solid var(--red);background:var(--red-dim)"><div class="label">Driver Claims Paid</div><div class="value" style="color:var(--red)">' + formatMoney(totalClaimsPaid) + '</div></div>' : '') +
        '</div>' +
        
        // Upcoming Court Dates Alert
        (upcomingCourt.length > 0 ? '<div class="card" style="margin-bottom:24px;background:linear-gradient(135deg,var(--amber-dim),var(--amber-dim));border:1px solid var(--amber)"><div class="card-header" style="background:transparent"><h3 style="color:var(--amber)"> Upcoming Court Dates</h3></div><div style="padding:16px">' +
        upcomingCourt.slice(0, 5).map(t => {
          const driver = appData.drivers.find(d => d.id === t.driver_id);
          const driverName = driver ? driver.first_name + ' ' + driver.last_name : 'Unknown';
          const daysUntil = Math.ceil((new Date(t.court_date) - new Date(today)) / (1000 * 60 * 60 * 24));
          return '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg-card);border-radius:8px;margin-bottom:8px">' +
            '<div><strong>' + driverName + '</strong><div style="font-size:12px;color:var(--text-muted)">' + (t.ticket_description || 'No description') + '</div></div>' +
            '<div style="text-align:right"><div style="font-weight:600;color:' + (daysUntil <= 3 ? 'var(--red)' : daysUntil <= 7 ? 'var(--amber)' : 'var(--green)') + '">' + formatDate(t.court_date) + '</div>' +
            '<div style="font-size:12px;color:var(--text-muted)">' + (daysUntil === 0 ? 'TODAY!' : daysUntil === 1 ? 'Tomorrow' : daysUntil + ' days') + '</div></div></div>';
        }).join('') + '</div></div>' : '') +
        
        // Tabs
        '<div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap">' +
        '<button class="btn ' + (dcTab === 'tickets' ? 'btn-primary' : 'btn-secondary') + '" onclick="dcTab=\'tickets\';renderDriverCompliance(document.getElementById(\'main-content\'))"> Tickets (' + tickets.length + ')</button>' +
        '<button class="btn ' + (dcTab === 'violations' ? 'btn-primary' : 'btn-secondary') + '" style="' + (dcTab === 'violations' ? 'background:var(--purple);border-color:var(--purple)' : '') + '" onclick="dcTab=\'violations\';renderDriverCompliance(document.getElementById(\'main-content\'))"> Violations (' + violations.length + ')</button>' +
        '<button class="btn ' + (dcTab === 'claims' ? 'btn-primary' : 'btn-secondary') + '" style="' + (dcTab === 'claims' ? 'background:var(--amber);border-color:var(--amber)' : '') + '" onclick="dcTab=\'claims\';renderDriverCompliance(document.getElementById(\'main-content\'))"> Claims (' + claims.length + ')</button>' +
        '</div>' +
        
        '<div id="dcTabContent"></div>';
      
      const tabContent = document.getElementById('dcTabContent');
      if (dcTab === 'tickets') renderTicketsTab(tabContent);
      else if (dcTab === 'violations') renderViolationsTab(tabContent);
      else renderClaimsTab(tabContent);
    }
    
    function renderTicketsTab(c) {
      const tickets = appData.tickets || [];
      let filtered = tickets;
      if (dcFilterStatus) filtered = filtered.filter(t => t.status === dcFilterStatus);
      if (dcFilterDriver) filtered = filtered.filter(t => t.driver_id == dcFilterDriver);
      
      c.innerHTML = '<div class="card" style="padding:16px;margin-bottom:20px"><div style="display:flex;gap:16px;align-items:end;flex-wrap:wrap">' +
        '<div class="form-group" style="margin:0;min-width:150px"><label style="margin-bottom:4px">Status</label><select onchange="dcFilterStatus=this.value;renderDriverCompliance(document.getElementById(\'main-content\'))">' +
        '<option value="">All Statuses</option>' +
        '<option value="OPEN"' + (dcFilterStatus === 'OPEN' ? ' selected' : '') + '>Open</option>' +
        '<option value="IN_PROGRESS"' + (dcFilterStatus === 'IN_PROGRESS' ? ' selected' : '') + '>In Progress</option>' +
        '<option value="ATTORNEY_HIRED"' + (dcFilterStatus === 'ATTORNEY_HIRED' ? ' selected' : '') + '>Attorney Hired</option>' +
        '<option value="PENDING_COURT"' + (dcFilterStatus === 'PENDING_COURT' ? ' selected' : '') + '>Pending Court</option>' +
        '<option value="PENDING_DATAQ"' + (dcFilterStatus === 'PENDING_DATAQ' ? ' selected' : '') + '>Pending DataQ</option>' +
        '<option value="RESOLVED"' + (dcFilterStatus === 'RESOLVED' ? ' selected' : '') + '>Resolved</option>' +
        '<option value="DISMISSED"' + (dcFilterStatus === 'DISMISSED' ? ' selected' : '') + '>Dismissed</option>' +
        '</select></div>' +
        '<div class="form-group" style="margin:0;min-width:150px"><label style="margin-bottom:4px">Driver</label><select onchange="dcFilterDriver=this.value;renderDriverCompliance(document.getElementById(\'main-content\'))">' +
        '<option value="">All Drivers</option>' +
        appData.drivers.map(d => '<option value="' + d.id + '"' + (dcFilterDriver == d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('') +
        '</select></div>' +
        ((dcFilterStatus || dcFilterDriver) ? '<button class="btn btn-secondary" onclick="dcFilterStatus=\'\';dcFilterDriver=\'\';renderDriverCompliance(document.getElementById(\'main-content\'))"> Clear</button>' : '') +
        '<div style="margin-left:auto;font-size:13px;color:var(--text-muted)">' + filtered.length + ' of ' + tickets.length + ' tickets</div>' +
        '</div></div>' +
        
        '<div class="card"><div class="card-header"><h3> Tickets</h3></div><div class="table-wrapper"><table><thead><tr>' +
        '<th>Driver</th><th>Date</th><th>Description</th><th>Status</th><th>Court Date</th><th>Attorney</th><th>Court Decision</th><th>DataQ</th><th>Files</th><th class="sticky-col">Actions</th>' +
        '</tr></thead><tbody>' +
        (filtered.length === 0 ? '<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-muted)">No tickets found</td></tr>' :
        filtered.sort((a, b) => (b.ticket_date || '').localeCompare(a.ticket_date || '')).map(t => {
          const driver = appData.drivers.find(d => d.id === t.driver_id);
          const driverName = driver ? driver.first_name + ' ' + driver.last_name : '<span style="color:var(--red)">Unknown</span>';
          const files = (appData.ticket_files || []).filter(f => f.ticket_id === t.id);
          
          return '<tr>' +
            '<td><strong>' + driverName + '</strong></td>' +
            '<td>' + (t.ticket_date ? formatDate(t.ticket_date) : '-') + '</td>' +
            '<td style="max-width:180px">' + (t.ticket_description || '-') + '</td>' +
            '<td>' + getTicketStatusBadge(t.status) + '</td>' +
            '<td>' + (t.court_date ? formatDate(t.court_date) : '-') + '</td>' +
            '<td style="max-width:120px;font-size:12px">' + (t.attorney_info || '-') + '</td>' +
            '<td>' + (t.court_decision ? getCourtDecisionBadge(t.court_decision) : '-') + '</td>' +
            '<td>' + (t.dataq_decision ? getDataQBadge(t.dataq_decision) : '-') + '</td>' +
            '<td><button class="btn btn-secondary btn-sm" onclick="openTicketFilesModal(' + t.id + ')"> ' + files.length + '</button></td>' +
            '<td class="sticky-col"><div class="actions">' +
            '<button class="action-btn edit" onclick="openTicketModal(' + t.id + ')">Edit</button>' +
            '<button class="action-btn delete" onclick="deleteTicket(' + t.id + ')">Del</button>' +
            '</div></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }
    
    function renderViolationsTab(c) {
      const violations = appData.violations || [];
      let filtered = violations;
      if (dcFilterStatus) filtered = filtered.filter(v => v.status === dcFilterStatus);
      if (dcFilterDriver) filtered = filtered.filter(v => v.driver_id == dcFilterDriver);
      
      c.innerHTML = '<div class="card" style="padding:16px;margin-bottom:20px"><div style="display:flex;gap:16px;align-items:end;flex-wrap:wrap">' +
        '<div class="form-group" style="margin:0;min-width:150px"><label style="margin-bottom:4px">Status</label><select onchange="dcFilterStatus=this.value;renderDriverCompliance(document.getElementById(\'main-content\'))">' +
        '<option value="">All Statuses</option>' +
        '<option value="OPEN"' + (dcFilterStatus === 'OPEN' ? ' selected' : '') + '>Open</option>' +
        '<option value="IN_PROGRESS"' + (dcFilterStatus === 'IN_PROGRESS' ? ' selected' : '') + '>In Progress</option>' +
        '<option value="PENDING_REVIEW"' + (dcFilterStatus === 'PENDING_REVIEW' ? ' selected' : '') + '>Pending Review</option>' +
        '<option value="RESOLVED"' + (dcFilterStatus === 'RESOLVED' ? ' selected' : '') + '>Resolved</option>' +
        '<option value="DISMISSED"' + (dcFilterStatus === 'DISMISSED' ? ' selected' : '') + '>Dismissed</option>' +
        '</select></div>' +
        '<div class="form-group" style="margin:0;min-width:150px"><label style="margin-bottom:4px">Driver</label><select onchange="dcFilterDriver=this.value;renderDriverCompliance(document.getElementById(\'main-content\'))">' +
        '<option value="">All Drivers</option>' +
        appData.drivers.map(d => '<option value="' + d.id + '"' + (dcFilterDriver == d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('') +
        '</select></div>' +
        ((dcFilterStatus || dcFilterDriver) ? '<button class="btn btn-secondary" onclick="dcFilterStatus=\'\';dcFilterDriver=\'\';renderDriverCompliance(document.getElementById(\'main-content\'))"> Clear</button>' : '') +
        '<div style="margin-left:auto;font-size:13px;color:var(--text-muted)">' + filtered.length + ' of ' + violations.length + ' violations</div>' +
        '</div></div>' +
        
        '<div class="card"><div class="card-header"><h3> Violations</h3></div><div class="table-wrapper"><table><thead><tr>' +
        '<th>Driver</th><th>Date</th><th>Type</th><th>Description</th><th>Severity</th><th>Status</th><th>Points</th><th>Fine</th><th>Files</th><th class="sticky-col">Actions</th>' +
        '</tr></thead><tbody>' +
        (filtered.length === 0 ? '<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-muted)">No violations found</td></tr>' :
        filtered.sort((a, b) => (b.violation_date || '').localeCompare(a.violation_date || '')).map(v => {
          const driver = appData.drivers.find(d => d.id === v.driver_id);
          const driverName = driver ? driver.first_name + ' ' + driver.last_name : '<span style="color:var(--red)">Unknown</span>';
          const files = (appData.violation_files || []).filter(f => f.violation_id === v.id);
          
          return '<tr>' +
            '<td><strong>' + driverName + '</strong></td>' +
            '<td>' + (v.violation_date ? formatDate(v.violation_date) : '-') + '</td>' +
            '<td>' + getViolationTypeBadge(v.violation_type) + '</td>' +
            '<td style="max-width:180px">' + (v.description || '-') + '</td>' +
            '<td>' + getSeverityBadge(v.severity) + '</td>' +
            '<td>' + getViolationStatusBadge(v.status) + '</td>' +
            '<td>' + (v.points || '-') + '</td>' +
            '<td>' + (v.fine_amount ? formatMoney(v.fine_amount) : '-') + '</td>' +
            '<td><button class="btn btn-secondary btn-sm" onclick="openViolationFilesModal(' + v.id + ')"> ' + files.length + '</button></td>' +
            '<td class="sticky-col"><div class="actions">' +
            '<button class="action-btn edit" onclick="openViolationModal(' + v.id + ')">Edit</button>' +
            '<button class="action-btn delete" onclick="deleteViolation(' + v.id + ')">Del</button>' +
            '</div></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }
    
    function renderClaimsTab(c) {
      const claims = (appData.claims || []).filter(cl => cl.driver_id); // Only driver-assigned claims
      let filtered = claims;
      if (dcFilterStatus) filtered = filtered.filter(cl => cl.status === dcFilterStatus);
      if (dcFilterDriver) filtered = filtered.filter(cl => cl.driver_id == dcFilterDriver);
      
      c.innerHTML = '<div class="card" style="padding:16px;margin-bottom:20px"><div style="display:flex;gap:16px;align-items:end;flex-wrap:wrap">' +
        '<div class="form-group" style="margin:0;min-width:150px"><label style="margin-bottom:4px">Status</label><select onchange="dcFilterStatus=this.value;renderDriverCompliance(document.getElementById(\'main-content\'))">' +
        '<option value="">All Statuses</option>' +
        '<option value="OPEN"' + (dcFilterStatus === 'OPEN' ? ' selected' : '') + '>Open</option>' +
        '<option value="UNDER_REVIEW"' + (dcFilterStatus === 'UNDER_REVIEW' ? ' selected' : '') + '>Under Review</option>' +
        '<option value="APPROVED"' + (dcFilterStatus === 'APPROVED' ? ' selected' : '') + '>Approved</option>' +
        '<option value="DENIED"' + (dcFilterStatus === 'DENIED' ? ' selected' : '') + '>Denied</option>' +
        '<option value="SETTLED"' + (dcFilterStatus === 'SETTLED' ? ' selected' : '') + '>Settled</option>' +
        '</select></div>' +
        '<div class="form-group" style="margin:0;min-width:150px"><label style="margin-bottom:4px">Driver</label><select onchange="dcFilterDriver=this.value;renderDriverCompliance(document.getElementById(\'main-content\'))">' +
        '<option value="">All Drivers</option>' +
        appData.drivers.map(d => '<option value="' + d.id + '"' + (dcFilterDriver == d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('') +
        '</select></div>' +
        ((dcFilterStatus || dcFilterDriver) ? '<button class="btn btn-secondary" onclick="dcFilterStatus=\'\';dcFilterDriver=\'\';renderDriverCompliance(document.getElementById(\'main-content\'))"> Clear</button>' : '') +
        '<div style="margin-left:auto;font-size:13px;color:var(--text-muted)">' + filtered.length + ' of ' + claims.length + ' claims</div>' +
        '</div></div>' +
        
        // Financial Summary
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:20px">' +
        '<div style="background:var(--amber-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:12px;color:var(--amber)">Total Claimed</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--amber)">' + formatMoney(filtered.reduce((s,cl) => s + parseFloat(cl.claim_amount || 0), 0)) + '</div></div>' +
        '<div style="background:var(--red-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:var(--text-xs);color:var(--red)">Driver Fault (Paid)</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--red)">' + formatMoney(filtered.filter(cl => cl.fault_party === 'DRIVER' && cl.status === 'SETTLED').reduce((s,cl) => s + parseFloat(cl.settlement_amount || cl.claim_amount || 0), 0)) + '</div></div>' +
        '<div style="background:var(--green-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:var(--text-xs);color:var(--green)">Recovered</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--green)">' + formatMoney(filtered.filter(cl => cl.fault_party !== 'DRIVER' && cl.status === 'SETTLED').reduce((s,cl) => s + parseFloat(cl.settlement_amount || 0), 0)) + '</div></div>' +
        '</div>' +
        
        '<div class="card"><div class="card-header"><h3> Damage Claims</h3></div><div class="table-wrapper"><table><thead><tr>' +
        '<th>Claim #</th><th>Date</th><th>Driver</th><th>Type</th><th>Description</th><th>Fault</th><th>Amount</th><th>Status</th><th>Files</th><th class="sticky-col">Actions</th>' +
        '</tr></thead><tbody>' +
        (filtered.length === 0 ? '<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-muted)">No claims found</td></tr>' :
        filtered.sort((a, b) => (b.incident_date || '').localeCompare(a.incident_date || '')).map(cl => {
          const driver = appData.drivers.find(d => d.id === cl.driver_id);
          const driverName = driver ? driver.first_name + ' ' + driver.last_name : '-';
          const files = (appData.claim_files || []).filter(f => f.claim_id === cl.id);
          
          return '<tr>' +
            '<td><strong>' + (cl.claim_number || 'CLM-' + cl.id) + '</strong></td>' +
            '<td>' + (cl.incident_date ? formatDate(cl.incident_date) : '-') + '</td>' +
            '<td>' + driverName + '</td>' +
            '<td><span class="badge badge-gray">' + (cl.damage_type || '-') + '</span></td>' +
            '<td style="max-width:180px">' + (cl.description || '-') + '</td>' +
            '<td>' + getFaultBadge(cl.fault_party) + '</td>' +
            '<td class="money">' + formatMoney(cl.claim_amount) + '</td>' +
            '<td>' + getClaimStatusBadge(cl.status) + '</td>' +
            '<td><button class="btn btn-secondary btn-sm" onclick="openClaimFilesModal(' + cl.id + ')"> ' + files.length + '</button></td>' +
            '<td class="sticky-col"><div class="actions">' +
            '<button class="action-btn view" onclick="viewClaim(' + cl.id + ')">View</button>' +
            '<button class="action-btn edit" onclick="openClaimModal(' + cl.id + ')">Edit</button>' +
            '<button class="action-btn delete" onclick="deleteClaim(' + cl.id + ')">Del</button>' +
            '</div></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }
    
    function getFaultBadge(fault) {
      const badges = {
        'DRIVER': '<span class="badge badge-red">DRIVER</span>',
        'BROKER': '<span class="badge badge-blue">BROKER</span>',
        'SHIPPER': '<span class="badge badge-purple">SHIPPER</span>',
        'CARRIER': '<span class="badge badge-amber">CARRIER</span>',
        'OTHER': '<span class="badge badge-gray">OTHER</span>',
        'UNKNOWN': '<span class="badge badge-gray">UNKNOWN</span>'
      };
      return badges[fault] || '<span class="badge badge-gray">' + (fault || 'N/A') + '</span>';
    }
    
    // Claim Files Modal
    function openClaimFilesModal(claimId) {
      const claim = (appData.claims || []).find(c => c.id === claimId);
      const files = (appData.claim_files || []).filter(f => f.claim_id === claimId);
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3> Claim Files</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div style="margin-bottom:16px;padding:12px;background:var(--bg-darker);border-radius:8px"><strong>' + (claim?.claim_number || 'Claim #' + claimId) + '</strong></div>' +
        '<div class="form-group"><label>Upload File</label><input type="file" id="claimFileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"></div>' +
        '<button class="btn btn-primary btn-sm" onclick="uploadClaimFile(' + claimId + ')"> Upload</button>' +
        '<div style="margin-top:20px"><h4>Attached Files (' + files.length + ')</h4>' +
        (files.length === 0 ? '<p style="color:var(--text-muted)">No files attached</p>' :
        '<div style="display:flex;flex-direction:column;gap:8px;margin-top:12px">' +
        files.map(f => '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg-darker);border-radius:6px">' +
          '<div><strong>' + f.file_name + '</strong><div style="font-size:var(--text-xs);color:var(--text-muted)">' + formatDate(f.uploaded_at) + '</div></div>' +
          '<div class="actions"><a href="' + f.file_url + '" target="_blank" class="action-btn view">View</a><button class="action-btn delete" onclick="deleteClaimFile(' + f.id + ',' + claimId + ')">Del</button></div></div>'
        ).join('') + '</div>') +
        '</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Close</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function uploadClaimFile(claimId) {
      const fileInput = document.getElementById('claimFileInput');
      if (!fileInput.files.length) { showToast('Select a file', 'error'); return; }
      const file = fileInput.files[0];
      showToast('Uploading...');
      try {
        const fileName = Date.now() + '_' + file.name;
        const { data: uploadData, error: uploadError } = await supabase.storage.from('claim-files').upload(fileName, file);
        if (uploadError) throw uploadError;
        const { data: urlData } = supabase.storage.from('claim-files').getPublicUrl(fileName);
        await dbInsert('claim_files', { claim_id: claimId, file_name: file.name, file_url: urlData.publicUrl, uploaded_at: new Date().toISOString() });
        showToast('File uploaded!');
        await loadAllData(true);
        document.querySelector('.modal-overlay').remove();
        openClaimFilesModal(claimId);
      } catch (e) { showToast('Upload failed: ' + e.message, 'error'); }
    }
    
    async function deleteClaimFile(fileId, claimId) {
      if (!confirm('Delete this file?')) return;
      try {
        await dbDelete('claim_files', fileId);
        showToast('File deleted');
        await loadAllData(true);
        document.querySelector('.modal-overlay').remove();
        openClaimFilesModal(claimId);
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    function getTicketStatusBadge(status) {
      const badges = {
        'OPEN': '<span class="badge badge-red">OPEN</span>',
        'IN_PROGRESS': '<span class="badge badge-amber">IN PROGRESS</span>',
        'ATTORNEY_HIRED': '<span class="badge badge-blue">ATTORNEY HIRED</span>',
        'PENDING_COURT': '<span class="badge badge-purple">PENDING COURT</span>',
        'PENDING_DATAQ': '<span class="badge badge-purple">PENDING DATAQ</span>',
        'RESOLVED': '<span class="badge badge-green">RESOLVED</span>',
        'DISMISSED': '<span class="badge badge-gray">DISMISSED</span>'
      };
      return badges[status] || '<span class="badge badge-gray">' + status + '</span>';
    }
    
    function getViolationStatusBadge(status) {
      const badges = {
        'OPEN': '<span class="badge badge-red">OPEN</span>',
        'IN_PROGRESS': '<span class="badge badge-amber">IN PROGRESS</span>',
        'PENDING_REVIEW': '<span class="badge badge-purple">PENDING REVIEW</span>',
        'RESOLVED': '<span class="badge badge-green">RESOLVED</span>',
        'DISMISSED': '<span class="badge badge-gray">DISMISSED</span>'
      };
      return badges[status] || '<span class="badge badge-gray">' + status + '</span>';
    }
    
    function getViolationTypeBadge(type) {
      const badges = {
        'HOS': '<span class="badge" style="background:var(--red);color:white">HOS</span>',
        'SPEEDING': '<span class="badge" style="background:var(--amber);color:white">SPEEDING</span>',
        'LOGBOOK': '<span class="badge" style="background:var(--purple);color:white">LOGBOOK</span>',
        'EQUIPMENT': '<span class="badge" style="background:var(--blue);color:white">EQUIPMENT</span>',
        'WEIGHT': '<span class="badge" style="background:var(--text-secondary);color:white">WEIGHT</span>',
        'SAFETY': '<span class="badge" style="background:var(--red);color:white">SAFETY</span>',
        'OTHER': '<span class="badge badge-gray">OTHER</span>'
      };
      return badges[type] || '<span class="badge badge-gray">' + (type || 'N/A') + '</span>';
    }
    
    function getSeverityBadge(severity) {
      const badges = {
        'MINOR': '<span class="badge badge-blue">MINOR</span>',
        'MODERATE': '<span class="badge badge-amber">MODERATE</span>',
        'SERIOUS': '<span class="badge badge-red">SERIOUS</span>',
        'CRITICAL': '<span class="badge" style="background:var(--red);color:white">CRITICAL</span>'
      };
      return badges[severity] || '<span class="badge badge-gray">' + (severity || 'N/A') + '</span>';
    }
    
    function getCourtDecisionBadge(decision) {
      const badges = {
        'GUILTY': '<span class="badge badge-red">GUILTY</span>',
        'NOT_GUILTY': '<span class="badge badge-green">NOT GUILTY</span>',
        'DISMISSED': '<span class="badge badge-blue">DISMISSED</span>',
        'REDUCED': '<span class="badge badge-amber">REDUCED</span>',
        'PENDING': '<span class="badge badge-gray">PENDING</span>'
      };
      return badges[decision] || '<span class="badge badge-gray">' + decision + '</span>';
    }
    
    function getDataQBadge(decision) {
      const badges = {
        'ACCEPTED': '<span class="badge badge-green">ACCEPTED</span>',
        'DENIED': '<span class="badge badge-red">DENIED</span>',
        'PENDING': '<span class="badge badge-amber">PENDING</span>',
        'NOT_FILED': '<span class="badge badge-gray">NOT FILED</span>'
      };
      return badges[decision] || '<span class="badge badge-gray">' + decision + '</span>';
    }
    
    // TICKET MODAL
    function openTicketModal(id) {
      const t = id ? (appData.tickets || []).find(x => x.id === id) : null;
      const today = new Date().toISOString().split('T')[0];
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:650px"><div class="modal-header"><h3> ' + (t ? 'Edit' : 'New') + ' Ticket</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body" style="max-height:70vh;overflow-y:auto">' +
        
        '<div class="form-row"><div class="form-group"><label>Driver *</label><select id="ticketDriver">' +
        '<option value="">Select Driver</option>' +
        appData.drivers.map(d => '<option value="' + d.id + '"' + (t?.driver_id === d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('') +
        '</select></div><div class="form-group"><label>Status *</label><select id="ticketStatus">' +
        '<option value="OPEN"' + (t?.status === 'OPEN' ? ' selected' : '') + '>Open</option>' +
        '<option value="IN_PROGRESS"' + (t?.status === 'IN_PROGRESS' ? ' selected' : '') + '>In Progress</option>' +
        '<option value="ATTORNEY_HIRED"' + (t?.status === 'ATTORNEY_HIRED' ? ' selected' : '') + '>Attorney Hired</option>' +
        '<option value="PENDING_COURT"' + (t?.status === 'PENDING_COURT' ? ' selected' : '') + '>Pending Court</option>' +
        '<option value="PENDING_DATAQ"' + (t?.status === 'PENDING_DATAQ' ? ' selected' : '') + '>Pending DataQ</option>' +
        '<option value="RESOLVED"' + (t?.status === 'RESOLVED' ? ' selected' : '') + '>Resolved</option>' +
        '<option value="DISMISSED"' + (t?.status === 'DISMISSED' ? ' selected' : '') + '>Dismissed</option>' +
        '</select></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Ticket Date</label><input type="date" id="ticketDate" value="' + (t?.ticket_date || today) + '"></div>' +
        '<div class="form-group"><label>Court Date</label><input type="date" id="ticketCourtDate" value="' + (t?.court_date || '') + '"></div></div>' +
        
        '<div class="form-group"><label>Ticket Description</label><textarea id="ticketDescription" rows="2" placeholder="e.g., Speeding 15mph over limit, Logbook violation...">' + (t?.ticket_description || '') + '</textarea></div>' +
        
        '<div class="form-group"><label>Attorney Info</label><input type="text" id="ticketAttorney" value="' + (t?.attorney_info || '') + '" placeholder="Attorney name, phone, or firm"></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Court Decision</label><select id="ticketCourtDecision">' +
        '<option value="">Not Yet</option>' +
        '<option value="PENDING"' + (t?.court_decision === 'PENDING' ? ' selected' : '') + '>Pending</option>' +
        '<option value="GUILTY"' + (t?.court_decision === 'GUILTY' ? ' selected' : '') + '>Guilty</option>' +
        '<option value="NOT_GUILTY"' + (t?.court_decision === 'NOT_GUILTY' ? ' selected' : '') + '>Not Guilty</option>' +
        '<option value="DISMISSED"' + (t?.court_decision === 'DISMISSED' ? ' selected' : '') + '>Dismissed</option>' +
        '<option value="REDUCED"' + (t?.court_decision === 'REDUCED' ? ' selected' : '') + '>Reduced</option>' +
        '</select></div><div class="form-group"><label>DataQ Decision</label><select id="ticketDataQ">' +
        '<option value="">Not Filed</option>' +
        '<option value="NOT_FILED"' + (t?.dataq_decision === 'NOT_FILED' ? ' selected' : '') + '>Not Filed</option>' +
        '<option value="PENDING"' + (t?.dataq_decision === 'PENDING' ? ' selected' : '') + '>Pending</option>' +
        '<option value="ACCEPTED"' + (t?.dataq_decision === 'ACCEPTED' ? ' selected' : '') + '>Accepted (Removed)</option>' +
        '<option value="DENIED"' + (t?.dataq_decision === 'DENIED' ? ' selected' : '') + '>Denied</option>' +
        '</select></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Fine Amount ($)</label><input type="number" id="ticketFine" value="' + (t?.fine_amount || '') + '" placeholder="0.00"></div>' +
        '<div class="form-group"><label>Points</label><input type="number" id="ticketPoints" value="' + (t?.points || '') + '" placeholder="0"></div></div>' +
        
        '<div class="form-group"><label>Notes</label><textarea id="ticketNotes" rows="2" placeholder="Additional notes...">' + (t?.notes || '') + '</textarea></div>' +
        
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveTicket(' + (id || 'null') + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function saveTicket(id) {
      const driverId = parseInt(document.getElementById('ticketDriver').value);
      if (!driverId) { showToast('Please select a driver', 'error'); return; }
      
      const data = {
        driver_id: driverId,
        status: document.getElementById('ticketStatus').value,
        ticket_date: document.getElementById('ticketDate').value || null,
        ticket_description: document.getElementById('ticketDescription').value,
        court_date: document.getElementById('ticketCourtDate').value || null,
        attorney_info: document.getElementById('ticketAttorney').value,
        court_decision: document.getElementById('ticketCourtDecision').value || null,
        dataq_decision: document.getElementById('ticketDataQ').value || null,
        fine_amount: parseFloat(document.getElementById('ticketFine').value) || null,
        points: parseInt(document.getElementById('ticketPoints').value) || null,
        notes: document.getElementById('ticketNotes').value
      };
      
      try {
        if (id) { await dbUpdate('tickets', id, data); }
        else { await dbInsert('tickets', data); }
        document.querySelector('.modal-overlay').remove();
        showToast('Ticket saved!');
        await loadAllData(true);
        renderDriverCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    async function deleteTicket(id) {
      if (!confirm('Delete this ticket?')) return;
      try {
        await dbDelete('tickets', id);
        showToast('Ticket deleted');
        await loadAllData(true);
        renderDriverCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    // VIOLATION MODAL
    function openViolationModal(id) {
      const v = id ? (appData.violations || []).find(x => x.id === id) : null;
      const today = new Date().toISOString().split('T')[0];
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:650px"><div class="modal-header"><h3> ' + (v ? 'Edit' : 'New') + ' Violation</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body" style="max-height:70vh;overflow-y:auto">' +
        
        '<div class="form-row"><div class="form-group"><label>Driver *</label><select id="violationDriver">' +
        '<option value="">Select Driver</option>' +
        appData.drivers.map(d => '<option value="' + d.id + '"' + (v?.driver_id === d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('') +
        '</select></div><div class="form-group"><label>Status *</label><select id="violationStatus">' +
        '<option value="OPEN"' + (v?.status === 'OPEN' ? ' selected' : '') + '>Open</option>' +
        '<option value="IN_PROGRESS"' + (v?.status === 'IN_PROGRESS' ? ' selected' : '') + '>In Progress</option>' +
        '<option value="PENDING_REVIEW"' + (v?.status === 'PENDING_REVIEW' ? ' selected' : '') + '>Pending Review</option>' +
        '<option value="RESOLVED"' + (v?.status === 'RESOLVED' ? ' selected' : '') + '>Resolved</option>' +
        '<option value="DISMISSED"' + (v?.status === 'DISMISSED' ? ' selected' : '') + '>Dismissed</option>' +
        '</select></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Violation Date</label><input type="date" id="violationDate" value="' + (v?.violation_date || today) + '"></div>' +
        '<div class="form-group"><label>Violation Type</label><select id="violationType">' +
        '<option value="">Select Type</option>' +
        '<option value="HOS"' + (v?.violation_type === 'HOS' ? ' selected' : '') + '>Hours of Service (HOS)</option>' +
        '<option value="SPEEDING"' + (v?.violation_type === 'SPEEDING' ? ' selected' : '') + '>Speeding</option>' +
        '<option value="LOGBOOK"' + (v?.violation_type === 'LOGBOOK' ? ' selected' : '') + '>Logbook</option>' +
        '<option value="EQUIPMENT"' + (v?.violation_type === 'EQUIPMENT' ? ' selected' : '') + '>Equipment</option>' +
        '<option value="WEIGHT"' + (v?.violation_type === 'WEIGHT' ? ' selected' : '') + '>Weight/Overload</option>' +
        '<option value="SAFETY"' + (v?.violation_type === 'SAFETY' ? ' selected' : '') + '>Safety</option>' +
        '<option value="OTHER"' + (v?.violation_type === 'OTHER' ? ' selected' : '') + '>Other</option>' +
        '</select></div></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Severity</label><select id="violationSeverity">' +
        '<option value="MINOR"' + (v?.severity === 'MINOR' ? ' selected' : '') + '>Minor</option>' +
        '<option value="MODERATE"' + (v?.severity === 'MODERATE' ? ' selected' : '') + '>Moderate</option>' +
        '<option value="SERIOUS"' + (v?.severity === 'SERIOUS' ? ' selected' : '') + '>Serious</option>' +
        '<option value="CRITICAL"' + (v?.severity === 'CRITICAL' ? ' selected' : '') + '>Critical</option>' +
        '</select></div><div class="form-group"><label>Location</label><input type="text" id="violationLocation" value="' + (v?.location || '') + '" placeholder="City, State"></div></div>' +
        
        '<div class="form-group"><label>Description</label><textarea id="violationDescription" rows="2" placeholder="Detailed description of the violation...">' + (v?.description || '') + '</textarea></div>' +
        
        '<div class="form-row"><div class="form-group"><label>Fine Amount ($)</label><input type="number" id="violationFine" value="' + (v?.fine_amount || '') + '" placeholder="0.00"></div>' +
        '<div class="form-group"><label>Points</label><input type="number" id="violationPoints" value="' + (v?.points || '') + '" placeholder="0"></div></div>' +
        
        '<div class="form-group"><label>Inspection Report #</label><input type="text" id="violationReportNum" value="' + (v?.report_number || '') + '" placeholder="DOT inspection report number"></div>' +
        
        '<div class="form-group"><label>Notes</label><textarea id="violationNotes" rows="2" placeholder="Additional notes...">' + (v?.notes || '') + '</textarea></div>' +
        
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveViolation(' + (id || 'null') + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function saveViolation(id) {
      const driverId = parseInt(document.getElementById('violationDriver').value);
      if (!driverId) { showToast('Please select a driver', 'error'); return; }
      
      const data = {
        driver_id: driverId,
        status: document.getElementById('violationStatus').value,
        violation_date: document.getElementById('violationDate').value || null,
        violation_type: document.getElementById('violationType').value || null,
        severity: document.getElementById('violationSeverity').value,
        location: document.getElementById('violationLocation').value,
        description: document.getElementById('violationDescription').value,
        fine_amount: parseFloat(document.getElementById('violationFine').value) || null,
        points: parseInt(document.getElementById('violationPoints').value) || null,
        report_number: document.getElementById('violationReportNum').value,
        notes: document.getElementById('violationNotes').value
      };
      
      try {
        if (id) { await dbUpdate('violations', id, data); }
        else { await dbInsert('violations', data); }
        document.querySelector('.modal-overlay').remove();
        showToast('Violation saved!');
        await loadAllData(true);
        renderDriverCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    async function deleteViolation(id) {
      if (!confirm('Delete this violation?')) return;
      try {
        await dbDelete('violations', id);
        showToast('Violation deleted');
        await loadAllData(true);
        renderDriverCompliance(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    // FILE ATTACHMENTS FOR TICKETS
    function openTicketFilesModal(ticketId) {
      const ticket = (appData.tickets || []).find(t => t.id === ticketId);
      const files = (appData.ticket_files || []).filter(f => f.ticket_id === ticketId);
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3> Ticket Files</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div style="margin-bottom:16px;padding:12px;background:var(--bg-darker);border-radius:8px"><strong>' + (ticket?.ticket_description || 'Ticket #' + ticketId) + '</strong></div>' +
        '<div class="form-group"><label>Upload File</label><input type="file" id="ticketFileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"></div>' +
        '<button class="btn btn-primary btn-sm" onclick="uploadTicketFile(' + ticketId + ')"> Upload</button>' +
        '<div style="margin-top:20px"><h4>Attached Files (' + files.length + ')</h4>' +
        (files.length === 0 ? '<p style="color:var(--text-muted)">No files attached</p>' :
        '<div style="display:flex;flex-direction:column;gap:8px;margin-top:12px">' +
        files.map(f => '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg-darker);border-radius:6px">' +
          '<div><strong>' + f.file_name + '</strong><div style="font-size:var(--text-xs);color:var(--text-muted)">' + formatDate(f.uploaded_at) + '</div></div>' +
          '<div class="actions"><a href="' + f.file_url + '" target="_blank" class="action-btn view">View</a><button class="action-btn delete" onclick="deleteTicketFile(' + f.id + ',' + ticketId + ')">Del</button></div></div>'
        ).join('') + '</div>') +
        '</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Close</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function uploadTicketFile(ticketId) {
      const fileInput = document.getElementById('ticketFileInput');
      if (!fileInput.files.length) { showToast('Select a file', 'error'); return; }
      const file = fileInput.files[0];
      showToast('Uploading...');
      try {
        const fileName = Date.now() + '_' + file.name;
        const { data: uploadData, error: uploadError } = await supabase.storage.from('ticket-files').upload(fileName, file);
        if (uploadError) throw uploadError;
        const { data: urlData } = supabase.storage.from('ticket-files').getPublicUrl(fileName);
        await dbInsert('ticket_files', { ticket_id: ticketId, file_name: file.name, file_url: urlData.publicUrl, uploaded_at: new Date().toISOString() });
        showToast('File uploaded!');
        await loadAllData(true);
        document.querySelector('.modal-overlay').remove();
        openTicketFilesModal(ticketId);
      } catch (e) { showToast('Upload failed: ' + e.message, 'error'); }
    }
    
    async function deleteTicketFile(fileId, ticketId) {
      if (!confirm('Delete this file?')) return;
      try {
        await dbDelete('ticket_files', fileId);
        showToast('File deleted');
        await loadAllData(true);
        document.querySelector('.modal-overlay').remove();
        openTicketFilesModal(ticketId);
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }
    
    // FILE ATTACHMENTS FOR VIOLATIONS
    function openViolationFilesModal(violationId) {
      const violation = (appData.violations || []).find(v => v.id === violationId);
      const files = (appData.violation_files || []).filter(f => f.violation_id === violationId);
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:500px"><div class="modal-header"><h3> Violation Files</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div style="margin-bottom:16px;padding:12px;background:var(--bg-darker);border-radius:8px"><strong>' + (violation?.description || 'Violation #' + violationId) + '</strong></div>' +
        '<div class="form-group"><label>Upload File</label><input type="file" id="violationFileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"></div>' +
        '<button class="btn btn-primary btn-sm" onclick="uploadViolationFile(' + violationId + ')"> Upload</button>' +
        '<div style="margin-top:20px"><h4>Attached Files (' + files.length + ')</h4>' +
        (files.length === 0 ? '<p style="color:var(--text-muted)">No files attached</p>' :
        '<div style="display:flex;flex-direction:column;gap:8px;margin-top:12px">' +
        files.map(f => '<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--bg-darker);border-radius:6px">' +
          '<div><strong>' + f.file_name + '</strong><div style="font-size:var(--text-xs);color:var(--text-muted)">' + formatDate(f.uploaded_at) + '</div></div>' +
          '<div class="actions"><a href="' + f.file_url + '" target="_blank" class="action-btn view">View</a><button class="action-btn delete" onclick="deleteViolationFile(' + f.id + ',' + violationId + ')">Del</button></div></div>'
        ).join('') + '</div>') +
        '</div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Close</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function uploadViolationFile(violationId) {
      const fileInput = document.getElementById('violationFileInput');
      if (!fileInput.files.length) { showToast('Select a file', 'error'); return; }
      const file = fileInput.files[0];
      showToast('Uploading...');
      try {
        const fileName = Date.now() + '_' + file.name;
        const { data: uploadData, error: uploadError } = await supabase.storage.from('violation-files').upload(fileName, file);
        if (uploadError) throw uploadError;
        const { data: urlData } = supabase.storage.from('violation-files').getPublicUrl(fileName);
        await dbInsert('violation_files', { violation_id: violationId, file_name: file.name, file_url: urlData.publicUrl, uploaded_at: new Date().toISOString() });
        showToast('File uploaded!');
        await loadAllData(true);
        document.querySelector('.modal-overlay').remove();
        openViolationFilesModal(violationId);
      } catch (e) { showToast('Upload failed: ' + e.message, 'error'); }
    }
    
    async function deleteViolationFile(fileId, violationId) {
      if (!confirm('Delete this file?')) return;
      try {
        await dbDelete('violation_files', fileId);
        showToast('File deleted');
        await loadAllData(true);
        document.querySelector('.modal-overlay').remove();
        openViolationFilesModal(violationId);
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    // ============ DAMAGE CLAIMS MANAGEMENT ============
    function renderClaims(c) {
      const claims = appData.claims || [];
      
      // Stats
      const openClaims = claims.filter(cl => cl.status === 'OPEN').length;
      const underReview = claims.filter(cl => cl.status === 'UNDER_REVIEW').length;
      const approvedClaims = claims.filter(cl => cl.status === 'APPROVED').length;
      const deniedClaims = claims.filter(cl => cl.status === 'DENIED').length;
      const settledClaims = claims.filter(cl => cl.status === 'SETTLED').length;
      const totalClaimAmount = claims.reduce((s, cl) => s + parseFloat(cl.claim_amount || 0), 0);
      const settledAmount = claims.filter(cl => cl.status === 'SETTLED').reduce((s, cl) => s + parseFloat(cl.settlement_amount || cl.claim_amount || 0), 0);
      
      c.innerHTML = '<div class="header"><h2> Damage Claims</h2><button class="btn btn-primary" onclick="openClaimModal()">+ New Claim</button></div>' +
        
        // Stats Row - Mobile friendly grid
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="padding:16px;text-align:center"><div style="font-size:24px;margin-bottom:4px"></div><div class="label">Open Claims</div><div class="value">' + openClaims + '</div></div>' +
        '<div class="stat-card" style="padding:16px;text-align:center"><div style="font-size:24px;margin-bottom:4px"></div><div class="label">Under Review</div><div class="value">' + underReview + '</div></div>' +
        '<div class="stat-card" style="padding:16px;text-align:center"><div style="font-size:24px;margin-bottom:4px"></div><div class="label">Approved</div><div class="value">' + approvedClaims + '</div></div>' +
        '<div class="stat-card" style="padding:16px;text-align:center"><div style="font-size:24px;margin-bottom:4px"></div><div class="label">Denied</div><div class="value">' + deniedClaims + '</div></div>' +
        '<div class="stat-card" style="padding:16px;text-align:center"><div style="font-size:24px;margin-bottom:4px"></div><div class="label">Settled</div><div class="value">' + settledClaims + '</div></div>' +
        '<div class="stat-card" style="padding:16px;text-align:center;background:var(--amber-dim)"><div style="font-size:24px;margin-bottom:4px"></div><div class="label">Total Claimed</div><div class="value" style="color:var(--amber)">' + formatMoney(totalClaimAmount) + '</div></div>' +
        '<div class="stat-card" style="padding:16px;text-align:center;background:var(--green-dim)"><div style="font-size:24px;margin-bottom:4px"></div><div class="label">Total Settled</div><div class="value" style="color:var(--green)">' + formatMoney(settledAmount) + '</div></div>' +
        '</div>' +
        
        // Claims Table
        '<div class="card"><div class="card-header"><h3> All Claims</h3></div>' +
        '<div class="table-wrapper"><table><thead><tr><th>#</th><th>Date</th><th>Truck</th><th>Driver</th><th>Type</th><th>Description</th><th>Claim Amount</th><th>Status</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        (claims.length === 0 ? '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-muted)">No damage claims recorded. Click "+ New Claim" to add one.</td></tr>' :
        claims.sort((a, b) => new Date(b.incident_date) - new Date(a.incident_date)).map((cl, i) => {
          const truck = appData.trucks.find(t => t.id === cl.truck_id);
          const driver = appData.drivers.find(d => d.id === cl.driver_id);
          const statusBadge = getClaimStatusBadge(cl.status);
          return '<tr>' +
            '<td><strong>' + (cl.claim_number || 'CLM-' + cl.id) + '</strong></td>' +
            '<td>' + formatDate(cl.incident_date) + '</td>' +
            '<td>' + (truck ? '<span class="badge badge-blue">#' + truck.truck_number + '</span>' : '-') + '</td>' +
            '<td>' + (driver ? driver.first_name + ' ' + driver.last_name : '-') + '</td>' +
            '<td><span class="badge badge-gray">' + (cl.damage_type || 'Other') + '</span></td>' +
            '<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="' + (cl.description || '') + '">' + (cl.description || '-') + '</td>' +
            '<td class="money">' + formatMoney(cl.claim_amount) + '</td>' +
            '<td>' + statusBadge + '</td>' +
            '<td class="sticky-col"><div class="actions"><button class="action-btn view" onclick="viewClaim(' + cl.id + ')">View</button><button class="action-btn edit" onclick="openClaimModal(' + cl.id + ')">Edit</button><button class="action-btn delete" onclick="deleteClaim(' + cl.id + ')">Del</button></div></td>' +
            '</tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }
    
    function getClaimStatusBadge(status) {
      const badges = {
        'OPEN': '<span class="badge badge-amber">OPEN</span>',
        'UNDER_REVIEW': '<span class="badge badge-blue">UNDER REVIEW</span>',
        'APPROVED': '<span class="badge badge-green">APPROVED</span>',
        'DENIED': '<span class="badge badge-red">DENIED</span>',
        'SETTLED': '<span class="badge badge-purple">SETTLED</span>'
      };
      return badges[status] || '<span class="badge badge-gray">' + status + '</span>';
    }
    
    function openClaimModal(claimId) {
      const claim = claimId ? appData.claims.find(c => c.id === claimId) : null;
      const isEdit = !!claim;
      
      const truckOptions = appData.trucks.map(t => '<option value="' + t.id + '"' + (claim && claim.truck_id === t.id ? ' selected' : '') + '>#' + t.truck_number + ' - ' + t.truck_type + '</option>').join('');
      const driverOptions = appData.drivers.map(d => '<option value="' + d.id + '"' + (claim && claim.driver_id === d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('');
      const tripOptions = appData.trips.map(t => '<option value="' + t.id + '"' + (claim && claim.trip_id === t.id ? ' selected' : '') + '>' + t.trip_number + '</option>').join('');
      
      const damageTypes = ['Cargo Damage', 'Vehicle Damage', 'Property Damage', 'Equipment Damage', 'Theft', 'Weather Damage', 'Accident', 'Other'];
      const damageTypeOptions = damageTypes.map(dt => '<option value="' + dt + '"' + (claim && claim.damage_type === dt ? ' selected' : '') + '>' + dt + '</option>').join('');
      
      const statusOptions = ['OPEN', 'UNDER_REVIEW', 'APPROVED', 'DENIED', 'SETTLED'].map(s => '<option value="' + s + '"' + (claim && claim.status === s ? ' selected' : '') + '>' + s.replace('_', ' ') + '</option>').join('');
      
      const faultOptions = ['UNKNOWN', 'DRIVER', 'BROKER', 'SHIPPER', 'CARRIER', 'OTHER'].map(f => '<option value="' + f + '"' + (claim && claim.fault_party === f ? ' selected' : '') + '>' + f + '</option>').join('');
      
      showModal('claim-modal', (isEdit ? 'Edit' : 'New') + ' Damage Claim', 
        '<form id="claim-form">' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">' +
        '<div class="form-group"><label>Incident Date *</label><input type="date" name="incident_date" value="' + (claim ? claim.incident_date : new Date().toISOString().split('T')[0]) + '" required></div>' +
        '<div class="form-group"><label>Claim Number</label><input type="text" name="claim_number" value="' + (claim ? claim.claim_number || '' : '') + '" placeholder="Auto-generated if empty"></div>' +
        '</div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">' +
        '<div class="form-group"><label>Assign to Truck</label><select name="truck_id"><option value="">-- Select Truck --</option>' + truckOptions + '</select></div>' +
        '<div class="form-group"><label>Assign to Driver</label><select name="driver_id"><option value="">-- Select Driver --</option>' + driverOptions + '</select></div>' +
        '</div>' +
        '<div class="form-group"><label>Related Trip (Optional)</label><select name="trip_id"><option value="">-- Select Trip --</option>' + tripOptions + '</select></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">' +
        '<div class="form-group"><label>Damage Type *</label><select name="damage_type" required>' + damageTypeOptions + '</select></div>' +
        '<div class="form-group"><label>Fault Party *</label><select name="fault_party" required>' + faultOptions + '</select></div>' +
        '<div class="form-group"><label>Status *</label><select name="status" required>' + statusOptions + '</select></div>' +
        '</div>' +
        '<div style="background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:16px;font-size:13px"><strong> Fault Party:</strong> If DRIVER is at fault and claim is SETTLED, it will be tracked as a company expense or driver deduction.</div>' +
        '<div class="form-group"><label>Description *</label><textarea name="description" rows="3" required placeholder="Describe the damage incident...">' + (claim ? claim.description || '' : '') + '</textarea></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">' +
        '<div class="form-group"><label>Claim Amount ($) *</label><input type="number" name="claim_amount" step="0.01" value="' + (claim ? claim.claim_amount || '' : '') + '" required placeholder="0.00"></div>' +
        '<div class="form-group"><label>Settlement Amount ($)</label><input type="number" name="settlement_amount" step="0.01" value="' + (claim ? claim.settlement_amount || '' : '') + '" placeholder="If settled"></div>' +
        '</div>' +
        '<div class="form-group"><label>Insurance Claim Number</label><input type="text" name="insurance_claim_number" value="' + (claim ? claim.insurance_claim_number || '' : '') + '" placeholder="Insurance reference #"></div>' +
        '<div class="form-group"><label>Location of Incident</label><input type="text" name="incident_location" value="' + (claim ? claim.incident_location || '' : '') + '" placeholder="Address or location"></div>' +
        '<div class="form-group"><label>Resolution Notes</label><textarea name="resolution_notes" rows="2" placeholder="Notes about claim resolution...">' + (claim ? claim.resolution_notes || '' : '') + '</textarea></div>' +
        '</form>',
        '<button class="btn btn-secondary" onclick="closeModal(\'claim-modal\')">Cancel</button>' +
        '<button class="btn btn-primary" onclick="saveClaim(' + (claimId || 'null') + ')">' + (isEdit ? 'Update' : 'Create') + ' Claim</button>'
      );
    }
    
    async function saveClaim(claimId) {
      const form = document.getElementById('claim-form');
      const formData = new FormData(form);
      
      const claimData = {
        incident_date: formData.get('incident_date'),
        claim_number: formData.get('claim_number') || null,
        truck_id: formData.get('truck_id') ? parseInt(formData.get('truck_id')) : null,
        driver_id: formData.get('driver_id') ? parseInt(formData.get('driver_id')) : null,
        trip_id: formData.get('trip_id') ? parseInt(formData.get('trip_id')) : null,
        damage_type: formData.get('damage_type'),
        fault_party: formData.get('fault_party') || 'UNKNOWN',
        status: formData.get('status'),
        description: formData.get('description'),
        claim_amount: parseFloat(formData.get('claim_amount')) || 0,
        settlement_amount: formData.get('settlement_amount') ? parseFloat(formData.get('settlement_amount')) : null,
        insurance_claim_number: formData.get('insurance_claim_number') || null,
        incident_location: formData.get('incident_location') || null,
        resolution_notes: formData.get('resolution_notes') || null
      };
      
      // Generate claim number if not provided
      if (!claimData.claim_number) {
        claimData.claim_number = 'CLM-' + Date.now().toString().slice(-6);
      }
      
      try {
        if (claimId) {
          // Update existing claim in database
          await dbUpdate('claims', claimId, claimData);
          await logActivity('CLAIM_UPDATED', { claim_id: claimId, claim_number: claimData.claim_number, status: claimData.status, claim_amount: claimData.claim_amount, damage_type: claimData.damage_type });
          const idx = appData.claims.findIndex(c => c.id === claimId);
          if (idx !== -1) {
            appData.claims[idx] = { ...appData.claims[idx], ...claimData };
          }
          showToast('Claim updated successfully');
        } else {
          // Create new claim in database
          const newClaim = await dbInsert('claims', claimData);
          await logActivity('CLAIM_CREATED', { claim_id: newClaim.id, claim_number: claimData.claim_number, claim_amount: claimData.claim_amount, damage_type: claimData.damage_type });
          appData.claims.push(newClaim);
          showToast('Claim created successfully');
        }
        closeModal('claim-modal');
        renderClaims(document.getElementById('main-content'));
      } catch (e) {
        showToast('Error saving claim: ' + e.message, 'error');
      }
    }
    
    function viewClaim(claimId) {
      const claim = appData.claims.find(c => c.id === claimId);
      if (!claim) return;
      
      const truck = appData.trucks.find(t => t.id === claim.truck_id);
      const driver = appData.drivers.find(d => d.id === claim.driver_id);
      const trip = appData.trips.find(t => t.id === claim.trip_id);
      
      showModal('view-claim-modal', ' Claim Details: ' + (claim.claim_number || 'CLM-' + claim.id),
        '<div style="display:grid;gap:16px">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;padding:16px;background:var(--bg-tertiary);border-radius:8px">' +
        '<div><strong style="font-size:24px">' + formatMoney(claim.claim_amount) + '</strong><br><span style="color:var(--text-muted)">Claim Amount</span></div>' +
        '<div>' + getClaimStatusBadge(claim.status) + '</div>' +
        '</div>' +
        
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">' +
        '<div style="padding:12px;background:var(--bg-tertiary);border-radius:8px"><strong>Incident Date</strong><br>' + formatDate(claim.incident_date) + '</div>' +
        '<div style="padding:12px;background:var(--bg-tertiary);border-radius:8px"><strong>Damage Type</strong><br>' + (claim.damage_type || '-') + '</div>' +
        '<div style="padding:12px;background:var(--bg-tertiary);border-radius:8px"><strong>Assigned Truck</strong><br>' + (truck ? '#' + truck.truck_number + ' (' + truck.truck_type + ')' : 'Not assigned') + '</div>' +
        '<div style="padding:12px;background:var(--bg-tertiary);border-radius:8px"><strong>Assigned Driver</strong><br>' + (driver ? driver.first_name + ' ' + driver.last_name : 'Not assigned') + '</div>' +
        '</div>' +
        
        (trip ? '<div style="padding:12px;background:var(--blue-dim);border-radius:8px"><strong>Related Trip:</strong> ' + trip.trip_number + '</div>' : '') +
        
        '<div style="padding:12px;background:var(--bg-tertiary);border-radius:8px"><strong>Description</strong><br>' + (claim.description || '-') + '</div>' +
        
        (claim.incident_location ? '<div style="padding:12px;background:var(--bg-tertiary);border-radius:8px"><strong>Incident Location</strong><br>' + claim.incident_location + '</div>' : '') +
        
        (claim.insurance_claim_number ? '<div style="padding:12px;background:var(--amber-dim);border-radius:8px"><strong>Insurance Claim #</strong><br>' + claim.insurance_claim_number + '</div>' : '') +
        
        (claim.settlement_amount ? '<div style="padding:var(--spacing-3);background:var(--green-dim);border-radius:var(--radius)"><strong>Settlement Amount</strong><br><span style="font-size:20px;color:var(--green)">' + formatMoney(claim.settlement_amount) + '</span></div>' : '') +
        
        (claim.resolution_notes ? '<div style="padding:12px;background:var(--purple-dim);border-radius:8px"><strong>Resolution Notes</strong><br>' + claim.resolution_notes + '</div>' : '') +
        
        '<div style="font-size:12px;color:var(--text-muted)">Created: ' + formatDate(claim.created_at) + '</div>' +
        '</div>',
        '<button class="btn btn-secondary" onclick="closeModal(\'view-claim-modal\')">Close</button>' +
        '<button class="btn btn-primary" onclick="closeModal(\'view-claim-modal\');openClaimModal(' + claimId + ')">Edit Claim</button>'
      );
    }
    
    async function deleteClaim(claimId) {
      if (!confirm('Are you sure you want to delete this claim?')) return;
      
      try {
        const claim = appData.claims.find(c => c.id === claimId);
        // Delete from database
        await dbDelete('claims', claimId);
        await logActivity('CLAIM_DELETED', { claim_id: claimId, claim_number: claim?.claim_number, claim_amount: claim?.claim_amount });
        
        // Remove from local array
        const idx = appData.claims.findIndex(c => c.id === claimId);
        if (idx !== -1) {
          appData.claims.splice(idx, 1);
        }
        showToast('Claim deleted');
        renderClaims(document.getElementById('main-content'));
      } catch (e) {
        showToast('Delete failed: ' + e.message, 'error');
      }
    }

    // ========================================
    // CREATE NEW LOAD - AI DOCUMENT IMPORT
    // ========================================

    let createLoadFileData = null;

    function openCreateNewLoad() {
      createLoadFileData = null;
      const m = document.createElement('div');
      m.className = 'modal-overlay';
      m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:600px">' +
        '<div class="modal-header" style="background:var(--purple);color:white">' +
        '<h3 style="margin:0">+ Create New Load</h3>' +
        '<button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()" style="color:white"></button>' +
        '</div>' +
        '<div class="modal-body" style="padding:24px">' +
        '<div style="background:var(--purple-dim);padding:var(--spacing-4);border-radius:var(--radius);margin-bottom:20px">' +
        '<div style="font-weight:600;color:var(--purple);margin-bottom:8px">Upload Rate Confirmation</div>' +
        '<div style="color:var(--text-secondary);font-size:13px">Upload a rate confirmation, manifest, or contract. AI will extract all vehicle and order information automatically.</div>' +
        '</div>' +
        '<div id="createLoadUploadArea" style="border:2px dashed var(--border);border-radius:12px;padding:48px;text-align:center;cursor:pointer;transition:all 0.2s" ' +
        'onclick="document.getElementById(\'createLoadFile\').click()" ' +
        'ondragover="event.preventDefault();this.style.borderColor=\'var(--purple)\';this.style.background=\'var(--purple-dim)\'" ' +
        'ondragleave="this.style.borderColor=\'var(--border)\';this.style.background=\'transparent\'" ' +
        'ondrop="handleCreateLoadDrop(event)">' +
        '<input type="file" id="createLoadFile" accept=".pdf,.jpg,.jpeg,.png" onchange="handleCreateLoadFile(event)" style="display:none">' +
        '<div style="font-size:48px;margin-bottom:16px"></div>' +
        '<div style="font-weight:600;margin-bottom:8px">Click to upload or drag & drop</div>' +
        '<div style="color:var(--text-muted);font-size:13px">PDF, JPG, PNG (max 10MB)</div>' +
        '</div>' +
        '<div id="createLoadFilePreview" style="display:none;margin-top:16px"></div>' +
        '<div id="createLoadProgress" style="display:none;margin-top:16px;text-align:center">' +
        '<div style="font-size:24px;margin-bottom:8px;animation:spin 1s linear infinite"></div>' +
        '<div style="font-weight:600">Analyzing document...</div>' +
        '<div style="color:var(--text-muted);font-size:13px;margin-top:4px">AI is extracting order information</div>' +
        '</div>' +
        '</div>' +
        '<div class="modal-footer">' +
        '<button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button>' +
        '<button class="btn" style="background:var(--purple);color:white" id="createLoadBtn" onclick="processCreateLoad()" disabled>Analyze & Create</button>' +
        '</div></div>';
      document.body.appendChild(m);
    }

    function handleCreateLoadFile(event) {
      const file = event.target.files[0];
      processCreateLoadFile(file);
    }

    function handleCreateLoadDrop(event) {
      event.preventDefault();
      const area = document.getElementById('createLoadUploadArea');
      area.style.borderColor = 'var(--border)';
      area.style.background = 'transparent';
      const file = event.dataTransfer.files[0];
      processCreateLoadFile(file);
    }

    function processCreateLoadFile(file) {
      if (!file) return;

      const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
      if (!validTypes.includes(file.type)) {
        showToast('Please upload a PDF, JPG, or PNG file', 'error');
        return;
      }

      if (file.size > 10 * 1024 * 1024) {
        showToast('File too large. Max 10MB.', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        createLoadFileData = {
          base64: e.target.result.split(',')[1],
          type: file.type,
          name: file.name
        };

        const preview = document.getElementById('createLoadFilePreview');
        preview.style.display = 'block';
        preview.innerHTML = '<div style="background:var(--bg-card-hover);padding:var(--spacing-3);border-radius:var(--radius);display:flex;align-items:center;gap:12px">' +
          '<span style="font-size:24px">' + (file.type.includes('pdf') ? '' : '') + '</span>' +
          '<div style="flex:1">' +
          '<div style="font-weight:600">' + file.name + '</div>' +
          '<div style="font-size:12px;color:var(--text-muted)">' + (file.size / 1024).toFixed(1) + ' KB</div>' +
          '</div>' +
          '<button onclick="clearCreateLoadFile()" style="background:none;border:none;cursor:pointer;font-size:18px;color:var(--text-muted)"></button>' +
          '</div>';

        document.getElementById('createLoadBtn').disabled = false;
      };
      reader.readAsDataURL(file);
    }

    function clearCreateLoadFile() {
      createLoadFileData = null;
      document.getElementById('createLoadFilePreview').style.display = 'none';
      document.getElementById('createLoadFile').value = '';
      document.getElementById('createLoadBtn').disabled = true;
    }

    async function processCreateLoad() {
      if (!createLoadFileData) {
        showToast('Please upload a document first', 'error');
        return;
      }

      // Check if API key is configured
      const apiKey = getApiKey();
      if (!apiKey) {
        showToast('Please add your Anthropic API key in Settings first', 'error');
        return;
      }

      document.getElementById('createLoadUploadArea').style.display = 'none';
      document.getElementById('createLoadFilePreview').style.display = 'none';
      document.getElementById('createLoadProgress').style.display = 'block';
      document.getElementById('createLoadBtn').disabled = true;

      try {
        const mediaType = createLoadFileData.type;
        const contentType = mediaType.includes('pdf') ? 'document' : 'image';

        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': getApiKey(),
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 2048,
            messages: [{
              role: 'user',
              content: [
                {
                  type: contentType,
                  source: {
                    type: 'base64',
                    media_type: mediaType,
                    data: createLoadFileData.base64
                  }
                },
                {
                  type: 'text',
                  text: 'Extract all order information from this rate confirmation/manifest/contract. Return ONLY a JSON object:\n\n{\n  "order_number": "string or null",\n  "broker_name": "string or null",\n  "vehicle_year": "number or null",\n  "vehicle_make": "string or null",\n  "vehicle_model": "string or null",\n  "vehicle_vin": "string or null",\n  "vehicle_color": "string or null",\n  "origin": "City, State format or null",\n  "pickup_full_address": "full street address or null",\n  "pickup_phone": "string or null",\n  "pickup_date": "YYYY-MM-DD format or null",\n  "destination": "City, State format or null",\n  "delivery_full_address": "full street address or null",\n  "delivery_phone": "string or null",\n  "dropoff_date": "YYYY-MM-DD format or null",\n  "revenue": "number or null",\n  "payment_type": "BILL or COD or COP or CHECK or null",\n  "broker_fee": "number or null",\n  "notes": "special instructions or null"\n}'
                }
              ]
            }]
          })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error?.message || 'API request failed');
        }

        const data = await response.json();
        const content = data.content[0].text;

        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (!jsonMatch) throw new Error('Could not parse response');

        const extracted = JSON.parse(jsonMatch[0]);

        // Generate unique order number - check for duplicates
        let orderNumber = extracted.order_number || 'ORD-' + Date.now().toString().slice(-6);
        const existingOrder = appData.orders.find(o => o.order_number === orderNumber);
        if (existingOrder) {
          // Order number already exists - append timestamp to make unique
          orderNumber = orderNumber + '-' + Date.now().toString().slice(-4);
        }

        // Build order data with only known safe columns
        const orderData = {
          order_number: orderNumber,
          broker_name: extracted.broker_name || null,
          vehicle_year: extracted.vehicle_year ? parseInt(extracted.vehicle_year) : new Date().getFullYear(),
          vehicle_make: extracted.vehicle_make || '',
          vehicle_model: extracted.vehicle_model || '',
          vehicle_vin: extracted.vehicle_vin || null,
          vehicle_color: extracted.vehicle_color || null,
          origin: extracted.origin || '',
          pickup_full_address: extracted.pickup_full_address || null,
          pickup_phone: extracted.pickup_phone || null,
          pickup_date: extracted.pickup_date || null,
          destination: extracted.destination || '',
          delivery_full_address: extracted.delivery_full_address || null,
          delivery_phone: extracted.delivery_phone || null,
          dropoff_date: extracted.dropoff_date || null,
          revenue: parseFloat(extracted.revenue) || 0,
          payment_type: extracted.payment_type || 'BILL',
          broker_fee: parseFloat(extracted.broker_fee) || 0,
          dispatcher_notes: extracted.notes || null,
          status: 'PENDING',
          trip_id: null,
          payment_status: 'pending'
        };

        const newOrder = await dbInsert('orders', orderData);
        await logActivity('LOAD_CREATED_FROM_DOCUMENT', {
          order_id: newOrder.id,
          order_number: orderData.order_number,
          source_file: createLoadFileData.name
        });

        document.querySelector('.modal-overlay').remove();

        await loadAllData(true);
        showToast('Order created from document!');
        openOrderDetailPage(newOrder.id);

      } catch (e) {
        console.error('Create load error:', e);
        showToast('Failed to process document: ' + e.message, 'error');

        document.getElementById('createLoadUploadArea').style.display = 'block';
        document.getElementById('createLoadFilePreview').style.display = 'block';
        document.getElementById('createLoadProgress').style.display = 'none';
        document.getElementById('createLoadBtn').disabled = false;
      }
    }

    // ========================================
    // BILLING / RECEIVABLES DASHBOARD
    // ========================================

    let billingSearchTerm = '';
    let billingTab = 'overview'; // 'overview' | 'brokers' | 'invoices'
    let brokerBillingSearchTerm = '';
    let billingFilter = 'all'; // 'all' | 'paid' | 'outstanding' | 'overdue'

    function calculateOrderAging(order) {
      const now = new Date();
      let dueDate;
      if (order.due_date) {
        dueDate = new Date(order.due_date);
      } else {
        const baseDate = new Date(order.delivery_date || order.dropoff_date || order.created_at || now);
        dueDate = new Date(baseDate);
        dueDate.setDate(dueDate.getDate() + 30);
      }

      const daysOverdue = Math.floor((now - dueDate) / (1000 * 60 * 60 * 24));
      const amount = order.payment_type === 'SPLIT' ?
        parseFloat(order.bill_amount || 0) : parseFloat(order.revenue || 0);

      return { dueDate, daysOverdue, billAmount: amount };
    }

    function getUnpaidBillOrders() {
      return appData.orders
        .filter(o =>
          (o.payment_type === 'BILL' || o.payment_type === 'SPLIT') &&
          o.payment_status !== 'paid' &&
          (o.delivery_status === 'delivered' || o.status === 'DELIVERED')
        )
        .map(o => ({ ...o, ...calculateOrderAging(o) }))
        .sort((a, b) => b.daysOverdue - a.daysOverdue);
    }

    function getPaidBillOrders() {
      return appData.orders
        .filter(o =>
          (o.payment_type === 'BILL' || o.payment_type === 'SPLIT') &&
          o.payment_status === 'paid' &&
          (o.delivery_status === 'delivered' || o.status === 'DELIVERED')
        )
        .map(o => {
          const amount = o.payment_type === 'SPLIT' ?
            parseFloat(o.bill_amount || 0) : parseFloat(o.revenue || 0);
          return { ...o, billAmount: amount };
        });
    }

    // Get delivered BILL orders that haven't been formally invoiced yet
    function getOrdersNeedingInvoice() {
      return appData.orders
        .filter(o =>
          (o.payment_type === 'BILL' || o.payment_type === 'SPLIT') &&
          o.payment_status !== 'paid' &&
          (o.delivery_status === 'delivered' || o.status === 'DELIVERED') &&
          !o.invoiced_at
        )
        .map(o => ({ ...o, ...calculateOrderAging(o) }))
        .sort((a, b) => new Date(a.delivery_date || a.dropoff_date) - new Date(b.delivery_date || b.dropoff_date));
    }

    // Calculate real avg days to pay from payment_date
    function calculateAvgDaysToPay(paidOrders) {
      const ordersWithPaymentDate = paidOrders.filter(o => o.payment_date);
      if (ordersWithPaymentDate.length === 0) return null;

      const totalDays = ordersWithPaymentDate.reduce((sum, o) => {
        const invoiceDate = new Date(o.delivery_date || o.dropoff_date || o.created_at);
        const paidDate = new Date(o.payment_date);
        const days = Math.floor((paidDate - invoiceDate) / (1000 * 60 * 60 * 24));
        return sum + Math.max(0, days);
      }, 0);

      return Math.round(totalDays / ordersWithPaymentDate.length);
    }

    // Aggregate billing data by broker
    function getBrokerBillingStats() {
      const unpaidOrders = getUnpaidBillOrders();
      const paidOrders = getPaidBillOrders();

      const brokerMap = new Map();

      // Process unpaid orders
      unpaidOrders.forEach(o => {
        const brokerKey = o.broker_name || 'Unknown';
        if (!brokerMap.has(brokerKey)) {
          brokerMap.set(brokerKey, {
            brokerName: brokerKey,
            brokerId: o.broker_id,
            totalInvoiced: 0,
            totalPaid: 0,
            outstanding: 0,
            overdue: 0,
            invoiceCount: 0,
            paidCount: 0,
            unpaidOrders: [],
            paidOrders: [],
            aging: { current: 0, days1_30: 0, days31_60: 0, days61_90: 0, days90Plus: 0 }
          });
        }
        const stats = brokerMap.get(brokerKey);
        stats.totalInvoiced += o.billAmount;
        stats.outstanding += o.billAmount;
        stats.invoiceCount++;
        stats.unpaidOrders.push(o);

        // Aging buckets
        if (o.daysOverdue <= 0) stats.aging.current += o.billAmount;
        else if (o.daysOverdue <= 30) stats.aging.days1_30 += o.billAmount;
        else if (o.daysOverdue <= 60) stats.aging.days31_60 += o.billAmount;
        else if (o.daysOverdue <= 90) stats.aging.days61_90 += o.billAmount;
        else stats.aging.days90Plus += o.billAmount;

        if (o.daysOverdue > 0) stats.overdue += o.billAmount;
      });

      // Process paid orders
      paidOrders.forEach(o => {
        const brokerKey = o.broker_name || 'Unknown';
        if (!brokerMap.has(brokerKey)) {
          brokerMap.set(brokerKey, {
            brokerName: brokerKey,
            brokerId: o.broker_id,
            totalInvoiced: 0,
            totalPaid: 0,
            outstanding: 0,
            overdue: 0,
            invoiceCount: 0,
            paidCount: 0,
            unpaidOrders: [],
            paidOrders: [],
            aging: { current: 0, days1_30: 0, days31_60: 0, days61_90: 0, days90Plus: 0 }
          });
        }
        const stats = brokerMap.get(brokerKey);
        stats.totalInvoiced += o.billAmount;
        stats.totalPaid += o.billAmount;
        stats.paidCount++;
        stats.paidOrders.push(o);
      });

      // Calculate avg days to pay per broker
      brokerMap.forEach(stats => {
        const paidWithDates = stats.paidOrders.filter(o => o.payment_date);
        if (paidWithDates.length > 0) {
          const totalDays = paidWithDates.reduce((sum, o) => {
            const invoiceDate = new Date(o.delivery_date || o.dropoff_date || o.created_at);
            const paidDate = new Date(o.payment_date);
            return sum + Math.max(0, Math.floor((paidDate - invoiceDate) / (1000 * 60 * 60 * 24)));
          }, 0);
          stats.avgDaysToPay = Math.round(totalDays / paidWithDates.length);
        } else {
          stats.avgDaysToPay = null;
        }
      });

      return Array.from(brokerMap.values()).sort((a, b) => b.outstanding - a.outstanding);
    }

    // Mini aging bar for broker table
    function renderMiniAgingBar(aging, total) {
      if (total <= 0) return '<div style="height:8px;background:var(--bg-tertiary);border-radius:4px;width:120px"></div>';

      const currentPct = (aging.current / total) * 100;
      const d1_30Pct = (aging.days1_30 / total) * 100;
      const d31_60Pct = (aging.days31_60 / total) * 100;
      const d61_90Pct = (aging.days61_90 / total) * 100;
      const d90PlusPct = (aging.days90Plus / total) * 100;

      return '<div style="display:flex;height:8px;border-radius:4px;overflow:hidden;width:120px" title="Current: ' + formatMoney(aging.current) + ' | 1-30: ' + formatMoney(aging.days1_30) + ' | 31-60: ' + formatMoney(aging.days31_60) + ' | 61-90: ' + formatMoney(aging.days61_90) + ' | 90+: ' + formatMoney(aging.days90Plus) + '">' +
        (currentPct > 0 ? '<div style="width:' + currentPct + '%;background:var(--green)"></div>' : '') +
        (d1_30Pct > 0 ? '<div style="width:' + d1_30Pct + '%;background:var(--amber)"></div>' : '') +
        (d31_60Pct > 0 ? '<div style="width:' + d31_60Pct + '%;background:var(--amber)"></div>' : '') +
        (d61_90Pct > 0 ? '<div style="width:' + d61_90Pct + '%;background:var(--red)"></div>' : '') +
        (d90PlusPct > 0 ? '<div style="width:' + d90PlusPct + '%;background:var(--red)"></div>' : '') +
        '</div>';
    }

    function getInvoiceNumber(order) {
      const year = new Date(order.created_at || Date.now()).getFullYear();
      return 'INV-' + year + String(order.id).padStart(4, '0');
    }

    function formatDueDateShort(date) {
      if (!date) return '-';
      const d = new Date(date);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function getPaymentStatusInfo(order) {
      if (order.payment_status === 'paid') return { text: 'Paid', color: 'var(--green)', bg: 'var(--green-dim)' };
      if (order.daysOverdue > 60) return { text: 'Delinquent', color: 'var(--red)', bg: 'var(--red-dim)' };
      if (order.daysOverdue > 0) return { text: 'Pending', color: 'var(--amber)', bg: 'var(--amber-dim)' };
      return { text: 'Pending', color: 'var(--amber)', bg: 'var(--amber-dim)' };
    }

    function getTypeBadge(order) {
      // Default to BILL, could be extended based on broker preferences
      const type = 'BILL';
      return { text: type, color: 'var(--blue)', border: 'var(--blue)' };
    }

    async function markBillingOrderPaid(orderId) {
      const order = appData.orders.find(o => o.id === orderId);
      if (!order) return;

      try {
        const now = new Date().toISOString();
        await dbUpdate('orders', orderId, { payment_status: 'paid', payment_date: now });
        order.payment_status = 'paid';
        order.payment_date = now;
        showToast('Invoice marked as paid');
        renderBillingPage(document.getElementById('main-content'));
      } catch (e) {
        showToast('Failed to update: ' + e.message, 'error');
      }
    }

    async function markOrderInvoiced(orderId, invoiceNumber = null) {
      const order = appData.orders.find(o => o.id === orderId);
      if (!order) return;

      try {
        const now = new Date().toISOString();
        const updateData = { invoiced_at: now };
        if (invoiceNumber) updateData.invoice_number = invoiceNumber;

        await dbUpdate('orders', orderId, updateData);
        order.invoiced_at = now;
        if (invoiceNumber) order.invoice_number = invoiceNumber;
        showToast('Order marked as invoiced');
        renderBillingPage(document.getElementById('main-content'));
      } catch (e) {
        showToast('Failed to update: ' + e.message, 'error');
      }
    }

    function openMarkInvoicedModal(orderId) {
      const order = appData.orders.find(o => o.id === orderId);
      if (!order) return;

      const revenue = parseFloat(order.revenue) || 0;
      const brokerFee = parseFloat(order.broker_fee) || 0;
      const localFee = parseFloat(order.local_fee) || 0;
      const amountDue = revenue - brokerFee - localFee;

      const modalHtml = `
        <div class="modal-overlay" id="mark-invoiced-modal" onclick="if(event.target===this)this.remove()">
          <div class="modal" style="max-width:440px">
            <div class="modal-header">
              <h3 style="margin:0;font-family:var(--font-sans);font-size:var(--text-lg);font-weight:var(--weight-bold)">Mark as Invoiced</h3>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </div>
            <div class="modal-body" style="padding:24px">
              <div style="background:var(--bg-tertiary);border-radius:var(--radius);padding:16px;margin-bottom:20px;border:1px solid var(--border)">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                  <span style="font-size:13px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Order</span>
                  <strong style="color:var(--text-primary);font-size:14px">#${escapeHtml(order.order_number || String(order.id))}</strong>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                  <span style="font-size:13px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Broker</span>
                  <strong style="color:var(--text-primary);font-size:14px">${escapeHtml(order.broker_name || 'Unknown')}</strong>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;padding-top:8px;border-top:1px solid var(--border)">
                  <span style="font-size:13px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Amount</span>
                  <strong style="color:var(--primary);font-size:16px;font-family:var(--font-mono)">${formatMoney(amountDue)}</strong>
                </div>
              </div>
              <div style="margin-bottom:20px">
                <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600;color:var(--text-secondary)">Invoice Number <span style="font-weight:400;color:var(--text-muted)">(optional)</span></label>
                <input type="text" id="invoice-number-input" placeholder="e.g., INV-2024-001"
                  style="width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg-tertiary);color:var(--text-primary);font-size:14px;transition:var(--transition)"
                  onfocus="this.style.borderColor='var(--primary)';this.style.boxShadow='0 0 0 3px var(--primary-light)'"
                  onblur="this.style.borderColor='var(--border)';this.style.boxShadow='none'">
              </div>
            </div>
            <div class="modal-footer" style="padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end">
              <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
              <button class="btn btn-primary" onclick="submitMarkInvoiced(${orderId})">Mark Invoiced</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
    }

    async function submitMarkInvoiced(orderId) {
      const invoiceNumber = document.getElementById('invoice-number-input')?.value?.trim() || null;
      document.getElementById('mark-invoiced-modal')?.remove();
      await markOrderInvoiced(orderId, invoiceNumber);
    }

    function renderBillingPage(c) {
      const unpaidOrders = getUnpaidBillOrders();
      const paidOrders = getPaidBillOrders();
      const brokerStats = getBrokerBillingStats();

      // Calculate metrics
      const totalReceivables = unpaidOrders.reduce((s, o) => s + o.billAmount, 0);
      const collected = paidOrders.reduce((s, o) => s + o.billAmount, 0);
      const totalInvoiced = totalReceivables + collected;
      const overdueAmount = unpaidOrders.filter(o => o.daysOverdue > 0).reduce((s, o) => s + o.billAmount, 0);
      const avgDaysToPay = calculateAvgDaysToPay(paidOrders);
      const collectionRate = (collected + totalReceivables) > 0 ? Math.round((collected / (collected + totalReceivables)) * 100) : 0;

      // Aging buckets
      const current = unpaidOrders.filter(o => o.daysOverdue <= 0);
      const days1_30 = unpaidOrders.filter(o => o.daysOverdue > 0 && o.daysOverdue <= 30);
      const days31_60 = unpaidOrders.filter(o => o.daysOverdue > 30 && o.daysOverdue <= 60);
      const days61_90 = unpaidOrders.filter(o => o.daysOverdue > 60 && o.daysOverdue <= 90);
      const days90Plus = unpaidOrders.filter(o => o.daysOverdue > 90);

      const currentAmt = current.reduce((s, o) => s + o.billAmount, 0);
      const days1_30Amt = days1_30.reduce((s, o) => s + o.billAmount, 0);
      const days31_60Amt = days31_60.reduce((s, o) => s + o.billAmount, 0);
      const days61_90Amt = days61_90.reduce((s, o) => s + o.billAmount, 0);
      const days90PlusAmt = days90Plus.reduce((s, o) => s + o.billAmount, 0);

      let html = '';

      // Header with Export button
      html += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px">';
      html += '<div><h2 style="margin:0;font-size:var(--text-2xl);font-weight:var(--weight-bold);font-family:var(--font-sans)">Receivables</h2>';
      html += '<p style="margin:4px 0 0;color:var(--text-muted);font-size:14px">Manage invoices, track payments, monitor aging by broker</p></div>';
      html += '<button class="btn btn-secondary" onclick="window.print()" style="display:flex;align-items:center;gap:8px">Export</button>';
      html += '</div>';

      // Segmented Tab Navigation
      const tabBtnStyle = (key) => {
        const isActive = billingTab === key;
        return 'padding:10px 20px;font-size:14px;font-weight:500;border:none;cursor:pointer;transition:all 0.15s;white-space:nowrap;' +
          (isActive ? 'background:var(--bg-secondary);color:var(--text-primary);box-shadow:var(--shadow-sm);border-radius:var(--radius-sm);' : 'background:transparent;color:var(--text-muted);border-radius:var(--radius-sm);');
      };
      html += '<div style="display:inline-flex;background:var(--bg-tertiary);border-radius:var(--radius);padding:3px;gap:2px;margin-bottom:24px">';
      html += '<button style="' + tabBtnStyle('overview') + '" onclick="billingTab=\'overview\';renderBillingPage(document.getElementById(\'main-content\'))">Overview</button>';
      html += '<button style="' + tabBtnStyle('brokers') + '" onclick="billingTab=\'brokers\';renderBillingPage(document.getElementById(\'main-content\'))">Brokers (' + brokerStats.length + ')</button>';
      html += '<button style="' + tabBtnStyle('invoices') + '" onclick="billingTab=\'invoices\';renderBillingPage(document.getElementById(\'main-content\'))">Invoices (' + unpaidOrders.length + ')</button>';
      html += '</div>';

      // Render based on active tab
      if (billingTab === 'overview') {
        html += renderBillingOverviewTab(unpaidOrders, paidOrders, brokerStats, {
          totalReceivables, collected, totalInvoiced, overdueAmount, avgDaysToPay, collectionRate,
          currentAmt, days1_30Amt, days31_60Amt, days61_90Amt, days90PlusAmt
        });
      } else if (billingTab === 'brokers') {
        html += renderBillingBrokersTab(brokerStats);
      } else {
        html += renderBillingInvoicesTab(unpaidOrders, paidOrders);
      }

      c.innerHTML = html;
    }

    // Overview Tab - Enhanced Dashboard
    function renderBillingOverviewTab(unpaidOrders, paidOrders, brokerStats, m) {
      let html = '';

      // Needs Invoice Alert - theme-aware
      const needsInvoiceOrders = getOrdersNeedingInvoice();
      if (needsInvoiceOrders.length > 0) {
        const needsInvoiceTotal = needsInvoiceOrders.reduce((sum, o) => sum + o.billAmount, 0);
        html += '<div onclick="billingFilter=\'needs_invoice\';billingTab=\'invoices\';renderBillingPage(document.getElementById(\'main-content\'))" style="background:var(--warning-light);border-left:4px solid var(--warning);border-radius:var(--radius-sm);padding:16px 20px;margin-bottom:20px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform=\'translateY(-1px)\';this.style.boxShadow=\'var(--shadow-md)\'" onmouseout="this.style.transform=\'translateY(0)\';this.style.boxShadow=\'none\'">';
        html += '<div style="display:flex;align-items:center;justify-content:space-between">';
        html += '<div style="display:flex;align-items:center;gap:12px">';
        html += '<div style="width:8px;height:8px;background:var(--warning);border-radius:50%"></div>';
        html += '<div>';
        html += '<div style="font-weight:600;color:var(--text-primary);font-size:15px">Needs Invoice</div>';
        html += '<div style="color:var(--text-secondary);font-size:13px">' + needsInvoiceOrders.length + ' delivered order' + (needsInvoiceOrders.length === 1 ? '' : 's') + ' ready to invoice &middot; <span style="font-family:var(--font-mono)">' + formatMoney(needsInvoiceTotal) + '</span></div>';
        html += '</div></div>';
        html += '<div style="display:flex;align-items:center;gap:6px;color:var(--text-secondary);font-size:13px;font-weight:500">View <span style="font-size:16px">&rarr;</span></div>';
        html += '</div></div>';
      }

      // Summary Cards (6 cards) - responsive grid with dot indicators
      html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:24px">';

      const cards = [
        { label: 'Total Invoiced', value: formatMoney(m.totalInvoiced), sub: (unpaidOrders.length + paidOrders.length) + ' invoices', color: 'var(--purple)', click: "billingFilter='all';billingTab='invoices';renderBillingPage(document.getElementById('main-content'))" },
        { label: 'Total Paid', value: formatMoney(m.collected), sub: paidOrders.length + ' paid', color: 'var(--success)', click: "billingFilter='paid';billingTab='invoices';renderBillingPage(document.getElementById('main-content'))" },
        { label: 'Outstanding', value: formatMoney(m.totalReceivables), sub: unpaidOrders.length + ' pending', color: 'var(--info)', click: "billingFilter='outstanding';billingTab='invoices';renderBillingPage(document.getElementById('main-content'))" },
        { label: 'Overdue', value: formatMoney(m.overdueAmount), sub: 'Needs attention', color: 'var(--danger)', click: "billingFilter='overdue';billingTab='invoices';renderBillingPage(document.getElementById('main-content'))" },
        { label: 'Avg Days to Pay', value: m.avgDaysToPay !== null ? m.avgDaysToPay + '<span style="font-size:14px;font-weight:400"> days</span>' : '-', sub: 'Collection time', color: 'var(--warning)', click: null },
        { label: 'Collection Rate', value: m.collectionRate + '%', sub: 'Of total billed', color: m.collectionRate >= 70 ? 'var(--success)' : m.collectionRate >= 50 ? 'var(--warning)' : 'var(--danger)', click: null }
      ];

      cards.forEach(cd => {
        const clickAttr = cd.click ? 'onclick="' + cd.click + '" style="cursor:pointer"' : '';
        html += '<div ' + clickAttr + ' style="background:var(--bg-card);border-radius:var(--radius);padding:24px;border:1px solid var(--border);transition:all 0.2s;' + (cd.click ? 'cursor:pointer' : '') + '" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'var(--shadow-md)\'" onmouseout="this.style.transform=\'translateY(0)\';this.style.boxShadow=\'none\'">';
        html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px">';
        html += '<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + cd.color + '"></span>';
        html += '<span style="color:var(--text-muted);font-size:11px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600">' + cd.label + '</span>';
        html += '</div>';
        html += '<div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:' + cd.color + ';font-family:var(--font-mono);margin-bottom:4px">' + cd.value + '</div>';
        html += '<div style="color:var(--text-muted);font-size:12px">' + cd.sub + '</div>';
        html += '</div>';
      });

      html += '</div>';

      // Aging Summary Bar
      html += '<div style="background:var(--bg-card);border-radius:var(--radius);padding:24px;border:1px solid var(--border);margin-bottom:24px">';
      html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">';
      html += '<h3 style="margin:0;font-size:16px;font-weight:600;font-family:var(--font-sans)">Aging Summary</h3>';
      html += '<div style="color:var(--text-muted);font-size:14px">Outstanding: <strong style="color:var(--text-primary);font-family:var(--font-mono)">' + formatMoney(m.totalReceivables) + '</strong></div>';
      html += '</div>';

      if (m.totalReceivables > 0) {
        const currentPct = (m.currentAmt / m.totalReceivables) * 100;
        const days1_30Pct = (m.days1_30Amt / m.totalReceivables) * 100;
        const days31_60Pct = (m.days31_60Amt / m.totalReceivables) * 100;
        const days61_90Pct = (m.days61_90Amt / m.totalReceivables) * 100;
        const days90PlusPct = (m.days90PlusAmt / m.totalReceivables) * 100;

        html += '<div style="display:flex;height:32px;border-radius:var(--radius-sm);overflow:hidden;margin-bottom:16px">';
        if (currentPct > 0) html += '<div style="width:' + currentPct + '%;background:var(--green)"></div>';
        if (days1_30Pct > 0) html += '<div style="width:' + days1_30Pct + '%;background:var(--amber)"></div>';
        if (days31_60Pct > 0) html += '<div style="width:' + days31_60Pct + '%;background:var(--amber)"></div>';
        if (days61_90Pct > 0) html += '<div style="width:' + days61_90Pct + '%;background:var(--red)"></div>';
        if (days90PlusPct > 0) html += '<div style="width:' + days90PlusPct + '%;background:var(--red)"></div>';
        html += '</div>';
      } else {
        html += '<div style="height:32px;background:var(--bg-tertiary);border-radius:var(--radius-sm);margin-bottom:16px"></div>';
      }

      // Mini-card legend grid instead of inline legend
      html += '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px">';
      const ageBuckets = [
        { label: 'Current', amt: m.currentAmt, color: 'var(--green)' },
        { label: '1-30 Days', amt: m.days1_30Amt, color: 'var(--amber)' },
        { label: '31-60 Days', amt: m.days31_60Amt, color: 'var(--amber)' },
        { label: '61-90 Days', amt: m.days61_90Amt, color: 'var(--red)' },
        { label: '90+ Days', amt: m.days90PlusAmt, color: 'var(--red)' }
      ];
      ageBuckets.forEach(bk => {
        html += '<div style="background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 12px;text-align:center">';
        html += '<div style="display:flex;align-items:center;justify-content:center;gap:6px;margin-bottom:6px"><span style="width:8px;height:8px;border-radius:2px;background:' + bk.color + ';display:inline-block"></span><span style="font-size:var(--text-xs);color:var(--text-muted)">' + bk.label + '</span></div>';
        html += '<div style="font-size:14px;font-weight:700;font-family:var(--font-mono)">' + formatMoney(bk.amt) + '</div></div>';
      });
      html += '</div></div>';

      // Top Brokers by Outstanding
      html += '<div class="card" style="margin-bottom:24px">';
      html += '<div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">';
      html += '<h3 style="margin:0;font-size:16px;font-weight:600;font-family:var(--font-sans)">Top Brokers by Outstanding</h3>';
      html += '<button class="btn btn-sm btn-secondary" onclick="billingTab=\'brokers\';renderBillingPage(document.getElementById(\'main-content\'))">View All</button>';
      html += '</div>';
      html += '<div class="table-wrapper"><table>';
      html += '<thead><tr><th>Broker</th><th style="text-align:right">Outstanding</th><th style="text-align:right">Total Invoiced</th><th style="text-align:right">Paid</th><th style="text-align:right">Overdue</th><th style="width:120px">Aging</th><th style="width:80px">Actions</th></tr></thead><tbody>';

      if (brokerStats.length === 0) {
        html += '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted)">No broker billing data</td></tr>';
      } else {
        brokerStats.slice(0, 5).forEach(b => {
          const statusColor = b.overdue > 0 ? 'var(--danger)' : b.outstanding > 0 ? 'var(--warning)' : 'var(--success)';
          html += '<tr style="cursor:pointer" onclick="openBrokerBillingDetail(\'' + escapeHtml(b.brokerName).replace(/'/g, "\\'") + '\')">';
          html += '<td><strong>' + escapeHtml(b.brokerName) + '</strong><br><span style="font-size:12px;color:var(--text-muted)">' + b.unpaidOrders.length + ' outstanding</span></td>';
          html += '<td style="text-align:right;font-weight:600;color:' + statusColor + ';font-family:var(--font-mono)">' + formatMoney(b.outstanding) + '</td>';
          html += '<td style="text-align:right;font-family:var(--font-mono)">' + formatMoney(b.totalInvoiced) + '</td>';
          html += '<td style="text-align:right;color:var(--success);font-family:var(--font-mono)">' + formatMoney(b.totalPaid) + '</td>';
          html += '<td style="text-align:right;color:var(--danger);font-family:var(--font-mono)">' + formatMoney(b.overdue) + '</td>';
          html += '<td>' + renderMiniAgingBar(b.aging, b.outstanding) + '</td>';
          html += '<td onclick="event.stopPropagation()"><button class="btn btn-sm btn-secondary" onclick="openBrokerBillingDetail(\'' + escapeHtml(b.brokerName).replace(/'/g, "\\'") + '\')">View</button></td>';
          html += '</tr>';
        });
      }

      html += '</tbody></table></div></div>';

      return html;
    }

    // Brokers Tab - Full Broker Accounts
    function renderBillingBrokersTab(brokerStats) {
      let html = '';

      // Search bar
      html += '<div style="margin-bottom:16px">';
      html += '<input type="text" id="broker-billing-search" placeholder="Search brokers..." ';
      html += 'value="' + brokerBillingSearchTerm + '" ';
      html += 'oninput="brokerBillingSearchTerm=this.value;renderBillingPage(document.getElementById(\'main-content\'))" ';
      html += 'style="padding:10px 12px;border:1px solid var(--border);border-radius:8px;width:300px;background:var(--bg-card);color:var(--text-primary)">';
      html += '</div>';

      // Filter brokers
      let filteredBrokers = brokerStats;
      if (brokerBillingSearchTerm.trim()) {
        const term = brokerBillingSearchTerm.toLowerCase().trim();
        filteredBrokers = brokerStats.filter(b => b.brokerName.toLowerCase().includes(term));
      }

      // Broker accounts table
      html += '<div class="card"><div class="table-wrapper"><table>';
      html += '<thead><tr>';
      html += '<th>Broker</th>';
      html += '<th style="text-align:right">Total Invoiced</th>';
      html += '<th style="text-align:right">Paid</th>';
      html += '<th style="text-align:right">Outstanding</th>';
      html += '<th style="text-align:right">Overdue</th>';
      html += '<th>Aging</th>';
      html += '<th style="text-align:center">Avg Days</th>';
      html += '<th style="width:100px">Actions</th>';
      html += '</tr></thead><tbody>';

      if (filteredBrokers.length === 0) {
        html += '<tr><td colspan="8" style="text-align:center;padding:60px;color:var(--text-muted)">';
        html += '<div style="width:56px;height:56px;border:2px dashed var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:18px;color:var(--text-muted)">' + (brokerBillingSearchTerm ? 'S' : 'B') + '</div>';
        html += '<div style="font-size:16px;font-weight:600;margin-bottom:6px;color:var(--text-secondary)">' + (brokerBillingSearchTerm ? 'No brokers found' : 'No billing data') + '</div>';
        html += '</td></tr>';
      } else {
        filteredBrokers.forEach(b => {
          const statusColor = b.overdue > 0 ? 'var(--danger)' : b.outstanding > 0 ? 'var(--warning)' : 'var(--success)';
          const statusBadge = b.overdue > 0 ? '<span class="badge badge-red" style="font-size:10px;margin-left:8px">OVERDUE</span>' :
                             b.outstanding > 0 ? '<span class="badge badge-amber" style="font-size:10px;margin-left:8px">PENDING</span>' :
                             '<span class="badge badge-green" style="font-size:10px;margin-left:8px">CLEAR</span>';

          html += '<tr style="cursor:pointer" onclick="openBrokerBillingDetail(\'' + escapeHtml(b.brokerName).replace(/'/g, "\\'") + '\')">';
          html += '<td><div style="font-weight:600">' + escapeHtml(b.brokerName) + statusBadge + '</div>';
          html += '<div style="font-size:12px;color:var(--text-muted)">' + b.unpaidOrders.length + ' outstanding, ' + b.paidCount + ' paid</div></td>';
          html += '<td style="text-align:right;font-weight:500;font-family:var(--font-mono)">' + formatMoney(b.totalInvoiced) + '</td>';
          html += '<td style="text-align:right;color:var(--success);font-family:var(--font-mono)">' + formatMoney(b.totalPaid) + '</td>';
          html += '<td style="text-align:right;font-weight:600;color:' + statusColor + ';font-family:var(--font-mono)">' + formatMoney(b.outstanding) + '</td>';
          html += '<td style="text-align:right;color:var(--danger);font-family:var(--font-mono)">' + formatMoney(b.overdue) + '</td>';
          html += '<td>' + renderMiniAgingBar(b.aging, b.outstanding) + '</td>';
          html += '<td style="text-align:center">' + (b.avgDaysToPay !== null ? b.avgDaysToPay + 'd' : '-') + '</td>';
          html += '<td onclick="event.stopPropagation()"><button class="btn btn-sm btn-primary" onclick="openBrokerBillingDetail(\'' + escapeHtml(b.brokerName).replace(/'/g, "\\'") + '\')">View</button></td>';
          html += '</tr>';
        });
      }

      html += '</tbody></table></div>';
      html += '<div style="padding:12px 16px;color:var(--text-muted);font-size:13px;border-top:1px solid var(--border)">Showing ' + filteredBrokers.length + ' brokers</div>';
      html += '</div>';

      return html;
    }

    // Invoices Tab - with filter support
    function renderBillingInvoicesTab(unpaidOrders, paidOrders) {
      let html = '';

      // Determine which orders to show based on filter
      let baseOrders = [];
      let filterLabel = 'All Invoices';
      const overdueOrders = unpaidOrders.filter(o => o.daysOverdue > 0);
      const needsInvoiceOrders = getOrdersNeedingInvoice();

      if (billingFilter === 'paid') {
        baseOrders = paidOrders.map(o => ({ ...o, ...calculateOrderAging(o) }));
        filterLabel = 'Paid Invoices';
      } else if (billingFilter === 'outstanding') {
        baseOrders = unpaidOrders;
        filterLabel = 'Outstanding Invoices';
      } else if (billingFilter === 'overdue') {
        baseOrders = overdueOrders;
        filterLabel = 'Overdue Invoices';
      } else if (billingFilter === 'needs_invoice') {
        baseOrders = needsInvoiceOrders;
        filterLabel = 'Needs Invoice';
      } else {
        baseOrders = [...unpaidOrders, ...paidOrders.map(o => ({ ...o, ...calculateOrderAging(o) }))];
        filterLabel = 'All Invoices';
      }

      // Segmented filter control
      const filterBtnStyle = (key) => {
        const isActive = billingFilter === key;
        return 'padding:8px 16px;font-size:13px;font-weight:500;border:none;cursor:pointer;transition:all 0.15s;white-space:nowrap;' +
          (isActive ? 'background:var(--bg-secondary);color:var(--text-primary);box-shadow:var(--shadow-sm);border-radius:var(--radius-sm);' : 'background:transparent;color:var(--text-muted);border-radius:var(--radius-sm);');
      };
      const dotIndicator = (color, count) => count > 0 ? '<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:' + color + ';margin-right:6px"></span>' : '';

      html += '<div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;flex-wrap:wrap">';
      html += '<div style="display:inline-flex;background:var(--bg-tertiary);border-radius:var(--radius);padding:3px;gap:2px">';
      html += '<button style="' + filterBtnStyle('all') + '" onclick="billingFilter=\'all\';renderBillingPage(document.getElementById(\'main-content\'))">All (' + (unpaidOrders.length + paidOrders.length) + ')</button>';
      html += '<button style="' + filterBtnStyle('needs_invoice') + '" onclick="billingFilter=\'needs_invoice\';renderBillingPage(document.getElementById(\'main-content\'))">' + dotIndicator('var(--warning)', needsInvoiceOrders.length) + 'Needs Invoice (' + needsInvoiceOrders.length + ')</button>';
      html += '<button style="' + filterBtnStyle('outstanding') + '" onclick="billingFilter=\'outstanding\';renderBillingPage(document.getElementById(\'main-content\'))">Outstanding (' + unpaidOrders.length + ')</button>';
      html += '<button style="' + filterBtnStyle('paid') + '" onclick="billingFilter=\'paid\';renderBillingPage(document.getElementById(\'main-content\'))">Paid (' + paidOrders.length + ')</button>';
      html += '<button style="' + filterBtnStyle('overdue') + '" onclick="billingFilter=\'overdue\';renderBillingPage(document.getElementById(\'main-content\'))">' + dotIndicator('var(--danger)', overdueOrders.length) + 'Overdue (' + overdueOrders.length + ')</button>';
      html += '</div>';

      // Search bar
      html += '<div style="position:relative;flex:1;max-width:300px">';
      html += '<input type="text" id="billing-search" placeholder="Search invoices..." ';
      html += 'value="' + billingSearchTerm + '" ';
      html += 'oninput="billingSearchTerm=this.value;renderBillingPage(document.getElementById(\'main-content\'))" ';
      html += 'style="width:100%;padding:8px 12px 8px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg-card);color:var(--text-primary);font-size:13px">';
      html += '</div></div>';

      // Apply search filter
      let filteredOrders = baseOrders;
      if (billingSearchTerm.trim()) {
        const term = billingSearchTerm.toLowerCase().trim();
        filteredOrders = baseOrders.filter(o => {
          const invoiceNum = getInvoiceNumber(o).toLowerCase();
          const orderNum = (o.order_number || 'ORD-' + o.id).toLowerCase();
          const brokerName = (o.broker_name || '').toLowerCase();
          return invoiceNum.includes(term) || orderNum.includes(term) || brokerName.includes(term);
        });
      }

      const totalFilteredAmount = filteredOrders.reduce((s, o) => s + (o.billAmount || 0), 0);

      // Invoice Table  merged DUE+AGE, merged TYPE into STATUS  7 columns
      html += '<div class="card"><div class="table-wrapper"><table>';
      html += '<thead><tr>';
      html += '<th style="width:130px">INVOICE</th>';
      html += '<th>CUSTOMER</th>';
      html += '<th>LOAD</th>';
      html += '<th style="text-align:right">AMOUNT</th>';
      html += '<th>DUE / AGE</th>';
      html += '<th>STATUS</th>';
      html += '<th style="width:90px">ACTIONS</th>';
      html += '</tr></thead><tbody>';

      if (filteredOrders.length === 0) {
        html += '<tr><td colspan="7" style="text-align:center;padding:60px;color:var(--text-muted)">';
        html += '<div style="width:56px;height:56px;border:2px dashed var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;font-size:20px;color:var(--text-muted)">';
        html += billingSearchTerm ? 'S' : 'I';
        html += '</div>';
        html += '<div style="font-size:16px;font-weight:600;margin-bottom:6px;color:var(--text-secondary)">' + (billingSearchTerm ? 'No matches found' : 'No invoices to display') + '</div>';
        html += '<div style="font-size:13px">' + (billingSearchTerm ? 'Try a different search term' : filterLabel === 'Overdue Invoices' ? 'No overdue invoices  all clear' : 'No invoices match this filter') + '</div>';
        html += '</td></tr>';
      } else {
        filteredOrders.forEach(o => {
          const invoiceNum = getInvoiceNumber(o);
          const isPaid = o.payment_status === 'paid';
          const needsInvoice = !o.invoiced_at && !isPaid;

          let statusInfo;
          if (isPaid) {
            statusInfo = { text: 'Paid', color: 'var(--green)', bg: 'var(--success-light)' };
          } else if (needsInvoice) {
            statusInfo = { text: 'Needs Invoice', color: 'var(--warning)', bg: 'var(--warning-light)' };
          } else {
            statusInfo = getPaymentStatusInfo(o);
          }

          const typeBadge = getTypeBadge(o);
          const ageText = isPaid ? (o.payment_date ? 'Paid ' + formatDueDateShort(new Date(o.payment_date)) : 'Paid') :
                         (o.daysOverdue <= 0 ? Math.abs(o.daysOverdue) + 'd left' : o.daysOverdue + 'd over');
          const ageColor = isPaid ? 'var(--success)' : (o.daysOverdue <= 0 ? 'var(--success)' : 'var(--danger)');

          html += '<tr style="cursor:pointer" onclick="openOrderDetailPage(' + o.id + ')">';
          html += '<td><strong style="color:var(--text-primary)">' + invoiceNum + '</strong>';
          if (o.invoice_number) {
            html += '<div style="font-size:var(--text-xs);color:var(--text-muted)">' + escapeHtml(o.invoice_number) + '</div>';
          }
          html += '</td>';
          html += '<td><div style="font-weight:500">' + escapeHtml(o.broker_name || 'Unknown') + '</div>';
          html += '<div style="font-size:12px;color:var(--text-muted)">broker</div></td>';
          html += '<td><div style="font-weight:500">' + escapeHtml(o.order_number || 'ORD-' + o.id) + '</div>';
          html += '<div style="font-size:12px;color:var(--text-muted)">' + escapeHtml(o.origin || '?') + '  ' + escapeHtml(o.destination || '?') + '</div></td>';
          html += '<td style="text-align:right;font-weight:600;font-family:var(--font-mono)">' + formatMoney(o.billAmount) + '</td>';
          // Merged DUE + AGE column
          html += '<td><div style="font-size:13px">' + formatDueDateShort(o.dueDate) + '</div>';
          html += '<div style="font-size:12px;font-weight:600;color:' + ageColor + '">' + ageText + '</div></td>';
          // Merged STATUS + TYPE column
          html += '<td><span style="display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;background:' + statusInfo.bg + ';color:' + statusInfo.color + '">' + statusInfo.text + '</span>';
          html += '<div style="font-size:var(--text-xs);color:var(--text-muted);margin-top:4px">' + typeBadge.text + '</div></td>';
          html += '<td onclick="event.stopPropagation()" style="text-align:center">';
          if (needsInvoice) {
            html += '<button class="btn btn-sm" onclick="openMarkInvoicedModal(' + o.id + ')" style="font-size:12px;padding:6px 14px;background:var(--warning);color:white;border:none;border-radius:var(--radius-sm);cursor:pointer;font-weight:500" title="Mark as Invoiced">Invoice</button>';
          } else if (!isPaid) {
            html += '<button class="btn btn-sm" onclick="markBillingOrderPaid(' + o.id + ')" style="font-size:12px;padding:6px 14px;background:var(--success);color:white;border:none;border-radius:var(--radius-sm);cursor:pointer;font-weight:500" title="Mark as Paid">Paid</button>';
          }
          html += '</td>';
          html += '</tr>';
        });
      }

      html += '</tbody></table></div>';
      // Footer: Showing X of Y on left, Total on right
      html += '<div style="padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-size:13px;color:var(--text-muted)">';
      html += '<span>Showing ' + filteredOrders.length + ' ' + filterLabel.toLowerCase() + '</span>';
      html += '<span style="font-family:var(--font-mono);font-weight:600;color:var(--text-primary)">Total: ' + formatMoney(totalFilteredAmount) + '</span>';
      html += '</div></div>';

      return html;
    }

    // Broker Detail Modal
    function openBrokerBillingDetail(brokerName) {
      const brokerStats = getBrokerBillingStats().find(b => b.brokerName === brokerName);
      if (!brokerStats) return;

      const m = document.createElement('div');
      m.className = 'modal-overlay';
      m.onclick = e => { if (e.target === m) m.remove(); };

      // Status dot color
      const statusDotColor = brokerStats.overdue > 0 ? 'var(--danger)' : brokerStats.outstanding > 0 ? 'var(--warning)' : 'var(--success)';

      let html = '<div class="modal" style="max-width:900px;max-height:90vh">';
      html += '<div class="modal-header">';
      html += '<div style="display:flex;align-items:center;gap:10px">';
      html += '<span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:' + statusDotColor + '"></span>';
      html += '<h3 style="margin:0;font-family:var(--font-sans);font-weight:700">' + escapeHtml(brokerStats.brokerName) + '</h3>';
      html += '</div>';
      html += '<button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div>';
      html += '<div class="modal-body" style="max-height:75vh;overflow-y:auto">';

      // Hero: Outstanding Balance  full-width large card
      html += '<div style="background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:16px;text-align:center">';
      html += '<div style="font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Outstanding Balance</div>';
      html += '<div style="font-size:36px;font-weight:800;color:' + (brokerStats.outstanding > 0 ? 'var(--text-primary)' : 'var(--success)') + ';font-family:var(--font-mono)">' + formatMoney(brokerStats.outstanding) + '</div>';
      html += '</div>';

      // 4 smaller metric cards
      html += '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px">';
      const metrics = [
        { label: 'Total Invoiced', value: formatMoney(brokerStats.totalInvoiced), color: 'var(--purple)' },
        { label: 'Paid', value: formatMoney(brokerStats.totalPaid), color: 'var(--success)' },
        { label: 'Overdue', value: formatMoney(brokerStats.overdue), color: 'var(--danger)' },
        { label: 'Avg Days to Pay', value: brokerStats.avgDaysToPay !== null ? brokerStats.avgDaysToPay + 'd' : '-', color: 'var(--text-primary)' }
      ];
      metrics.forEach(mt => {
        html += '<div style="background:var(--bg-tertiary);padding:16px;border-radius:var(--radius-sm);text-align:center;border:1px solid var(--border)">';
        html += '<div style="font-size:var(--text-xs);color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.3px">' + mt.label + '</div>';
        html += '<div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:' + mt.color + ';font-family:var(--font-mono)">' + mt.value + '</div></div>';
      });
      html += '</div>';

      // Aging Breakdown
      html += '<div style="margin-bottom:24px">';
      html += '<div style="font-size:12px;color:var(--text-muted);margin-bottom:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px">Aging Breakdown</div>';
      if (brokerStats.outstanding > 0) {
        const a = brokerStats.aging;
        const total = brokerStats.outstanding;
        html += '<div style="display:flex;height:32px;border-radius:var(--radius-sm);overflow:hidden;margin-bottom:12px">';
        if (a.current > 0) html += '<div style="width:' + (a.current/total*100) + '%;background:var(--green)" title="Current: ' + formatMoney(a.current) + '"></div>';
        if (a.days1_30 > 0) html += '<div style="width:' + (a.days1_30/total*100) + '%;background:var(--amber)" title="1-30 Days: ' + formatMoney(a.days1_30) + '"></div>';
        if (a.days31_60 > 0) html += '<div style="width:' + (a.days31_60/total*100) + '%;background:var(--amber)" title="31-60 Days: ' + formatMoney(a.days31_60) + '"></div>';
        if (a.days61_90 > 0) html += '<div style="width:' + (a.days61_90/total*100) + '%;background:var(--red)" title="61-90 Days: ' + formatMoney(a.days61_90) + '"></div>';
        if (a.days90Plus > 0) html += '<div style="width:' + (a.days90Plus/total*100) + '%;background:var(--red)" title="90+ Days: ' + formatMoney(a.days90Plus) + '"></div>';
        html += '</div>';
        // Mini-card legend
        html += '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px">';
        const buckets = [
          { label: 'Current', amt: a.current, color: 'var(--green)' },
          { label: '1-30d', amt: a.days1_30, color: 'var(--amber)' },
          { label: '31-60d', amt: a.days31_60, color: 'var(--amber)' },
          { label: '61-90d', amt: a.days61_90, color: 'var(--red)' },
          { label: '90+d', amt: a.days90Plus, color: 'var(--red)' }
        ];
        buckets.forEach(bk => {
          html += '<div style="background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius-sm);padding:8px 10px;text-align:center">';
          html += '<div style="display:flex;align-items:center;justify-content:center;gap:4px;margin-bottom:4px"><span style="width:8px;height:8px;border-radius:2px;background:' + bk.color + ';display:inline-block"></span><span style="font-size:var(--text-xs);color:var(--text-muted)">' + bk.label + '</span></div>';
          html += '<div style="font-size:13px;font-weight:600;font-family:var(--font-mono)">' + formatMoney(bk.amt) + '</div></div>';
        });
        html += '</div>';
      } else {
        html += '<div style="color:var(--success);font-weight:500">No outstanding balance</div>';
      }
      html += '</div>';

      // Outstanding Invoices
      if (brokerStats.unpaidOrders.length > 0) {
        const unpaidTotal = brokerStats.unpaidOrders.reduce((s, o) => s + (o.billAmount || 0), 0);
        html += '<div style="margin-bottom:24px">';
        html += '<div style="font-size:12px;color:var(--text-muted);margin-bottom:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px">Outstanding Invoices (' + brokerStats.unpaidOrders.length + ')</div>';
        html += '<div class="table-wrapper"><table style="font-size:13px">';
        html += '<thead><tr><th>Invoice</th><th>Order</th><th style="text-align:right">Amount</th><th>Due</th><th>Age</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
        brokerStats.unpaidOrders.forEach((o, idx) => {
          const ageText = o.daysOverdue <= 0 ? Math.abs(o.daysOverdue) + 'd left' : o.daysOverdue + 'd over';
          const ageColor = o.daysOverdue <= 0 ? 'var(--success)' : 'var(--danger)';
          const statusInfo = getPaymentStatusInfo(o);
          const zebraStyle = idx % 2 === 1 ? 'background:var(--bg-tertiary)' : '';
          html += '<tr style="' + zebraStyle + '">';
          html += '<td><strong>' + getInvoiceNumber(o) + '</strong></td>';
          html += '<td>' + escapeHtml(o.order_number || 'ORD-' + o.id) + '</td>';
          html += '<td style="text-align:right;font-weight:600;font-family:var(--font-mono)">' + formatMoney(o.billAmount) + '</td>';
          html += '<td>' + formatDueDateShort(o.dueDate) + '</td>';
          html += '<td><span style="color:' + ageColor + ';font-weight:600">' + ageText + '</span></td>';
          html += '<td><span style="display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;background:' + statusInfo.bg + ';color:' + statusInfo.color + '">' + statusInfo.text + '</span></td>';
          html += '<td><button class="btn btn-sm btn-primary" onclick="markBillingOrderPaid(' + o.id + ');this.closest(\'.modal-overlay\').remove()">Mark Paid</button></td>';
          html += '</tr>';
        });
        // Summary row
        html += '<tr style="border-top:2px solid var(--border);font-weight:700">';
        html += '<td colspan="2">Total</td>';
        html += '<td style="text-align:right;font-family:var(--font-mono)">' + formatMoney(unpaidTotal) + '</td>';
        html += '<td colspan="4"></td></tr>';
        html += '</tbody></table></div></div>';
      }

      // Payment History
      if (brokerStats.paidOrders.length > 0) {
        html += '<div>';
        html += '<div style="font-size:12px;color:var(--text-muted);margin-bottom:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px">Payment History (' + brokerStats.paidCount + ' paid)</div>';
        html += '<div class="table-wrapper"><table style="font-size:13px">';
        html += '<thead><tr><th>Invoice</th><th>Order</th><th style="text-align:right">Amount</th><th>Invoiced</th><th>Paid</th><th>Days to Pay</th></tr></thead><tbody>';
        brokerStats.paidOrders.slice(0, 10).forEach((o, idx) => {
          const invoiceDate = new Date(o.delivery_date || o.created_at);
          const paidDate = o.payment_date ? new Date(o.payment_date) : null;
          const daysToPay = paidDate ? Math.floor((paidDate - invoiceDate) / (1000 * 60 * 60 * 24)) : '-';
          const daysColor = typeof daysToPay === 'number' ? (daysToPay <= 15 ? 'var(--success)' : daysToPay <= 30 ? 'var(--warning)' : 'var(--danger)') : 'var(--text-muted)';
          const zebraStyle = idx % 2 === 1 ? 'background:var(--bg-tertiary)' : '';
          html += '<tr style="' + zebraStyle + '">';
          html += '<td>' + getInvoiceNumber(o) + '</td>';
          html += '<td>' + escapeHtml(o.order_number || 'ORD-' + o.id) + '</td>';
          html += '<td style="text-align:right;font-family:var(--font-mono)">' + formatMoney(o.billAmount) + '</td>';
          html += '<td>' + formatDueDateShort(invoiceDate) + '</td>';
          html += '<td>' + (paidDate ? formatDueDateShort(paidDate) : '-') + '</td>';
          html += '<td style="font-weight:600;color:' + daysColor + '">' + (typeof daysToPay === 'number' ? daysToPay + 'd' : '-') + '</td>';
          html += '</tr>';
        });
        if (brokerStats.paidOrders.length > 10) {
          html += '<tr><td colspan="6" style="text-align:center;color:var(--text-muted);font-size:12px">... and ' + (brokerStats.paidOrders.length - 10) + ' more</td></tr>';
        }
        html += '</tbody></table></div></div>';
      }

      html += '</div></div>';
      m.innerHTML = html;
      document.body.appendChild(m);
    }

    // Payroll year filter (default to current year)
    let payrollYear = new Date().getFullYear();

    function renderPayroll(c) {
      // Year filter for payroll
      const yearStart = payrollYear + '-01-01';
      const yearEnd = payrollYear + '-12-31';

      const payrollData = appData.drivers.map(driver => {
        const driverTrips = appData.trips.filter(t => t.driver_id === driver.id && t.status === 'COMPLETED' && t.trip_date >= yearStart && t.trip_date <= yearEnd);
        let grossEarnings = 0;
        let cashCollected = 0;
        let expenseReimbursements = 0;

        driverTrips.forEach(trip => {
          const fin = getTripFin(trip.id);
          grossEarnings += fin.driverCut;
          
          const tripOrders = appData.orders.filter(o => o.trip_id === trip.id);
          // For split payments, only count cod_amount as cash collected, not full revenue
          // LOCAL_COD is paid to local drivers, not the trip driver
          cashCollected += tripOrders
            .filter(o => o.payment_type === 'COD' || o.payment_type === 'COP')
            .reduce((sum, o) => {
              if (parseFloat(o.bill_amount || 0) > 0) {
                return sum + parseFloat(o.cod_amount || 0);
              }
              return sum + parseFloat(o.revenue || 0);
            }, 0);
          
          const tripExpenses = appData.expenses.filter(e => e.trip_id === trip.id);
          // Only reimburse OTHER category expenses
          expenseReimbursements += tripExpenses.filter(e => e.category === 'OTHER').reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
        });

        const netPay = grossEarnings - cashCollected + expenseReimbursements;
        return { driver, driverTrips, tripCount: driverTrips.length, grossEarnings, cashCollected, expenseReimbursements, netPay };
      });

      // Year selector options
      const currentYear = new Date().getFullYear();
      const yearOptions = [currentYear, currentYear - 1, currentYear - 2, currentYear - 3].map(y =>
        '<option value="' + y + '"' + (payrollYear === y ? ' selected' : '') + '>' + y + '</option>'
      ).join('');

      c.innerHTML = '<div class="header"><h2> Driver Payroll</h2><div style="display:flex;align-items:center;gap:12px"><div style="display:flex;align-items:center;gap:8px;background:var(--bg-app);padding:var(--spacing-2) var(--spacing-3);border-radius:var(--radius)"><label style="font-weight:600;color:var(--text-secondary);font-size:var(--text-sm)">Year:</label><select onchange="payrollYear=parseInt(this.value);renderPayroll(document.getElementById(\'main-content\'))" style="padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:14px">' + yearOptions + '</select></div><button class="btn btn-secondary" onclick="window.print()"> Print</button></div></div>' +
        '<div style="background:var(--blue-dim);border:1px solid var(--blue-dim);border-radius:8px;padding:16px;margin-bottom:24px"><strong style="color:var(--blue)"> Formula:</strong><p style="color:var(--blue);margin-top:8px">Net Pay = Gross Earnings  Cash Collected + Expense Reimbursements (OTHER only)</p><p style="color:var(--text-muted);font-size:13px;margin-top:4px">Only COMPLETED trips are included. Only "OTHER" category expenses are reimbursed to drivers.</p></div>' +
        '<div class="card"><div class="table-wrapper"><table><thead><tr><th>Driver</th><th>Completed Trips</th><th>Gross Earnings</th><th>Cash Collected</th><th>Expense Reimb.</th><th>Net Pay</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        (payrollData.length === 0 ? '<tr><td colspan="7" style="text-align:center;padding:40px">No drivers yet</td></tr>' :
        payrollData.map(p => '<tr><td><strong>' + p.driver.first_name + ' ' + p.driver.last_name + '</strong><br><span style="color:var(--text-muted);font-size:12px">' + p.driver.cut_percent + '% cut</span></td><td>' + p.tripCount + '</td><td class="money positive">' + formatMoney(p.grossEarnings) + '</td><td class="money negative">-' + formatMoney(p.cashCollected) + '</td><td class="money positive">+' + formatMoney(p.expenseReimbursements) + '</td><td class="money" style="font-size:16px;font-weight:700;color:' + (p.netPay >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(p.netPay) + '</td><td class="sticky-col"><button class="btn btn-primary btn-sm" onclick="openPaystubModal(' + p.driver.id + ')"> Generate Paystub</button></td></tr>').join('')) +
        '</tbody></table></div></div>' +
        '<div class="card"><div class="card-header"><h3> Payroll Summary</h3></div><div style="padding:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:20px;text-align:center">' +
        '<div><div style="font-size:12px;color:var(--text-muted)">Total Gross</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--text-primary)">' + formatMoney(payrollData.reduce((s,p) => s + p.grossEarnings, 0)) + '</div></div>' +
        '<div><div style="font-size:12px;color:var(--text-muted)">Total Cash Collected</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--red)">' + formatMoney(payrollData.reduce((s,p) => s + p.cashCollected, 0)) + '</div></div>' +
        '<div><div style="font-size:12px;color:var(--text-muted)">Total Reimbursements</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--green)">' + formatMoney(payrollData.reduce((s,p) => s + p.expenseReimbursements, 0)) + '</div></div>' +
        '<div style="background:var(--green-dim);padding:var(--spacing-4);border-radius:var(--radius)"><div style="font-size:var(--text-xs);color:var(--green)">Total Net Payroll</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--green)">' + formatMoney(payrollData.reduce((s,p) => s + p.netPay, 0)) + '</div></div>' +
        '</div></div>';
    }

    // Helper function to build detailed trip/order HTML for paystub and settlement modals
    function buildTripOrdersHTML(tripId, valueType = 'driverCut') {
      const tripIdStr = String(tripId);
      const trip = appData.trips.find(t => String(t.id) === tripIdStr);
      const orders = appData.orders.filter(o => String(o.trip_id) === tripIdStr);
      const fin = getTripFin(tripId);

      if (!trip) return '';

      // Calculate value to show (driver cut for company drivers, settlement for owner-ops)
      const mainValue = valueType === 'settlement'
        ? fin.cleanGross - fin.dispatchFee - fin.cashCollected
        : fin.driverCut;
      const valueColor = valueType === 'settlement' ? 'var(--amber)' : 'var(--green)';

      // Payment type badge styles
      const getBadge = (type) => {
        const badges = {
          'COD': '<span style="background:var(--amber);color:white;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600">COD</span>',
          'COP': '<span style="background:var(--amber);color:white;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600">COP</span>',
          'LOCAL_COD': '<span style="background:var(--amber);color:white;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600">LOCAL</span>',
          'BILLED': '<span style="background:var(--blue);color:white;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600">BILLED</span>',
          'CHECK': '<span style="background:var(--green);color:white;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600">CHECK</span>',
          'SPLIT': '<span style="background:var(--purple);color:white;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600">SPLIT</span>'
        };
        return badges[type] || '<span style="background:var(--text-muted);color:white;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600">' + (type || 'N/A') + '</span>';
      };

      // Build order rows
      let ordersHTML = '';
      let tripCashTotal = 0;

      orders.forEach((o, idx) => {
        const revenue = parseFloat(o.revenue || 0);
        const isCash = o.payment_type === 'COD' || o.payment_type === 'COP'; // LOCAL_COD goes to local driver, not trip driver
        const hasBillPortion = parseFloat(o.bill_amount || 0) > 0;
        const cashAmount = isCash ? (hasBillPortion ? parseFloat(o.cod_amount || 0) : revenue) : 0;
        tripCashTotal += cashAmount;

        const vehicleInfo = [o.vehicle_year, o.vehicle_make, o.vehicle_model].filter(Boolean).join(' ') || 'N/A';
        const orderLabel = o.order_number ? o.order_number + '  ' + vehicleInfo : vehicleInfo;
        const isLast = idx === orders.length - 1;
        const prefix = isLast ? '' : '';

        ordersHTML += '<div style="display:flex;align-items:center;gap:8px;padding:4px 0 4px 24px;font-size:12px;color:var(--text-muted)">' +
          '<span style="color:var(--text-muted)">' + prefix + '</span>' +
          '<span style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="' + orderLabel + '">' + orderLabel + '</span>' +
          '<span style="font-weight:500;color:var(--text-primary)">' + formatMoney(revenue) + '</span>' +
          getBadge(o.payment_type) +
          '</div>';
      });

      // Add cash collected summary if any
      if (tripCashTotal > 0) {
        ordersHTML += '<div style="display:flex;align-items:center;gap:8px;padding:4px 0 4px 24px;font-size:11px;color:var(--amber);font-weight:600">' +
          '<span style="color:transparent"></span>' +
          '<span> Cash Collected: ' + formatMoney(tripCashTotal) + '</span>' +
          '</div>';
      }

      // Build complete trip block
      const checkboxClass = valueType === 'settlement' ? 'settlement-trip' : 'paystub-trip';
      return '<div style="border-bottom:1px solid var(--border);padding:8px 0">' +
        '<label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-weight:500">' +
        '<input type="checkbox" class="' + checkboxClass + '" value="' + trip.id + '">' +
        '<span><strong>' + trip.trip_number + '</strong> - ' + formatDate(trip.trip_date) + '</span>' +
        '<span style="margin-left:auto;color:' + valueColor + ';font-weight:600">' + formatMoney(mainValue) + '</span>' +
        '</label>' +
        (orders.length > 0 ? ordersHTML : '<div style="padding:4px 0 4px 24px;font-size:12px;color:var(--text-muted);font-style:italic">No orders</div>') +
        '</div>';
    }

    function openPaystubModal(driverId) {
      const driver = appData.drivers.find(d => d.id === driverId);
      const isOwnerOp = driver?.driver_type === 'OWNER_OP';

      // If Owner-Operator, use different settlement modal
      if (isOwnerOp) {
        openSettlementModal(driverId);
        return;
      }

      // Filter by payrollYear
      const yearStart = payrollYear + '-01-01';
      const yearEnd = payrollYear + '-12-31';
      const completedTrips = appData.trips.filter(t => t.driver_id === driverId && t.status === 'COMPLETED' && t.trip_date >= yearStart && t.trip_date <= yearEnd);

      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:650px;max-height:90vh;display:flex;flex-direction:column"><div class="modal-header"><h3> Generate Paystub</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body" style="overflow-y:auto;flex:1">' +
        '<div class="form-row"><div class="form-group"><label>Driver</label><input value="' + driver.first_name + ' ' + driver.last_name + '" readonly style="background:var(--bg-card-hover)"></div><div class="form-group"><label>Driver Email</label><input type="email" id="driverEmail" value="' + (driver.email || '') + '" placeholder="driver@email.com"></div></div>' +
        '<div class="form-group"><label>Select Trip(s) for Paystub</label><div style="max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;padding:8px">' +
        (completedTrips.length === 0 ? '<p style="color:var(--text-muted);text-align:center;padding:20px">No completed trips</p>' :
        completedTrips.map(t => buildTripOrdersHTML(t.id, 'driverCut')).join('')) +
        '</div></div>' +
        '<div class="form-row"><div class="form-group"><label>Stub #</label><input type="number" id="stubNumber" value="' + (1000 + Math.floor(Math.random() * 9000)) + '"></div><div class="form-group"><label>Check #</label><input type="number" id="checkNumber" value="' + (10000 + Math.floor(Math.random() * 90000)) + '"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Period Starting</label><input type="date" id="periodStart" value="' + new Date().toISOString().split('T')[0] + '"></div><div class="form-group"><label>Period Ending</label><input type="date" id="periodEnd" value="' + new Date().toISOString().split('T')[0] + '"></div></div>' +
        '<div class="form-group"><label>Pay Date</label><input type="date" id="payDate" value="' + new Date().toISOString().split('T')[0] + '"></div>' +
        
        // Deductions Section
        '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-top:12px">' +
        '<label style="font-weight:600;margin-bottom:8px;display:block;color:var(--red)"> DEDUCTIONS</label>' +
        '<div class="form-row" style="gap:8px"><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Insurance (Cargo/Liab/Phys)</label><input type="number" id="dedInsurance" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Fuel</label><input type="number" id="dedFuel" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Fuel Deposit</label><input type="number" id="dedFuelDeposit" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div></div>' +
        '<div class="form-row" style="gap:8px"><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">ELD</label><input type="number" id="dedELD" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Tolls</label><input type="number" id="dedTolls" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">IFTA</label><input type="number" id="dedIFTA" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div></div>' +
        '<div class="form-row" style="gap:8px"><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Highway Use Tax (2290)</label><input type="number" id="ded2290" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Reg Renewal</label><input type="number" id="dedRegRenewal" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Other Deductions</label><input type="number" id="dedOther" value="0" class="deduction-input" onchange="updatePaystubTotals()"></div></div>' +
        '<div style="text-align:right;margin-top:8px;font-weight:600;color:var(--red)">Total Deductions: $<span id="totalDeductionsDisplay">0.00</span></div></div>' +
        
        // Bonuses Section
        '<div style="background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-top:12px">' +
        '<label style="font-weight:600;margin-bottom:8px;display:block;color:var(--green)"> BONUSES</label>' +
        '<div class="form-row" style="gap:8px"><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Level I Inspection</label><input type="number" id="bonusLevel1" value="0" class="bonus-input" onchange="updatePaystubTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Level II Inspection</label><input type="number" id="bonusLevel2" value="0" class="bonus-input" onchange="updatePaystubTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Level III Inspection</label><input type="number" id="bonusLevel3" value="0" class="bonus-input" onchange="updatePaystubTotals()"></div></div>' +
        '<div class="form-row" style="gap:8px"><div class="form-group" style="margin-bottom:0"><label style="font-size:12px">Other Bonus</label><input type="number" id="bonusOther" value="0" class="bonus-input" onchange="updatePaystubTotals()"></div></div>' +
        '<div style="text-align:right;margin-top:8px;font-weight:600;color:var(--green)">Total Bonuses: $<span id="totalBonusesDisplay">0.00</span></div></div>' +
        
        '</div><div class="modal-footer" style="flex-wrap:wrap;gap:8px"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="generatePaystub(' + driverId + ', \'print\')"><svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right:6px"><path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2H5zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1z"/><path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2V7z"/></svg>Print</button><button class="btn btn-primary" style="background:var(--green)" onclick="generatePaystub(' + driverId + ', \'email\')"><svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right:6px"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/></svg>Send Email</button><button class="btn btn-secondary" onclick="generatePaystub(' + driverId + ', \'both\')">Print & Email</button></div></div>';
      document.body.appendChild(m);
    }

    // Owner-Operator Settlement Modal (different from Company Driver paystub)
    function openSettlementModal(driverId) {
      const driver = appData.drivers.find(d => d.id === driverId);
      const dispatchFeePercent = driver?.dispatch_fee_percent || 5;

      // Filter by payrollYear
      const yearStart = payrollYear + '-01-01';
      const yearEnd = payrollYear + '-12-31';
      const completedTrips = appData.trips.filter(t => t.driver_id === driverId && t.status === 'COMPLETED' && t.trip_date >= yearStart && t.trip_date <= yearEnd);

      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:650px;max-height:90vh;display:flex;flex-direction:column"><div class="modal-header" style="background:var(--amber);color:white"><h3> Generate Settlement Statement</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()" style="color:white"></button></div><div class="modal-body" style="overflow-y:auto;flex:1">' +
        '<div style="background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:16px;border:2px solid var(--amber)"><div style="font-weight:600;color:var(--amber)"> Owner-Operator Settlement</div><div style="font-size:12px;color:var(--amber)">Dispatch Fee: ' + dispatchFeePercent + '%</div></div>' +
        '<div class="form-row"><div class="form-group"><label>Owner-Operator</label><input value="' + driver.first_name + ' ' + driver.last_name + '" readonly style="background:var(--bg-card-hover)"></div><div class="form-group"><label>Email</label><input type="email" id="driverEmail" value="' + (driver.email || '') + '" placeholder="owner@email.com"></div></div>' +
        '<div class="form-group"><label>Select Trip(s) for Settlement</label><div style="max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;padding:8px">' +
        (completedTrips.length === 0 ? '<p style="color:var(--text-muted);text-align:center;padding:20px">No completed trips</p>' :
        completedTrips.map(t => buildTripOrdersHTML(t.id, 'settlement')).join('')) +
        '</div></div>' +
        '<div class="form-row"><div class="form-group"><label>Settlement #</label><input type="number" id="settlementNumber" value="' + (1000 + Math.floor(Math.random() * 9000)) + '"></div><div class="form-group"><label>Check #</label><input type="number" id="checkNumber" value="' + (10000 + Math.floor(Math.random() * 90000)) + '"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Period Starting</label><input type="date" id="periodStart" value="' + new Date().toISOString().split('T')[0] + '"></div><div class="form-group"><label>Period Ending</label><input type="date" id="periodEnd" value="' + new Date().toISOString().split('T')[0] + '"></div></div>' +
        '<div class="form-group"><label>Settlement Date</label><input type="date" id="payDate" value="' + new Date().toISOString().split('T')[0] + '"></div>' +

        // Deductions Section for Owner-Operators
        '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-top:12px">' +
        '<label style="font-weight:600;margin-bottom:8px;display:block;color:var(--red)"> DEDUCTIONS</label>' +
        '<div class="form-row" style="gap:8px"><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">IFTA</label><input type="number" id="settDedIFTA" value="0" class="settlement-ded" onchange="updateSettlementTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">ELD</label><input type="number" id="settDedELD" value="0" class="settlement-ded" onchange="updateSettlementTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Tolls</label><input type="number" id="settDedTolls" value="0" class="settlement-ded" onchange="updateSettlementTotals()"></div></div>' +
        '<div class="form-row" style="gap:8px"><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Insurance</label><input type="number" id="settDedInsurance" value="0" class="settlement-ded" onchange="updateSettlementTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Fuel</label><input type="number" id="settDedFuel" value="0" class="settlement-ded" onchange="updateSettlementTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">HUT 2290</label><input type="number" id="settDed2290" value="0" class="settlement-ded" onchange="updateSettlementTotals()"></div></div>' +
        '<div class="form-row" style="gap:8px"><div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Reg Renewal</label><input type="number" id="settDedReg" value="0" class="settlement-ded" onchange="updateSettlementTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Advances</label><input type="number" id="settDedAdvances" value="0" class="settlement-ded" onchange="updateSettlementTotals()"></div>' +
        '<div class="form-group" style="margin-bottom:8px"><label style="font-size:12px">Other</label><input type="number" id="settDedOther" value="0" class="settlement-ded" onchange="updateSettlementTotals()"></div></div>' +
        '<div style="margin-top:8px;padding-top:8px;border-top:1px dashed var(--red-dim)"><label style="font-size:11px;color:var(--red);font-weight:600">Custom Deductions:</label></div>' +
        '<div class="form-row" style="gap:8px;margin-top:4px"><div class="form-group" style="margin-bottom:4px;flex:2"><input type="text" id="settDedCustom1Label" placeholder="Description" style="font-size:12px"></div><div class="form-group" style="margin-bottom:4px;flex:1"><input type="number" id="settDedCustom1" value="0" class="settlement-ded" onchange="updateSettlementTotals()"></div></div>' +
        '<div class="form-row" style="gap:8px"><div class="form-group" style="margin-bottom:4px;flex:2"><input type="text" id="settDedCustom2Label" placeholder="Description" style="font-size:12px"></div><div class="form-group" style="margin-bottom:4px;flex:1"><input type="number" id="settDedCustom2" value="0" class="settlement-ded" onchange="updateSettlementTotals()"></div></div>' +
        '<div class="form-row" style="gap:8px"><div class="form-group" style="margin-bottom:4px;flex:2"><input type="text" id="settDedCustom3Label" placeholder="Description" style="font-size:12px"></div><div class="form-group" style="margin-bottom:4px;flex:1"><input type="number" id="settDedCustom3" value="0" class="settlement-ded" onchange="updateSettlementTotals()"></div></div>' +
        '<div style="text-align:right;margin-top:8px;font-weight:600;color:var(--red)">Total Deductions: $<span id="totalSettlementDeductions">0.00</span></div></div>' +

        '</div><div class="modal-footer" style="flex-wrap:wrap;gap:8px"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" style="background:var(--amber)" onclick="generateSettlement(' + driverId + ', \'print\')"><svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right:6px"><path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2H5zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1z"/><path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2V7z"/></svg>Print</button><button class="btn btn-primary" style="background:var(--green)" onclick="generateSettlement(' + driverId + ', \'email\')"><svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" style="margin-right:6px"><path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z"/></svg>Send Email</button></div></div>';
      document.body.appendChild(m);
    }

    // Update settlement deductions total
    function updateSettlementTotals() {
      const dedIds = ['settDedIFTA', 'settDedELD', 'settDedTolls', 'settDedInsurance', 'settDedFuel', 'settDed2290', 'settDedReg', 'settDedAdvances', 'settDedOther', 'settDedCustom1', 'settDedCustom2', 'settDedCustom3'];
      let total = 0;
      dedIds.forEach(id => { total += parseFloat(document.getElementById(id)?.value || 0); });
      const display = document.getElementById('totalSettlementDeductions');
      if (display) display.textContent = total.toFixed(2);
    }

    // Generate Owner-Operator Settlement
    async function generateSettlement(driverId, action = 'print') {
      const driver = appData.drivers.find(d => d.id === driverId);
      const dispatchFeePercent = driver?.dispatch_fee_percent || 5;

      // Get selected trips
      const selectedTripIds = Array.from(document.querySelectorAll('.settlement-trip:checked')).map(cb => cb.value);
      if (selectedTripIds.length === 0) {
        showToast('Please select at least one trip', 'error');
        return;
      }

      // Calculate totals - now at ORDER level for detailed view
      let totalRevenue = 0, totalBrokerFee = 0, totalLocalFee = 0, totalDispatchFee = 0, totalCashCollected = 0;
      const tripDetails = [];

      selectedTripIds.forEach(tripId => {
        const trip = appData.trips.find(t => String(t.id) === String(tripId));
        if (!trip) {
          console.warn('Trip not found:', tripId);
          return;
        }
        const orders = appData.orders.filter(o => String(o.trip_id) === String(tripId));

        // Create one row per order for detailed view
        orders.forEach(o => {
          const revenue = parseFloat(o.revenue || 0);
          const brokerFee = parseFloat(o.broker_fee || 0);
          const localFee = parseFloat(o.local_fee || 0);
          const cleanGross = revenue - brokerFee - localFee;
          const orderDispatchFee = cleanGross * (dispatchFeePercent / 100);
          const isCash = o.payment_type === 'COD' || o.payment_type === 'COP'; // LOCAL_COD goes to local driver
          const hasBillPortion = parseFloat(o.bill_amount || 0) > 0;
          const cashCollected = isCash ? (hasBillPortion ? parseFloat(o.cod_amount || 0) : revenue) : 0;
          const settlement = cleanGross - orderDispatchFee - cashCollected;

          // Build order/vehicle label
          const vehicleInfo = [o.vehicle_year, o.vehicle_make].filter(Boolean).join(' ');
          const orderVehicle = o.order_number ? (o.order_number + (vehicleInfo ? ' ' + vehicleInfo : '')) : (vehicleInfo || 'N/A');

          totalRevenue += revenue;
          totalBrokerFee += brokerFee;
          totalLocalFee += localFee;
          totalDispatchFee += orderDispatchFee;
          totalCashCollected += cashCollected;

          tripDetails.push({
            tripNumber: trip.trip_number,
            date: trip.trip_date,
            orderVehicle,
            paymentType: o.payment_type || 'BILL',
            revenue,
            brokerFee,
            localFee,
            cleanGross,
            dispatchFee: orderDispatchFee,
            cashCollected,
            settlement
          });
        });
      });

      const totalCleanGross = totalRevenue - totalBrokerFee - totalLocalFee;

      // Get deductions from form
      const deductions = {
        ifta: parseFloat(document.getElementById('settDedIFTA')?.value || 0),
        eld: parseFloat(document.getElementById('settDedELD')?.value || 0),
        tolls: parseFloat(document.getElementById('settDedTolls')?.value || 0),
        insurance: parseFloat(document.getElementById('settDedInsurance')?.value || 0),
        fuel: parseFloat(document.getElementById('settDedFuel')?.value || 0),
        hut2290: parseFloat(document.getElementById('settDed2290')?.value || 0),
        regRenewal: parseFloat(document.getElementById('settDedReg')?.value || 0),
        advances: parseFloat(document.getElementById('settDedAdvances')?.value || 0),
        other: parseFloat(document.getElementById('settDedOther')?.value || 0),
        custom1: { label: document.getElementById('settDedCustom1Label')?.value || '', amount: parseFloat(document.getElementById('settDedCustom1')?.value || 0) },
        custom2: { label: document.getElementById('settDedCustom2Label')?.value || '', amount: parseFloat(document.getElementById('settDedCustom2')?.value || 0) },
        custom3: { label: document.getElementById('settDedCustom3Label')?.value || '', amount: parseFloat(document.getElementById('settDedCustom3')?.value || 0) }
      };
      const totalDeductions = deductions.ifta + deductions.eld + deductions.tolls + deductions.insurance + deductions.fuel + deductions.hut2290 + deductions.regRenewal + deductions.advances + deductions.other + deductions.custom1.amount + deductions.custom2.amount + deductions.custom3.amount;

      const totalSettlement = totalCleanGross - totalDispatchFee - totalCashCollected - totalDeductions;

      const periodStart = document.getElementById('periodStart')?.value;
      const periodEnd = document.getElementById('periodEnd')?.value;
      const payDate = document.getElementById('payDate')?.value;
      const settlementNumber = document.getElementById('settlementNumber')?.value;
      const checkNumber = document.getElementById('checkNumber')?.value;

      // Generate PDF
      const pdfBlob = await generateSettlementPDF(driver, tripDetails, totalRevenue, totalBrokerFee, totalLocalFee, totalCleanGross, totalDispatchFee, totalCashCollected, totalSettlement, dispatchFeePercent, periodStart, periodEnd, payDate, settlementNumber, checkNumber, deductions, totalDeductions);

      if (action === 'print' || action === 'both') {
        const url = URL.createObjectURL(pdfBlob);
        window.open(url, '_blank');
      }

      if (action === 'email' || action === 'both') {
        const driverEmail = document.getElementById('driverEmail')?.value;
        if (!driverEmail) {
          showToast('Please enter owner email address', 'error');
          return;
        }
        await sendSettlementEmail(pdfBlob, driverEmail, driver, selectedTripIds, payDate, totalSettlement);
      }

      document.querySelector('.modal-overlay')?.remove();
    }

    // Generate Settlement PDF for Owner-Operators
    async function generateSettlementPDF(driver, tripDetails, totalRevenue, totalBrokerFee, totalLocalFee, totalCleanGross, totalDispatchFee, totalCashCollected, totalSettlement, dispatchFeePercent, periodStart, periodEnd, payDate, settlementNumber, checkNumber, deductions = {}, totalDeductions = 0) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format: 'a4' });

      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = 15;
      let y = margin;

      // Colors
      const orange = [245, 158, 11];
      const darkGray = [17, 24, 39];
      const medGray = [107, 114, 128];
      const lightGray = [243, 244, 246];

      const fmtMoney = (amt) => '$' + (amt || 0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
      const fmtDate = (d) => d ? new Date(d).toLocaleDateString() : 'N/A';

      // === HEADER ===
      // Text-based logo (image removed)
      doc.setFillColor(...darkGray);
      doc.rect(margin, y, 18, 14, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(8);
      doc.setFont('helvetica', 'bold');
      doc.text('HORIZON', margin + 2, y + 6);
      doc.text('STAR', margin + 2, y + 11);

      // Title
      doc.setFontSize(18);
      doc.setTextColor(...orange);
      doc.setFont('helvetica', 'bold');
      doc.text('SETTLEMENT STATEMENT', pageWidth - margin, y + 10, { align: 'right' });
      y += 20;

      // Owner Info
      const hasCompany = driver.pay_to_company && driver.pay_to_company.trim();
      const infoBoxHeight = hasCompany ? 26 : 20;
      doc.setFillColor(...lightGray);
      doc.roundedRect(margin, y, pageWidth - margin * 2, infoBoxHeight, 2, 2, 'F');
      doc.setTextColor(...darkGray);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.text('Owner-Operator:', margin + 4, y + 6);
      doc.setFont('helvetica', 'normal');
      doc.text(driver.first_name + ' ' + driver.last_name, margin + 40, y + 6);
      if (hasCompany) {
        doc.setFont('helvetica', 'bold');
        doc.text('Company:', margin + 4, y + 12);
        doc.setFont('helvetica', 'normal');
        doc.text(driver.pay_to_company, margin + 28, y + 12);
      }
      doc.setFont('helvetica', 'bold');
      doc.text('Dispatch Fee:', margin + 4, y + (hasCompany ? 18 : 12));
      doc.setFont('helvetica', 'normal');
      doc.text(dispatchFeePercent + '%', margin + 32, y + (hasCompany ? 18 : 12));
      doc.setFont('helvetica', 'bold');
      doc.text('Settlement #:', pageWidth / 2, y + 6);
      doc.setFont('helvetica', 'normal');
      doc.text(settlementNumber || 'N/A', pageWidth / 2 + 28, y + 6);
      doc.setFont('helvetica', 'bold');
      doc.text('Period:', pageWidth / 2, y + 12);
      doc.setFont('helvetica', 'normal');
      doc.text(fmtDate(periodStart) + ' - ' + fmtDate(periodEnd), pageWidth / 2 + 16, y + 12);
      doc.setFont('helvetica', 'bold');
      doc.text('Settlement Date:', pageWidth / 2, y + 18);
      doc.setFont('helvetica', 'normal');
      doc.text(fmtDate(payDate), pageWidth / 2 + 36, y + 18);
      y += infoBoxHeight + 6;

      // Trip Details Table - now with Order/Vehicle and Type columns
      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...darkGray);
      doc.text('Order Details', margin, y);
      y += 6;

      doc.autoTable({
        startY: y,
        head: [['Date', 'Trip', 'Order/Vehicle', 'Type', 'Revenue', 'Broker', 'Local', 'Clean', 'Disp', 'Cash', 'Settle']],
        body: tripDetails.map(t => [
          fmtDate(t.date),
          t.tripNumber,
          t.orderVehicle || 'N/A',
          t.paymentType || 'BILL',
          fmtMoney(t.revenue),
          fmtMoney(t.brokerFee),
          fmtMoney(t.localFee),
          fmtMoney(t.cleanGross),
          fmtMoney(t.dispatchFee),
          fmtMoney(t.cashCollected),
          fmtMoney(t.settlement)
        ]),
        foot: [['TOTALS', '', '', '', fmtMoney(totalRevenue), fmtMoney(totalBrokerFee), fmtMoney(totalLocalFee), fmtMoney(totalCleanGross), fmtMoney(totalDispatchFee), fmtMoney(totalCashCollected), fmtMoney(totalSettlement)]],
        theme: 'grid',
        headStyles: { fillColor: orange, textColor: [255, 255, 255], fontStyle: 'bold', fontSize: 6 },
        footStyles: { fillColor: [254, 243, 199], textColor: darkGray, fontStyle: 'bold', fontSize: 6 },
        bodyStyles: { fontSize: 6 },
        margin: { left: margin, right: margin },
        columnStyles: {
          0: { cellWidth: 13 },  // Date
          1: { cellWidth: 12 },  // Trip
          2: { cellWidth: 24 },  // Order/Vehicle
          3: { cellWidth: 11 },  // Type
          4: { cellWidth: 15, halign: 'right' },  // Revenue
          5: { cellWidth: 13, halign: 'right' },  // Broker
          6: { cellWidth: 13, halign: 'right' },  // Local
          7: { cellWidth: 15, halign: 'right' },  // Clean
          8: { cellWidth: 13, halign: 'right' },  // Disp
          9: { cellWidth: 13, halign: 'right' },  // Cash
          10: { cellWidth: 15, halign: 'right' }  // Settle
        },
        didParseCell: function(data) {
          // Color-code payment type column
          if (data.column.index === 3 && data.section === 'body') {
            const type = data.cell.raw;
            if (type === 'COD' || type === 'COP') {
              data.cell.styles.textColor = [245, 158, 11]; // orange
              data.cell.styles.fontStyle = 'bold';
            } else if (type === 'CHECK') {
              data.cell.styles.textColor = [16, 185, 129]; // green
            } else if (type === 'LOCAL_COD') {
              data.cell.styles.textColor = [234, 179, 8]; // yellow
            }
          }
        }
      });

      y = doc.lastAutoTable.finalY + 8;

      // Deductions Section (only if there are deductions)
      if (totalDeductions > 0) {
        const red = [220, 38, 38];
        doc.setFillColor(254, 226, 226);
        doc.roundedRect(margin, y, pageWidth - margin * 2, 32, 2, 2, 'F');
        doc.setTextColor(...red);
        doc.setFontSize(9);
        doc.setFont('helvetica', 'bold');
        doc.text('DEDUCTIONS', margin + 4, y + 6);
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(8);
        doc.setTextColor(...darkGray);

        // Build deduction items list
        const dedItems = [];
        if (deductions.ifta > 0) dedItems.push(['IFTA', deductions.ifta]);
        if (deductions.eld > 0) dedItems.push(['ELD', deductions.eld]);
        if (deductions.tolls > 0) dedItems.push(['Tolls', deductions.tolls]);
        if (deductions.insurance > 0) dedItems.push(['Insurance', deductions.insurance]);
        if (deductions.fuel > 0) dedItems.push(['Fuel', deductions.fuel]);
        if (deductions.hut2290 > 0) dedItems.push(['HUT 2290', deductions.hut2290]);
        if (deductions.regRenewal > 0) dedItems.push(['Reg Renewal', deductions.regRenewal]);
        if (deductions.advances > 0) dedItems.push(['Advances', deductions.advances]);
        if (deductions.other > 0) dedItems.push(['Other', deductions.other]);
        if (deductions.custom1?.amount > 0) dedItems.push([deductions.custom1.label || 'Custom 1', deductions.custom1.amount]);
        if (deductions.custom2?.amount > 0) dedItems.push([deductions.custom2.label || 'Custom 2', deductions.custom2.amount]);
        if (deductions.custom3?.amount > 0) dedItems.push([deductions.custom3.label || 'Custom 3', deductions.custom3.amount]);

        // Display deductions in columns
        const dedCol1 = margin + 4;
        const dedCol2 = margin + 65;
        const dedCol3 = margin + 125;
        dedItems.forEach((item, i) => {
          const col = i < 4 ? dedCol1 : (i < 8 ? dedCol2 : dedCol3);
          const row = i % 4;
          doc.text(item[0] + ':', col, y + 12 + row * 4);
          doc.setTextColor(...red);
          doc.text('-' + fmtMoney(item[1]), col + 30, y + 12 + row * 4, { align: 'right' });
          doc.setTextColor(...darkGray);
        });

        // Total deductions
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...red);
        doc.text('Total Deductions: -' + fmtMoney(totalDeductions), pageWidth - margin - 4, y + 28, { align: 'right' });

        y += 36;
      }

      // Summary Box
      doc.setFillColor(254, 243, 199);
      const summaryBoxHeight = totalDeductions > 0 ? 56 : 50;
      doc.roundedRect(margin, y, pageWidth - margin * 2, summaryBoxHeight, 2, 2, 'F');
      doc.setTextColor(...darkGray);
      doc.setFontSize(9);
      const col1 = margin + 5;
      const col1Val = margin + 55;
      const col2 = pageWidth / 2 + 5;
      const col2Val = pageWidth - margin - 5;
      doc.setFont('helvetica', 'normal');
      doc.text('Total Load Revenue:', col1, y + 8);
      doc.text(fmtMoney(totalRevenue), col1Val, y + 8, { align: 'right' });
      doc.text('Less: Broker Fees:', col1, y + 14);
      doc.text('(' + fmtMoney(totalBrokerFee) + ')', col1Val, y + 14, { align: 'right' });
      doc.text('Less: Local Fees:', col1, y + 20);
      doc.text('(' + fmtMoney(totalLocalFee) + ')', col1Val, y + 20, { align: 'right' });
      doc.setFont('helvetica', 'bold');
      doc.text('Clean Revenue:', col2, y + 8);
      doc.text(fmtMoney(totalCleanGross), col2Val, y + 8, { align: 'right' });
      doc.setFont('helvetica', 'normal');
      doc.text('Less: Dispatch (' + dispatchFeePercent + '%):', col2, y + 14);
      doc.text('(' + fmtMoney(totalDispatchFee) + ')', col2Val, y + 14, { align: 'right' });
      doc.text('Less: Cash Collected:', col2, y + 20);
      doc.text('(' + fmtMoney(totalCashCollected) + ')', col2Val, y + 20, { align: 'right' });
      if (totalDeductions > 0) {
        doc.setTextColor(220, 38, 38);
        doc.text('Less: Deductions:', col2, y + 26);
        doc.text('(' + fmtMoney(totalDeductions) + ')', col2Val, y + 26, { align: 'right' });
      }
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(11);
      doc.setTextColor(...orange);
      const settlementY = totalDeductions > 0 ? y + 44 : y + 38;
      doc.text('OWNER SETTLEMENT:', col2, settlementY);
      doc.text(fmtMoney(totalSettlement), col2Val, settlementY, { align: 'right' });

      // Footer
      const footerY = doc.internal.pageSize.getHeight() - 15;
      doc.setFontSize(8);
      doc.setTextColor(...medGray);
      doc.setFont('helvetica', 'normal');
      doc.text('Horizon Star LLC | (800) 555-1234 | settlements@horizonstar.com', pageWidth / 2, footerY, { align: 'center' });
      doc.text('Generated: ' + new Date().toLocaleString(), pageWidth / 2, footerY + 4, { align: 'center' });

      return doc.output('blob');
    }

    // Send Settlement Email
    async function sendSettlementEmail(pdfBlob, email, driver, tripIds, payDate, amount) {
      try {
        const base64 = await blobToBase64(pdfBlob);
        const tripNumbers = tripIds.map(id => appData.trips.find(t => t.id === id)?.trip_number).filter(Boolean).join(', ');

        const response = await fetch(SUPABASE_URL + '/functions/v1/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + SUPABASE_KEY },
          body: JSON.stringify({
            to: email,
            subject: 'Settlement Statement - ' + driver.first_name + ' ' + driver.last_name + ' - ' + formatDate(payDate),
            html: '<p>Please find attached your settlement statement for trips: ' + tripNumbers + '</p><p>Settlement Amount: <strong>' + formatMoney(amount) + '</strong></p><p>Settlement Date: ' + formatDate(payDate) + '</p><p>Thank you for your partnership!</p><p>- Horizon Star LLC</p>',
            attachment: { filename: 'Settlement_' + driver.last_name + '_' + payDate + '.pdf', content: base64, type: 'application/pdf' }
          })
        });

        if (response.ok) {
          showToast('Settlement emailed to ' + email, 'success');
          await logActivity('SETTLEMENT_EMAILED', { driver_id: driver.id, driver_name: driver.first_name + ' ' + driver.last_name, email: email, trips: tripNumbers, amount: amount });
        } else {
          throw new Error('Email failed');
        }
      } catch (e) {
        console.error('Email error:', e);
        showToast('Failed to send email', 'error');
      }
    }

    function updatePaystubTotals() {
      const deductions = ['dedInsurance', 'dedFuel', 'dedFuelDeposit', 'dedELD', 'dedTolls', 'dedIFTA', 'ded2290', 'dedRegRenewal', 'dedOther'];
      const bonuses = ['bonusLevel1', 'bonusLevel2', 'bonusLevel3', 'bonusOther'];
      
      let totalDed = 0;
      deductions.forEach(id => { totalDed += parseFloat(document.getElementById(id)?.value || 0); });
      
      let totalBonus = 0;
      bonuses.forEach(id => { totalBonus += parseFloat(document.getElementById(id)?.value || 0); });
      
      document.getElementById('totalDeductionsDisplay').textContent = totalDed.toFixed(2);
      document.getElementById('totalBonusesDisplay').textContent = totalBonus.toFixed(2);
    }

    // Generate PDF directly using jsPDF (pixel-perfect, no html2canvas issues)
    async function generatePaystubPDF(driver, earnings, selectedTripIds, netPay, totalDriverCut, totalCashCollected, totalExpenses, totalRevenue, periodStart, periodEnd, payDate, stubNumber, checkNumber, deductions, bonuses, totalDeductions, totalBonuses, totalBrokerFee, totalLocalFee, totalCleanGross, avgEarningsPerTrip) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format: 'a4' });

      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = 15;
      let y = margin;

      // Colors (RGB arrays)
      const green = [4, 120, 87];
      const red = [185, 28, 28];
      const darkGray = [17, 24, 39];
      const medGray = [107, 114, 128];
      const lightGray = [243, 244, 246];

      // Local helper functions for PDF
      const fmtMoney = (amt) => '$' + (amt || 0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
      const fmtDate = (d) => d ? new Date(d).toLocaleDateString() : 'N/A';

      // === HEADER WITH LOGO ===
      // Text-based logo (image removed)
      doc.setFillColor(17, 24, 39);
      doc.rect(margin, y, 18, 14, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.text('HS', margin + 9, y + 9, { align: 'center' });
      doc.setTextColor(...darkGray);
      {
        doc.setFontSize(14);
        doc.text('HORIZON STAR', margin + 22, y + 8);
        doc.setFontSize(8);
        doc.setTextColor(...medGray);
        doc.setFont('helvetica', 'normal');
        doc.text('Transportation Services', margin + 22, y + 12);
      }

      // Right side - Document info
      doc.setFontSize(8);
      doc.setTextColor(...medGray);
      doc.text('Official Document', pageWidth - margin, y + 4, { align: 'right' });
      doc.setFontSize(11);
      doc.setTextColor(...darkGray);
      doc.setFont('helvetica', 'bold');
      doc.text('Earnings Statement', pageWidth - margin, y + 10, { align: 'right' });
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8);
      doc.text('Stub No. ' + stubNumber + '  |  Check No. ' + checkNumber, pageWidth - margin, y + 16, { align: 'right' });

      y += 24;

      // === NET PAY BANNER ===
      doc.setFillColor(...green);
      doc.rect(margin, y, pageWidth - margin * 2, 16, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(10);
      doc.text('Net Pay This Period', margin + 5, y + 6);
      doc.setFontSize(18);
      doc.setFont('helvetica', 'bold');
      doc.text(fmtMoney(netPay), margin + 5, y + 13);
      doc.setFont('helvetica', 'normal');

      y += 22;

      // === DRIVER INFO + STATS ===
      doc.setTextColor(...darkGray);
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text(driver.first_name.toUpperCase() + ' ' + driver.last_name.toUpperCase(), margin, y);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);
      doc.setTextColor(...medGray);
      const cutPercent = earnings.length > 0 ? earnings[0].cutPercent : (driver.cut_percent || 0);
      doc.text('Driver | ' + cutPercent + '% Commission Rate', margin, y + 5);

      // Stats boxes on right
      const statBoxWidth = 28;
      const statsX = pageWidth - margin - (statBoxWidth * 3) - 6;
      doc.setFillColor(...lightGray);
      const statsData = [[selectedTripIds.length, 'Trips'], [earnings.length, 'Loads'], [fmtMoney(avgEarningsPerTrip), 'Avg/Trip']];
      statsData.forEach((stat, i) => {
        const x = statsX + (statBoxWidth + 3) * i;
        doc.rect(x, y - 6, statBoxWidth, 14, 'F');
        doc.setTextColor(...darkGray);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'bold');
        doc.text(String(stat[0]), x + statBoxWidth/2, y, { align: 'center' });
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(...medGray);
        doc.text(stat[1], x + statBoxWidth/2, y + 5, { align: 'center' });
      });

      y += 14;

      // === SUMMARY GRID ===
      const summaryData = [
        { label: 'Gross Earnings', value: fmtMoney(totalDriverCut), color: green, bg: [240, 253, 244] },
        { label: 'Cash Collected', value: '-' + fmtMoney(totalCashCollected), color: red, bg: [254, 242, 242] },
        { label: 'Reimbursements', value: '+' + fmtMoney(totalExpenses), color: green, bg: [249, 250, 251] },
        { label: 'Total Revenue', value: fmtMoney(totalRevenue), color: darkGray, bg: [249, 250, 251] }
      ];
      const boxWidth = (pageWidth - margin * 2 - 9) / 4;
      summaryData.forEach((item, i) => {
        const x = margin + (boxWidth + 3) * i;
        doc.setFillColor(...item.bg);
        doc.rect(x, y, boxWidth, 18, 'F');
        doc.setTextColor(...item.color);
        doc.setFontSize(13);
        doc.setFont('helvetica', 'bold');
        doc.text(item.value, x + boxWidth/2, y + 8, { align: 'center' });
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(...medGray);
        doc.text(item.label.toUpperCase(), x + boxWidth/2, y + 14, { align: 'center' });
      });

      y += 24;

      // === EARNINGS TABLE HEADER ===
      doc.setFillColor(...lightGray);
      doc.rect(margin, y, pageWidth - margin * 2, 8, 'F');
      doc.setDrawColor(17, 24, 39);
      doc.setLineWidth(0.5);
      doc.line(margin, y, margin + 2, y + 8);
      doc.setTextColor(...darkGray);
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      doc.text('EARNINGS DETAIL', margin + 6, y + 5.5);
      doc.setFont('helvetica', 'normal');

      y += 10;

      // Build table with AutoTable - includes Order/Vehicle and Payment Type columns
      const tableHeaders = ['Date', 'Trip', 'Order/Vehicle', 'Type', 'Revenue', 'Broker', 'Local', 'Clean', 'Cut', '%', 'Cash'];
      const tableData = earnings.map(e => [
        fmtDate(e.date),
        e.tripNumber,
        e.orderVehicle || 'N/A',
        e.paymentType || 'BILL',
        fmtMoney(e.revenue),
        e.brokerFee > 0 ? '-' + fmtMoney(e.brokerFee) : '',
        e.localFee > 0 ? '-' + fmtMoney(e.localFee) : '',
        fmtMoney(e.cleanGross),
        fmtMoney(e.driverCut),
        e.cutPercent.toFixed(0) + '%',
        e.cashOnHand > 0 ? fmtMoney(e.cashOnHand) : ''
      ]);

      // Add total row
      tableData.push([
        'TOTAL', '', '', '',
        fmtMoney(totalRevenue),
        '-' + fmtMoney(totalBrokerFee),
        '-' + fmtMoney(totalLocalFee),
        fmtMoney(totalCleanGross),
        fmtMoney(totalDriverCut),
        cutPercent.toFixed(0) + '%',
        fmtMoney(totalCashCollected)
      ]);

      doc.autoTable({
        startY: y,
        head: [tableHeaders],
        body: tableData,
        margin: { left: margin, right: margin },
        styles: { fontSize: 6, cellPadding: 1.5 },
        headStyles: { fillColor: [249, 250, 251], textColor: [107, 114, 128], fontStyle: 'bold', fontSize: 6 },
        bodyStyles: { textColor: [17, 24, 39] },
        columnStyles: {
          0: { cellWidth: 14 },  // Date
          1: { cellWidth: 14 },  // Trip
          2: { cellWidth: 28 },  // Order/Vehicle
          3: { cellWidth: 12 },  // Type
          4: { halign: 'right', cellWidth: 16 },  // Revenue
          5: { halign: 'right', textColor: red, cellWidth: 14 },  // Broker
          6: { halign: 'right', textColor: red, cellWidth: 14 },  // Local
          7: { halign: 'right', cellWidth: 16 },  // Clean
          8: { halign: 'right', textColor: green, fontStyle: 'bold', cellWidth: 16 },  // Cut
          9: { halign: 'center', cellWidth: 10 },  // %
          10: { halign: 'right', cellWidth: 16 }  // Cash
        },
        didParseCell: function(data) {
          if (data.row.index === tableData.length - 1) {
            data.cell.styles.fillColor = [243, 244, 246];
            data.cell.styles.fontStyle = 'bold';
          }
          // Color-code payment type
          if (data.column.index === 3 && data.row.index < tableData.length - 1) {
            const type = data.cell.raw;
            if (type === 'COD' || type === 'COP') {
              data.cell.styles.textColor = [245, 158, 11]; // orange
              data.cell.styles.fontStyle = 'bold';
            } else if (type === 'CHECK') {
              data.cell.styles.textColor = [16, 185, 129]; // green
            } else if (type === 'LOCAL_COD') {
              data.cell.styles.textColor = [234, 179, 8]; // yellow
            }
          }
        }
      });

      y = doc.lastAutoTable.finalY + 8;

      // === DEDUCTIONS & BONUSES (two columns) ===
      const colWidth = (pageWidth - margin * 2 - 4) / 2;

      // Deductions column
      doc.setDrawColor(229, 231, 235);
      doc.rect(margin, y, colWidth, 50);
      doc.setFillColor(...red);
      doc.rect(margin, y, colWidth, 8, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(8);
      doc.setFont('helvetica', 'bold');
      doc.text(' DEDUCTIONS', margin + 4, y + 5.5);

      let dedY = y + 14;
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(...darkGray);
      const dedItems = [
        ['Insurance', deductions.insurance],
        ['Fuel', deductions.fuel],
        ['Fuel Deposit', deductions.fuelDeposit],
        ['ELD', deductions.eld],
        ['Tolls', deductions.tolls],
        ['IFTA', deductions.ifta],
        ['HUT 2290', deductions.hut2290],
        ['Reg Renewal', deductions.regRenewal],
        ['Other', deductions.other]
      ].filter(d => d[1] > 0);

      if (dedItems.length > 0) {
        dedItems.forEach(([label, amt]) => {
          doc.setFontSize(8);
          doc.setTextColor(...darkGray);
          doc.text(label, margin + 4, dedY);
          doc.setTextColor(...red);
          doc.text('-' + fmtMoney(amt), margin + colWidth - 4, dedY, { align: 'right' });
          dedY += 5;
        });
        // Total deductions
        doc.setFillColor(254, 242, 242);
        doc.rect(margin + 2, y + 40, colWidth - 4, 8, 'F');
        doc.setTextColor(...red);
        doc.setFont('helvetica', 'bold');
        doc.text('Total: -' + fmtMoney(totalDeductions), margin + colWidth - 4, y + 45, { align: 'right' });
      } else {
        doc.setTextColor(...medGray);
        doc.setFontSize(8);
        doc.text('No deductions this period', margin + colWidth/2, y + 28, { align: 'center' });
      }

      // Bonuses column
      const bonusX = margin + colWidth + 4;
      doc.setDrawColor(229, 231, 235);
      doc.rect(bonusX, y, colWidth, 50);
      doc.setFillColor(...green);
      doc.rect(bonusX, y, colWidth, 8, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFont('helvetica', 'bold');
      doc.text('+ BONUSES & ADDITIONS', bonusX + 4, y + 5.5);

      let bonY = y + 14;
      doc.setFont('helvetica', 'normal');
      const bonItems = [
        ['Expense Reimbursements', totalExpenses],
        ['Level I Inspection', bonuses.level1],
        ['Level II Inspection', bonuses.level2],
        ['Level III Inspection', bonuses.level3],
        ['Other Bonus', bonuses.other]
      ].filter(b => b[1] > 0);

      if (bonItems.length > 0) {
        bonItems.forEach(([label, amt]) => {
          doc.setFontSize(8);
          doc.setTextColor(...darkGray);
          doc.text(label, bonusX + 4, bonY);
          doc.setTextColor(...green);
          doc.text('+' + fmtMoney(amt), bonusX + colWidth - 4, bonY, { align: 'right' });
          bonY += 5;
        });
        // Total bonuses
        doc.setFillColor(240, 253, 244);
        doc.rect(bonusX + 2, y + 40, colWidth - 4, 8, 'F');
        doc.setTextColor(...green);
        doc.setFont('helvetica', 'bold');
        doc.text('Total: +' + fmtMoney(totalBonuses + totalExpenses), bonusX + colWidth - 4, y + 45, { align: 'right' });
      } else {
        doc.setTextColor(...medGray);
        doc.setFontSize(8);
        doc.text('No bonuses this period', bonusX + colWidth/2, y + 28, { align: 'center' });
      }

      y += 56;

      // === CHECK STUB ===
      doc.setDrawColor(...darkGray);
      doc.setLineWidth(0.5);
      doc.rect(margin, y, pageWidth - margin * 2, 32);

      // Check header
      doc.setFillColor(249, 250, 251);
      doc.rect(margin, y, pageWidth - margin * 2, 10, 'F');
      doc.setTextColor(...darkGray);
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      doc.text('Horizon Star, LLC', margin + 4, y + 5);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(7);
      doc.text('118 Mary Ambler Way, Ambler, PA 19002', margin + 4, y + 8);
      doc.setFontSize(8);
      doc.text('Check No. ' + checkNumber, pageWidth - margin - 4, y + 5, { align: 'right' });
      doc.text('Date: ' + fmtDate(payDate), pageWidth - margin - 4, y + 8, { align: 'right' });

      // Check body
      doc.setFontSize(7);
      doc.setTextColor(...medGray);
      doc.text('PAY TO THE ORDER OF', margin + 4, y + 15);
      doc.setTextColor(...darkGray);
      doc.setFontSize(12);
      doc.setFont('helvetica', 'bold');
      doc.text(driver.first_name.toUpperCase() + ' ' + driver.last_name.toUpperCase(), margin + 4, y + 21);

      // Amount box
      const amtColor = netPay >= 0 ? green : red;
      doc.setFillColor(netPay >= 0 ? 240 : 254, netPay >= 0 ? 253 : 242, netPay >= 0 ? 244 : 242);
      doc.setDrawColor(...amtColor);
      doc.rect(pageWidth - margin - 45, y + 13, 41, 12, 'FD');
      doc.setTextColor(...amtColor);
      doc.setFontSize(14);
      doc.text(fmtMoney(netPay), pageWidth - margin - 24.5, y + 21, { align: 'center' });

      // Check footer
      doc.setFillColor(...darkGray);
      doc.rect(margin, y + 27, pageWidth - margin * 2, 5, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(6);
      doc.setFont('helvetica', 'normal');
      doc.text('This is not a negotiable instrument', margin + 4, y + 30.5);
      doc.text('For record keeping purposes only', pageWidth - margin - 4, y + 30.5, { align: 'right' });

      y += 38;

      // === FOOTER ===
      doc.setTextColor(...medGray);
      doc.setFontSize(7);
      doc.text('Horizon Star, LLC | 118 Mary Ambler Way, Ambler, PA 19002 | (267) 334-1834', pageWidth/2, y, { align: 'center' });
      doc.text('Statement generated ' + new Date().toLocaleDateString() + ' at ' + new Date().toLocaleTimeString(), pageWidth/2, y + 4, { align: 'center' });

      // Return PDF blob
      return doc.output('blob');
    }

    async function generatePaystub(driverId, action = 'print') {
      // action can be: 'print', 'email', or 'both'
      const driver = appData.drivers.find(d => d.id === driverId);
      const selectedTripIds = Array.from(document.querySelectorAll('.paystub-trip:checked')).map(cb => parseInt(cb.value));
      
      if (selectedTripIds.length === 0) { showToast('Please select at least one trip', 'error'); return; }
      
      const stubNumber = document.getElementById('stubNumber').value;
      const checkNumber = document.getElementById('checkNumber').value;
      const periodStart = document.getElementById('periodStart').value;
      const periodEnd = document.getElementById('periodEnd').value;
      const payDate = document.getElementById('payDate').value;
      
      // Get itemized deductions
      const deductions = {
        insurance: parseFloat(document.getElementById('dedInsurance').value) || 0,
        fuel: parseFloat(document.getElementById('dedFuel').value) || 0,
        fuelDeposit: parseFloat(document.getElementById('dedFuelDeposit').value) || 0,
        eld: parseFloat(document.getElementById('dedELD').value) || 0,
        tolls: parseFloat(document.getElementById('dedTolls').value) || 0,
        ifta: parseFloat(document.getElementById('dedIFTA').value) || 0,
        hut2290: parseFloat(document.getElementById('ded2290').value) || 0,
        regRenewal: parseFloat(document.getElementById('dedRegRenewal').value) || 0,
        other: parseFloat(document.getElementById('dedOther').value) || 0
      };
      const totalDeductions = Object.values(deductions).reduce((a, b) => a + b, 0);
      
      // Get itemized bonuses
      const bonuses = {
        level1: parseFloat(document.getElementById('bonusLevel1').value) || 0,
        level2: parseFloat(document.getElementById('bonusLevel2').value) || 0,
        level3: parseFloat(document.getElementById('bonusLevel3').value) || 0,
        other: parseFloat(document.getElementById('bonusOther').value) || 0
      };
      const totalBonuses = Object.values(bonuses).reduce((a, b) => a + b, 0);
      
      // For backward compatibility
      const otherAdditions = totalBonuses;
      const otherDeductions = totalDeductions;
      
      // Gather all order data for selected trips
      let earnings = [];
      let totalRevenue = 0, totalBrokerFee = 0, totalLocalFee = 0, totalCleanGross = 0, totalDriverCut = 0;
      let totalCashCollected = 0, totalExpenses = 0;
      
      selectedTripIds.forEach(tripId => {
        const trip = appData.trips.find(t => t.id === tripId);
        const orders = appData.orders.filter(o => o.trip_id === tripId);
        const expenses = appData.expenses.filter(e => e.trip_id === tripId);
        const cutPercent = trip.driver_cut_percent || driver.cut_percent || 32;
        
        orders.forEach(o => {
          const revenue = parseFloat(o.revenue || 0);
          const brokerFee = parseFloat(o.broker_fee || 0);
          const localFee = parseFloat(o.local_fee || 0);
          const cleanGross = revenue - brokerFee - localFee;
          const driverCut = cleanGross * (cutPercent / 100);
          const isCash = o.payment_type === 'COD' || o.payment_type === 'COP'; // LOCAL_COD goes to local driver
          // For split payments, only count cod_amount as cash on hand
          const hasBillPortion = parseFloat(o.bill_amount || 0) > 0;
          const cashOnHand = isCash ? (hasBillPortion ? parseFloat(o.cod_amount || 0) : revenue) : 0;
          
          // Build order/vehicle label
          const vehicleInfo = [o.vehicle_year, o.vehicle_make].filter(Boolean).join(' ');
          const orderVehicle = o.order_number ? (o.order_number + (vehicleInfo ? ' ' + vehicleInfo : '')) : (vehicleInfo || 'N/A');

          earnings.push({
            date: trip.trip_date,
            tripNumber: trip.trip_number,
            orderVehicle,
            paymentType: o.payment_type || 'BILL',
            revenue,
            brokerFee,
            localFee,
            cleanGross,
            driverCut,
            cutPercent,
            cashOnHand,
            isCash
          });
          
          totalRevenue += revenue;
          totalBrokerFee += brokerFee;
          totalLocalFee += localFee;
          totalCleanGross += cleanGross;
          totalDriverCut += driverCut;
          if (isCash) totalCashCollected += cashOnHand;
        });
        
        // Only reimburse OTHER category expenses
        expenses.forEach(e => {
          if (e.category === 'OTHER') {
            totalExpenses += parseFloat(e.amount || 0);
          }
        });
      });
      
      const netPay = totalDriverCut - totalCashCollected + totalExpenses + otherAdditions - otherDeductions;
      
      // Calculate additional metrics for the statement
      const avgEarningsPerTrip = selectedTripIds.length > 0 ? totalDriverCut / selectedTripIds.length : 0;
      const avgRevenuePerLoad = earnings.length > 0 ? totalRevenue / earnings.length : 0;
      const cashCollectedPercent = totalDriverCut > 0 ? (totalCashCollected / totalDriverCut * 100) : 0;
      
      // Generate professional paystub HTML
      const paystubHTML = `
<!DOCTYPE html>
<html>
<head>
  <title>Earnings Statement - ${driver.first_name} ${driver.last_name}</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
      font-size: 12px; 
      background: var(--bg-card);
      color: var(--text-primary);
      line-height: 1.4;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    .page { max-width: 800px; margin: 0 auto; padding: 0; }
    
    /* Header */
    .header {
      background: var(--text-primary);
      color: white;
      padding: 24px 32px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .brand { display: flex; align-items: center; gap: 16px; }
    .brand-mark {
      width: 48px; height: 48px;
      background: var(--bg-card);
      color: var(--text-primary);
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; font-weight: 700;
      letter-spacing: -1px;
    }
    .brand-text { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
    .brand-sub { font-size: 11px; opacity: 0.7; margin-top: 2px; font-weight: 400; }
    .doc-info { text-align: right; }
    .doc-title { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; opacity: 0.7; }
    .doc-type { font-size: 18px; font-weight: 600; margin: 4px 0 12px; }
    .doc-meta { font-size: 11px; opacity: 0.85; }
    .doc-meta-row { display: flex; justify-content: flex-end; gap: 24px; margin: 2px 0; }
    .doc-meta-label { opacity: 0.7; }
    .doc-meta-value { font-weight: 600; }
    
    /* Amount Banner */
    .amount-banner {
      background: ${netPay >= 0 ? 'var(--green)' : 'var(--red)'};
      color: white;
      padding: 28px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .amount-label { font-size: 13px; text-transform: uppercase; letter-spacing: 1px; font-weight: 500; }
    .amount-value { font-size: 36px; font-weight: 700; letter-spacing: -1px; }
    
    /* Content Area */
    .content { padding: 24px 32px; background: var(--bg-card); }
    
    /* Driver Section */
    .driver-section {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--bg-elevated);
      margin-bottom: 20px;
    }
    .driver-info h2 { font-size: 16px; font-weight: 600; color: var(--text-primary); }
    .driver-detail { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
    .driver-stats { display: flex; gap: 32px; }
    .stat-block { text-align: right; }
    .stat-value { font-size: 18px; font-weight: 700; color: var(--text-primary); }
    .stat-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
    
    /* Summary Grid */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 24px;
    }
    .summary-item {
      background: var(--bg-app);
      border: 1px solid var(--bg-elevated);
      padding: 14px;
      text-align: center;
    }
    .summary-item.highlight { background: var(--green-dim); border-color: var(--green-dim); }
    .summary-item.negative { background: var(--red-dim); border-color: var(--red-dim); }
    .summary-amount { font-size: 18px; font-weight: 700; color: var(--text-primary); }
    .summary-amount.green { color: var(--green); }
    .summary-amount.red { color: var(--red); }
    .summary-label { font-size: 9px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
    
    /* Section Headers */
    .section-header {
      background: var(--bg-card-hover);
      padding: 10px 16px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-secondary);
      margin: 24px 0 0;
      border-left: 3px solid var(--text-primary);
    }
    
    /* Tables */
    table { width: 100%; border-collapse: collapse; margin-top: 0; }
    thead { background: var(--bg-app); }
    th { 
      padding: 10px 8px; 
      text-align: left; 
      font-weight: 600; 
      color: var(--text-secondary);
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--bg-elevated);
    }
    td { 
      padding: 10px 8px; 
      border-bottom: 1px solid var(--bg-card-hover);
      font-size: 11px;
    }
    .text-right { text-align: right; }
    .text-center { text-align: center; }
    .mono { font-family: 'SF Mono', Monaco, 'Courier New', monospace; font-size: 11px; }
    .text-green { color: var(--green); }
    .text-red { color: var(--red); }
    .text-muted { color: var(--text-muted); }
    .font-medium { font-weight: 500; }
    .font-semibold { font-weight: 600; }
    
    .total-row { background: var(--bg-card-hover); }
    .total-row td { font-weight: 600; padding: 12px 8px; border-bottom: none; }
    
    .trip-badge {
      display: inline-block;
      background: var(--bg-elevated);
      color: var(--text-secondary);
      padding: 2px 8px;
      font-size: 10px;
      font-weight: 500;
    }
    .cash-badge {
      display: inline-block;
      background: var(--green-dim);
      color: var(--green);
      padding: 2px 8px;
      font-size: 10px;
      font-weight: 500;
    }
    
    /* Two Column Layout */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      margin-top: 24px;
    }
    .col { padding: 16px; border: 1px solid var(--bg-elevated); }
    .col:first-child { border-right: none; }
    .col-header {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding-bottom: 12px;
      margin-bottom: 12px;
      border-bottom: 1px solid var(--bg-elevated);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .col-header.red { color: var(--red); border-color: var(--red-dim); }
    .col-header.green { color: var(--green); border-color: var(--green-dim); }
    .col-icon {
      width: 20px; height: 20px;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 700;
    }
    .line-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 11px;
      border-bottom: 1px dashed var(--bg-card-hover);
    }
    .line-item:last-of-type { border-bottom: none; }
    .line-total {
      display: flex;
      justify-content: space-between;
      padding: 12px;
      margin-top: 12px;
      font-weight: 600;
      font-size: 12px;
    }
    .line-total.red { background: var(--red-dim); color: var(--red); }
    .line-total.green { background: var(--green-dim); color: var(--green); }
    .empty-state {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
      font-size: 11px;
      font-style: italic;
    }
    
    /* Check Stub */
    .check-stub {
      margin-top: 32px;
      border: 2px solid var(--text-primary);
    }
    .check-header {
      background: var(--bg-app);
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid var(--bg-elevated);
    }
    .check-company { font-size: 11px; color: var(--text-secondary); }
    .check-company strong { display: block; color: var(--text-primary); font-size: 12px; margin-bottom: 2px; }
    .check-numbers { text-align: right; font-size: 11px; }
    .check-numbers strong { font-size: 13px; }
    .check-body {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .pay-to-label { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
    .pay-to-name { font-size: 16px; font-weight: 700; color: var(--text-primary); margin: 4px 0; }
    .check-amount-box {
      background: ${netPay >= 0 ? 'var(--green-dim)' : 'var(--red-dim)'};
      border: 2px solid ${netPay >= 0 ? 'var(--green)' : 'var(--red)'};
      padding: 12px 24px;
      text-align: center;
    }
    .check-amount-value {
      font-size: 24px;
      font-weight: 700;
      color: ${netPay >= 0 ? 'var(--green)' : 'var(--red)'};
    }
    .check-footer {
      background: var(--text-primary);
      color: white;
      padding: 8px 20px;
      display: flex;
      justify-content: space-between;
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    /* Footer */
    .footer {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--bg-elevated);
      text-align: center;
      font-size: 10px;
      color: var(--text-muted);
    }
    
    /* Print Button */
    .print-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 24px;
      background: var(--text-primary);
      color: white;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .print-btn:hover { background: var(--text-primary); }
    
    @media print {
      body { background: white; }
      .page { padding: 0; max-width: none; }
      .print-btn { display: none; }
    }
    /* PDF Export styles (for html2canvas capture) */
    body.pdf-export { margin: 0 !important; padding: 0 !important; background: white !important; }
    body.pdf-export .print-btn { display: none !important; }
    body.pdf-export .page { margin: 0 !important; padding: 20px !important; max-width: none !important; }
  </style>
</head>
<body>
  <button class="print-btn" onclick="window.print()">
    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5 1a2 2 0 0 0-2 2v1h10V3a2 2 0 0 0-2-2H5zm6 8H5a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1z"/><path d="M0 7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v-2a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2H2a2 2 0 0 1-2-2V7zm2.5 1a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1z"/></svg>
    Print Statement
  </button>
  
  <div class="page">
    <!-- Header -->
    <div class="header">
      <div class="brand">
        <div class="brand-mark">HS</div>
        <div>
          <div class="brand-text">HORIZON STAR</div>
          <div class="brand-sub">Transportation Services</div>
        </div>
      </div>
      <div class="doc-info">
        <div class="doc-title">Official Document</div>
        <div class="doc-type">Earnings Statement</div>
        <div class="doc-meta">
          <div class="doc-meta-row">
            <span><span class="doc-meta-label">Stub No.</span> <span class="doc-meta-value">${stubNumber}</span></span>
            <span><span class="doc-meta-label">Check No.</span> <span class="doc-meta-value">${checkNumber}</span></span>
          </div>
          <div class="doc-meta-row">
            <span><span class="doc-meta-label">Period</span> <span class="doc-meta-value">${formatDate(periodStart)} - ${formatDate(periodEnd)}</span></span>
          </div>
          <div class="doc-meta-row">
            <span><span class="doc-meta-label">Pay Date</span> <span class="doc-meta-value">${formatDate(payDate)}</span></span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Amount Banner -->
    <div class="amount-banner">
      <div class="amount-label">Net Pay This Period</div>
      <div class="amount-value">${formatMoney(netPay)}</div>
    </div>
    
    <div class="content">
      <!-- Driver Section -->
      <div class="driver-section">
        <div class="driver-info">
          <h2>${driver.first_name.toUpperCase()} ${driver.last_name.toUpperCase()}</h2>
          <div class="driver-detail">Driver | ${earnings.length > 0 ? earnings[0].cutPercent : driver.cut_percent}% Commission Rate</div>
        </div>
        <div class="driver-stats">
          <div class="stat-block">
            <div class="stat-value">${selectedTripIds.length}</div>
            <div class="stat-label">Trips</div>
          </div>
          <div class="stat-block">
            <div class="stat-value">${earnings.length}</div>
            <div class="stat-label">Loads</div>
          </div>
          <div class="stat-block">
            <div class="stat-value">${formatMoney(avgEarningsPerTrip)}</div>
            <div class="stat-label">Avg Per Trip</div>
          </div>
        </div>
      </div>
      
      <!-- Summary Grid -->
      <div class="summary-grid">
        <div class="summary-item highlight">
          <div class="summary-amount green">${formatMoney(totalDriverCut)}</div>
          <div class="summary-label">Gross Earnings</div>
        </div>
        <div class="summary-item negative">
          <div class="summary-amount red">-${formatMoney(totalCashCollected)}</div>
          <div class="summary-label">Cash Collected</div>
        </div>
        <div class="summary-item">
          <div class="summary-amount green">+${formatMoney(totalExpenses)}</div>
          <div class="summary-label">Reimbursements</div>
        </div>
        <div class="summary-item">
          <div class="summary-amount">${formatMoney(totalRevenue)}</div>
          <div class="summary-label">Total Revenue</div>
        </div>
      </div>
      
      <!-- Earnings Table -->
      <div class="section-header">Earnings Detail</div>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Trip</th>
            <th class="text-right">Revenue</th>
            <th class="text-right">Broker Fee</th>
            <th class="text-right">Local Fee</th>
            <th class="text-right">Clean Gross</th>
            <th class="text-right">Driver Cut</th>
            <th class="text-center">Rate</th>
            <th class="text-right">Cash</th>
          </tr>
        </thead>
        <tbody>
          ${earnings.map(e => `
            <tr>
              <td class="mono">${formatDate(e.date)}</td>
              <td><span class="trip-badge">${e.tripNumber}</span></td>
              <td class="text-right mono">${formatMoney(e.revenue)}</td>
              <td class="text-right mono text-red">${e.brokerFee > 0 ? '-' + formatMoney(e.brokerFee) : '<span class="text-muted"></span>'}</td>
              <td class="text-right mono text-red">${e.localFee > 0 ? '-' + formatMoney(e.localFee) : '<span class="text-muted"></span>'}</td>
              <td class="text-right mono font-medium">${formatMoney(e.cleanGross)}</td>
              <td class="text-right mono font-semibold text-green">${formatMoney(e.driverCut)}</td>
              <td class="text-center">${e.cutPercent.toFixed(0)}%</td>
              <td class="text-right">${e.cashOnHand > 0 ? '<span class="cash-badge">' + formatMoney(e.cashOnHand) + '</span>' : '<span class="text-muted"></span>'}</td>
            </tr>
          `).join('')}
          <tr class="total-row">
            <td colspan="2">TOTAL</td>
            <td class="text-right mono">${formatMoney(totalRevenue)}</td>
            <td class="text-right mono text-red">-${formatMoney(totalBrokerFee)}</td>
            <td class="text-right mono text-red">-${formatMoney(totalLocalFee)}</td>
            <td class="text-right mono">${formatMoney(totalCleanGross)}</td>
            <td class="text-right mono text-green">${formatMoney(totalDriverCut)}</td>
            <td class="text-center">${earnings.length > 0 ? earnings[0].cutPercent.toFixed(0) : 0}%</td>
            <td class="text-right mono">${formatMoney(totalCashCollected)}</td>
          </tr>
        </tbody>
      </table>
      
      <!-- Deductions & Bonuses -->
      <div class="two-col">
        <div class="col">
          <div class="col-header red">
            <span class="col-icon"></span>
            Deductions
          </div>
          ${totalDeductions > 0 ? `
            ${deductions.insurance > 0 ? `<div class="line-item"><span>Insurance (Cargo/Liability/Physical)</span><span class="text-red mono">-${formatMoney(deductions.insurance)}</span></div>` : ''}
            ${deductions.fuel > 0 ? `<div class="line-item"><span>Fuel</span><span class="text-red mono">-${formatMoney(deductions.fuel)}</span></div>` : ''}
            ${deductions.fuelDeposit > 0 ? `<div class="line-item"><span>Fuel Deposit</span><span class="text-red mono">-${formatMoney(deductions.fuelDeposit)}</span></div>` : ''}
            ${deductions.eld > 0 ? `<div class="line-item"><span>ELD</span><span class="text-red mono">-${formatMoney(deductions.eld)}</span></div>` : ''}
            ${deductions.tolls > 0 ? `<div class="line-item"><span>Tolls</span><span class="text-red mono">-${formatMoney(deductions.tolls)}</span></div>` : ''}
            ${deductions.ifta > 0 ? `<div class="line-item"><span>IFTA</span><span class="text-red mono">-${formatMoney(deductions.ifta)}</span></div>` : ''}
            ${deductions.hut2290 > 0 ? `<div class="line-item"><span>Highway Use Tax (2290)</span><span class="text-red mono">-${formatMoney(deductions.hut2290)}</span></div>` : ''}
            ${deductions.regRenewal > 0 ? `<div class="line-item"><span>Registration Renewal</span><span class="text-red mono">-${formatMoney(deductions.regRenewal)}</span></div>` : ''}
            ${deductions.other > 0 ? `<div class="line-item"><span>Other Deductions</span><span class="text-red mono">-${formatMoney(deductions.other)}</span></div>` : ''}
            <div class="line-total red">
              <span>Total Deductions</span>
              <span>-${formatMoney(totalDeductions)}</span>
            </div>
          ` : '<div class="empty-state">No deductions this period</div>'}
        </div>
        
        <div class="col">
          <div class="col-header green">
            <span class="col-icon">+</span>
            Bonuses & Additions
          </div>
          ${totalBonuses > 0 || totalExpenses > 0 ? `
            ${totalExpenses > 0 ? `<div class="line-item"><span>Expense Reimbursements</span><span class="text-green mono">+${formatMoney(totalExpenses)}</span></div>` : ''}
            ${bonuses.level1 > 0 ? `<div class="line-item"><span>Level I Inspection Bonus</span><span class="text-green mono">+${formatMoney(bonuses.level1)}</span></div>` : ''}
            ${bonuses.level2 > 0 ? `<div class="line-item"><span>Level II Inspection Bonus</span><span class="text-green mono">+${formatMoney(bonuses.level2)}</span></div>` : ''}
            ${bonuses.level3 > 0 ? `<div class="line-item"><span>Level III Inspection Bonus</span><span class="text-green mono">+${formatMoney(bonuses.level3)}</span></div>` : ''}
            ${bonuses.other > 0 ? `<div class="line-item"><span>Other Bonus</span><span class="text-green mono">+${formatMoney(bonuses.other)}</span></div>` : ''}
            <div class="line-total green">
              <span>Total Additions</span>
              <span>+${formatMoney(totalBonuses + totalExpenses)}</span>
            </div>
          ` : '<div class="empty-state">No bonuses this period</div>'}
        </div>
      </div>
      
      <!-- Check Stub -->
      <div class="check-stub">
        <div class="check-header">
          <div class="check-company">
            <strong>Horizon Star, LLC</strong>
            118 Mary Ambler Way, Ambler, PA 19002<br>
            (267) 334-1834
          </div>
          <div class="check-numbers">
            Check No. <strong>${checkNumber}</strong><br>
            Date: ${formatDate(payDate)}
          </div>
        </div>
        <div class="check-body">
          <div>
            <div class="pay-to-label">Pay to the order of</div>
            <div class="pay-to-name">${driver.first_name.toUpperCase()} ${driver.last_name.toUpperCase()}</div>
          </div>
          <div class="check-amount-box">
            <div class="check-amount-value">${formatMoney(netPay)}</div>
          </div>
        </div>
        <div class="check-footer">
          <span>This is not a negotiable instrument</span>
          <span>For record keeping purposes only</span>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="footer">
        Horizon Star, LLC | 118 Mary Ambler Way, Ambler, PA 19002 | (267) 334-1834<br>
        Statement generated ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}
      </div>
    </div>
  </div>
</body>
</html>`;
      
      // Handle based on action type
      const driverEmail = document.getElementById('driverEmail').value;
      const shouldPrint = action === 'print' || action === 'both';
      const shouldEmail = action === 'email' || action === 'both';
      
      // Open print window if needed
      if (shouldPrint) {
        const printWindow = window.open('', '_blank');
        printWindow.document.write(paystubHTML);
        printWindow.document.close();
      }
      
      // Send email directly via Supabase Edge Function if requested
      if (shouldEmail) {
        if (!driverEmail) {
          showToast('Please enter driver email address', 'error');
          return;
        }

        // Show sending indicator
        showToast('Generating PDF and sending email to ' + driverEmail + '...', 'info');

        try {
          // Generate PDF directly using jsPDF (no html2canvas - much more reliable)
          const pdfBlob = await generatePaystubPDF(
            driver, earnings, selectedTripIds, netPay,
            totalDriverCut, totalCashCollected, totalExpenses, totalRevenue,
            periodStart, periodEnd, payDate, stubNumber, checkNumber,
            deductions, bonuses, totalDeductions, totalBonuses,
            totalBrokerFee, totalLocalFee, totalCleanGross, avgEarningsPerTrip
          );

          // Convert PDF to base64
          const base64Pdf = await blobToBase64(pdfBlob);

          // Get trip numbers for email body
          const selectedTrips = selectedTripIds.map(id => appData.trips.find(t => t.id === id)).filter(t => t);
          const tripNames = selectedTrips.map(t => t.trip_number).join(', ');

          const emailSubject = 'Earnings Statement - ' + driver.first_name + ' ' + driver.last_name + ' - Pay Date: ' + formatDate(payDate);
          const emailBody = 'Hello ' + driver.first_name + ',\n\nPlease find attached your Earnings Statement for ' + tripNames + '.\n\nPay Date: ' + formatDate(payDate) + '\nNet Pay: ' + formatMoney(netPay) + '\n\nThank you,\nHorizon Star TMS';

          // Send email with PDF attachment
          await sendEarningsEmail(
            driverEmail,
            driver.first_name + ' ' + driver.last_name,
            emailSubject,
            null, // no HTML body
            emailBody,
            {
              filename: 'Earnings_Statement_' + driver.last_name + '_' + formatDate(payDate).replace(/\//g, '-') + '.pdf',
              content: base64Pdf
            }
          );

          showToast('Email sent successfully to ' + driverEmail + '!', 'success');

          // Log the activity
          await logActivity('PAYSTUB_EMAILED', {
            driver_id: driverId,
            driver_name: driver.first_name + ' ' + driver.last_name,
            email: driverEmail,
            stub_number: stubNumber,
            net_pay: netPay,
            period: formatDate(periodStart) + ' - ' + formatDate(periodEnd)
          });

        } catch (error) {
          console.error('Email send error:', error);
          showToast('Failed to send email: ' + (error.text || error.message || 'Unknown error'), 'error');
          return;
        }
      }
      
      document.querySelector('.modal-overlay').remove();
      if (shouldPrint && !shouldEmail) {
        showToast('Paystub generated! Print window opened.');
      } else if (!shouldPrint && shouldEmail) {
        // Already showed success message
      } else if (shouldPrint && shouldEmail) {
        showToast('Paystub printed and emailed successfully!');
      }
    }

    // ============ BILL OF LADING (BOL) PDF GENERATION ============
    async function generateBOLPDF(orderId, returnBase64 = false) {
      const order = appData.orders.find(o => o.id === orderId);
      if (!order) { showToast('Order not found', 'error'); return null; }

      showToast('Generating Bill of Lading...', 'info');

      // Fetch inspections, photos, and damages
      let inspections = [], photos = [];
      try {
        inspections = await dbFetch('vehicle_inspections', { filter: { order_id: 'eq.' + orderId } }) || [];
        if (inspections.length > 0) {
          const inspectionIds = inspections.map(i => i.id);
          photos = await dbFetch('inspection_photos', { filter: { inspection_id: 'in.(' + inspectionIds.join(',') + ')' } }) || [];
        }
      } catch (e) {
        console.log('Could not load inspections:', e);
      }

      const pickupInsp = inspections.find(i => i.inspection_type === 'pickup');
      const deliveryInsp = inspections.find(i => i.inspection_type === 'delivery');
      const pickupPhotos = photos.filter(p => p.inspection_id === pickupInsp?.id);
      const deliveryPhotos = photos.filter(p => p.inspection_id === deliveryInsp?.id);

      // Get trip and driver info
      const trip = order.trip_id ? appData.trips.find(t => t.id === order.trip_id) : null;
      const driver = trip?.driver_id
        ? appData.drivers.find(d => d.id === trip.driver_id)
        : (order.driver_id ? appData.drivers.find(d => d.id === order.driver_id) : null);

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format: 'a4' });
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 15;
      let y = margin;

      // Colors
      const darkGray = [17, 24, 39];
      const medGray = [107, 114, 128];
      const lightGray = [243, 244, 246];
      const green = [34, 197, 94];
      const blue = [59, 130, 246];

      const fmtDate = (d) => d ? new Date(d).toLocaleDateString() : 'N/A';
      const fmtDateTime = (d) => d ? new Date(d).toLocaleString() : 'N/A';

      // === PAGE 1: BOL HEADER AND DETAILS ===

      // Text-based logo (image removed)
      doc.setFillColor(...darkGray);
      doc.rect(margin, y, 18, 14, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(8);
      doc.setFont('helvetica', 'bold');
      doc.text('HORIZON', margin + 2, y + 6);
      doc.text('STAR', margin + 2, y + 11);

      // Title
      doc.setFontSize(20);
      doc.setTextColor(...darkGray);
      doc.setFont('helvetica', 'bold');
      doc.text('BILL OF LADING', pageWidth - margin, y + 10, { align: 'right' });
      y += 22;

      // Order Info Box
      doc.setFillColor(...lightGray);
      doc.roundedRect(margin, y, pageWidth - margin * 2, 16, 2, 2, 'F');
      doc.setFontSize(9);
      doc.setTextColor(...darkGray);
      doc.setFont('helvetica', 'bold');
      doc.text('Order #:', margin + 4, y + 6);
      doc.setFont('helvetica', 'normal');
      doc.text(order.order_number || 'N/A', margin + 22, y + 6);
      doc.setFont('helvetica', 'bold');
      doc.text('Date:', margin + 60, y + 6);
      doc.setFont('helvetica', 'normal');
      doc.text(fmtDate(new Date()), margin + 74, y + 6);
      if (trip) {
        doc.setFont('helvetica', 'bold');
        doc.text('Trip #:', pageWidth / 2 + 10, y + 6);
        doc.setFont('helvetica', 'normal');
        doc.text(trip.trip_number, pageWidth / 2 + 26, y + 6);
      }
      if (driver) {
        doc.setFont('helvetica', 'bold');
        doc.text('Driver:', margin + 4, y + 12);
        doc.setFont('helvetica', 'normal');
        doc.text(driver.first_name + ' ' + driver.last_name, margin + 22, y + 12);
      }
      y += 22;

      // Vehicle Information
      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      doc.text('Vehicle Information', margin, y);
      y += 6;

      doc.autoTable({
        startY: y,
        head: [['Year', 'Make', 'Model', 'VIN', 'Color']],
        body: [[
          order.vehicle_year || 'N/A',
          order.vehicle_make || 'N/A',
          order.vehicle_model || 'N/A',
          order.vehicle_vin || 'Not recorded',
          order.vehicle_color || 'N/A'
        ]],
        theme: 'striped',
        headStyles: { fillColor: darkGray, textColor: [255, 255, 255], fontSize: 8 },
        bodyStyles: { fontSize: 8 },
        margin: { left: margin, right: margin }
      });
      y = doc.lastAutoTable.finalY + 8;

      // Route Information - Side by Side
      const colWidth = (pageWidth - margin * 2 - 6) / 2;

      // Pickup Box
      doc.setFillColor(240, 253, 244);
      doc.roundedRect(margin, y, colWidth, 40, 2, 2, 'F');
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...green);
      doc.text('PICKUP', margin + 4, y + 6);
      doc.setTextColor(...darkGray);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8);
      doc.text(order.pickup_name || 'N/A', margin + 4, y + 12);
      doc.text(order.pickup_address || '', margin + 4, y + 17);
      doc.text((order.pickup_city || '') + ', ' + (order.pickup_state || '') + ' ' + (order.pickup_zip || ''), margin + 4, y + 22);
      if (order.pickup_phone) doc.text('Phone: ' + order.pickup_phone, margin + 4, y + 27);
      if (pickupInsp) {
        doc.setFont('helvetica', 'bold');
        doc.text('Odometer: ' + (pickupInsp.odometer || 'N/A'), margin + 4, y + 34);
        doc.text('Date: ' + fmtDate(pickupInsp.completed_at || pickupInsp.started_at || pickupInsp.created_at), margin + colWidth/2, y + 34);
        // Show inspection location if available
        if (pickupInsp.location_address) {
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(6);
          doc.setTextColor(...medGray);
          doc.text('GPS: ' + pickupInsp.location_address, margin + 4, y + 39);
          doc.setTextColor(...darkGray);
        }
      }

      // Delivery Box
      doc.setFillColor(254, 243, 199);
      doc.roundedRect(margin + colWidth + 6, y, colWidth, 40, 2, 2, 'F');
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(245, 158, 11);
      doc.text('DELIVERY', margin + colWidth + 10, y + 6);
      doc.setTextColor(...darkGray);
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(8);
      doc.text(order.delivery_name || 'N/A', margin + colWidth + 10, y + 12);
      doc.text(order.delivery_address || '', margin + colWidth + 10, y + 17);
      doc.text((order.delivery_city || '') + ', ' + (order.delivery_state || '') + ' ' + (order.delivery_zip || ''), margin + colWidth + 10, y + 22);
      if (order.delivery_phone) doc.text('Phone: ' + order.delivery_phone, margin + colWidth + 10, y + 27);
      if (deliveryInsp) {
        doc.setFont('helvetica', 'bold');
        doc.text('Odometer: ' + (deliveryInsp.odometer || 'N/A'), margin + colWidth + 10, y + 34);
        doc.text('Date: ' + fmtDate(deliveryInsp.completed_at || deliveryInsp.started_at || deliveryInsp.created_at), margin + colWidth + colWidth/2, y + 34);
        // Show inspection location if available
        if (deliveryInsp.location_address) {
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(6);
          doc.setTextColor(...medGray);
          doc.text('GPS: ' + deliveryInsp.location_address, margin + colWidth + 10, y + 39);
          doc.setTextColor(...darkGray);
        }
      }
      y += 48;

      // Signatures Section
      doc.setFontSize(11);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...darkGray);
      doc.text('Signatures', margin, y);
      y += 6;

      // Signature boxes - 2x2 grid
      const sigWidth = (pageWidth - margin * 2 - 6) / 2;
      const sigHeight = 28;

      // Helper to draw signature box - signatures are stored as base64 data URIs
      const drawSignatureBox = async (x, yPos, title, signatureBase64, signerName, timestamp) => {
        doc.setFillColor(...lightGray);
        doc.roundedRect(x, yPos, sigWidth, sigHeight, 2, 2, 'F');
        doc.setFontSize(7);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...medGray);
        doc.text(title.toUpperCase(), x + 3, yPos + 5);

        if (signatureBase64) {
          try {
            // Signature is stored as base64 data URI (e.g., "data:image/png;base64,...")
            doc.addImage(signatureBase64, 'PNG', x + 3, yPos + 7, sigWidth - 40, 16);
          } catch (e) {
            console.error('Error rendering signature:', e);
            doc.setTextColor(...darkGray);
            doc.setFontSize(8);
            doc.text('[Signature on file]', x + 3, yPos + 16);
          }
        } else {
          doc.setTextColor(...medGray);
          doc.setFontSize(8);
          doc.text('Not signed', x + 3, yPos + 16);
        }

        doc.setFontSize(6);
        doc.setTextColor(...darkGray);
        if (signerName) doc.text(signerName, x + sigWidth - 35, yPos + 12);
        if (timestamp) doc.text(fmtDateTime(timestamp), x + sigWidth - 35, yPos + 17);
      };

      // Draw 4 signature boxes - use customer_signature/driver_signature (base64) fields
      await drawSignatureBox(margin, y, 'Pickup - Customer', pickupInsp?.customer_signature, pickupInsp?.customer_name, pickupInsp?.customer_signed_at);
      await drawSignatureBox(margin + sigWidth + 6, y, 'Pickup - Driver', pickupInsp?.driver_signature, driver ? driver.first_name + ' ' + driver.last_name : null, pickupInsp?.driver_signed_at);
      y += sigHeight + 4;
      await drawSignatureBox(margin, y, 'Delivery - Customer', deliveryInsp?.customer_signature, deliveryInsp?.customer_name, deliveryInsp?.customer_signed_at);
      await drawSignatureBox(margin + sigWidth + 6, y, 'Delivery - Driver', deliveryInsp?.driver_signature, driver ? driver.first_name + ' ' + driver.last_name : null, deliveryInsp?.driver_signed_at);
      y += sigHeight + 10;

      // Notes Section
      if (order.notes || order.dispatcher_notes) {
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.text('Notes', margin, y);
        y += 5;
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        if (order.notes) {
          const noteLines = doc.splitTextToSize(order.notes, pageWidth - margin * 2);
          doc.text(noteLines, margin, y);
          y += noteLines.length * 4 + 4;
        }
      }

      // Footer on page 1
      doc.setTextColor(...medGray);
      doc.setFontSize(7);
      doc.text('Horizon Star, LLC | 118 Mary Ambler Way, Ambler, PA 19002 | (267) 334-1834', pageWidth/2, pageHeight - 10, { align: 'center' });
      doc.text('Generated ' + new Date().toLocaleString(), pageWidth/2, pageHeight - 6, { align: 'center' });

      // === PAGE 2+: INSPECTION PHOTOS ===
      const allPhotos = [...pickupPhotos, ...deliveryPhotos];
      if (allPhotos.length > 0) {
        doc.addPage();
        y = margin;

        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(...darkGray);
        doc.text('Inspection Photos', margin, y);
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(...medGray);
        doc.text(allPhotos.length + ' photos', pageWidth - margin, y, { align: 'right' });
        y += 10;

        // Photo grid - 3 columns, 4 rows per page = 12 photos per page
        const photoWidth = (pageWidth - margin * 2 - 10) / 3;
        const photoHeight = photoWidth * 0.75;
        let col = 0;
        let photosOnPage = 0;

        for (let i = 0; i < allPhotos.length; i++) {
          const photo = allPhotos[i];

          // Check if we need a new page
          if (y + photoHeight + 15 > pageHeight - 20) {
            doc.addPage();
            y = margin;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(...darkGray);
            doc.text('Inspection Photos (continued)', margin, y);
            y += 10;
            col = 0;
          }

          const x = margin + col * (photoWidth + 5);

          // Draw photo placeholder/border
          doc.setDrawColor(...lightGray);
          doc.setFillColor(250, 250, 250);
          doc.roundedRect(x, y, photoWidth, photoHeight, 2, 2, 'FD');

          // Try to load and add photo
          try {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            await new Promise((resolve, reject) => {
              img.onload = resolve;
              img.onerror = reject;
              img.src = photo.photo_url;
            });
            doc.addImage(img, 'JPEG', x + 1, y + 1, photoWidth - 2, photoHeight - 8, undefined, 'FAST');
          } catch (e) {
            doc.setFontSize(8);
            doc.setTextColor(...medGray);
            doc.text('Photo unavailable', x + photoWidth/2, y + photoHeight/2, { align: 'center' });
          }

          // Photo label
          const isPickup = pickupPhotos.some(p => p.id === photo.id);
          doc.setFontSize(6);
          doc.setTextColor(...medGray);
          doc.text((isPickup ? 'P: ' : 'D: ') + (photo.photo_type || 'Photo'), x + 2, y + photoHeight - 2);

          col++;
          if (col >= 3) {
            col = 0;
            y += photoHeight + 8;
          }
        }
      }

      // Return base64 for email attachment or open in new tab
      if (returnBase64) {
        return doc.output('datauristring').split(',')[1];
      } else {
        const pdfBlob = doc.output('blob');
        const pdfUrl = URL.createObjectURL(pdfBlob);
        window.open(pdfUrl, '_blank');
        showToast('Bill of Lading generated!');
        return null;
      }
    }

    // ============ INVOICE PDF GENERATION ============
    async function generateInvoicePDF(orderId, returnBase64 = false) {
      const order = appData.orders.find(o => o.id === orderId);
      if (!order) { showToast('Order not found', 'error'); return null; }

      showToast('Generating Invoice...', 'info');

      // Get broker info
      const broker = order.broker_name ? appData.brokers?.find(b => b.name === order.broker_name) : null;

      // Get trip info
      const trip = order.trip_id ? appData.trips.find(t => t.id === order.trip_id) : null;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format: 'a4' });
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 15;
      const contentWidth = pageWidth - margin * 2;
      let y = margin;

      // Colors
      const darkGray = [17, 24, 39];
      const medGray = [107, 114, 128];
      const lightGray = [243, 244, 246];
      const green = [34, 197, 94];
      const white = [255, 255, 255];

      const fmtMoney = (amt) => '$' + (parseFloat(amt) || 0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
      const fmtDate = (d) => d ? new Date(d).toLocaleDateString() : 'N/A';

      // Calculate financials
      const revenue = parseFloat(order.revenue) || 0;
      const brokerFee = parseFloat(order.broker_fee) || 0;
      const localFee = parseFloat(order.local_fee) || 0;
      const netAmount = revenue - brokerFee - localFee;

      // === WATERMARK ===
      doc.saveGraphicsState();
      doc.setGState(new doc.GState({ opacity: 0.03 }));
      doc.setFontSize(60);
      doc.setTextColor(...medGray);
      doc.setFont('helvetica', 'bold');
      doc.text('HORIZON STAR', pageWidth / 2, pageHeight / 2, { align: 'center', angle: 45 });
      doc.restoreGraphicsState();

      // PAID watermark for paid invoices
      if (order.payment_status === 'paid') {
        doc.saveGraphicsState();
        doc.setGState(new doc.GState({ opacity: 0.08 }));
        doc.setFontSize(72);
        doc.setTextColor(...green);
        doc.setFont('helvetica', 'bold');
        doc.text('PAID', pageWidth / 2, pageHeight / 2 + 20, { align: 'center', angle: 45 });
        doc.restoreGraphicsState();
      }

      // === HEADER ===
      // Logotype: "HORIZON STAR" + "TRANSPORT" subtitle
      doc.setFontSize(16);
      doc.setTextColor(...darkGray);
      doc.setFont('helvetica', 'bold');
      doc.text('HORIZON STAR', margin, y + 6);
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(...medGray);
      doc.text('T R A N S P O R T', margin, y + 11);
      // Green accent underline
      doc.setDrawColor(...green);
      doc.setLineWidth(0.8);
      doc.line(margin, y + 13, margin + 42, y + 13);

      // "INVOICE" title right-aligned
      doc.setFontSize(28);
      doc.setTextColor(...darkGray);
      doc.setFont('helvetica', 'bold');
      doc.text('INVOICE', pageWidth - margin, y + 8, { align: 'right' });
      y += 22;

      // === INVOICE DETAILS STRIP ===
      // White box with green left accent border
      doc.setDrawColor(...green);
      doc.setLineWidth(1.5);
      doc.line(margin, y, margin, y + 18);
      doc.setFillColor(255, 255, 255);
      doc.roundedRect(margin + 2, y, contentWidth - 2, 18, 1, 1, 'F');
      doc.setDrawColor(230, 230, 230);
      doc.setLineWidth(0.3);
      doc.roundedRect(margin + 2, y, contentWidth - 2, 18, 1, 1, 'S');

      // 2x2 grid layout
      const detailCol1 = margin + 6;
      const detailCol2 = margin + contentWidth / 2;
      doc.setFontSize(7);
      doc.setTextColor(...medGray);
      doc.setFont('helvetica', 'normal');
      doc.text('Invoice #', detailCol1, y + 5);
      doc.text('Date', detailCol2, y + 5);
      doc.text('Order #', detailCol1, y + 13);
      doc.text('Status', detailCol2, y + 13);

      doc.setFontSize(9);
      doc.setTextColor(...darkGray);
      doc.setFont('helvetica', 'bold');
      doc.text('INV-' + (order.order_number || 'N/A'), detailCol1 + 20, y + 5);
      doc.text(fmtDate(new Date()), detailCol2 + 14, y + 5);
      doc.text(order.order_number || 'N/A', detailCol1 + 20, y + 13);
      // Color-coded status
      const statusText = (order.payment_status || 'pending').toUpperCase();
      const statusClr = order.payment_status === 'paid' ? green : [245, 158, 11];
      doc.setTextColor(...statusClr);
      doc.text(statusText, detailCol2 + 14, y + 13);
      doc.setTextColor(...darkGray);
      y += 26;

      // === BILL TO / SHIPPING  two side-by-side cards ===
      const halfW = (contentWidth - 6) / 2;

      // Bill To card
      doc.setFontSize(8);
      doc.setTextColor(...medGray);
      doc.setFont('helvetica', 'bold');
      doc.text('BILL TO', margin, y);
      y += 4;
      doc.setDrawColor(230, 230, 230);
      doc.setLineWidth(0.3);
      doc.roundedRect(margin, y, halfW, 28, 2, 2, 'S');
      doc.setFontSize(10);
      doc.setTextColor(...darkGray);
      doc.setFont('helvetica', 'bold');
      doc.text(order.broker_name || 'Direct Customer', margin + 5, y + 7);
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(...medGray);
      if (broker) {
        doc.text(broker.address || '', margin + 5, y + 13);
        doc.text((broker.city || '') + ', ' + (broker.state || '') + ' ' + (broker.zip || ''), margin + 5, y + 18);
        doc.text(broker.phone || '', margin + 5, y + 23);
      }

      // Shipping Details card
      const shipX = margin + halfW + 6;
      doc.setFontSize(8);
      doc.setTextColor(...medGray);
      doc.setFont('helvetica', 'bold');
      doc.text('SHIPPING', shipX, y - 4);
      doc.setDrawColor(230, 230, 230);
      doc.roundedRect(shipX, y, halfW, 28, 2, 2, 'S');

      // FROM indicator
      doc.setFontSize(7);
      doc.setTextColor(...green);
      doc.setFont('helvetica', 'bold');
      doc.text('FROM', shipX + 5, y + 7);
      doc.setFontSize(8);
      doc.setTextColor(...darkGray);
      doc.setFont('helvetica', 'normal');
      doc.text((order.pickup_city || order.origin || '') + ', ' + (order.pickup_state || ''), shipX + 18, y + 7);
      if (order.pickup_address) {
        doc.setFontSize(7);
        doc.setTextColor(...medGray);
        doc.text(order.pickup_address, shipX + 18, y + 12);
      }

      // TO indicator
      doc.setFontSize(7);
      doc.setTextColor(...green);
      doc.setFont('helvetica', 'bold');
      doc.text('TO', shipX + 5, y + 18);
      doc.setFontSize(8);
      doc.setTextColor(...darkGray);
      doc.setFont('helvetica', 'normal');
      doc.text((order.delivery_city || order.destination || '') + ', ' + (order.delivery_state || ''), shipX + 18, y + 18);
      if (order.delivery_address) {
        doc.setFontSize(7);
        doc.setTextColor(...medGray);
        doc.text(order.delivery_address, shipX + 18, y + 23);
      }

      y += 36;

      // === SERVICE TABLE ===
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...darkGray);
      doc.text('Service Description', margin, y);
      y += 5;

      doc.autoTable({
        startY: y,
        head: [['Vehicle', 'VIN', 'Qty', 'Route', 'Payment Type']],
        body: [[
          (order.vehicle_year || '') + ' ' + (order.vehicle_make || '') + ' ' + (order.vehicle_model || ''),
          order.vehicle_vin || 'N/A',
          '1',
          (order.pickup_state || order.origin || '') + ' \u2192 ' + (order.delivery_state || order.destination || ''),
          order.payment_type || 'BILL'
        ]],
        theme: 'grid',
        headStyles: { fillColor: darkGray, textColor: white, fontSize: 8, cellPadding: 4 },
        bodyStyles: { fontSize: 8, cellPadding: 4 },
        alternateRowStyles: { fillColor: [249, 250, 251] },
        margin: { left: margin, right: margin }
      });
      y = doc.lastAutoTable.finalY + 10;

      // === PRICING BREAKDOWN ===
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.text('Pricing', margin, y);
      y += 5;

      const pricingData = [
        ['Gross Revenue', fmtMoney(revenue)],
      ];
      if (brokerFee > 0) {
        pricingData.push(['Broker Fee', '-' + fmtMoney(brokerFee)]);
      }
      if (localFee > 0) {
        pricingData.push(['Local Fee', '-' + fmtMoney(localFee)]);
      }

      doc.autoTable({
        startY: y,
        body: pricingData,
        theme: 'plain',
        styles: { fontSize: 9, cellPadding: 3 },
        columnStyles: {
          0: { cellWidth: 100 },
          1: { cellWidth: 40, halign: 'right' }
        },
        didParseCell: function(data) {
          // Red text for deductions
          if (data.column.index === 1 && data.cell.raw && data.cell.raw.startsWith('-')) {
            data.cell.styles.textColor = [239, 68, 68];
          }
        },
        margin: { left: margin, right: margin }
      });
      y = doc.lastAutoTable.finalY + 2;

      // Horizontal rule before total
      doc.setDrawColor(200, 200, 200);
      doc.setLineWidth(0.3);
      doc.line(margin, y, pageWidth - margin, y);
      y += 6;

      // === AMOUNT DUE BLOCK  full-width dark bar ===
      doc.setFillColor(17, 24, 39);
      doc.roundedRect(margin, y, contentWidth, 16, 2, 2, 'F');
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...white);
      doc.text('AMOUNT DUE', margin + 6, y + 10);
      doc.setFontSize(16);
      doc.setTextColor(...green);
      doc.text(fmtMoney(netAmount), pageWidth - margin - 6, y + 10.5, { align: 'right' });
      y += 24;

      // === PAYMENT TERMS + INFO  combined card ===
      doc.setDrawColor(230, 230, 230);
      doc.setLineWidth(0.3);
      doc.roundedRect(margin, y, contentWidth, 30, 2, 2, 'S');

      // Left column: Payment Terms
      doc.setFontSize(8);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...darkGray);
      doc.text('Payment Terms', margin + 5, y + 6);
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(...medGray);
      doc.text('Payment Type: ' + (order.payment_type || 'BILL'), margin + 5, y + 12);
      if (order.payment_type === 'COD' || order.payment_type === 'COP') {
        doc.text('Payment due upon delivery.', margin + 5, y + 17);
      } else {
        doc.text('Payment due within 30 days of invoice date.', margin + 5, y + 17);
      }

      // Right column: Payment Info
      const infoX = margin + contentWidth / 2 + 5;
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...darkGray);
      doc.text('Payment Information', infoX, y + 6);
      doc.setFont('helvetica', 'normal');
      doc.setTextColor(...medGray);
      doc.text('Make checks payable to: Horizon Star, LLC', infoX, y + 12);
      doc.text('Mail to: 118 Mary Ambler Way, Ambler, PA 19002', infoX, y + 17);
      doc.text('billing@horizonstarllc.com | (267) 334-1834', infoX, y + 22);

      // Vertical divider
      doc.setDrawColor(230, 230, 230);
      doc.line(margin + contentWidth / 2, y + 2, margin + contentWidth / 2, y + 28);

      // === FOOTER ===
      // Thin separator
      doc.setDrawColor(220, 220, 220);
      doc.setLineWidth(0.2);
      doc.line(margin, pageHeight - 18, pageWidth - margin, pageHeight - 18);

      // Green "Thank you" text
      doc.setFontSize(9);
      doc.setTextColor(...green);
      doc.setFont('helvetica', 'bold');
      doc.text('Thank you for your business!', margin, pageHeight - 13);

      // Company info + page number
      doc.setTextColor(...medGray);
      doc.setFontSize(7);
      doc.setFont('helvetica', 'normal');
      doc.text('Horizon Star, LLC | 118 Mary Ambler Way, Ambler, PA 19002 | (267) 334-1834', margin, pageHeight - 8);
      doc.text('Page 1 of 1', pageWidth - margin, pageHeight - 8, { align: 'right' });

      // Return base64 for email attachment or open in new tab
      if (returnBase64) {
        return doc.output('datauristring').split(',')[1]; // Return base64 only
      } else {
        const pdfBlob = doc.output('blob');
        const pdfUrl = URL.createObjectURL(pdfBlob);
        window.open(pdfUrl, '_blank');
        showToast('Invoice generated!');
        return null;
      }
    }

    // ============ SEND INVOICE TO BROKER ============
    async function sendInvoiceToBroker(orderId) {
      const order = appData.orders.find(o => o.id === orderId);
      if (!order) { showToast('Order not found', 'error'); return; }

      // Get broker email from brokers table
      const broker = order.broker_name ? (appData.brokers || []).find(b => b.name === order.broker_name) : null;
      const brokerEmail = broker?.email || '';

      // Calculate amount due
      const revenue = parseFloat(order.revenue) || 0;
      const brokerFee = parseFloat(order.broker_fee) || 0;
      const localFee = parseFloat(order.local_fee) || 0;
      const amountDue = revenue - brokerFee - localFee;
      const fmtMoney = (amt) => '$' + (parseFloat(amt) || 0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');

      const modalHTML = `
        <div class="modal-overlay" onclick="if(event.target===this)this.remove()">
          <div class="modal" style="max-width:500px">
            <div class="modal-header">
              <div style="display:flex;align-items:center;gap:12px">
                <div style="width:36px;height:36px;background:var(--primary-light);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center">
                  <span style="font-family:var(--font-sans);font-weight:800;font-size:13px;color:var(--primary)">HS</span>
                </div>
                <div>
                  <h3 style="margin:0;font-family:var(--font-sans);font-size:var(--text-lg);font-weight:var(--weight-bold)">Send Invoice</h3>
                  <div style="font-size:12px;color:var(--text-muted);margin-top:2px">${escapeHtml(order.order_number || 'Order')} &middot; ${escapeHtml(order.broker_name || 'Broker')}</div>
                </div>
              </div>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </div>
            <div class="modal-body" style="padding:24px">
              <div style="margin-bottom:16px">
                <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:var(--text-secondary)">Recipient Email <span style="color:var(--danger)">*</span></label>
                <input type="email" id="invoiceEmail" value="${brokerEmail}" placeholder="broker@example.com"
                       style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:14px;background:var(--bg-tertiary);color:var(--text-primary);transition:var(--transition)"
                       onfocus="this.style.borderColor='var(--primary)';this.style.boxShadow='0 0 0 3px var(--primary-light)'"
                       onblur="this.style.borderColor='var(--border)';this.style.boxShadow='none'">
              </div>

              <div style="margin-bottom:20px">
                <label style="display:block;margin-bottom:6px;font-weight:600;font-size:13px;color:var(--text-secondary)">CC Email <span style="font-weight:400;color:var(--text-muted)">(optional)</span></label>
                <input type="email" id="invoiceCcEmail" value="" placeholder="accounting@company.com"
                       style="width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:var(--radius-sm);font-size:14px;background:var(--bg-tertiary);color:var(--text-primary);transition:var(--transition)"
                       onfocus="this.style.borderColor='var(--primary)';this.style.boxShadow='0 0 0 3px var(--primary-light)'"
                       onblur="this.style.borderColor='var(--border)';this.style.boxShadow='none'">
              </div>

              <div style="background:var(--bg-tertiary);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:20px">
                <div style="font-size:11px;font-weight:700;color:var(--text-muted);margin-bottom:12px;text-transform:uppercase;letter-spacing:0.5px">Invoice Preview</div>
                <div style="display:grid;gap:8px;font-size:13px;color:var(--text-secondary)">
                  <div style="display:flex;justify-content:space-between">
                    <span>Invoice #</span>
                    <strong style="color:var(--text-primary)">INV-${escapeHtml(order.order_number || 'N/A')}</strong>
                  </div>
                  <div style="display:flex;justify-content:space-between">
                    <span>Vehicle</span>
                    <strong style="color:var(--text-primary)">${escapeHtml((order.vehicle_year || '') + ' ' + (order.vehicle_make || '') + ' ' + (order.vehicle_model || ''))}</strong>
                  </div>
                  <div style="display:flex;justify-content:space-between">
                    <span>Route</span>
                    <strong style="color:var(--text-primary)">${escapeHtml(order.origin || order.pickup_state || 'Origin')}  ${escapeHtml(order.destination || order.delivery_state || 'Dest')}</strong>
                  </div>
                  <div style="display:flex;justify-content:space-between;padding-top:10px;border-top:1px solid var(--border);margin-top:4px">
                    <span style="font-weight:600">Amount Due</span>
                    <strong style="font-size:18px;color:var(--primary);font-family:var(--font-mono)">${fmtMoney(amountDue)}</strong>
                  </div>
                </div>
              </div>

              <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:13px;color:var(--text-secondary)">
                <input type="checkbox" id="markInvoiceSent" checked style="width:18px;height:18px;accent-color:var(--primary)">
                <span>Mark invoice as sent in system</span>
              </label>
            </div>
            <div class="modal-footer" style="border-top:1px solid var(--border);padding:16px 24px;display:flex;gap:12px;justify-content:flex-end">
              <button class="btn btn-secondary" onclick="generateInvoicePDF(${orderId})">Preview PDF</button>
              <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
              <button class="btn btn-primary" onclick="confirmSendInvoice(${orderId})">Send Invoice</button>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    async function confirmSendInvoice(orderId) {
      const emailInput = document.getElementById('invoiceEmail');
      const ccEmailInput = document.getElementById('invoiceCcEmail');
      const markSentCheckbox = document.getElementById('markInvoiceSent');

      const email = emailInput?.value?.trim();
      const ccEmail = ccEmailInput?.value?.trim();
      const markAsSent = markSentCheckbox?.checked;

      if (!email) {
        showToast('Email address is required', 'error');
        return;
      }

      if (!email.includes('@')) {
        showToast('Please enter a valid email address', 'error');
        return;
      }

      const order = appData.orders.find(o => o.id === orderId);
      if (!order) { showToast('Order not found', 'error'); return; }

      // Close modal and show sending toast
      document.querySelector('.modal-overlay')?.remove();
      showToast('Generating and sending invoice...', 'info');

      try {
        // Generate Invoice PDF as base64
        const invoiceBase64 = await generateInvoicePDF(orderId, true);
        if (!invoiceBase64) {
          showToast('Failed to generate invoice PDF', 'error');
          return;
        }

        // Generate BOL PDF as base64 (may fail if no inspection data, that's ok)
        let bolBase64 = null;
        try {
          bolBase64 = await generateBOLPDF(orderId, true);
        } catch (e) {
          console.log('BOL generation skipped:', e.message);
        }

        // Calculate amounts for email
        const revenue = parseFloat(order.revenue) || 0;
        const brokerFee = parseFloat(order.broker_fee) || 0;
        const localFee = parseFloat(order.local_fee) || 0;
        const amountDue = revenue - brokerFee - localFee;
        const fmtMoney = (amt) => '$' + (parseFloat(amt) || 0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');

        // Build email body
        const emailHtml = `
          <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; background: var(--bg-card);">
            <div style="background: linear-gradient(135deg, var(--amber), var(--amber)); padding: 32px; text-align: center;">
              <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 700;">HORIZON STAR</h1>
              <p style="color: rgba(255,255,255,0.9); margin: 8px 0 0; font-size: 14px;">Transportation Services</p>
            </div>

            <div style="padding: 32px;">
              <h2 style="color: var(--text-primary); margin: 0 0 8px; font-size: 22px;">Invoice Attached</h2>
              <p style="color: var(--text-secondary); margin: 0 0 24px; font-size: 14px;">Please find your invoice attached to this email.</p>

              <div style="background: var(--amber-dim); border: 1px solid var(--amber-dim); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                <table style="width: 100%; border-collapse: collapse;">
                  <tr>
                    <td style="padding: 8px 0; color: var(--amber); font-size: 14px;">Invoice Number</td>
                    <td style="padding: 8px 0; color: var(--amber); font-weight: 600; text-align: right;">INV-${order.order_number || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; color: var(--amber); font-size: 14px;">Order Number</td>
                    <td style="padding: 8px 0; color: var(--amber); font-weight: 600; text-align: right;">${order.order_number || 'N/A'}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; color: var(--amber); font-size: 14px;">Vehicle</td>
                    <td style="padding: 8px 0; color: var(--amber); font-weight: 600; text-align: right;">${order.vehicle_year || ''} ${order.vehicle_make || ''} ${order.vehicle_model || ''}</td>
                  </tr>
                  <tr>
                    <td style="padding: 8px 0; color: var(--amber); font-size: 14px;">Route</td>
                    <td style="padding: 8px 0; color: var(--amber); font-weight: 600; text-align: right;">${order.origin || order.pickup_state || ''}  ${order.destination || order.delivery_state || ''}</td>
                  </tr>
                  <tr style="border-top: 2px solid var(--amber-dim);">
                    <td style="padding: 12px 0 8px; color: var(--amber); font-size: 16px; font-weight: 600;">Amount Due</td>
                    <td style="padding: 12px 0 8px; color: var(--amber); font-weight: 700; text-align: right; font-size: 20px;">${fmtMoney(amountDue)}</td>
                  </tr>
                </table>
              </div>

              <div style="background: var(--bg-card-hover); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                <h3 style="color: var(--text-secondary); margin: 0 0 12px; font-size: 14px; font-weight: 600;">Payment Information</h3>
                <p style="color: var(--text-secondary); margin: 0; font-size: 13px; line-height: 1.6;">
                  <strong>Make checks payable to:</strong> Horizon Star, LLC<br>
                  <strong>Mail to:</strong> 118 Mary Ambler Way, Ambler, PA 19002<br>
                  <strong>Questions?</strong> billing@horizonstarllc.com | (267) 334-1834
                </p>
              </div>

              <p style="color: var(--text-muted); font-size: 12px; text-align: center; margin: 0;">
                Thank you for your business!
              </p>
            </div>

            <div style="background: var(--text-primary); padding: 20px; text-align: center;">
              <p style="color: var(--text-muted); margin: 0; font-size: 12px;">
                Horizon Star, LLC | 118 Mary Ambler Way, Ambler, PA 19002<br>
                (267) 334-1834 | billing@horizonstarllc.com
              </p>
            </div>
          </div>
        `;

        // Build attachments array (Invoice always, BOL if available)
        const attachments = [
          {
            filename: 'Invoice-' + (order.order_number || orderId) + '.pdf',
            content: invoiceBase64
          }
        ];
        if (bolBase64) {
          attachments.push({
            filename: 'BOL-' + (order.order_number || orderId) + '.pdf',
            content: bolBase64
          });
        }

        // Build request payload
        const payload = {
          to: email,
          subject: 'Invoice INV-' + (order.order_number || orderId) + ' - Horizon Star Transport',
          from_name: 'Horizon Star Billing',
          html: emailHtml,
          attachments: attachments
        };

        // Add CC if provided
        if (ccEmail && ccEmail.includes('@')) {
          payload.cc = ccEmail;
        }

        // Send email
        const response = await fetch(SUPABASE_URL + '/functions/v1/send-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + SUPABASE_KEY
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'Failed to send email');
        }

        // Log activity
        await logActivity('INVOICE_SENT', {
          order_id: orderId,
          order_number: order.order_number,
          recipient: email,
          cc: ccEmail || null,
          amount: amountDue
        });

        showToast('Invoice sent successfully!', 'success');

      } catch (error) {
        console.error('Failed to send invoice:', error);
        showToast('Failed to send invoice: ' + error.message, 'error');
      }
    }

    // ============ ROUTE SHEET PDF GENERATION ============
    async function generateRouteSheetPDF(orderId) {
      const order = appData.orders.find(o => o.id === orderId);
      if (!order) { showToast('Order not found', 'error'); return; }

      const trip = order.trip_id ? appData.trips.find(t => t.id === order.trip_id) : null;
      if (!trip) {
        showToast('Order is not assigned to a trip', 'error');
        return;
      }

      const driver = trip.driver_id ? appData.drivers.find(d => d.id === trip.driver_id) : null;
      const truck = trip.truck_id ? appData.trucks.find(t => t.id === trip.truck_id) : null;

      // Get all orders in this trip
      const tripOrders = appData.orders.filter(o => o.trip_id === trip.id);

      showToast('Generating Route Sheet...', 'info');

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format: 'a4' });
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const margin = 12;
      let y = margin;

      // Colors
      const darkGray = [17, 24, 39];
      const medGray = [107, 114, 128];
      const lightGray = [243, 244, 246];
      const blue = [59, 130, 246];
      const green = [34, 197, 94];
      const orange = [249, 115, 22];

      const fmtDate = (d) => d ? new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';

      // === HEADER ===
      // Text-based logo (image removed)
      doc.setFillColor(...blue);
      doc.rect(margin, y, 16, 13, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(8);
      doc.setFont('helvetica', 'bold');
      doc.text('HS', margin + 8, y + 8, { align: 'center' });

      // Title and Trip Info (right side)
      doc.setFontSize(22);
      doc.setTextColor(...darkGray);
      doc.setFont('helvetica', 'bold');
      doc.text(trip.trip_number, pageWidth - margin, y + 6, { align: 'right' });
      doc.setFontSize(9);
      doc.setTextColor(...medGray);
      doc.setFont('helvetica', 'normal');
      doc.text('Generated: ' + fmtDate(new Date()), pageWidth - margin, y + 12, { align: 'right' });

      y += 18;

      // Blue accent line
      doc.setDrawColor(...blue);
      doc.setLineWidth(0.8);
      doc.line(margin, y, pageWidth - margin, y);
      y += 8;

      // === TRIP DETAILS GRID ===
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...blue);
      doc.text('TRIP DETAILS', margin, y);
      y += 6;

      const gridWidth = (pageWidth - margin * 2 - 9) / 4;
      const gridData = [
        { label: 'Driver', value: driver ? driver.first_name + ' ' + driver.last_name : 'Unassigned' },
        { label: 'Truck #', value: truck ? truck.truck_number : 'N/A' },
        { label: 'Trip Date', value: fmtDate(trip.trip_date) },
        { label: 'Total Vehicles', value: tripOrders.length + ' Cars' }
      ];

      gridData.forEach((item, i) => {
        const x = margin + i * (gridWidth + 3);
        doc.setFillColor(...lightGray);
        doc.roundedRect(x, y, gridWidth, 14, 1.5, 1.5, 'F');
        doc.setFontSize(7);
        doc.setTextColor(...medGray);
        doc.setFont('helvetica', 'normal');
        doc.text(item.label.toUpperCase(), x + 3, y + 5);
        doc.setFontSize(10);
        doc.setTextColor(...darkGray);
        doc.setFont('helvetica', 'bold');
        doc.text(item.value, x + 3, y + 11);
      });
      y += 20;

      // === BUILD STOP LIST ===
      // Create stops array with pickup and delivery for each order
      const stops = [];
      tripOrders.forEach(ord => {
        // Pickup stop
        stops.push({
          type: 'pickup',
          sequence: ord.pickup_sequence || 0,
          order: ord,
          location: ord.pickup_city && ord.pickup_state ? ord.pickup_city + ', ' + ord.pickup_state : (ord.origin || 'N/A'),
          address: [ord.pickup_address, ord.pickup_city, ord.pickup_state, ord.pickup_zip].filter(Boolean).join(', ') || '',
          name: ord.pickup_name || '',
          phone: ord.pickup_phone || '',
          notes: ord.pickup_notes || ord.notes || ''
        });
        // Delivery stop
        stops.push({
          type: 'delivery',
          sequence: ord.delivery_sequence || 0,
          order: ord,
          location: ord.delivery_city && ord.delivery_state ? ord.delivery_city + ', ' + ord.delivery_state : (ord.destination || 'N/A'),
          address: [ord.delivery_address, ord.delivery_city, ord.delivery_state, ord.delivery_zip].filter(Boolean).join(', ') || '',
          name: ord.delivery_name || '',
          phone: ord.delivery_phone || '',
          notes: ord.delivery_notes || ''
        });
      });

      // Sort by sequence
      stops.sort((a, b) => a.sequence - b.sequence);

      // === STOPS TABLE ===
      doc.setFontSize(10);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(...blue);
      doc.text('OPTIMIZED ROUTE SEQUENCE (' + stops.length + ' Stops)', margin, y);
      y += 5;

      // Table header
      const colWidths = [12, 18, 50, 55, 35, 26];
      const headers = ['#', 'Type', 'Vehicle', 'Location', 'Contact', 'Notes'];

      doc.setFillColor(...blue);
      doc.rect(margin, y, pageWidth - margin * 2, 7, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(7);
      doc.setFont('helvetica', 'bold');

      let xPos = margin + 2;
      headers.forEach((h, i) => {
        doc.text(h, xPos, y + 5);
        xPos += colWidths[i];
      });
      y += 7;

      // Table rows
      stops.forEach((stop, index) => {
        // Check for page break
        if (y > pageHeight - 45) {
          doc.addPage();
          y = margin;
        }

        const rowHeight = 12;
        const isEven = index % 2 === 0;
        if (isEven) {
          doc.setFillColor(248, 250, 252);
          doc.rect(margin, y, pageWidth - margin * 2, rowHeight, 'F');
        }

        // Stop number circle
        doc.setFillColor(...blue);
        doc.circle(margin + 6, y + rowHeight / 2, 3.5, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(7);
        doc.setFont('helvetica', 'bold');
        doc.text(String(index + 1), margin + 6, y + rowHeight / 2 + 1.5, { align: 'center' });

        // Type badge
        xPos = margin + colWidths[0] + 2;
        if (stop.type === 'pickup') {
          doc.setFillColor(220, 252, 231);
          doc.roundedRect(xPos, y + 3, 14, 6, 1, 1, 'F');
          doc.setTextColor(22, 101, 52);
          doc.setFontSize(6);
          doc.text('PICKUP', xPos + 7, y + 7, { align: 'center' });
        } else {
          doc.setFillColor(255, 237, 213);
          doc.roundedRect(xPos, y + 3, 14, 6, 1, 1, 'F');
          doc.setTextColor(154, 52, 18);
          doc.setFontSize(6);
          doc.text('DELIVERY', xPos + 7, y + 7, { align: 'center' });
        }

        // Vehicle
        xPos = margin + colWidths[0] + colWidths[1] + 2;
        doc.setTextColor(...darkGray);
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        const vehicleText = [stop.order.vehicle_year, stop.order.vehicle_make, stop.order.vehicle_model].filter(Boolean).join(' ') || 'N/A';
        doc.text(vehicleText.substring(0, 28), xPos, y + 5);
        if (stop.order.vehicle_vin) {
          doc.setFontSize(6);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(...medGray);
          doc.text('VIN: ...' + stop.order.vehicle_vin.slice(-4), xPos, y + 9);
        }

        // Location
        xPos = margin + colWidths[0] + colWidths[1] + colWidths[2] + 2;
        doc.setTextColor(...darkGray);
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.text(stop.location.substring(0, 30), xPos, y + 5);
        if (stop.name) {
          doc.setFontSize(6);
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(...medGray);
          doc.text(stop.name.substring(0, 35), xPos, y + 9);
        }

        // Contact
        xPos = margin + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + 2;
        doc.setTextColor(...darkGray);
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        if (stop.phone) {
          doc.text(stop.phone.substring(0, 18), xPos, y + 6);
        }

        // Notes
        xPos = margin + colWidths[0] + colWidths[1] + colWidths[2] + colWidths[3] + colWidths[4] + 2;
        if (stop.notes) {
          doc.setTextColor(...medGray);
          doc.setFontSize(6);
          doc.text(stop.notes.substring(0, 18), xPos, y + 6);
        }

        y += rowHeight;
      });

      y += 8;

      // === SPECIAL INSTRUCTIONS BOX ===
      if (trip.notes) {
        if (y > pageHeight - 50) {
          doc.addPage();
          y = margin;
        }
        doc.setFillColor(255, 251, 235);
        doc.setDrawColor(252, 211, 77);
        doc.roundedRect(margin, y, pageWidth - margin * 2, 18, 2, 2, 'FD');
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(146, 64, 14);
        doc.text('SPECIAL INSTRUCTIONS', margin + 4, y + 6);
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(120, 53, 15);
        doc.text(trip.notes.substring(0, 200), margin + 4, y + 12);
        y += 24;
      }

      // === SIGNATURE LINES ===
      if (y > pageHeight - 35) {
        doc.addPage();
        y = margin;
      }
      y += 6;
      const sigWidth = (pageWidth - margin * 2 - 20) / 2;

      doc.setDrawColor(...darkGray);
      doc.setLineWidth(0.3);
      doc.line(margin, y + 12, margin + sigWidth, y + 12);
      doc.line(pageWidth - margin - sigWidth, y + 12, pageWidth - margin, y + 12);

      doc.setFontSize(7);
      doc.setTextColor(...medGray);
      doc.setFont('helvetica', 'normal');
      doc.text('Driver Signature / Date', margin, y + 17);
      doc.text('Dispatcher Signature / Date', pageWidth - margin - sigWidth, y + 17);

      // === FOOTER ===
      doc.setFontSize(7);
      doc.setTextColor(...medGray);
      doc.text('Emergency Contact: (267) 334-1834  |  dispatch@horizonstarllc.com', margin, pageHeight - 10);
      doc.text('Page 1 of 1  |  Printed: ' + new Date().toLocaleString(), pageWidth - margin, pageHeight - 10, { align: 'right' });

      // Open PDF
      const pdfBlob = doc.output('blob');
      window.open(URL.createObjectURL(pdfBlob), '_blank');
      showToast('Route Sheet generated!');
    }

    // ============ TRACKING LINK TO BROKER ============
    async function sendTrackingLinkToBroker(orderId) {
      const order = appData.orders.find(o => o.id === orderId);
      if (!order) { showToast('Order not found', 'error'); return; }

      // Get broker email from brokers table
      const broker = order.broker_name ? (appData.brokers || []).find(b => b.name === order.broker_name) : null;
      const brokerEmail = broker?.email || '';

      const modalHTML = `
        <div class="modal-overlay" onclick="if(event.target===this)this.remove()">
          <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
              <h3>Send Tracking Link</h3>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </div>
            <div class="modal-body">
              <p style="margin-bottom: 16px; color: var(--text-muted);">
                Send a live tracking link for <strong>${order.order_number}</strong> to the broker.
              </p>

              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 500;">Recipient Email</label>
                <input type="email" id="trackingEmail" value="${brokerEmail}" placeholder="broker@example.com"
                       style="width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
              </div>

              <div style="background: var(--bg-darker); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">PREVIEW</div>
                <div style="font-size: 13px;">
                  <strong>Vehicle:</strong> ${order.vehicle_year || ''} ${order.vehicle_make || ''} ${order.vehicle_model || ''}<br>
                  <strong>Route:</strong> ${order.origin || order.pickup_state || ''}  ${order.destination || order.delivery_state || ''}
                </div>
              </div>

              <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmSendTrackingLink(${orderId})">
                  Send Tracking Link
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    async function confirmSendTrackingLink(orderId) {
      const emailInput = document.getElementById('trackingEmail');
      const email = emailInput?.value?.trim();

      if (!email) {
        showToast('Email address is required', 'error');
        return;
      }

      if (!email.includes('@')) {
        showToast('Please enter a valid email address', 'error');
        return;
      }

      const order = appData.orders.find(o => o.id === orderId);
      if (!order) { showToast('Order not found', 'error'); return; }

      // Build tracking URL
      const trackingUrl = window.location.origin + window.location.pathname + '#tracking?order_id=' + encodeURIComponent(order.order_number);

      // Get trip and driver info
      const trip = order.trip_id ? appData.trips.find(t => t.id === order.trip_id) : null;
      const driver = trip?.driver_id
        ? appData.drivers.find(d => d.id === trip.driver_id)
        : (order.driver_id ? appData.drivers.find(d => d.id === order.driver_id) : null);

      showToast('Sending tracking link...', 'info');

      try {
        const response = await fetch(SUPABASE_URL + '/functions/v1/send-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + SUPABASE_KEY
          },
          body: JSON.stringify({
            to: email,
            subject: 'Tracking Link - Order ' + order.order_number,
            from_name: 'Horizon Star Transport',
            html: '<div style="font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif; max-width: 600px; margin: 0 auto;">' +
              '<div style="background: linear-gradient(135deg, var(--blue), var(--blue)); padding: 24px; text-align: center;">' +
                '<h1 style="color: white; margin: 0; font-size: 24px;">HORIZON STAR</h1>' +
                '<p style="color: rgba(255,255,255,0.9); margin: 8px 0 0;">Live Tracking Available</p>' +
              '</div>' +
              '<div style="padding: 24px; background: var(--bg-app);">' +
                '<p style="color: var(--bg-elevated); font-size: 16px; margin-bottom: 20px;">Your shipment is ready to track! Click the button below to view real-time status updates.</p>' +
                '<div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 20px;">' +
                  '<table style="width: 100%; border-collapse: collapse;">' +
                    '<tr><td style="padding: 8px 0; color: var(--text-secondary); font-size: 14px;">Order #</td>' +
                    '<td style="padding: 8px 0; color: var(--bg-elevated); font-weight: 600; text-align: right;">' + order.order_number + '</td></tr>' +
                    '<tr><td style="padding: 8px 0; color: var(--text-secondary); font-size: 14px;">Vehicle</td>' +
                    '<td style="padding: 8px 0; color: var(--bg-elevated); font-weight: 600; text-align: right;">' + (order.vehicle_year || '') + ' ' + (order.vehicle_make || '') + ' ' + (order.vehicle_model || '') + '</td></tr>' +
                    '<tr><td style="padding: 8px 0; color: var(--text-secondary); font-size: 14px;">Route</td>' +
                    '<td style="padding: 8px 0; color: var(--bg-elevated); font-weight: 600; text-align: right;">' + (order.origin || order.pickup_state || 'Origin') + '  ' + (order.destination || order.delivery_state || 'Destination') + '</td></tr>' +
                    (driver ? '<tr><td style="padding: 8px 0; color: var(--text-secondary); font-size: 14px;">Driver</td>' +
                    '<td style="padding: 8px 0; color: var(--bg-elevated); font-weight: 600; text-align: right;">' + driver.first_name + ' ' + driver.last_name + '</td></tr>' : '') +
                  '</table>' +
                '</div>' +
                '<div style="text-align: center; margin: 24px 0;">' +
                  '<a href="' + trackingUrl + '" style="display: inline-block; background: var(--blue); color: white; padding: 14px 32px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 16px;">View Live Tracking</a>' +
                '</div>' +
                '<p style="color: var(--text-secondary); font-size: 13px; text-align: center;">Or copy this link: <a href="' + trackingUrl + '" style="color: var(--blue);">' + trackingUrl + '</a></p>' +
              '</div>' +
              '<div style="background: var(--bg-elevated); padding: 20px; text-align: center;">' +
                '<p style="color: var(--text-muted); font-size: 13px; margin: 0 0 8px;">Questions? Contact our dispatch team</p>' +
                '<p style="color: white; font-size: 14px; margin: 0;"><strong>(267) 334-1834</strong> | dispatch@horizonstarllc.com</p>' +
              '</div>' +
            '</div>'
          })
        });

        if (response.ok) {
          showToast('Tracking link sent to ' + email, 'success');
          document.querySelector('.modal-overlay')?.remove();

          // Log activity with dispatcher name
          const dispatcherName = currentUser ? (currentUser.first_name + ' ' + currentUser.last_name).trim() : 'Unknown';
          await logActivity('TRACKING_LINK_SENT', {
            order_id: orderId,
            order_number: order.order_number,
            recipient_email: email,
            sent_by: dispatcherName
          });
        } else {
          throw new Error('Email failed to send');
        }
      } catch (e) {
        console.error('Email error:', e);
        showToast('Failed to send tracking link', 'error');
      }
    }

    // ============ PUBLIC TRACKING PORTAL ============
    // This renders the tracking portal for public/unauthenticated users
    async function renderPublicTrackingPortal() {
      applyTheme();

      // Parse order_id from hash
      const hashParts = window.location.hash.split('?');
      const params = new URLSearchParams(hashParts[1] || '');
      const orderIdentifier = params.get('order_id') || params.get('order');

      // Show loading state
      document.getElementById('app').innerHTML = `
        <div style="min-height:100vh;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;">
          <div class="spinner"></div>
        </div>
      `;

      // Fetch order data from Supabase (public read)
      let order = null;
      let trip = null;
      let driver = null;

      try {
        // Try to find by order_number first, then by id
        let orders = await dbFetch('orders', { order_number: 'eq.' + orderIdentifier });
        if (!orders || orders.length === 0) {
          orders = await dbFetch('orders', { id: 'eq.' + orderIdentifier });
        }

        if (orders && orders.length > 0) {
          order = orders[0];

          // Get trip if assigned
          if (order.trip_id) {
            const trips = await dbFetch('trips', { id: 'eq.' + order.trip_id });
            if (trips && trips.length > 0) {
              trip = trips[0];

              // Get driver if assigned
              if (trip.driver_id) {
                const drivers = await dbFetch('drivers', { id: 'eq.' + trip.driver_id });
                if (drivers && drivers.length > 0) {
                  driver = drivers[0];
                }
              }
            }
          }
        }
      } catch (e) {
        console.error('Failed to load tracking data:', e);
      }

      // Fetch vehicle inspections for pickup/delivery dates
      let pickupInspection = null;
      let deliveryInspection = null;
      if (order) {
        try {
          const inspections = await dbFetch('vehicle_inspections', { filter: { order_id: 'eq.' + order.id } });
          if (inspections && inspections.length > 0) {
            pickupInspection = inspections.find(i => i.inspection_type === 'pickup' && i.status === 'completed');
            deliveryInspection = inspections.find(i => i.inspection_type === 'delivery' && i.status === 'completed');
          }
        } catch (e) {
          console.log('Could not fetch inspections for tracking');
        }
      }

      // Render the tracking portal
      renderTrackingPortalHTML(order, trip, driver, pickupInspection, deliveryInspection);
    }

    // Render tracking portal (used for both public and authenticated views)
    function renderTrackingPortal(container) {
      // For authenticated users, parse from hash
      const hashParts = window.location.hash.split('?');
      const params = new URLSearchParams(hashParts[1] || '');
      const orderIdentifier = params.get('order_id') || params.get('order');

      const order = appData.orders.find(o =>
        o.order_number === orderIdentifier ||
        String(o.id) === orderIdentifier
      );

      const trip = order?.trip_id ? appData.trips.find(t => t.id === order.trip_id) : null;
      const driver = trip?.driver_id
        ? appData.drivers.find(d => d.id === trip.driver_id)
        : (order?.driver_id ? appData.drivers.find(d => d.id === order.driver_id) : null);

      // Get inspections from appData if available
      const inspections = (appData.vehicle_inspections || []).filter(i => i.order_id === order?.id);
      const pickupInspection = inspections.find(i => i.inspection_type === 'pickup' && i.status === 'completed');
      const deliveryInspection = inspections.find(i => i.inspection_type === 'delivery' && i.status === 'completed');

      renderTrackingPortalHTML(order, trip, driver, pickupInspection, deliveryInspection, container);
    }

    function renderTrackingPortalHTML(order, trip, driver, pickupInspection, deliveryInspection, container) {
      const fmtDate = (d) => d ? new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
      const fmtDateTime = (d) => d ? new Date(d).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) : '';

      // Determine status
      let status = 'pending';
      let statusLabel = 'Pending';
      let statusColor = 'var(--text-secondary)';
      let statusBg = 'linear-gradient(135deg, var(--text-secondary), var(--text-secondary))';

      if (order) {
        const deliveryStatus = order.delivery_status?.toLowerCase();
        if (deliveryStatus === 'delivered') {
          status = 'delivered';
          statusLabel = 'Delivered';
          statusColor = 'var(--green)';
          statusBg = 'linear-gradient(135deg, var(--green), var(--green))';
        } else if (deliveryStatus === 'picked_up' || trip) {
          status = 'in_transit';
          statusLabel = 'In Transit';
          statusColor = 'var(--blue)';
          statusBg = 'linear-gradient(135deg, var(--blue), var(--blue))';
        } else if (order.trip_id) {
          status = 'assigned';
          statusLabel = 'Assigned';
          statusColor = 'var(--amber)';
          statusBg = 'linear-gradient(135deg, var(--amber), var(--amber))';
        }
      }

      // Build timeline events with dates
      const timeline = [];
      if (order) {
        const pickedUp = status === 'in_transit' || status === 'delivered';
        const delivered = status === 'delivered';
        const pickupActualDate = pickupInspection?.completed_at || pickupInspection?.created_at;
        const deliveryActualDate = deliveryInspection?.completed_at || deliveryInspection?.created_at;

        // Order Confirmed - use created_at
        timeline.push({
          label: 'Order Confirmed',
          detail: 'Order received and confirmed',
          date: order.created_at ? fmtDate(order.created_at) : null,
          completed: true
        });

        // Driver Assigned - use trip.created_at
        timeline.push({
          label: 'Driver Assigned',
          detail: trip && driver ? driver.first_name + ' ' + driver.last_name : 'Pending assignment',
          date: trip?.created_at ? fmtDate(trip.created_at) : null,
          completed: !!trip
        });

        // Picked Up - show actual date or ETA
        timeline.push({
          label: 'Picked Up',
          detail: order.pickup_city && order.pickup_state ? order.pickup_city + ', ' + order.pickup_state : 'Pickup location',
          date: pickedUp && pickupActualDate ? fmtDate(pickupActualDate) : null,
          eta: !pickedUp && order.pickup_date ? 'ETA: ' + fmtDate(order.pickup_date) : null,
          completed: pickedUp
        });

        // In Transit
        timeline.push({
          label: 'In Transit',
          detail: status === 'in_transit' ? 'En route to destination' : 'Pending',
          date: (status === 'in_transit' || delivered) && pickupActualDate ? fmtDate(pickupActualDate) : null,
          completed: status === 'in_transit' || status === 'delivered',
          current: status === 'in_transit'
        });

        // Delivered - show actual date or ETA
        timeline.push({
          label: 'Delivered',
          detail: order.delivery_city && order.delivery_state ? order.delivery_city + ', ' + order.delivery_state : 'Delivery location',
          date: delivered && deliveryActualDate ? fmtDate(deliveryActualDate) : null,
          eta: !delivered && order.delivery_date ? 'ETA: ' + fmtDate(order.delivery_date) : null,
          completed: delivered
        });
      }

      const html = `
        <div class="tracking-portal">
          <style>
            .tracking-portal {
              min-height: 100vh;
              background: var(--bg-primary);
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            }
            .tracking-header {
              background: var(--bg-card);
              border-bottom: 1px solid var(--border);
              padding: 16px 24px;
              display: flex;
              justify-content: space-between;
              align-items: center;
            }
            .tracking-logo {
              font-size: 20px;
              font-weight: 700;
              color: var(--accent);
            }
            .tracking-logo span {
              color: var(--text-primary);
            }
            .tracking-container {
              max-width: 900px;
              margin: 0 auto;
              padding: 32px 24px;
            }
            .tracking-title {
              text-align: center;
              margin-bottom: 24px;
            }
            .tracking-title h1 {
              font-size: 24px;
              color: var(--text-primary);
              margin-bottom: 8px;
            }
            .tracking-id-badge {
              display: inline-block;
              background: var(--accent);
              color: white;
              padding: 6px 16px;
              border-radius: 20px;
              font-size: 14px;
              font-weight: 600;
            }
            .tracking-refresh-note {
              background: var(--blue-dim);
              border: 1px solid var(--blue-dim);
              border-radius: 8px;
              padding: 12px 16px;
              font-size: 13px;
              color: var(--blue);
              text-align: center;
              margin-bottom: 24px;
            }
            .tracking-status-banner {
              background: ${statusBg};
              color: white;
              padding: 20px 24px;
              border-radius: 12px;
              margin-bottom: 24px;
              display: flex;
              justify-content: space-between;
              align-items: center;
            }
            .tracking-status-text {
              font-size: 22px;
              font-weight: 700;
            }
            .tracking-status-detail {
              font-size: 14px;
              opacity: 0.9;
              margin-top: 4px;
            }
            .tracking-card {
              background: var(--bg-card);
              border: 1px solid var(--border);
              border-radius: 12px;
              padding: 24px;
              margin-bottom: 20px;
            }
            .tracking-card-title {
              font-size: 16px;
              font-weight: 600;
              margin-bottom: 16px;
              color: var(--text-primary);
            }
            .tracking-vehicle-card {
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 16px;
              background: var(--bg-tertiary);
              border-radius: 8px;
            }
            .tracking-vehicle-info h3 {
              font-size: 16px;
              color: var(--text-primary);
              margin-bottom: 4px;
            }
            .tracking-vehicle-info p {
              font-size: 13px;
              color: var(--text-muted);
            }
            .tracking-badge {
              display: inline-block;
              padding: 4px 12px;
              border-radius: 20px;
              font-size: 12px;
              font-weight: 600;
              background: ${status === 'delivered' ? 'var(--green-dim)' : status === 'in_transit' ? 'var(--blue-dim)' : 'var(--amber-dim)'};
              color: ${status === 'delivered' ? 'var(--green)' : status === 'in_transit' ? 'var(--blue)' : 'var(--amber)'};
            }
            .tracking-timeline {
              position: relative;
              padding-left: 30px;
            }
            .tracking-timeline::before {
              content: '';
              position: absolute;
              left: 10px;
              top: 0;
              bottom: 0;
              width: 2px;
              background: var(--border);
            }
            .tracking-timeline-item {
              position: relative;
              padding-bottom: 24px;
            }
            .tracking-timeline-item:last-child {
              padding-bottom: 0;
            }
            .tracking-timeline-dot {
              position: absolute;
              left: -24px;
              top: 4px;
              width: 14px;
              height: 14px;
              border-radius: 50%;
              background: var(--border);
              border: 3px solid var(--bg-card);
            }
            .tracking-timeline-dot.completed {
              background: var(--green);
            }
            .tracking-timeline-dot.current {
              background: var(--blue);
              box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
            }
            .tracking-timeline-content {
              background: var(--bg-tertiary);
              padding: 12px 16px;
              border-radius: 8px;
            }
            .tracking-timeline-title {
              font-weight: 600;
              color: var(--text-primary);
              margin-bottom: 4px;
            }
            .tracking-timeline-detail {
              font-size: 13px;
              color: var(--text-muted);
            }
            .tracking-timeline-date {
              font-size: 12px;
              color: var(--green);
              margin-top: 4px;
              font-weight: 500;
            }
            .tracking-timeline-eta {
              font-size: 12px;
              color: var(--amber);
              margin-top: 4px;
              font-weight: 500;
            }
            .tracking-contact-grid {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 16px;
            }
            @media (max-width: 600px) {
              .tracking-contact-grid {
                grid-template-columns: 1fr;
              }
              .tracking-status-banner {
                flex-direction: column;
                text-align: center;
                gap: 12px;
              }
            }
            .tracking-contact-item {
              background: var(--bg-tertiary);
              padding: 16px;
              border-radius: 8px;
            }
            .tracking-contact-label {
              font-size: 12px;
              color: var(--text-muted);
              margin-bottom: 4px;
            }
            .tracking-contact-value {
              font-size: 14px;
              font-weight: 500;
              color: var(--text-primary);
            }
            .tracking-footer {
              text-align: center;
              padding: 24px;
              color: var(--text-muted);
              font-size: 13px;
            }
            .tracking-not-found {
              text-align: center;
              padding: 60px 24px;
            }
            .tracking-not-found-icon {
              font-size: 64px;
              margin-bottom: 16px;
            }
            .tracking-not-found h2 {
              color: var(--text-primary);
              margin-bottom: 8px;
            }
            .tracking-not-found p {
              color: var(--text-muted);
            }
          </style>

          <div class="tracking-header">
            <div class="tracking-logo">HORIZON<span>STAR</span></div>
            <div style="text-align:right;font-size:13px;color:var(--text-muted);">
              Tracking Portal
            </div>
          </div>

          <div class="tracking-container">
            ${!order ? `
              <div class="tracking-not-found">
                <div class="tracking-not-found-icon"></div>
                <h2>Order Not Found</h2>
                <p>The tracking link may be invalid or the order no longer exists.</p>
                <p style="margin-top:16px;">Questions? Contact <strong>(267) 334-1834</strong></p>
              </div>
            ` : `
              <div class="tracking-title">
                <h1>Vehicle Tracking</h1>
                <span class="tracking-id-badge">Order #${order.order_number || order.id}</span>
              </div>

              <div class="tracking-refresh-note">
                 This page shows real-time status. Refresh for the latest updates.
              </div>

              <div class="tracking-status-banner">
                <div>
                  <div class="tracking-status-text">${status === 'delivered' ? '' : status === 'in_transit' ? '' : ''} ${statusLabel}</div>
                  <div class="tracking-status-detail">
                    ${status === 'in_transit' ? 'En route to ' + (order.delivery_city || order.destination || 'destination') :
                      status === 'delivered' ? 'Delivered to ' + (order.delivery_city || order.destination || 'destination') :
                      'Awaiting pickup'}
                  </div>
                </div>
                ${trip?.trip_date ? `
                  <div style="text-align:right;">
                    <div style="font-size:12px;opacity:0.8;">Trip Date</div>
                    <div style="font-size:var(--text-lg);font-weight:var(--weight-bold);">${fmtDate(trip.trip_date)}</div>
                  </div>
                ` : ''}
              </div>

              <div class="tracking-card">
                <div class="tracking-card-title"> Vehicle</div>
                <div class="tracking-vehicle-card">
                  <div class="tracking-vehicle-info">
                    <h3>${[order.vehicle_year, order.vehicle_make, order.vehicle_model].filter(Boolean).join(' ') || 'Vehicle'}</h3>
                    <p>${order.vehicle_vin ? 'VIN: ' + order.vehicle_vin.substring(0, 8) + '...' + order.vehicle_vin.slice(-4) : 'VIN not available'}${order.vehicle_color ? '  ' + order.vehicle_color : ''}</p>
                  </div>
                  <div>
                    <span class="tracking-badge">${statusLabel}</span>
                  </div>
                </div>
              </div>

              <div class="tracking-card">
                <div class="tracking-card-title"> Route</div>
                <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
                  <div style="flex:1;min-width:120px;">
                    <div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;">PICKUP</div>
                    <div style="font-weight:600;color:var(--text-primary);">
                      ${order.pickup_city && order.pickup_state ? order.pickup_city + ', ' + order.pickup_state : order.origin || 'Origin'}
                    </div>
                  </div>
                  <div style="font-size:24px;color:var(--text-muted);"></div>
                  <div style="flex:1;min-width:120px;">
                    <div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;">DELIVERY</div>
                    <div style="font-weight:600;color:var(--text-primary);">
                      ${order.delivery_city && order.delivery_state ? order.delivery_city + ', ' + order.delivery_state : order.destination || 'Destination'}
                    </div>
                  </div>
                </div>
              </div>

              <div class="tracking-card">
                <div class="tracking-card-title"> Shipment Timeline</div>
                <div class="tracking-timeline">
                  ${timeline.map(item => `
                    <div class="tracking-timeline-item">
                      <div class="tracking-timeline-dot ${item.completed ? (item.current ? 'current' : 'completed') : ''}"></div>
                      <div class="tracking-timeline-content">
                        <div class="tracking-timeline-title">${item.label}</div>
                        <div class="tracking-timeline-detail">${item.detail}</div>
                        ${item.date ? '<div class="tracking-timeline-date">' + item.date + '</div>' : ''}
                        ${item.eta ? '<div class="tracking-timeline-eta">' + item.eta + '</div>' : ''}
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>

              <div class="tracking-card">
                <div class="tracking-card-title"> Contact Information</div>
                <div class="tracking-contact-grid">
                  <div class="tracking-contact-item">
                    <div class="tracking-contact-label">Dispatch</div>
                    <div class="tracking-contact-value">(267) 334-1834</div>
                  </div>
                  <div class="tracking-contact-item">
                    <div class="tracking-contact-label">Email</div>
                    <div class="tracking-contact-value">dispatch@horizonstarllc.com</div>
                  </div>
                  ${driver ? `
                    <div class="tracking-contact-item">
                      <div class="tracking-contact-label">Driver</div>
                      <div class="tracking-contact-value">${driver.first_name} ${driver.last_name}${driver.phone ? '  ' + driver.phone : ''}</div>
                    </div>
                  ` : ''}
                  <div class="tracking-contact-item">
                    <div class="tracking-contact-label">24/7 Emergency</div>
                    <div class="tracking-contact-value">(267) 334-1834</div>
                  </div>
                </div>
              </div>
            `}
          </div>

          <div class="tracking-footer">
            Powered by Horizon Star TMS  Questions? Contact dispatch@horizonstarllc.com
          </div>
        </div>
      `;

      // Render to container or full app
      if (container) {
        container.innerHTML = html;
      } else {
        document.getElementById('app').innerHTML = html;
      }
    }

    // ============ ORDER ATTACHMENTS ============
    async function openOrderAttachmentsModal(orderId) {
      const order = appData.orders.find(o => o.id === orderId);
      if (!order) { showToast('Order not found', 'error'); return; }

      // Get attachments for this order
      const attachments = (appData.order_attachments || []).filter(a => a.order_id === orderId);

      const modalHTML = `
        <div class="modal-overlay" onclick="if(event.target===this)this.remove()">
          <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
              <h3> Attachments - Order ${order.order_number}</h3>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
            </div>
            <div class="modal-body">
              <!-- Upload Section -->
              <div style="margin-bottom: 20px; padding: 16px; background: var(--bg-darker); border-radius: 8px; border: 2px dashed var(--border);">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <input type="file" id="attachmentFile" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="flex: 1;">
                  <button class="btn btn-primary" onclick="uploadOrderAttachment(${orderId})">
                     Upload
                  </button>
                </div>
                <div style="margin-top: 8px; font-size: 12px; color: var(--text-muted);">
                  Accepted formats: PDF, JPG, PNG, DOC, DOCX (max 10MB)
                </div>
              </div>

              <!-- Attachments List -->
              <div id="attachmentsList">
                ${attachments.length === 0 ? `
                  <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <div style="font-size: 48px; margin-bottom: 12px;"></div>
                    <div>No attachments yet</div>
                    <div style="font-size: 12px;">Upload files to attach to this order</div>
                  </div>
                ` : `
                  <div class="attachments-list">
                    ${attachments.map(a => `
                      <div class="attachment-item">
                        <div class="attachment-info">
                          <span class="attachment-icon">${getFileIcon(a.file_type || a.file_name)}</span>
                          <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${a.file_name}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">
                              ${formatDate(a.uploaded_at)} ${a.file_size ? ' ' + formatFileSize(a.file_size) : ''}
                            </div>
                          </div>
                        </div>
                        <div class="attachment-actions">
                          <button class="btn btn-sm" style="background: var(--bg-lighter);" onclick="window.open('${a.file_url}', '_blank')">
                             View
                          </button>
                          <a href="${a.file_url}" download="${a.file_name}" class="btn btn-sm" style="background: var(--bg-lighter);">
                             Download
                          </a>
                          <button class="btn btn-sm btn-danger" onclick="deleteOrderAttachment(${a.id}, ${orderId})">
                            
                          </button>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    async function uploadOrderAttachment(orderId) {
      const fileInput = document.getElementById('attachmentFile');
      if (!fileInput.files || !fileInput.files[0]) {
        showToast('Please select a file to upload', 'error');
        return;
      }

      const file = fileInput.files[0];

      // Check file size (10MB max)
      if (file.size > 10 * 1024 * 1024) {
        showToast('File size must be less than 10MB', 'error');
        return;
      }

      showToast('Uploading file...', 'info');

      try {
        // Upload to Supabase Storage
        const fileName = Date.now() + '_' + file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
        const filePath = 'order_' + orderId + '/' + fileName;

        const { data: uploadData, error: uploadError } = await supabaseClient
          .storage
          .from('order-attachments')
          .upload(filePath, file);

        if (uploadError) throw uploadError;

        // Get public URL
        const { data: urlData } = supabaseClient
          .storage
          .from('order-attachments')
          .getPublicUrl(filePath);

        const fileUrl = urlData.publicUrl;

        // Save to database
        const { data: attachment, error: dbError } = await supabaseClient
          .from('order_attachments')
          .insert({
            order_id: orderId,
            file_name: file.name,
            file_url: fileUrl,
            file_type: file.type,
            file_size: file.size,
            uploaded_by: currentUser?.first_name || 'dispatcher'
          })
          .select()
          .single();

        if (dbError) throw dbError;

        // Update appData
        appData.order_attachments.push(attachment);

        showToast('File uploaded successfully!');

        // Refresh the modal
        document.querySelector('.modal-overlay').remove();
        openOrderAttachmentsModal(orderId);

      } catch (error) {
        console.error('Upload error:', error);
        showToast('Failed to upload file: ' + (error.message || 'Unknown error'), 'error');
      }
    }

    async function deleteOrderAttachment(attachmentId, orderId) {
      if (!confirm('Delete this attachment?')) return;

      try {
        // Get attachment details
        const attachment = appData.order_attachments.find(a => a.id === attachmentId);
        if (!attachment) throw new Error('Attachment not found');

        // Delete from storage (extract path from URL)
        const urlParts = attachment.file_url.split('/order-attachments/');
        if (urlParts.length > 1) {
          const filePath = decodeURIComponent(urlParts[1]);
          await supabaseClient.storage.from('order-attachments').remove([filePath]);
        }

        // Delete from database
        const { error } = await supabaseClient
          .from('order_attachments')
          .delete()
          .eq('id', attachmentId);

        if (error) throw error;

        // Update appData
        appData.order_attachments = appData.order_attachments.filter(a => a.id !== attachmentId);

        showToast('Attachment deleted');

        // Refresh the modal
        document.querySelector('.modal-overlay').remove();
        openOrderAttachmentsModal(orderId);

      } catch (error) {
        console.error('Delete error:', error);
        showToast('Failed to delete: ' + (error.message || 'Unknown error'), 'error');
      }
    }

    function getFileIcon(fileTypeOrName) {
      const type = (fileTypeOrName || '').toLowerCase();
      if (type.includes('pdf')) return '';
      if (type.includes('image') || type.includes('jpg') || type.includes('jpeg') || type.includes('png')) return '';
      if (type.includes('doc') || type.includes('word')) return '';
      if (type.includes('xls') || type.includes('excel') || type.includes('spreadsheet')) return '';
      return '';
    }

    function formatFileSize(bytes) {
      if (!bytes) return '';
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Fixed Costs Management
    // ============ CONSOLIDATED FINANCIALS ============
    let finTab = 'executive'; // executive, analysis, overview, costs, trips, drivers, brokers, lanes
    let financialsYear = new Date().getFullYear(); // Default to current year

    function renderConsolidatedFinancials(c) {
      const allTrips = appData.trips || [];
      const allOrders = appData.orders || [];
      const trucks = appData.trucks || [];
      const drivers = appData.drivers || [];
      const fixedCosts = appData.fixed_costs || [];
      const allVariableCosts = appData.variable_costs || [];
      const allMaintenance = appData.maintenance_records || [];
      const allFuelRecords = appData.fuel_transactions || [];

      // Filter by selected year
      const yearStart = financialsYear + '-01-01';
      const yearEnd = financialsYear + '-12-31';

      const trips = allTrips.filter(t => {
        if (!t.trip_date) return false;
        return t.trip_date >= yearStart && t.trip_date <= yearEnd;
      });

      const orders = allOrders.filter(o => {
        if (o.trip_id) {
          const trip = allTrips.find(t => t.id === o.trip_id);
          return trip && trip.trip_date >= yearStart && trip.trip_date <= yearEnd;
        }
        return o.created_at && o.created_at >= yearStart && o.created_at <= yearEnd;
      });

      const variableCosts = allVariableCosts.filter(vc => {
        if (!vc.date) return false;
        return vc.date >= yearStart && vc.date <= yearEnd;
      });

      const maintenance = allMaintenance.filter(m => {
        if (!m.date) return false;
        return m.date >= yearStart && m.date <= yearEnd;
      });

      const fuelRecords = allFuelRecords.filter(f => {
        if (!f.transaction_date) return false;
        return f.transaction_date >= yearStart && f.transaction_date <= yearEnd;
      });

      // Calculate months in selected year (always 12 for a full year, or partial if current year)
      const now = new Date();
      const isCurrentYear = financialsYear === now.getFullYear();
      const monthsInData = isCurrentYear ? now.getMonth() + 1 : 12;

      //  REVENUE & COSTS FROM TRIPS 
      let totalRevenue = 0, totalBrokerFees = 0, totalLocalFees = 0, totalDriverPay = 0, totalDispatchFees = 0, totalTripExpenses = 0;
      let tripMilesTotal = 0, totalCars = 0;

      trips.forEach(t => {
        const fin = getTripFin(t.id);
        totalRevenue += fin.loadRevenue;
        totalBrokerFees += fin.brokerFee;
        totalLocalFees += fin.localFees;
        totalDriverPay += fin.driverCut;        // Company drivers only (Owner-Ops have 0)
        totalDispatchFees += fin.dispatchFee;   // Owner-Ops only (this is company profit)
        // Only count expenses for Company Driver trips - Owner-Op expenses are their responsibility
        if (!fin.isOwnerOp) {
          totalTripExpenses += fin.totalExpenses;
        }
        tripMilesTotal += parseFloat(t.miles || 0);
        totalCars += fin.vehicleCount;
      });

      // Use fleet miles from Samsara for fleet-wide metrics, fall back to trip miles
      const fleetMilesResult = getFleetMiles(yearStart, yearEnd);
      const totalMiles = fleetMilesResult.miles > 0 ? fleetMilesResult.miles : tripMilesTotal;
      const milesSource = fleetMilesResult.miles > 0 ? 'samsara' : 'trips';

      // Fixed & Variable Costs
      const monthlyFixedCosts = fixedCosts.reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);
      const totalFixedCosts = monthlyFixedCosts * monthsInData;
      const totalFuelFromRecords = fuelRecords.reduce((sum, f) => sum + parseFloat(f.total_cost || 0), 0);
      const totalMaintenanceCost = maintenance.reduce((sum, m) => sum + parseFloat(m.total_cost || 0), 0);
      const totalOtherVariableCosts = variableCosts.reduce((sum, vc) => sum + parseFloat(vc.amount || 0), 0);
      const totalVariableCosts = totalFuelFromRecords + totalMaintenanceCost + totalOtherVariableCosts;
      
      // Calculate profits
      // For Company Drivers: profit = cleanRevenue - driverCut - expenses
      // For Owner-Ops: profit = dispatch fee only (company doesn't pay driver or expenses)
      // totalDispatchFees represents pure profit from Owner-Op trips
      // totalDriverPay is only from Company Driver trips (Owner-Ops have driverCut=0)
      const cleanRevenue = totalRevenue - totalBrokerFees - totalLocalFees;
      // Gross Profit = what's left after paying drivers (Company Drivers only)
      // Plus dispatch fees which are pure profit from Owner-Ops
      const grossProfit = (cleanRevenue - totalDriverPay) + totalDispatchFees;
      // Operating Profit = after trip expenses (only from Company Driver trips - Owner-Op expenses are their responsibility)
      const operatingProfit = grossProfit - totalTripExpenses - totalVariableCosts;
      const netProfit = operatingProfit - totalFixedCosts;
      const profitMargin = totalRevenue > 0 ? (netProfit / totalRevenue * 100) : 0;
      
      // Per unit metrics
      const profitPerCar = totalCars > 0 ? netProfit / totalCars : 0;
      const profitPerMile = totalMiles > 0 ? netProfit / totalMiles : 0;
      const revenuePerMile = totalMiles > 0 ? totalRevenue / totalMiles : 0;
      const avgRevenuePerCar = totalCars > 0 ? totalRevenue / totalCars : 0;
      
      // Year selector options
      const currentYear = new Date().getFullYear();
      const yearOptions = [currentYear, currentYear - 1, currentYear - 2, currentYear - 3].map(y =>
        '<option value="' + y + '"' + (financialsYear === y ? ' selected' : '') + '>' + y + '</option>'
      ).join('');

      // Tabs
      const tabs = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:12px">
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button class="btn ${finTab === 'executive' ? 'btn-primary' : 'btn-secondary'}" style="padding:6px 12px;font-size:12px" onclick="finTab='executive';renderConsolidatedFinancials(document.getElementById('main-content'))"> Executive</button>
            <button class="btn ${finTab === 'analysis' ? 'btn-primary' : 'btn-secondary'}" style="padding:6px 12px;font-size:12px" onclick="finTab='analysis';renderConsolidatedFinancials(document.getElementById('main-content'))"> Analysis</button>
            <button class="btn ${finTab === 'overview' ? 'btn-primary' : 'btn-secondary'}" style="padding:6px 12px;font-size:12px" onclick="finTab='overview';renderConsolidatedFinancials(document.getElementById('main-content'))"> Overview</button>
            <button class="btn ${finTab === 'costs' ? 'btn-primary' : 'btn-secondary'}" style="padding:6px 12px;font-size:12px" onclick="finTab='costs';renderConsolidatedFinancials(document.getElementById('main-content'))"> Costs</button>
            <button class="btn ${finTab === 'trips' ? 'btn-primary' : 'btn-secondary'}" style="padding:6px 12px;font-size:12px" onclick="finTab='trips';renderConsolidatedFinancials(document.getElementById('main-content'))"> By Trip</button>
            <button class="btn ${finTab === 'drivers' ? 'btn-primary' : 'btn-secondary'}" style="padding:6px 12px;font-size:12px" onclick="finTab='drivers';renderConsolidatedFinancials(document.getElementById('main-content'))"> By Driver</button>
            <button class="btn ${finTab === 'brokers' ? 'btn-primary' : 'btn-secondary'}" style="padding:6px 12px;font-size:12px" onclick="finTab='brokers';renderConsolidatedFinancials(document.getElementById('main-content'))"> By Broker</button>
            <button class="btn ${finTab === 'lanes' ? 'btn-primary' : 'btn-secondary'}" style="padding:6px 12px;font-size:12px" onclick="finTab='lanes';renderConsolidatedFinancials(document.getElementById('main-content'))"> By Lane</button>
          </div>
          <div style="display:flex;align-items:center;gap:8px;background:var(--bg-app);padding:8px 12px;border-radius:6px">
            <label style="font-weight:600;color:var(--text-secondary);font-size:13px">Year:</label>
            <select onchange="financialsYear=parseInt(this.value);renderConsolidatedFinancials(document.getElementById('main-content'))" style="padding:6px 12px;border:1px solid var(--border);border-radius:6px;font-weight:600">
              ${yearOptions}
            </select>
          </div>
        </div>
      `;
      
      let content = '';
      
      // Route to original functions for Executive and Analysis
      if (finTab === 'executive') {
        renderExecutiveDashboard(c);
        return;
      } else if (finTab === 'analysis') {
        renderFinancialAnalysis(c);
        return;
      } else if (finTab === 'overview') {
        content = renderFinOverview(totalRevenue, cleanRevenue, grossProfit, operatingProfit, netProfit, profitMargin, totalCars, totalMiles, trips.length, monthlyFixedCosts, totalVariableCosts, totalDriverPay, totalBrokerFees, totalLocalFees, totalTripExpenses, profitPerCar, profitPerMile, revenuePerMile, avgRevenuePerCar);
      } else if (finTab === 'costs') {
        content = renderFinCosts(fixedCosts, variableCosts, monthlyFixedCosts, totalVariableCosts, totalFuelFromRecords, totalMaintenanceCost, totalOtherVariableCosts, fuelRecords);
      } else if (finTab === 'trips') {
        content = renderFinByTrip(trips);
      } else if (finTab === 'drivers') {
        content = renderFinByDriver(trips, drivers);
      } else if (finTab === 'brokers') {
        content = renderFinByBroker(orders, trips);
      } else if (finTab === 'lanes') {
        content = renderFinByLane(orders, trips);
      }
      
      c.innerHTML = '<div class="header"><h2> Financials</h2></div>' + tabs + content;
    }
    
    function renderFinOverview(totalRevenue, cleanRevenue, grossProfit, operatingProfit, netProfit, profitMargin, totalCars, totalMiles, tripCount, monthlyFixedCosts, totalVariableCosts, totalDriverPay, totalBrokerFees, totalLocalFees, totalTripExpenses, profitPerCar, profitPerMile, revenuePerMile, avgRevenuePerCar) {
      return `
        <div class="stats-grid" style="margin-bottom:24px;">
          <div class="stat-card" style="border-left:4px solid var(--green)">
            <div class="label">Total Revenue</div>
            <div class="value" style="color:var(--green)">${formatMoney(totalRevenue)}</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px">${totalCars} cars  ${tripCount} trips</div>
          </div>
          <div class="stat-card" style="border-left:4px solid var(--blue)">
            <div class="label">Clean Revenue</div>
            <div class="value" style="color:var(--blue)">${formatMoney(cleanRevenue)}</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px">After broker & local fees</div>
          </div>
          <div class="stat-card" style="border-left:4px solid ${netProfit >= 0 ? 'var(--green)' : 'var(--red)'}">
            <div class="label">Net Profit</div>
            <div class="value" style="color:${netProfit >= 0 ? 'var(--green)' : 'var(--red)'}">${formatMoney(netProfit)}</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px">${profitMargin.toFixed(1)}% margin</div>
          </div>
          <div class="stat-card">
            <div class="label">Profit / Car</div>
            <div class="value">${formatMoney(profitPerCar)}</div>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;">
          <div class="card">
            <div class="card-header"><h3> Revenue Breakdown</h3></div>
            <div style="padding:20px;">
              <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)">
                <span>Gross Revenue</span><strong style="color:var(--green)">${formatMoney(totalRevenue)}</strong>
              </div>
              <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)">
                <span style="color:var(--red)"> Broker Fees</span><span style="color:var(--red)">${formatMoney(totalBrokerFees)}</span>
              </div>
              <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)">
                <span style="color:var(--red)"> Local Fees</span><span style="color:var(--red)">${formatMoney(totalLocalFees)}</span>
              </div>
              <div style="display:flex;justify-content:space-between;padding:12px 0;background:var(--green-dim);margin:0 -20px;padding-left:20px;padding-right:20px;">
                <strong>= Clean Revenue</strong><strong style="color:var(--green)">${formatMoney(cleanRevenue)}</strong>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header"><h3> Expenses Breakdown</h3></div>
            <div style="padding:20px;">
              <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)">
                <span>Driver Pay</span><span style="color:var(--red)">${formatMoney(totalDriverPay)}</span>
              </div>
              <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)">
                <span>Trip Expenses (fuel, tolls)</span><span style="color:var(--red)">${formatMoney(totalTripExpenses)}</span>
              </div>
              <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)">
                <span>Variable Costs</span><span style="color:var(--red)">${formatMoney(totalVariableCosts)}</span>
              </div>
              <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)">
                <span>Fixed Costs (monthly)</span><span style="color:var(--red)">${formatMoney(monthlyFixedCosts)}/mo</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card" style="margin-top:24px;">
          <div class="card-header"><h3> Key Metrics</h3></div>
          <div style="padding:20px;display:grid;grid-template-columns:repeat(4,1fr);gap:20px;">
            <div style="text-align:center;padding:16px;background:var(--bg-app);border-radius:8px;">
              <div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--blue)">${formatMoney(revenuePerMile)}</div>
              <div style="font-size:13px;color:var(--text-muted);margin-top:4px">Revenue / Mile</div>
            </div>
            <div style="text-align:center;padding:16px;background:var(--bg-app);border-radius:8px;">
              <div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--green)">${formatMoney(profitPerMile)}</div>
              <div style="font-size:13px;color:var(--text-muted);margin-top:4px">Profit / Mile</div>
            </div>
            <div style="text-align:center;padding:16px;background:var(--bg-app);border-radius:8px;">
              <div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--purple)">${formatMoney(avgRevenuePerCar)}</div>
              <div style="font-size:13px;color:var(--text-muted);margin-top:4px">Avg Revenue / Car</div>
            </div>
            <div style="text-align:center;padding:16px;background:var(--bg-app);border-radius:8px;">
              <div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--amber)">${totalMiles.toLocaleString()}</div>
              <div style="font-size:13px;color:var(--text-muted);margin-top:4px">Total Miles</div>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderFinCosts(fixedCosts, variableCosts, monthlyFixedCosts, totalVariableCosts, totalFuelFromRecords, totalMaintenanceCost, totalOtherVariableCosts, fuelRecords = []) {
      const fixedRows = fixedCosts.length === 0
        ? '<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--text-muted)">No fixed costs yet</td></tr>'
        : fixedCosts.map(fc => `<tr><td><span class="badge badge-blue">${fc.category || 'OTHER'}</span></td><td>${fc.name}</td><td class="money">${formatMoney(fc.amount)}/mo</td><td><div class="actions"><button class="action-btn edit" onclick="openFixedCostModal(${fc.id})">Edit</button><button class="action-btn delete" onclick="deleteFixedCost(${fc.id})">Del</button></div></td></tr>`).join('');

      const varRows = variableCosts.length === 0
        ? '<tr><td colspan="5" style="text-align:center;padding:20px;color:var(--text-muted)">No variable costs yet</td></tr>'
        : variableCosts.map(vc => `<tr><td>${vc.date ? formatDate(vc.date) : '-'}</td><td><span class="badge badge-purple">${vc.category || 'OTHER'}</span></td><td>${vc.name || vc.description || '-'}</td><td class="money">${formatMoney(vc.amount)}</td><td><div class="actions"><button class="action-btn edit" onclick="openVariableCostModal(${vc.id})">Edit</button><button class="action-btn delete" onclick="deleteVariableCost(${vc.id})">Del</button></div></td></tr>`).join('');

      // Fuel card stats
      const fuelTxCount = fuelRecords.length;
      const totalGallons = fuelRecords.reduce((s, f) => s + parseFloat(f.gallons || 0), 0);
      const avgPerGallon = totalGallons > 0 ? totalFuelFromRecords / totalGallons : 0;
      const avgPerTransaction = fuelTxCount > 0 ? totalFuelFromRecords / fuelTxCount : 0;

      return `
        <div class="stats-grid" style="margin-bottom:24px;">
          <div class="stat-card" style="border-left:4px solid var(--red)">
            <div class="label">Monthly Fixed Costs</div>
            <div class="value" style="color:var(--red)">${formatMoney(monthlyFixedCosts)}</div>
          </div>
          <div class="stat-card" style="border-left:4px solid var(--amber)">
            <div class="label">Total Variable Costs</div>
            <div class="value" style="color:var(--amber)">${formatMoney(totalVariableCosts)}</div>
          </div>
          <div class="stat-card">
            <div class="label">Fuel (from records)</div>
            <div class="value">${formatMoney(totalFuelFromRecords)}</div>
          </div>
          <div class="stat-card">
            <div class="label">Maintenance</div>
            <div class="value">${formatMoney(totalMaintenanceCost)}</div>
          </div>
        </div>

        <!-- Fuel Card Expenses Card -->
        <div class="card" style="margin-bottom:24px;border-left:4px solid var(--red)">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
            <h3> Fuel Card Expenses</h3>
            <div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--red)">${formatMoney(totalFuelFromRecords)}</div>
          </div>
          <div style="padding:16px 20px;background:var(--red-dim)">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px;">
              <div style="text-align:center;padding:12px;background:var(--bg-card);border-radius:8px;">
                <div style="font-size:var(--text-xs);color:var(--text-muted)">Transactions</div>
                <div style="font-size:var(--text-lg);font-weight:var(--weight-bold)">${fuelTxCount}</div>
              </div>
              <div style="text-align:center;padding:12px;background:var(--bg-card);border-radius:8px;">
                <div style="font-size:var(--text-xs);color:var(--text-muted)">Total Gallons</div>
                <div style="font-size:var(--text-lg);font-weight:var(--weight-bold)">${totalGallons.toFixed(1)}</div>
              </div>
              <div style="text-align:center;padding:12px;background:var(--bg-card);border-radius:8px;">
                <div style="font-size:var(--text-xs);color:var(--text-muted)">Avg $/Gallon</div>
                <div style="font-size:var(--text-lg);font-weight:var(--weight-bold)">${formatMoney(avgPerGallon)}</div>
              </div>
              <div style="text-align:center;padding:12px;background:var(--bg-card);border-radius:8px;">
                <div style="font-size:var(--text-xs);color:var(--text-muted)">Avg per Fill</div>
                <div style="font-size:var(--text-lg);font-weight:var(--weight-bold)">${formatMoney(avgPerTransaction)}</div>
              </div>
            </div>
            <div style="margin-top:12px;text-align:center;font-size:12px;color:var(--text-muted)">
              Data from uploaded fuel card reports  <a href="#" onclick="navigateTo('fuel');return false" style="color:var(--red)">View Fuel Tracking </a>
            </div>
          </div>
        </div>

        <div class="card" style="margin-bottom:24px;">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
            <h3> Fixed Costs (Monthly)</h3>
            <button class="btn btn-primary" onclick="openFixedCostModal()">+ Add</button>
          </div>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Category</th><th>Name</th><th>Amount</th><th>Actions</th></tr></thead>
              <tbody>${fixedRows}</tbody>
            </table>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
            <h3> Variable Costs</h3>
            <button class="btn btn-primary" onclick="openVariableCostModal()">+ Add</button>
          </div>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Actions</th></tr></thead>
              <tbody>${varRows}</tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    function renderFinByTrip(trips) {
      const tripRows = trips.length === 0
        ? '<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--text-muted)">No trips yet</td></tr>'
        : [...trips].sort((a, b) => b.id - a.id).slice(0, 50).map(t => {
            const fin = getTripFin(t.id);
            const driver = appData.drivers.find(d => d.id === t.driver_id);
            const profit = fin.netProfit;
            return `<tr>
              <td><strong>${t.trip_number || 'TRIP-' + t.id}</strong></td>
              <td>${driver ? driver.first_name + ' ' + driver.last_name : '-'}</td>
              <td>${t.trip_date ? formatDate(t.trip_date) : '-'}</td>
              <td>${fin.vehicleCount}</td>
              <td>${(t.miles || 0).toLocaleString()}</td>
              <td class="money">${formatMoney(fin.loadRevenue)}</td>
              <td class="money negative">${formatMoney(fin.brokerFee + fin.localFees)}</td>
              <td class="money negative">${formatMoney(fin.driverCut + fin.totalExpenses)}</td>
              <td class="money ${profit >= 0 ? '' : 'negative'}" style="font-weight:700;color:${profit >= 0 ? 'var(--green)' : 'var(--red)'}">${formatMoney(profit)}</td>
            </tr>`;
          }).join('');
      
      return `
        <div class="card">
          <div class="card-header"><h3> Profitability by Trip</h3></div>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Trip</th><th>Driver</th><th>Date</th><th>Cars</th><th>Miles</th><th>Revenue</th><th>Fees</th><th>Costs</th><th>Profit</th></tr></thead>
              <tbody>${tripRows}</tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    function renderFinByDriver(trips, drivers) {
      const driverStats = {};
      drivers.forEach(d => {
        driverStats[d.id] = { name: d.first_name + ' ' + d.last_name, trips: 0, cars: 0, miles: 0, revenue: 0, profit: 0, driverPay: 0 };
      });
      
      trips.forEach(t => {
        if (t.driver_id && driverStats[t.driver_id]) {
          const fin = getTripFin(t.id);
          driverStats[t.driver_id].trips++;
          driverStats[t.driver_id].cars += fin.vehicleCount;
          driverStats[t.driver_id].miles += parseFloat(t.miles || 0);
          driverStats[t.driver_id].revenue += fin.loadRevenue;
          driverStats[t.driver_id].profit += fin.netProfit;
          driverStats[t.driver_id].driverPay += fin.driverCut;
        }
      });
      
      const driverList = Object.values(driverStats).filter(d => d.trips > 0).sort((a, b) => b.profit - a.profit);
      
      const rows = driverList.length === 0
        ? '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted)">No driver data yet</td></tr>'
        : driverList.map(d => `<tr>
            <td><strong>${d.name}</strong></td>
            <td>${d.trips}</td>
            <td>${d.cars}</td>
            <td>${d.miles.toLocaleString()}</td>
            <td class="money">${formatMoney(d.revenue)}</td>
            <td class="money">${formatMoney(d.driverPay)}</td>
            <td class="money ${d.profit >= 0 ? '' : 'negative'}" style="font-weight:700;color:${d.profit >= 0 ? 'var(--green)' : 'var(--red)'}">${formatMoney(d.profit)}</td>
            <td>${d.cars > 0 ? formatMoney(d.profit / d.cars) : '-'}</td>
          </tr>`).join('');
      
      return `
        <div class="card">
          <div class="card-header"><h3> Profitability by Driver</h3></div>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Driver</th><th>Trips</th><th>Cars</th><th>Miles</th><th>Revenue</th><th>Driver Pay</th><th>Net Profit</th><th>Profit/Car</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    function renderFinByBroker(orders, trips) {
      const brokerStats = {};

      orders.forEach(o => {
        const brokerName = o.broker_name || 'Unknown';
        if (!brokerStats[brokerName]) {
          brokerStats[brokerName] = { revenue: 0, brokerFee: 0, localFee: 0, driverPay: 0, dispatchFee: 0, cars: 0, trips: new Set() };
        }
        brokerStats[brokerName].revenue += parseFloat(o.revenue || 0);
        brokerStats[brokerName].brokerFee += parseFloat(o.broker_fee || 0);
        brokerStats[brokerName].localFee += parseFloat(o.local_fee || 0);
        brokerStats[brokerName].cars++;
        if (o.trip_id) {
          brokerStats[brokerName].trips.add(o.trip_id);
          // Get driver pay/dispatch fee from trip for profit calculation
          const fin = getTripFin(o.trip_id);
          const tripOrderCount = orders.filter(ord => ord.trip_id === o.trip_id).length || 1;
          // Allocate driver pay proportionally to each order in the trip
          brokerStats[brokerName].driverPay += fin.driverCut / tripOrderCount;
          brokerStats[brokerName].dispatchFee += fin.dispatchFee / tripOrderCount;
        }
      });

      const brokerList = Object.entries(brokerStats)
        .map(([name, data]) => {
          const cleanRevenue = data.revenue - data.brokerFee - data.localFee;
          // Net profit = clean revenue - driver pay + dispatch fees (dispatch fees are company profit)
          const netProfit = cleanRevenue - data.driverPay + data.dispatchFee;
          return {
            name,
            revenue: data.revenue,
            brokerFee: data.brokerFee,
            cleanRevenue: cleanRevenue,
            netProfit: netProfit,
            feePercent: data.revenue > 0 ? (data.brokerFee / data.revenue * 100) : 0,
            cars: data.cars,
            trips: data.trips.size
          };
        })
        .sort((a, b) => b.netProfit - a.netProfit);

      const rows = brokerList.length === 0
        ? '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted)">No broker data yet</td></tr>'
        : brokerList.map(b => `<tr>
            <td><strong>${b.name}</strong></td>
            <td>${b.trips}</td>
            <td>${b.cars}</td>
            <td class="money">${formatMoney(b.revenue)}</td>
            <td class="money negative">${formatMoney(b.brokerFee)} <span style="color:var(--text-muted);font-size:11px">(${b.feePercent.toFixed(1)}%)</span></td>
            <td class="money">${formatMoney(b.cleanRevenue)}</td>
            <td class="money" style="color:var(--green);font-weight:700">${formatMoney(b.netProfit)}</td>
            <td>${b.cars > 0 ? formatMoney(b.netProfit / b.cars) : '-'}</td>
          </tr>`).join('');

      return `
        <div class="card">
          <div class="card-header"><h3> Profitability by Broker</h3></div>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Broker</th><th>Trips</th><th>Cars</th><th>Revenue</th><th>Broker Fee</th><th>Clean Rev</th><th>Net Profit</th><th>Profit/Car</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    function renderFinByLane(orders, trips) {
      const laneStats = {};

      orders.forEach(o => {
        if (!o.origin || !o.destination) return;
        const originState = extractState(o.origin);
        const destState = extractState(o.destination);
        const lane = originState + '  ' + destState;

        if (!laneStats[lane]) {
          laneStats[lane] = { revenue: 0, cleanRevenue: 0, driverPay: 0, dispatchFee: 0, miles: 0, cars: 0, trips: new Set() };
        }

        const revenue = parseFloat(o.revenue || 0);
        const brokerFee = parseFloat(o.broker_fee || 0);
        const localFee = parseFloat(o.local_fee || 0);

        laneStats[lane].revenue += revenue;
        laneStats[lane].cleanRevenue += revenue - brokerFee - localFee;
        laneStats[lane].cars++;
        if (o.trip_id) {
          laneStats[lane].trips.add(o.trip_id);
          const trip = trips.find(t => t.id === o.trip_id);
          if (trip) {
            const tripOrderCount = orders.filter(ord => ord.trip_id === o.trip_id).length || 1;
            laneStats[lane].miles += parseFloat(trip.miles || 0) / tripOrderCount;
            // Get driver pay/dispatch fee for accurate profit
            const fin = getTripFin(o.trip_id);
            laneStats[lane].driverPay += fin.driverCut / tripOrderCount;
            laneStats[lane].dispatchFee += fin.dispatchFee / tripOrderCount;
          }
        }
      });

      const laneList = Object.entries(laneStats)
        .map(([lane, data]) => {
          // Net profit = clean revenue - driver pay + dispatch fees
          const netProfit = data.cleanRevenue - data.driverPay + data.dispatchFee;
          return {
            lane,
            revenue: data.revenue,
            cleanRevenue: data.cleanRevenue,
            netProfit: netProfit,
            cars: data.cars,
            trips: data.trips.size,
            miles: Math.round(data.miles),
            rpm: data.miles > 0 ? data.cleanRevenue / data.miles : 0  // Use clean revenue for RPM
          };
        })
        .sort((a, b) => b.netProfit - a.netProfit)
        .slice(0, 20);

      const rows = laneList.length === 0
        ? '<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text-muted)">No lane data yet</td></tr>'
        : laneList.map(l => `<tr>
            <td><strong>${l.lane}</strong></td>
            <td>${l.trips}</td>
            <td>${l.cars}</td>
            <td>${l.miles.toLocaleString()}</td>
            <td class="money">${formatMoney(l.revenue)}</td>
            <td class="money">${formatMoney(l.cleanRevenue)}</td>
            <td class="money" style="color:var(--green);font-weight:700">${formatMoney(l.netProfit)}</td>
            <td>${formatMoney(l.rpm)}/mi</td>
          </tr>`).join('');

      return `
        <div class="card">
          <div class="card-header"><h3> Profitability by Lane</h3></div>
          <div class="table-wrapper">
            <table>
              <thead><tr><th>Lane</th><th>Trips</th><th>Cars</th><th>Miles</th><th>Revenue</th><th>Clean Rev</th><th>Net Profit</th><th>Rev/Mile</th></tr></thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>
      `;
    }

    // ============ TRIP PROFITABILITY PAGE ============
    // Default Trip Profitability filter to current year
    const currentYearForTripProfit = new Date().getFullYear();
    let tripProfitFilter = { startDate: currentYearForTripProfit + '-01-01', endDate: currentYearForTripProfit + '-12-31', driver: 'all', truck: 'all', profitability: 'all', search: '' };
    let tripProfitSort = { column: 'date', direction: 'desc' };
    let selectedTripsForCompare = [];

    function renderTripProfitability(c) {
      const trips = appData.trips || [];
      const drivers = appData.drivers || [];
      const trucks = appData.trucks || [];

      // Apply filters
      let filteredTrips = [...trips];

      if (tripProfitFilter.startDate) {
        filteredTrips = filteredTrips.filter(t => t.trip_date >= tripProfitFilter.startDate);
      }
      if (tripProfitFilter.endDate) {
        filteredTrips = filteredTrips.filter(t => t.trip_date <= tripProfitFilter.endDate);
      }
      if (tripProfitFilter.driver !== 'all') {
        filteredTrips = filteredTrips.filter(t => t.driver_id === parseInt(tripProfitFilter.driver));
      }
      if (tripProfitFilter.truck !== 'all') {
        filteredTrips = filteredTrips.filter(t => t.truck_id === parseInt(tripProfitFilter.truck));
      }
      if (tripProfitFilter.search) {
        const searchLower = tripProfitFilter.search.toLowerCase();
        filteredTrips = filteredTrips.filter(t => (t.trip_number && t.trip_number.toLowerCase().includes(searchLower)));
      }

      // Calculate financials for all filtered trips
      const tripData = filteredTrips.map(t => {
        const fin = getTripFin(t.id);
        const driver = drivers.find(d => d.id === t.driver_id);
        const truck = trucks.find(tr => tr.id === t.truck_id);
        const miles = parseFloat(t.miles || 0);
        const margin = fin.loadRevenue > 0 ? (fin.netProfit / fin.loadRevenue * 100) : 0;
        const rpm = miles > 0 ? fin.loadRevenue / miles : 0;
        const ppm = miles > 0 ? fin.netProfit / miles : 0;
        return { trip: t, fin, driver, truck, miles, margin, rpm, ppm, isProfitable: fin.netProfit >= 0 };
      });

      // Apply profitability filter
      let displayData = tripData;
      if (tripProfitFilter.profitability === 'profitable') {
        displayData = tripData.filter(d => d.isProfitable);
      } else if (tripProfitFilter.profitability === 'unprofitable') {
        displayData = tripData.filter(d => !d.isProfitable);
      }

      // Sort data
      displayData.sort((a, b) => {
        let aVal, bVal;
        switch(tripProfitSort.column) {
          case 'date': aVal = new Date(a.trip.trip_date || 0); bVal = new Date(b.trip.trip_date || 0); break;
          case 'trip': aVal = a.trip.trip_number || ''; bVal = b.trip.trip_number || ''; break;
          case 'driver': aVal = a.driver ? a.driver.last_name : ''; bVal = b.driver ? b.driver.last_name : ''; break;
          case 'truck': aVal = a.truck ? a.truck.truck_number : 0; bVal = b.truck ? b.truck.truck_number : 0; break;
          case 'revenue': aVal = a.fin.loadRevenue; bVal = b.fin.loadRevenue; break;
          case 'profit': aVal = a.fin.netProfit; bVal = b.fin.netProfit; break;
          case 'margin': aVal = a.margin; bVal = b.margin; break;
          case 'rpm': aVal = a.rpm; bVal = b.rpm; break;
          default: aVal = 0; bVal = 0;
        }
        if (aVal < bVal) return tripProfitSort.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return tripProfitSort.direction === 'asc' ? 1 : -1;
        return 0;
      });

      // Calculate summary stats
      const totalRevenue = displayData.reduce((s, d) => s + d.fin.loadRevenue, 0);
      const totalProfit = displayData.reduce((s, d) => s + d.fin.netProfit, 0);
      const totalMiles = displayData.reduce((s, d) => s + d.miles, 0);
      const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue * 100) : 0;
      const profitableCount = displayData.filter(d => d.isProfitable).length;

      // Build driver and truck options
      const driverOptions = drivers.map(d => '<option value="' + d.id + '"' + (tripProfitFilter.driver == d.id ? ' selected' : '') + '>' + d.first_name + ' ' + d.last_name + '</option>').join('');
      const truckOptions = trucks.map(t => '<option value="' + t.id + '"' + (tripProfitFilter.truck == t.id ? ' selected' : '') + '>#' + t.truck_number + '</option>').join('');

      // Top/Bottom performers
      const sortedByProfit = [...displayData].sort((a, b) => b.fin.netProfit - a.fin.netProfit);
      const top5 = sortedByProfit.slice(0, 5);
      const bottom5 = sortedByProfit.slice(-5).reverse();

      c.innerHTML = `
        <div class="header">
          <h2> Trip Profitability Analysis</h2>
          <div style="display:flex;gap:8px">
            <button class="btn btn-secondary" onclick="exportTripProfitability()"> Export CSV</button>
            ${selectedTripsForCompare.length >= 2 ? '<button class="btn btn-primary" onclick="showTripComparison()"> Compare Selected (' + selectedTripsForCompare.length + ')</button>' : ''}
          </div>
        </div>

        <!-- Date Range & Filters -->
        <div style="background:var(--bg-app);padding:var(--spacing-4);border-radius:var(--radius);margin-bottom:20px">
          <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:center">
            <div style="display:flex;align-items:center;gap:8px">
              <label style="font-weight:var(--weight-semibold);color:var(--text-secondary)">From:</label>
              <input type="date" value="${tripProfitFilter.startDate}" onchange="tripProfitFilter.startDate=this.value;renderTripProfitability(document.getElementById('main-content'))" style="padding:8px 12px;border:1px solid var(--border);border-radius:6px">
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <label style="font-weight:var(--weight-semibold);color:var(--text-secondary)">To:</label>
              <input type="date" value="${tripProfitFilter.endDate}" onchange="tripProfitFilter.endDate=this.value;renderTripProfitability(document.getElementById('main-content'))" style="padding:8px 12px;border:1px solid var(--border);border-radius:6px">
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <label style="font-weight:var(--weight-semibold);color:var(--text-secondary)">Driver:</label>
              <select onchange="tripProfitFilter.driver=this.value;renderTripProfitability(document.getElementById('main-content'))" style="padding:8px 12px;border:1px solid var(--border);border-radius:6px">
                <option value="all"${tripProfitFilter.driver === 'all' ? ' selected' : ''}>All Drivers</option>
                ${driverOptions}
              </select>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <label style="font-weight:var(--weight-semibold);color:var(--text-secondary)">Truck:</label>
              <select onchange="tripProfitFilter.truck=this.value;renderTripProfitability(document.getElementById('main-content'))" style="padding:8px 12px;border:1px solid var(--border);border-radius:6px">
                <option value="all"${tripProfitFilter.truck === 'all' ? ' selected' : ''}>All Trucks</option>
                ${truckOptions}
              </select>
            </div>
            <div style="display:flex;align-items:center;gap:8px">
              <label style="font-weight:var(--weight-semibold);color:var(--text-secondary)">Status:</label>
              <select onchange="tripProfitFilter.profitability=this.value;renderTripProfitability(document.getElementById('main-content'))" style="padding:8px 12px;border:1px solid var(--border);border-radius:6px">
                <option value="all"${tripProfitFilter.profitability === 'all' ? ' selected' : ''}>All Trips</option>
                <option value="profitable"${tripProfitFilter.profitability === 'profitable' ? ' selected' : ''}>Profitable Only</option>
                <option value="unprofitable"${tripProfitFilter.profitability === 'unprofitable' ? ' selected' : ''}>Unprofitable Only</option>
              </select>
            </div>
            <button class="btn btn-secondary" style="padding:8px 16px" onclick="tripProfitFilter={startDate:new Date().getFullYear()+'-01-01',endDate:new Date().getFullYear()+'-12-31',driver:'all',truck:'all',profitability:'all',search:''};selectedTripsForCompare=[];renderTripProfitability(document.getElementById('main-content'))">Clear Filters</button>
          </div>
        </div>

        <!-- Summary Stats -->
        <div class="stats-grid" style="margin-bottom:24px">
          <div class="stat-card" style="border-left:4px solid var(--green)">
            <div class="label">Total Revenue</div>
            <div class="value" style="color:var(--green)">${formatMoney(totalRevenue)}</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px">${displayData.length} trips</div>
          </div>
          <div class="stat-card" style="border-left:4px solid ${totalProfit >= 0 ? 'var(--green)' : 'var(--red)'}">
            <div class="label">Net Profit</div>
            <div class="value" style="color:${totalProfit >= 0 ? 'var(--green)' : 'var(--red)'}">${formatMoney(totalProfit)}</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px">${avgMargin.toFixed(1)}% margin</div>
          </div>
          <div class="stat-card">
            <div class="label">Profitable Trips</div>
            <div class="value" style="color:var(--green)">${profitableCount}/${displayData.length}</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px">${(displayData.length > 0 ? (profitableCount / displayData.length * 100) : 0).toFixed(0)}% success rate</div>
          </div>
          <div class="stat-card">
            <div class="label">Avg Profit/Mile</div>
            <div class="value">${formatMoney(totalMiles > 0 ? totalProfit / totalMiles : 0)}</div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:4px">${totalMiles.toLocaleString()} total miles</div>
          </div>
        </div>

        <!-- Best/Worst Performers -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px">
          <div class="card" style="border-left:4px solid var(--green)">
            <div class="card-header"><h3>Top 5 Most Profitable</h3></div>
            <div style="padding:12px">
              ${top5.length === 0 ? '<div style="text-align:center;color:var(--text-muted);padding:20px">No data</div>' : top5.map(d => '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="font-weight:600">' + d.trip.trip_number + '</span><span style="color:var(--green);font-weight:700">' + formatMoney(d.fin.netProfit) + ' (' + d.margin.toFixed(1) + '%)</span></div>').join('')}
            </div>
          </div>
          <div class="card" style="border-left:4px solid var(--red)">
            <div class="card-header"><h3>Bottom 5 Performers</h3></div>
            <div style="padding:12px">
              ${bottom5.length === 0 ? '<div style="text-align:center;color:var(--text-muted);padding:20px">No data</div>' : bottom5.map(d => '<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span style="font-weight:600">' + d.trip.trip_number + '</span><span style="color:' + (d.fin.netProfit >= 0 ? 'var(--amber)' : 'var(--red)') + ';font-weight:700">' + formatMoney(d.fin.netProfit) + ' (' + d.margin.toFixed(1) + '%)</span></div>').join('')}
            </div>
          </div>
        </div>

        <!-- Trips Table -->
        <div class="card">
          <div class="card-header" style="display:flex;justify-content:space-between;align-items:center">
            <h3>All Trips (${displayData.length})</h3>
            <span style="font-size:12px;color:var(--text-muted)">Select trips to compare | Click headers to sort</span>
          </div>
          <div class="table-wrapper" style="max-height:500px;overflow-y:auto">
            <table id="tripProfitTable">
              <thead style="position:sticky;top:0;z-index:5;background:var(--card-bg)">
                <tr>
                  <th style="width:40px">Compare</th>
                  <th onclick="sortTripProfitTable('date')" style="cursor:pointer">Date ${tripProfitSort.column === 'date' ? (tripProfitSort.direction === 'asc' ? '' : '') : ''}</th>
                  <th onclick="sortTripProfitTable('trip')" style="cursor:pointer">Trip # ${tripProfitSort.column === 'trip' ? (tripProfitSort.direction === 'asc' ? '' : '') : ''}</th>
                  <th onclick="sortTripProfitTable('driver')" style="cursor:pointer">Driver ${tripProfitSort.column === 'driver' ? (tripProfitSort.direction === 'asc' ? '' : '') : ''}</th>
                  <th onclick="sortTripProfitTable('truck')" style="cursor:pointer">Truck ${tripProfitSort.column === 'truck' ? (tripProfitSort.direction === 'asc' ? '' : '') : ''}</th>
                  <th onclick="sortTripProfitTable('revenue')" style="cursor:pointer">Revenue ${tripProfitSort.column === 'revenue' ? (tripProfitSort.direction === 'asc' ? '' : '') : ''}</th>
                  <th>Broker Fees</th>
                  <th>Driver Pay</th>
                  <th>Expenses</th>
                  <th onclick="sortTripProfitTable('profit')" style="cursor:pointer">Net Profit ${tripProfitSort.column === 'profit' ? (tripProfitSort.direction === 'asc' ? '' : '') : ''}</th>
                  <th onclick="sortTripProfitTable('margin')" style="cursor:pointer">Margin % ${tripProfitSort.column === 'margin' ? (tripProfitSort.direction === 'asc' ? '' : '') : ''}</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${displayData.length === 0 ? '<tr><td colspan="12" style="text-align:center;padding:40px;color:var(--text-muted)">No trips match the selected filters</td></tr>' :
                displayData.map(d => {
                  const isSelected = selectedTripsForCompare.includes(d.trip.id);
                  return '<tr style="' + (isSelected ? 'background:var(--primary-light)' : '') + '">' +
                    '<td><input type="checkbox" ' + (isSelected ? 'checked' : '') + ' onchange="toggleTripCompare(' + d.trip.id + ')" ' + (selectedTripsForCompare.length >= 3 && !isSelected ? 'disabled title="Max 3 trips"' : '') + '></td>' +
                    '<td>' + formatDate(d.trip.trip_date) + '</td>' +
                    '<td><strong>' + d.trip.trip_number + '</strong></td>' +
                    '<td>' + (d.driver ? d.driver.first_name + ' ' + d.driver.last_name : '-') + '</td>' +
                    '<td>' + (d.truck ? '#' + d.truck.truck_number : '-') + '</td>' +
                    '<td class="money" style="color:var(--green)">' + formatMoney(d.fin.loadRevenue) + '</td>' +
                    '<td class="money" style="color:var(--red)">' + formatMoney(d.fin.brokerFee) + '</td>' +
                    '<td class="money" style="color:var(--red)">' + formatMoney(d.fin.driverCut) + '</td>' +
                    '<td class="money" style="color:var(--red)">' + formatMoney(d.fin.totalExpenses) + '</td>' +
                    '<td class="money" style="font-weight:700;color:' + (d.isProfitable ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(d.fin.netProfit) + '</td>' +
                    '<td style="color:' + (d.margin >= 20 ? 'var(--green)' : d.margin >= 0 ? 'var(--amber)' : 'var(--red)') + '">' + d.margin.toFixed(1) + '%</td>' +
                    '<td><button class="action-btn" onclick="showTripProfitDetailModal(' + d.trip.id + ')">Details</button></td>' +
                  '</tr>';
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    function sortTripProfitTable(column) {
      if (tripProfitSort.column === column) {
        tripProfitSort.direction = tripProfitSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        tripProfitSort.column = column;
        tripProfitSort.direction = 'desc';
      }
      renderTripProfitability(document.getElementById('main-content'));
    }

    function toggleTripCompare(tripId) {
      const idx = selectedTripsForCompare.indexOf(tripId);
      if (idx > -1) {
        selectedTripsForCompare.splice(idx, 1);
      } else if (selectedTripsForCompare.length < 3) {
        selectedTripsForCompare.push(tripId);
      }
      renderTripProfitability(document.getElementById('main-content'));
    }

    function showTripComparison() {
      if (selectedTripsForCompare.length < 2) {
        showToast('Select at least 2 trips to compare', 'warning');
        return;
      }

      const trips = selectedTripsForCompare.map(id => {
        const trip = appData.trips.find(t => t.id === id);
        const fin = getTripFin(id);
        const driver = appData.drivers.find(d => d.id === trip.driver_id);
        const truck = appData.trucks.find(t => t.id === trip.truck_id);
        const miles = parseFloat(trip.miles || 0);
        return { trip, fin, driver, truck, miles };
      });

      const avgRevenue = trips.reduce((s, t) => s + t.fin.loadRevenue, 0) / trips.length;
      const avgProfit = trips.reduce((s, t) => s + t.fin.netProfit, 0) / trips.length;
      const avgMargin = trips.reduce((s, t) => s + (t.fin.loadRevenue > 0 ? t.fin.netProfit / t.fin.loadRevenue * 100 : 0), 0) / trips.length;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.onclick = e => { if (e.target === modal) modal.remove(); };
      modal.innerHTML = `
        <div class="modal" style="max-width:900px;max-height:90vh;overflow-y:auto">
          <div class="modal-header">
            <h3>Trip Comparison</h3>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
          </div>
          <div class="modal-body" style="padding:20px">
            <div style="display:grid;grid-template-columns:repeat(${trips.length}, 1fr);gap:16px;margin-bottom:24px">
              ${trips.map(t => `
                <div class="card" style="border-top:4px solid ${t.fin.netProfit >= 0 ? 'var(--green)' : 'var(--red)'}">
                  <div class="card-header"><h3>${t.trip.trip_number}</h3></div>
                  <div style="padding:16px">
                    <div style="margin-bottom:12px"><strong>Date:</strong> ${formatDate(t.trip.trip_date)}</div>
                    <div style="margin-bottom:12px"><strong>Driver:</strong> ${t.driver ? t.driver.first_name + ' ' + t.driver.last_name : '-'}</div>
                    <div style="margin-bottom:12px"><strong>Truck:</strong> ${t.truck ? '#' + t.truck.truck_number : '-'}</div>
                    <div style="margin-bottom:12px"><strong>Miles:</strong> ${t.miles.toLocaleString()}</div>
                    <div style="margin-bottom:12px"><strong>Cars:</strong> ${t.fin.vehicleCount}</div>
                    <hr style="margin:16px 0">
                    <div style="margin-bottom:8px"><strong>Revenue:</strong> <span style="color:var(--green)">${formatMoney(t.fin.loadRevenue)}</span></div>
                    <div style="margin-bottom:8px"><strong>Broker Fees:</strong> <span style="color:var(--red)">${formatMoney(t.fin.brokerFee)}</span></div>
                    <div style="margin-bottom:8px"><strong>Driver Pay:</strong> <span style="color:var(--red)">${formatMoney(t.fin.driverCut)}</span></div>
                    <div style="margin-bottom:8px"><strong>Expenses:</strong> <span style="color:var(--red)">${formatMoney(t.fin.totalExpenses)}</span></div>
                    <hr style="margin:16px 0">
                    <div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:${t.fin.netProfit >= 0 ? 'var(--green)' : 'var(--red)'}">
                      Net Profit: ${formatMoney(t.fin.netProfit)}
                    </div>
                    <div style="margin-top:8px;color:var(--text-muted)">
                      Margin: ${(t.fin.loadRevenue > 0 ? t.fin.netProfit / t.fin.loadRevenue * 100 : 0).toFixed(1)}%
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>

            <div class="card" style="background:var(--bg-app)">
              <div class="card-header"><h3>Benchmark Comparison</h3></div>
              <div style="padding:16px;display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
                <div style="text-align:center;padding:16px;background:var(--card-bg);border-radius:8px">
                  <div style="font-size:12px;color:var(--text-muted)">Avg Revenue</div>
                  <div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--blue)">${formatMoney(avgRevenue)}</div>
                </div>
                <div style="text-align:center;padding:16px;background:var(--card-bg);border-radius:8px">
                  <div style="font-size:12px;color:var(--text-muted)">Avg Profit</div>
                  <div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:${avgProfit >= 0 ? 'var(--green)' : 'var(--red)'}">${formatMoney(avgProfit)}</div>
                </div>
                <div style="text-align:center;padding:16px;background:var(--card-bg);border-radius:8px">
                  <div style="font-size:12px;color:var(--text-muted)">Avg Margin</div>
                  <div style="font-size:var(--text-xl);font-weight:var(--weight-bold)">${avgMargin.toFixed(1)}%</div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function showTripProfitDetailModal(tripId) {
      const trip = appData.trips.find(t => t.id === tripId);
      const fin = getTripFin(tripId);
      const driver = appData.drivers.find(d => d.id === trip.driver_id);
      const truck = appData.trucks.find(t => t.id === trip.truck_id);
      const orders = appData.orders.filter(o => o.trip_id === tripId);
      const expenses = appData.expenses.filter(e => e.trip_id === tripId);
      const miles = parseFloat(trip.miles || 0);
      const margin = fin.loadRevenue > 0 ? (fin.netProfit / fin.loadRevenue * 100) : 0;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.onclick = e => { if (e.target === modal) modal.remove(); };
      modal.innerHTML = `
        <div class="modal" style="max-width:800px;max-height:90vh;overflow-y:auto">
          <div class="modal-header" style="background:${fin.netProfit >= 0 ? 'var(--green-dim)' : 'var(--red-dim)'}">
            <h3>Trip Report: ${trip.trip_number}</h3>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
          </div>
          <div class="modal-body" style="padding:20px">

            <!-- Trip Summary -->
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr;gap:16px;margin-bottom:24px">
              <div style="text-align:center;padding:16px;background:var(--bg-app);border-radius:8px">
                <div style="font-size:12px;color:var(--text-muted)">Date</div>
                <div style="font-size:16px;font-weight:600">${formatDate(trip.trip_date)}</div>
              </div>
              <div style="text-align:center;padding:16px;background:var(--bg-app);border-radius:8px">
                <div style="font-size:12px;color:var(--text-muted)">Driver</div>
                <div style="font-size:16px;font-weight:600">${driver ? driver.first_name + ' ' + driver.last_name : '-'}</div>
              </div>
              <div style="text-align:center;padding:16px;background:var(--bg-app);border-radius:8px">
                <div style="font-size:12px;color:var(--text-muted)">Truck</div>
                <div style="font-size:16px;font-weight:600">${truck ? '#' + truck.truck_number : '-'}</div>
              </div>
              <div style="text-align:center;padding:16px;background:var(--bg-app);border-radius:8px">
                <div style="font-size:12px;color:var(--text-muted)">Miles</div>
                <div style="font-size:16px;font-weight:600">${miles.toLocaleString()}</div>
              </div>
              <div style="text-align:center;padding:16px;background:var(--amber-dim);border-radius:8px;border:2px solid var(--amber)">
                <div style="font-size:12px;color:var(--amber)">Driver Cut</div>
                <div style="font-size:16px;font-weight:600;color:var(--amber)">${trip.driver_cut_percent || 32}%</div>
              </div>
            </div>

            <!-- Financial Breakdown -->
            <div class="card" style="margin-bottom:24px">
              <div class="card-header"><h3>Financial Breakdown</h3></div>
              <div style="padding:20px">
                <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)">
                  <span>Gross Revenue (${fin.vehicleCount} vehicles)</span>
                  <strong style="color:var(--green)">${formatMoney(fin.loadRevenue)}</strong>
                </div>
                <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)">
                  <span style="color:var(--red)"> Broker Fees</span>
                  <span style="color:var(--red)">${formatMoney(fin.brokerFee)}</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)">
                  <span style="color:var(--red)"> Local Fees</span>
                  <span style="color:var(--red)">${formatMoney(fin.localFees)}</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:12px 0;background:var(--green-dim);margin:0 -20px;padding-left:20px;padding-right:20px">
                  <strong>= Clean Revenue</strong>
                  <strong style="color:var(--green)">${formatMoney(fin.cleanGross)}</strong>
                </div>
                <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)">
                  <span style="color:var(--red)"> Driver Pay (${trip.driver_cut_percent || 32}%)</span>
                  <span style="color:var(--red)">${formatMoney(fin.driverCut)}</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)">
                  <span style="color:var(--red)"> Trip Expenses</span>
                  <span style="color:var(--red)">${formatMoney(fin.totalExpenses)}</span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:16px 0;margin-top:8px;background:${fin.netProfit >= 0 ? 'var(--green-dim)' : 'var(--red-dim)'};margin:8px -20px -20px -20px;padding:16px 20px;border-radius:0 0 8px 8px">
                  <strong style="font-size:18px">NET PROFIT</strong>
                  <strong style="font-size:18px;color:${fin.netProfit >= 0 ? 'var(--green)' : 'var(--red)'}">${formatMoney(fin.netProfit)} (${margin.toFixed(1)}%)</strong>
                </div>
              </div>
            </div>

            <!-- Vehicles/Orders -->
            <div class="card" style="margin-bottom:24px">
              <div class="card-header"><h3>Vehicles (${orders.length})</h3></div>
              <div class="table-wrapper">
                <table>
                  <thead><tr><th>Order</th><th>Vehicle</th><th>Origin</th><th>Destination</th><th>Revenue</th><th>Broker Fee</th></tr></thead>
                  <tbody>
                    ${orders.length === 0 ? '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--text-muted)">No orders</td></tr>' :
                    orders.map(o => `
                      <tr>
                        <td>${o.order_number || '-'}</td>
                        <td>${o.vehicle_year || ''} ${o.vehicle_make || ''} ${o.vehicle_model || ''}</td>
                        <td>${o.origin || '-'}</td>
                        <td>${o.destination || '-'}</td>
                        <td class="money">${formatMoney(o.revenue)}</td>
                        <td class="money" style="color:var(--red)">${formatMoney(o.broker_fee)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Trip Expenses -->
            <div class="card">
              <div class="card-header"><h3>Trip Expenses (${expenses.length})</h3></div>
              <div class="table-wrapper">
                <table>
                  <thead><tr><th>Category</th><th>Description</th><th>Amount</th></tr></thead>
                  <tbody>
                    ${expenses.length === 0 ? '<tr><td colspan="3" style="text-align:center;padding:20px;color:var(--text-muted)">No expenses recorded</td></tr>' :
                    expenses.map(e => `
                      <tr>
                        <td><span class="badge badge-blue">${e.category || 'OTHER'}</span></td>
                        <td>${e.description || '-'}</td>
                        <td class="money">${formatMoney(e.amount)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>

          </div>
          <div class="modal-footer" style="display:flex;gap:8px">
            <button class="btn btn-secondary" onclick="exportSingleTripReport(${tripId})">Export Report</button>
            <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function exportTripProfitability() {
      const trips = appData.trips || [];
      if (trips.length === 0) {
        showToast('No trips to export', 'error');
        return;
      }

      const headers = ['Trip #', 'Date', 'Driver', 'Truck', 'Miles', 'Cars', 'Revenue', 'Broker Fees', 'Local Fees', 'Driver Pay', 'Expenses', 'Net Profit', 'Margin %'];

      const rows = trips.map(t => {
        const fin = getTripFin(t.id);
        const driver = appData.drivers.find(d => d.id === t.driver_id);
        const truck = appData.trucks.find(tr => tr.id === t.truck_id);
        const miles = parseFloat(t.miles || 0);
        const margin = fin.loadRevenue > 0 ? (fin.netProfit / fin.loadRevenue * 100) : 0;

        return [
          t.trip_number || '',
          t.trip_date || '',
          driver ? driver.first_name + ' ' + driver.last_name : '',
          truck ? truck.truck_number : '',
          miles,
          fin.vehicleCount,
          fin.loadRevenue.toFixed(2),
          fin.brokerFee.toFixed(2),
          fin.localFees.toFixed(2),
          fin.driverCut.toFixed(2),
          fin.totalExpenses.toFixed(2),
          fin.netProfit.toFixed(2),
          margin.toFixed(1)
        ].map(val => '"' + val + '"').join(',');
      });

      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.setAttribute('href', URL.createObjectURL(blob));
      link.setAttribute('download', 'trip_profitability_' + new Date().toISOString().split('T')[0] + '.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showToast('Exported ' + trips.length + ' trips!');
    }

    function exportSingleTripReport(tripId) {
      const trip = appData.trips.find(t => t.id === tripId);
      const fin = getTripFin(tripId);
      const driver = appData.drivers.find(d => d.id === trip.driver_id);
      const truck = appData.trucks.find(t => t.id === trip.truck_id);
      const orders = appData.orders.filter(o => o.trip_id === tripId);
      const expenses = appData.expenses.filter(e => e.trip_id === tripId);

      const lines = [
        ['Trip Report: ' + trip.trip_number],
        ['Generated: ' + new Date().toLocaleString()],
        [],
        ['TRIP DETAILS'],
        ['Date', trip.trip_date],
        ['Driver', driver ? driver.first_name + ' ' + driver.last_name : '-'],
        ['Truck', truck ? '#' + truck.truck_number : '-'],
        ['Miles', trip.miles || 0],
        [],
        ['FINANCIAL SUMMARY'],
        ['Revenue', fin.loadRevenue.toFixed(2)],
        ['Broker Fees', fin.brokerFee.toFixed(2)],
        ['Local Fees', fin.localFees.toFixed(2)],
        ['Driver Pay', fin.driverCut.toFixed(2)],
        ['Trip Expenses', fin.totalExpenses.toFixed(2)],
        ['Net Profit', fin.netProfit.toFixed(2)],
        [],
        ['VEHICLES'],
        ['Order #', 'Vehicle', 'Origin', 'Destination', 'Revenue', 'Broker Fee']
      ];

      orders.forEach(o => {
        lines.push([
          o.order_number || '',
          (o.vehicle_year || '') + ' ' + (o.vehicle_make || '') + ' ' + (o.vehicle_model || ''),
          o.origin || '',
          o.destination || '',
          parseFloat(o.revenue || 0).toFixed(2),
          parseFloat(o.broker_fee || 0).toFixed(2)
        ]);
      });

      lines.push([]);
      lines.push(['EXPENSES']);
      lines.push(['Category', 'Description', 'Amount']);

      expenses.forEach(e => {
        lines.push([e.category || '', e.description || '', parseFloat(e.amount || 0).toFixed(2)]);
      });

      const csv = lines.map(row => row.map(val => '"' + val + '"').join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.setAttribute('href', URL.createObjectURL(blob));
      link.setAttribute('download', 'trip_report_' + trip.trip_number + '_' + new Date().toISOString().split('T')[0] + '.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showToast('Trip report exported!');
    }
    // ============ END TRIP PROFITABILITY PAGE ============

    function renderFixedCosts(c) {
      const costs = appData.fixed_costs || [];
      const totalMonthly = costs.reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);
      
      c.innerHTML = '<div class="header"><h2> Fixed Costs (Monthly)</h2><div style="display:flex;gap:12px"><button class="btn btn-secondary" onclick="openSetupWizard()"> Setup Wizard</button><button class="btn btn-primary" onclick="openFixedCostModal()">+ Add Fixed Cost</button></div></div>' +
        '<div style="background:var(--blue-dim);border:1px solid var(--blue-dim);border-radius:8px;padding:16px;margin-bottom:24px"><strong style="color:var(--blue)"> Fixed Costs</strong><p style="color:var(--blue);margin-top:8px">Enter your monthly fixed business expenses here. These will be included in the Financial Analysis report.</p></div>' +
        '<div class="stats-grid" style="margin-bottom:24px"><div class="stat-card" style="border-left:4px solid var(--red)"><div class="label">Total Monthly Fixed Costs</div><div class="value" style="color:var(--red)">' + formatMoney(totalMonthly) + '</div></div><div class="stat-card"><div class="label">Annual Fixed Costs</div><div class="value">' + formatMoney(totalMonthly * 12) + '</div></div></div>' +
        '<div class="card"><div class="table-wrapper"><table><thead><tr><th>Category</th><th>Name</th><th>Monthly Amount</th><th>Actions</th></tr></thead><tbody>' +
        (costs.length === 0 ? '<tr><td colspan="4" style="text-align:center;padding:40px"><div style="margin-bottom:16px">No fixed costs yet.</div><button class="btn btn-primary" onclick="openSetupWizard()" style="font-size:16px;padding:12px 24px"> Start Setup Wizard</button><div style="margin-top:12px;color:var(--text-muted);font-size:13px">Walk through entering all your expenses step-by-step</div></td></tr>' :
        costs.map(fc => '<tr><td><span class="badge badge-blue">' + (fc.category || 'OTHER') + '</span></td><td><strong>' + fc.name + '</strong></td><td class="money">' + formatMoney(fc.amount) + '</td><td><div class="actions"><button class="action-btn edit" onclick="openFixedCostModal(' + fc.id + ')">Edit</button><button class="action-btn delete" onclick="deleteFixedCost(' + fc.id + ')">Del</button></div></td></tr>').join('')) +
        '</tbody></table></div></div>';
    }

    function openFixedCostModal(id = null) {
      const fc = id ? appData.fixed_costs.find(x => x.id === id) : null;
      const categories = ['INSURANCE', 'RENT', 'SALARY', 'LEASE_PAYMENT', 'DISPATCH', 'PARKING', 'TOLLS_FIXED', 'REGISTRATION', 'SOFTWARE', 'OTHER'];
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:450px"><div class="modal-header"><h3>' + (fc ? 'Edit' : 'Add') + ' Fixed Cost</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body"><div class="form-group"><label>Category</label><select id="fcCategory">' + categories.map(cat => '<option value="' + cat + '"' + (fc?.category === cat ? ' selected' : '') + '>' + cat.replace('_', ' ') + '</option>').join('') + '</select></div><div class="form-group"><label>Name / Description</label><input id="fcName" value="' + (fc?.name || '') + '" placeholder="e.g., Truck 10 Lease Payment"></div><div class="form-group"><label>Monthly Amount $</label><input type="number" id="fcAmount" value="' + (fc?.amount || '') + '" placeholder="e.g., 2750"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveFixedCost(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    async function saveFixedCost(id) {
      const data = { category: document.getElementById('fcCategory').value, name: document.getElementById('fcName').value, amount: parseFloat(document.getElementById('fcAmount').value) || 0 };
      try { 
        if (id) { 
          await dbUpdate('fixed_costs', id, data); 
          await logActivity('FIXED_COST_UPDATED', { cost_id: id, category: data.category, name: data.name, amount: data.amount });
        } else { 
          const newCost = await dbInsert('fixed_costs', data); 
          await logActivity('FIXED_COST_CREATED', { cost_id: newCost.id, category: data.category, name: data.name, amount: data.amount });
        } 
        document.querySelector('.modal-overlay').remove(); showToast('Saved!'); await loadAllData(true); renderFixedCosts(document.getElementById('main-content')); 
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteFixedCost(id) { 
      if (!confirm('Delete this fixed cost?')) return; 
      const cost = (appData.fixed_costs || []).find(fc => fc.id === id);
      await dbDelete('fixed_costs', id); 
      await logActivity('FIXED_COST_DELETED', { cost_id: id, category: cost?.category, name: cost?.name, amount: cost?.amount });
      showToast('Deleted'); await loadAllData(true); renderFixedCosts(document.getElementById('main-content')); 
    }

    // ============ VARIABLE COSTS ============
    const variableCostCategories = [
      { id: 'TOLLS', name: 'Tolls', icon: '' },
      { id: 'LUMPER', name: 'Lumper Fees', icon: '' },
      { id: 'DETENTION', name: 'Detention', icon: '' },
      { id: 'TONU', name: 'TONU (Truck Order Not Used)', icon: '' },
      { id: 'DEF', name: 'DEF Fluid', icon: '' },
      { id: 'TRUCK_WASH', name: 'Truck Wash', icon: '' },
      { id: 'PARKING', name: 'Parking Fees', icon: '' },
      { id: 'SCALE', name: 'Scale/Weigh Station', icon: '' },
      { id: 'PERMITS', name: 'Permits', icon: '' },
      { id: 'DRIVER_ADVANCE', name: 'Driver Advance', icon: '' },
      { id: 'REPAIRS_ROAD', name: 'Road Repairs', icon: '' },
      { id: 'TOWING', name: 'Towing', icon: '' },
      { id: 'TICKETS', name: 'Tickets/Fines', icon: '' },
      { id: 'OTHER', name: 'Other', icon: '' }
    ];
    
    let varCostFilter = 'all';
    let varCostMonth = new Date().getMonth() + 1;
    let varCostYear = new Date().getFullYear();
    
    function renderVariableCosts(c) {
      const costs = appData.variable_costs || [];
      
      // Filter by month/year
      const filtered = varCostFilter === 'all' ? costs : costs.filter(vc => {
        if (!vc.date) return false;
        const d = new Date(vc.date);
        return d.getMonth() + 1 === varCostMonth && d.getFullYear() === varCostYear;
      });
      
      // Calculate totals
      const totalAll = costs.reduce((s, vc) => s + parseFloat(vc.amount || 0), 0);
      const totalFiltered = filtered.reduce((s, vc) => s + parseFloat(vc.amount || 0), 0);
      
      // Group by category
      const byCategory = {};
      variableCostCategories.forEach(cat => byCategory[cat.id] = 0);
      filtered.forEach(vc => {
        if (byCategory[vc.category] !== undefined) byCategory[vc.category] += parseFloat(vc.amount || 0);
        else byCategory['OTHER'] += parseFloat(vc.amount || 0);
      });
      
      // Sort by date desc
      const sorted = [...filtered].sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
      
      // Build category summary cards
      const categoryCards = variableCostCategories
        .filter(cat => byCategory[cat.id] > 0)
        .sort((a, b) => byCategory[b.id] - byCategory[a.id])
        .map(cat => '<div style="background:var(--bg-app);padding:var(--spacing-3);border-radius:var(--radius);text-align:center;min-width:120px"><div style="font-size:20px">' + cat.icon + '</div><div style="font-size:var(--text-xs);color:var(--text-muted);margin:4px 0">' + cat.name + '</div><div style="font-weight:700;color:var(--text-primary)">' + formatMoney(byCategory[cat.id]) + '</div></div>').join('');
      
      const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      
      c.innerHTML = '<div class="header"><h2> Variable Costs</h2><button class="btn btn-primary" onclick="openVariableCostModal()">+ Add Expense</button></div>' +
        
        '<div style="background:var(--amber-dim);border:1px solid var(--amber);border-radius:8px;padding:16px;margin-bottom:24px"><strong style="color:var(--amber)"> Variable Costs</strong><p style="color:var(--amber);margin-top:8px">Track expenses that vary based on operations: tolls, lumper fees, DEF, parking, etc. These are included in the Profitability Dashboard.</p></div>' +
        
        // Period Filter
        '<div style="display:flex;gap:12px;align-items:center;margin-bottom:20px;flex-wrap:wrap">' +
        '<button class="btn ' + (varCostFilter === 'all' ? 'btn-primary' : 'btn-secondary') + '" onclick="setVarCostFilter(\'all\')">All Time</button>' +
        '<button class="btn ' + (varCostFilter === 'month' ? 'btn-primary' : 'btn-secondary') + '" onclick="setVarCostFilter(\'month\')">By Month</button>' +
        (varCostFilter === 'month' ? '<select onchange="setVarCostMonth(this.value)" style="padding:8px;border-radius:6px;border:1px solid var(--bg-elevated)">' + months.slice(1).map((m, i) => '<option value="' + (i + 1) + '"' + (varCostMonth === i + 1 ? ' selected' : '') + '>' + m + '</option>').join('') + '</select>' +
        '<select onchange="setVarCostYear(this.value)" style="padding:8px;border-radius:6px;border:1px solid var(--bg-elevated)">' + [2023, 2024, 2025, 2026, 2027].map(y => '<option value="' + y + '"' + (varCostYear === y ? ' selected' : '') + '>' + y + '</option>').join('') + '</select>' : '') +
        '</div>' +
        
        // Stats
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:130px;padding:12px 16px;border-left:4px solid var(--amber)"><div class="label">' + (varCostFilter === 'all' ? 'All Time' : months[varCostMonth] + ' ' + varCostYear) + ' Total</div><div class="value" style="color:var(--amber)">' + formatMoney(totalFiltered) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Total Entries</div><div class="value">' + filtered.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px"><div class="label">All Time Total</div><div class="value">' + formatMoney(totalAll) + '</div></div>' +
        '</div>' +
        
        // Category breakdown
        (categoryCards ? '<div style="margin-bottom:24px"><h4 style="margin-bottom:12px;color:var(--text-secondary)">By Category</h4><div style="display:flex;gap:12px;flex-wrap:wrap">' + categoryCards + '</div></div>' : '') +
        
        // Table
        '<div class="card"><div class="card-header"><h3> All Variable Expenses</h3><button class="btn btn-secondary btn-sm" onclick="exportVariableCostsCSV()"> Export</button></div><div class="table-wrapper"><table><thead><tr><th>Date</th><th>Category</th><th>Truck</th><th>Amount</th><th>Notes</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        (sorted.length === 0 ? '<tr><td colspan="6" style="text-align:center;padding:40px">No variable costs recorded yet.</td></tr>' :
        sorted.map(vc => {
          const cat = variableCostCategories.find(c => c.id === vc.category) || { icon: '', name: vc.category };
          const truck = appData.trucks.find(t => t.id === vc.truck_id);
          return '<tr><td>' + formatDate(vc.date) + '</td><td>' + cat.icon + ' ' + cat.name + '</td><td>' + (truck ? '#' + truck.truck_number : '-') + '</td><td class="money" style="color:var(--amber);font-weight:600">' + formatMoney(vc.amount) + '</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + (vc.notes || '-') + '</td><td class="sticky-col"><div class="actions"><button class="action-btn edit" onclick="openVariableCostModal(' + vc.id + ')">Edit</button><button class="action-btn delete" onclick="deleteVariableCost(' + vc.id + ')">Del</button></div></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }
    
    function setVarCostFilter(f) { varCostFilter = f; renderVariableCosts(document.getElementById('main-content')); }
    function setVarCostMonth(m) { varCostMonth = parseInt(m); renderVariableCosts(document.getElementById('main-content')); }
    function setVarCostYear(y) { varCostYear = parseInt(y); renderVariableCosts(document.getElementById('main-content')); }
    
    function openVariableCostModal(id = null) {
      const vc = id ? (appData.variable_costs || []).find(x => x.id === id) : null;
      const truckOptions = appData.trucks.map(t => '<option value="' + t.id + '"' + (vc?.truck_id === t.id ? ' selected' : '') + '>#' + t.truck_number + '</option>').join('');
      const catOptions = variableCostCategories.map(cat => '<option value="' + cat.id + '"' + (vc?.category === cat.id ? ' selected' : '') + '>' + cat.icon + ' ' + cat.name + '</option>').join('');
      
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:480px"><div class="modal-header"><h3>' + (vc ? 'Edit' : 'Add') + ' Variable Cost</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body">' +
        '<div class="form-row"><div class="form-group"><label>Date *</label><input type="date" id="vcDate" value="' + (vc?.date || new Date().toISOString().split('T')[0]) + '"></div>' +
        '<div class="form-group"><label>Amount $ *</label><input type="number" step="0.01" id="vcAmount" value="' + (vc?.amount || '') + '" placeholder="0.00"></div></div>' +
        '<div class="form-row"><div class="form-group"><label>Category *</label><select id="vcCategory">' + catOptions + '</select></div>' +
        '<div class="form-group"><label>Truck (Optional)</label><select id="vcTruck"><option value="">-- No Truck --</option>' + truckOptions + '</select></div></div>' +
        '<div class="form-group"><label>Trip # (Optional)</label><input id="vcTrip" value="' + (vc?.trip_number || '') + '" placeholder="e.g., T-1234"></div>' +
        '<div class="form-group"><label>Notes</label><textarea id="vcNotes" rows="2" placeholder="Additional details...">' + (vc?.notes || '') + '</textarea></div>' +
        '</div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveVariableCost(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }
    
    async function saveVariableCost(id) {
      const data = {
        date: document.getElementById('vcDate').value,
        amount: parseFloat(document.getElementById('vcAmount').value) || 0,
        category: document.getElementById('vcCategory').value,
        truck_id: parseInt(document.getElementById('vcTruck').value) || null,
        trip_number: document.getElementById('vcTrip').value || null,
        notes: document.getElementById('vcNotes').value || null
      };
      
      if (!data.date || !data.amount) { showToast('Date and Amount are required', 'error'); return; }
      
      try {
        const truck = data.truck_id ? appData.trucks.find(t => t.id === data.truck_id) : null;
        if (id) {
          await dbUpdate('variable_costs', id, data);
          await logActivity('VARIABLE_COST_UPDATED', { cost_id: id, category: data.category, amount: data.amount, truck_number: truck?.truck_number });
        } else {
          const newCost = await dbInsert('variable_costs', data);
          await logActivity('VARIABLE_COST_CREATED', { cost_id: newCost.id, category: data.category, amount: data.amount, truck_number: truck?.truck_number });
        }
        document.querySelector('.modal-overlay').remove();
        showToast('Variable cost saved!');
        await loadAllData(true);
        renderVariableCosts(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }
    
    async function deleteVariableCost(id) {
      if (!confirm('Delete this expense?')) return;
      try {
        const cost = (appData.variable_costs || []).find(vc => vc.id === id);
        await dbDelete('variable_costs', id);
        await logActivity('VARIABLE_COST_DELETED', { cost_id: id, category: cost?.category, amount: cost?.amount });
        showToast('Deleted');
        await loadAllData(true);
        renderVariableCosts(document.getElementById('main-content'));
      } catch (e) { showToast(e.message, 'error'); }
    }
    
    function exportVariableCostsCSV() {
      const costs = appData.variable_costs || [];
      if (costs.length === 0) { showToast('No data to export', 'error'); return; }
      
      const headers = ['Date', 'Category', 'Truck #', 'Trip #', 'Amount', 'Notes'];
      const rows = costs.map(vc => {
        const truck = appData.trucks.find(t => t.id === vc.truck_id);
        const cat = variableCostCategories.find(c => c.id === vc.category);
        return [
          vc.date || '',
          cat ? cat.name : vc.category,
          truck ? truck.truck_number : '',
          vc.trip_number || '',
          vc.amount || 0,
          (vc.notes || '').replace(/"/g, '""')
        ].map(v => '"' + v + '"').join(',');
      });
      
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'variable_costs_' + new Date().toISOString().split('T')[0] + '.csv';
      link.click();
      showToast('Exported ' + costs.length + ' records!');
    }

    // Financial Analysis Report
    let finPeriodType = 'month';
    let finYear = new Date().getFullYear();
    let finMonth = new Date().getMonth() + 1;
    let finQuarter = Math.ceil(finMonth / 3);

    function renderFinancialAnalysis(c) {
      const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const numTrucks = appData.trucks.filter(t => t.status === 'ACTIVE').length || 1;
      const monthlyFixedCosts = (appData.fixed_costs || []).reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);

      // Filter by financialsYear
      const yearStart = financialsYear + '-01-01';
      const yearEnd = financialsYear + '-12-31';
      const yearFilteredTrips = (appData.trips || []).filter(t => {
        if (!t.trip_date) return false;
        return t.trip_date >= yearStart && t.trip_date <= yearEnd;
      });

      // ============ YEAR CALCULATIONS FOR "AT A GLANCE" ============
      let allTimeRevenue = 0, allTimeBrokerFees = 0, allTimeLocalFees = 0, allTimeDriverCut = 0, allTimeExpenses = 0, allTimeMiles = 0, allTimeCars = 0;
      const allTimeFuelCosts = { FUEL: 0, TOLLS: 0, PERMITS: 0, PARKING: 0, MAINTENANCE: 0, OTHER: 0 };

      yearFilteredTrips.forEach(t => {
        const f = getTripFin(t.id);
        allTimeRevenue += f.loadRevenue;
        allTimeBrokerFees += f.brokerFee;
        allTimeLocalFees += f.localFees;
        allTimeDriverCut += f.driverCut;
        allTimeExpenses += f.totalExpenses;
        allTimeMiles += parseFloat(t.miles || 0);
        allTimeCars += f.vehicleCount;
        
        const tripExpenses = appData.expenses.filter(e => e.trip_id === t.id);
        tripExpenses.forEach(e => {
          if (allTimeFuelCosts[e.category] !== undefined) allTimeFuelCosts[e.category] += parseFloat(e.amount || 0);
          else allTimeFuelCosts.OTHER += parseFloat(e.amount || 0);
        });
      });
      
      const allTimeTripCount = yearFilteredTrips.length;
      const allTimeCleanGross = allTimeRevenue - allTimeBrokerFees - allTimeLocalFees;
      const allTimeDirectTripExpenses = allTimeBrokerFees + allTimeLocalFees + allTimeDriverCut + allTimeExpenses; // All trip costs
      const allTimeNetProfit = allTimeRevenue - allTimeDirectTripExpenses; // Revenue - All Trip Costs
      const allTimeTruckGross = allTimeCleanGross - allTimeDriverCut; // Keep for backward compatibility

      // Calculate avg driver cut percentage
      let totalCutPercent = 0;
      yearFilteredTrips.forEach(t => totalCutPercent += parseFloat(t.driver_cut_percent || 32));
      const avgDriverCutPercent = allTimeTripCount > 0 ? totalCutPercent / allTimeTripCount : 32;
      
      // All-time metrics
      const allTimeAvgPPC = allTimeCars > 0 ? allTimeRevenue / allTimeCars : 0;
      const allTimeAvgPPM = allTimeMiles > 0 ? allTimeRevenue / allTimeMiles : 0;
      const allTimeAvgCarsPerTrip = allTimeTripCount > 0 ? allTimeCars / allTimeTripCount : 0;
      const allTimeAvgMilesPerTrip = allTimeTripCount > 0 ? allTimeMiles / allTimeTripCount : 0;
      const allTimeAvgExpensePerTrip = allTimeTripCount > 0 ? allTimeExpenses / allTimeTripCount : 0;
      const allTimeAvgFuelPerMile = allTimeMiles > 0 ? allTimeFuelCosts.FUEL / allTimeMiles : 0;
      
      // Calculate break-even PPC
      // New formula: Net Profit = Clean Gross - Direct Trip Costs - Fixed Costs
      // Clean Gross = Revenue - Broker Fees - Local Fees
      // Direct Trip Costs = Driver Cut + Expenses
      // To break even: 0 = Clean Gross - Direct Trip Costs - Fixed Costs
      const brokerFeeRatio = allTimeRevenue > 0 ? allTimeBrokerFees / allTimeRevenue : 0;
      const localFeeRatio = allTimeRevenue > 0 ? allTimeLocalFees / allTimeRevenue : 0;
      const driverCutRatio = avgDriverCutPercent / 100;
      
      // Revenue needed per month to break even:
      // Clean Gross = Revenue * (1 - brokerRatio - localRatio)
      // Driver Cut = Clean Gross * driverRatio
      // Net Profit = Clean Gross - Driver Cut - Expenses - Fixed Costs = 0
      // Revenue * (1 - brokerRatio - localRatio) * (1 - driverRatio) = expenses + Fixed Costs
      // Calculate avg monthly direct costs from trips (includes all trip costs)
      // Use yearFilteredTrips instead of all trips for accurate year-based metrics
      const tripDates = yearFilteredTrips.map(t => parseTripDate(t.trip_date)).filter(d => d !== null);
      const minDate = tripDates.length > 0 ? new Date(Math.min(...tripDates)) : new Date();
      const maxDate = tripDates.length > 0 ? new Date(Math.max(...tripDates)) : new Date();
      const monthsOfData = Math.max(1, Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24 * 30)));
      const avgMonthlyDirectExpenses = allTimeDirectTripExpenses / monthsOfData;
      const avgMonthlyTrips = allTimeTripCount / monthsOfData;
      const avgMonthlyCars = allTimeCars / monthsOfData;
      
      const truckGrossRatio = (1 - brokerFeeRatio - localFeeRatio) * (1 - driverCutRatio);
      const breakEvenMonthlyRevenue = truckGrossRatio > 0 ? (monthlyFixedCosts + avgMonthlyDirectExpenses) / truckGrossRatio : 0;
      const breakEvenPPC = avgMonthlyCars > 0 ? breakEvenMonthlyRevenue / avgMonthlyCars : 0;
      const currentProfitPerCar = allTimeCars > 0 ? allTimeNetProfit / allTimeCars : 0;
      const ppcGap = breakEvenPPC - allTimeAvgPPC;
      
      // Profit trajectory (current vs needed) - using new formula
      const currentMonthlyProfit = allTimeNetProfit / monthsOfData - monthlyFixedCosts;
      const isProfitable = currentMonthlyProfit >= 0;
      
      // ============ PERIOD CALCULATIONS ============
      let filteredTrips = [];
      let periodLabel = '';
      
      if (finPeriodType === 'month') {
        filteredTrips = appData.trips.filter(t => {
          const d = parseTripDate(t.trip_date);
          return d && d.getFullYear() === finYear && (d.getMonth() + 1) === finMonth;
        });
        periodLabel = months[finMonth] + ' ' + finYear;
      } else if (finPeriodType === 'quarter') {
        const qMonths = [(finQuarter-1)*3+1, (finQuarter-1)*3+2, (finQuarter-1)*3+3];
        filteredTrips = appData.trips.filter(t => {
          const d = parseTripDate(t.trip_date);
          return d && d.getFullYear() === finYear && qMonths.includes(d.getMonth() + 1);
        });
        periodLabel = 'Q' + finQuarter + ' ' + finYear;
      } else {
        filteredTrips = appData.trips.filter(t => {
          const d = parseTripDate(t.trip_date);
          return d && d.getFullYear() === finYear;
        });
        periodLabel = 'Year ' + finYear;
      }
      
      // 
      //  CAR VOLUME TRACKING BY TIMEFRAME
      // 
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Normalize to start of day
      const currentYear = today.getFullYear();
      const currentMonth = today.getMonth() + 1;
      const currentQuarter = Math.ceil(currentMonth / 3);
      
      // 
      //  CAR VOLUME TRACKING BY IMPORT DATE (created_at)
      // Tracks when vehicles were added to TMS, not trip date
      // 
      
      // Helper: Get orders imported in date range (by created_at)
      const getOrdersInRange = (startDate, endDate) => appData.orders.filter(o => {
        if (!o.created_at) return false;
        const d = new Date(o.created_at);
        return d >= startDate && d <= endDate;
      });
      
      // Helper: Get orders imported in a specific month
      const getOrdersInMonth = (year, month) => appData.orders.filter(o => {
        if (!o.created_at) return false;
        const d = new Date(o.created_at);
        return d.getFullYear() === year && (d.getMonth() + 1) === month;
      });
      
      // Helper: Get orders imported in a specific year
      const getOrdersInYear = (year) => appData.orders.filter(o => {
        if (!o.created_at) return false;
        const d = new Date(o.created_at);
        return d.getFullYear() === year;
      });
      
      // Helper: Get orders imported in specific quarter
      const getOrdersInQuarter = (year, quarter) => {
        const qMonths = [(quarter-1)*3+1, (quarter-1)*3+2, (quarter-1)*3+3];
        return appData.orders.filter(o => {
          if (!o.created_at) return false;
          const d = new Date(o.created_at);
          return d.getFullYear() === year && qMonths.includes(d.getMonth() + 1);
        });
      };
      
      //  WEEKLY TRACKING 
      const getWeekStart = (date) => {
        const d = new Date(date);
        const day = d.getDay();
        d.setDate(d.getDate() - day);
        d.setHours(0, 0, 0, 0);
        return d;
      };
      const getWeekEnd = (weekStart) => {
        const d = new Date(weekStart);
        d.setDate(d.getDate() + 6);
        d.setHours(23, 59, 59, 999);
        return d;
      };
      
      const thisWeekStart = getWeekStart(today);
      const thisWeekEnd = getWeekEnd(thisWeekStart);
      const lastWeekStart = new Date(thisWeekStart); lastWeekStart.setDate(lastWeekStart.getDate() - 7);
      const lastWeekEnd = new Date(thisWeekEnd); lastWeekEnd.setDate(lastWeekEnd.getDate() - 7);
      const twoWeeksAgoStart = new Date(lastWeekStart); twoWeeksAgoStart.setDate(twoWeeksAgoStart.getDate() - 7);
      const twoWeeksAgoEnd = new Date(lastWeekEnd); twoWeeksAgoEnd.setDate(twoWeeksAgoEnd.getDate() - 7);
      
      // Count cars by import date (created_at)
      const thisWeekCars = getOrdersInRange(thisWeekStart, thisWeekEnd).length;
      const lastWeekCars = getOrdersInRange(lastWeekStart, lastWeekEnd).length;
      const twoWeeksAgoCars = getOrdersInRange(twoWeeksAgoStart, twoWeeksAgoEnd).length;
      const weeklyChange = lastWeekCars > 0 ? ((thisWeekCars - lastWeekCars) / lastWeekCars * 100) : 0;
      
      // Debug logging
      console.log('=== CAR VOLUME DEBUG (by import date) ===');
      console.log('Today:', today.toISOString());
      console.log('This Week:', thisWeekStart.toISOString(), 'to', thisWeekEnd.toISOString());
      console.log('Total orders:', appData.orders.length);
      console.log('Orders this week:', thisWeekCars);
      console.log('Orders last week:', lastWeekCars);
      console.log('==========================================');
      
      //  MONTHLY TRACKING (by import date) 
      const getMonthData = (year, month) => {
        const orders = getOrdersInMonth(year, month);
        // Count unique trips these orders belong to
        const tripIds = new Set(orders.filter(o => o.trip_id).map(o => o.trip_id));
        return { trips: tripIds.size, cars: orders.length };
      };
      
      const monthlyData = [];
      for (let i = 5; i >= 0; i--) {
        let m = currentMonth - i;
        let y = currentYear;
        if (m <= 0) { m += 12; y--; }
        const data = getMonthData(y, m);
        monthlyData.push({ 
          label: months[m].substring(0, 3) + ' ' + String(y).slice(-2), 
          month: m, 
          year: y,
          cars: data.cars, 
          trips: data.trips 
        });
      }
      
      const thisMonthCars = monthlyData[5]?.cars || 0;
      const lastMonthCars = monthlyData[4]?.cars || 0;
      const monthlyChange = lastMonthCars > 0 ? ((thisMonthCars - lastMonthCars) / lastMonthCars * 100) : 0;
      const maxMonthlyCars = Math.max(...monthlyData.map(m => m.cars), 1);
      
      //  QUARTERLY TRACKING (by import date) 
      const getQuarterData = (year, quarter) => {
        const orders = getOrdersInQuarter(year, quarter);
        const tripIds = new Set(orders.filter(o => o.trip_id).map(o => o.trip_id));
        return { trips: tripIds.size, cars: orders.length };
      };
      
      // Current year quarters
      const q1Data = getQuarterData(currentYear, 1);
      const q2Data = getQuarterData(currentYear, 2);
      const q3Data = getQuarterData(currentYear, 3);
      const q4Data = getQuarterData(currentYear, 4);
      
      // Last year quarters for comparison
      const lastYearQ1 = getQuarterData(currentYear - 1, 1);
      const lastYearQ2 = getQuarterData(currentYear - 1, 2);
      const lastYearQ3 = getQuarterData(currentYear - 1, 3);
      const lastYearQ4 = getQuarterData(currentYear - 1, 4);
      
      const quarterlyData = [
        { label: 'Q1', current: q1Data, lastYear: lastYearQ1 },
        { label: 'Q2', current: q2Data, lastYear: lastYearQ2 },
        { label: 'Q3', current: q3Data, lastYear: lastYearQ3 },
        { label: 'Q4', current: q4Data, lastYear: lastYearQ4 }
      ];
      
      const maxQuarterlyCars = Math.max(...quarterlyData.map(q => Math.max(q.current.cars, q.lastYear.cars)), 1);
      
      //  YEARLY TRACKING (by import date) 
      const getYearData = (year) => {
        const orders = getOrdersInYear(year);
        const tripIds = new Set(orders.filter(o => o.trip_id).map(o => o.trip_id));
        return { trips: tripIds.size, cars: orders.length };
      };
      
      const yearlyData = [];
      for (let y = currentYear - 2; y <= currentYear; y++) {
        const data = getYearData(y);
        yearlyData.push({ year: y, cars: data.cars, trips: data.trips });
      }
      
      const thisYearCars = yearlyData.find(y => y.year === currentYear)?.cars || 0;
      const lastYearCars = yearlyData.find(y => y.year === currentYear - 1)?.cars || 0;
      const yearlyChange = lastYearCars > 0 ? ((thisYearCars - lastYearCars) / lastYearCars * 100) : 0;
      const maxYearlyCars = Math.max(...yearlyData.map(y => y.cars), 1);
      
      // Calculate period metrics
      let loadRevenue = 0, brokerFees = 0, localFees = 0, driverCut = 0, tripExpenses = 0, totalMiles = 0, totalCars = 0;
      const fuelCosts = { FUEL: 0, TOLLS: 0, PERMITS: 0, PARKING: 0, MAINTENANCE: 0, OTHER: 0 };
      
      filteredTrips.forEach(t => {
        const f = getTripFin(t.id);
        loadRevenue += f.loadRevenue;
        brokerFees += f.brokerFee;
        localFees += f.localFees;
        driverCut += f.driverCut;
        tripExpenses += f.totalExpenses;
        totalMiles += parseFloat(t.miles || 0);
        totalCars += f.vehicleCount;
        
        const tripExp = appData.expenses.filter(e => e.trip_id === t.id);
        tripExp.forEach(e => {
          if (fuelCosts[e.category] !== undefined) fuelCosts[e.category] += parseFloat(e.amount || 0);
          else fuelCosts.OTHER += parseFloat(e.amount || 0);
        });
      });
      
      // Direct Trip Expenses = ALL costs for trips
      const directTripExpenses = brokerFees + localFees + driverCut + tripExpenses;
      
      const tripCount = filteredTrips.length;
      const cleanGross = loadRevenue - brokerFees - localFees;
      const netProfit = loadRevenue - directTripExpenses; // Revenue - All Trip Costs
      const truckGross = cleanGross - driverCut; // Keep for backward compatibility
      const periodMonths = finPeriodType === 'month' ? 1 : finPeriodType === 'quarter' ? 3 : 12;
      const totalFixedCosts = monthlyFixedCosts * periodMonths;
      const totalOperatingExpenses = totalFixedCosts + directTripExpenses;
      const netProfitBeforeTax = loadRevenue - totalOperatingExpenses; // Revenue - (Fixed Costs + Direct Trip Expenses)
      const grossProfitMargin = loadRevenue > 0 ? (netProfit / loadRevenue * 100) : 0; // Trip profit margin
      const netProfitMargin = loadRevenue > 0 ? (netProfitBeforeTax / loadRevenue * 100) : 0;
      
      // Per-unit metrics
      const avgRevPerTruck = loadRevenue / numTrucks;
      const avgTruckGrossPerTruck = truckGross / numTrucks;
      const fixedCostPerTruck = totalFixedCosts / numTrucks;
      const netProfitPerTruck = netProfitBeforeTax / numTrucks;
      
      const avgRevPerTrip = tripCount > 0 ? loadRevenue / tripCount : 0;
      const avgTruckGrossPerTrip = tripCount > 0 ? truckGross / tripCount : 0;
      const avgPricePerCar = totalCars > 0 ? loadRevenue / totalCars : 0;
      const directCostPerTrip = tripCount > 0 ? directTripExpenses / tripCount : 0;
      const fixedCostPerTrip = tripCount > 0 ? totalFixedCosts / tripCount : 0;
      const netProfitPerTrip = tripCount > 0 ? netProfitBeforeTax / tripCount : 0;
      
      const revenuePerMile = totalMiles > 0 ? loadRevenue / totalMiles : 0;
      const truckGrossPerMile = totalMiles > 0 ? truckGross / totalMiles : 0;
      const fuelCostPerMile = totalMiles > 0 ? fuelCosts.FUEL / totalMiles : 0;
      const netProfitPerMile = totalMiles > 0 ? netProfitBeforeTax / totalMiles : 0;
      
      //  NEW: Enhanced Efficiency Metrics 
      // Cost Per Mile breakdown
      const totalCostPerMile = totalMiles > 0 ? totalOperatingExpenses / totalMiles : 0;
      const directCostPerMile = totalMiles > 0 ? directTripExpenses / totalMiles : 0;
      
      // Efficiency Ratios
      const fuelToRevenueRatio = loadRevenue > 0 ? (fuelCosts.FUEL / loadRevenue * 100) : 0;
      const feeBurdenRatio = loadRevenue > 0 ? ((brokerFees + localFees) / loadRevenue * 100) : 0;
      const driverCutRatioDisplay = cleanGross > 0 ? (driverCut / cleanGross * 100) : 0;
      const expenseRatio = loadRevenue > 0 ? (tripExpenses / loadRevenue * 100) : 0;
      
      // Break-Even Analysis (enhanced)
      const breakEvenCarsPerMonth = currentProfitPerCar !== 0 ? Math.ceil(monthlyFixedCosts / Math.abs(currentProfitPerCar)) : 0;
      const breakEvenRevenuePerMonth = truckGrossRatio > 0 ? monthlyFixedCosts / truckGrossRatio : 0;
      const marginOfSafety = loadRevenue > 0 && breakEvenRevenuePerMonth > 0 ? ((loadRevenue / periodMonths - breakEvenRevenuePerMonth) / (loadRevenue / periodMonths) * 100) : 0;
      
      // Variable costs integration
      const totalVariableCosts = (appData.variable_costs || [])
        .filter(vc => {
          if (!vc.date) return false;
          const d = new Date(vc.date);
          if (finPeriodType === 'month') return d.getFullYear() === finYear && (d.getMonth() + 1) === finMonth;
          if (finPeriodType === 'quarter') {
            const qMonths = [(finQuarter-1)*3+1, (finQuarter-1)*3+2, (finQuarter-1)*3+3];
            return d.getFullYear() === finYear && qMonths.includes(d.getMonth() + 1);
          }
          return d.getFullYear() === finYear;
        })
        .reduce((s, vc) => s + parseFloat(vc.amount || 0), 0);
      
      // Fuel from fuel_transactions (for period)
      const fuelTransactionsCost = (appData.fuel_transactions || [])
        .filter(ft => {
          if (!ft.transaction_date) return false;
          const d = new Date(ft.transaction_date);
          if (finPeriodType === 'month') return d.getFullYear() === finYear && (d.getMonth() + 1) === finMonth;
          if (finPeriodType === 'quarter') {
            const qMonths = [(finQuarter-1)*3+1, (finQuarter-1)*3+2, (finQuarter-1)*3+3];
            return d.getFullYear() === finYear && qMonths.includes(d.getMonth() + 1);
          }
          return d.getFullYear() === finYear;
        })
        .reduce((s, ft) => s + parseFloat(ft.total_cost || 0), 0);
      
      // Combined true operating expenses
      const trueOperatingExpenses = totalOperatingExpenses + totalVariableCosts + fuelTransactionsCost;
      const trueNetProfit = loadRevenue - directTripExpenses - totalFixedCosts - totalVariableCosts;
      
      // Build fixed costs breakdown
      const fixedCostsBreakdown = (appData.fixed_costs || []).map(fc => '<tr><td style="padding-left:24px">' + fc.name + '</td><td class="money">' + formatMoney(fc.amount * periodMonths) + '</td></tr>').join('');
      
      // Tabs for consolidated view
      const finTabs = `
        <div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;">
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='executive';renderConsolidatedFinancials(document.getElementById('main-content'))"> Executive</button>
          <button class="btn btn-primary" style="padding:6px 12px;font-size:12px" onclick="finTab='analysis';renderConsolidatedFinancials(document.getElementById('main-content'))"> Analysis</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='overview';renderConsolidatedFinancials(document.getElementById('main-content'))"> Overview</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='costs';renderConsolidatedFinancials(document.getElementById('main-content'))"> Costs</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='trips';renderConsolidatedFinancials(document.getElementById('main-content'))"> By Trip</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='drivers';renderConsolidatedFinancials(document.getElementById('main-content'))"> By Driver</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='brokers';renderConsolidatedFinancials(document.getElementById('main-content'))"> By Broker</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="finTab='lanes';renderConsolidatedFinancials(document.getElementById('main-content'))"> By Lane</button>
        </div>
      `;
      
      c.innerHTML = finTabs + '<div class="header"><h2> Financial Analysis</h2><div style="display:flex;gap:8px"><button class="btn btn-secondary" onclick="loadAllData(true).then(()=>renderFinancialAnalysis(document.getElementById(\'main-content\')))"> Refresh</button><button class="btn btn-secondary" onclick="window.print()"> Print</button></div></div>' +
        
        // ============ TRIP SEARCH SECTION (UNCHANGED) ============
        '<div style="background:var(--purple);color:white;padding:10px 16px;border-radius:8px 8px 0 0;font-weight:600;font-size:14px"> TRIP SEARCH & ANALYSIS</div>' +
        '<div class="card" style="border-radius:0 0 8px 8px;margin-bottom:16px;padding:16px">' +
        '<div style="display:flex;gap:12px;align-items:end;flex-wrap:wrap;margin-bottom:16px">' +
        '<div class="form-group" style="margin:0;flex:1;min-width:180px"><label>Select or Search Trip #</label><select id="tripSearchSelect" onchange="showTripAnalysis(this.value)" style="width:100%"><option value="">-- Select a Trip --</option>' +
        appData.trips.map(t => '<option value="' + t.id + '">' + t.trip_number + '</option>').join('') +
        '</select></div>' +
        '<div class="form-group" style="margin:0"><label>Target Utilization %</label><input type="number" id="targetUtilization" value="85" style="width:100px" onchange="if(document.getElementById(\'tripSearchSelect\').value)showTripAnalysis(document.getElementById(\'tripSearchSelect\').value)"></div>' +
        '</div>' +
        '<div id="tripAnalysisResult"></div>' +
        '</div>' +
        
        //  NEW: ALL TRIPS FINANCIAL OVERVIEW 
        '<div class="card" style="padding:0;overflow:hidden;margin-bottom:24px">' +
        '<div style="background:linear-gradient(90deg,var(--green),var(--green));color:white;padding:16px 20px;font-weight:700;display:flex;align-items:center;justify-content:space-between">' +
        '<div style="display:flex;align-items:center;gap:10px"><span style="font-size:20px"></span> All Trips Financial Overview</div>' +
        '<div style="font-size:12px;opacity:0.9">' + appData.trips.length + ' trips total</div>' +
        '</div>' +
        '<div style="padding:16px;background:var(--green-dim);border-bottom:1px solid var(--green-dim)">' +
        '<div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">' +
        '<span style="font-size:13px;color:var(--green);font-weight:500">Quick Filters:</span>' +
        '<button class="btn btn-sm" style="background:var(--green-dim);color:var(--green);border:1px solid var(--green)" onclick="filterTripsTable(\'profitable\')"> Profitable</button>' +
        '<button class="btn btn-sm" style="background:var(--red-dim);color:var(--red);border:1px solid var(--red-dim)" onclick="filterTripsTable(\'losing\')"> Losing</button>' +
        '<button class="btn btn-sm" style="background:var(--blue-dim);color:var(--blue);border:1px solid var(--blue-dim)" onclick="filterTripsTable(\'all\')"> All</button>' +
        '<span style="margin-left:auto;font-size:12px;color:var(--text-muted)">Click column headers to sort</span>' +
        '</div></div>' +
        '<div class="table-wrapper" style="max-height:400px;overflow-y:auto"><table id="tripsFinancialTable"><thead style="position:sticky;top:0;z-index:5"><tr>' +
        '<th onclick="sortTripsTable(\'date\')" style="cursor:pointer">Date </th>' +
        '<th onclick="sortTripsTable(\'trip\')" style="cursor:pointer">Trip # </th>' +
        '<th>Driver</th>' +
        '<th>Truck</th>' +
        '<th onclick="sortTripsTable(\'cars\')" style="cursor:pointer">Cars </th>' +
        '<th onclick="sortTripsTable(\'miles\')" style="cursor:pointer">Miles </th>' +
        '<th onclick="sortTripsTable(\'revenue\')" style="cursor:pointer">Revenue </th>' +
        '<th onclick="sortTripsTable(\'expenses\')" style="cursor:pointer">Expenses </th>' +
        '<th onclick="sortTripsTable(\'profit\')" style="cursor:pointer">Net Profit </th>' +
        '<th onclick="sortTripsTable(\'margin\')" style="cursor:pointer">Margin </th>' +
        '<th onclick="sortTripsTable(\'ppm\')" style="cursor:pointer">$/Mile </th>' +
        '<th>Status</th>' +
        '</tr></thead><tbody>' +
        appData.trips.map(t => {
          const f = getTripFin(t.id);
          const driver = appData.drivers.find(d => d.id === t.driver_id);
          const truck = appData.trucks.find(tr => tr.id === t.truck_id);
          const miles = parseFloat(t.miles || 0);
          const margin = f.loadRevenue > 0 ? (f.netProfit / f.loadRevenue * 100) : 0;
          const ppm = miles > 0 ? f.netProfit / miles : 0;
          const isProfitable = f.netProfit >= 0;
          const statusBadge = isProfitable ? 
            '<span class="badge badge-green"> Profit</span>' : 
            '<span class="badge badge-red"> Loss</span>';
          return '<tr data-profit="' + f.netProfit + '" class="trip-row">' +
            '<td>' + formatDate(t.trip_date) + '</td>' +
            '<td><a href="#" onclick="showTripAnalysis(' + t.id + ');return false" style="color:var(--green);font-weight:600">' + t.trip_number + '</a></td>' +
            '<td>' + (driver ? driver.first_name + ' ' + driver.last_name.charAt(0) + '.' : '-') + '</td>' +
            '<td>' + (truck ? '#' + truck.truck_number : '-') + '</td>' +
            '<td style="text-align:center">' + f.vehicleCount + '</td>' +
            '<td style="text-align:right">' + miles.toLocaleString() + '</td>' +
            '<td class="money" style="color:var(--green)">' + formatMoney(f.loadRevenue) + '</td>' +
            '<td class="money" style="color:var(--red)">' + formatMoney(f.directTripExpenses) + '</td>' +
            '<td class="money" style="font-weight:700;color:' + (isProfitable ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(f.netProfit) + '</td>' +
            '<td style="text-align:right;color:' + (margin >= 20 ? 'var(--green)' : margin >= 0 ? 'var(--amber)' : 'var(--red)') + '">' + margin.toFixed(1) + '%</td>' +
            '<td class="money" style="color:' + (ppm >= 0.5 ? 'var(--green)' : ppm >= 0 ? 'var(--amber)' : 'var(--red)') + '">' + formatMoney(ppm) + '</td>' +
            '<td>' + statusBadge + '</td>' +
            '</tr>';
        }).join('') +
        '</tbody></table></div>' +
        
        // Summary row
        '<div style="padding:16px;background:var(--green-dim);display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px">' +
        (function() {
          let totRev = 0, totExp = 0, totProfit = 0, totMiles = 0, totCars = 0, profitableCount = 0;
          appData.trips.forEach(t => {
            const f = getTripFin(t.id);
            totRev += f.loadRevenue;
            totExp += f.directTripExpenses;
            totProfit += f.netProfit;
            totMiles += parseFloat(t.miles || 0);
            totCars += f.vehicleCount;
            if (f.netProfit >= 0) profitableCount++;
          });
          const avgMargin = totRev > 0 ? (totProfit / totRev * 100) : 0;
          const avgPPM = totMiles > 0 ? totProfit / totMiles : 0;
          return '<div style="text-align:center"><div style="font-size:11px;color:var(--green)">Total Revenue</div><div style="font-weight:700;color:var(--green)">' + formatMoney(totRev) + '</div></div>' +
            '<div style="text-align:center"><div style="font-size:11px;color:var(--green)">Total Expenses</div><div style="font-weight:700;color:var(--red)">' + formatMoney(totExp) + '</div></div>' +
            '<div style="text-align:center"><div style="font-size:11px;color:var(--green)">Total Profit</div><div style="font-weight:700;color:' + (totProfit >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(totProfit) + '</div></div>' +
            '<div style="text-align:center"><div style="font-size:11px;color:var(--green)">Avg Margin</div><div style="font-weight:700">' + avgMargin.toFixed(1) + '%</div></div>' +
            '<div style="text-align:center"><div style="font-size:11px;color:var(--green)">Avg $/Mile</div><div style="font-weight:700">' + formatMoney(avgPPM) + '</div></div>' +
            '<div style="text-align:center"><div style="font-size:11px;color:var(--green)">Profitable Trips</div><div style="font-weight:700;color:var(--green)">' + profitableCount + '/' + appData.trips.length + '</div></div>';
        })() +
        '</div></div>' +
        
        // ============ EXECUTIVE SUMMARY HERO ============
        '<div class="fin-hero" style="background:linear-gradient(135deg,var(--text-primary) 0%,var(--bg-elevated) 50%,var(--bg-elevated) 100%);border-radius:16px;padding:32px;margin-bottom:24px;position:relative;overflow:hidden">' +
        '<div style="position:absolute;top:0;right:0;width:300px;height:300px;background:radial-gradient(circle,rgba(99,102,241,0.15) 0%,transparent 70%);pointer-events:none"></div>' +
        '<div style="position:absolute;bottom:-50px;left:-50px;width:200px;height:200px;background:radial-gradient(circle,rgba(34,197,94,0.1) 0%,transparent 70%);pointer-events:none"></div>' +
        
        '<div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:20px;margin-bottom:24px">' +
        '<div>' +
        '<h3 style="color:var(--bg-card-hover);margin:0 0 8px 0;font-size:var(--text-2xl);font-weight:var(--weight-bold)">Financial Health Dashboard</h3>' +
        '<p style="color:var(--text-muted);margin:0;font-size:14px">All-time analysis  ' + allTimeTripCount + ' trips  ' + allTimeCars + ' cars  ' + allTimeMiles.toLocaleString() + ' miles</p>' +
        '</div>' +
        '<div style="display:flex;gap:12px">' +
        '<div style="background:' + (isProfitable ? 'rgba(34,197,94,0.2)' : 'rgba(239,68,68,0.2)') + ';border:1px solid ' + (isProfitable ? 'var(--green)' : 'var(--red)') + ';padding:8px 16px;border-radius:20px;display:flex;align-items:center;gap:8px">' +
        '<span style="width:8px;height:8px;border-radius:50%;background:' + (isProfitable ? 'var(--green)' : 'var(--red)') + '"></span>' +
        '<span style="color:' + (isProfitable ? 'var(--green)' : 'var(--red)') + ';font-weight:600;font-size:13px">' + (isProfitable ? 'PROFITABLE' : 'NEEDS ATTENTION') + '</span>' +
        '</div>' +
        '</div>' +
        '</div>' +
        
        // Hero Stats Row
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">' +
        
        // Profit Per Car - Main KPI
        '<div class="fin-kpi-card" style="background:linear-gradient(135deg,' + (currentProfitPerCar >= 0 ? 'var(--green),var(--green)' : 'var(--red),var(--red)') + ');padding:24px;border-radius:12px;position:relative;overflow:hidden">' +
        '<div style="position:absolute;top:-20px;right:-20px;font-size:80px;opacity:0.1"></div>' +
        '<div style="font-size:12px;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Profit Per Car</div>' +
        '<div style="font-size:36px;font-weight:800;color:white;line-height:1">' + formatMoney(currentProfitPerCar) + '</div>' +
        '<div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:8px">After all costs incl. fixed</div>' +
        '</div>' +
        
        // Est Monthly Profit
        '<div class="fin-kpi-card" style="background:linear-gradient(135deg,var(--text-primary),var(--blue));padding:24px;border-radius:12px;position:relative;overflow:hidden">' +
        '<div style="position:absolute;top:-20px;right:-20px;font-size:80px;opacity:0.1"></div>' +
        '<div style="font-size:12px;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Est. Monthly Profit</div>' +
        '<div style="font-size:36px;font-weight:800;color:' + (currentMonthlyProfit >= 0 ? 'var(--green)' : 'var(--red)') + ';line-height:1">' + formatMoney(currentMonthlyProfit) + '</div>' +
        '<div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:8px">Based on ' + monthsOfData + ' months data</div>' +
        '</div>' +
        
        // Monthly Fixed Costs
        '<div class="fin-kpi-card" style="background:linear-gradient(135deg,var(--amber),var(--amber));padding:24px;border-radius:12px;position:relative;overflow:hidden">' +
        '<div style="position:absolute;top:-20px;right:-20px;font-size:80px;opacity:0.1"></div>' +
        '<div style="font-size:12px;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Monthly Fixed Costs</div>' +
        '<div style="font-size:36px;font-weight:800;color:white;line-height:1">' + formatMoney(monthlyFixedCosts) + '</div>' +
        '<div style="font-size:12px;color:rgba(255,255,255,0.6);margin-top:8px">~' + formatMoney(avgMonthlyCars > 0 ? monthlyFixedCosts / avgMonthlyCars : 0) + ' per car</div>' +
        '</div>' +
        
        // Break-Even PPC
        '<div class="fin-kpi-card" style="background:linear-gradient(135deg,var(--purple),var(--purple));padding:24px;border-radius:12px;position:relative;overflow:hidden">' +
        '<div style="position:absolute;top:-20px;right:-20px;font-size:80px;opacity:0.1"></div>' +
        '<div style="font-size:12px;color:rgba(255,255,255,0.7);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Break-Even PPC</div>' +
        '<div style="font-size:36px;font-weight:800;color:white;line-height:1">' + formatMoney(breakEvenPPC) + '</div>' +
        '<div style="font-size:12px;color:' + (ppcGap <= 0 ? 'var(--green)' : 'var(--amber)') + ';margin-top:8px">' + (ppcGap > 0 ? ' Need +' + formatMoney(ppcGap) : ' Above by ' + formatMoney(Math.abs(ppcGap))) + '</div>' +
        '</div>' +
        '</div>' +
        '</div>' +
        
        // 
        //  CAR VOLUME TRACKING BY TIMEFRAME
        // 
        '<div class="card" style="padding:0;overflow:hidden;margin-bottom:24px">' +
        '<div style="background:linear-gradient(135deg,var(--purple) 0%,var(--purple) 100%);color:white;padding:20px 24px">' +
        '<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">' +
        '<div style="display:flex;align-items:center;gap:12px">' +
        '<span style="font-size:32px"></span>' +
        '<div><h3 style="margin:0;font-size:var(--text-xl);font-weight:var(--weight-bold)">Car Volume Tracking</h3>' +
        '<p style="margin:4px 0 0 0;opacity:0.85;font-size:13px">Vehicles counted by import date (when added to TMS)</p></div>' +
        '</div>' +
        '<div style="display:flex;gap:16px;flex-wrap:wrap">' +
        '<div style="text-align:center;padding:8px 16px;background:rgba(255,255,255,0.15);border-radius:8px">' +
        '<div style="font-size:11px;opacity:0.8">ALL TIME</div>' +
        '<div style="font-size:24px;font-weight:800">' + appData.orders.length.toLocaleString() + '</div></div>' +
        '<div style="text-align:center;padding:8px 16px;background:rgba(255,255,255,0.15);border-radius:8px">' +
        '<div style="font-size:11px;opacity:0.8">THIS YEAR</div>' +
        '<div style="font-size:24px;font-weight:800">' + thisYearCars.toLocaleString() + '</div></div>' +
        '</div></div></div>' +
        
        '<div style="padding:24px">' +
        
        //  WEEKLY SECTION 
        '<div style="margin-bottom:28px">' +
        '<div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">' +
        '<span style="font-size:18px"></span>' +
        '<h4 style="margin:0;color:var(--text-primary);font-weight:600">Weekly Volume</h4>' +
        '<span style="margin-left:auto;font-size:12px;color:' + (weeklyChange >= 0 ? 'var(--green)' : 'var(--red)') + ';font-weight:600;background:' + (weeklyChange >= 0 ? 'var(--green-dim)' : 'var(--red-dim)') + ';padding:4px 10px;border-radius:12px">' +
        (weeklyChange >= 0 ? '' : '') + ' ' + Math.abs(weeklyChange).toFixed(1) + '% vs last week</span>' +
        '</div>' +
        '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">' +
        '<div style="background:var(--bg-app);border-radius:12px;padding:20px;text-align:center;border:2px solid var(--border)">' +
        '<div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">2 Weeks Ago</div>' +
        '<div style="font-size:32px;font-weight:800;color:var(--text-muted)">' + twoWeeksAgoCars + '</div>' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted)">cars</div></div>' +
        '<div style="background:var(--bg-app);border-radius:12px;padding:20px;text-align:center;border:2px solid var(--border)">' +
        '<div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Last Week</div>' +
        '<div style="font-size:32px;font-weight:800;color:var(--text-secondary)">' + lastWeekCars + '</div>' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted)">cars</div></div>' +
        '<div style="background:linear-gradient(135deg,var(--blue-dim),var(--purple-dim));border-radius:12px;padding:20px;text-align:center;border:2px solid var(--purple-dim)">' +
        '<div style="font-size:12px;color:var(--purple);margin-bottom:4px;font-weight:600">THIS WEEK</div>' +
        '<div style="font-size:32px;font-weight:800;color:var(--purple)">' + thisWeekCars + '</div>' +
        '<div style="font-size:11px;color:var(--purple)">cars</div></div>' +
        '</div></div>' +
        
        //  MONTHLY SECTION 
        '<div style="margin-bottom:28px">' +
        '<div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">' +
        '<span style="font-size:18px"></span>' +
        '<h4 style="margin:0;color:var(--text-primary);font-weight:600">Monthly Volume (Last 6 Months)</h4>' +
        '<span style="margin-left:auto;font-size:12px;color:' + (monthlyChange >= 0 ? 'var(--green)' : 'var(--red)') + ';font-weight:600;background:' + (monthlyChange >= 0 ? 'var(--green-dim)' : 'var(--red-dim)') + ';padding:4px 10px;border-radius:12px">' +
        (monthlyChange >= 0 ? '' : '') + ' ' + Math.abs(monthlyChange).toFixed(1) + '% vs last month</span>' +
        '</div>' +
        '<div style="display:grid;grid-template-columns:repeat(6,1fr);gap:12px">' +
        monthlyData.map((m, i) => {
          const isCurrentMonth = i === 5;
          const barHeight = maxMonthlyCars > 0 ? (m.cars / maxMonthlyCars * 80) : 0;
          return '<div style="text-align:center">' +
            '<div style="height:100px;display:flex;flex-direction:column;justify-content:flex-end;align-items:center">' +
            '<div style="font-size:14px;font-weight:700;color:' + (isCurrentMonth ? 'var(--purple)' : 'var(--bg-elevated)') + ';margin-bottom:4px">' + m.cars + '</div>' +
            '<div style="width:40px;height:' + barHeight + 'px;background:' + (isCurrentMonth ? 'linear-gradient(180deg,var(--purple),var(--purple))' : 'linear-gradient(180deg,var(--text-muted),var(--text-secondary))') + ';border-radius:4px 4px 0 0;min-height:4px"></div></div>' +
            '<div style="margin-top:8px;padding:8px;background:' + (isCurrentMonth ? 'var(--purple-dim)' : 'var(--bg-app)') + ';border-radius:8px">' +
            '<div style="font-size:11px;font-weight:' + (isCurrentMonth ? '700' : '500') + ';color:' + (isCurrentMonth ? 'var(--purple)' : 'var(--text-secondary)') + '">' + m.label + '</div>' +
            '<div style="font-size:10px;color:var(--text-muted)">' + m.trips + ' trips</div></div></div>';
        }).join('') +
        '</div></div>' +
        
        //  QUARTERLY SECTION 
        '<div style="margin-bottom:28px">' +
        '<div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">' +
        '<span style="font-size:18px"></span>' +
        '<h4 style="margin:0;color:var(--text-primary);font-weight:600">Quarterly Comparison</h4>' +
        '<div style="margin-left:auto;display:flex;gap:12px;font-size:11px">' +
        '<span style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:12px;background:var(--purple);border-radius:2px"></span> ' + currentYear + '</span>' +
        '<span style="display:flex;align-items:center;gap:4px"><span style="width:12px;height:12px;background:var(--border);border-radius:2px"></span> ' + (currentYear - 1) + '</span>' +
        '</div></div>' +
        '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px">' +
        quarterlyData.map((q, i) => {
          const isCurrentQuarter = (i + 1) === currentQuarter;
          const currentBarHeight = maxQuarterlyCars > 0 ? (q.current.cars / maxQuarterlyCars * 70) : 0;
          const lastYearBarHeight = maxQuarterlyCars > 0 ? (q.lastYear.cars / maxQuarterlyCars * 70) : 0;
          const qChange = q.lastYear.cars > 0 ? ((q.current.cars - q.lastYear.cars) / q.lastYear.cars * 100) : 0;
          return '<div style="background:' + (isCurrentQuarter ? 'var(--purple-dim)' : 'var(--bg-app)') + ';border-radius:var(--radius-lg);padding:var(--spacing-4);border:2px solid ' + (isCurrentQuarter ? 'var(--purple-dim)' : 'var(--border)') + '">' +
            '<div style="text-align:center;margin-bottom:12px">' +
            '<div style="font-size:16px;font-weight:700;color:' + (isCurrentQuarter ? 'var(--purple)' : 'var(--bg-elevated)') + '">' + q.label + (isCurrentQuarter ? ' ' : '') + '</div></div>' +
            '<div style="display:flex;justify-content:center;gap:8px;height:90px;align-items:flex-end">' +
            '<div style="display:flex;flex-direction:column;align-items:center">' +
            '<div style="font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:2px">' + q.lastYear.cars + '</div>' +
            '<div style="width:28px;height:' + lastYearBarHeight + 'px;background:var(--border);border-radius:4px 4px 0 0;min-height:4px"></div></div>' +
            '<div style="display:flex;flex-direction:column;align-items:center">' +
            '<div style="font-size:12px;font-weight:700;color:var(--purple);margin-bottom:2px">' + q.current.cars + '</div>' +
            '<div style="width:28px;height:' + currentBarHeight + 'px;background:linear-gradient(180deg,var(--purple),var(--purple));border-radius:4px 4px 0 0;min-height:4px"></div></div></div>' +
            '<div style="text-align:center;margin-top:8px;font-size:11px;color:' + (qChange >= 0 ? 'var(--green)' : 'var(--red)') + ';font-weight:600">' +
            (q.current.cars > 0 || q.lastYear.cars > 0 ? ((qChange >= 0 ? '' : '') + ' ' + Math.abs(qChange).toFixed(0) + '% YoY') : '-') + '</div>' +
            '</div>';
        }).join('') +
        '</div></div>' +
        
        //  YEARLY SECTION 
        '<div>' +
        '<div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">' +
        '<span style="font-size:18px"></span>' +
        '<h4 style="margin:0;color:var(--text-primary);font-weight:600">Annual Volume</h4>' +
        '<span style="margin-left:auto;font-size:12px;color:' + (yearlyChange >= 0 ? 'var(--green)' : 'var(--red)') + ';font-weight:600;background:' + (yearlyChange >= 0 ? 'var(--green-dim)' : 'var(--red-dim)') + ';padding:4px 10px;border-radius:12px">' +
        (yearlyChange >= 0 ? '' : '') + ' ' + Math.abs(yearlyChange).toFixed(1) + '% YoY</span>' +
        '</div>' +
        '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">' +
        yearlyData.map((y, i) => {
          const isCurrentYear = y.year === currentYear;
          const barWidth = maxYearlyCars > 0 ? (y.cars / maxYearlyCars * 100) : 0;
          return '<div style="background:' + (isCurrentYear ? 'linear-gradient(135deg,var(--purple-dim),var(--purple-dim))' : 'var(--bg-app)') + ';border-radius:12px;padding:20px;border:2px solid ' + (isCurrentYear ? 'var(--purple-dim)' : 'var(--border)') + '">' +
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">' +
            '<div style="font-size:20px;font-weight:800;color:' + (isCurrentYear ? 'var(--purple)' : 'var(--bg-elevated)') + '">' + y.year + '</div>' +
            '<div style="font-size:var(--text-xs);color:var(--text-muted)">' + y.trips + ' trips</div></div>' +
            '<div style="height:16px;background:var(--border);border-radius:8px;overflow:hidden;margin-bottom:8px">' +
            '<div style="height:100%;width:' + barWidth + '%;background:' + (isCurrentYear ? 'linear-gradient(90deg,var(--purple),var(--purple))' : 'linear-gradient(90deg,var(--text-muted),var(--text-secondary))') + ';border-radius:8px"></div></div>' +
            '<div style="font-size:28px;font-weight:800;color:' + (isCurrentYear ? 'var(--purple)' : 'var(--text-secondary)') + ';text-align:center">' + y.cars.toLocaleString() + ' <span style="font-size:14px;font-weight:500">cars</span></div>' +
            '</div>';
        }).join('') +
        '</div></div>' +
        
        '</div></div>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:24px">' +
        
        '<div class="fin-metric-card" style="background:var(--bg-card);border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid var(--border);text-align:center;transition:all 0.2s;cursor:pointer" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.15)\'" onmouseout="this.style.transform=\'none\';this.style.boxShadow=\'0 1px 3px rgba(0,0,0,0.1)\'">' +
        '<div style="width:48px;height:48px;background:var(--blue-dim);border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:24px"></div>' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Avg Price/Car</div>' +
        '<div style="font-size:22px;font-weight:700;color:var(--text-primary)">' + formatMoney(allTimeAvgPPC) + '</div>' +
        '</div>' +
        
        '<div class="fin-metric-card" style="background:var(--bg-card);border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid var(--border);text-align:center;transition:all 0.2s;cursor:pointer" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.15)\'" onmouseout="this.style.transform=\'none\';this.style.boxShadow=\'0 1px 3px rgba(0,0,0,0.1)\'">' +
        '<div style="width:48px;height:48px;background:var(--green-dim);border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:24px"></div>' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Avg Price/Mile</div>' +
        '<div style="font-size:22px;font-weight:700;color:var(--text-primary)">' + formatMoney(allTimeAvgPPM) + '</div>' +
        '</div>' +
        
        '<div class="fin-metric-card" style="background:var(--bg-card);border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid var(--border);text-align:center;transition:all 0.2s;cursor:pointer" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.15)\'" onmouseout="this.style.transform=\'none\';this.style.boxShadow=\'0 1px 3px rgba(0,0,0,0.1)\'">' +
        '<div style="width:48px;height:48px;background:var(--amber-dim);border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:24px"></div>' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Cars/Trip</div>' +
        '<div style="font-size:22px;font-weight:700;color:var(--text-primary)">' + allTimeAvgCarsPerTrip.toFixed(1) + '</div>' +
        '</div>' +
        
        '<div class="fin-metric-card" style="background:var(--bg-card);border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid var(--border);text-align:center;transition:all 0.2s;cursor:pointer" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.15)\'" onmouseout="this.style.transform=\'none\';this.style.boxShadow=\'0 1px 3px rgba(0,0,0,0.1)\'">' +
        '<div style="width:48px;height:48px;background:var(--purple-dim);border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:24px"></div>' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Miles/Trip</div>' +
        '<div style="font-size:22px;font-weight:700;color:var(--text-primary)">' + allTimeAvgMilesPerTrip.toFixed(0) + '</div>' +
        '</div>' +
        
        '<div class="fin-metric-card" style="background:var(--bg-card);border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid var(--border);text-align:center;transition:all 0.2s;cursor:pointer" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.15)\'" onmouseout="this.style.transform=\'none\';this.style.boxShadow=\'0 1px 3px rgba(0,0,0,0.1)\'">' +
        '<div style="width:48px;height:48px;background:var(--red-dim);border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:24px"></div>' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Fuel/Mile</div>' +
        '<div style="font-size:22px;font-weight:700;color:var(--text-primary)">' + formatMoney(allTimeAvgFuelPerMile) + '</div>' +
        '</div>' +
        
        '<div class="fin-metric-card" style="background:var(--bg-card);border-radius:12px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);border:1px solid var(--border);text-align:center;transition:all 0.2s;cursor:pointer" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.15)\'" onmouseout="this.style.transform=\'none\';this.style.boxShadow=\'0 1px 3px rgba(0,0,0,0.1)\'">' +
        '<div style="width:48px;height:48px;background:var(--red-dim);border-radius:12px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;font-size:24px"></div>' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Expense/Trip</div>' +
        '<div style="font-size:22px;font-weight:700;color:var(--text-primary)">' + formatMoney(allTimeAvgExpensePerTrip) + '</div>' +
        '</div>' +
        '</div>' +
        
        // ============ PERIOD SELECTOR - MODERNIZED ============
        '<div class="card" style="padding:20px;margin-bottom:24px;background:linear-gradient(90deg,var(--bg-app),var(--bg-card-hover))">' +
        '<div style="display:flex;gap:20px;align-items:center;flex-wrap:wrap">' +
        '<div style="display:flex;align-items:center;gap:8px">' +
        '<span style="font-size:20px"></span>' +
        '<span style="font-weight:600;color:var(--bg-elevated)">Select Period:</span>' +
        '</div>' +
        '<div style="display:flex;gap:8px;background:var(--bg-card);padding:4px;border-radius:8px;border:1px solid var(--border)">' +
        '<button onclick="finPeriodType=\'month\';renderFinancialAnalysis(document.getElementById(\'main-content\'))" style="padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.2s;' + (finPeriodType === 'month' ? 'background:var(--blue);color:white' : 'background:transparent;color:var(--text-muted)') + '">Monthly</button>' +
        '<button onclick="finPeriodType=\'quarter\';renderFinancialAnalysis(document.getElementById(\'main-content\'))" style="padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.2s;' + (finPeriodType === 'quarter' ? 'background:var(--blue);color:white' : 'background:transparent;color:var(--text-muted)') + '">Quarterly</button>' +
        '<button onclick="finPeriodType=\'year\';renderFinancialAnalysis(document.getElementById(\'main-content\'))" style="padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.2s;' + (finPeriodType === 'year' ? 'background:var(--blue);color:white' : 'background:transparent;color:var(--text-muted)') + '">Yearly</button>' +
        '</div>' +
        '<select id="finYear" onchange="finYear=parseInt(this.value);renderFinancialAnalysis(document.getElementById(\'main-content\'))" style="padding:10px 16px;border:1px solid var(--border);border-radius:8px;background:var(--bg-card);font-weight:500"><option value="2024"' + (finYear === 2024 ? ' selected' : '') + '>2024</option><option value="2025"' + (finYear === 2025 ? ' selected' : '') + '>2025</option><option value="2026"' + (finYear === 2026 ? ' selected' : '') + '>2026</option><option value="2027"' + (finYear === 2027 ? ' selected' : '') + '>2027</option></select>' +
        (finPeriodType === 'month' ? '<select id="finMonth" onchange="finMonth=parseInt(this.value);renderFinancialAnalysis(document.getElementById(\'main-content\'))" style="padding:10px 16px;border:1px solid var(--border);border-radius:8px;background:var(--bg-card);font-weight:500">' + months.slice(1).map((m, i) => '<option value="' + (i+1) + '"' + (finMonth === i+1 ? ' selected' : '') + '>' + m + '</option>').join('') + '</select>' : '') +
        (finPeriodType === 'quarter' ? '<select id="finQuarter" onchange="finQuarter=parseInt(this.value);renderFinancialAnalysis(document.getElementById(\'main-content\'))" style="padding:10px 16px;border:1px solid var(--border);border-radius:8px;background:var(--bg-card);font-weight:500"><option value="1"' + (finQuarter === 1 ? ' selected' : '') + '>Q1 (Jan-Mar)</option><option value="2"' + (finQuarter === 2 ? ' selected' : '') + '>Q2 (Apr-Jun)</option><option value="3"' + (finQuarter === 3 ? ' selected' : '') + '>Q3 (Jul-Sep)</option><option value="4"' + (finQuarter === 4 ? ' selected' : '') + '>Q4 (Oct-Dec)</option></select>' : '') +
        '<div style="margin-left:auto;background:var(--bg-elevated);color:white;padding:10px 20px;border-radius:8px;font-weight:700">' + periodLabel + '</div>' +
        '</div></div>' +
        
        // ============ PERIOD PERFORMANCE DASHBOARD ============
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:24px;margin-bottom:24px">' +
        
        // Left: Revenue & Profit Visual
        '<div class="card" style="padding:0;overflow:hidden">' +
        '<div style="background:var(--blue);color:white;padding:16px 20px;font-weight:700;display:flex;align-items:center;gap:10px"><span style="font-size:20px"></span> Revenue & Profit - ' + periodLabel + '</div>' +
        '<div style="padding:24px">' +
        
        // Revenue Bar
        '<div style="margin-bottom:20px">' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="font-weight:600;color:var(--bg-elevated)">Gross Revenue</span><span style="font-weight:700;color:var(--blue)">' + formatMoney(loadRevenue) + '</span></div>' +
        '<div style="height:12px;background:var(--border);border-radius:6px;overflow:hidden"><div style="height:100%;width:100%;background:linear-gradient(90deg,var(--blue),var(--blue));border-radius:6px"></div></div>' +
        '</div>' +
        
        // Clean Gross Bar
        '<div style="margin-bottom:20px">' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="font-weight:600;color:var(--bg-elevated)">Clean Gross <span style="font-weight:400;color:var(--text-muted)">(- fees)</span></span><span style="font-weight:700;color:var(--green)">' + formatMoney(cleanGross) + '</span></div>' +
        '<div style="height:12px;background:var(--border);border-radius:6px;overflow:hidden"><div style="height:100%;width:' + (loadRevenue > 0 ? (cleanGross/loadRevenue*100) : 0) + '%;background:linear-gradient(90deg,var(--green),var(--green));border-radius:6px"></div></div>' +
        '</div>' +
        
        // Trip Net Profit Bar
        '<div style="margin-bottom:20px">' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="font-weight:600;color:var(--bg-elevated)">Trip Net Profit</span><span style="font-weight:700;color:' + (netProfit >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(netProfit) + '</span></div>' +
        '<div style="height:12px;background:var(--border);border-radius:6px;overflow:hidden"><div style="height:100%;width:' + (loadRevenue > 0 ? Math.max(0, netProfit/loadRevenue*100) : 0) + '%;background:linear-gradient(90deg,' + (netProfit >= 0 ? 'var(--green),var(--green)' : 'var(--red),var(--red)') + ');border-radius:6px"></div></div>' +
        '</div>' +
        
        // Final Net Profit
        '<div style="background:' + (netProfitBeforeTax >= 0 ? 'var(--green-dim)' : 'var(--red-dim)') + ';padding:16px;border-radius:12px;margin-top:16px">' +
        '<div style="display:flex;justify-content:space-between;align-items:center">' +
        '<div><div style="font-size:13px;color:var(--text-muted);margin-bottom:4px">Net Profit Before Tax</div><div style="font-size:var(--text-xs);color:var(--text-muted)">(After fixed costs)</div></div>' +
        '<div style="font-size:28px;font-weight:800;color:' + (netProfitBeforeTax >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(netProfitBeforeTax) + '</div>' +
        '</div>' +
        '</div>' +
        '</div></div>' +
        
        // Right: Operational Volume
        '<div class="card" style="padding:0;overflow:hidden">' +
        '<div style="background:var(--green);color:white;padding:16px 20px;font-weight:700;display:flex;align-items:center;gap:10px"><span style="font-size:20px"></span> Operations - ' + periodLabel + '</div>' +
        '<div style="padding:24px">' +
        '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px">' +
        
        '<div style="background:var(--bg-app);padding:16px;border-radius:12px;text-align:center;border:1px solid var(--border)">' +
        '<div style="font-size:32px;font-weight:800;color:var(--text-primary)">' + numTrucks + '</div>' +
        '<div style="font-size:12px;color:var(--text-muted);margin-top:4px">Active Trucks</div>' +
        '</div>' +
        
        '<div style="background:var(--bg-app);padding:16px;border-radius:12px;text-align:center;border:1px solid var(--border)">' +
        '<div style="font-size:32px;font-weight:800;color:var(--text-primary)">' + tripCount + '</div>' +
        '<div style="font-size:12px;color:var(--text-muted);margin-top:4px">Trips Completed</div>' +
        '</div>' +
        
        '<div style="background:var(--bg-app);padding:16px;border-radius:12px;text-align:center;border:1px solid var(--border)">' +
        '<div style="font-size:32px;font-weight:800;color:var(--text-primary)">' + totalCars + '</div>' +
        '<div style="font-size:12px;color:var(--text-muted);margin-top:4px">Cars Hauled</div>' +
        '</div>' +
        
        '<div style="background:var(--bg-app);padding:16px;border-radius:12px;text-align:center;border:1px solid var(--border)">' +
        '<div style="font-size:32px;font-weight:800;color:var(--text-primary)">' + totalMiles.toLocaleString() + '</div>' +
        '<div style="font-size:12px;color:var(--text-muted);margin-top:4px">Miles Traveled</div>' +
        '</div>' +
        '</div>' +
        
        // Per Unit Metrics
        '<div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border)">' +
        '<div style="font-weight:600;color:var(--bg-elevated);margin-bottom:12px">Per-Unit Performance</div>' +
        '<div style="display:flex;flex-direction:column;gap:8px">' +
        '<div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-card-hover);border-radius:6px"><span style="color:var(--text-muted)">Avg Revenue/Trip</span><span style="font-weight:600">' + formatMoney(avgRevPerTrip) + '</span></div>' +
        '<div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-card-hover);border-radius:6px"><span style="color:var(--text-muted)">Avg Price/Car</span><span style="font-weight:600">' + formatMoney(avgPricePerCar) + '</span></div>' +
        '<div style="display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-card-hover);border-radius:6px"><span style="color:var(--text-muted)">Revenue/Mile</span><span style="font-weight:600">' + formatMoney(revenuePerMile) + '</span></div>' +
        '<div style="display:flex;justify-content:space-between;padding:8px 12px;background:' + (netProfitPerTrip >= 0 ? 'var(--green-dim)' : 'var(--red-dim)') + ';border-radius:6px"><span style="color:var(--text-muted)">Net Profit/Trip</span><span style="font-weight:700;color:' + (netProfitPerTrip >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(netProfitPerTrip) + '</span></div>' +
        '</div>' +
        '</div>' +
        '</div></div>' +
        '</div>' +
        
        // ============ EXPENSE BREAKDOWN VISUAL ============
        '<div class="card" style="padding:0;overflow:hidden;margin-bottom:24px">' +
        '<div style="background:var(--red);color:white;padding:16px 20px;font-weight:700;display:flex;align-items:center;gap:10px"><span style="font-size:20px"></span> Expense Breakdown - ' + periodLabel + '</div>' +
        '<div style="padding:24px">' +
        
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px">' +
        
        // Broker Fees
        '<div style="position:relative;background:var(--red-dim);border-radius:var(--radius-lg);padding:var(--spacing-4);border-left:4px solid var(--red)">' +
        '<div style="font-size:var(--text-xs);color:var(--red);text-transform:uppercase;margin-bottom:4px">Broker Fees</div>' +
        '<div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--red)">' + formatMoney(brokerFees) + '</div>' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted);margin-top:4px">' + (loadRevenue > 0 ? (brokerFees/loadRevenue*100).toFixed(1) : 0) + '% of revenue</div>' +
        '</div>' +
        
        // Local Fees
        '<div style="position:relative;background:var(--amber-dim);border-radius:var(--radius-lg);padding:var(--spacing-4);border-left:4px solid var(--amber)">' +
        '<div style="font-size:12px;color:var(--amber);text-transform:uppercase;margin-bottom:4px">Local Fees</div>' +
        '<div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--amber)">' + formatMoney(localFees) + '</div>' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted);margin-top:4px">' + (loadRevenue > 0 ? (localFees/loadRevenue*100).toFixed(1) : 0) + '% of revenue</div>' +
        '</div>' +
        
        // Driver Cut
        '<div style="position:relative;background:var(--purple-dim);border-radius:var(--radius-lg);padding:var(--spacing-4);border-left:4px solid var(--purple)">' +
        '<div style="font-size:12px;color:var(--purple);text-transform:uppercase;margin-bottom:4px">Driver Cut (' + avgDriverCutPercent.toFixed(0) + '%)</div>' +
        '<div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--purple)">' + formatMoney(driverCut) + '</div>' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted);margin-top:4px">' + (loadRevenue > 0 ? (driverCut/loadRevenue*100).toFixed(1) : 0) + '% of revenue</div>' +
        '</div>' +
        
        // Trip Expenses
        '<div style="position:relative;background:var(--green-dim);border-radius:var(--radius-lg);padding:var(--spacing-4);border-left:4px solid var(--green)">' +
        '<div style="font-size:var(--text-xs);color:var(--green);text-transform:uppercase;margin-bottom:4px">Trip Expenses</div>' +
        '<div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--green)">' + formatMoney(tripExpenses) + '</div>' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted);margin-top:4px">Fuel, tolls, etc.</div>' +
        '</div>' +
        '</div>' +
        
        // Detailed Expense Grid
        '<div style="background:var(--bg-app);border-radius:12px;padding:20px">' +
        '<div style="font-weight:600;color:var(--bg-elevated);margin-bottom:16px">Expense Details</div>' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px">' +
        '<div style="background:var(--bg-card);padding:var(--spacing-3);border-radius:var(--radius);text-align:center;border:1px solid var(--border)"><div style="font-size:20px;margin-bottom:4px"></div><div style="font-size:var(--text-xs);color:var(--text-muted)">Fuel</div><div style="font-weight:700;color:var(--text-primary)">' + formatMoney(fuelCosts.FUEL) + '</div></div>' +
        '<div style="background:var(--bg-card);padding:var(--spacing-3);border-radius:var(--radius);text-align:center;border:1px solid var(--border)"><div style="font-size:20px;margin-bottom:4px"></div><div style="font-size:var(--text-xs);color:var(--text-muted)">Tolls</div><div style="font-weight:700;color:var(--text-primary)">' + formatMoney(fuelCosts.TOLLS) + '</div></div>' +
        '<div style="background:var(--bg-card);padding:var(--spacing-3);border-radius:var(--radius);text-align:center;border:1px solid var(--border)"><div style="font-size:20px;margin-bottom:4px"></div><div style="font-size:var(--text-xs);color:var(--text-muted)">Permits</div><div style="font-weight:700;color:var(--text-primary)">' + formatMoney(fuelCosts.PERMITS) + '</div></div>' +
        '<div style="background:var(--bg-card);padding:var(--spacing-3);border-radius:var(--radius);text-align:center;border:1px solid var(--border)"><div style="font-size:20px;margin-bottom:4px"></div><div style="font-size:var(--text-xs);color:var(--text-muted)">Parking</div><div style="font-weight:700;color:var(--text-primary)">' + formatMoney(fuelCosts.PARKING) + '</div></div>' +
        '<div style="background:var(--bg-card);padding:var(--spacing-3);border-radius:var(--radius);text-align:center;border:1px solid var(--border)"><div style="font-size:20px;margin-bottom:4px"></div><div style="font-size:var(--text-xs);color:var(--text-muted)">Maintenance</div><div style="font-weight:700;color:var(--text-primary)">' + formatMoney(fuelCosts.MAINTENANCE) + '</div></div>' +
        '<div style="background:var(--bg-card);padding:var(--spacing-3);border-radius:var(--radius);text-align:center;border:1px solid var(--border)"><div style="font-size:20px;margin-bottom:4px"></div><div style="font-size:var(--text-xs);color:var(--text-muted)">Other</div><div style="font-weight:700;color:var(--text-primary)">' + formatMoney(fuelCosts.OTHER) + '</div></div>' +
        '</div>' +
        '</div>' +
        
        // Totals Row
        '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:20px">' +
        '<div style="background:var(--red-dim);padding:16px;border-radius:12px;text-align:center"><div style="font-size:var(--text-xs);color:var(--red);margin-bottom:4px">Total Direct Trip Expenses</div><div style="font-size:22px;font-weight:800;color:var(--red)">' + formatMoney(directTripExpenses) + '</div></div>' +
        '<div style="background:var(--amber-dim);padding:16px;border-radius:12px;text-align:center"><div style="font-size:12px;color:var(--amber);margin-bottom:4px">Fixed Costs (' + periodMonths + ' mo)</div><div style="font-size:22px;font-weight:800;color:var(--amber)">' + formatMoney(totalFixedCosts) + '</div></div>' +
        '<div style="background:var(--bg-elevated);padding:16px;border-radius:12px;text-align:center"><div style="font-size:12px;color:var(--text-secondary);margin-bottom:4px">Total Operating Expenses</div><div style="font-size:22px;font-weight:800;color:var(--text-primary)">' + formatMoney(totalOperatingExpenses) + '</div></div>' +
        '</div>' +
        '</div></div>' +
        
        // ============ PROFIT MARGINS & FIXED COSTS ============
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:24px;margin-bottom:24px">' +
        
        // Profit Margins Visual
        '<div class="card" style="padding:24px">' +
        '<div style="font-weight:700;font-size:18px;color:var(--text-primary);margin-bottom:20px;display:flex;align-items:center;gap:10px"><span style="font-size:24px"></span> Profit Margins</div>' +
        '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:24px">' +
        
        // Trip Profit Margin Gauge
        '<div style="text-align:center">' +
        '<div style="position:relative;width:140px;height:70px;margin:0 auto 16px;overflow:hidden">' +
        '<div style="position:absolute;width:140px;height:140px;border-radius:50%;background:conic-gradient(' + (grossProfitMargin >= 0 ? 'var(--green)' : 'var(--red)') + ' 0deg ' + (Math.min(Math.abs(grossProfitMargin), 100) * 1.8) + 'deg, var(--bg-elevated) ' + (Math.min(Math.abs(grossProfitMargin), 100) * 1.8) + 'deg 180deg, transparent 180deg 360deg)"></div>' +
        '<div style="position:absolute;top:10px;left:10px;width:120px;height:120px;border-radius:50%;background:var(--bg-card);display:flex;align-items:center;justify-content:center;padding-top:35px">' +
        '<span style="font-size:24px;font-weight:800;color:' + (grossProfitMargin >= 0 ? 'var(--green)' : 'var(--red)') + '">' + grossProfitMargin.toFixed(1) + '%</span>' +
        '</div></div>' +
        '<div style="font-weight:600;color:var(--bg-elevated)">Trip Profit Margin</div>' +
        '<div style="font-size:12px;color:var(--text-muted)">Revenue to trip profit</div>' +
        '</div>' +
        
        // Net Profit Margin Gauge
        '<div style="text-align:center">' +
        '<div style="position:relative;width:140px;height:70px;margin:0 auto 16px;overflow:hidden">' +
        '<div style="position:absolute;width:140px;height:140px;border-radius:50%;background:conic-gradient(' + (netProfitMargin >= 0 ? 'var(--blue)' : 'var(--red)') + ' 0deg ' + (Math.min(Math.abs(netProfitMargin), 100) * 1.8) + 'deg, var(--bg-elevated) ' + (Math.min(Math.abs(netProfitMargin), 100) * 1.8) + 'deg 180deg, transparent 180deg 360deg)"></div>' +
        '<div style="position:absolute;top:10px;left:10px;width:120px;height:120px;border-radius:50%;background:var(--bg-card);display:flex;align-items:center;justify-content:center;padding-top:35px">' +
        '<span style="font-size:24px;font-weight:800;color:' + (netProfitMargin >= 0 ? 'var(--blue)' : 'var(--red)') + '">' + netProfitMargin.toFixed(1) + '%</span>' +
        '</div></div>' +
        '<div style="font-weight:600;color:var(--bg-elevated)">Net Profit Margin</div>' +
        '<div style="font-size:12px;color:var(--text-muted)">After all expenses</div>' +
        '</div>' +
        '</div></div>' +
        
        //  NEW: EFFICIENCY RATIOS & PER-MILE ANALYSIS 
        '<div class="card" style="padding:0;overflow:hidden;margin-bottom:24px">' +
        '<div style="background:linear-gradient(90deg,var(--blue),var(--blue));color:white;padding:16px 20px;font-weight:700;display:flex;align-items:center;gap:10px"><span style="font-size:20px"></span> Efficiency & Per-Mile Analysis</div>' +
        '<div style="padding:24px">' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:20px">' +
        
        // Cost Per Mile
        '<div style="background:var(--green-dim);padding:16px;border-radius:12px;text-align:center;border:1px solid var(--green-dim)">' +
        '<div style="font-size:11px;color:var(--green);text-transform:uppercase;margin-bottom:4px">Total Cost/Mile</div>' +
        '<div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--green)">' + formatMoney(totalCostPerMile) + '</div>' +
        '</div>' +
        
        // Direct Cost Per Mile
        '<div style="background:var(--red-dim);padding:16px;border-radius:12px;text-align:center;border:1px solid var(--red-dim)">' +
        '<div style="font-size:11px;color:var(--red);text-transform:uppercase;margin-bottom:4px">Direct Cost/Mile</div>' +
        '<div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--red)">' + formatMoney(directCostPerMile) + '</div>' +
        '</div>' +
        
        // Revenue Per Mile
        '<div style="background:var(--green-dim);padding:16px;border-radius:12px;text-align:center;border:1px solid var(--green-dim)">' +
        '<div style="font-size:11px;color:var(--green);text-transform:uppercase;margin-bottom:4px">Revenue/Mile</div>' +
        '<div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--green)">' + formatMoney(revenuePerMile) + '</div>' +
        '</div>' +
        
        // Profit Per Mile
        '<div style="background:' + (netProfitPerMile >= 0 ? 'var(--green-dim)' : 'var(--red-dim)') + ';padding:16px;border-radius:12px;text-align:center;border:1px solid ' + (netProfitPerMile >= 0 ? 'var(--green)' : 'var(--red-dim)') + '">' +
        '<div style="font-size:11px;color:' + (netProfitPerMile >= 0 ? 'var(--green)' : 'var(--red)') + ';text-transform:uppercase;margin-bottom:4px">Profit/Mile</div>' +
        '<div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:' + (netProfitPerMile >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(netProfitPerMile) + '</div>' +
        '</div>' +
        
        // Fuel CPM
        '<div style="background:var(--amber-dim);padding:16px;border-radius:12px;text-align:center;border:1px solid var(--amber-dim)">' +
        '<div style="font-size:11px;color:var(--amber);text-transform:uppercase;margin-bottom:4px">Fuel Cost/Mile</div>' +
        '<div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--amber)">' + formatMoney(fuelCostPerMile) + '</div>' +
        '</div>' +
        
        // Profit Per Car
        '<div style="background:' + (netProfitPerTrip >= 0 ? 'var(--green-dim)' : 'var(--red-dim)') + ';padding:16px;border-radius:12px;text-align:center;border:1px solid ' + (netProfitPerTrip >= 0 ? 'var(--green-dim)' : 'var(--red-dim)') + '">' +
        '<div style="font-size:11px;color:' + (netProfitPerTrip >= 0 ? 'var(--green)' : 'var(--red)') + ';text-transform:uppercase;margin-bottom:4px">Profit/Trip</div>' +
        '<div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:' + (netProfitPerTrip >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(netProfitPerTrip) + '</div>' +
        '</div>' +
        '</div>' +
        
        // Efficiency Ratios
        '<div style="background:var(--bg-app);padding:16px;border-radius:12px">' +
        '<div style="font-weight:600;color:var(--bg-elevated);margin-bottom:12px">Expense Ratios (% of Revenue)</div>' +
        '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">' +
        '<div style="text-align:center"><div style="font-size:var(--text-xs);color:var(--text-muted)">Fuel</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:' + (fuelToRevenueRatio <= 15 ? 'var(--green)' : fuelToRevenueRatio <= 25 ? 'var(--amber)' : 'var(--red)') + '">' + fuelToRevenueRatio.toFixed(1) + '%</div></div>' +
        '<div style="text-align:center"><div style="font-size:var(--text-xs);color:var(--text-muted)">Fees (Broker+Local)</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:' + (feeBurdenRatio <= 10 ? 'var(--green)' : feeBurdenRatio <= 15 ? 'var(--amber)' : 'var(--red)') + '">' + feeBurdenRatio.toFixed(1) + '%</div></div>' +
        '<div style="text-align:center"><div style="font-size:var(--text-xs);color:var(--text-muted)">Driver Cut</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--purple)">' + driverCutRatioDisplay.toFixed(1) + '%</div></div>' +
        '<div style="text-align:center"><div style="font-size:var(--text-xs);color:var(--text-muted)">Trip Expenses</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:' + (expenseRatio <= 10 ? 'var(--green)' : expenseRatio <= 20 ? 'var(--amber)' : 'var(--red)') + '">' + expenseRatio.toFixed(1) + '%</div></div>' +
        '</div></div>' +
        '</div></div>' +
        
        //  NEW: BREAK-EVEN ANALYSIS 
        '<div class="card" style="padding:0;overflow:hidden;margin-bottom:24px">' +
        '<div style="background:linear-gradient(90deg,var(--purple),var(--purple));color:white;padding:16px 20px;font-weight:700;display:flex;align-items:center;gap:10px"><span style="font-size:20px"></span> Break-Even Analysis</div>' +
        '<div style="padding:24px">' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px">' +
        
        '<div style="background:var(--purple-dim);padding:20px;border-radius:12px;text-align:center;border-left:4px solid var(--purple)">' +
        '<div style="font-size:12px;color:var(--purple);margin-bottom:4px">Break-Even PPC</div>' +
        '<div style="font-size:28px;font-weight:800;color:var(--purple)">' + formatMoney(breakEvenPPC) + '</div>' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted);margin-top:4px">Min price per car needed</div>' +
        '</div>' +
        
        '<div style="background:var(--purple-dim);padding:20px;border-radius:12px;text-align:center;border-left:4px solid var(--purple)">' +
        '<div style="font-size:12px;color:var(--purple);margin-bottom:4px">Break-Even Cars/Month</div>' +
        '<div style="font-size:28px;font-weight:800;color:var(--purple)">' + breakEvenCarsPerMonth + '</div>' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted);margin-top:4px">To cover fixed costs</div>' +
        '</div>' +
        
        '<div style="background:var(--purple-dim);padding:20px;border-radius:12px;text-align:center;border-left:4px solid var(--purple)">' +
        '<div style="font-size:12px;color:var(--purple);margin-bottom:4px">Break-Even Revenue/Mo</div>' +
        '<div style="font-size:28px;font-weight:800;color:var(--purple)">' + formatMoney(breakEvenRevenuePerMonth) + '</div>' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted);margin-top:4px">Monthly target</div>' +
        '</div>' +
        
        '<div style="background:' + (marginOfSafety >= 20 ? 'var(--green-dim)' : marginOfSafety >= 0 ? 'var(--amber-dim)' : 'var(--red-dim)') + ';padding:20px;border-radius:12px;text-align:center;border-left:4px solid ' + (marginOfSafety >= 20 ? 'var(--green)' : marginOfSafety >= 0 ? 'var(--amber)' : 'var(--red)') + '">' +
        '<div style="font-size:12px;color:' + (marginOfSafety >= 20 ? 'var(--green)' : marginOfSafety >= 0 ? 'var(--amber)' : 'var(--red)') + ';margin-bottom:4px">Margin of Safety</div>' +
        '<div style="font-size:28px;font-weight:800;color:' + (marginOfSafety >= 20 ? 'var(--green)' : marginOfSafety >= 0 ? 'var(--amber)' : 'var(--red)') + '">' + marginOfSafety.toFixed(1) + '%</div>' +
        '<div style="font-size:var(--text-xs);color:var(--text-muted);margin-top:4px">' + (marginOfSafety >= 20 ? ' Healthy buffer' : marginOfSafety >= 0 ? ' Tight margin' : ' Below break-even') + '</div>' +
        '</div>' +
        '</div>' +
        
        (totalVariableCosts > 0 || fuelTransactionsCost > 0 ? 
        '<div style="margin-top:16px;padding:12px;background:var(--amber-dim);border-radius:8px;border:1px solid var(--amber)">' +
        '<div style="font-size:12px;color:var(--amber)"><strong> Additional Costs (not in trip expenses):</strong> Variable Costs: ' + formatMoney(totalVariableCosts) + ' | Fuel Transactions: ' + formatMoney(fuelTransactionsCost) + '</div>' +
        '</div>' : '') +
        '</div></div>' +
        '</div>' +
        
        // Fixed Costs Breakdown
        '<div class="card" style="padding:0;overflow:hidden">' +
        '<div style="background:var(--amber);color:white;padding:16px 20px;font-weight:700;display:flex;align-items:center;gap:10px"><span style="font-size:20px"></span> Fixed Costs - ' + formatMoney(totalFixedCosts) + '</div>' +
        '<div style="padding:20px;max-height:280px;overflow-y:auto">' +
        '<div style="display:grid;gap:8px">' +
        ((appData.fixed_costs || []).length === 0 ? '<div style="text-align:center;padding:20px;color:var(--text-muted)">No fixed costs configured</div>' :
        (appData.fixed_costs || []).map(fc => 
          '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--bg-app);border-radius:8px;border-left:3px solid var(--amber)">' +
          '<div><span style="font-weight:600;color:var(--text-primary)">' + fc.name + '</span><span style="margin-left:8px;font-size:var(--text-xs);color:var(--text-muted);background:var(--border);padding:2px 8px;border-radius:4px">' + (fc.category || 'OTHER') + '</span></div>' +
          '<div style="font-weight:700;color:var(--amber)">' + formatMoney(fc.amount * periodMonths) + '</div>' +
          '</div>'
        ).join('')) +
        '</div>' +
        '</div></div>' +
        '</div>';
    }
    
    //  TRIPS TABLE SORTING & FILTERING 
    let tripsSortCol = 'date';
    let tripsSortDir = 'desc';
    
    function filterTripsTable(filter) {
      const rows = document.querySelectorAll('#tripsFinancialTable tbody tr.trip-row');
      rows.forEach(row => {
        const profit = parseFloat(row.dataset.profit || 0);
        if (filter === 'all') row.style.display = '';
        else if (filter === 'profitable') row.style.display = profit >= 0 ? '' : 'none';
        else if (filter === 'losing') row.style.display = profit < 0 ? '' : 'none';
      });
    }
    
    function sortTripsTable(col) {
      if (tripsSortCol === col) tripsSortDir = tripsSortDir === 'asc' ? 'desc' : 'asc';
      else { tripsSortCol = col; tripsSortDir = 'desc'; }
      
      const tbody = document.querySelector('#tripsFinancialTable tbody');
      const rows = Array.from(tbody.querySelectorAll('tr.trip-row'));
      
      rows.sort((a, b) => {
        let aVal, bVal;
        const cells = { a: a.cells, b: b.cells };
        
        switch(col) {
          case 'date': aVal = new Date(cells.a[0].textContent); bVal = new Date(cells.b[0].textContent); break;
          case 'trip': aVal = cells.a[1].textContent; bVal = cells.b[1].textContent; break;
          case 'cars': aVal = parseInt(cells.a[4].textContent) || 0; bVal = parseInt(cells.b[4].textContent) || 0; break;
          case 'miles': aVal = parseInt(cells.a[5].textContent.replace(/,/g,'')) || 0; bVal = parseInt(cells.b[5].textContent.replace(/,/g,'')) || 0; break;
          case 'revenue': aVal = parseFloat(cells.a[6].textContent.replace(/[$,]/g,'')) || 0; bVal = parseFloat(cells.b[6].textContent.replace(/[$,]/g,'')) || 0; break;
          case 'expenses': aVal = parseFloat(cells.a[7].textContent.replace(/[$,]/g,'')) || 0; bVal = parseFloat(cells.b[7].textContent.replace(/[$,]/g,'')) || 0; break;
          case 'profit': aVal = parseFloat(a.dataset.profit) || 0; bVal = parseFloat(b.dataset.profit) || 0; break;
          case 'margin': aVal = parseFloat(cells.a[9].textContent) || 0; bVal = parseFloat(cells.b[9].textContent) || 0; break;
          case 'ppm': aVal = parseFloat(cells.a[10].textContent.replace(/[$,]/g,'')) || 0; bVal = parseFloat(cells.b[10].textContent.replace(/[$,]/g,'')) || 0; break;
          default: aVal = 0; bVal = 0;
        }
        
        if (aVal < bVal) return tripsSortDir === 'asc' ? -1 : 1;
        if (aVal > bVal) return tripsSortDir === 'asc' ? 1 : -1;
        return 0;
      });
      
      rows.forEach(row => tbody.appendChild(row));
    }

    function showTripAnalysis(tripId) {
      if (!tripId) { document.getElementById('tripAnalysisResult').innerHTML = ''; return; }
      
      const trip = appData.trips.find(t => t.id === parseInt(tripId));
      const driver = appData.drivers.find(d => d.id === trip.driver_id);
      const truck = appData.trucks.find(t => t.id === trip.truck_id);
      const orders = appData.orders.filter(o => o.trip_id === parseInt(tripId));
      const expenses = appData.expenses.filter(e => e.trip_id === parseInt(tripId));
      const targetUtil = parseFloat(document.getElementById('targetUtilization').value) || 85;
      
      // Financial calculations
      const loadRevenue = orders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
      const brokerFee = orders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
      const localFee = orders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
      const cleanGross = loadRevenue - brokerFee - localFee;
      const driverCutPercent = trip.driver_cut_percent || 32;
      const driverCut = cleanGross * (driverCutPercent / 100);
      
      // Expense breakdown
      const fuelCosts = { FUEL: 0, TOLLS: 0, PERMITS: 0, PARKING: 0, MAINTENANCE: 0, OTHER: 0 };
      expenses.forEach(e => {
        if (fuelCosts[e.category] !== undefined) fuelCosts[e.category] += parseFloat(e.amount || 0);
        else fuelCosts.OTHER += parseFloat(e.amount || 0);
      });
      const tripExpenses = expenses.reduce((s, e) => s + parseFloat(e.amount || 0), 0);
      
      // Direct Trip Expenses = ALL costs for this trip
      const directTripExpenses = brokerFee + localFee + driverCut + tripExpenses;
      
      // Trip Net Profit = Revenue - All Trip Costs
      const tripNetProfit = loadRevenue - directTripExpenses;
      
      // Cash collected (COD + COP only) - LOCAL_COD goes to local driver, not trip driver
      const cashCollected = orders.filter(o => o.payment_type === 'COD' || o.payment_type === 'COP').reduce((s, o) => {
        // If bill_amount > 0, this is a split payment - use cod_amount instead of revenue
        if (parseFloat(o.bill_amount || 0) > 0) {
          return s + parseFloat(o.cod_amount || 0);
        }
        return s + parseFloat(o.revenue || 0);
      }, 0);
      const expenseReimbursement = fuelCosts.OTHER; // Only OTHER category is reimbursed
      const netPayToDriver = driverCut - cashCollected + expenseReimbursement;
      
      // Miles and metrics
      const miles = parseFloat(trip.miles || 0);
      const totalCars = orders.length;
      const avgPricePerCar = totalCars > 0 ? loadRevenue / totalCars : 0;
      const revenuePerMile = miles > 0 ? loadRevenue / miles : 0;
      const netProfitPerMile = miles > 0 ? tripNetProfit / miles : 0;
      const fuelCostPerMile = miles > 0 ? fuelCosts.FUEL / miles : 0;
      const variableCostPerMile = miles > 0 ? directTripExpenses / miles : 0;
      
      // Utilization calculation (assuming 8-car hauler)
      const maxCapacity = 8;
      const haulerType = '8-Car Hauler';
      const tripUtilization = (totalCars / (maxCapacity * 2)) * 100; // *2 for round trip
      
      // Outbound vs Return (based on vehicle_direction)
      const outboundOrders = orders.filter(o => o.vehicle_direction && (o.vehicle_direction.includes('HOME_TO') || o.vehicle_direction.includes('NY_TO')));
      const returnOrders = orders.filter(o => o.vehicle_direction && (o.vehicle_direction.includes('TO_HOME') || o.vehicle_direction.includes('CA_TO') || o.vehicle_direction.includes('FL_TO')));
      const outboundCount = outboundOrders.length || Math.floor(totalCars / 2);
      const returnCount = returnOrders.length || totalCars - outboundCount;
      const outboundUtil = (outboundCount / maxCapacity) * 100;
      const returnUtil = (returnCount / maxCapacity) * 100;
      
      // Overhead allocation (monthly fixed costs / avg trips per month)
      const monthlyFixedCosts = (appData.fixed_costs || []).reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);
      const avgTripsPerMonth = appData.trips.length > 0 ? Math.max(1, appData.trips.length / 3) : 1;
      const overheadAllocation = monthlyFixedCosts / avgTripsPerMonth;
      const trueNetProfit = tripNetProfit - overheadAllocation;
      const trueNetProfitMargin = loadRevenue > 0 ? (trueNetProfit / loadRevenue) * 100 : 0;
      
      // Operating Ratio (total costs / revenue)
      const operatingRatio = loadRevenue > 0 ? (directTripExpenses / loadRevenue) * 100 : 0;
      
      // Rating
      let utilizationRating = 'Poor';
      let utilizationColor = 'var(--red)';
      if (tripUtilization >= 90) { utilizationRating = 'Excellent'; utilizationColor = 'var(--green)'; }
      else if (tripUtilization >= 80) { utilizationRating = 'Good'; utilizationColor = 'var(--blue)'; }
      else if (tripUtilization >= 70) { utilizationRating = 'Acceptable'; utilizationColor = 'var(--amber)'; }
      
      let overallRating = 'Not Profitable';
      let overallColor = 'var(--red)';
      if (trueNetProfit >= overheadAllocation) { overallRating = 'Highly Profitable'; overallColor = 'var(--green)'; }
      else if (trueNetProfit >= 0) { overallRating = 'Profitable'; overallColor = 'var(--blue)'; }
      else if (trueNetProfit >= -500) { overallRating = 'Break Even'; overallColor = 'var(--amber)'; }
      
      const isAboveTarget = tripNetProfit >= overheadAllocation;
      
      // Build utilization bar
      const utilBar = '<div style="background:var(--bg-elevated);border-radius:4px;height:20px;width:200px;overflow:hidden"><div style="background:' + utilizationColor + ';height:100%;width:' + Math.min(tripUtilization, 100) + '%"></div></div>';
      
      document.getElementById('tripAnalysisResult').innerHTML = 
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">' +
        
        // LEFT COLUMN - Financial Breakdown
        '<div>' +
        '<div style="background:var(--blue);color:white;padding:10px 16px;border-radius:8px 8px 0 0;font-weight:600"> Financial Breakdown</div>' +
        '<div style="border:1px solid var(--bg-elevated);border-top:none;padding:16px;border-radius:0 0 8px 8px">' +
        '<table style="width:100%;font-size:14px">' +
        '<tr><td>Load Revenue</td><td style="text-align:right;font-weight:600">' + formatMoney(loadRevenue) + '</td></tr>' +
        '<tr><td style="padding-left:16px;color:var(--text-muted)">Broker Fee</td><td style="text-align:right;color:var(--red)">(' + formatMoney(brokerFee) + ')</td></tr>' +
        '<tr><td style="padding-left:16px;color:var(--text-muted)">Local Fee</td><td style="text-align:right;color:var(--amber)">(' + formatMoney(localFee) + ')</td></tr>' +
        '<tr><td style="padding-left:16px;color:var(--purple)">Driver\'s Cut (' + driverCutPercent + '%)</td><td style="text-align:right;color:var(--purple)">(' + formatMoney(driverCut) + ')</td></tr>' +
        '<tr><td style="padding-left:16px">Fuel</td><td style="text-align:right">(' + formatMoney(fuelCosts.FUEL) + ')</td></tr>' +
        '<tr><td style="padding-left:16px">Tolls</td><td style="text-align:right">(' + formatMoney(fuelCosts.TOLLS) + ')</td></tr>' +
        '<tr><td style="padding-left:16px">Permits</td><td style="text-align:right">(' + formatMoney(fuelCosts.PERMITS) + ')</td></tr>' +
        '<tr><td style="padding-left:16px">Parking</td><td style="text-align:right">(' + formatMoney(fuelCosts.PARKING) + ')</td></tr>' +
        '<tr><td style="padding-left:16px">Maintenance</td><td style="text-align:right">(' + formatMoney(fuelCosts.MAINTENANCE) + ')</td></tr>' +
        '<tr><td style="padding-left:16px">Other</td><td style="text-align:right">(' + formatMoney(fuelCosts.OTHER) + ')</td></tr>' +
        '<tr style="background:var(--red-dim)"><td style="font-weight:600;color:var(--red)">Total Direct Trip Expenses</td><td style="text-align:right;font-weight:600;color:var(--red)">(' + formatMoney(directTripExpenses) + ')</td></tr>' +
        '<tr style="background:' + (tripNetProfit >= 0 ? 'var(--green-dim)' : 'var(--red-dim)') + '"><td style="font-weight:700">Trip Net Profit</td><td style="text-align:right;font-weight:700;color:' + (tripNetProfit >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(tripNetProfit) + '</td></tr>' +
        '</table>' +
        '</div>' +
        
        // Other Metrics
        '<div style="background:var(--text-secondary);color:white;padding:10px 16px;border-radius:8px 8px 0 0;font-weight:600;margin-top:16px"> Other Metrics</div>' +
        '<div style="border:1px solid var(--bg-elevated);border-top:none;padding:16px;border-radius:0 0 8px 8px">' +
        '<table style="width:100%;font-size:14px">' +
        '<tr><td>Avg Price Per Car (APPC)</td><td style="text-align:right;font-weight:600">' + formatMoney(avgPricePerCar) + '</td></tr>' +
        '<tr><td>Revenue Per Mile (RPM)</td><td style="text-align:right">' + formatMoney(revenuePerMile) + '</td></tr>' +
        '<tr><td>Trip Net Profit/Mile (NPPM)</td><td style="text-align:right">' + formatMoney(netProfitPerMile) + '</td></tr>' +
        '<tr><td>Fuel Costs Per Mile</td><td style="text-align:right">' + formatMoney(fuelCostPerMile) + '</td></tr>' +
        '<tr><td>Variable Cost Per Mile</td><td style="text-align:right">' + formatMoney(variableCostPerMile) + '</td></tr>' +
        '</table>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px">' +
        '<div style="background:var(--blue-dim);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:11px;color:var(--blue)">Cash Collected</div><div style="font-weight:700">' + formatMoney(cashCollected) + '</div></div>' +
        '<div style="background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:11px;color:var(--green)">Driver Earnings</div><div style="font-weight:700">' + formatMoney(driverCut + expenseReimbursement) + '</div></div>' +
        '<div style="background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:11px;color:var(--amber)">Other Reimb.</div><div style="font-weight:700">' + formatMoney(expenseReimbursement) + '</div></div>' +
        '<div style="background:var(--purple-dim);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:11px;color:var(--purple)">Net Pay to Driver</div><div style="font-weight:700">' + formatMoney(netPayToDriver) + '</div></div>' +
        '</div></div>' +
        '</div>' +
        
        // RIGHT COLUMN - Trip Info & Utilization
        '<div>' +
        '<div style="background:var(--green);color:white;padding:10px 16px;border-radius:8px 8px 0 0;font-weight:600"> Trip Info</div>' +
        '<div style="border:1px solid var(--bg-elevated);border-top:none;padding:16px;border-radius:0 0 8px 8px">' +
        '<table style="width:100%;font-size:14px">' +
        '<tr><td>Trip #</td><td style="text-align:right;font-weight:600">' + trip.trip_number + '</td></tr>' +
        '<tr><td>Date</td><td style="text-align:right">' + (trip.trip_date || '-') + '</td></tr>' +
        '<tr><td>Driver</td><td style="text-align:right">' + (driver ? driver.first_name + ' ' + driver.last_name : '-') + '</td></tr>' +
        '<tr><td>Truck #</td><td style="text-align:right">' + (truck ? truck.truck_number : '-') + '</td></tr>' +
        '<tr><td>Hauler Type</td><td style="text-align:right">' + haulerType + '</td></tr>' +
        '<tr><td>Total Miles</td><td style="text-align:right;font-weight:600">' + miles.toLocaleString() + ' mi</td></tr>' +
        '</table></div>' +
        
        // Capacity & Utilization
        '<div style="background:var(--purple);color:white;padding:10px 16px;border-radius:8px 8px 0 0;font-weight:600;margin-top:16px"> Trip Capacity & Utilization</div>' +
        '<div style="border:1px solid var(--bg-elevated);border-top:none;padding:16px;border-radius:0 0 8px 8px">' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:12px"><span>Max Capacity:</span><span style="font-weight:600">' + maxCapacity + ' cars</span></div>' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:12px"><span>Total Cars Loaded:</span><span style="font-weight:600">' + totalCars + ' cars</span></div>' +
        '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span>Trip Utilization:</span><span style="font-weight:700;color:' + utilizationColor + '">' + tripUtilization.toFixed(1) + '%</span></div>' +
        '<div style="margin-bottom:12px">' + utilBar + '</div>' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Target Utilization:</span><span style="font-weight:600">' + targetUtil + '%</span></div>' +
        '<div style="display:flex;justify-content:space-between"><span>Rating:</span><span style="font-weight:700;color:' + utilizationColor + '">' + utilizationRating + '</span></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px">' +
        '<div style="background:var(--blue-dim);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:11px">Outbound Leg</div><div style="font-weight:700">' + outboundUtil.toFixed(0) + '%</div><div style="font-size:var(--text-xs);color:var(--text-muted)">' + outboundCount + ' of ' + maxCapacity + ' cars</div></div>' +
        '<div style="background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);text-align:center"><div style="font-size:11px">Return Leg</div><div style="font-weight:700">' + returnUtil.toFixed(0) + '%</div><div style="font-size:var(--text-xs);color:var(--text-muted)">' + returnCount + ' of ' + maxCapacity + ' cars</div></div>' +
        '</div></div>' +
        
        // Profitability Analysis
        '<div style="background:' + (trueNetProfit >= 0 ? 'var(--green)' : 'var(--red)') + ';color:white;padding:10px 16px;border-radius:8px 8px 0 0;font-weight:600;margin-top:16px"> Profitability Analysis</div>' +
        '<div style="border:1px solid var(--bg-elevated);border-top:none;padding:16px;border-radius:0 0 8px 8px">' +
        '<div style="text-align:center;margin-bottom:16px"><div style="font-size:12px;color:var(--text-muted)">True Net Profit of Trip</div><div style="font-size:28px;font-weight:700;color:' + (trueNetProfit >= 0 ? 'var(--green)' : 'var(--red)') + '">' + (trueNetProfit >= 0 ? '' : '') + ' ' + formatMoney(trueNetProfit) + '</div></div>' +
        '<div style="background:' + (isAboveTarget ? 'var(--green-dim)' : 'var(--red-dim)') + ';padding:var(--spacing-3);border-radius:var(--radius);text-align:center;margin-bottom:12px;font-size:13px">' +
        'This trip\'s contribution of ' + formatMoney(tripNetProfit) + ' was ' + (isAboveTarget ? ' ABOVE' : ' BELOW') + ' the overhead allocation per trip.' +
        '</div>' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Overhead Allocation/Trip:</span><span style="font-weight:600">' + formatMoney(overheadAllocation) + '</span></div>' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Trip vs Break-Even:</span><span style="font-weight:700;color:' + (tripNetProfit - overheadAllocation >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(tripNetProfit - overheadAllocation) + '</span></div>' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Operating Ratio:</span><span style="font-weight:600">' + operatingRatio.toFixed(1) + '%</span></div>' +
        '<div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>True Net Profit Margin:</span><span style="font-weight:700;color:' + (trueNetProfitMargin >= 0 ? 'var(--green)' : 'var(--red)') + '">' + trueNetProfitMargin.toFixed(1) + '%</span></div>' +
        '<div style="text-align:center;margin-top:16px;padding:16px;background:var(--bg-app);border-radius:8px"><div style="font-size:12px;color:var(--text-muted)">Overall Rating</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:' + overallColor + '">' + overallRating + '</div></div>' +
        '</div></div>' +
        '</div>' +
        
        // TRIP DETAILS TABLE
        '<div style="grid-column:1/-1;margin-top:16px">' +
        '<div style="background:var(--text-secondary);color:white;padding:10px 16px;border-radius:8px 8px 0 0;font-weight:600"> Trip Details - Vehicles</div>' +
        '<div class="table-wrapper" style="border:1px solid var(--bg-elevated);border-top:none;border-radius:0 0 8px 8px"><table><thead><tr><th>Direction</th><th>Order #</th><th>Dispatcher</th><th>Broker</th><th>Vehicle</th><th>Origin</th><th>Destination</th><th>Pick-Up</th><th>Delivery</th><th>Payment</th><th>Broker Fee</th><th>Local Fee</th><th>Revenue</th></tr></thead><tbody>' +
        orders.map(o => {
          const disp = appData.dispatchers.find(d => d.id === o.dispatcher_id);
          const dirLabel = vehicleDirections.find(d => d.id === o.vehicle_direction)?.label || '-';
          const noteHtml = o.dispatcher_notes ? '<tr style="background:var(--amber-dim)"><td colspan="13" style="padding:8px 16px;font-size:13px"><span style="font-weight:600;color:var(--amber)"> Note:</span> ' + o.dispatcher_notes + '</td></tr>' : '';
          return '<tr><td><span class="badge" style="background:var(--purple);color:white">' + dirLabel + '</span></td><td><strong>' + o.order_number + '</strong>' + (o.dispatcher_notes ? ' ' : '') + '</td><td>' + (disp ? disp.name : '-') + '</td><td>' + (o.broker_name || '-') + '</td><td>' + o.vehicle_year + ' ' + o.vehicle_make + ' ' + o.vehicle_model + '</td><td>' + (o.origin || '-') + '</td><td>' + (o.destination || '-') + '</td><td>' + (o.pickup_date ? formatDate(o.pickup_date) : '-') + '</td><td>' + (o.dropoff_date ? formatDate(o.dropoff_date) : '-') + '</td><td><span class="badge badge-blue">' + (o.payment_type || '-') + '</span></td><td class="money negative">' + formatMoney(o.broker_fee || 0) + '</td><td class="money negative">' + formatMoney(o.local_fee || 0) + '</td><td class="money">' + formatMoney(o.revenue) + '</td></tr>' + noteHtml;
        }).join('') +
        '</tbody></table></div></div>' +
        '</div>';
    }

    // ============ PROFITABILITY DASHBOARD ============
    function renderProfitability(c) {
      try {
        const trips = appData.trips || [];
        const orders = appData.orders || [];
        const trucks = appData.trucks || [];
        const maintenance = appData.maintenance_records || [];
        const fuelRecords = appData.fuel_transactions || [];
        const fixedCosts = appData.fixed_costs || [];
        const variableCosts = appData.variable_costs || [];
      
      // Period selector - calculate months in data
      const tripDates = trips.filter(t => t.trip_date).map(t => parseTripDate(t.trip_date)).filter(d => d !== null);
      const minDate = tripDates.length > 0 ? new Date(Math.min(...tripDates)) : new Date();
      const maxDate = tripDates.length > 0 ? new Date(Math.max(...tripDates)) : new Date();
      const monthsInData = Math.max(1, Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24 * 30)));
      
      //  FIXED: Use getTripFin() for accurate revenue/cost data 
      let totalRevenue = 0, totalBrokerFees = 0, totalLocalFees = 0, totalDriverPay = 0, totalTripExpenses = 0;
      let tripMilesTotal = 0, totalCars = 0;

      trips.forEach(t => {
        const fin = getTripFin(t.id);
        totalRevenue += fin.loadRevenue;
        totalBrokerFees += fin.brokerFee;
        totalLocalFees += fin.localFees;
        totalDriverPay += fin.driverCut;
        totalTripExpenses += fin.totalExpenses;
        tripMilesTotal += parseFloat(t.miles || 0);
        totalCars += fin.vehicleCount;
      });

      // Use fleet miles from Samsara for fleet-wide metrics, fall back to trip miles
      const startDate = minDate.toISOString().split('T')[0];
      const endDate = maxDate.toISOString().split('T')[0];
      const fleetMilesResult = getFleetMiles(startDate, endDate);
      const totalMiles = fleetMilesResult.miles > 0 ? fleetMilesResult.miles : tripMilesTotal;
      const milesSource = fleetMilesResult.miles > 0 ? 'samsara' : 'trips';

      const cleanRevenue = totalRevenue - totalBrokerFees - totalLocalFees;
      const avgRevenuePerMile = totalMiles > 0 ? totalRevenue / totalMiles : 0;
      
      // Calculate Variable Costs (Fuel Records + Maintenance Records + Variable Costs table)
      // Note: Trip expenses (fuel, tolls etc.) are already in totalTripExpenses from getTripFin()
      const totalFuelFromRecords = fuelRecords.reduce((sum, f) => sum + parseFloat(f.total_cost || 0), 0);
      const totalMaintenanceCost = maintenance.reduce((sum, m) => sum + parseFloat(m.total_cost || 0), 0);
      const totalOtherVariableCosts = variableCosts.reduce((sum, vc) => sum + parseFloat(vc.amount || 0), 0);
      // Don't double-count: totalTripExpenses already includes trip-level fuel/tolls
      const totalVariableCosts = totalFuelFromRecords + totalMaintenanceCost + totalOtherVariableCosts;
      
      // Calculate Fixed Costs (monthly * months in data)
      const monthlyFixedCosts = fixedCosts.reduce((sum, fc) => sum + parseFloat(fc.amount || 0), 0);
      const totalFixedCosts = monthlyFixedCosts * monthsInData;
      
      // TOTAL COSTS & TRUE NET PROFIT (using accurate data from getTripFin)
      const totalAllCosts = totalBrokerFees + totalLocalFees + totalDriverPay + totalTripExpenses + totalVariableCosts + totalFixedCosts;
      const grossProfit = cleanRevenue - totalDriverPay;
      const operatingProfit = grossProfit - totalTripExpenses - totalVariableCosts;
      const trueNetProfit = operatingProfit - totalFixedCosts;
      const profitMargin = totalRevenue > 0 ? (trueNetProfit / totalRevenue * 100) : 0;
      
      //  NEW: Cost Per Mile & Profit Per Mile metrics 
      const totalCPM = totalMiles > 0 ? totalAllCosts / totalMiles : 0;
      const fuelCPM = totalMiles > 0 ? totalFuelFromRecords / totalMiles : 0;
      const profitPerMile = totalMiles > 0 ? trueNetProfit / totalMiles : 0;
      const profitPerCar = totalCars > 0 ? trueNetProfit / totalCars : 0;
      
      // ---- BROKER PROFITABILITY (Using orders data for accuracy) ----
      const brokerStats = {};
      
      orders.forEach(o => {
        if (!o.trip_id) return; // Skip unassigned orders
        const trip = trips.find(t => t.id === o.trip_id);
        if (!trip) return;
        
        const brokerName = o.broker_name || 'Unknown';
        const revenue = parseFloat(o.revenue || 0);
        const brokerFee = parseFloat(o.broker_fee || 0);
        const localFee = parseFloat(o.local_fee || 0);
        
        if (!brokerStats[brokerName]) {
          brokerStats[brokerName] = { revenue: 0, trips: new Set(), brokerFee: 0, localFee: 0, cars: 0 };
        }
        brokerStats[brokerName].revenue += revenue;
        brokerStats[brokerName].brokerFee += brokerFee;
        brokerStats[brokerName].localFee += localFee;
        brokerStats[brokerName].trips.add(o.trip_id);
        brokerStats[brokerName].cars += 1;
      });
      
      const brokerList = Object.entries(brokerStats)
        .map(([name, data]) => {
          const cleanRevenue = data.revenue - data.brokerFee - data.localFee;
          return {
            name,
            revenue: data.revenue,
            trips: data.trips.size,
            cars: data.cars,
            brokerFee: data.brokerFee,
            profit: cleanRevenue,
            feePercent: data.revenue > 0 ? (data.brokerFee / data.revenue * 100) : 0
          };
        })
        .sort((a, b) => b.profit - a.profit)
        .slice(0, 10);
      
      // ---- LANE PROFITABILITY (Using orders data for accuracy) ----
      const laneStats = {};
      
      orders.forEach(o => {
        if (!o.trip_id || !o.origin || !o.destination) return;
        const trip = trips.find(t => t.id === o.trip_id);
        if (!trip) return;
        
        const originState = extractState(o.origin);
        const destState = extractState(o.destination);
        const lane = originState + '  ' + destState;
        
        const revenue = parseFloat(o.revenue || 0);
        const brokerFee = parseFloat(o.broker_fee || 0);
        const localFee = parseFloat(o.local_fee || 0);
        const cleanRevenue = revenue - brokerFee - localFee;
        
        if (!laneStats[lane]) {
          laneStats[lane] = { revenue: 0, miles: 0, trips: new Set(), profit: 0, cars: 0 };
        }
        laneStats[lane].revenue += revenue;
        laneStats[lane].profit += cleanRevenue;
        laneStats[lane].trips.add(o.trip_id);
        laneStats[lane].cars += 1;
        // Add trip miles proportionally (divide by cars in trip)
        const tripOrders = orders.filter(ord => ord.trip_id === o.trip_id).length;
        if (tripOrders > 0) {
          laneStats[lane].miles += parseFloat(trip.miles || 0) / tripOrders;
        }
      });
      
      const laneList = Object.entries(laneStats)
        .map(([lane, data]) => ({
          lane,
          revenue: data.revenue,
          miles: Math.round(data.miles),
          trips: data.trips.size,
          cars: data.cars,
          profit: data.profit,
          rpm: data.miles > 0 ? data.revenue / data.miles : 0,
          ppm: data.miles > 0 ? data.profit / data.miles : 0
        }))
        .sort((a, b) => b.ppm - a.ppm)
        .slice(0, 10);
      
      // ---- TRUCK PROFITABILITY (Using getTripFin for accuracy) ----
      const truckStats = {};
      trucks.forEach(t => {
        truckStats[t.id] = {
          truck_number: t.truck_number,
          revenue: 0,
          miles: 0,
          trips: 0,
          profit: 0,
          fuelCost: 0,
          maintenanceCost: 0,
          driverCut: 0
        };
      });
      
      trips.forEach(t => {
        if (t.truck_id && truckStats[t.truck_id]) {
          const fin = getTripFin(t.id);
          truckStats[t.truck_id].revenue += fin.loadRevenue;
          truckStats[t.truck_id].profit += fin.netProfit;
          truckStats[t.truck_id].driverCut += fin.driverCut;
          truckStats[t.truck_id].miles += parseFloat(t.miles || 0);
          truckStats[t.truck_id].trips += 1;
        }
      });
      
      fuelRecords.forEach(f => {
        if (f.truck_id && truckStats[f.truck_id]) {
          truckStats[f.truck_id].fuelCost += parseFloat(f.total_cost || 0);
        }
      });
      
      maintenance.forEach(m => {
        if (m.truck_id && truckStats[m.truck_id]) {
          truckStats[m.truck_id].maintenanceCost += parseFloat(m.total_cost || 0);
        }
      });
      
      const truckList = Object.values(truckStats)
        .map(t => ({
          ...t,
          totalCost: t.fuelCost + t.maintenanceCost,
          // Net profit from trips minus truck-specific costs
          trueProfit: t.profit - t.fuelCost - t.maintenanceCost,
          rpm: t.miles > 0 ? t.revenue / t.miles : 0,
          cpm: t.miles > 0 ? (t.fuelCost + t.maintenanceCost) / t.miles : 0,
          ppm: t.miles > 0 ? (t.profit - t.fuelCost - t.maintenanceCost) / t.miles : 0
        }))
        .filter(t => t.revenue > 0 || t.totalCost > 0)
        .sort((a, b) => b.trueProfit - a.trueProfit);
      
      // Build HTML
      c.innerHTML = '<div class="header"><h2> Profitability Dashboard</h2></div>' +
        
        // Summary Stats - Enhanced with new metrics
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px"><div class="label">Total Revenue</div><div class="value" style="color:var(--green)">' + formatMoney(totalRevenue) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Total Costs</div><div class="value" style="color:var(--red)">' + formatMoney(totalAllCosts) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px;border-left:3px solid ' + (trueNetProfit >= 0 ? 'var(--green)' : 'var(--red)') + '"><div class="label">Net Profit</div><div class="value" style="color:' + (trueNetProfit >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(trueNetProfit) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Profit Margin</div><div class="value" style="color:' + (profitMargin >= 20 ? 'var(--green)' : profitMargin >= 10 ? 'var(--amber)' : 'var(--red)') + '">' + profitMargin.toFixed(1) + '%</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:90px;padding:12px 16px"><div class="label">Avg $/Mile</div><div class="value">' + formatMoney(avgRevenuePerMile) + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Total Miles</div><div class="value">' + totalMiles.toLocaleString() + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:100px;padding:12px 16px"><div class="label">Total Cars</div><div class="value">' + totalCars.toLocaleString() + '</div></div>' +
        '</div>' +
        
        // NEW: Per-Mile & Per-Car Analysis
        '<div class="card" style="margin-bottom:24px;background:linear-gradient(135deg,var(--text-primary),var(--blue));color:white"><div class="card-header" style="border:none"><h3 style="color:white"> Key Performance Metrics</h3></div><div style="padding:20px">' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:16px">' +
        '<div style="background:rgba(255,255,255,0.15);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:11px;opacity:0.8">Cost Per Mile</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold)">' + formatMoney(totalCPM) + '</div></div>' +
        '<div style="background:rgba(255,255,255,0.15);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:11px;opacity:0.8">Fuel CPM</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold)">' + formatMoney(fuelCPM) + '</div></div>' +
        '<div style="background:' + (profitPerMile >= 0 ? 'rgba(34,197,94,0.3)' : 'rgba(239,68,68,0.3)') + ';padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:11px;opacity:0.8">Profit Per Mile</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:' + (profitPerMile >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(profitPerMile) + '</div></div>' +
        '<div style="background:' + (profitPerCar >= 0 ? 'rgba(34,197,94,0.3)' : 'rgba(239,68,68,0.3)') + ';padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:11px;opacity:0.8">Profit Per Car</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:' + (profitPerCar >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(profitPerCar) + '</div></div>' +
        '<div style="background:rgba(255,255,255,0.15);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:11px;opacity:0.8">Fee Burden</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold)">' + (totalRevenue > 0 ? ((totalBrokerFees + totalLocalFees) / totalRevenue * 100).toFixed(1) : 0) + '%</div></div>' +
        '<div style="background:rgba(255,255,255,0.15);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:11px;opacity:0.8">Driver Ratio</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold)">' + (cleanRevenue > 0 ? (totalDriverPay / cleanRevenue * 100).toFixed(1) : 0) + '%</div></div>' +
        '</div></div></div>' +
        
        // Cost Breakdown Card
        '<div class="card" style="margin-bottom:24px"><div class="card-header"><h3> Cost Breakdown</h3></div><div style="padding:20px">' +
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px">' +
        '<div style="background:var(--red-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:var(--text-xs);color:var(--red)"> Fuel (Records)</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--red)">' + formatMoney(totalFuelFromRecords) + '</div></div>' +
        '<div style="background:var(--amber-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:12px;color:var(--amber)"> Maintenance</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--amber)">' + formatMoney(totalMaintenanceCost) + '</div></div>' +
        '<div style="background:var(--purple-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:12px;color:var(--purple)"> Variable Costs</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--purple)">' + formatMoney(totalOtherVariableCosts) + '</div></div>' +
        '<div style="background:var(--blue-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:12px;color:var(--blue)"> Fixed (Monthly)</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--blue)">' + formatMoney(monthlyFixedCosts) + '</div></div>' +
        '<div style="background:var(--bg-card-hover);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:12px;color:var(--text-secondary)"> Driver Pay</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--text-muted)">' + formatMoney(totalDriverPay) + '</div></div>' +
        '<div style="background:var(--red-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:var(--text-xs);color:var(--red)"> Fees</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--red)">' + formatMoney(totalBrokerFees + totalLocalFees) + '</div></div>' +
        '<div style="background:var(--green-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:var(--text-xs);color:var(--green)"> Trip Expenses</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--green)">' + formatMoney(totalTripExpenses) + '</div></div>' +
        '</div></div></div>' +
        
        // Two column layout
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px">' +
        
        // Top Brokers - Enhanced with profit
        '<div class="card"><div class="card-header"><h3> Top Brokers by Profit</h3></div><div class="table-wrapper"><table><thead><tr><th>Broker</th><th>Cars</th><th>Trips</th><th>Revenue</th><th>Profit</th><th>Fee %</th></tr></thead><tbody>' +
        (brokerList.length === 0 ? '<tr><td colspan="6" style="text-align:center;padding:20px">No data</td></tr>' :
        brokerList.map((b, i) => {
          const medal = i === 0 ? ' ' : i === 1 ? ' ' : i === 2 ? ' ' : '';
          const profitColor = b.profit >= 0 ? 'var(--green)' : 'var(--red)';
          return '<tr><td><strong>' + medal + b.name + '</strong></td><td>' + b.cars + '</td><td>' + b.trips + '</td><td class="money">' + formatMoney(b.revenue) + '</td><td class="money" style="color:' + profitColor + ';font-weight:600">' + formatMoney(b.profit) + '</td><td style="color:var(--amber)">' + b.feePercent.toFixed(1) + '%</td></tr>';
        }).join('')) +
        '</tbody></table></div></div>' +
        
        // Top Lanes - Enhanced with PPM
        '<div class="card"><div class="card-header"><h3> Top Lanes by Profit/Mile</h3></div><div class="table-wrapper"><table><thead><tr><th>Lane</th><th>Cars</th><th>Miles</th><th>Revenue</th><th>Profit</th><th>$/Mile</th></tr></thead><tbody>' +
        (laneList.length === 0 ? '<tr><td colspan="6" style="text-align:center;padding:20px">No data</td></tr>' :
        laneList.map((l, i) => {
          const medal = i === 0 ? ' ' : i === 1 ? ' ' : i === 2 ? ' ' : '';
          const ppmColor = l.ppm >= 0.5 ? 'var(--green)' : l.ppm >= 0 ? 'var(--amber)' : 'var(--red)';
          return '<tr><td><strong>' + medal + l.lane + '</strong></td><td>' + l.cars + '</td><td>' + l.miles.toLocaleString() + '</td><td class="money">' + formatMoney(l.revenue) + '</td><td class="money" style="color:' + (l.profit >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(l.profit) + '</td><td style="color:' + ppmColor + ';font-weight:600">' + formatMoney(l.ppm) + '</td></tr>';
        }).join('')) +
        '</tbody></table></div></div>' +
        
        '</div>' +
        
        // Truck Profitability - Enhanced with PPM
        '<div class="card"><div class="card-header"><h3> Truck Profitability</h3></div><div class="table-wrapper"><table><thead><tr><th>Truck</th><th>Trips</th><th>Miles</th><th>Revenue</th><th>Fuel Cost</th><th>Maint Cost</th><th>True Profit</th><th>$/Mile</th><th>CPM</th><th>PPM</th></tr></thead><tbody>' +
        (truckList.length === 0 ? '<tr><td colspan="10" style="text-align:center;padding:20px">No data</td></tr>' :
        truckList.map((t, i) => {
          const profitColor = t.trueProfit >= 0 ? 'var(--green)' : 'var(--red)';
          const ppmColor = t.ppm >= 0.5 ? 'var(--green)' : t.ppm >= 0 ? 'var(--amber)' : 'var(--red)';
          const medal = i === 0 ? ' ' : i === 1 ? ' ' : i === 2 ? ' ' : '';
          return '<tr style="' + (i < 3 ? 'background:var(--green-dim)' : '') + '"><td><strong>' + medal + '#' + t.truck_number + '</strong></td><td>' + t.trips + '</td><td>' + t.miles.toLocaleString() + '</td><td class="money">' + formatMoney(t.revenue) + '</td><td class="money" style="color:var(--red)">' + formatMoney(t.fuelCost) + '</td><td class="money" style="color:var(--amber)">' + formatMoney(t.maintenanceCost) + '</td><td class="money" style="color:' + profitColor + ';font-weight:700">' + formatMoney(t.trueProfit) + '</td><td>' + formatMoney(t.rpm) + '</td><td style="color:var(--text-muted)">' + formatMoney(t.cpm) + '</td><td style="color:' + ppmColor + ';font-weight:600">' + formatMoney(t.ppm) + '</td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
      } catch (error) {
        console.error('Profitability error:', error);
        c.innerHTML = '<div class="header"><h2> Profitability Dashboard</h2></div><div class="card" style="padding:40px;text-align:center"><p style="color:var(--red)">Error loading profitability data: ' + error.message + '</p><p style="color:var(--text-muted);margin-top:10px">Check console for details.</p></div>';
      }
    }
    
    function extractState(location) {
      if (!location) return 'Unknown';
      // Try to extract state abbreviation (last 2 letters after comma or space)
      const parts = location.split(',');
      if (parts.length >= 2) {
        const statePart = parts[parts.length - 1].trim();
        const stateMatch = statePart.match(/([A-Z]{2})/);
        if (stateMatch) return stateMatch[1];
      }
      // Try to find state abbreviation anywhere
      const stateMatch = location.match(/\b([A-Z]{2})\b/);
      if (stateMatch) return stateMatch[1];
      // Return first 10 chars if no state found
      return location.substring(0, 10);
    }

    // ============ MAINTENANCE PAGE ============
    let maintenanceFilter = { truck: 'all', sort: 'newest' };
    
    function renderMaintenance(c) {
      const records = appData.maintenance_records || [];
      
      // Apply truck filter
      let filtered = records;
      if (maintenanceFilter.truck !== 'all') {
        filtered = records.filter(m => m.truck_id === parseInt(maintenanceFilter.truck));
      }
      
      // Apply sort
      const sorted = [...filtered].sort((a, b) => {
        if (maintenanceFilter.sort === 'newest') {
          return new Date(b.service_date || 0) - new Date(a.service_date || 0);
        } else {
          return new Date(a.service_date || 0) - new Date(b.service_date || 0);
        }
      });
      
      const total = filtered.reduce((s, m) => s + parseFloat(m.total_cost || 0), 0);
      
      // Get unique trucks for filter dropdown
      const trucksWithRecords = [...new Set(records.map(m => m.truck_id))].filter(id => id);
      const truckOptions = trucksWithRecords.map(id => {
        const truck = appData.trucks.find(t => t.id === id);
        return '<option value="' + id + '"' + (maintenanceFilter.truck == id ? ' selected' : '') + '>#' + (truck ? truck.truck_number : id) + '</option>';
      }).join('');
      
      c.innerHTML = '<div class="header"><h2> Maintenance</h2><div style="display:flex;gap:8px"><button class="btn btn-secondary" onclick="exportMaintenanceToCSV()"> Export to Sheets</button><button class="btn btn-primary" onclick="openMaintenanceModal(null, null)">+ New Record</button></div></div>' +
        
        // Filters
        '<div style="display:flex;gap:var(--spacing-4);margin-bottom:var(--spacing-5);flex-wrap:wrap;align-items:center;background:var(--bg-app);padding:var(--spacing-4);border-radius:var(--radius)">' +
        '<div style="display:flex;align-items:center;gap:8px"><label style="font-weight:var(--weight-semibold);color:var(--text-secondary)"> Truck:</label><select onchange="maintenanceFilter.truck=this.value;renderMaintenance(document.getElementById(\'main-content\'))" style="padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px"><option value="all"' + (maintenanceFilter.truck === 'all' ? ' selected' : '') + '>All Trucks</option>' + truckOptions + '</select></div>' +
        '<div style="display:flex;align-items:center;gap:8px"><label style="font-weight:var(--weight-semibold);color:var(--text-secondary)"> Sort:</label><select onchange="maintenanceFilter.sort=this.value;renderMaintenance(document.getElementById(\'main-content\'))" style="padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px"><option value="newest"' + (maintenanceFilter.sort === 'newest' ? ' selected' : '') + '>Newest First</option><option value="oldest"' + (maintenanceFilter.sort === 'oldest' ? ' selected' : '') + '>Oldest First</option></select></div>' +
        '<button class="btn btn-secondary" style="padding:8px 16px" onclick="maintenanceFilter={truck:\'all\',sort:\'newest\'};renderMaintenance(document.getElementById(\'main-content\'))">Clear Filters</button>' +
        '</div>' +
        
        '<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px">' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:110px;padding:12px 16px"><div class="label">Total Records</div><div class="value">' + records.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:120px;padding:12px 16px"><div class="label">Filtered Records</div><div class="value">' + filtered.length + '</div></div>' +
        '<div class="stat-card" style="flex:0 0 auto;min-width:130px;padding:12px 16px;border-left:3px solid var(--green)"><div class="label">Total Spent' + (maintenanceFilter.truck !== 'all' ? ' (Filtered)' : '') + '</div><div class="value" style="color:var(--green)">' + formatMoney(total) + '</div></div></div>' +
        '<div class="card"><div class="card-header"><h3> Maintenance Records' + (maintenanceFilter.truck !== 'all' ? ' - Truck #' + (appData.trucks.find(t => t.id == maintenanceFilter.truck)?.truck_number || '') : '') + '</h3></div><div class="table-wrapper"><table><thead><tr><th>Truck</th><th>Date</th><th>Type</th><th>Shop</th><th>Description</th><th>Cost</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        (sorted.length === 0 ? '<tr><td colspan="7" style="text-align:center;padding:40px">No maintenance records found.</td></tr>' :
        sorted.map(m => {
          const truck = appData.trucks.find(t => t.id === m.truck_id);
          return '<tr><td><strong>#' + (truck ? truck.truck_number : '-') + '</strong></td>' +
            '<td>' + (m.service_date ? formatDate(m.service_date) : '-') + '</td>' +
            '<td><span class="badge badge-blue">' + (m.service_type || '-') + '</span></td>' +
            '<td>' + (m.shop_name || '-') + '</td>' +
            '<td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + (m.description || '-') + '</td>' +
            '<td class="money">' + formatMoney(m.total_cost || 0) + '</td>' +
            '<td class="sticky-col"><div class="actions">' +
            (m.invoice_file ? '<button class="action-btn view" onclick="viewMaintenanceInvoice(' + m.id + ')"></button>' : '') +
            '<button class="action-btn edit" onclick="openMaintenanceModal(null,' + m.id + ')">Edit</button>' +
            '<button class="action-btn delete" onclick="deleteMaintenanceRecord(' + m.id + ',' + m.truck_id + ')">Del</button></div></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }
    
    function exportMaintenanceToCSV() {
      const records = appData.maintenance_records || [];
      if (records.length === 0) {
        showToast('No maintenance records to export', 'error');
        return;
      }
      
      // Sort by date descending
      const sorted = [...records].sort((a, b) => new Date(b.service_date || 0) - new Date(a.service_date || 0));
      
      // CSV Headers
      const headers = ['Truck #', 'Service Date', 'Service Type', 'Shop Name', 'Description', 'Odometer', 'Parts Cost', 'Labor Cost', 'Total Cost', 'Notes'];
      
      // Build CSV rows
      const rows = sorted.map(m => {
        const truck = appData.trucks.find(t => t.id === m.truck_id);
        return [
          truck ? truck.truck_number : '',
          m.service_date || '',
          m.service_type || '',
          (m.shop_name || '').replace(/"/g, '""'),
          (m.description || '').replace(/"/g, '""').replace(/\n/g, ' '),
          m.odometer || '',
          m.parts_cost || 0,
          m.labor_cost || 0,
          m.total_cost || 0,
          (m.notes || '').replace(/"/g, '""')
        ].map(val => '"' + val + '"').join(',');
      });
      
      // Combine headers and rows
      const csv = [headers.join(','), ...rows].join('\n');
      
      // Create download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'maintenance_records_' + new Date().toISOString().split('T')[0] + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      showToast(' Exported ' + records.length + ' records! Open in Google Sheets.');
    }

    // ============ SETTINGS ============
    function getApiKey() {
      return localStorage.getItem('horizonstar_anthropic_key') || '';
    }
    
    function setApiKey(key) {
      if (key) {
        localStorage.setItem('horizonstar_anthropic_key', key);
      } else {
        localStorage.removeItem('horizonstar_anthropic_key');
      }
    }
    
    // ============ EMAIL INTEGRATION (Supabase Edge Function + Resend) ============

    // Helper function to convert blob to base64
    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    // Send earnings statement email via Supabase Edge Function
    async function sendEarningsEmail(driverEmail, driverName, subject, htmlContent, textContent, attachment) {
      try {
        const response = await fetch(SUPABASE_URL + '/functions/v1/send-email', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getAccessToken()
          },
          body: JSON.stringify({
            to: driverEmail,
            subject: subject,
            html: htmlContent || null,
            text: textContent || null,
            from_name: 'Horizon Star TMS',
            attachment: attachment || null
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to send email');
        }

        return { success: true, id: data.id };
      } catch (error) {
        console.error('Email error:', error);
        throw error;
      }
    }

    // Test email configuration
    async function testEmailSetup() {
      const resultDiv = document.getElementById('emailTestResult');
      resultDiv.innerHTML = '<div style="background:var(--blue-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--blue)">Sending test email...</div>';

      try {
        await sendEarningsEmail(
          currentUser.email,
          currentUser.first_name,
          'Test Email from Horizon Star TMS',
          '<h2>Email Configuration Successful!</h2><p>Your email integration is working correctly.</p><p>You can now send earnings statements directly to drivers.</p><br><p style="color:var(--text-muted);font-size:12px">- Horizon Star TMS</p>'
        );

        resultDiv.innerHTML = '<div style="background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--green)">Test email sent to ' + currentUser.email + '! Check your inbox.</div>';
      } catch (error) {
        console.error('Email test failed:', error);
        resultDiv.innerHTML = '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--red)">Failed: ' + error.message + '</div>';
      }
    }

    function renderSettings(c) {
      if (currentUser.role !== 'ADMIN') { c.innerHTML = '<div style="text-align:center;padding:60px">Access Denied</div>'; return; }
      
      const currentKey = getApiKey();
      const maskedKey = currentKey ? currentKey.substring(0, 10) + '...' + currentKey.substring(currentKey.length - 4) : '';
      
      const samsaraKey = getSamsaraApiKey();
      const maskedSamsaraKey = samsaraKey ? samsaraKey.substring(0, 8) + '...' + samsaraKey.substring(samsaraKey.length - 4) : '';
      const samsaraProxyUrl = getSamsaraProxyUrl();
      
      c.innerHTML = '<div class="header"><h2> Settings</h2></div>' +
        
        // Samsara Integration Section
        '<div class="card" style="max-width:700px"><div class="card-header"><h3> Samsara GPS Integration</h3></div>' +
        '<div style="padding:20px">' +
        '<p style="color:var(--text-muted);margin-bottom:20px">Connect to Samsara for real-time truck GPS tracking on the Live Map.</p>' +
        
        '<div class="form-group"><label>Samsara API Token</label><div style="display:flex;gap:12px"><input type="password" id="samsaraKeyInput" value="' + samsaraKey + '" placeholder="samsara_api_xxxxxxxx..." style="flex:1"><button class="btn btn-secondary" onclick="toggleSamsaraKeyVisibility()"></button></div></div>' +
        
        '<div class="form-group"><label>Proxy URL <span style="color:var(--text-muted);font-weight:normal">(required for browser access)</span></label><input type="text" id="samsaraProxyInput" value="' + samsaraProxyUrl + '" placeholder="https://samsara-proxy.yourname.workers.dev" style="width:100%"></div>' +
        
        (samsaraKey ? '<div style="background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:16px"><span style="color:var(--green)"> Samsara token saved: ' + maskedSamsaraKey + '</span>' + (samsaraProxyUrl ? '<br><span style="color:var(--green)"> Proxy configured</span>' : '<br><span style="color:var(--amber)"> No proxy - may not work in browser</span>') + '</div>' : '<div style="background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:16px"><span style="color:var(--amber)"> No Samsara token. Live tracking disabled.</span></div>') +
        
        '<div style="display:flex;gap:12px;flex-wrap:wrap"><button class="btn btn-primary" onclick="saveSamsaraKey()"> Save Settings</button>' +
        (samsaraKey ? '<button class="btn btn-secondary" style="background:var(--red-dim);color:var(--red)" onclick="clearSamsaraKey()"> Remove</button>' : '') +
        '<button class="btn btn-secondary" onclick="testSamsaraConnection()"> Test Connection</button>' +
        (samsaraKey ? '<button class="btn btn-secondary" onclick="manageTruckSamsaraLinks()"> Link Trucks to Vehicles</button>' : '') +
        '</div>' +
        
        '<div id="samsaraTestResult" style="margin-top:16px"></div>' +
        '</div></div>' +
        
        '<div class="card" style="max-width:700px;margin-top:24px"><div class="card-header"><h3> Proxy Setup (Required for Browser)</h3></div>' +
        '<div style="padding:20px">' +
        '<p style="color:var(--text-muted);margin-bottom:16px">Samsara blocks direct browser requests (CORS). Set up a free Cloudflare Worker proxy:</p>' +
        '<ol style="color:var(--text-muted);line-height:2.2">' +
        '<li>Go to <a href="https://dash.cloudflare.com" target="_blank" style="color:var(--blue)">dash.cloudflare.com</a> (free account)</li>' +
        '<li>Click <strong>Workers & Pages</strong>  <strong>Create Application</strong>  <strong>Create Worker</strong></li>' +
        '<li>Name it <code style="background:var(--bg-card-hover);padding:2px 6px;border-radius:4px">samsara-proxy</code></li>' +
        '<li>Click <strong>Deploy</strong>, then <strong>Edit Code</strong></li>' +
        '<li>Replace all code with: <button class="btn btn-secondary" style="padding:4px 12px;font-size:12px;margin-left:8px" onclick="showProxyCode()"> View Code</button></li>' +
        '<li>Click <strong>Save and Deploy</strong></li>' +
        '<li>Copy your URL (e.g., <code style="background:var(--bg-card-hover);padding:2px 6px;border-radius:4px">https://samsara-proxy.yourname.workers.dev</code>)</li>' +
        '<li>Paste it in the Proxy URL field above</li>' +
        '</ol>' +
        '</div></div>' +
        
        '<div class="card" style="max-width:700px;margin-top:24px"><div class="card-header"><h3> How to Get Samsara API Token</h3></div>' +
        '<div style="padding:20px">' +
        '<ol style="color:var(--text-muted);line-height:2">' +
        '<li>Log into <a href="https://cloud.samsara.com" target="_blank" style="color:var(--blue)">cloud.samsara.com</a></li>' +
        '<li>Go to <strong>Settings</strong>  <strong>API Tokens</strong></li>' +
        '<li>Click <strong>Add API Token</strong></li>' +
        '<li>Name it (e.g., "TMS Integration")</li>' +
        '<li>Select permissions: <strong>Read</strong> for Fleet, Vehicles</li>' +
        '<li>Copy the token and paste above</li>' +
        '</ol>' +
        '</div></div>' +

        // Google Maps Integration Section (for Trip Map)
        '<div class="card" style="max-width:700px;margin-top:24px"><div class="card-header"><h3> Google Maps Integration</h3></div>' +
        '<div style="padding:20px">' +
        '<p style="color:var(--text-muted);margin-bottom:20px">Enable Trip Map feature with driving routes and geocoding.</p>' +

        '<div class="form-group"><label>Google Maps API Key</label><div style="display:flex;gap:12px"><input type="password" id="googleMapsKeyInput" value="' + getGoogleMapsApiKey() + '" placeholder="AIzaSy..." style="flex:1"><button class="btn btn-secondary" onclick="toggleGoogleMapsKeyVisibility()"></button></div></div>' +

        (getGoogleMapsApiKey() ? '<div style="background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:16px"><span style="color:var(--green)"> Google Maps API key saved</span></div>' : '<div style="background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:16px"><span style="color:var(--amber)"> No API key. Trip Map feature disabled.</span></div>') +

        '<div style="display:flex;gap:12px;flex-wrap:wrap"><button class="btn btn-primary" onclick="saveGoogleMapsKey()"> Save Key</button>' +
        (getGoogleMapsApiKey() ? '<button class="btn btn-secondary" style="background:var(--red-dim);color:var(--red)" onclick="clearGoogleMapsKey()"> Remove</button>' : '') +
        '<button class="btn btn-secondary" onclick="testGoogleMapsKey()"> Test Connection</button></div>' +

        '<div id="googleMapsTestResult" style="margin-top:16px"></div>' +
        '</div></div>' +

        '<div class="card" style="max-width:700px;margin-top:24px"><div class="card-header"><h3> How to Get Google Maps API Key</h3></div>' +
        '<div style="padding:20px">' +
        '<ol style="color:var(--text-muted);line-height:2">' +
        '<li>Go to <a href="https://console.cloud.google.com" target="_blank" style="color:var(--blue)">console.cloud.google.com</a></li>' +
        '<li>Create a new project or select existing</li>' +
        '<li>Go to <strong>APIs & Services</strong>  <strong>Library</strong></li>' +
        '<li>Enable: <strong>Geocoding API</strong> and <strong>Directions API</strong></li>' +
        '<li>Go to <strong>APIs & Services</strong>  <strong>Credentials</strong></li>' +
        '<li>Click <strong>Create Credentials</strong>  <strong>API Key</strong></li>' +
        '<li>Restrict key to Geocoding and Directions APIs (optional but recommended)</li>' +
        '<li>Copy and paste the key above</li>' +
        '</ol>' +
        '<div style="background:var(--blue-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-top:16px"><strong style="color:var(--blue)">Free Tier:</strong> $200/month credit (~40,000 geocode requests or ~40,000 directions requests)</div>' +
        '</div></div>' +

        // Email Integration Section (Supabase Edge Function + Resend)
        '<div class="card" style="max-width:700px;margin-top:24px"><div class="card-header"><h3> Email Integration (Resend)</h3></div>' +
        '<div style="padding:20px">' +
        '<p style="color:var(--text-muted);margin-bottom:20px">Send earnings statements directly to drivers via email. Uses Supabase Edge Function + Resend API.</p>' +

        '<div style="background:var(--green-dim);padding:var(--spacing-4);border-radius:var(--radius);margin-bottom:20px">' +
        '<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="color:var(--green);font-weight:600">Email sending is ready</span></div>' +
        '<span style="color:var(--green);font-size:13px">Emails are sent via Supabase Edge Function. No configuration needed in the app.</span>' +
        '</div>' +

        '<div style="display:flex;gap:12px;flex-wrap:wrap">' +
        '<button class="btn btn-primary" onclick="testEmailSetup()"> Send Test Email</button>' +
        '</div>' +

        '<div id="emailTestResult" style="margin-top:16px"></div>' +
        '</div></div>' +

        '<div class="card" style="max-width:700px;margin-top:24px"><div class="card-header"><h3> Resend Setup (One-Time - 100 emails/day free)</h3></div>' +
        '<div style="padding:20px">' +
        '<p style="color:var(--text-muted);margin-bottom:16px">If email is not working, follow these steps to set up Resend:</p>' +
        '<ol style="color:var(--text-muted);line-height:2.2">' +
        '<li>Go to <a href="https://resend.com/" target="_blank" style="color:var(--blue)">resend.com</a> and create a free account</li>' +
        '<li>Copy your <strong>API Key</strong> from the dashboard</li>' +
        '<li>Open terminal and run: <code style="background:var(--bg-card-hover);padding:2px 6px;border-radius:4px">supabase secrets set RESEND_API_KEY=re_xxxxx</code></li>' +
        '<li>Deploy the edge function: <code style="background:var(--bg-card-hover);padding:2px 6px;border-radius:4px">supabase functions deploy send-email</code></li>' +
        '<li>Test using the button above</li>' +
        '</ol>' +
        '<div style="background:var(--blue-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-top:16px"><strong style="color:var(--blue)">Free Tier:</strong> 100 emails/day, 3,000 emails/month</div>' +
        '</div></div>' +
        
        // Claude API Section
        '<div class="card" style="max-width:700px;margin-top:24px"><div class="card-header"><h3> AI Integration (Claude API)</h3></div>' +
        '<div style="padding:20px">' +
        '<p style="color:var(--text-muted);margin-bottom:20px">Enter your Anthropic API key to enable AI features like automatic invoice data extraction.</p>' +
        
        '<div class="form-group"><label>Anthropic API Key</label><div style="display:flex;gap:12px"><input type="password" id="apiKeyInput" value="' + currentKey + '" placeholder="sk-ant-api..." style="flex:1"><button class="btn btn-secondary" onclick="toggleApiKeyVisibility()"></button></div></div>' +
        
        (currentKey ? '<div style="background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:16px"><span style="color:var(--green)"> API Key configured: ' + maskedKey + '</span></div>' : '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius);margin-bottom:16px"><span style="color:var(--red)"> No API key configured. AI features disabled.</span></div>') +
        
        '<div style="display:flex;gap:12px;margin-top:20px"><button class="btn btn-primary" onclick="saveApiKey()"> Save API Key</button>' +
        (currentKey ? '<button class="btn btn-secondary" style="background:var(--red-dim);color:var(--red)" onclick="clearApiKey()"> Remove Key</button>' : '') +
        '<button class="btn btn-secondary" onclick="testApiKey()"> Test Connection</button></div>' +
        
        '<div id="apiTestResult" style="margin-top:16px"></div>' +
        '</div></div>' +
        
        '<div class="card" style="max-width:700px;margin-top:24px"><div class="card-header"><h3> Get Claude API Key</h3></div>' +
        '<div style="padding:20px">' +
        '<ol style="color:var(--text-muted);line-height:2">' +
        '<li>Go to <a href="https://console.anthropic.com/" target="_blank" style="color:var(--blue)">console.anthropic.com</a></li>' +
        '<li>Sign up or log in</li>' +
        '<li>Go to API Keys section</li>' +
        '<li>Create a new key</li>' +
        '<li>Copy and paste it above</li>' +
        '</ol>' +
        '</div></div>';
    }
    
    // ============ SAMSARA INTEGRATION ============
    // Global storage for Samsara settings (loaded from DB)
    let samsaraSettings = {
      api_key: '',
      proxy_url: ''
    };
    
    function getSamsaraApiKey() {
      return samsaraSettings.api_key || localStorage.getItem('samsara_api_key') || '';
    }
    
    function setSamsaraApiKey(key) {
      samsaraSettings.api_key = key || '';
      // Also keep in localStorage as backup
      if (key) {
        localStorage.setItem('samsara_api_key', key);
      } else {
        localStorage.removeItem('samsara_api_key');
      }
    }
    
    function getSamsaraProxyUrl() {
      return samsaraSettings.proxy_url || localStorage.getItem('samsara_proxy_url') || '';
    }
    
    function setSamsaraProxyUrl(url) {
      samsaraSettings.proxy_url = url || '';
      if (url) {
        localStorage.setItem('samsara_proxy_url', url);
      } else {
        localStorage.removeItem('samsara_proxy_url');
      }
    }
    
    async function loadSamsaraSettings() {
      try {
        const settings = await dbFetch('app_settings', { key: 'eq.samsara' });
        if (settings && settings.length > 0) {
          const data = settings[0].value;
          if (data) {
            samsaraSettings.api_key = data.api_key || '';
            samsaraSettings.proxy_url = data.proxy_url || '';
            // Sync to localStorage for faster access
            if (samsaraSettings.api_key) localStorage.setItem('samsara_api_key', samsaraSettings.api_key);
            if (samsaraSettings.proxy_url) localStorage.setItem('samsara_proxy_url', samsaraSettings.proxy_url);
          }
        }
      } catch (e) {
        console.log('No app_settings table, using localStorage for Samsara settings');
        // Fallback to localStorage
        samsaraSettings.api_key = localStorage.getItem('samsara_api_key') || '';
        samsaraSettings.proxy_url = localStorage.getItem('samsara_proxy_url') || '';
      }
    }
    
    async function saveSamsaraSettingsToDb() {
      const data = {
        api_key: samsaraSettings.api_key,
        proxy_url: samsaraSettings.proxy_url
      };
      
      try {
        // Try to upsert
        const existing = await dbFetch('app_settings', { key: 'eq.samsara' });
        if (existing && existing.length > 0) {
          await dbUpdate('app_settings', existing[0].id, { value: data });
        } else {
          await dbInsert('app_settings', { key: 'samsara', value: data });
        }
        return true;
      } catch (e) {
        console.error('Failed to save Samsara settings to DB:', e);
        // Continue using localStorage
        return false;
      }
    }
    
    // ============ GOOGLE MAPS INTEGRATION ============
    // For Trip Map feature - geocoding and routing

    function getGoogleMapsApiKey() {
      return localStorage.getItem('horizonstar_google_maps_key') || '';
    }

    function setGoogleMapsApiKey(key) {
      if (key) {
        localStorage.setItem('horizonstar_google_maps_key', key);
      } else {
        localStorage.removeItem('horizonstar_google_maps_key');
      }
    }

    // Geocoding cache to minimize API calls
    let geocodeCache = {};

    function loadGeocodeCache() {
      try {
        const cached = localStorage.getItem('horizonstar_geocode_cache');
        if (cached) geocodeCache = JSON.parse(cached);
      } catch(e) { geocodeCache = {}; }
    }

    function saveGeocodeCache() {
      try {
        localStorage.setItem('horizonstar_geocode_cache', JSON.stringify(geocodeCache));
      } catch(e) { console.warn('Could not save geocode cache'); }
    }

    async function geocodeAddress(address) {
      if (!address) return null;

      const cacheKey = address.toLowerCase().trim();
      if (geocodeCache[cacheKey]) return geocodeCache[cacheKey];

      const apiKey = getGoogleMapsApiKey();
      if (!apiKey) {
        console.warn('Google Maps API key not configured');
        return null;
      }

      try {
        const response = await fetch(
          `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${apiKey}`
        );
        const data = await response.json();

        if (data.status === 'OK' && data.results.length > 0) {
          const location = data.results[0].geometry.location;
          const result = { lat: location.lat, lng: location.lng };
          geocodeCache[cacheKey] = result;
          saveGeocodeCache();
          return result;
        }
        console.warn('Geocoding failed for:', address, data.status);
        return null;
      } catch(e) {
        console.error('Geocoding error:', e);
        return null;
      }
    }

    async function calculateDrivingRoute(waypoints) {
      if (waypoints.length < 2) return null;

      const apiKey = getGoogleMapsApiKey();
      if (!apiKey) return null;

      const origin = `${waypoints[0].lat},${waypoints[0].lng}`;
      const destination = `${waypoints[waypoints.length - 1].lat},${waypoints[waypoints.length - 1].lng}`;

      let url = `https://maps.googleapis.com/maps/api/directions/json?origin=${origin}&destination=${destination}&key=${apiKey}`;

      if (waypoints.length > 2) {
        const intermediates = waypoints.slice(1, -1).map(w => `${w.lat},${w.lng}`).join('|');
        url += `&waypoints=${encodeURIComponent(intermediates)}`;
      }

      try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.status === 'OK' && data.routes.length > 0) {
          return {
            polyline: data.routes[0].overview_polyline.points,
            legs: data.routes[0].legs,
            totalDistance: data.routes[0].legs.reduce((sum, leg) => sum + leg.distance.value, 0),
            totalDuration: data.routes[0].legs.reduce((sum, leg) => sum + leg.duration.value, 0)
          };
        }
        console.warn('Directions API failed:', data.status);
        return null;
      } catch(e) {
        console.error('Directions API error:', e);
        return null;
      }
    }

    function decodePolyline(encoded) {
      const points = [];
      let index = 0, lat = 0, lng = 0;

      while (index < encoded.length) {
        let shift = 0, result = 0, byte;
        do {
          byte = encoded.charCodeAt(index++) - 63;
          result |= (byte & 0x1f) << shift;
          shift += 5;
        } while (byte >= 0x20);
        lat += (result & 1) ? ~(result >> 1) : (result >> 1);

        shift = 0; result = 0;
        do {
          byte = encoded.charCodeAt(index++) - 63;
          result |= (byte & 0x1f) << shift;
          shift += 5;
        } while (byte >= 0x20);
        lng += (result & 1) ? ~(result >> 1) : (result >> 1);

        points.push([lat / 1e5, lng / 1e5]);
      }
      return points;
    }

    // Trip Map state
    let tripMapInstance = null;
    let tripMapMarkers = [];
    let tripMapRoute = null;
    let tripMapTripId = null;
    let tripMapStops = [];

    async function openTripMap(tripId) {
      tripMapTripId = tripId;
      const trip = appData.trips.find(t => t.id === tripId);
      const tripOrders = appData.orders.filter(o => o.trip_id === tripId);

      if (tripOrders.length === 0) {
        showToast('No vehicles in this trip to map', 'warning');
        return;
      }

      const apiKey = getGoogleMapsApiKey();
      if (!apiKey) {
        showToast('Please configure Google Maps API key in Settings', 'error');
        goToPage('settings');
        return;
      }

      // Build stops array
      tripMapStops = buildTripMapStops(tripOrders);

      // Create modal
      const m = document.createElement('div');
      m.className = 'modal-overlay';
      m.id = 'tripMapOverlay';
      m.onclick = e => { if (e.target === m) closeTripMap(); };

      m.innerHTML = `
        <div class="modal" style="max-width:95vw;width:1400px;max-height:95vh;height:90vh;display:flex;flex-direction:column">
          <div class="modal-header" style="flex-shrink:0">
            <h3> Trip Map - ${trip ? trip.trip_number : 'Trip ' + tripId}</h3>
            <button class="modal-close" onclick="closeTripMap()"></button>
          </div>
          <div style="display:flex;flex:1;overflow:hidden">
            <div id="tripMapContainer" style="flex:1;min-height:400px;position:relative">
              <div id="tripMapLoading" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:1000">
                <div style="font-size:32px;margin-bottom:16px"></div>
                <div>Loading map...</div>
              </div>
            </div>
            <div id="tripMapPanel" style="width:320px;background:var(--bg-card);border-left:1px solid var(--border);overflow-y:auto;padding:16px">
              <div style="margin-bottom:16px">
                <div id="tripMapStats" style="font-size:13px;color:var(--text-muted)">Calculating route...</div>
              </div>
              <div style="margin-bottom:12px">
                <button class="btn btn-secondary btn-sm" onclick="tripMapAutoSequenceGeographic()"> Auto-Sequence</button>
              </div>
              <p style="font-size:12px;color:var(--text-muted);margin-bottom:12px">Drag stops to reorder route:</p>
              <div id="tripMapStopList"></div>
              <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">
                <button class="btn btn-primary" style="width:100%" onclick="saveTripMapSequence()"> Save Sequence</button>
              </div>
            </div>
          </div>
        </div>
      `;

      document.body.appendChild(m);
      loadGeocodeCache();
      await initTripMap();
    }

    function buildTripMapStops(tripOrders) {
      let stops = [];

      tripOrders.forEach(order => {
        const hasLocalFee = parseFloat(order.local_fee || 0) > 0;
        const pickupAddr = order.pickup_full_address || order.origin || '';
        const deliveryAddr = order.delivery_full_address || order.destination || '';

        // Add PICKUP only if no local fee (local fee = local driver picked up car to terminal)
        if (!hasLocalFee && pickupAddr) {
          stops.push({
            orderId: order.id,
            type: 'PICKUP',
            address: pickupAddr,
            shortLocation: order.origin || '',
            vehicle: `${order.vehicle_year || ''} ${order.vehicle_make || ''} ${order.vehicle_model || ''}`.trim(),
            date: order.pickup_date,
            sequence: order.pickup_sequence || 999,
            coords: null
          });
        }

        // Always add DELIVERY
        if (deliveryAddr) {
          stops.push({
            orderId: order.id,
            type: 'DELIVERY',
            address: deliveryAddr,
            shortLocation: order.destination || '',
            vehicle: `${order.vehicle_year || ''} ${order.vehicle_make || ''} ${order.vehicle_model || ''}`.trim(),
            date: order.dropoff_date,
            sequence: order.delivery_sequence || 999,
            isTerminalPickup: hasLocalFee,
            coords: null
          });
        }
      });

      // Sort by sequence, then by date
      stops.sort((a, b) => {
        if (a.sequence !== b.sequence) return a.sequence - b.sequence;
        const dateA = new Date(a.date || '2099-12-31');
        const dateB = new Date(b.date || '2099-12-31');
        return dateA - dateB;
      });

      return stops;
    }

    async function initTripMap() {
      // Ensure Leaflet CSS is loaded
      if (!document.querySelector('link[href*="leaflet"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
        document.head.appendChild(link);
      }

      // Ensure Leaflet JS is loaded
      if (!window.L) {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
        script.onload = () => initTripMapAfterLeaflet();
        document.body.appendChild(script);
      } else {
        await initTripMapAfterLeaflet();
      }
    }

    async function initTripMapAfterLeaflet() {
      const container = document.getElementById('tripMapContainer');
      if (!container || !window.L) return;

      // Clean up any existing map instance first
      if (tripMapInstance) {
        try {
          tripMapInstance.remove();
        } catch (e) {
          // Ignore removal errors
        }
        tripMapInstance = null;
      }

      // Ensure container has dimensions before initializing
      if (container.offsetWidth === 0 || container.offsetHeight === 0) {
        setTimeout(initTripMapAfterLeaflet, 100);
        return;
      }

      // Small delay to ensure container is fully rendered
      await new Promise(r => setTimeout(r, 100));

      try {
        tripMapInstance = L.map(container).setView([39.8283, -98.5795], 4);
      } catch (e) {
        console.warn('Trip map init error:', e);
        return;
      }

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap'
      }).addTo(tripMapInstance);

      document.getElementById('tripMapLoading')?.remove();

      // Geocode all addresses
      for (let i = 0; i < tripMapStops.length; i++) {
        const stop = tripMapStops[i];
        if (!stop.coords && stop.address) {
          stop.coords = await geocodeAddress(stop.address);
        }
      }

      renderTripMapStopList();
      await updateTripMapRoute();
    }

    async function updateTripMapRoute() {
      if (!tripMapInstance) return;

      // Clear existing
      tripMapMarkers.forEach(m => m.remove());
      tripMapMarkers = [];
      if (tripMapRoute) {
        tripMapRoute.remove();
        tripMapRoute = null;
      }

      const validStops = tripMapStops.filter(s => s.coords);

      if (validStops.length === 0) {
        document.getElementById('tripMapStats').innerHTML = '<span style="color:var(--red)">Could not geocode any addresses</span>';
        return;
      }

      // Add numbered markers
      const bounds = [];
      validStops.forEach((stop, index) => {
        const isPickup = stop.type === 'PICKUP';
        const markerColor = isPickup ? 'var(--green)' : 'var(--amber)';

        const icon = L.divIcon({
          html: `<div style="background:${markerColor};color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:14px;box-shadow:0 2px 6px rgba(0,0,0,0.3);border:2px solid white">${index + 1}</div>`,
          className: 'trip-map-marker',
          iconSize: [28, 28],
          iconAnchor: [14, 14]
        });

        const marker = L.marker([stop.coords.lat, stop.coords.lng], { icon })
          .addTo(tripMapInstance)
          .bindPopup(`
            <div style="min-width:180px">
              <div style="font-weight:600;color:${markerColor}">${isPickup ? ' PICKUP' : ' DELIVERY'}</div>
              <div style="font-size:14px;margin-top:4px">${stop.vehicle || 'Vehicle'}</div>
              <div style="font-size:12px;color:var(--text-muted);margin-top:4px"> ${stop.shortLocation || stop.address}</div>
              ${stop.date ? `<div style="font-size:12px;color:var(--text-muted);margin-top:2px"> ${formatDate(stop.date)}</div>` : ''}
            </div>
          `);

        tripMapMarkers.push(marker);
        bounds.push([stop.coords.lat, stop.coords.lng]);
      });

      // Draw route line between stops
      if (validStops.length >= 2) {
        const pathCoords = validStops.map(s => [s.coords.lat, s.coords.lng]);
        tripMapRoute = L.polyline(pathCoords, {
          color: 'var(--blue)',
          weight: 4,
          opacity: 0.8
        }).addTo(tripMapInstance);

        document.getElementById('tripMapStats').innerHTML = `<div>${validStops.length} stops</div>`;
      } else {
        document.getElementById('tripMapStats').innerHTML = `<div>${validStops.length} stop${validStops.length !== 1 ? 's' : ''}</div>`;
      }

      if (bounds.length > 0) {
        tripMapInstance.fitBounds(bounds, { padding: [40, 40] });
      }
    }

    function renderTripMapStopList() {
      const container = document.getElementById('tripMapStopList');
      if (!container) return;

      container.innerHTML = tripMapStops.map((stop, index) => {
        const isPickup = stop.type === 'PICKUP';
        const bgColor = isPickup ? 'rgba(34,197,94,0.15)' : 'rgba(249,115,22,0.15)';
        const borderColor = isPickup ? 'var(--green)' : 'var(--amber)';
        const typeLabel = isPickup ? ' P' : ' D';
        const hasCoords = !!stop.coords;

        return `
          <div class="trip-map-stop" draggable="true" data-index="${index}"
               style="background:${bgColor};border-left:4px solid ${borderColor};padding:10px;margin-bottom:6px;border-radius:6px;cursor:grab;${!hasCoords ? 'opacity:0.5' : ''}"
               ondragstart="tripMapDragStart(event)" ondragover="tripMapDragOver(event)" ondrop="tripMapDrop(event)" ondragend="tripMapDragEnd(event)">
            <div style="display:flex;align-items:center;gap:8px">
              <span style="font-weight:700;min-width:24px">${index + 1}.</span>
              <div style="flex:1;overflow:hidden">
                <div style="font-size:12px;font-weight:600;color:${borderColor}">${typeLabel}</div>
                <div style="font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${stop.vehicle || 'Vehicle'}</div>
                <div style="font-size:var(--text-xs);color:var(--text-muted)">${stop.shortLocation || (stop.address ? stop.address.substring(0, 30) : 'No address')}</div>
              </div>
              <span style="color:var(--text-muted)"></span>
            </div>
          </div>
        `;
      }).join('');
    }

    let tripMapDraggedIndex = null;

    function tripMapDragStart(e) {
      tripMapDraggedIndex = parseInt(e.target.closest('.trip-map-stop').dataset.index);
      e.target.closest('.trip-map-stop').style.opacity = '0.4';
    }

    function tripMapDragOver(e) {
      e.preventDefault();
    }

    async function tripMapDrop(e) {
      e.preventDefault();
      const targetEl = e.target.closest('.trip-map-stop');
      if (!targetEl) return;
      const targetIndex = parseInt(targetEl.dataset.index);

      if (tripMapDraggedIndex !== null && tripMapDraggedIndex !== targetIndex) {
        const [moved] = tripMapStops.splice(tripMapDraggedIndex, 1);
        tripMapStops.splice(targetIndex, 0, moved);

        renderTripMapStopList();
        await updateTripMapRoute();
      }
    }

    function tripMapDragEnd(e) {
      const el = e.target.closest('.trip-map-stop');
      if (el) el.style.opacity = '1';
      tripMapDraggedIndex = null;
    }

    // Auto-sequence: Geographic (EastWest or WestEast based on trip direction)
    // Interleaves pickups and deliveries at each geographic location
    async function tripMapAutoSequenceGeographic() {
      // Determine trip direction from orders
      const tripOrders = appData.orders.filter(o => o.trip_id === tripMapTripId);
      const directions = tripOrders.map(o => o.vehicle_direction).filter(Boolean);

      // Check if it's a return trip (going east)
      const isReturnTrip = directions.some(d =>
        d.includes('TO_HOME') || d === 'CA_TO_FL'
      );

      // Filter stops with valid coordinates
      const stopsWithCoords = tripMapStops.filter(s => s.coords);
      const stopsWithoutCoords = tripMapStops.filter(s => !s.coords);

      if (stopsWithCoords.length === 0) {
        showToast('No geocoded stops to sequence', 'warning');
        return;
      }

      // Identify which deliveries can happen anytime (terminal pickups / no pickup in trip)
      // Check against ALL stops (not just stopsWithCoords) to see if pickup exists
      const allPickupOrderIds = new Set(tripMapStops.filter(s => s.type === 'PICKUP').map(s => s.orderId));
      const canDeliverAnytime = new Set();

      for (const stop of stopsWithCoords) {
        if (stop.type === 'DELIVERY') {
          // Can deliver anytime if: terminal pickup OR no pickup stop exists for this order
          if (stop.isTerminalPickup || !allPickupOrderIds.has(stop.orderId)) {
            canDeliverAnytime.add(stop.orderId);
          }
        }
      }

      // Sort stops to approximate driving route
      // Primary: longitude (EastWest or WestEast)
      // Secondary: in Oklahoma region only, prefer southern route (I-40 corridor before Tulsa/I-44)
      const LONGITUDE_THRESHOLD = 2; // degrees (~100-150 miles)
      const OKLAHOMA_REGION = { minLng: -100, maxLng: -94 }; // Oklahoma longitude range

      stopsWithCoords.sort((a, b) => {
        const lngDiff = Math.abs(a.coords.lng - b.coords.lng);

        // Only apply latitude sorting in Oklahoma region where I-40 and I-44 split
        const aInOklahoma = a.coords.lng >= OKLAHOMA_REGION.minLng && a.coords.lng <= OKLAHOMA_REGION.maxLng;
        const bInOklahoma = b.coords.lng >= OKLAHOMA_REGION.minLng && b.coords.lng <= OKLAHOMA_REGION.maxLng;

        if (lngDiff < LONGITUDE_THRESHOLD && aInOklahoma && bInOklahoma) {
          // Both in Oklahoma with similar longitude - southern first (I-40 before I-44)
          return a.coords.lat - b.coords.lat;
        }

        // Default: sort by longitude
        if (isReturnTrip) {
          return a.coords.lng - b.coords.lng; // West to East
        } else {
          return b.coords.lng - a.coords.lng; // East to West
        }
      });

      // Build result: process in geographic order
      // - Pickups: add immediately, mark order as picked up
      // - Deliveries that can happen anytime: add at their geographic position
      // - Deliveries that need pickup first: defer until their pickup is done
      const result = [];
      const pickedUp = new Set(canDeliverAnytime); // Pre-mark terminal pickups
      const deferred = []; // Deliveries waiting for pickup

      for (const stop of stopsWithCoords) {
        if (stop.type === 'PICKUP') {
          result.push(stop);
          pickedUp.add(stop.orderId);

          // After each pickup, add any deferred deliveries that are now ready
          // Sort deferred by longitude to add them in geographic order
          const nowReady = deferred.filter(d => pickedUp.has(d.orderId));
          if (nowReady.length > 0) {
            nowReady.sort((a, b) => isReturnTrip
              ? a.coords.lng - b.coords.lng
              : b.coords.lng - a.coords.lng
            );
            for (const ready of nowReady) {
              result.push(ready);
              deferred.splice(deferred.indexOf(ready), 1);
            }
          }
        } else {
          // DELIVERY
          if (pickedUp.has(stop.orderId)) {
            result.push(stop);
          } else {
            deferred.push(stop);
          }
        }
      }

      // Add remaining deferred at end (shouldn't happen normally)
      result.push(...deferred);

      tripMapStops = [...result, ...stopsWithoutCoords];

      renderTripMapStopList();
      await updateTripMapRoute();
      showToast(` Sorted ${isReturnTrip ? 'WestEast' : 'EastWest'}`, 'success');
    }

    function validateTripMapSequence() {
      const orderPositions = {};

      tripMapStops.forEach((stop, index) => {
        if (!orderPositions[stop.orderId]) {
          orderPositions[stop.orderId] = {};
        }
        orderPositions[stop.orderId][stop.type] = index;
      });

      let errors = [];
      Object.keys(orderPositions).forEach(orderId => {
        const pos = orderPositions[orderId];
        if (pos.PICKUP !== undefined && pos.DELIVERY !== undefined) {
          if (pos.PICKUP >= pos.DELIVERY) {
            errors.push(orderId);
          }
        }
      });

      if (errors.length > 0) {
        showToast(' Pickup must come before delivery for each vehicle', 'warning');
        return false;
      }
      return true;
    }

    async function saveTripMapSequence() {
      if (!validateTripMapSequence()) return;

      const updates = {};

      tripMapStops.forEach((stop, index) => {
        if (!updates[stop.orderId]) {
          updates[stop.orderId] = {};
        }

        if (stop.type === 'PICKUP') {
          updates[stop.orderId].pickup_sequence = index + 1;
        } else {
          updates[stop.orderId].delivery_sequence = index + 1;
        }
      });

      try {
        for (const [orderId, data] of Object.entries(updates)) {
          await dbUpdate('orders', parseInt(orderId), data, true);
        }

        showToast(' Route sequence saved!', 'success');
        closeTripMap();
        await loadAllData(true);
        viewTrip(tripMapTripId);
      } catch(e) {
        showToast(' Failed to save: ' + e.message, 'error');
      }
    }

    function closeTripMap() {
      if (tripMapInstance) {
        tripMapInstance.remove();
        tripMapInstance = null;
      }
      tripMapMarkers = [];
      tripMapRoute = null;
      tripMapStops = [];
      document.getElementById('tripMapOverlay')?.remove();
    }

    // Google Maps Settings functions
    function saveGoogleMapsKey() {
      const key = document.getElementById('googleMapsKeyInput')?.value?.trim();
      setGoogleMapsApiKey(key);
      showToast(key ? ' Google Maps API key saved' : 'API key cleared', key ? 'success' : 'info');
      renderSettings();
    }

    function clearGoogleMapsKey() {
      setGoogleMapsApiKey('');
      showToast('Google Maps API key removed', 'info');
      renderSettings();
    }

    function toggleGoogleMapsKeyVisibility() {
      const input = document.getElementById('googleMapsKeyInput');
      if (input) {
        input.type = input.type === 'password' ? 'text' : 'password';
      }
    }

    async function testGoogleMapsKey() {
      const key = document.getElementById('googleMapsKeyInput')?.value?.trim();
      const resultDiv = document.getElementById('googleMapsTestResult');
      if (!resultDiv) return;

      if (!key) {
        resultDiv.innerHTML = '<div style="color:var(--red)">Please enter an API key first</div>';
        return;
      }

      resultDiv.innerHTML = '<div style="color:var(--text-muted)">Testing connection...</div>';

      try {
        const response = await fetch(
          `https://maps.googleapis.com/maps/api/geocode/json?address=New+York,+NY&key=${key}`
        );
        const data = await response.json();

        if (data.status === 'OK') {
          resultDiv.innerHTML = '<div style="color:var(--green)"> Connection successful! Geocoding API is working.</div>';
        } else if (data.status === 'REQUEST_DENIED') {
          resultDiv.innerHTML = '<div style="color:var(--red)"> API key invalid or Geocoding API not enabled</div>';
        } else {
          resultDiv.innerHTML = `<div style="color:var(--amber)"> Response: ${data.status}</div>`;
        }
      } catch(e) {
        resultDiv.innerHTML = '<div style="color:var(--red)"> Connection failed: ' + e.message + '</div>';
      }
    }

    function showProxyCode() {
      const proxyCode = `// Samsara API Proxy - Cloudflare Worker
// Deploy this at dash.cloudflare.com -> Workers & Pages

export default {
  async fetch(request, env, ctx) {
    // Handle CORS preflight
    if (request.method === 'OPTIONS') {
      return new Response(null, {
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type, X-Samsara-Token',
          'Access-Control-Max-Age': '86400',
        },
      });
    }

    try {
      const url = new URL(request.url);
      const samsaraPath = url.searchParams.get('path');
      
      if (!samsaraPath) {
        return jsonResponse({ error: 'Missing path parameter' }, 400);
      }

      const samsaraToken = request.headers.get('X-Samsara-Token');
      
      if (!samsaraToken) {
        return jsonResponse({ error: 'Missing X-Samsara-Token header' }, 401);
      }

      const samsaraUrl = 'https://api.samsara.com' + samsaraPath;

      const samsaraResponse = await fetch(samsaraUrl, {
        method: request.method,
        headers: {
          'Authorization': 'Bearer ' + samsaraToken,
          'Content-Type': 'application/json',
        },
      });

      const data = await samsaraResponse.json();
      return jsonResponse(data, samsaraResponse.status);

    } catch (error) {
      return jsonResponse({ error: error.message }, 500);
    }
  },
};

function jsonResponse(data, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: {
      'Content-Type': 'application/json',
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, X-Samsara-Token',
    },
  });
}`;

      showModal('proxy-code-modal', ' Cloudflare Worker Proxy Code',
        '<p style="margin-bottom:16px;color:var(--text-muted)">Copy this code and paste it into your Cloudflare Worker:</p>' +
        '<div style="position:relative">' +
        '<button onclick="navigator.clipboard.writeText(document.getElementById(\'proxyCodeText\').textContent);showToast(\'Code copied!\')" style="position:absolute;top:8px;right:8px;padding:6px 12px;background:var(--green);color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px"> Copy</button>' +
        '<pre id="proxyCodeText" style="background:var(--bg-elevated);color:var(--bg-elevated);padding:var(--spacing-4);border-radius:var(--radius);overflow-x:auto;font-size:12px;line-height:1.5;max-height:400px;overflow-y:auto">' + proxyCode.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>' +
        '</div>',
        '<button class="btn btn-primary" onclick="closeModal(\'proxy-code-modal\')">Done</button>'
      );
    }
    
    function toggleSamsaraKeyVisibility() {
      const input = document.getElementById('samsaraKeyInput');
      input.type = input.type === 'password' ? 'text' : 'password';
    }
    
    async function saveSamsaraKey() {
      const key = document.getElementById('samsaraKeyInput').value.trim();
      setSamsaraApiKey(key);
      const proxyUrl = document.getElementById('samsaraProxyInput')?.value.trim() || '';
      setSamsaraProxyUrl(proxyUrl);
      
      // Save to database for all users
      const saved = await saveSamsaraSettingsToDb();
      if (saved) {
        showToast('Samsara settings saved for all users!');
      } else {
        showToast('Samsara settings saved locally');
      }
      renderSettings(document.getElementById('main-content'));
    }
    
    async function clearSamsaraKey() {
      if (!confirm('Remove Samsara token? Live tracking will be disabled for all users.')) return;
      setSamsaraApiKey('');
      setSamsaraProxyUrl('');
      await saveSamsaraSettingsToDb();
      showToast('Samsara settings removed');
      renderSettings(document.getElementById('main-content'));
    }
    
    async function samsaraFetch(path) {
      const key = getSamsaraApiKey();
      const proxyUrl = getSamsaraProxyUrl();
      
      if (!key) return null;
      
      try {
        let response;
        
        if (proxyUrl) {
          // Use proxy
          response = await fetch(proxyUrl + '?path=' + encodeURIComponent(path), {
            method: 'GET',
            headers: {
              'X-Samsara-Token': key,
              'Content-Type': 'application/json'
            }
          });
        } else {
          // Direct call (may fail due to CORS)
          response = await fetch('https://api.samsara.com' + path, {
            method: 'GET',
            headers: {
              'Authorization': 'Bearer ' + key,
              'Content-Type': 'application/json'
            }
          });
        }
        
        if (response.ok) {
          return await response.json();
        } else if (response.status === 401) {
          console.error('Samsara: Invalid API token');
        }
      } catch (e) {
        console.error('Samsara fetch error:', e);
      }
      return null;
    }
    
    async function testSamsaraConnection() {
      const key = document.getElementById('samsaraKeyInput').value.trim();
      const proxyUrl = document.getElementById('samsaraProxyInput')?.value.trim() || '';
      const resultDiv = document.getElementById('samsaraTestResult');
      
      if (!key) {
        resultDiv.innerHTML = '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--red)">Please enter a Samsara API token first</div>';
        return;
      }
      
      resultDiv.innerHTML = '<div style="background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--amber)"> Testing Samsara connection...</div>';
      
      try {
        let response;
        
        if (proxyUrl) {
          // Use proxy
          response = await fetch(proxyUrl + '?path=' + encodeURIComponent('/fleet/vehicles'), {
            method: 'GET',
            headers: {
              'X-Samsara-Token': key,
              'Content-Type': 'application/json'
            }
          });
        } else {
          // Direct call
          response = await fetch('https://api.samsara.com/fleet/vehicles', {
            method: 'GET',
            headers: {
              'Authorization': 'Bearer ' + key,
              'Content-Type': 'application/json'
            }
          });
        }
        
        if (response.ok) {
          const data = await response.json();
          const vehicleCount = data.data ? data.data.length : 0;
          resultDiv.innerHTML = '<div style="background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--green)"> Connection successful! Found ' + vehicleCount + ' vehicles in your Samsara fleet.' + (proxyUrl ? ' (via proxy)' : '') + '</div>';
        } else if (response.status === 401) {
          resultDiv.innerHTML = '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--red)"> Invalid API token. Please check your token.</div>';
        } else {
          resultDiv.innerHTML = '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--red)"> Connection failed: ' + response.status + '</div>';
        }
      } catch (e) {
        if (proxyUrl) {
          resultDiv.innerHTML = '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--red)"> Proxy error: ' + e.message + '. Check your proxy URL.</div>';
        } else {
          resultDiv.innerHTML = '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--red)"> CORS blocked. Please set up a proxy (see instructions below) or deploy to a server.</div>';
        }
      }
    }
    
    async function fetchSamsaraVehicles() {
      const data = await samsaraFetch('/fleet/vehicles');
      return data?.data || [];
    }
    
    async function fetchSamsaraLocations() {
      const data = await samsaraFetch('/fleet/vehicles/locations');
      return data?.data || [];
    }

    // Fetch vehicle stats (odometer readings) from Samsara API
    async function fetchSamsaraVehicleStats(startTime, endTime) {
      // Convert dates to ISO 8601 format for Samsara API
      const startISO = new Date(startTime).toISOString();
      const endISO = new Date(endTime + 'T23:59:59').toISOString();

      // Samsara API: GET /fleet/vehicles/stats/history for historical odometer data
      const params = new URLSearchParams({
        startTime: startISO,
        endTime: endISO,
        types: 'obdOdometerMeters'
      });

      const data = await samsaraFetch('/fleet/vehicles/stats/history?' + params.toString());
      return data?.data || [];
    }

    // Fetch fleet mileage from Samsara API and save to database
    async function fetchAndSaveFleetMileage(periodStart, periodEnd) {
      const statusDiv = document.getElementById('samsaraFetchStatus');

      try {
        statusDiv.innerHTML = '<div style="background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--amber)"> Fetching vehicles from Samsara...</div>';

        // First get list of all vehicles
        const vehicles = await fetchSamsaraVehicles();

        if (!vehicles || vehicles.length === 0) {
          statusDiv.innerHTML = '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--red)"> No vehicles found. Check your Samsara connection.</div>';
          return;
        }

        statusDiv.innerHTML = '<div style="background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--amber)"> Found ' + vehicles.length + ' vehicles. Fetching odometer data...</div>';

        // Fetch stats for each vehicle
        const startISO = new Date(periodStart).toISOString();
        const endISO = new Date(periodEnd + 'T23:59:59').toISOString();

        const data = [];

        for (const vehicle of vehicles) {
          try {
            // Get stats history for this vehicle
            const params = new URLSearchParams({
              startTime: startISO,
              endTime: endISO,
              types: 'obdOdometerMeters',
              vehicleIds: vehicle.id
            });

            const statsData = await samsaraFetch('/fleet/vehicles/stats/history?' + params.toString());
            const stats = statsData?.data || [];

            if (stats.length > 0 && stats[0].obdOdometerMeters && stats[0].obdOdometerMeters.length > 0) {
              const readings = stats[0].obdOdometerMeters;

              // Get first and last readings to calculate distance
              const startOdoMeters = readings[0]?.value || 0;
              const endOdoMeters = readings[readings.length - 1]?.value || 0;

              // Convert meters to miles
              const startOdoMiles = startOdoMeters * 0.000621371;
              const endOdoMiles = endOdoMeters * 0.000621371;
              const distanceMiles = endOdoMiles - startOdoMiles;

              // Extract truck number from vehicle name
              const truckMatch = (vehicle.name || '').match(/(\d+)/);
              const truckNumber = truckMatch ? parseInt(truckMatch[1]) : null;

              if (truckNumber && distanceMiles > 0) {
                data.push({
                  vehicle_name: vehicle.name || 'Vehicle ' + vehicle.id,
                  truck_number: truckNumber,
                  distance: Math.round(distanceMiles * 10) / 10,
                  driving_hours: 0,
                  stops: 0,
                  start_odometer: Math.round(startOdoMiles * 100) / 100,
                  end_odometer: Math.round(endOdoMiles * 100) / 100
                });
              }
            }
          } catch (e) {
            console.warn('Could not fetch stats for vehicle:', vehicle.name, e);
          }
        }

        if (data.length === 0) {
          // Try alternative: use /fleet/vehicles/stats for current readings
          statusDiv.innerHTML = '<div style="background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--amber)"> No historical data. Trying alternative method...</div>';

          // Get current vehicle stats
          const currentStats = await samsaraFetch('/fleet/vehicles/stats?types=obdOdometerMeters');
          const currentData = currentStats?.data || [];

          if (currentData.length > 0) {
            statusDiv.innerHTML = '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--red)"> Samsara API returned current odometer only, not historical range.<br><br>For accurate mileage by date range, please use CSV upload instead.</div>';
            return;
          }

          statusDiv.innerHTML = '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--red)"> No odometer data available from Samsara API.<br><br>Please upload the Vehicle Activity Report CSV instead.</div>';
          return;
        }

        // Save to database
        await saveFleetMileageToDb(data, periodStart, periodEnd);

      } catch (err) {
        console.error('Error fetching Samsara mileage:', err);
        statusDiv.innerHTML = '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--red)"> Error: ' + err.message + '</div>';
      }
    }

    function getTruckSamsaraLinks() {
      try {
        return JSON.parse(localStorage.getItem('truck_samsara_links') || '{}');
      } catch (e) {
        return {};
      }
    }
    
    function setTruckSamsaraLink(truckId, samsaraVehicleId) {
      const links = getTruckSamsaraLinks();
      if (samsaraVehicleId) {
        links[truckId] = samsaraVehicleId;
      } else {
        delete links[truckId];
      }
      localStorage.setItem('truck_samsara_links', JSON.stringify(links));
    }
    
    async function manageTruckSamsaraLinks() {
      const samsaraVehicles = await fetchSamsaraVehicles();
      const links = getTruckSamsaraLinks();
      
      if (samsaraVehicles.length === 0) {
        showToast('Could not fetch Samsara vehicles. Check your token.', 'error');
        return;
      }
      
      const vehicleOptions = samsaraVehicles.map(v => 
        '<option value="' + v.id + '">' + (v.name || 'Vehicle ' + v.id) + '</option>'
      ).join('');
      
      const truckRows = appData.trucks.map(t => {
        const linkedVehicle = links[t.id] || '';
        return '<tr>' +
          '<td><strong>#' + t.truck_number + '</strong></td>' +
          '<td>' + t.truck_type + '</td>' +
          '<td><select onchange="setTruckSamsaraLink(' + t.id + ', this.value)" style="padding:8px;border-radius:6px;border:1px solid var(--border);min-width:200px">' +
          '<option value="">-- Not Linked --</option>' +
          samsaraVehicles.map(v => '<option value="' + v.id + '"' + (linkedVehicle === v.id ? ' selected' : '') + '>' + (v.name || 'Vehicle ' + v.id) + '</option>').join('') +
          '</select></td>' +
          '</tr>';
      }).join('');
      
      showModal('samsara-link-modal', ' Link Trucks to Samsara Vehicles',
        '<p style="color:var(--text-muted);margin-bottom:20px">Match your TMS trucks with Samsara vehicles for live GPS tracking.</p>' +
        '<div class="table-wrapper"><table>' +
        '<thead><tr><th>Truck #</th><th>Type</th><th>Samsara Vehicle</th></tr></thead>' +
        '<tbody>' + truckRows + '</tbody>' +
        '</table></div>',
        '<button class="btn btn-primary" onclick="closeModal(\'samsara-link-modal\');showToast(\'Links saved!\')">Done</button>'
      );
    }
    
    // ============ LIVE MAP PAGE ============
    let liveMapInstance = null;
    let liveMapMarkers = {};
    let liveMapRefreshInterval = null;
    
    async function renderLiveMap(c) {
      const samsaraKey = getSamsaraApiKey();
      
      c.innerHTML = '<div class="header"><h2> ' + t('live_map') + '</h2>' +
        '<div style="display:flex;gap:12px;align-items:center">' +
        '<span id="lastUpdateTime" style="color:var(--text-muted);font-size:13px"></span>' +
        '<button class="btn btn-secondary" onclick="refreshLiveMap()"> Refresh</button>' +
        (currentUser.role === 'ADMIN' ? '<button class="btn btn-secondary" onclick="goToPage(\'settings\')"> Configure Samsara</button>' : '') +
        '</div></div>' +
        
        (!samsaraKey ? 
          '<div class="card" style="text-align:center;padding:60px">' +
          '<div style="font-size:48px;margin-bottom:20px"></div>' +
          '<h3 style="margin-bottom:12px">Samsara Not Connected</h3>' +
          '<p style="color:var(--text-muted);margin-bottom:24px">Connect your Samsara account to see live truck locations.</p>' +
          (currentUser.role === 'ADMIN' ? '<button class="btn btn-primary" onclick="goToPage(\'settings\')">Configure Samsara </button>' : '<p style="color:var(--text-muted)">Please ask an administrator to configure Samsara.</p>') +
          '</div>' 
        :
          '<div style="display:flex;gap:20px;height:calc(100vh - 180px)">' +
          '<div id="liveMapContainer" style="flex:1;border-radius:12px;overflow:hidden;border:1px solid var(--border);min-height:500px"></div>' +
          '<div id="truckListPanel" style="width:300px;background:var(--bg-card);border-radius:12px;border:1px solid var(--border);overflow-y:auto;padding:16px">' +
          '<h3 style="margin-bottom:16px"> Fleet Status</h3>' +
          '<div id="truckStatusList"><div style="text-align:center;padding:40px;color:var(--text-muted)">Loading...</div></div>' +
          '</div></div>'
        );
      
      if (samsaraKey) {
        // Load Leaflet CSS
        if (!document.getElementById('leaflet-css')) {
          const link = document.createElement('link');
          link.id = 'leaflet-css';
          link.rel = 'stylesheet';
          link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
          document.head.appendChild(link);
        }
        
        // Load Leaflet JS
        if (!window.L) {
          const script = document.createElement('script');
          script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
          script.onload = () => initLiveMap();
          document.body.appendChild(script);
        } else {
          initLiveMap();
        }
        
        // Start auto-refresh every 30 seconds
        if (liveMapRefreshInterval) clearInterval(liveMapRefreshInterval);
        liveMapRefreshInterval = setInterval(refreshLiveMap, 30000);
      }
    }
    
    function initLiveMap() {
      const container = document.getElementById('liveMapContainer');
      if (!container || !window.L) return;

      // Ensure container has dimensions before initializing
      if (container.offsetWidth === 0 || container.offsetHeight === 0) {
        // Retry after a short delay if container not ready
        setTimeout(initLiveMap, 100);
        return;
      }

      // Clear existing map
      if (liveMapInstance) {
        try {
          liveMapInstance.remove();
        } catch (e) {
          // Ignore removal errors
        }
        liveMapInstance = null;
      }
      liveMapMarkers = {};

      // Initialize map centered on US
      try {
        liveMapInstance = L.map('liveMapContainer', { zoomAnimation: false }).setView([39.8283, -98.5795], 4);
      } catch (e) {
        console.warn('Leaflet map init error:', e);
        return;
      }

      // Add tile layer (OpenStreetMap)
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ' OpenStreetMap contributors'
      }).addTo(liveMapInstance);

      // Wait for map to be fully ready before loading data
      setTimeout(() => refreshLiveMap(), 200);
    }
    
    async function refreshLiveMap() {
      if (!liveMapInstance || !liveMapInstance._container) return;
      
      const locations = await fetchSamsaraLocations();
      const links = getTruckSamsaraLinks();
      const reverseLinks = {};
      
      // Create reverse lookup: samsaraVehicleId -> truckId
      Object.entries(links).forEach(([truckId, samsaraId]) => {
        reverseLinks[samsaraId] = parseInt(truckId);
      });
      
      // Update last refresh time
      const timeEl = document.getElementById('lastUpdateTime');
      if (timeEl) {
        timeEl.textContent = 'Updated: ' + new Date().toLocaleTimeString();
      }
      
      // Build truck status list
      let truckStatusHtml = '';
      const bounds = [];
      
      if (locations.length === 0) {
        truckStatusHtml = '<div style="text-align:center;padding:20px;color:var(--text-muted)">No location data available.<br><br>Make sure your trucks are linked to Samsara vehicles in Settings.</div>';
      } else {
        locations.forEach(loc => {
          const samsaraVehicle = loc.id;
          const truckId = reverseLinks[samsaraVehicle];
          const truck = truckId ? appData.trucks.find(t => t.id === truckId) : null;
          
          const lat = loc.location?.latitude;
          const lng = loc.location?.longitude;
          const speed = loc.location?.speed ? Math.round(loc.location.speed * 0.621371) : 0; // Convert km/h to mph
          const heading = loc.location?.heading || 0;
          const address = loc.location?.reverseGeo?.formattedLocation || 'Unknown location';
          const vehicleName = loc.name || 'Vehicle ' + samsaraVehicle;
          const truckLabel = truck ? 'Truck #' + truck.truck_number : vehicleName;
          const isMoving = speed > 2;
          
          if (lat && lng) {
            bounds.push([lat, lng]);
            
            // Create/update marker
            const markerKey = samsaraVehicle;
            const iconHtml = '<div style="background:' + (isMoving ? 'var(--green)' : 'var(--text-secondary)') + ';color:white;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:600;white-space:nowrap;box-shadow:0 2px 4px rgba(0,0,0,0.3)"> ' + (truck ? '#' + truck.truck_number : vehicleName.substring(0, 10)) + '</div>';
            
            const customIcon = L.divIcon({
              html: iconHtml,
              className: 'truck-marker',
              iconSize: null,
              iconAnchor: [40, 20]
            });
            
            if (liveMapMarkers[markerKey]) {
              liveMapMarkers[markerKey].setLatLng([lat, lng]);
              liveMapMarkers[markerKey].setIcon(customIcon);
            } else {
              liveMapMarkers[markerKey] = L.marker([lat, lng], { icon: customIcon })
                .addTo(liveMapInstance)
                .bindPopup('<div style="min-width:200px"><strong>' + truckLabel + '</strong><br>' +
                  '<span style="color:var(--text-muted)">' + address + '</span><br>' +
                  '<div style="margin-top:8px">' +
                  '<span style="background:' + (isMoving ? 'var(--green-dim)' : 'var(--bg-card-hover)') + ';color:' + (isMoving ? 'var(--green)' : 'var(--text-secondary)') + ';padding:2px 8px;border-radius:4px;font-size:12px">' + (isMoving ? ' Moving ' + speed + ' mph' : ' Stopped') + '</span>' +
                  '</div></div>');
            }
            
            // Add to status list
            truckStatusHtml += '<div onclick="liveMapInstance.setView([' + lat + ',' + lng + '], 12)" style="padding:12px;margin-bottom:8px;background:var(--bg-tertiary);border-radius:8px;cursor:pointer;border-left:4px solid ' + (isMoving ? 'var(--green)' : 'var(--text-secondary)') + '">' +
              '<div style="font-weight:600">' + truckLabel + '</div>' +
              '<div style="font-size:12px;color:var(--text-muted);margin-top:4px">' + address.substring(0, 40) + (address.length > 40 ? '...' : '') + '</div>' +
              '<div style="font-size:12px;margin-top:6px">' +
              '<span style="color:' + (isMoving ? 'var(--green)' : 'var(--text-secondary)') + '">' + (isMoving ? ' ' + speed + ' mph' : ' Stopped') + '</span>' +
              '</div></div>';
          }
        });
        
        // Fit map to show all trucks
        if (bounds.length > 0 && liveMapInstance) {
          try {
            liveMapInstance.fitBounds(bounds, { padding: [50, 50], animate: false });
          } catch (e) {
            console.warn('fitBounds error:', e);
          }
        }
      }
      
      // Also show trucks that aren't linked
      const linkedTruckIds = Object.keys(links).map(id => parseInt(id));
      const unlinkedTrucks = appData.trucks.filter(t => !linkedTruckIds.includes(t.id));
      
      if (unlinkedTrucks.length > 0) {
        truckStatusHtml += '<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)">' +
          '<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px">Not linked to Samsara:</div>';
        
        unlinkedTrucks.forEach(t => {
          truckStatusHtml += '<div style="padding:8px;margin-bottom:4px;background:var(--bg-tertiary);border-radius:6px;opacity:0.6">' +
            '<span style="font-weight:500">Truck #' + t.truck_number + '</span>' +
            '<span style="color:var(--text-muted);font-size:12px;margin-left:8px">No GPS</span>' +
            '</div>';
        });
        
        truckStatusHtml += '</div>';
      }
      
      const listEl = document.getElementById('truckStatusList');
      if (listEl) {
        listEl.innerHTML = truckStatusHtml || '<div style="text-align:center;padding:20px;color:var(--text-muted)">No trucks to display</div>';
      }
    }
    
    // Cleanup map on page change
    function cleanupLiveMap() {
      if (liveMapRefreshInterval) {
        clearInterval(liveMapRefreshInterval);
        liveMapRefreshInterval = null;
      }
      if (liveMapInstance) {
        liveMapInstance.remove();
        liveMapInstance = null;
      }
      liveMapMarkers = {};
    }

    // ============ TEAM CHAT ============
    let chatMessages = [];
    let chatRefreshInterval = null;
    let lastMessageId = 0;
    let mentionDropdownVisible = false;
    let mentionStartPos = -1;
    let unreadChatCount = 0;
    let lastSeenChatId = parseInt(localStorage.getItem('lastSeenChatId') || '0');
    let miniChatOpen = false;
    let miniChatRefreshInterval = null;
    
    async function renderTeamChat(c) {
      c.innerHTML = '<div class="chat-container" style="display:flex;flex-direction:column;height:calc(100vh - 120px);max-width:900px;margin:0 auto">' +
        '<div class="chat-header" style="padding:16px 20px;border-bottom:1px solid var(--border);background:var(--bg-card);border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center">' +
        '<div><h2 style="margin:0;display:flex;align-items:center;gap:10px"> ' + t('team_chat') + '</h2>' +
        '<span style="color:var(--text-muted);font-size:13px" id="chatOnlineStatus">Loading...</span></div>' +
        '<div style="display:flex;gap:8px">' +
        '<button class="btn btn-secondary" onclick="refreshChat()" style="padding:8px 12px"></button>' +
        '</div></div>' +
        
        '<div id="chatMessages" class="chat-messages" style="flex:1;overflow-y:auto;padding:20px;background:var(--bg-secondary);display:flex;flex-direction:column;gap:12px">' +
        '<div style="text-align:center;color:var(--text-muted);padding:40px">Loading messages...</div>' +
        '</div>' +
        
        '<div class="chat-input-area" style="padding:16px;background:var(--bg-card);border-top:1px solid var(--border);border-radius:0 0 12px 12px">' +
        '<div id="chatFilePreview" style="display:none;margin-bottom:12px;padding:12px;background:var(--bg-tertiary);border-radius:8px"></div>' +
        '<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px"> ' + 'Type @ to mention   to attach files' + '</div>' +
        '<div style="display:flex;gap:12px;align-items:flex-end">' +
        '<input type="file" id="chatFileInput" multiple accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt" style="display:none" onchange="handleChatFileSelect(event)">' +
        '<button onclick="document.getElementById(\'chatFileInput\').click()" class="btn btn-secondary" style="height:48px;width:48px;padding:0;border-radius:12px;flex-shrink:0" title="' + 'Attach file' + '"></button>' +
        '<div style="flex:1;position:relative">' +
        '<textarea id="chatInput" placeholder="' + 'Type a message...' + '" ' +
        'style="width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:12px;resize:none;font-size:14px;line-height:1.4;min-height:48px;max-height:120px;background:var(--bg-tertiary);color:var(--text-primary)" ' +
        'onkeydown="handleChatKeydown(event)" oninput="handleChatInput(event)"></textarea>' +
        '<div id="mentionDropdown" style="display:none;position:absolute;bottom:100%;left:0;right:0;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;box-shadow:var(--shadow-lg);max-height:200px;overflow-y:auto;margin-bottom:4px;z-index:100"></div>' +
        '</div>' +
        '<button onclick="sendChatMessage()" class="btn btn-primary" style="height:48px;padding:0 24px;border-radius:12px;font-weight:600">' +
        '<span style="display:flex;align-items:center;gap:6px"> ' + 'Send' + '</span></button>' +
        '</div></div>' +
        '</div>';
      
      // Load messages
      await loadChatMessages();
      
      // Start auto-refresh every 5 seconds
      if (chatRefreshInterval) clearInterval(chatRefreshInterval);
      chatRefreshInterval = setInterval(checkNewMessages, 5000);
      
      // Focus input
      setTimeout(() => document.getElementById('chatInput')?.focus(), 100);
    }
    
    function autoResizeTextarea(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 120) + 'px';
    }
    
    function handleChatInput(e) {
      const input = e.target;
      autoResizeTextarea(input);
      
      const cursorPos = input.selectionStart;
      const text = input.value;
      
      // Check for @ mention trigger
      const textBeforeCursor = text.substring(0, cursorPos);
      const atMatch = textBeforeCursor.match(/@(\w*)$/);
      
      if (atMatch) {
        mentionStartPos = cursorPos - atMatch[1].length - 1;
        showMentionDropdown(atMatch[1]);
      } else {
        hideMentionDropdown();
      }
    }
    
    function showMentionDropdown(query) {
      const dropdown = document.getElementById('mentionDropdown');
      if (!dropdown) return;
      
      // Get all users that can be mentioned
      const allUsers = appData.users || [];
      const filtered = query 
        ? allUsers.filter(u => 
            (u.first_name + ' ' + (u.last_name || '')).toLowerCase().includes(query.toLowerCase()) ||
            u.email.toLowerCase().includes(query.toLowerCase())
          )
        : allUsers;
      
      if (filtered.length === 0) {
        dropdown.style.display = 'none';
        return;
      }
      
      dropdown.innerHTML = filtered.slice(0, 8).map((u, idx) => {
        const name = u.first_name + ' ' + (u.last_name || '');
        const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const color = getAvatarColor(u.id);
        return '<div onclick="selectMention(' + u.id + ', \'' + name.replace(/'/g, "\\'") + '\')" ' +
          'style="padding:10px 12px;cursor:pointer;display:flex;align-items:center;gap:10px;' + (idx === 0 ? 'background:var(--bg-hover);' : '') + '" ' +
          'onmouseover="this.style.background=\'var(--bg-hover)\'" onmouseout="this.style.background=\'\'">' +
          '<div style="width:32px;height:32px;border-radius:50%;background:' + color + ';color:white;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600">' + initials + '</div>' +
          '<div><div style="font-weight:500">' + name + '</div>' +
          '<div style="font-size:var(--text-xs);color:var(--text-muted)">' + u.role + '</div></div></div>';
      }).join('');
      
      dropdown.style.display = 'block';
      mentionDropdownVisible = true;
    }
    
    function hideMentionDropdown() {
      const dropdown = document.getElementById('mentionDropdown');
      if (dropdown) dropdown.style.display = 'none';
      mentionDropdownVisible = false;
      mentionStartPos = -1;
    }
    
    function selectMention(userId, userName) {
      const input = document.getElementById('chatInput');
      if (!input || mentionStartPos === -1) return;
      
      const text = input.value;
      const before = text.substring(0, mentionStartPos);
      const after = text.substring(input.selectionStart);
      
      input.value = before + '@' + userName + ' ' + after;
      input.focus();
      
      // Set cursor after mention
      const newPos = before.length + userName.length + 2;
      input.setSelectionRange(newPos, newPos);
      
      hideMentionDropdown();
    }
    
    function handleChatKeydown(e) {
      if (mentionDropdownVisible) {
        if (e.key === 'Escape') {
          e.preventDefault();
          hideMentionDropdown();
          return;
        }
        if (e.key === 'Tab' || e.key === 'Enter') {
          const firstItem = document.querySelector('#mentionDropdown > div');
          if (firstItem) {
            e.preventDefault();
            firstItem.click();
            return;
          }
        }
      }
      
      if (e.key === 'Enter' && !e.shiftKey && !mentionDropdownVisible) {
        e.preventDefault();
        sendChatMessage();
      }
    }
    
    async function loadChatMessages() {
      try {
        chatMessages = await dbFetch('chat_messages', { order: 'created_at.asc', limit: 100 }) || [];
        renderChatMessages();
        if (chatMessages.length > 0) {
          lastMessageId = chatMessages[chatMessages.length - 1].id;
          // Mark all messages as seen
          lastSeenChatId = lastMessageId;
          localStorage.setItem('lastSeenChatId', lastSeenChatId.toString());
          unreadChatCount = 0;
          updateChatBadges();
        }
        updateOnlineStatus();
      } catch (e) {
        console.error('Failed to load chat:', e);
        document.getElementById('chatMessages').innerHTML = 
          '<div style="text-align:center;color:var(--text-muted);padding:40px">' +
          '<p> Chat not set up yet</p>' +
          '<p style="font-size:13px;margin-top:8px">Run the SQL script to create the chat_messages table</p></div>';
      }
    }
    
    async function checkNewMessages() {
      if (currentPage !== 'team_chat') {
        cleanupChat();
        return;
      }
      
      try {
        const newMessages = await dbFetch('chat_messages', { 
          order: 'created_at.asc',
          filter: { id: 'gt.' + lastMessageId }
        }) || [];
        
        if (newMessages.length > 0) {
          chatMessages = [...chatMessages, ...newMessages];
          lastMessageId = newMessages[newMessages.length - 1].id;
          renderChatMessages();
        }
        updateOnlineStatus();
      } catch (e) {
        console.error('Chat refresh error:', e);
      }
    }
    
    async function refreshChat() {
      lastMessageId = 0;
      await loadChatMessages();
      showToast('Chat refreshed');
    }
    
    function updateOnlineStatus() {
      const statusEl = document.getElementById('chatOnlineStatus');
      if (statusEl) {
        const userCount = [...new Set(chatMessages.slice(-20).map(m => m.user_id))].length;
        statusEl.innerHTML = '<span style="color:var(--green)"></span> ' + 
          'Online' + 
          '  ' + chatMessages.length + ' ' + 'messages';
      }
    }
    
    function renderChatMessages() {
      const container = document.getElementById('chatMessages');
      if (!container) return;
      
      if (chatMessages.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:60px">' +
          '<div style="font-size:48px;margin-bottom:16px"></div>' +
          '<p>' + 'No messages yet' + '</p>' +
          '<p style="font-size:13px;margin-top:8px">' + 'Start the conversation!' + '</p></div>';
        return;
      }
      
      // Group messages by date
      let html = '';
      let currentDate = '';
      
      chatMessages.forEach((msg, idx) => {
        const msgDate = new Date(msg.created_at);
        const dateStr = msgDate.toLocaleDateString();
        const timeStr = msgDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const isOwnMessage = msg.user_id === currentUser.id;
        const isConsecutive = idx > 0 && chatMessages[idx - 1].user_id === msg.user_id && 
          (new Date(msg.created_at) - new Date(chatMessages[idx - 1].created_at)) < 60000;
        
        // Date separator
        if (dateStr !== currentDate) {
          currentDate = dateStr;
          const isToday = dateStr === new Date().toLocaleDateString();
          const isYesterday = dateStr === new Date(Date.now() - 86400000).toLocaleDateString();
          const dateLabel = isToday ? 'Today' : 
                           isYesterday ? 'Yesterday' : dateStr;
          html += '<div style="text-align:center;margin:16px 0"><span style="background:var(--bg-tertiary);padding:6px 16px;border-radius:20px;font-size:12px;color:var(--text-muted)">' + dateLabel + '</span></div>';
        }
        
        // Message bubble
        const userName = escapeHtml(msg.user_name || 'Unknown');
        const initials = escapeHtml((msg.user_name || 'U').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase());
        const avatarColor = getAvatarColor(msg.user_id);
        
        html += '<div style="display:flex;gap:10px;align-items:flex-start;' + (isOwnMessage ? 'flex-direction:row-reverse' : '') + '">';
        
        // Avatar (only show if not consecutive)
        if (!isConsecutive) {
          html += '<div style="width:36px;height:36px;border-radius:50%;background:' + avatarColor + ';color:white;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;flex-shrink:0">' + initials + '</div>';
        } else {
          html += '<div style="width:36px;flex-shrink:0"></div>';
        }
        
        // Message content
        html += '<div style="max-width:70%;' + (isOwnMessage ? 'text-align:right' : '') + '">';
        
        if (!isConsecutive) {
          html += '<div style="font-size:12px;color:var(--text-muted);margin-bottom:4px;' + (isOwnMessage ? 'text-align:right' : '') + '">' +
            '<span style="font-weight:600;color:var(--text-primary)">' + userName + '</span>' +
            (msg.user_role ? ' <span style="background:var(--bg-tertiary);padding:2px 6px;border-radius:4px;font-size:10px">' + escapeHtml(msg.user_role) + '</span>' : '') +
            '</div>';
        }
        
        const otherMsgBg = 'var(--bg-card)';
        const otherMsgColor = 'var(--text-primary)';
        const otherMsgBorder = '1px solid var(--border)';
        const otherMsgShadow = '0 2px 8px rgba(0,0,0,0.15)';
        
        // Parse file attachments
        let attachmentsHtml = '';
        if (msg.file_attachments) {
          try {
            const files = typeof msg.file_attachments === 'string' ? JSON.parse(msg.file_attachments) : msg.file_attachments;
            if (files && files.length > 0) {
              attachmentsHtml = '<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px">';
              files.forEach(file => {
                const isImage = file.type && file.type.startsWith('image/');
                if (isImage) {
                  attachmentsHtml += '<a href="' + file.url + '" target="_blank" style="display:block">' +
                    '<img src="' + file.url + '" alt="' + escapeHtml(file.name) + '" style="max-width:200px;max-height:200px;border-radius:8px;cursor:pointer;display:block" onclick="openImageViewer(\'' + file.url + '\');event.preventDefault()">' +
                    '</a>';
                } else {
                  const icon = file.type && file.type.includes('pdf') ? '' : '';
                  attachmentsHtml += '<a href="' + file.url + '" target="_blank" download style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:' + (isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)') + ';border-radius:8px;text-decoration:none;color:inherit">' +
                    '<span style="font-size:20px">' + icon + '</span>' +
                    '<div><div style="font-size:12px;font-weight:500">' + escapeHtml(file.name) + '</div>' +
                    '<div style="font-size:10px;opacity:0.7">' + formatFileSize(file.size || 0) + '</div></div>' +
                    '</a>';
                }
              });
              attachmentsHtml += '</div>';
            }
          } catch (e) {
            console.error('Failed to parse attachments:', e);
          }
        }
        
        html += '<div style="background:' + (isOwnMessage ? 'linear-gradient(135deg, var(--green) 0%, var(--green) 100%)' : otherMsgBg) + ';color:' + (isOwnMessage ? 'white' : otherMsgColor) + ';padding:10px 14px;border-radius:' + (isOwnMessage ? '16px 16px 4px 16px' : '16px 16px 16px 4px') + ';display:inline-block;text-align:left;word-wrap:break-word;box-shadow:' + (isOwnMessage ? '0 2px 8px rgba(34, 197, 94, 0.3)' : otherMsgShadow) + ';border:' + (isOwnMessage ? 'none' : otherMsgBorder) + '">';
        
        // Text content (only if there's text)
        if (msg.message && msg.message.trim()) {
          html += '<div style="white-space:pre-wrap">' + formatMessageWithMentions(msg.message, isOwnMessage) + '</div>';
        }
        
        // File attachments
        html += attachmentsHtml;
        
        // Time
        html += '<div style="font-size:10px;opacity:0.7;margin-top:4px;text-align:right">' + timeStr + '</div>' +
          '</div>';
        
        html += '</div></div>';
      });
      
      container.innerHTML = html;
      
      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }
    
    function openImageViewer(imageUrl) {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10000;display:flex;align-items:center;justify-content:center;cursor:zoom-out';
      overlay.onclick = () => overlay.remove();
      
      const img = document.createElement('img');
      img.src = imageUrl;
      img.style.cssText = 'max-width:90vw;max-height:90vh;object-fit:contain;border-radius:8px';
      
      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = '';
      closeBtn.style.cssText = 'position:absolute;top:20px;right:20px;width:44px;height:44px;border-radius:50%;background:rgba(255,255,255,0.2);color:white;border:none;font-size:24px;cursor:pointer';
      closeBtn.onclick = () => overlay.remove();
      
      const downloadBtn = document.createElement('a');
      downloadBtn.href = imageUrl;
      downloadBtn.download = '';
      downloadBtn.innerHTML = ' ' + 'Download';
      downloadBtn.style.cssText = 'position:absolute;bottom:20px;right:20px;padding:12px 20px;background:var(--primary);color:white;border-radius:8px;text-decoration:none;font-weight:600';
      
      overlay.appendChild(img);
      overlay.appendChild(closeBtn);
      overlay.appendChild(downloadBtn);
      document.body.appendChild(overlay);
    }
    
    function getAvatarColor(userId) {
      const colors = ['var(--green)', 'var(--blue)', 'var(--amber)', 'var(--red)', 'var(--purple)', 'var(--red)', 'var(--blue)', 'var(--green)'];
      return colors[userId % colors.length];
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function formatMessageWithMentions(text, isOwnMessage) {
      // First escape HTML
      let html = escapeHtml(text);
      
      // Then highlight @mentions
      html = html.replace(/@([A-Za-z\u10A0-\u10FF]+ ?[A-Za-z\u10A0-\u10FF]*)/g, function(match, name) {
        const mentionStyle = isOwnMessage 
          ? 'background:rgba(255,255,255,0.2);padding:2px 6px;border-radius:4px;font-weight:600' 
          : 'background:rgba(34,197,94,0.15);color:var(--green);padding:2px 6px;border-radius:4px;font-weight:600';
        return '<span style="' + mentionStyle + '">@' + name + '</span>';
      });
      
      return html;
    }
    
    function extractMentions(message) {
      const mentions = [];
      const regex = /@([A-Za-z\u10A0-\u10FF]+ ?[A-Za-z\u10A0-\u10FF]*)/g;
      let match;
      
      while ((match = regex.exec(message)) !== null) {
        const mentionName = match[1].trim();
        // Find user by name
        const user = appData.users.find(u => {
          const fullName = (u.first_name + ' ' + (u.last_name || '')).trim();
          return fullName.toLowerCase() === mentionName.toLowerCase() ||
                 u.first_name.toLowerCase() === mentionName.toLowerCase();
        });
        if (user && user.id !== currentUser.id) {
          mentions.push(user);
        }
      }
      
      return mentions;
    }
    
    // ============ CHAT FILE UPLOAD ============
    let chatPendingFiles = [];
    
    function handleChatFileSelect(event) {
      const files = Array.from(event.target.files);
      if (files.length === 0) return;
      
      // Limit file size (10MB each for Storage)
      const maxSize = 10 * 1024 * 1024;
      const validFiles = files.filter(f => {
        if (f.size > maxSize) {
          showToast('File too large (max 10MB): ' + f.name, 'error');
          return false;
        }
        return true;
      });
      
      chatPendingFiles = [...chatPendingFiles, ...validFiles].slice(0, 5); // Max 5 files
      renderChatFilePreview();
      
      // Clear input for re-selection
      event.target.value = '';
    }
    
    function renderChatFilePreview() {
      const preview = document.getElementById('chatFilePreview');
      if (!preview) return;
      
      if (chatPendingFiles.length === 0) {
        preview.style.display = 'none';
        return;
      }
      
      preview.style.display = 'block';
      preview.innerHTML = '<div style="display:flex;flex-wrap:wrap;gap:8px">' +
        chatPendingFiles.map((file, idx) => {
          const isImage = file.type.startsWith('image/');
          const icon = isImage ? '' : (file.type.includes('pdf') ? '' : '');
          const preview = isImage ? URL.createObjectURL(file) : null;
          
          return '<div style="position:relative;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:8px;display:flex;align-items:center;gap:8px">' +
            (preview ? '<img src="' + preview + '" style="width:40px;height:40px;object-fit:cover;border-radius:4px">' : '<span style="font-size:24px">' + icon + '</span>') +
            '<div style="max-width:120px;overflow:hidden">' +
            '<div style="font-size:12px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + file.name + '</div>' +
            '<div style="font-size:10px;color:var(--text-muted)">' + formatFileSize(file.size) + '</div>' +
            '</div>' +
            '<button onclick="removeChatPendingFile(' + idx + ')" style="position:absolute;top:-6px;right:-6px;width:20px;height:20px;border-radius:50%;background:var(--red);color:white;border:none;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center"></button>' +
            '</div>';
        }).join('') +
        '</div>';
    }
    
    function removeChatPendingFile(idx) {
      chatPendingFiles.splice(idx, 1);
      renderChatFilePreview();
    }
    
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    async function uploadChatFile(file) {
      const timestamp = Date.now();
      const ext = file.name.split('.').pop();
      const fileName = `chat_${currentUser.id}_${timestamp}.${ext}`;
      
      try {
        // Upload to Supabase Storage
        const { data, error } = await sb.storage
          .from('chatfiles')
          .upload(fileName, file, {
            cacheControl: '3600',
            upsert: true
          });
        
        if (error) {
          console.error('Storage upload error:', error);
          throw new Error(error.message || 'Storage upload failed');
        }
        
        const { data: urlData } = sb.storage
          .from('chatfiles')
          .getPublicUrl(fileName);
        
        return {
          url: urlData.publicUrl,
          name: file.name,
          type: file.type,
          size: file.size
        };
      } catch (storageError) {
        console.error('Upload failed:', storageError);
        
        // Base64 fallback for small files (under 500KB)
        const maxBase64Size = 500 * 1024;
        if (file.size <= maxBase64Size) {
          showToast('Storage failed, using base64', 'warning');
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
              resolve({
                url: reader.result,
                name: file.name,
                type: file.type,
                size: file.size,
                isBase64: true
              });
            };
            reader.onerror = () => reject(new Error('Failed to read file'));
            reader.readAsDataURL(file);
          });
        }
        
        throw storageError;
      }
    }
    
    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      
      // Need either message or files
      if (!message && chatPendingFiles.length === 0) return;
      
      // Disable input while sending
      input.disabled = true;
      
      try {
        const senderName = currentUser.first_name + ' ' + (currentUser.last_name || '');
        
        // Upload files first
        let fileAttachments = [];
        if (chatPendingFiles.length > 0) {
          showToast('Uploading files...', 'info');
          
          for (const file of chatPendingFiles) {
            try {
              const uploaded = await uploadChatFile(file);
              fileAttachments.push(uploaded);
            } catch (e) {
              showToast('Upload failed: ' + file.name, 'error');
            }
          }
        }
        
        const msgData = {
          user_id: currentUser.id,
          user_name: senderName,
          user_role: currentUser.role,
          message: message || '',
          file_attachments: fileAttachments.length > 0 ? JSON.stringify(fileAttachments) : null
        };
        
        const newMsg = await dbInsert('chat_messages', msgData);
        
        // Extract mentions and create notifications
        const mentionedUsers = extractMentions(message);
        for (const user of mentionedUsers) {
          try {
            await dbInsert('notifications', {
              user_id: user.id,
              type: 'MENTION',
              title: senderName + ' mentioned you',
              message: message.substring(0, 100) + (message.length > 100 ? '...' : ''),
              link: 'team_chat',
              is_read: false
            });
          } catch (e) {
            console.error('Failed to create notification:', e);
          }
        }
        
        // Add to local list and render
        chatMessages.push(newMsg);
        lastMessageId = newMsg.id;
        renderChatMessages();
        
        // Clear input and files
        input.value = '';
        input.style.height = '48px';
        chatPendingFiles = [];
        renderChatFilePreview();
        
        // Log activity
        await logActivity('CHAT_MESSAGE_SENT', { 
          message_preview: message.substring(0, 50), 
          mentions: mentionedUsers.map(u => u.first_name).join(', '),
          files: fileAttachments.length 
        });
        
        if (fileAttachments.length > 0) {
          showToast('Sent!');
        }
        
      } catch (e) {
        showToast('Failed to send message: ' + e.message, 'error');
      } finally {
        input.disabled = false;
        input.focus();
      }
    }
    
    // ============ MOBILE SWIPE ACTIONS ============
    function initSwipeActions(element, options = {}) {
      if (!element) return;
      
      let startX = 0;
      let currentX = 0;
      let isDragging = false;
      const threshold = 80;
      
      const content = element.querySelector('.swipe-content') || element;
      
      element.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        isDragging = true;
        content.style.transition = 'none';
      }, { passive: true });
      
      element.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        currentX = e.touches[0].clientX - startX;
        
        // Limit swipe distance
        const maxSwipe = 160;
        if (currentX > maxSwipe) currentX = maxSwipe;
        if (currentX < -maxSwipe) currentX = -maxSwipe;
        
        content.style.transform = `translateX(${currentX}px)`;
      }, { passive: true });
      
      element.addEventListener('touchend', () => {
        if (!isDragging) return;
        isDragging = false;
        content.style.transition = 'transform 0.3s ease';
        
        if (currentX > threshold && options.onSwipeRight) {
          options.onSwipeRight();
        } else if (currentX < -threshold && options.onSwipeLeft) {
          options.onSwipeLeft();
        }
        
        // Reset position
        content.style.transform = 'translateX(0)';
        currentX = 0;
      });
    }
    
    // ============ BOTTOM SHEET MENU ============
    let currentBottomSheet = null;
    
    function showBottomSheet(items, title = '') {
      // Remove existing
      closeBottomSheet();
      
      const overlay = document.createElement('div');
      overlay.className = 'bottom-sheet-overlay';
      overlay.onclick = (e) => {
        if (e.target === overlay) closeBottomSheet();
      };
      
      let itemsHtml = items.map(item => {
        if (item.divider) {
          return '<div class="bottom-sheet-divider"></div>';
        }
        return '<button class="bottom-sheet-item ' + (item.danger ? 'bottom-sheet-item-danger' : '') + '" onclick="' + item.action + ';closeBottomSheet()">' +
          '<span class="bottom-sheet-item-icon">' + item.icon + '</span>' +
          '<span>' + item.label + '</span></button>';
      }).join('');
      
      overlay.innerHTML = '<div class="bottom-sheet">' +
        (title ? '<div style="padding:16px 24px 8px;font-weight:600;font-size:14px;color:var(--text-muted)">' + title + '</div>' : '') +
        itemsHtml +
        '</div>';
      
      document.body.appendChild(overlay);
      currentBottomSheet = overlay;
      
      // Trigger animation
      requestAnimationFrame(() => {
        overlay.classList.add('open');
      });
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }
    
    function closeBottomSheet() {
      if (currentBottomSheet) {
        currentBottomSheet.classList.remove('open');
        setTimeout(() => {
          currentBottomSheet?.remove();
          currentBottomSheet = null;
        }, 300);
        document.body.style.overflow = '';
      }
    }
    
    // ============ MOBILE ACTION SHEET HELPER ============
    function showMobileActions(entityType, entityId, entityName) {
      const isMobile = window.innerWidth <= 768;
      if (!isMobile) return false; // Let desktop handle normally
      
      const actions = [];
      
      switch(entityType) {
        case 'trip':
          actions.push(
            { icon: '', label: 'View', action: 'openTripView(' + entityId + ')' },
            { icon: '', label: 'Edit', action: 'editTrip(' + entityId + ')' },
            { icon: '', label: 'Add Vehicle', action: 'addVehicleToTrip(' + entityId + ')' },
            { divider: true },
            { icon: '', label: 'Delete', action: 'deleteTrip(' + entityId + ')', danger: true }
          );
          break;
        case 'driver':
          actions.push(
            { icon: '', label: 'View', action: 'viewDriver(' + entityId + ')' },
            { icon: '', label: 'Edit', action: 'editDriver(' + entityId + ')' },
            { icon: '', label: 'Call', action: 'callDriver(' + entityId + ')' },
            { divider: true },
            { icon: '', label: 'Delete', action: 'deleteDriver(' + entityId + ')', danger: true }
          );
          break;
        case 'truck':
          actions.push(
            { icon: '', label: 'View', action: 'viewTruck(' + entityId + ')' },
            { icon: '', label: 'Edit', action: 'editTruck(' + entityId + ')' },
            { icon: '', label: 'Maintenance', action: 'addMaintenanceForTruck(' + entityId + ')' },
            { divider: true },
            { icon: '', label: 'Delete', action: 'deleteTruck(' + entityId + ')', danger: true }
          );
          break;
        case 'order':
          actions.push(
            { icon: '', label: 'Edit', action: 'editVehicle(' + entityId + ')' },
            { icon: '', label: 'Move to Trip', action: 'moveVehicleToTrip(' + entityId + ')' },
            { divider: true },
            { icon: '', label: 'Delete', action: 'deleteOrder(' + entityId + ')', danger: true }
          );
          break;
        case 'task':
          actions.push(
            { icon: '', label: 'Complete', action: 'toggleTaskComplete(' + entityId + ')' },
            { icon: '', label: 'Edit', action: 'editTask(' + entityId + ')' },
            { divider: true },
            { icon: '', label: 'Delete', action: 'deleteTask(' + entityId + ')', danger: true }
          );
          break;
        case 'chat':
          actions.push(
            { icon: '', label: 'Copy', action: 'copyMessage(' + entityId + ')' },
            { icon: '', label: 'Reply', action: 'replyToMessage(' + entityId + ')' }
          );
          break;
        default:
          return false;
      }
      
      showBottomSheet(actions, entityName);
      return true;
    }
    
    // ============ FLOATING ACTION BUTTON ============
    function addFloatingActionButton(page, action, icon = '+') {
      // Remove existing FAB
      document.querySelector('.fab')?.remove();
      
      if (window.innerWidth > 768) return; // Only on mobile
      
      const fab = document.createElement('button');
      fab.className = 'fab';
      fab.innerHTML = icon;
      fab.onclick = action;
      document.body.appendChild(fab);
      document.body.classList.add('has-fab');
    }
    
    function removeFloatingActionButton() {
      document.querySelector('.fab')?.remove();
      document.body.classList.remove('has-fab');
    }
    
    // ============ CALL DRIVER FUNCTION ============
    function callDriver(driverId) {
      const driver = appData.drivers.find(d => d.id === driverId);
      if (driver && driver.phone) {
        window.location.href = 'tel:' + driver.phone.replace(/[^0-9+]/g, '');
      } else {
        showToast('No phone number', 'error');
      }
    }
    
    function copyMessage(messageId) {
      const msg = chatMessages.find(m => m.id === messageId);
      if (msg) {
        navigator.clipboard.writeText(msg.message);
        showToast('Copied!');
      }
    }
    
    function replyToMessage(messageId) {
      const msg = chatMessages.find(m => m.id === messageId);
      if (msg) {
        const input = document.getElementById('chatInput');
        if (input) {
          input.value = '@' + msg.user_name + ' ';
          input.focus();
        }
      }
    }

    // ============ EXCEL EXPORT ============
    let xlsxLoaded = false;
    
    async function loadXLSX() {
      if (xlsxLoaded) return true;
      return new Promise((resolve) => {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        script.onload = () => {
          xlsxLoaded = true;
          resolve(true);
        };
        script.onerror = () => resolve(false);
        document.head.appendChild(script);
      });
    }
    
    async function exportToExcel(data, filename, sheetName = 'Sheet1') {
      showToast('Preparing export...', 'info');
      
      const loaded = await loadXLSX();
      if (!loaded) {
        showToast('Failed to load export library', 'error');
        return;
      }
      
      try {
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, sheetName);
        
        // Auto-size columns
        const colWidths = Object.keys(data[0] || {}).map(key => ({
          wch: Math.max(key.length, ...data.map(row => String(row[key] || '').length))
        }));
        ws['!cols'] = colWidths;
        
        XLSX.writeFile(wb, filename + '.xlsx');
        showToast('Export successful!');
        
        await logActivity('DATA_EXPORTED', { filename, records: data.length });
      } catch (e) {
        showToast('Export failed: ' + e.message, 'error');
      }
    }
    
    function exportTrips() {
      const data = appData.trips.map(t => {
        const truck = appData.trucks.find(tr => tr.id === t.truck_id);
        const driver = appData.drivers.find(d => d.id === t.driver_id);
        const f = getTripFin(t.id);
        return {
          'Trip #': t.trip_number || t.id,
          'Status': t.status,
          'Truck': truck ? '#' + truck.truck_number : '',
          'Driver': driver ? driver.name : '',
          'Origin': t.origin || '',
          'Destination': t.destination || '',
          'Miles': t.miles || 0,
          'Load Revenue': f.loadRevenue,
          'Broker Fee': f.brokerFee,
          'Driver Cut': f.driverCut,
          'Expenses': f.totalExpenses,
          'Net Profit': f.netProfit,
          'Vehicles': f.vehicleCount,
          'Start Date': t.start_date || '',
          'End Date': t.end_date || '',
          'Notes': t.notes || ''
        };
      });
      exportToExcel(data, 'trips_export_' + new Date().toISOString().split('T')[0], 'Trips');
    }
    
    function exportOrders() {
      const data = appData.orders.map(o => {
        const trip = appData.trips.find(t => t.id === o.trip_id);
        const broker = appData.brokers.find(b => b.id === o.broker_id);
        const dispatcher = appData.dispatchers.find(d => d.id === o.dispatcher_id);
        return {
          'Order #': o.order_number || o.id,
          'Status': o.status,
          'Trip #': trip ? trip.trip_number || trip.id : 'Unassigned',
          'Year': o.vehicle_year || '',
          'Make': o.vehicle_make || '',
          'Model': o.vehicle_model || '',
          'VIN': o.vin || '',
          'Pickup': o.pickup_location || '',
          'Delivery': o.delivery_location || '',
          'Revenue': o.revenue || 0,
          'Broker': broker ? broker.name : '',
          'Dispatcher': dispatcher ? dispatcher.name : '',
          'Pickup Date': o.pickup_date || '',
          'Delivery Date': o.delivery_date || '',
          'Notes': o.notes || ''
        };
      });
      exportToExcel(data, 'orders_export_' + new Date().toISOString().split('T')[0], 'Orders');
    }
    
    function exportFinancials() {
      // Trip-level financials
      const tripData = appData.trips.map(t => {
        const truck = appData.trucks.find(tr => tr.id === t.truck_id);
        const f = getTripFin(t.id);
        return {
          'Trip #': t.trip_number || t.id,
          'Truck': truck ? '#' + truck.truck_number : '',
          'Load Revenue': f.loadRevenue,
          'Broker Fee': f.brokerFee,
          'Local Fees': f.localFees,
          'Driver Cut': f.driverCut,
          'Trip Expenses': f.totalExpenses,
          'Gross Profit': f.grossProfit,
          'Net Profit': f.netProfit,
          'Profit Margin %': f.loadRevenue > 0 ? ((f.netProfit / f.loadRevenue) * 100).toFixed(1) : 0,
          'Revenue/Mile': t.miles > 0 ? (f.loadRevenue / t.miles).toFixed(2) : 0,
          'Profit/Mile': t.miles > 0 ? (f.netProfit / t.miles).toFixed(2) : 0
        };
      });
      
      exportToExcel(tripData, 'financials_export_' + new Date().toISOString().split('T')[0], 'Financials');
    }
    
    function exportMaintenance() {
      const data = appData.maintenance_records.map(m => {
        const truck = appData.trucks.find(t => t.id === m.truck_id);
        return {
          'Date': m.service_date || '',
          'Truck': truck ? '#' + truck.truck_number : '',
          'Service Type': m.service_type || '',
          'Description': m.description || '',
          'Cost': m.cost || 0,
          'Vendor': m.vendor || '',
          'Mileage': m.mileage || '',
          'Next Service': m.next_service_date || '',
          'Notes': m.notes || ''
        };
      });
      exportToExcel(data, 'maintenance_export_' + new Date().toISOString().split('T')[0], 'Maintenance');
    }
    
    function exportDrivers() {
      const data = appData.drivers.map(d => {
        const tripCount = appData.trips.filter(t => t.driver_id === d.id).length;
        return {
          'Name': d.name,
          'Phone': d.phone || '',
          'Email': d.email || '',
          'License #': d.license_number || '',
          'License Exp': d.license_expiration || '',
          'Status': d.status || 'ACTIVE',
          'Pay Type': d.pay_type || '',
          'Pay Rate': d.pay_rate || '',
          'Total Trips': tripCount
        };
      });
      exportToExcel(data, 'drivers_export_' + new Date().toISOString().split('T')[0], 'Drivers');
    }
    
    function exportTrucks() {
      const data = appData.trucks.map(t => {
        const tripCount = appData.trips.filter(tr => tr.truck_id === t.id).length;
        const maintenanceCost = appData.maintenance_records
          .filter(m => m.truck_id === t.id)
          .reduce((sum, m) => sum + parseFloat(m.cost || 0), 0);
        return {
          'Truck #': t.truck_number,
          'Type': t.truck_type || '',
          'Year': t.year || '',
          'Make': t.make || '',
          'Model': t.model || '',
          'VIN': t.vin || '',
          'License Plate': t.license_plate || '',
          'Status': t.status || 'ACTIVE',
          'Total Trips': tripCount,
          'Maintenance Cost': maintenanceCost
        };
      });
      exportToExcel(data, 'trucks_export_' + new Date().toISOString().split('T')[0], 'Trucks');
    }
    
    function showExportMenu() {
      const isMobile = window.innerWidth <= 768;
      
      if (isMobile) {
        showBottomSheet([
          { icon: '', label: 'Export Trips', action: 'exportTrips()' },
          { icon: '', label: 'Export Orders', action: 'exportOrders()' },
          { icon: '', label: 'Export Financials', action: 'exportFinancials()' },
          { icon: '', label: 'Export Maintenance', action: 'exportMaintenance()' },
          { divider: true },
          { icon: '', label: 'Export Drivers', action: 'exportDrivers()' },
          { icon: '', label: 'Export Trucks', action: 'exportTrucks()' }
        ], ' Export to Excel');
      } else {
        showModal('export-modal', ' ' + 'Export to Excel',
          '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">' +
          '<button class="btn btn-secondary" onclick="exportTrips();closeModal(\'export-modal\')" style="padding:20px;display:flex;flex-direction:column;align-items:center;gap:8px"><span style="font-size:24px"></span><span>' + 'Trips' + '</span></button>' +
          '<button class="btn btn-secondary" onclick="exportOrders();closeModal(\'export-modal\')" style="padding:20px;display:flex;flex-direction:column;align-items:center;gap:8px"><span style="font-size:24px"></span><span>' + 'Orders' + '</span></button>' +
          '<button class="btn btn-secondary" onclick="exportFinancials();closeModal(\'export-modal\')" style="padding:20px;display:flex;flex-direction:column;align-items:center;gap:8px"><span style="font-size:24px"></span><span>' + 'Financials' + '</span></button>' +
          '<button class="btn btn-secondary" onclick="exportMaintenance();closeModal(\'export-modal\')" style="padding:20px;display:flex;flex-direction:column;align-items:center;gap:8px"><span style="font-size:24px"></span><span>' + 'Maintenance' + '</span></button>' +
          '<button class="btn btn-secondary" onclick="exportDrivers();closeModal(\'export-modal\')" style="padding:20px;display:flex;flex-direction:column;align-items:center;gap:8px"><span style="font-size:24px"></span><span>' + 'Drivers' + '</span></button>' +
          '<button class="btn btn-secondary" onclick="exportTrucks();closeModal(\'export-modal\')" style="padding:20px;display:flex;flex-direction:column;align-items:center;gap:8px"><span style="font-size:24px"></span><span>' + 'Trucks' + '</span></button>' +
          '</div>',
          '<button class="btn btn-secondary" onclick="closeModal(\'export-modal\')">' + 'Close' + '</button>'
        );
      }
    }

    // ============ QUICK SETUP WIZARD ============
    let wizardStep = 1;
    let wizardData = {};
    
    function openSetupWizard() {
      wizardStep = 1;
      wizardData = {
        // Insurance (annual)
        liability_insurance: '',
        cargo_insurance: '',
        physical_damage: '',
        bobtail_insurance: '',
        workers_comp: '',
        general_liability: '',
        // Permits (annual)
        mc_authority: '',
        ucr_registration: '',
        ifta_irp: '',
        state_permits: '',
        hut_2290: '',
        // Truck Payments (monthly each)
        truck_payments: [],
        // Technology (monthly)
        eld_gps: '',
        dispatch_software: '',
        load_boards: '',
        accounting_software: '',
        phones_communication: '',
        // Office (monthly)
        office_rent: '',
        truck_parking: '',
        utilities_internet: '',
        bookkeeper_cpa: '',
        bank_fees: '',
        // Other
        other_monthly: ''
      };
      
      const m = document.createElement('div');
      m.className = 'modal-overlay';
      m.id = 'setup-wizard-modal';
      m.innerHTML = getWizardHTML();
      document.body.appendChild(m);
      updateWizardStep();
    }
    
    function getWizardHTML() {
      return `
        <div class="modal" style="max-width:600px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column">
          <div class="modal-header" style="background:linear-gradient(135deg,var(--blue),var(--blue));flex-shrink:0">
            <h3 style="color:white;display:flex;align-items:center;gap:10px">
              <span style="font-size:24px"></span> Quick Setup Wizard
            </h3>
            <button class="modal-close" onclick="closeSetupWizard()" style="color:white"></button>
          </div>
          
          <!-- Progress Bar -->
          <div style="padding:16px 20px;background:var(--bg-app);border-bottom:1px solid var(--border);flex-shrink:0">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span id="wizard-step-label" style="font-weight:600;color:var(--blue)">Step 1 of 6</span>
              <span id="wizard-step-name" style="color:var(--text-muted)">Insurance</span>
            </div>
            <div style="height:8px;background:var(--border);border-radius:4px;overflow:hidden">
              <div id="wizard-progress" style="height:100%;background:linear-gradient(90deg,var(--blue),var(--blue));width:16.66%;transition:width 0.3s"></div>
            </div>
          </div>
          
          <!-- Step Content -->
          <div id="wizard-content" style="padding:20px;overflow-y:auto;flex:1">
            <!-- Dynamic content here -->
          </div>
          
          <!-- Footer -->
          <div style="padding:16px 20px;border-top:1px solid var(--border);display:flex;justify-content:space-between;gap:12px;flex-shrink:0;background:var(--bg-app)">
            <button id="wizard-back" class="btn btn-secondary" onclick="wizardBack()" style="display:none"> Back</button>
            <div style="flex:1"></div>
            <button id="wizard-skip" class="btn btn-secondary" onclick="wizardSkip()">Skip This Step</button>
            <button id="wizard-next" class="btn btn-primary" onclick="wizardNext()">Next </button>
          </div>
        </div>
      `;
    }
    
    function updateWizardStep() {
      const content = document.getElementById('wizard-content');
      const progress = document.getElementById('wizard-progress');
      const stepLabel = document.getElementById('wizard-step-label');
      const stepName = document.getElementById('wizard-step-name');
      const backBtn = document.getElementById('wizard-back');
      const nextBtn = document.getElementById('wizard-next');
      const skipBtn = document.getElementById('wizard-skip');
      
      const steps = [
        { name: 'Insurance', icon: '' },
        { name: 'Permits & Authority', icon: '' },
        { name: 'Truck Payments', icon: '' },
        { name: 'Technology', icon: '' },
        { name: 'Office & Admin', icon: '' },
        { name: 'Review & Save', icon: '' }
      ];
      
      progress.style.width = ((wizardStep / 6) * 100) + '%';
      stepLabel.textContent = 'Step ' + wizardStep + ' of 6';
      stepName.textContent = steps[wizardStep - 1].icon + ' ' + steps[wizardStep - 1].name;
      
      backBtn.style.display = wizardStep > 1 ? 'block' : 'none';
      skipBtn.style.display = wizardStep < 6 ? 'block' : 'none';
      nextBtn.textContent = wizardStep === 6 ? ' Save All' : 'Next ';
      
      // Render step content
      if (wizardStep === 1) {
        content.innerHTML = getInsuranceStepHTML();
      } else if (wizardStep === 2) {
        content.innerHTML = getPermitsStepHTML();
      } else if (wizardStep === 3) {
        content.innerHTML = getTruckPaymentsStepHTML();
      } else if (wizardStep === 4) {
        content.innerHTML = getTechnologyStepHTML();
      } else if (wizardStep === 5) {
        content.innerHTML = getOfficeStepHTML();
      } else if (wizardStep === 6) {
        content.innerHTML = getReviewStepHTML();
      }
    }
    
    function getInsuranceStepHTML() {
      return `
        <div style="margin-bottom:16px">
          <div style="background:var(--blue-dim);padding:12px 16px;border-radius:8px;margin-bottom:16px">
            <div style="font-weight:600;color:var(--blue);margin-bottom:4px"> Insurance Policies</div>
            <div style="font-size:13px;color:var(--blue)">Enter your ANNUAL premium amounts. We'll calculate monthly automatically.</div>
          </div>
          
          <div style="display:grid;gap:16px">
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Liability Insurance (Annual)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $15,000-40,000/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-liability" value="${wizardData.liability_insurance}" placeholder="e.g. 25000" style="padding-left:28px" onchange="wizardData.liability_insurance=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Cargo Insurance (Annual)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $3,000-8,000/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-cargo" value="${wizardData.cargo_insurance}" placeholder="e.g. 5000" style="padding-left:28px" onchange="wizardData.cargo_insurance=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Physical Damage (Annual)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $5,000-15,000/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-physical" value="${wizardData.physical_damage}" placeholder="e.g. 8000" style="padding-left:28px" onchange="wizardData.physical_damage=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Bobtail Insurance (Annual)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $1,200-3,600/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-bobtail" value="${wizardData.bobtail_insurance}" placeholder="e.g. 2000" style="padding-left:28px" onchange="wizardData.bobtail_insurance=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Workers Compensation (Annual)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $2,400-10,000/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-workers" value="${wizardData.workers_comp}" placeholder="e.g. 5000" style="padding-left:28px" onchange="wizardData.workers_comp=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>General Liability (Annual)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $1,200-3,600/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-general" value="${wizardData.general_liability}" placeholder="e.g. 2000" style="padding-left:28px" onchange="wizardData.general_liability=this.value">
              </div>
            </div>
          </div>
          
          <div style="margin-top:16px;padding:var(--spacing-3);background:var(--green-dim);border-radius:var(--radius);border:1px solid var(--green-dim)">
            <div style="font-size:13px;color:var(--green)">
              <strong>Monthly Insurance Total:</strong> 
              <span id="insurance-monthly-total">$0</span>
              <span style="color:var(--text-muted);margin-left:8px">(Annual  12)</span>
            </div>
          </div>
        </div>
      `;
    }
    
    function getPermitsStepHTML() {
      return `
        <div style="margin-bottom:16px">
          <div style="background:var(--amber-dim);padding:12px 16px;border-radius:8px;margin-bottom:16px">
            <div style="font-weight:600;color:var(--amber);margin-bottom:4px"> Permits & Authority</div>
            <div style="font-size:13px;color:var(--amber)">Enter ANNUAL amounts. These are typically paid yearly but we'll divide by 12 for monthly cost.</div>
          </div>
          
          <div style="display:grid;gap:16px">
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>MC Authority Renewal (Annual)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $300-600/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-mc" value="${wizardData.mc_authority}" placeholder="e.g. 500" style="padding-left:28px" onchange="wizardData.mc_authority=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>UCR Registration (Annual)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $100-600/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-ucr" value="${wizardData.ucr_registration}" placeholder="e.g. 200" style="padding-left:28px" onchange="wizardData.ucr_registration=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>IFTA + IRP (All Trucks Combined, Annual)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $2,000-5,000/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-ifta" value="${wizardData.ifta_irp}" placeholder="e.g. 3500" style="padding-left:28px" onchange="wizardData.ifta_irp=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>State Permits (CA, NY, OR, etc. - Annual)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $500-2,000/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-state" value="${wizardData.state_permits}" placeholder="e.g. 1000" style="padding-left:28px" onchange="wizardData.state_permits=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>HUT/2290 Heavy Use Tax (Annual)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $550-1,200/yr</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-hut" value="${wizardData.hut_2290}" placeholder="e.g. 800" style="padding-left:28px" onchange="wizardData.hut_2290=this.value">
              </div>
            </div>
          </div>
          
          <div style="margin-top:16px;padding:var(--spacing-3);background:var(--green-dim);border-radius:var(--radius);border:1px solid var(--green-dim)">
            <div style="font-size:13px;color:var(--green)">
              <strong>Monthly Permits Total:</strong> 
              <span id="permits-monthly-total">$0</span>
            </div>
          </div>
        </div>
      `;
    }
    
    function getTruckPaymentsStepHTML() {
      const numTrucks = appData.trucks?.length || 4;
      let trucksHTML = '';
      
      for (let i = 0; i < Math.max(numTrucks, 1); i++) {
        const truck = appData.trucks?.[i];
        const truckLabel = truck ? 'Truck #' + truck.truck_number : 'Truck ' + (i + 1);
        const savedValue = wizardData.truck_payments[i] || '';
        
        trucksHTML += `
          <div class="form-group">
            <label style="display:flex;justify-content:space-between">
              <span>${truckLabel} - Monthly Payment</span>
              <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $1,500-3,000/mo</span>
            </label>
            <div style="position:relative">
              <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
              <input type="number" class="truck-payment-input" data-index="${i}" value="${savedValue}" placeholder="e.g. 2500" style="padding-left:28px" onchange="wizardData.truck_payments[${i}]=this.value">
            </div>
          </div>
        `;
      }
      
      return `
        <div style="margin-bottom:16px">
          <div style="background:var(--blue-dim);padding:12px 16px;border-radius:8px;margin-bottom:16px">
            <div style="font-weight:600;color:var(--blue);margin-bottom:4px"> Truck & Trailer Payments</div>
            <div style="font-size:13px;color:var(--blue)">Enter MONTHLY payment for each truck (loan or lease). Leave blank if owned outright.</div>
          </div>
          
          <div style="display:grid;gap:16px">
            ${trucksHTML}
            
            <div class="form-group" style="border-top:1px dashed var(--border);padding-top:16px">
              <label style="display:flex;justify-content:space-between">
                <span>Trailer Payments (All Trailers Combined, Monthly)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">If separate from truck</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-trailers" value="${wizardData.trailer_payments || ''}" placeholder="e.g. 1500" style="padding-left:28px" onchange="wizardData.trailer_payments=this.value">
              </div>
            </div>
          </div>
          
          <div style="margin-top:16px;padding:var(--spacing-3);background:var(--green-dim);border-radius:var(--radius);border:1px solid var(--green-dim)">
            <div style="font-size:13px;color:var(--green)">
              <strong>Monthly Truck/Trailer Payments:</strong> 
              <span id="trucks-monthly-total">$0</span>
            </div>
          </div>
        </div>
      `;
    }
    
    function getTechnologyStepHTML() {
      return `
        <div style="margin-bottom:16px">
          <div style="background:var(--purple-dim);padding:12px 16px;border-radius:8px;margin-bottom:16px">
            <div style="font-weight:600;color:var(--purple);margin-bottom:4px"> Technology & Software</div>
            <div style="font-size:13px;color:var(--purple)">Enter MONTHLY subscription/service costs.</div>
          </div>
          
          <div style="display:grid;gap:16px">
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>ELD + GPS Tracking (All Trucks, Monthly)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $100-200/mo total</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-eld" value="${wizardData.eld_gps}" placeholder="e.g. 150" style="padding-left:28px" onchange="wizardData.eld_gps=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Dispatch Software / TMS (Monthly)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $50-300/mo</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-dispatch" value="${wizardData.dispatch_software}" placeholder="e.g. 150" style="padding-left:28px" onchange="wizardData.dispatch_software=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Load Boards (CD, Super Dispatch, etc. Monthly)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $40-150/mo</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-loadboards" value="${wizardData.load_boards}" placeholder="e.g. 100" style="padding-left:28px" onchange="wizardData.load_boards=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Accounting Software (Monthly)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $25-80/mo</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-accounting" value="${wizardData.accounting_software}" placeholder="e.g. 50" style="padding-left:28px" onchange="wizardData.accounting_software=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Phones & Communication (Monthly)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $50-200/mo</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-phones" value="${wizardData.phones_communication}" placeholder="e.g. 100" style="padding-left:28px" onchange="wizardData.phones_communication=this.value">
              </div>
            </div>
          </div>
          
          <div style="margin-top:16px;padding:var(--spacing-3);background:var(--green-dim);border-radius:var(--radius);border:1px solid var(--green-dim)">
            <div style="font-size:13px;color:var(--green)">
              <strong>Monthly Technology Total:</strong> 
              <span id="tech-monthly-total">$0</span>
            </div>
          </div>
        </div>
      `;
    }
    
    function getOfficeStepHTML() {
      return `
        <div style="margin-bottom:16px">
          <div style="background:var(--red-dim);padding:12px 16px;border-radius:8px;margin-bottom:16px">
            <div style="font-weight:600;color:var(--red);margin-bottom:4px"> Office & Admin</div>
            <div style="font-size:13px;color:var(--red)">Enter MONTHLY costs. Enter 0 if working from home.</div>
          </div>
          
          <div style="display:grid;gap:16px">
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Office Rent (Monthly)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">$0 if home office</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-office" value="${wizardData.office_rent}" placeholder="e.g. 0" style="padding-left:28px" onchange="wizardData.office_rent=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Truck Parking / Yard (All Trucks, Monthly)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $400-1,200/mo</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-parking" value="${wizardData.truck_parking}" placeholder="e.g. 600" style="padding-left:28px" onchange="wizardData.truck_parking=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Utilities & Internet (Monthly)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $100-300/mo</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-utilities" value="${wizardData.utilities_internet}" placeholder="e.g. 150" style="padding-left:28px" onchange="wizardData.utilities_internet=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Bookkeeper / CPA (Monthly)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $200-500/mo</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-cpa" value="${wizardData.bookkeeper_cpa}" placeholder="e.g. 300" style="padding-left:28px" onchange="wizardData.bookkeeper_cpa=this.value">
              </div>
            </div>
            
            <div class="form-group">
              <label style="display:flex;justify-content:space-between">
                <span>Bank Fees (Monthly)</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Typical: $20-100/mo</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-bank" value="${wizardData.bank_fees}" placeholder="e.g. 50" style="padding-left:28px" onchange="wizardData.bank_fees=this.value">
              </div>
            </div>
            
            <div class="form-group" style="border-top:1px dashed var(--border);padding-top:16px">
              <label style="display:flex;justify-content:space-between">
                <span>Other Monthly Costs</span>
                <span style="font-size:var(--text-xs);color:var(--text-muted)">Anything else recurring</span>
              </label>
              <div style="position:relative">
                <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-muted)">$</span>
                <input type="number" id="wiz-other" value="${wizardData.other_monthly}" placeholder="e.g. 200" style="padding-left:28px" onchange="wizardData.other_monthly=this.value">
              </div>
            </div>
          </div>
          
          <div style="margin-top:16px;padding:var(--spacing-3);background:var(--green-dim);border-radius:var(--radius);border:1px solid var(--green-dim)">
            <div style="font-size:13px;color:var(--green)">
              <strong>Monthly Office/Admin Total:</strong> 
              <span id="office-monthly-total">$0</span>
            </div>
          </div>
        </div>
      `;
    }
    
    function getReviewStepHTML() {
      // Calculate totals
      const insurance = (
        (parseFloat(wizardData.liability_insurance) || 0) +
        (parseFloat(wizardData.cargo_insurance) || 0) +
        (parseFloat(wizardData.physical_damage) || 0) +
        (parseFloat(wizardData.bobtail_insurance) || 0) +
        (parseFloat(wizardData.workers_comp) || 0) +
        (parseFloat(wizardData.general_liability) || 0)
      ) / 12;
      
      const permits = (
        (parseFloat(wizardData.mc_authority) || 0) +
        (parseFloat(wizardData.ucr_registration) || 0) +
        (parseFloat(wizardData.ifta_irp) || 0) +
        (parseFloat(wizardData.state_permits) || 0) +
        (parseFloat(wizardData.hut_2290) || 0)
      ) / 12;
      
      const trucks = (wizardData.truck_payments || []).reduce((s, v) => s + (parseFloat(v) || 0), 0) + (parseFloat(wizardData.trailer_payments) || 0);
      
      const tech = (
        (parseFloat(wizardData.eld_gps) || 0) +
        (parseFloat(wizardData.dispatch_software) || 0) +
        (parseFloat(wizardData.load_boards) || 0) +
        (parseFloat(wizardData.accounting_software) || 0) +
        (parseFloat(wizardData.phones_communication) || 0)
      );
      
      const office = (
        (parseFloat(wizardData.office_rent) || 0) +
        (parseFloat(wizardData.truck_parking) || 0) +
        (parseFloat(wizardData.utilities_internet) || 0) +
        (parseFloat(wizardData.bookkeeper_cpa) || 0) +
        (parseFloat(wizardData.bank_fees) || 0) +
        (parseFloat(wizardData.other_monthly) || 0)
      );
      
      const total = insurance + permits + trucks + tech + office;
      
      return `
        <div style="margin-bottom:16px">
          <div style="background:var(--green-dim);padding:12px 16px;border-radius:8px;margin-bottom:16px">
            <div style="font-weight:600;color:var(--green);margin-bottom:4px"> Review & Save</div>
            <div style="font-size:13px;color:var(--green)">Review your monthly fixed costs. Click "Save All" to add these to your TMS.</div>
          </div>
          
          <div style="background:var(--bg-app);border-radius:12px;padding:20px;border:1px solid var(--border)">
            <table style="width:100%;border-collapse:collapse">
              <tr style="border-bottom:1px solid var(--border)">
                <td style="padding:12px 0;font-weight:500"> Insurance</td>
                <td style="padding:12px 0;text-align:right;font-weight:600;color:var(--blue)">${formatMoney(insurance)}/mo</td>
              </tr>
              <tr style="border-bottom:1px solid var(--border)">
                <td style="padding:12px 0;font-weight:500"> Permits & Authority</td>
                <td style="padding:12px 0;text-align:right;font-weight:600;color:var(--blue)">${formatMoney(permits)}/mo</td>
              </tr>
              <tr style="border-bottom:1px solid var(--border)">
                <td style="padding:12px 0;font-weight:500"> Truck/Trailer Payments</td>
                <td style="padding:12px 0;text-align:right;font-weight:600;color:var(--blue)">${formatMoney(trucks)}/mo</td>
              </tr>
              <tr style="border-bottom:1px solid var(--border)">
                <td style="padding:12px 0;font-weight:500"> Technology</td>
                <td style="padding:12px 0;text-align:right;font-weight:600;color:var(--blue)">${formatMoney(tech)}/mo</td>
              </tr>
              <tr style="border-bottom:2px solid var(--blue)">
                <td style="padding:12px 0;font-weight:500"> Office & Admin</td>
                <td style="padding:12px 0;text-align:right;font-weight:600;color:var(--blue)">${formatMoney(office)}/mo</td>
              </tr>
              <tr style="background:var(--blue);color:white">
                <td style="padding:16px 12px;font-weight:700;font-size:16px;border-radius:0 0 0 8px">TOTAL MONTHLY FIXED COSTS</td>
                <td style="padding:16px 12px;text-align:right;font-weight:700;font-size:20px;border-radius:0 0 8px 0">${formatMoney(total)}/mo</td>
              </tr>
            </table>
          </div>
          
          <div style="margin-top:16px;padding:12px;background:var(--amber-dim);border-radius:8px;border:1px solid var(--amber)">
            <div style="font-size:13px;color:var(--amber)">
              <strong> What happens next:</strong> We'll create individual line items in your Fixed Costs page. You can edit them anytime.
            </div>
          </div>
        </div>
      `;
    }
    
    function saveCurrentStepData() {
      // Save data from current step inputs
      if (wizardStep === 1) {
        wizardData.liability_insurance = document.getElementById('wiz-liability')?.value || '';
        wizardData.cargo_insurance = document.getElementById('wiz-cargo')?.value || '';
        wizardData.physical_damage = document.getElementById('wiz-physical')?.value || '';
        wizardData.bobtail_insurance = document.getElementById('wiz-bobtail')?.value || '';
        wizardData.workers_comp = document.getElementById('wiz-workers')?.value || '';
        wizardData.general_liability = document.getElementById('wiz-general')?.value || '';
      } else if (wizardStep === 2) {
        wizardData.mc_authority = document.getElementById('wiz-mc')?.value || '';
        wizardData.ucr_registration = document.getElementById('wiz-ucr')?.value || '';
        wizardData.ifta_irp = document.getElementById('wiz-ifta')?.value || '';
        wizardData.state_permits = document.getElementById('wiz-state')?.value || '';
        wizardData.hut_2290 = document.getElementById('wiz-hut')?.value || '';
      } else if (wizardStep === 3) {
        document.querySelectorAll('.truck-payment-input').forEach((input, i) => {
          wizardData.truck_payments[i] = input.value;
        });
        wizardData.trailer_payments = document.getElementById('wiz-trailers')?.value || '';
      } else if (wizardStep === 4) {
        wizardData.eld_gps = document.getElementById('wiz-eld')?.value || '';
        wizardData.dispatch_software = document.getElementById('wiz-dispatch')?.value || '';
        wizardData.load_boards = document.getElementById('wiz-loadboards')?.value || '';
        wizardData.accounting_software = document.getElementById('wiz-accounting')?.value || '';
        wizardData.phones_communication = document.getElementById('wiz-phones')?.value || '';
      } else if (wizardStep === 5) {
        wizardData.office_rent = document.getElementById('wiz-office')?.value || '';
        wizardData.truck_parking = document.getElementById('wiz-parking')?.value || '';
        wizardData.utilities_internet = document.getElementById('wiz-utilities')?.value || '';
        wizardData.bookkeeper_cpa = document.getElementById('wiz-cpa')?.value || '';
        wizardData.bank_fees = document.getElementById('wiz-bank')?.value || '';
        wizardData.other_monthly = document.getElementById('wiz-other')?.value || '';
      }
    }
    
    function wizardNext() {
      saveCurrentStepData();
      
      if (wizardStep === 6) {
        saveWizardData();
      } else {
        wizardStep++;
        updateWizardStep();
      }
    }
    
    function wizardBack() {
      saveCurrentStepData();
      if (wizardStep > 1) {
        wizardStep--;
        updateWizardStep();
      }
    }
    
    function wizardSkip() {
      wizardStep++;
      updateWizardStep();
    }
    
    async function saveWizardData() {
      const fixedCosts = [];
      
      // Insurance (annual  12)
      if (wizardData.liability_insurance) fixedCosts.push({ name: 'Liability Insurance', amount: parseFloat(wizardData.liability_insurance) / 12 });
      if (wizardData.cargo_insurance) fixedCosts.push({ name: 'Cargo Insurance', amount: parseFloat(wizardData.cargo_insurance) / 12 });
      if (wizardData.physical_damage) fixedCosts.push({ name: 'Physical Damage Insurance', amount: parseFloat(wizardData.physical_damage) / 12 });
      if (wizardData.bobtail_insurance) fixedCosts.push({ name: 'Bobtail Insurance', amount: parseFloat(wizardData.bobtail_insurance) / 12 });
      if (wizardData.workers_comp) fixedCosts.push({ name: 'Workers Compensation', amount: parseFloat(wizardData.workers_comp) / 12 });
      if (wizardData.general_liability) fixedCosts.push({ name: 'General Liability', amount: parseFloat(wizardData.general_liability) / 12 });
      
      // Permits (annual  12)
      if (wizardData.mc_authority) fixedCosts.push({ name: 'MC Authority', amount: parseFloat(wizardData.mc_authority) / 12 });
      if (wizardData.ucr_registration) fixedCosts.push({ name: 'UCR Registration', amount: parseFloat(wizardData.ucr_registration) / 12 });
      if (wizardData.ifta_irp) fixedCosts.push({ name: 'IFTA + IRP', amount: parseFloat(wizardData.ifta_irp) / 12 });
      if (wizardData.state_permits) fixedCosts.push({ name: 'State Permits', amount: parseFloat(wizardData.state_permits) / 12 });
      if (wizardData.hut_2290) fixedCosts.push({ name: 'HUT/2290 Tax', amount: parseFloat(wizardData.hut_2290) / 12 });
      
      // Truck payments (already monthly)
      (wizardData.truck_payments || []).forEach((payment, i) => {
        if (payment) {
          const truck = appData.trucks?.[i];
          const label = truck ? 'Truck #' + truck.truck_number + ' Payment' : 'Truck ' + (i + 1) + ' Payment';
          fixedCosts.push({ name: label, amount: parseFloat(payment) });
        }
      });
      if (wizardData.trailer_payments) fixedCosts.push({ name: 'Trailer Payments', amount: parseFloat(wizardData.trailer_payments) });
      
      // Technology (already monthly)
      if (wizardData.eld_gps) fixedCosts.push({ name: 'ELD + GPS Tracking', amount: parseFloat(wizardData.eld_gps) });
      if (wizardData.dispatch_software) fixedCosts.push({ name: 'Dispatch Software', amount: parseFloat(wizardData.dispatch_software) });
      if (wizardData.load_boards) fixedCosts.push({ name: 'Load Boards', amount: parseFloat(wizardData.load_boards) });
      if (wizardData.accounting_software) fixedCosts.push({ name: 'Accounting Software', amount: parseFloat(wizardData.accounting_software) });
      if (wizardData.phones_communication) fixedCosts.push({ name: 'Phones & Communication', amount: parseFloat(wizardData.phones_communication) });
      
      // Office (already monthly)
      if (wizardData.office_rent) fixedCosts.push({ name: 'Office Rent', amount: parseFloat(wizardData.office_rent) });
      if (wizardData.truck_parking) fixedCosts.push({ name: 'Truck Parking/Yard', amount: parseFloat(wizardData.truck_parking) });
      if (wizardData.utilities_internet) fixedCosts.push({ name: 'Utilities & Internet', amount: parseFloat(wizardData.utilities_internet) });
      if (wizardData.bookkeeper_cpa) fixedCosts.push({ name: 'Bookkeeper/CPA', amount: parseFloat(wizardData.bookkeeper_cpa) });
      if (wizardData.bank_fees) fixedCosts.push({ name: 'Bank Fees', amount: parseFloat(wizardData.bank_fees) });
      if (wizardData.other_monthly) fixedCosts.push({ name: 'Other Monthly Costs', amount: parseFloat(wizardData.other_monthly) });
      
      if (fixedCosts.length === 0) {
        showToast('No costs to save', 'error');
        return;
      }
      
      try {
        // Save each fixed cost
        let saved = 0;
        for (const cost of fixedCosts) {
          await dbInsert('fixed_costs', cost);
          saved++;
        }
        
        closeSetupWizard();
        showToast(' Saved ' + saved + ' fixed costs!', 'success');
        await loadAllData(true);
        renderPage();
      } catch (e) {
        showToast('Error saving: ' + e.message, 'error');
      }
    }
    
    function closeSetupWizard() {
      document.getElementById('setup-wizard-modal')?.remove();
    }

    function cleanupChat() {
      if (chatRefreshInterval) {
        clearInterval(chatRefreshInterval);
        chatRefreshInterval = null;
      }
    }

    // ============ MINI CHAT WIDGET ============
    function initMiniChat() {
      // Don't show on team_chat page
      if (currentPage === 'team_chat') {
        document.body.classList.add('on-team-chat');
        return;
      }
      document.body.classList.remove('on-team-chat');
      
      // Remove existing mini chat elements
      document.querySelector('.mini-chat-bubble')?.remove();
      document.querySelector('.mini-chat-window')?.remove();
      
      // Create chat bubble
      const bubble = document.createElement('button');
      bubble.className = 'mini-chat-bubble';
      bubble.innerHTML = '' + (unreadChatCount > 0 ? '<span class="badge">' + (unreadChatCount > 99 ? '99+' : unreadChatCount) + '</span>' : '');
      bubble.onclick = toggleMiniChat;
      document.body.appendChild(bubble);
      
      // Start checking for new messages
      startMiniChatPolling();
    }
    
    function toggleMiniChat() {
      if (miniChatOpen) {
        closeMiniChat();
      } else {
        openMiniChat();
      }
    }
    
    function openMiniChat() {
      miniChatOpen = true;
      
      // Mark messages as seen
      if (chatMessages.length > 0) {
        lastSeenChatId = chatMessages[chatMessages.length - 1].id;
        localStorage.setItem('lastSeenChatId', lastSeenChatId.toString());
        unreadChatCount = 0;
        updateChatBadges();
      }
      
      const window = document.createElement('div');
      window.className = 'mini-chat-window';
      window.innerHTML = 
        '<div class="mini-chat-header">' +
        '<h4> ' + 'Team Chat' + '</h4>' +
        '<div style="display:flex;gap:8px">' +
        '<button onclick="navigate(\'team_chat\');closeMiniChat()" title="' + 'Full Chat' + '"></button>' +
        '<button onclick="closeMiniChat()"></button>' +
        '</div></div>' +
        '<div class="mini-chat-messages" id="miniChatMessages"><div style="text-align:center;color:var(--text-muted);padding:20px">Loading...</div></div>' +
        '<div id="miniChatFilePreview" style="display:none;padding:8px 12px;background:var(--bg-tertiary);border-top:1px solid var(--border)"></div>' +
        '<div class="mini-chat-input-area" style="position:relative">' +
        '<div id="miniMentionDropdown" style="display:none;position:absolute;bottom:100%;left:0;right:0;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;box-shadow:0 -4px 20px rgba(0,0,0,0.15);max-height:180px;overflow-y:auto;margin-bottom:4px;z-index:100"></div>' +
        '<input type="file" id="miniChatFileInput" accept="image/*,.pdf,.doc,.docx" style="display:none" onchange="handleMiniChatFileSelect(event)">' +
        '<button onclick="document.getElementById(\'miniChatFileInput\').click()" style="width:36px;height:36px;border-radius:50%;background:var(--bg-tertiary);border:1px solid var(--border);cursor:pointer;font-size:16px" title="' + 'Attach file' + '"></button>' +
        '<input type="text" id="miniChatInput" placeholder="' + '@ to mention...' + '" oninput="handleMiniChatMention(event)" onkeydown="handleMiniChatKeydown(event)">' +
        '<button onclick="sendMiniChatMessage()"></button>' +
        '</div>';
      
      document.body.appendChild(window);
      
      // Load messages
      loadMiniChatMessages();
      
      // Focus input
      setTimeout(() => document.getElementById('miniChatInput')?.focus(), 100);
    }
    
    function closeMiniChat() {
      miniChatOpen = false;
      document.querySelector('.mini-chat-window')?.remove();
    }
    
    async function loadMiniChatMessages() {
      try {
        chatMessages = await dbFetch('chat_messages', { order: 'created_at.asc', limit: 50 }) || [];
        renderMiniChatMessages();
      } catch (e) {
        document.getElementById('miniChatMessages').innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">Chat not available</div>';
      }
    }
    
    function renderMiniChatMessages() {
      const container = document.getElementById('miniChatMessages');
      if (!container) return;
      
      if (chatMessages.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted)">No messages yet</div>';
        return;
      }
      
      container.innerHTML = chatMessages.slice(-20).map(msg => {
        const isOwn = msg.user_id === currentUser.id;
        const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        return '<div style="margin-bottom:8px;' + (isOwn ? 'text-align:right' : '') + '">' +
          '<div style="display:inline-block;max-width:80%;padding:8px 12px;border-radius:12px;' + 
          (isOwn ? 'background:var(--primary);color:white' : 'background:var(--bg-tertiary)') + '">' +
          (!isOwn ? '<div style="font-size:11px;font-weight:600;margin-bottom:2px">' + (msg.user_name || 'Unknown') + '</div>' : '') +
          '<div style="font-size:13px">' + (msg.message || '').replace(/\n/g, '<br>') + '</div>' +
          '</div>' +
          '<div style="font-size:10px;color:var(--text-muted);margin-top:2px">' + time + '</div>' +
          '</div>';
      }).join('');
      
      container.scrollTop = container.scrollHeight;
    }
    
    async function sendMiniChatMessage() {
      const input = document.getElementById('miniChatInput');
      const message = input.value.trim();
      
      if (!message && !miniChatPendingFile) return;
      
      try {
        const msgData = {
          user_id: currentUser.id,
          user_name: currentUser.first_name + ' ' + (currentUser.last_name || ''),
          message: message
        };
        
        await dbInsert('chat_messages', msgData);
        input.value = '';
        miniChatPendingFile = null;
        renderMiniChatFilePreview();
        await loadMiniChatMessages();
      } catch (e) {
        showToast('Failed to send message', 'error');
      }
    }
    
    function startMiniChatPolling() {
      if (miniChatRefreshInterval) clearInterval(miniChatRefreshInterval);
      
      miniChatRefreshInterval = setInterval(async () => {
        try {
          const newMessages = await dbFetch('chat_messages', { 
            order: 'id.desc', 
            limit: 1 
          }) || [];
          
          if (newMessages.length > 0) {
            const latestId = newMessages[0].id;
            const newCount = latestId - lastSeenChatId;
            
            if (newCount !== unreadChatCount && newCount > 0) {
              unreadChatCount = Math.max(0, newCount);
              updateChatBadges();
              
              // Play sound for new messages
              if (unreadChatCount > 0 && !miniChatOpen && currentPage !== 'team_chat') {
                playNotificationSound();
              }
            }
          }
        } catch (e) {
          // Silent fail for polling
        }
      }, 10000);
    }
    
    function stopMiniChatPolling() {
      if (miniChatRefreshInterval) {
        clearInterval(miniChatRefreshInterval);
        miniChatRefreshInterval = null;
      }
    }
    
    function updateChatBadges() {
      // Update mini chat bubble
      const bubble = document.querySelector('.mini-chat-bubble');
      if (bubble) {
        if (unreadChatCount > 0) {
          bubble.innerHTML = '<span class="badge">' + (unreadChatCount > 99 ? '99+' : unreadChatCount) + '</span>';
        } else {
          bubble.innerHTML = '';
        }
      }
      
      // Update nav badge
      const navBadge = document.getElementById('navChatBadge');
      if (unreadChatCount > 0) {
        if (navBadge) {
          navBadge.textContent = unreadChatCount > 99 ? '99+' : unreadChatCount;
          navBadge.style.display = 'flex';
        }
      } else if (navBadge) {
        navBadge.style.display = 'none';
      }
    }
    
    function renderMiniChatFilePreview() {
      const preview = document.getElementById('miniChatFilePreview');
      if (!preview) return;
      
      if (miniChatPendingFile) {
        preview.style.display = 'block';
        preview.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center">' +
          '<span style="font-size:12px"> ' + miniChatPendingFile.name + '</span>' +
          '<button onclick="miniChatPendingFile=null;renderMiniChatFilePreview()" style="background:none;border:none;cursor:pointer"></button></div>';
      } else {
        preview.style.display = 'none';
        preview.innerHTML = '';
      }
    }
    
    let miniChatPendingFile = null;
    let miniMentionStartPos = -1;
    
    function handleMiniChatMention(e) {
      const input = e.target;
      const cursorPos = input.selectionStart;
      const text = input.value;
      
      // Check for @ mention trigger
      const textBeforeCursor = text.substring(0, cursorPos);
      const atMatch = textBeforeCursor.match(/@(\w*)$/);
      
      if (atMatch) {
        miniMentionStartPos = cursorPos - atMatch[1].length - 1;
        showMiniMentionDropdown(atMatch[1]);
      } else {
        hideMiniMentionDropdown();
      }
    }
    
    function handleMiniChatKeydown(e) {
      const dropdown = document.getElementById('miniMentionDropdown');
      
      if (e.key === 'Enter') {
        if (dropdown && dropdown.style.display !== 'none') {
          // Select first mention
          const firstItem = dropdown.querySelector('.mention-item');
          if (firstItem) {
            firstItem.click();
            e.preventDefault();
            return;
          }
        }
        sendMiniChatMessage();
        e.preventDefault();
      } else if (e.key === 'Escape') {
        hideMiniMentionDropdown();
      } else if (e.key === 'Tab' && dropdown && dropdown.style.display !== 'none') {
        const firstItem = dropdown.querySelector('.mention-item');
        if (firstItem) {
          firstItem.click();
          e.preventDefault();
        }
      }
    }
    
    function showMiniMentionDropdown(query) {
      const dropdown = document.getElementById('miniMentionDropdown');
      if (!dropdown) return;
      
      const allUsers = appData.users || [];
      const filtered = query 
        ? allUsers.filter(u => 
            (u.first_name + ' ' + (u.last_name || '')).toLowerCase().includes(query.toLowerCase()) ||
            (u.email || '').toLowerCase().includes(query.toLowerCase())
          )
        : allUsers;
      
      if (filtered.length === 0) {
        dropdown.style.display = 'none';
        return;
      }
      
      dropdown.style.display = 'block';
      dropdown.innerHTML = filtered.slice(0, 6).map((u, idx) => {
        const name = u.first_name + ' ' + (u.last_name || '');
        const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const color = getAvatarColor(u.id);
        return '<div class="mention-item" onclick="selectMiniMention(' + u.id + ', \'' + name.replace(/'/g, "\\'") + '\')" style="display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;' + (idx === 0 ? 'background:var(--bg-tertiary);' : '') + '" onmouseover="this.style.background=\'var(--bg-tertiary)\'" onmouseout="this.style.background=\'' + (idx === 0 ? 'var(--bg-tertiary)' : 'transparent') + '\'">' +
          '<div style="width:28px;height:28px;border-radius:50%;background:' + color + ';color:white;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600">' + initials + '</div>' +
          '<div><div style="font-weight:500;font-size:13px">' + name + '</div>' +
          '<div style="font-size:var(--text-xs);color:var(--text-muted)">' + (u.role || 'User') + '</div></div>' +
          '</div>';
      }).join('');
    }
    
    function hideMiniMentionDropdown() {
      const dropdown = document.getElementById('miniMentionDropdown');
      if (dropdown) dropdown.style.display = 'none';
      miniMentionStartPos = -1;
    }
    
    function selectMiniMention(userId, userName) {
      const input = document.getElementById('miniChatInput');
      if (!input || miniMentionStartPos < 0) return;
      
      const before = input.value.substring(0, miniMentionStartPos);
      const after = input.value.substring(input.selectionStart);
      
      input.value = before + '@' + userName + ' ' + after;
      input.focus();
      
      const newPos = miniMentionStartPos + userName.length + 2;
      input.setSelectionRange(newPos, newPos);
      
      hideMiniMentionDropdown();
    }
    
    function handleMiniChatFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Limit file size (10MB for Storage)
      if (file.size > 10 * 1024 * 1024) {
        showToast('File too large (max 10MB)', 'error');
        return;
      }
      
      miniChatPendingFile = file;
      renderMiniChatFilePreview();
      event.target.value = '';
    }
    
    function renderMiniChatFilePreview() {
      const preview = document.getElementById('miniChatFilePreview');
      if (!preview) return;
      
      if (!miniChatPendingFile) {
        preview.style.display = 'none';
        return;
      }
      
      const isImage = miniChatPendingFile.type.startsWith('image/');
      const icon = isImage ? '' : '';
      
      preview.style.display = 'flex';
      preview.innerHTML = '<div style="display:flex;align-items:center;gap:8px;flex:1">' +
        '<span style="font-size:18px">' + icon + '</span>' +
        '<div style="flex:1;overflow:hidden"><div style="font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + miniChatPendingFile.name + '</div>' +
        '<div style="font-size:10px;color:var(--text-muted)">' + formatFileSize(miniChatPendingFile.size) + '</div></div>' +
        '<button onclick="miniChatPendingFile=null;renderMiniChatFilePreview()" style="width:24px;height:24px;border-radius:50%;background:var(--red);color:white;border:none;cursor:pointer;font-size:14px"></button>' +
        '</div>';
    }
    
    function closeMiniChat() {
      miniChatOpen = false;
      document.querySelector('.mini-chat-window')?.remove();
    }
    
    async function loadMiniChatMessages() {
      try {
        chatMessages = await dbFetch('chat_messages', { order: 'created_at.asc', limit: 50 }) || [];
        renderMiniChatMessages();
      } catch (e) {
        console.error('Failed to load mini chat messages:', e);
      }
    }
    
    function renderMiniChatMessages() {
      const container = document.getElementById('miniChatMessages');
      if (!container) return;
      
      if (chatMessages.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:40px">' + 
          'No messages yet' + '</div>';
        return;
      }
      
      // Show last 20 messages
      const recentMessages = chatMessages.slice(-20);
      
      const otherMsgBg = 'var(--bg-card)';
      const otherMsgColor = 'var(--text-primary)';
      const otherMsgBorder = '1px solid var(--border)';
      const otherMsgShadow = '0 2px 6px rgba(0,0,0,0.15)';
      const textMuted = 'var(--text-muted)';
      
      container.innerHTML = recentMessages.map(msg => {
        const isOwnMessage = msg.user_id === currentUser.id;
        const initials = msg.user_name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const color = getAvatarColor(msg.user_id);
        const time = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        // Parse file attachments
        let attachmentsHtml = '';
        if (msg.file_attachments) {
          try {
            const files = typeof msg.file_attachments === 'string' ? JSON.parse(msg.file_attachments) : msg.file_attachments;
            if (files && files.length > 0) {
              attachmentsHtml = '<div style="margin-top:6px">';
              files.forEach(file => {
                const isImage = file.type && file.type.startsWith('image/');
                if (isImage) {
                  attachmentsHtml += '<a href="' + file.url + '" target="_blank"><img src="' + file.url + '" style="max-width:150px;max-height:100px;border-radius:6px;margin-top:4px;display:block" onclick="openImageViewer(\'' + file.url + '\');event.preventDefault()"></a>';
                } else {
                  attachmentsHtml += '<a href="' + file.url + '" target="_blank" download style="display:flex;align-items:center;gap:6px;padding:6px 8px;background:' + (isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)') + ';border-radius:6px;text-decoration:none;color:inherit;font-size:11px;margin-top:4px"> ' + escapeHtml(file.name) + '</a>';
                }
              });
              attachmentsHtml += '</div>';
            }
          } catch (e) {}
        }
        
        return '<div style="display:flex;gap:8px;' + (isOwnMessage ? 'flex-direction:row-reverse' : '') + '">' +
          '<div style="width:32px;height:32px;border-radius:50%;background:' + color + ';color:white;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;flex-shrink:0">' + initials + '</div>' +
          '<div style="max-width:70%">' +
          '<div style="font-size:11px;color:' + textMuted + ';margin-bottom:2px;' + (isOwnMessage ? 'text-align:right' : '') + '">' + msg.user_name + '</div>' +
          '<div style="background:' + (isOwnMessage ? 'linear-gradient(135deg, var(--green) 0%, var(--green) 100%)' : otherMsgBg) + ';color:' + (isOwnMessage ? 'white' : otherMsgColor) + ';padding:8px 12px;border-radius:12px;font-size:13px;box-shadow:' + (isOwnMessage ? '0 2px 6px rgba(34, 197, 94, 0.3)' : otherMsgShadow) + ';border:' + (isOwnMessage ? 'none' : otherMsgBorder) + '">' +
          (msg.message ? formatMessageWithMentions(msg.message, isOwnMessage) : '') +
          attachmentsHtml +
          '<div style="font-size:10px;opacity:0.7;margin-top:4px;text-align:right">' + time + '</div>' +
          '</div></div></div>';
      }).join('');
      
      // Scroll to bottom
      container.scrollTop = container.scrollHeight;
    }
    
    async function sendMiniChatMessage() {
      const input = document.getElementById('miniChatInput');
      const message = input.value.trim();
      
      // Need either message or file
      if (!message && !miniChatPendingFile) return;
      
      input.disabled = true;
      
      try {
        const senderName = currentUser.first_name + ' ' + (currentUser.last_name || '');
        
        // Upload file if present
        let fileAttachments = [];
        if (miniChatPendingFile) {
          try {
            showToast('Uploading...', 'info');
            const uploaded = await uploadChatFile(miniChatPendingFile);
            fileAttachments.push(uploaded);
          } catch (e) {
            showToast('Upload failed', 'error');
          }
        }
        
        const msgData = {
          user_id: currentUser.id,
          user_name: senderName,
          user_role: currentUser.role,
          message: message || '',
          file_attachments: fileAttachments.length > 0 ? JSON.stringify(fileAttachments) : null
        };
        
        const newMsg = await dbInsert('chat_messages', msgData);
        
        // Extract mentions and create notifications
        const mentionedUsers = extractMentions(message);
        for (const user of mentionedUsers) {
          try {
            await dbInsert('notifications', {
              user_id: user.id,
              type: 'MENTION',
              title: senderName + ' mentioned you',
              message: message.substring(0, 100) + (message.length > 100 ? '...' : ''),
              link: 'team_chat',
              is_read: false
            });
          } catch (e) {}
        }
        
        chatMessages.push(newMsg);
        lastSeenChatId = newMsg.id;
        localStorage.setItem('lastSeenChatId', lastSeenChatId.toString());
        
        renderMiniChatMessages();
        input.value = '';
        miniChatPendingFile = null;
        renderMiniChatFilePreview();
        
        await logActivity('CHAT_MESSAGE_SENT', { message_preview: message.substring(0, 50), via: 'mini_chat', files: fileAttachments.length });
      } catch (e) {
        showToast('Failed to send message', 'error');
      } finally {
        input.disabled = false;
        input.focus();
      }
    }
    
    function startMiniChatPolling() {
      if (miniChatRefreshInterval) clearInterval(miniChatRefreshInterval);
      
      // Check for new messages every 10 seconds
      miniChatRefreshInterval = setInterval(async () => {
        try {
          const messages = await dbFetch('chat_messages', { order: 'created_at.desc', limit: 10 }) || [];
          
          if (messages.length > 0) {
            const latestId = messages[0].id;
            const newCount = messages.filter(m => m.id > lastSeenChatId && m.user_id !== currentUser.id).length;
            
            if (newCount !== unreadChatCount) {
              unreadChatCount = newCount;
              updateChatBadges();
              
              // Play sound if new messages
              if (newCount > 0 && !miniChatOpen && currentPage !== 'team_chat') {
                playNotificationSound();
              }
            }
            
            // Update messages if mini chat is open
            if (miniChatOpen) {
              chatMessages = await dbFetch('chat_messages', { order: 'created_at.asc', limit: 50 }) || [];
              renderMiniChatMessages();
            }
          }
        } catch (e) {}
      }, 10000);
    }
    
    function updateChatBadges() {
      // Update bubble badge
      const bubble = document.querySelector('.mini-chat-bubble');
      if (bubble) {
        const badge = bubble.querySelector('.badge');
        if (unreadChatCount > 0) {
          if (badge) {
            badge.textContent = unreadChatCount > 99 ? '99+' : unreadChatCount;
          } else {
            bubble.innerHTML = '<span class="badge">' + (unreadChatCount > 99 ? '99+' : unreadChatCount) + '</span>';
          }
        } else {
          bubble.innerHTML = '';
        }
      }
      
      // Update nav badge
      const navBadge = document.getElementById('navChatBadge');
      if (navBadge) {
        if (unreadChatCount > 0) {
          navBadge.textContent = unreadChatCount > 99 ? '99+' : unreadChatCount;
          navBadge.style.display = 'block';
        } else {
          navBadge.style.display = 'none';
        }
      }
      
      // Re-render nav to update badge
      renderNav();
    }
    
    function stopMiniChatPolling() {
      if (miniChatRefreshInterval) {
        clearInterval(miniChatRefreshInterval);
        miniChatRefreshInterval = null;
      }
    }

    // ============ NOTIFICATIONS SYSTEM ============
    let notifications = [];
    let notificationRefreshInterval = null;
    let previousUnreadCount = 0;
    
    function playNotificationSound() {
      try {
        // Create a simple beep sound using Web Audio API
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        gainNode.gain.value = 0.1;
        
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.15);
      } catch (e) {
        console.log('Could not play notification sound');
      }
    }
    
    async function loadNotifications() {
      try {
        const previousCount = notifications.filter(n => !n.is_read).length;
        
        notifications = await dbFetch('notifications', { 
          filter: { user_id: 'eq.' + currentUser.id },
          order: 'created_at.desc',
          limit: 50 
        }) || [];
        
        const currentUnreadCount = notifications.filter(n => !n.is_read).length;
        
        // Play sound if new notifications arrived
        if (currentUnreadCount > previousUnreadCount && previousUnreadCount > 0) {
          playNotificationSound();
          // Show toast for new notification
          const newest = notifications.find(n => !n.is_read);
          if (newest) {
            showToast(' ' + (newest.title || 'New notification'), 'info');
          }
        }
        
        previousUnreadCount = currentUnreadCount;
        updateNotificationBadge();
        renderNotificationList();
      } catch (e) {
        console.error('Failed to load notifications:', e);
        notifications = [];
      }
    }
    
    function updateNotificationBadge() {
      const badge = document.getElementById('notificationBadge');
      if (!badge) return;
      
      const unreadCount = notifications.filter(n => !n.is_read).length;
      if (unreadCount > 0) {
        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }
    
    function renderNotificationList() {
      const list = document.getElementById('notificationList');
      if (!list) return;
      
      if (notifications.length === 0) {
        list.innerHTML = '<div style="padding:40px 20px;text-align:center;color:var(--text-muted)">' +
          '<div style="font-size:32px;margin-bottom:12px"></div>' +
          '<div>' + 'No notifications' + '</div></div>';
        return;
      }
      
      list.innerHTML = notifications.map(n => {
        const timeAgo = getTimeAgo(n.created_at);
        const icon = n.type === 'MENTION' ? '' : '';
        
        return '<div class="notification-item ' + (n.is_read ? '' : 'unread') + '" onclick="handleNotificationClick(' + n.id + ', \'' + (n.link || '') + '\')">' +
          '<div class="notification-icon">' + icon + '</div>' +
          '<div class="notification-content">' +
          '<div class="notification-title">' + escapeHtml(n.title || 'Notification') + '</div>' +
          '<div class="notification-message">' + escapeHtml(n.message || '') + '</div>' +
          '<div class="notification-time">' + timeAgo + '</div>' +
          '</div></div>';
      }).join('');
    }
    
    function getTimeAgo(dateStr) {
      const now = new Date();
      const date = new Date(dateStr);
      const seconds = Math.floor((now - date) / 1000);
      
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
      return date.toLocaleDateString();
    }
    
    function toggleNotificationDropdown() {
      const dropdown = document.getElementById('notificationDropdown');
      const userDropdown = document.getElementById('userDropdown');
      
      // Close user dropdown if open
      if (userDropdown) userDropdown.classList.remove('open');
      document.querySelector('.topbar-user-wrapper')?.classList.remove('open');
      
      if (dropdown) {
        const isOpen = dropdown.classList.contains('open');
        dropdown.classList.toggle('open');
        
        // Load notifications when opening
        if (!isOpen) {
          loadNotifications();
        }
      }
    }
    
    async function handleNotificationClick(notificationId, link) {
      // Mark as read
      try {
        await dbUpdate('notifications', notificationId, { is_read: true });
        const notif = notifications.find(n => n.id === notificationId);
        if (notif) notif.is_read = true;
        updateNotificationBadge();
        renderNotificationList();
      } catch (e) {
        console.error('Failed to mark notification as read:', e);
      }
      
      // Navigate if there's a link
      if (link) {
        toggleNotificationDropdown();
        navigate(link);
      }
    }
    
    async function markAllNotificationsRead() {
      try {
        const unread = notifications.filter(n => !n.is_read);
        for (const n of unread) {
          await dbUpdate('notifications', n.id, { is_read: true });
          n.is_read = true;
        }
        updateNotificationBadge();
        renderNotificationList();
        showToast('All marked as read');
      } catch (e) {
        showToast('Failed to update', 'error');
      }
    }
    
    // Start notification polling
    function startNotificationPolling() {
      loadNotifications();
      if (notificationRefreshInterval) clearInterval(notificationRefreshInterval);
      notificationRefreshInterval = setInterval(loadNotifications, 30000); // Check every 30 seconds
    }
    
    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
      const notifWrapper = document.querySelector('.notification-wrapper');
      const notifDropdown = document.getElementById('notificationDropdown');
      
      if (notifWrapper && !notifWrapper.contains(e.target) && notifDropdown) {
        notifDropdown.classList.remove('open');
      }
    });

    function toggleApiKeyVisibility() {
      const input = document.getElementById('apiKeyInput');
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    function saveApiKey() {
      const key = document.getElementById('apiKeyInput').value.trim();
      if (key && !key.startsWith('sk-')) {
        showToast('Invalid API key format. Should start with sk-', 'error');
        return;
      }
      setApiKey(key);
      showToast('API Key saved!');
      renderSettings(document.getElementById('main-content'));
    }

    function clearApiKey() {
      if (!confirm('Remove API key? AI features will be disabled.')) return;
      setApiKey('');
      showToast('API Key removed');
      renderSettings(document.getElementById('main-content'));
    }

    async function testApiKey() {
      const key = document.getElementById('apiKeyInput').value.trim();
      const resultDiv = document.getElementById('apiTestResult');
      
      if (!key) {
        resultDiv.innerHTML = '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--red)">Please enter an API key first</div>';
        return;
      }
      
      resultDiv.innerHTML = '<div style="background:var(--amber-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--amber)"> Testing connection...</div>';
      
      try {
        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': key,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 10,
            messages: [{ role: 'user', content: 'Say "OK"' }]
          })
        });
        
        if (response.ok) {
          resultDiv.innerHTML = '<div style="background:var(--green-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--green)"> Connection successful! API key is valid.</div>';
        } else {
          const error = await response.json();
          resultDiv.innerHTML = '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--red)"> Error: ' + (error.error?.message || 'Invalid API key') + '</div>';
        }
      } catch (e) {
        resultDiv.innerHTML = '<div style="background:var(--red-dim);padding:var(--spacing-3);border-radius:var(--radius);color:var(--red)"> Connection failed: ' + e.message + '</div>';
      }
    }

    function renderUsers(c) {
      if (currentUser.role !== 'ADMIN') { c.innerHTML = '<div style="text-align:center;padding:60px">Access Denied</div>'; return; }
      c.innerHTML = '<div class="header"><h2>Users</h2><button class="btn btn-primary" onclick="openUserModal()">+ New User</button></div><div class="card"><div class="table-wrapper"><table><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead><tbody>' + appData.users.map(u => '<tr><td><strong>' + u.first_name + ' ' + u.last_name + '</strong></td><td>' + u.email + '</td><td><span class="badge ' + (u.role === 'ADMIN' ? 'badge-red' : u.role === 'MANAGER' ? 'badge-amber' : 'badge-blue') + '">' + u.role + '</span></td><td><span class="badge ' + (u.is_active ? 'badge-green' : 'badge-gray') + '">' + (u.is_active ? 'Active' : 'Inactive') + '</span></td><td><div class="actions"><button class="action-btn edit" onclick="openUserModal(' + u.id + ')">Edit</button>' + (u.id !== currentUser.id ? '<button class="action-btn delete" onclick="deleteUser(' + u.id + ')">Del</button>' : '') + '</div></td></tr>').join('') + '</tbody></table></div></div>';
    }

    function openUserModal(id = null) {
      const u = id ? appData.users.find(x => x.id === id) : null;
      const m = document.createElement('div'); m.className = 'modal-overlay'; m.onclick = e => { if (e.target === m) m.remove(); };
      m.innerHTML = '<div class="modal" style="max-width:450px"><div class="modal-header"><h3>' + (u ? 'Edit' : 'New') + ' User</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body"><div class="form-row"><div class="form-group"><label>First Name</label><input id="uFirst" value="' + (u?.first_name || '') + '"></div><div class="form-group"><label>Last Name</label><input id="uLast" value="' + (u?.last_name || '') + '"></div></div><div class="form-group"><label>Email</label><input id="uEmail" value="' + (u?.email || '') + '"></div><div class="form-group"><label>Password' + (u ? ' (blank = keep)' : '') + '</label><input type="password" id="uPass"></div><div class="form-row"><div class="form-group"><label>Role</label><select id="uRole"><option' + (u?.role === 'DISPATCHER' ? ' selected' : '') + '>DISPATCHER</option><option' + (u?.role === 'MANAGER' ? ' selected' : '') + '>MANAGER</option><option' + (u?.role === 'ADMIN' ? ' selected' : '') + '>ADMIN</option></select></div><div class="form-group"><label>Active</label><select id="uActive"><option value="true"' + (u?.is_active !== false ? ' selected' : '') + '>Yes</option><option value="false"' + (u?.is_active === false ? ' selected' : '') + '>No</option></select></div></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveUser(' + id + ')">Save</button></div></div>';
      document.body.appendChild(m);
    }

    async function saveUser(id) {
      const data = { first_name: document.getElementById('uFirst').value, last_name: document.getElementById('uLast').value, email: document.getElementById('uEmail').value, role: document.getElementById('uRole').value, is_active: document.getElementById('uActive').value === 'true' };
      const pass = document.getElementById('uPass').value;
      if (pass || !id) {
        // Hash password before saving
        data.password = await hashPassword(pass);
      }
      try { 
        if (id) { 
          await dbUpdate('users', id, data); 
          await logActivity('USER_UPDATED', { target_user_id: id, user_email: data.email, role: data.role, is_active: data.is_active });
        } else { 
          const newUser = await dbInsert('users', data); 
          await logActivity('USER_CREATED', { target_user_id: newUser.id, user_email: data.email, role: data.role });
        } 
        document.querySelector('.modal-overlay').remove(); showToast('Saved!'); await loadAllData(true); renderUsers(document.getElementById('main-content')); 
      } catch (e) { showToast(e.message, 'error'); }
    }

    async function deleteUser(id) {
      if (!confirm('Delete?')) return;
      const user = appData.users.find(u => u.id === id);
      try {
        await dbDelete('users', id);
        await logActivity('USER_DELETED', { target_user_id: id, user_email: user?.email });
        showToast('Deleted'); await loadAllData(true); renderUsers(document.getElementById('main-content'));
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    // ============ ACTIVITY LOG SECTION ============
    let activityLogData = [];
    let activityLogFilter = 'all';
    
    let activityDateFrom = '';
    let activityDateTo = '';
    
    async function renderActivityLog(c) {
      // Fetch activity log from database
      try {
        activityLogData = await dbFetch('activity_log', { order: 'created_at.desc', limit: 1000 }) || [];
      } catch (e) {
        activityLogData = [];
      }
      
      const actionTypes = [...new Set(activityLogData.map(a => a.action))].sort();
      const userEmails = [...new Set(activityLogData.map(a => a.user_email))].filter(e => e && e !== 'unknown').sort();
      
      // Filter data
      let filtered = activityLogFilter === 'all' 
        ? activityLogData 
        : activityLogData.filter(a => a.action === activityLogFilter || a.user_email === activityLogFilter);
      
      // Apply date filter
      if (activityDateFrom) {
        filtered = filtered.filter(a => new Date(a.created_at) >= new Date(activityDateFrom));
      }
      if (activityDateTo) {
        const endDate = new Date(activityDateTo);
        endDate.setDate(endDate.getDate() + 1);
        filtered = filtered.filter(a => new Date(a.created_at) < endDate);
      }
      
      // Pagination
      pagination.activity_log.total = filtered.length;
      const paginatedData = getPaginatedData(filtered, 'activity_log');
      
      // Action type colors
      const actionColors = {
        'LOGIN_SUCCESS': 'var(--green)',
        'LOGOUT': 'var(--text-secondary)',
        'SIGNUP': 'var(--blue)',
        'VEHICLE_ADDED': 'var(--green)',
        'VEHICLE_UPDATED': 'var(--amber)',
        'VEHICLE_REMOVED_FROM_TRIP': 'var(--red)',
        'TRIP_CREATED': 'var(--green)',
        'TRIP_UPDATED': 'var(--amber)',
        'TRIP_DELETED': 'var(--red)',
        'ORDER_CREATED': 'var(--green)',
        'ORDER_UPDATED': 'var(--amber)',
        'ORDER_DELETED': 'var(--red)',
        'TRUCK_CREATED': 'var(--green)',
        'TRUCK_UPDATED': 'var(--amber)',
        'TRUCK_DELETED': 'var(--red)',
        'DRIVER_CREATED': 'var(--green)',
        'DRIVER_UPDATED': 'var(--amber)',
        'EXPENSE_CREATED': 'var(--amber)',
        'EXPENSE_DELETED': 'var(--red)',
        'TASK_CREATED': 'var(--green)',
        'TASK_COMPLETED': 'var(--green)',
        'TASK_REOPENED': 'var(--amber)',
        'TASK_DELETED': 'var(--red)',
        'CLAIM_CREATED': 'var(--amber)',
        'CLAIM_UPDATED': 'var(--blue)',
        'MAINTENANCE_CREATED': 'var(--blue)',
        'MAINTENANCE_UPDATED': 'var(--amber)',
        'USER_CREATED': 'var(--green)',
        'USER_UPDATED': 'var(--amber)',
        'USER_DELETED': 'var(--red)',
        'PASSWORD_RESET_SUCCESS': 'var(--purple)',
        'DATA_EXPORTED': 'var(--purple)',
        'CHAT_MESSAGE_SENT': 'var(--blue)'
      };
      
      // Action category icons
      const actionIcons = {
        'LOGIN': '', 'LOGOUT': '', 'SIGNUP': '',
        'TRIP': '', 'ORDER': '', 'VEHICLE': '',
        'TRUCK': '', 'DRIVER': '', 'EXPENSE': '',
        'TASK': '', 'CLAIM': '', 'MAINTENANCE': '',
        'USER': '', 'PASSWORD': '', 'DATA': '',
        'CHAT': '', 'FIXED_COST': '', 'VARIABLE_COST': '',
        'LOCAL_DRIVER': '', 'BROKER': '', 'DISPATCHER': ''
      };
      
      function getActionIcon(action) {
        for (const [key, icon] of Object.entries(actionIcons)) {
          if (action.includes(key)) return icon;
        }
        return '';
      }
      
      c.innerHTML = '<div class="header"><h2> ' + 'Audit Trail' + '</h2>' +
        '<button class="btn btn-secondary" onclick="exportActivityLog()"> ' + 'Export' + '</button></div>' +
        
        // Stats cards
        '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:20px">' +
        '<div class="stat-card" style="background:linear-gradient(135deg,var(--green)22,var(--green)11)"><div class="label">' + 'Today' + '</div><div class="value">' + activityLogData.filter(a => new Date(a.created_at).toDateString() === new Date().toDateString()).length + '</div></div>' +
        '<div class="stat-card" style="background:linear-gradient(135deg,var(--blue)22,var(--blue)11)"><div class="label">' + 'This Week' + '</div><div class="value">' + activityLogData.filter(a => new Date(a.created_at) > new Date(Date.now() - 7*24*60*60*1000)).length + '</div></div>' +
        '<div class="stat-card" style="background:linear-gradient(135deg,var(--amber)22,var(--amber)11)"><div class="label">' + 'Unique Users' + '</div><div class="value">' + userEmails.length + '</div></div>' +
        '<div class="stat-card" style="background:linear-gradient(135deg,var(--purple)22,var(--purple)11)"><div class="label">' + 'Total Records' + '</div><div class="value">' + activityLogData.length + '</div></div>' +
        '</div>' +
        
        // Filters
        '<div class="card" style="margin-bottom:20px;padding:16px">' +
        '<div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">' +
        '<div style="display:flex;gap:8px;align-items:center"><label>' + 'Filter:' + '</label>' +
        '<select onchange="activityLogFilter=this.value;pagination.activity_log.page=1;renderActivityLog(document.getElementById(\'main-content\'))" style="padding:8px 12px;border-radius:6px;border:1px solid var(--border)">' +
        '<option value="all"' + (activityLogFilter === 'all' ? ' selected' : '') + '>' + 'All Activities' + '</option>' +
        '<optgroup label="' + 'By Action' + '">' + actionTypes.map(a => '<option value="' + a + '"' + (activityLogFilter === a ? ' selected' : '') + '>' + a.replace(/_/g, ' ') + '</option>').join('') + '</optgroup>' +
        '<optgroup label="' + 'By User' + '">' + userEmails.map(e => '<option value="' + e + '"' + (activityLogFilter === e ? ' selected' : '') + '>' + e + '</option>').join('') + '</optgroup>' +
        '</select></div>' +
        '<div style="display:flex;gap:8px;align-items:center"><label>' + 'From:' + '</label>' +
        '<input type="date" value="' + activityDateFrom + '" onchange="activityDateFrom=this.value;pagination.activity_log.page=1;renderActivityLog(document.getElementById(\'main-content\'))" style="padding:8px;border-radius:6px;border:1px solid var(--border)"></div>' +
        '<div style="display:flex;gap:8px;align-items:center"><label>' + 'To:' + '</label>' +
        '<input type="date" value="' + activityDateTo + '" onchange="activityDateTo=this.value;pagination.activity_log.page=1;renderActivityLog(document.getElementById(\'main-content\'))" style="padding:8px;border-radius:6px;border:1px solid var(--border)"></div>' +
        '<button class="btn btn-secondary" onclick="activityLogFilter=\'all\';activityDateFrom=\'\';activityDateTo=\'\';pagination.activity_log.page=1;renderActivityLog(document.getElementById(\'main-content\'))" style="padding:8px 12px"> ' + 'Clear' + '</button>' +
        '<span style="color:var(--text-muted);margin-left:auto">' + 'Showing' + ' ' + paginatedData.data.length + ' / ' + filtered.length + '</span>' +
        '</div></div>' +
        
        '<div class="card"><div class="table-wrapper"><table>' +
        '<thead><tr><th style="width:50px"></th><th style="width:160px">' + 'Date/Time' + '</th><th style="width:200px">' + 'User' + '</th><th style="width:180px">' + 'Action' + '</th><th>' + 'Details' + '</th></tr></thead>' +
        '<tbody>' +
        (paginatedData.data.length === 0 
          ? '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-muted)">' + 'No activity logs found' + '</td></tr>' 
          : paginatedData.data.map(a => {
              const color = actionColors[a.action] || 'var(--text-secondary)';
              const icon = getActionIcon(a.action);
              let details = '';
              try {
                const d = typeof a.details === 'string' ? JSON.parse(a.details || '{}') : (a.details || {});
                details = Object.entries(d).map(([k, v]) => '<span style="background:var(--bg-tertiary);padding:2px 6px;border-radius:4px;margin-right:4px;margin-bottom:2px;display:inline-block;font-size:11px"><strong>' + k.replace(/_/g, ' ') + ':</strong> ' + (v || '-') + '</span>').join('');
              } catch (e) { details = a.details || '-'; }
              
              // Display user name if available, otherwise fall back to email
              const displayName = a.user_name || a.user_email || 'System';
              return '<tr style="cursor:pointer" onclick="showActivityDetail(' + JSON.stringify(a).replace(/"/g, '&quot;') + ')">' +
                '<td style="font-size:20px;text-align:center">' + icon + '</td>' +
                '<td style="font-size:13px;white-space:nowrap">' + formatDateTime(a.created_at) + '</td>' +
                '<td style="font-weight:500">' + displayName + '</td>' +
                '<td><span style="background:' + color + '22;color:' + color + ';padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600">' + a.action.replace(/_/g, ' ') + '</span></td>' +
                '<td style="font-size:12px">' + details + '</td>' +
                '</tr>';
            }).join('')) +
        '</tbody></table></div>' +
        renderPaginationControls('activity_log') +
        '</div>';
    }
    
    function showActivityDetail(activity) {
      let detailsHtml = '';
      try {
        const d = typeof activity.details === 'string' ? JSON.parse(activity.details || '{}') : (activity.details || {});
        detailsHtml = '<div style="display:grid;gap:12px">' +
          Object.entries(d).map(([k, v]) => 
            '<div style="display:flex;justify-content:space-between;padding:12px;background:var(--bg-tertiary);border-radius:8px">' +
            '<span style="font-weight:500;color:var(--text-muted)">' + k.replace(/_/g, ' ').toUpperCase() + '</span>' +
            '<span style="font-weight:600">' + (v || '-') + '</span></div>'
          ).join('') + '</div>';
      } catch (e) {
        detailsHtml = '<p>' + (activity.details || 'No details') + '</p>';
      }
      
      showModal('activity-detail-modal', ' ' + 'Activity Details',
        '<div style="margin-bottom:20px">' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">' +
        '<div><label style="color:var(--text-muted);font-size:12px">' + 'Date/Time' + '</label><div style="font-weight:600">' + formatDateTime(activity.created_at) + '</div></div>' +
        '<div><label style="color:var(--text-muted);font-size:12px">' + 'User' + '</label><div style="font-weight:600">' + (activity.user_email || 'System') + '</div></div>' +
        '<div><label style="color:var(--text-muted);font-size:12px">' + 'Action' + '</label><div style="font-weight:600">' + activity.action.replace(/_/g, ' ') + '</div></div>' +
        '<div><label style="color:var(--text-muted);font-size:12px">IP</label><div style="font-weight:600">' + (activity.ip_address || '-') + '</div></div>' +
        '</div>' +
        '<label style="color:var(--text-muted);font-size:12px;display:block;margin-bottom:8px">' + 'Details' + '</label>' +
        detailsHtml +
        '</div>',
        '<button class="btn btn-secondary" onclick="closeModal(\'activity-detail-modal\')">' + 'Close' + '</button>'
      );
    }
    
    async function exportActivityLog() {
      const data = activityLogData.map(a => {
        let details = {};
        try { details = typeof a.details === 'string' ? JSON.parse(a.details || '{}') : (a.details || {}); } catch(e) {}
        return {
          'Date/Time': formatDateTime(a.created_at),
          'User': a.user_email || 'System',
          'Action': a.action,
          'IP Address': a.ip_address || '',
          ...details
        };
      });
      exportToExcel(data, 'audit_trail_' + new Date().toISOString().split('T')[0], 'Audit Trail');
    }
    
    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Process pending auth from landing page
    async function processPendingAuth() {
      // Check for pending login
      const pendingLogin = sessionStorage.getItem('pendingLogin');
      if (pendingLogin) {
        sessionStorage.removeItem('pendingLogin');
        const { email, password } = JSON.parse(pendingLogin);
        
        // Check if account is locked
        const lockStatus = isAccountLocked(email.toLowerCase());
        if (lockStatus.locked) {
          alert(`Account locked. Try again in ${lockStatus.remainingMinutes} minutes.`);
          window.location.href = 'index.html';
          return false;
        }
        
        try {
          const users = await dbFetch('users', { filter: { email: 'eq.' + email.toLowerCase() } });
          if (users.length === 0) {
            recordLoginAttempt(email.toLowerCase(), false);
            alert('User not found');
            window.location.href = 'index.html';
            return false;
          }
          
          const user = users[0];
          
          // Check if user is active
          if (user.is_active === false) {
            alert('Account deactivated. Contact administrator.');
            window.location.href = 'index.html';
            return false;
          }
          
          // Hash password and compare
          const hashedPassword = await hashPassword(password);
          const passwordMatch = user.password === hashedPassword || user.password === password;
          
          if (!passwordMatch) {
            recordLoginAttempt(email.toLowerCase(), false);
            const attempts = getLoginAttempts(email.toLowerCase());
            if (attempts.count >= LOGIN_ATTEMPT_LIMIT) {
              alert(`Too many attempts. Account locked for ${LOGIN_LOCKOUT_MINUTES} minutes.`);
            } else {
              alert('Invalid password');
            }
            window.location.href = 'index.html';
            return false;
          }
          
          // Successful login
          recordLoginAttempt(email.toLowerCase(), true);
          
          // Update to hashed password if it was plain text
          if (user.password === password && user.password !== hashedPassword) {
            try {
              await dbUpdate('users', user.id, { password: hashedPassword });
            } catch (e) { /* Ignore */ }
          }
          
          currentUser = user;
          localStorage.setItem('horizonstar_user', JSON.stringify(user));
          startSessionMonitor();
          await logActivity('LOGIN_SUCCESS', { email: email.toLowerCase(), source: 'landing_page' });
          return true;
        } catch (e) {
          alert('Login error: ' + e.message);
          window.location.href = 'index.html';
          return false;
        }
      }
      
      // Check for pending signup
      const pendingSignup = sessionStorage.getItem('pendingSignup');
      if (pendingSignup) {
        sessionStorage.removeItem('pendingSignup');
        const { firstName, lastName, email, password } = JSON.parse(pendingSignup);
        
        try {
          // Check if email exists
          const existing = await dbFetch('users', { filter: { email: 'eq.' + email.toLowerCase() } });
          if (existing.length > 0) {
            alert('Email already registered');
            window.location.href = 'index.html';
            return false;
          }
          
          // Create user
          const newUser = await dbInsert('users', {
            email: email.toLowerCase(),
            password: password,
            first_name: firstName,
            last_name: lastName,
            role: 'DISPATCHER'
          });
          
          // Create dispatcher record
          await dbInsert('dispatchers', {
            name: firstName + ' ' + lastName,
            email: email.toLowerCase(),
            user_id: newUser.id
          });
          
          currentUser = {
            id: newUser.id,
            email: email.toLowerCase(),
            first_name: firstName,
            last_name: lastName,
            role: 'DISPATCHER'
          };
          localStorage.setItem('horizonstar_user', JSON.stringify(currentUser));
          return true;
        } catch (e) {
          alert('Signup error: ' + e.message);
          window.location.href = 'index.html';
          return false;
        }
      }
      
      return false;
    }

    // Start app
    (async function init() {
      // Check for public tracking portal (no auth required)
      if (window.location.hash.startsWith('#tracking')) {
        renderPublicTrackingPortal();
        return;
      }

      // Try to restore Supabase Auth session
      try {
        const { data: { session } } = await sb.auth.getSession();
        if (session) {
          authSession = session;
          
          // Get user from our users table
          const users = await dbFetch('users', { filter: { email: 'eq.' + session.user.email } });
          if (users.length > 0) {
            currentUser = users[0];
            localStorage.setItem('horizonstar_user', JSON.stringify(currentUser));
          }
        } else {
          // No Supabase session - clear any stale local data
          currentUser = null;
          localStorage.removeItem('horizonstar_user');
        }
      } catch (e) {
        console.log('Session restore failed:', e);
        // Clear stale data on error
        currentUser = null;
        localStorage.removeItem('horizonstar_user');
      }
      
      // Listen for auth state changes
      sb.auth.onAuthStateChange((event, session) => {
        authSession = session;
        if (event === 'SIGNED_OUT') {
          currentUser = null;
          localStorage.removeItem('horizonstar_user');
          renderLogin();
        }
      });
      
      // Check for session timeout first
      if (currentUser && checkSessionTimeout()) {
        return; // Session expired, will show login
      }
      
      // If already logged in with valid Supabase session, show app
      if (currentUser && authSession) {
        startSessionMonitor();
        renderApp();
        return;
      }
      
      // Check for pending auth from landing page
      const authProcessed = await processPendingAuth();
      if (authProcessed && currentUser && authSession) {
        renderApp();
        return;
      }
      
      // Not logged in or no valid session, show login
      renderLogin();
    })();
    
    // ============ PWA SERVICE WORKER ============
    // Only register on HTTPS (not local file://)
    if ('serviceWorker' in navigator && location.protocol === 'https:') {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('PWA: Service Worker registered', reg.scope))
          .catch(err => console.log('PWA: Service Worker failed', err));
      });
    }
    
    // PWA Install Prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // Show install button after login
      setTimeout(() => {
        if (document.querySelector('.sidebar') && !localStorage.getItem('pwa_install_dismissed')) {
          showPWAInstallPrompt();
        }
      }, 5000);
    });
    
    function showPWAInstallPrompt() {
      const prompt = document.createElement('div');
      prompt.id = 'pwa-install-prompt';
      prompt.innerHTML = `
        <div style="position:fixed;bottom:20px;right:20px;background:linear-gradient(135deg,var(--green),var(--green));color:white;padding:20px;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:99999;max-width:320px;font-family:Inter,sans-serif;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
            <span style="font-size:32px;"></span>
            <div>
              <div style="font-weight:700;font-size:16px;">Install TMS App</div>
              <div style="font-size:13px;opacity:0.9;">Add to home screen for quick access</div>
            </div>
          </div>
          <div style="display:flex;gap:10px;">
            <button onclick="installPWA()" style="flex:1;background:var(--bg-card);color:var(--green);border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;">Install</button>
            <button onclick="dismissPWAPrompt()" style="background:rgba(255,255,255,0.2);color:white;border:none;padding:10px 16px;border-radius:8px;font-weight:600;cursor:pointer;">Later</button>
          </div>
        </div>
      `;
      document.body.appendChild(prompt);
    }
    
    function installPWA() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(choice => {
          if (choice.outcome === 'accepted') {
            console.log('PWA: User accepted install');
          }
          deferredPrompt = null;
        });
      }
      document.getElementById('pwa-install-prompt')?.remove();
    }
    
    function dismissPWAPrompt() {
      localStorage.setItem('pwa_install_dismissed', 'true');
      document.getElementById('pwa-install-prompt')?.remove();
    }
    
    // iOS Install Instructions (iOS doesn't support beforeinstallprompt)
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }
    
    function isInStandaloneMode() {
      return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    }
    
    if (isIOS() && !isInStandaloneMode() && !localStorage.getItem('ios_install_dismissed')) {
      setTimeout(() => {
        if (document.querySelector('.sidebar')) {
          showIOSInstallPrompt();
        }
      }, 5000);
    }
    
    function showIOSInstallPrompt() {
      const prompt = document.createElement('div');
      prompt.id = 'ios-install-prompt';
      prompt.innerHTML = `
        <div style="position:fixed;bottom:20px;left:20px;right:20px;background:linear-gradient(135deg,var(--green),var(--green));color:white;padding:20px;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:99999;font-family:Inter,sans-serif;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
            <span style="font-size:32px;"></span>
            <div>
              <div style="font-weight:700;font-size:16px;">Install TMS App</div>
              <div style="font-size:13px;opacity:0.9;">Add to your home screen</div>
            </div>
            <button onclick="dismissIOSPrompt()" style="margin-left:auto;background:none;border:none;color:white;font-size:20px;cursor:pointer;"></button>
          </div>
          <div style="background:rgba(0,0,0,0.2);padding:var(--spacing-3);border-radius:var(--radius);font-size:13px;">
            <div style="margin-bottom:8px;">1. Tap the <strong>Share</strong> button <span style="background:var(--bg-card);color:var(--text-primary);padding:2px 6px;border-radius:4px;"></span></div>
            <div>2. Scroll down and tap <strong>"Add to Home Screen"</strong></div>
          </div>
        </div>
      `;
      document.body.appendChild(prompt);
    }
    
    function dismissIOSPrompt() {
      localStorage.setItem('ios_install_dismissed', 'true');
      document.getElementById('ios-install-prompt')?.remove();
    }
    
    // ============================================
    // ENHANCED REPORTS MODULE
    // Truck P&L, Driver Performance, Lane Analysis
    // ============================================
    
    let reportTab = 'truck_pl';
    let reportPeriod = 'month';
    let reportMonth = new Date().getMonth() + 1;
    let reportYear = new Date().getFullYear();
    let reportCompare = false;

    function renderReports(c) {
      const months = ['', 'January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      
      const filteredTrips = filterReportTripsByPeriod(appData.trips);
      const filteredOrders = appData.orders.filter(o => {
        const trip = appData.trips.find(t => t.id === o.trip_id);
        return trip && filteredTrips.includes(trip);
      });
      
      const prevPeriodTrips = reportCompare ? filterReportTripsByPeriod(appData.trips, true) : [];
      const prevPeriodOrders = reportCompare ? appData.orders.filter(o => {
        const trip = appData.trips.find(t => t.id === o.trip_id);
        return trip && prevPeriodTrips.includes(trip);
      }) : [];
      
      c.innerHTML = '<div class="header"><h2> Enhanced Reports</h2><div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap"><select id="reportPeriod" onchange="reportPeriod=this.value;renderReports(document.getElementById(\'main-content\'))" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card)"><option value="month"' + (reportPeriod === 'month' ? ' selected' : '') + '>Monthly</option><option value="quarter"' + (reportPeriod === 'quarter' ? ' selected' : '') + '>Quarterly</option><option value="year"' + (reportPeriod === 'year' ? ' selected' : '') + '>Yearly</option><option value="all"' + (reportPeriod === 'all' ? ' selected' : '') + '>All Time</option></select>' +
        (reportPeriod === 'month' ? '<select id="reportMonth" onchange="reportMonth=parseInt(this.value);renderReports(document.getElementById(\'main-content\'))" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card)">' + months.slice(1).map((m, i) => '<option value="' + (i+1) + '"' + (reportMonth === i+1 ? ' selected' : '') + '>' + m + '</option>').join('') + '</select>' : '') +
        (reportPeriod !== 'all' ? '<select id="reportYear" onchange="reportYear=parseInt(this.value);renderReports(document.getElementById(\'main-content\'))" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-card)"><option value="2024"' + (reportYear === 2024 ? ' selected' : '') + '>2024</option><option value="2025"' + (reportYear === 2025 ? ' selected' : '') + '>2025</option><option value="2026"' + (reportYear === 2026 ? ' selected' : '') + '>2026</option><option value="2027"' + (reportYear === 2027 ? ' selected' : '') + '>2027</option></select>' : '') +
        '<label style="display:flex;align-items:center;gap:6px;cursor:pointer"><input type="checkbox"' + (reportCompare ? ' checked' : '') + ' onchange="reportCompare=this.checked;renderReports(document.getElementById(\'main-content\'))"><span style="font-size:13px">Compare to previous</span></label><button class="btn btn-secondary" onclick="exportReportCSV()"> Export CSV</button></div></div>' +
        '<div style="display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap"><button class="btn ' + (reportTab === 'truck_pl' ? 'btn-primary' : 'btn-secondary') + '" onclick="reportTab=\'truck_pl\';renderReports(document.getElementById(\'main-content\'))"> Truck P&L</button><button class="btn ' + (reportTab === 'driver_performance' ? 'btn-primary' : 'btn-secondary') + '" onclick="reportTab=\'driver_performance\';renderReports(document.getElementById(\'main-content\'))"> Driver Performance</button><button class="btn ' + (reportTab === 'lane_analysis' ? 'btn-primary' : 'btn-secondary') + '" onclick="reportTab=\'lane_analysis\';renderReports(document.getElementById(\'main-content\'))"> Lane Analysis</button></div>' +
        '<div id="reportContent">' +
        (reportTab === 'truck_pl' ? renderTruckPLReport(filteredTrips, filteredOrders, prevPeriodTrips, prevPeriodOrders) : '') +
        (reportTab === 'driver_performance' ? renderDriverPerformanceReport(filteredTrips, filteredOrders, prevPeriodTrips, prevPeriodOrders) : '') +
        (reportTab === 'lane_analysis' ? renderLaneAnalysisReport(filteredTrips, filteredOrders, prevPeriodTrips, prevPeriodOrders) : '') +
        '</div>';
    }

    function filterReportTripsByPeriod(trips, previous = false) {
      if (reportPeriod === 'all') return trips;
      
      let startDate, endDate;
      const year = previous ? (reportPeriod === 'month' && reportMonth === 1 ? reportYear - 1 : reportYear) : reportYear;
      const month = previous ? (reportMonth === 1 ? 12 : reportMonth - 1) : reportMonth;
      
      if (reportPeriod === 'month') {
        startDate = new Date(year, month - 1, 1);
        endDate = new Date(year, month, 0);
      } else if (reportPeriod === 'quarter') {
        const q = Math.ceil(reportMonth / 3);
        const actualQ = previous ? (q === 1 ? 4 : q - 1) : q;
        const actualYear = previous && q === 1 ? reportYear - 1 : reportYear;
        startDate = new Date(actualYear, (actualQ - 1) * 3, 1);
        endDate = new Date(actualYear, actualQ * 3, 0);
      } else if (reportPeriod === 'year') {
        const actualYear = previous ? reportYear - 1 : reportYear;
        startDate = new Date(actualYear, 0, 1);
        endDate = new Date(actualYear, 11, 31);
      }
      
      return trips.filter(t => {
        if (!t.trip_date) return false;
        const tripDate = new Date(t.trip_date);
        return tripDate >= startDate && tripDate <= endDate;
      });
    }

    function renderTruckPLReport(trips, orders, prevTrips, prevOrders) {
      const trucks = appData.trucks.filter(t => t.status === 'ACTIVE');
      const monthlyFixedCosts = (appData.fixed_costs || []).reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);
      const fixedCostPerTruck = trucks.length > 0 ? monthlyFixedCosts / trucks.length : 0;
      
      let totalRevenue = 0, totalDriverCut = 0, totalFuel = 0, totalOther = 0, totalProfit = 0;
      
      const truckData = trucks.map(truck => {
        const truckTrips = trips.filter(t => t.truck_id === truck.id);
        const truckOrders = orders.filter(o => truckTrips.some(t => t.id === o.trip_id));
        
        const revenue = truckOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
        const brokerFees = truckOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
        const localFees = truckOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
        const cleanGross = revenue - brokerFees - localFees;
        
        const driverCut = truckTrips.reduce((sum, trip) => {
          const tripOrders = truckOrders.filter(o => o.trip_id === trip.id);
          const tripRevenue = tripOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
          const tripBroker = tripOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
          const tripLocal = tripOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
          const tripClean = tripRevenue - tripBroker - tripLocal;
          return sum + (tripClean * ((trip.driver_cut_percent || 32) / 100));
        }, 0);
        
        const tripIds = truckTrips.map(t => t.id);
        const fuelExpenses = (appData.expenses || []).filter(e => tripIds.includes(e.trip_id) && e.category === 'FUEL').reduce((s, e) => s + parseFloat(e.amount || 0), 0);
        const otherExpenses = (appData.expenses || []).filter(e => tripIds.includes(e.trip_id) && e.category !== 'FUEL').reduce((s, e) => s + parseFloat(e.amount || 0), 0);
        const maintenance = (appData.maintenance_records || []).filter(m => m.truck_id === truck.id).reduce((s, m) => s + parseFloat(m.cost || 0), 0);
        
        const totalCosts = driverCut + fuelExpenses + otherExpenses + fixedCostPerTruck + maintenance;
        const netProfit = cleanGross - totalCosts;
        const margin = cleanGross > 0 ? (netProfit / cleanGross) * 100 : 0;
        
        let prevData = null;
        if (reportCompare && prevTrips.length > 0) {
          const prevTruckTrips = prevTrips.filter(t => t.truck_id === truck.id);
          const prevTruckOrders = prevOrders.filter(o => prevTruckTrips.some(t => t.id === o.trip_id));
          const prevRevenue = prevTruckOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
          const prevBroker = prevTruckOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
          const prevLocal = prevTruckOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
          prevData = { revenue: prevRevenue - prevBroker - prevLocal, trips: prevTruckTrips.length };
        }
        
        totalRevenue += cleanGross;
        totalDriverCut += driverCut;
        totalFuel += fuelExpenses;
        totalOther += otherExpenses + maintenance + fixedCostPerTruck;
        totalProfit += netProfit;
        
        return { truck, trips: truckTrips.length, cars: truckOrders.length, revenue: cleanGross, driverCut, fuel: fuelExpenses, other: otherExpenses + maintenance + fixedCostPerTruck, netProfit, margin, prevData };
      }).sort((a, b) => b.netProfit - a.netProfit);
      
      const totalMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;
      
      return '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px"><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Total Revenue</div><div style="font-size:28px;font-weight:700;color:var(--green)">' + formatMoney(totalRevenue) + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Total Costs</div><div style="font-size:28px;font-weight:700;color:var(--red)">' + formatMoney(totalDriverCut + totalFuel + totalOther) + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Net Profit</div><div style="font-size:28px;font-weight:700;color:' + (totalProfit >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(totalProfit) + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Profit Margin</div><div style="font-size:28px;font-weight:700;color:' + (totalMargin >= 25 ? 'var(--green)' : totalMargin >= 15 ? 'var(--amber)' : 'var(--red)') + '">' + totalMargin.toFixed(1) + '%</div></div></div>' +
        '<div class="card"><div class="card-header"><h3> Profit & Loss by Truck</h3></div><div class="table-wrapper"><table><thead><tr><th>Truck</th><th>Trips</th><th>Cars</th><th>Revenue</th><th>Driver Cut</th><th>Fuel</th><th>Other Costs</th><th>Net Profit</th><th>Margin</th>' + (reportCompare ? '<th>vs Prev</th>' : '') + '</tr></thead><tbody>' +
        truckData.map((d, i) => '<tr><td><div style="display:flex;align-items:center;gap:8px">' + (i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : '') + '<strong>' + d.truck.truck_number + '</strong></div></td><td>' + d.trips + '</td><td>' + d.cars + '</td><td style="color:var(--green);font-weight:600">' + formatMoney(d.revenue) + '</td><td style="color:var(--red)">' + formatMoney(d.driverCut) + '</td><td style="color:var(--amber)">' + formatMoney(d.fuel) + '</td><td style="color:var(--text-muted)">' + formatMoney(d.other) + '</td><td style="font-weight:700;color:' + (d.netProfit >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(d.netProfit) + '</td><td><span style="padding:4px 8px;border-radius:12px;font-size:12px;font-weight:600;background:' + (d.margin >= 25 ? 'var(--green-dim)' : d.margin >= 15 ? 'var(--amber-dim)' : 'var(--red-dim)') + ';color:' + (d.margin >= 25 ? 'var(--green)' : d.margin >= 15 ? 'var(--amber)' : 'var(--red)') + '">' + d.margin.toFixed(1) + '%</span></td>' + (reportCompare ? '<td>' + (d.prevData ? '<span style="color:' + (d.revenue >= d.prevData.revenue ? 'var(--green)' : 'var(--red)') + '">' + (d.revenue >= d.prevData.revenue ? '' : '') + ' ' + Math.abs(((d.revenue - d.prevData.revenue) / (d.prevData.revenue || 1)) * 100).toFixed(0) + '%</span>' : '-') + '</td>' : '') + '</tr>').join('') +
        '<tr style="background:var(--bg-darker);font-weight:700"><td><strong>TOTAL</strong></td><td>' + truckData.reduce((s, d) => s + d.trips, 0) + '</td><td>' + truckData.reduce((s, d) => s + d.cars, 0) + '</td><td style="color:var(--green)">' + formatMoney(totalRevenue) + '</td><td style="color:var(--red)">' + formatMoney(totalDriverCut) + '</td><td style="color:var(--amber)">' + formatMoney(totalFuel) + '</td><td style="color:var(--text-muted)">' + formatMoney(totalOther) + '</td><td style="color:' + (totalProfit >= 0 ? 'var(--green)' : 'var(--red)') + '">' + formatMoney(totalProfit) + '</td><td>' + totalMargin.toFixed(1) + '%</td>' + (reportCompare ? '<td></td>' : '') + '</tr></tbody></table></div></div>' +
        (truckData.filter(d => d.margin < 15).length > 0 ? '<div style="margin-top:16px;padding:16px;background:var(--amber-dim);border-left:4px solid var(--amber);border-radius:8px"><strong style="color:var(--amber)"> Low Margin Alert:</strong> <span style="color:var(--amber)">' + truckData.filter(d => d.margin < 15).map(d => d.truck.truck_number).join(', ') + ' ' + (truckData.filter(d => d.margin < 15).length === 1 ? 'has' : 'have') + ' margin below 15%. Review costs.</span></div>' : '');
    }

    function renderDriverPerformanceReport(trips, orders, prevTrips, prevOrders) {
      const drivers = appData.drivers || [];
      let totalTrips = 0, totalCars = 0, totalRevenue = 0, totalEarnings = 0;
      
      const driverData = drivers.map(driver => {
        const driverTrips = trips.filter(t => t.driver_id === driver.id);
        const driverOrders = orders.filter(o => driverTrips.some(t => t.id === o.trip_id));
        
        const revenue = driverOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
        const brokerFees = driverOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
        const localFees = driverOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
        const cleanGross = revenue - brokerFees - localFees;
        
        const earnings = driverTrips.reduce((sum, trip) => {
          const tripOrders = driverOrders.filter(o => o.trip_id === trip.id);
          const tripRevenue = tripOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
          const tripBroker = tripOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
          const tripLocal = tripOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
          const tripClean = tripRevenue - tripBroker - tripLocal;
          return sum + (tripClean * ((trip.driver_cut_percent || 32) / 100));
        }, 0);
        
        // Cash collected - handle split payments (bill_amount > 0 means use cod_amount)
        // LOCAL_COD goes to local driver, not trip driver
        const cashCollected = driverOrders.filter(o => o.payment_type === 'COD' || o.payment_type === 'COP').reduce((s, o) => {
          if (parseFloat(o.bill_amount || 0) > 0) {
            return s + parseFloat(o.cod_amount || 0);
          }
          return s + parseFloat(o.revenue || 0);
        }, 0);
        const miles = driverTrips.reduce((s, t) => s + parseFloat(t.miles || 0), 0);
        const avgPerCar = driverOrders.length > 0 ? cleanGross / driverOrders.length : 0;
        
        let prevData = null;
        if (reportCompare && prevTrips.length > 0) {
          const prevDriverTrips = prevTrips.filter(t => t.driver_id === driver.id);
          prevData = { trips: prevDriverTrips.length };
        }
        
        totalTrips += driverTrips.length;
        totalCars += driverOrders.length;
        totalRevenue += cleanGross;
        totalEarnings += earnings;
        
        return { driver, trips: driverTrips.length, cars: driverOrders.length, revenue: cleanGross, earnings, cashCollected, miles, avgPerCar, avgCut: driverTrips.length > 0 ? driverTrips.reduce((s, t) => s + (t.driver_cut_percent || 32), 0) / driverTrips.length : 32, prevData };
      }).filter(d => d.trips > 0).sort((a, b) => b.revenue - a.revenue);
      
      return '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px"><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Total Trips</div><div style="font-size:28px;font-weight:700;color:var(--blue)">' + totalTrips + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Total Cars Hauled</div><div style="font-size:28px;font-weight:700;color:var(--purple)">' + totalCars + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Revenue Generated</div><div style="font-size:28px;font-weight:700;color:var(--green)">' + formatMoney(totalRevenue) + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Driver Earnings</div><div style="font-size:28px;font-weight:700;color:var(--amber)">' + formatMoney(totalEarnings) + '</div></div></div>' +
        '<div class="card"><div class="card-header"><h3> Driver Performance</h3></div><div class="table-wrapper"><table><thead><tr><th>Driver</th><th>Trips</th><th>Cars</th><th>Miles</th><th>Revenue</th><th>Avg $/Car</th><th>Cut %</th><th>Earnings</th><th>Cash Collected</th>' + (reportCompare ? '<th>vs Prev</th>' : '') + '</tr></thead><tbody>' +
        driverData.map((d, i) => '<tr><td><div style="display:flex;align-items:center;gap:8px">' + (i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : '') + '<div><strong>' + d.driver.first_name + ' ' + d.driver.last_name + '</strong><div style="font-size:var(--text-xs);color:var(--text-muted)">' + (d.driver.phone || '') + '</div></div></div></td><td><span style="font-weight:600">' + d.trips + '</span></td><td>' + d.cars + '</td><td>' + d.miles.toLocaleString() + '</td><td style="color:var(--green);font-weight:600">' + formatMoney(d.revenue) + '</td><td>' + formatMoney(d.avgPerCar) + '</td><td><span style="color:var(--blue);font-weight:600">' + d.avgCut.toFixed(0) + '%</span></td><td style="color:var(--amber);font-weight:700">' + formatMoney(d.earnings) + '</td><td style="color:var(--purple)">' + formatMoney(d.cashCollected) + '</td>' + (reportCompare ? '<td>' + (d.prevData ? '<span style="color:' + (d.trips >= d.prevData.trips ? 'var(--green)' : 'var(--red)') + '">' + (d.trips >= d.prevData.trips ? '' : '') + ' ' + Math.abs(d.trips - d.prevData.trips) + ' trips</span>' : '-') + '</td>' : '') + '</tr>').join('') +
        '</tbody></table></div></div>' +
        '<div class="card" style="margin-top:16px"><div class="card-header"><h3> Performance Insights</h3></div><div style="padding:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px"><div style="background:var(--bg-darker);padding:var(--spacing-4);border-radius:var(--radius)"><div style="font-size:13px;color:var(--text-muted);margin-bottom:8px">Top Performer</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold)"> ' + (driverData[0]?.driver.first_name || 'N/A') + ' ' + (driverData[0]?.driver.last_name || '') + '</div><div style="font-size:var(--text-xs);color:var(--green)">' + formatMoney(driverData[0]?.revenue || 0) + ' revenue</div></div><div style="background:var(--bg-darker);padding:var(--spacing-4);border-radius:var(--radius)"><div style="font-size:13px;color:var(--text-muted);margin-bottom:8px">Most Cars Hauled</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold)"> ' + ([...driverData].sort((a,b) => b.cars - a.cars)[0]?.driver.first_name || 'N/A') + '</div><div style="font-size:12px;color:var(--blue)">' + ([...driverData].sort((a,b) => b.cars - a.cars)[0]?.cars || 0) + ' cars</div></div><div style="background:var(--bg-darker);padding:var(--spacing-4);border-radius:var(--radius)"><div style="font-size:13px;color:var(--text-muted);margin-bottom:8px">Highest $/Car</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold)"> ' + ([...driverData].sort((a,b) => b.avgPerCar - a.avgPerCar)[0]?.driver.first_name || 'N/A') + '</div><div style="font-size:12px;color:var(--amber)">' + formatMoney([...driverData].sort((a,b) => b.avgPerCar - a.avgPerCar)[0]?.avgPerCar || 0) + '/car</div></div><div style="background:var(--bg-darker);padding:var(--spacing-4);border-radius:var(--radius)"><div style="font-size:13px;color:var(--text-muted);margin-bottom:8px">Most Miles</div><div style="font-size:var(--text-lg);font-weight:var(--weight-bold)"> ' + ([...driverData].sort((a,b) => b.miles - a.miles)[0]?.driver.first_name || 'N/A') + '</div><div style="font-size:12px;color:var(--purple)">' + ([...driverData].sort((a,b) => b.miles - a.miles)[0]?.miles || 0).toLocaleString() + ' miles</div></div></div></div>';
    }

    function renderLaneAnalysisReport(trips, orders, prevTrips, prevOrders) {
      const laneMap = new Map();
      
      trips.forEach(trip => {
        if (!trip.origin || !trip.destination) return;
        const originState = extractReportState(trip.origin);
        const destState = extractReportState(trip.destination);
        const laneKey = originState + '  ' + destState;
        
        const tripOrders = orders.filter(o => o.trip_id === trip.id);
        const revenue = tripOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
        const brokerFees = tripOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
        const localFees = tripOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
        const cleanGross = revenue - brokerFees - localFees;
        const miles = parseFloat(trip.miles || 0);
        
        if (!laneMap.has(laneKey)) {
          laneMap.set(laneKey, { lane: laneKey, origin: originState, destination: destState, trips: 0, cars: 0, revenue: 0, miles: 0, brokerFees: 0 });
        }
        
        const lane = laneMap.get(laneKey);
        lane.trips++;
        lane.cars += tripOrders.length;
        lane.revenue += cleanGross;
        lane.miles += miles;
        lane.brokerFees += brokerFees;
      });
      
      const laneData = Array.from(laneMap.values()).map(lane => ({
        ...lane,
        revenuePerMile: lane.miles > 0 ? lane.revenue / lane.miles : 0,
        avgPerCar: lane.cars > 0 ? lane.revenue / lane.cars : 0,
        avgBrokerFee: lane.revenue > 0 ? (lane.brokerFees / (lane.revenue + lane.brokerFees)) * 100 : 0
      })).sort((a, b) => b.revenue - a.revenue);
      
      const totalRevenue = laneData.reduce((s, l) => s + l.revenue, 0);
      const totalMiles = laneData.reduce((s, l) => s + l.miles, 0);
      const avgRevenuePerMile = totalMiles > 0 ? totalRevenue / totalMiles : 0;
      
      const backhaulOpportunities = [];
      laneData.forEach(lane => {
        const reverseLane = laneData.find(l => l.origin === lane.destination && l.destination === lane.origin);
        if (reverseLane && lane.trips > reverseLane.trips) {
          backhaulOpportunities.push({ from: lane.destination, to: lane.origin, currentTrips: reverseLane.trips, potentialTrips: lane.trips - reverseLane.trips, avgRevenue: reverseLane.avgPerCar });
        }
      });
      
      return '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px"><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Active Lanes</div><div style="font-size:28px;font-weight:700;color:var(--blue)">' + laneData.length + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Total Revenue</div><div style="font-size:28px;font-weight:700;color:var(--green)">' + formatMoney(totalRevenue) + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Total Miles</div><div style="font-size:28px;font-weight:700;color:var(--purple)">' + totalMiles.toLocaleString() + '</div></div><div class="card" style="padding:20px;text-align:center"><div style="font-size:12px;color:var(--text-muted);margin-bottom:4px">Avg $/Mile</div><div style="font-size:28px;font-weight:700;color:' + (avgRevenuePerMile >= 2 ? 'var(--green)' : 'var(--amber)') + '">' + formatMoney(avgRevenuePerMile) + '</div></div></div>' +
        '<div class="card"><div class="card-header"><h3> Lane Performance</h3></div><div class="table-wrapper"><table><thead><tr><th>Lane</th><th>Trips</th><th>Cars</th><th>Miles</th><th>Revenue</th><th>$/Mile</th><th>$/Car</th><th>Broker Fee %</th><th>% of Total</th></tr></thead><tbody>' +
        laneData.slice(0, 15).map((lane, i) => '<tr><td><div style="display:flex;align-items:center;gap:8px">' + (i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : '') + '<strong>' + lane.lane + '</strong></div></td><td>' + lane.trips + '</td><td>' + lane.cars + '</td><td>' + lane.miles.toLocaleString() + '</td><td style="color:var(--green);font-weight:600">' + formatMoney(lane.revenue) + '</td><td><span style="padding:4px 8px;border-radius:12px;font-size:12px;font-weight:600;background:' + (lane.revenuePerMile >= 2.5 ? 'var(--green-dim)' : lane.revenuePerMile >= 1.5 ? 'var(--amber-dim)' : 'var(--red-dim)') + ';color:' + (lane.revenuePerMile >= 2.5 ? 'var(--green)' : lane.revenuePerMile >= 1.5 ? 'var(--amber)' : 'var(--red)') + '">' + formatMoney(lane.revenuePerMile) + '</span></td><td>' + formatMoney(lane.avgPerCar) + '</td><td style="color:' + (lane.avgBrokerFee <= 5 ? 'var(--green)' : lane.avgBrokerFee <= 10 ? 'var(--amber)' : 'var(--red)') + '">' + lane.avgBrokerFee.toFixed(1) + '%</td><td><div style="display:flex;align-items:center;gap:8px"><div style="width:60px;height:8px;background:var(--bg-darker);border-radius:4px;overflow:hidden"><div style="width:' + ((lane.revenue / totalRevenue) * 100) + '%;height:100%;background:var(--blue)"></div></div><span style="font-size:12px">' + ((lane.revenue / totalRevenue) * 100).toFixed(1) + '%</span></div></td></tr>').join('') +
        '</tbody></table></div></div>' +
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px"><div class="card"><div class="card-header"><h3> Best $/Mile Lanes</h3></div><div style="padding:16px">' + [...laneData].sort((a, b) => b.revenuePerMile - a.revenuePerMile).slice(0, 5).map((lane, i) => '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-darker);border-radius:8px;margin-bottom:8px"><div style="display:flex;align-items:center;gap:8px"><span style="font-size:16px">' + ['','','','4','5'][i] + '</span><span style="font-weight:600">' + lane.lane + '</span></div><span style="color:var(--green);font-weight:700">' + formatMoney(lane.revenuePerMile) + '/mi</span></div>').join('') + '</div></div>' +
        '<div class="card"><div class="card-header"><h3> Backhaul Opportunities</h3></div><div style="padding:16px">' + (backhaulOpportunities.length > 0 ? backhaulOpportunities.slice(0, 5).map(bh => '<div style="padding:12px;background:var(--bg-darker);border-radius:8px;margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-weight:600">' + bh.from + '  ' + bh.to + '</span><span style="color:var(--amber);font-size:12px">+' + bh.potentialTrips + ' potential</span></div><div style="font-size:12px;color:var(--text-muted);margin-top:4px">Current: ' + bh.currentTrips + ' trips  Avg ' + formatMoney(bh.avgRevenue) + '/car</div></div>').join('') : '<div style="color:var(--text-muted);text-align:center;padding:20px">No clear backhaul opportunities detected</div>') + '</div></div></div>' +
        ([...laneData].filter(l => l.revenuePerMile < 1.5 && l.trips >= 2).length > 0 ? '<div style="margin-top:16px;padding:16px;background:var(--red-dim);border-left:4px solid var(--red);border-radius:8px"><strong style="color:var(--red)"> Low $/Mile Lanes:</strong> <span style="color:var(--red)">' + [...laneData].filter(l => l.revenuePerMile < 1.5 && l.trips >= 2).map(l => l.lane + ' (' + formatMoney(l.revenuePerMile) + '/mi)').join(', ') + ' - Consider negotiating better rates or avoiding these lanes.</span></div>' : '');
    }

    function extractReportState(location) {
      if (!location) return 'Unknown';
      const stateMatch = location.match(/,\s*([A-Z]{2})(?:\s|$|,)/);
      if (stateMatch) return stateMatch[1];
      const stateNames = { 'California': 'CA', 'Florida': 'FL', 'Texas': 'TX', 'Arizona': 'AZ', 'Nevada': 'NV', 'Pennsylvania': 'PA', 'New York': 'NY', 'Georgia': 'GA', 'Illinois': 'IL', 'Ohio': 'OH', 'Michigan': 'MI', 'New Jersey': 'NJ', 'Colorado': 'CO', 'Washington': 'WA', 'Oregon': 'OR', 'North Carolina': 'NC', 'South Carolina': 'SC', 'Virginia': 'VA', 'Maryland': 'MD', 'Tennessee': 'TN', 'Indiana': 'IN', 'Missouri': 'MO', 'Minnesota': 'MN', 'Wisconsin': 'WI', 'Alabama': 'AL', 'Louisiana': 'LA', 'Kentucky': 'KY', 'Oklahoma': 'OK', 'Connecticut': 'CT', 'Utah': 'UT', 'Iowa': 'IA', 'Arkansas': 'AR', 'Mississippi': 'MS', 'Kansas': 'KS', 'New Mexico': 'NM', 'Nebraska': 'NE', 'Idaho': 'ID', 'West Virginia': 'WV', 'Hawaii': 'HI', 'Maine': 'ME', 'New Hampshire': 'NH', 'Montana': 'MT', 'Rhode Island': 'RI', 'Delaware': 'DE', 'South Dakota': 'SD', 'North Dakota': 'ND', 'Alaska': 'AK', 'Vermont': 'VT', 'Wyoming': 'WY' };
      for (const [name, abbr] of Object.entries(stateNames)) {
        if (location.includes(name)) return abbr;
      }
      return location.split(',')[0].substring(0, 10);
    }

    function exportReportCSV() {
      const filteredTrips = filterReportTripsByPeriod(appData.trips);
      const filteredOrders = appData.orders.filter(o => {
        const trip = appData.trips.find(t => t.id === o.trip_id);
        return trip && filteredTrips.includes(trip);
      });
      
      let csv = '';
      let filename = '';
      
      if (reportTab === 'truck_pl') {
        csv = 'Truck,Trips,Cars,Revenue,Driver Cut,Fuel,Other Costs,Net Profit,Margin %\n';
        filename = 'truck_pl_report';
        const trucks = appData.trucks.filter(t => t.status === 'ACTIVE');
        trucks.forEach(truck => {
          const truckTrips = filteredTrips.filter(t => t.truck_id === truck.id);
          const truckOrders = filteredOrders.filter(o => truckTrips.some(t => t.id === o.trip_id));
          const revenue = truckOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
          const brokerFees = truckOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
          const localFees = truckOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
          const cleanGross = revenue - brokerFees - localFees;
          csv += truck.truck_number + ',' + truckTrips.length + ',' + truckOrders.length + ',' + cleanGross.toFixed(2) + ',0,0,0,0,0\n';
        });
      } else if (reportTab === 'driver_performance') {
        csv = 'Driver,Trips,Cars,Miles,Revenue,Avg Per Car,Cut %,Earnings,Cash Collected\n';
        filename = 'driver_performance_report';
        (appData.drivers || []).forEach(driver => {
          const driverTrips = filteredTrips.filter(t => t.driver_id === driver.id);
          if (driverTrips.length === 0) return;
          const driverOrders = filteredOrders.filter(o => driverTrips.some(t => t.id === o.trip_id));
          const revenue = driverOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
          const miles = driverTrips.reduce((s, t) => s + parseFloat(t.miles || 0), 0);
          csv += driver.first_name + ' ' + driver.last_name + ',' + driverTrips.length + ',' + driverOrders.length + ',' + miles + ',' + revenue.toFixed(2) + ',0,32,0,0\n';
        });
      } else if (reportTab === 'lane_analysis') {
        csv = 'Lane,Trips,Cars,Miles,Revenue,Revenue Per Mile,Avg Per Car\n';
        filename = 'lane_analysis_report';
      }
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename + '_' + new Date().toISOString().split('T')[0] + '.csv';
      a.click();
      URL.revokeObjectURL(url);
      showToast('Report exported!');
    }

    // ============================================
    // AI FINANCIAL ADVISOR - ENHANCED (24 Features)
    // ============================================
    
    let aiAdvisorHistory = [];
    let aiAdvisorLoading = false;
    let aiAdvisorTab = 'chat';
    let aiGoals = JSON.parse(localStorage.getItem('ai_advisor_goals') || '[]');
    let aiAlerts = JSON.parse(localStorage.getItem('ai_advisor_alerts') || '{"profitMargin":15,"cashReserve":10000}');
    let scenarioData = { trucks: 0, drivers: 0, revenue: 0 };

    function renderAIAdvisor(c) {
      const apiKey = getApiKey();
      const hasApiKey = apiKey && apiKey.length > 10;
      const fs = getFinancialSummaryForAI();
      const alertsList = checkFinancialAlerts(fs);
      const tip = getDailyTip(fs);
      
      c.innerHTML = `
        <div class="header">
          <h2> AI Financial Advisor</h2>
          <div style="display:flex;gap:12px;align-items:center">
            <span style="font-size:13px;color:var(--text-muted)">Powered by Claude AI</span>
            ${hasApiKey ? '<span style="color:var(--green);font-size:12px"> API Connected</span>' : '<span style="color:var(--red);font-size:12px"> Add API Key in Settings</span>'}
          </div>
        </div>
        
        ${alertsList.length > 0 ? `
        <div style="margin-bottom:16px;padding:14px 16px;background:linear-gradient(135deg,var(--red),var(--red));border-radius:12px;border:1px solid var(--red)">
          <div style="display:flex;align-items:center;gap:10px;color:var(--red-dim)">
            <span style="font-size:20px"></span>
            <div>
              <div style="font-weight:600;color:var(--red-dim)">Financial Alerts</div>
              <div style="font-size:13px">${alertsList.join('  ')}</div>
            </div>
          </div>
        </div>` : ''}
        
        <div style="margin-bottom:16px;padding:14px 16px;background:linear-gradient(135deg,var(--text-primary),var(--blue));border-radius:12px;border:1px solid var(--blue)">
          <div style="display:flex;align-items:center;gap:10px;color:var(--blue-dim)">
            <span style="font-size:20px"></span>
            <div>
              <div style="font-weight:600;color:var(--blue-dim)">Daily Tip</div>
              <div style="font-size:13px">${tip}</div>
            </div>
          </div>
        </div>
        
        <div class="card" style="margin-bottom:20px;background:linear-gradient(135deg, var(--text-primary) 0%, var(--bg-elevated) 100%);border:1px solid var(--bg-elevated)">
          <div style="padding:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div style="font-size:13px;color:var(--text-muted)"> Your Financial Snapshot</div>
              <button class="btn btn-secondary btn-sm" onclick="generateWeeklyDigest()"> Weekly Digest</button>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px">
              <div style="background:rgba(0,0,0,0.2);padding:var(--spacing-3);border-radius:var(--radius)">
                <div style="font-size:var(--text-xs);color:var(--text-muted)">Monthly Revenue</div>
                <div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--green)">${formatMoney(fs.monthlyRevenue)}</div>
              </div>
              <div style="background:rgba(0,0,0,0.2);padding:var(--spacing-3);border-radius:var(--radius)">
                <div style="font-size:var(--text-xs);color:var(--text-muted)">Monthly Profit</div>
                <div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:${fs.monthlyProfit >= 0 ? 'var(--green)' : 'var(--red)'}">${formatMoney(fs.monthlyProfit)}</div>
              </div>
              <div style="background:rgba(0,0,0,0.2);padding:var(--spacing-3);border-radius:var(--radius)">
                <div style="font-size:var(--text-xs);color:var(--text-muted)">Active Trucks</div>
                <div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--blue)">${fs.activeTrucks}</div>
              </div>
              <div style="background:rgba(0,0,0,0.2);padding:var(--spacing-3);border-radius:var(--radius)">
                <div style="font-size:var(--text-xs);color:var(--text-muted)">Profit/Truck</div>
                <div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--amber)">${formatMoney(fs.profitPerTruck)}</div>
              </div>
              <div style="background:rgba(0,0,0,0.2);padding:var(--spacing-3);border-radius:var(--radius)">
                <div style="font-size:var(--text-xs);color:var(--text-muted)">Cash on Hand</div>
                <div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:var(--purple)">${formatMoney(fs.cashOnHand)}</div>
              </div>
              <div style="background:rgba(0,0,0,0.2);padding:var(--spacing-3);border-radius:var(--radius)">
                <div style="font-size:var(--text-xs);color:var(--text-muted)">Profit Margin</div>
                <div style="font-size:var(--text-lg);font-weight:var(--weight-bold);color:${fs.profitMargin >= 25 ? 'var(--green)' : fs.profitMargin >= 15 ? 'var(--amber)' : 'var(--red)'}">${fs.profitMargin.toFixed(1)}%</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Tab Navigation -->
        <div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap">
          <button class="btn ${aiAdvisorTab === 'chat' ? 'btn-primary' : 'btn-secondary'}" onclick="switchAITab('chat')"> Chat</button>
          <button class="btn ${aiAdvisorTab === 'tools' ? 'btn-primary' : 'btn-secondary'}" onclick="switchAITab('tools')"> Tools</button>
          <button class="btn ${aiAdvisorTab === 'scenario' ? 'btn-primary' : 'btn-secondary'}" onclick="switchAITab('scenario')"> Scenario</button>
          <button class="btn ${aiAdvisorTab === 'goals' ? 'btn-primary' : 'btn-secondary'}" onclick="switchAITab('goals')"> Goals</button>
          <button class="btn ${aiAdvisorTab === 'analysis' ? 'btn-primary' : 'btn-secondary'}" onclick="switchAITab('analysis')"> Analysis</button>
          <button class="btn ${aiAdvisorTab === 'alerts' ? 'btn-primary' : 'btn-secondary'}" onclick="switchAITab('alerts')"> Alerts</button>
        </div>
        
        <div id="aiTabContent"></div>
        
        <style>
          .typing-dot { width:8px; height:8px; background:var(--text-muted); border-radius:50%; animation:typingBounce 1s infinite; display:inline-block; }
          @keyframes typingBounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-8px)} }
          .goal-card { background:var(--bg-darker); border-radius:12px; padding:16px; margin-bottom:12px; }
          .progress-bar { height:8px; background:var(--bg-card); border-radius:4px; overflow:hidden; }
          .progress-fill { height:100%; border-radius:4px; transition:width 0.3s; }
        </style>
      `;
      
      // Render active tab content
      const tabContent = document.getElementById('aiTabContent');
      if (aiAdvisorTab === 'chat') renderAIChatTab(tabContent, hasApiKey);
      else if (aiAdvisorTab === 'tools') renderAIToolsTab(tabContent, fs);
      else if (aiAdvisorTab === 'scenario') renderAIScenarioTab(tabContent, fs);
      else if (aiAdvisorTab === 'goals') renderAIGoalsTab(tabContent, fs);
      else if (aiAdvisorTab === 'analysis') renderAIAnalysisTab(tabContent, fs);
      else if (aiAdvisorTab === 'alerts') renderAIAlertsTab(tabContent);
    }
    
    function switchAITab(tab) {
      aiAdvisorTab = tab;
      renderAIAdvisor(document.getElementById('main-content'));
    }

    // Chat Tab
    function renderAIChatTab(c, hasApiKey) {
      c.innerHTML = `
        <div style="margin-bottom:16px">
          <div style="font-size:13px;color:var(--text-muted);margin-bottom:10px"> Quick questions:</div>
          <div style="display:flex;flex-wrap:wrap;gap:8px">
            <button class="btn btn-secondary" style="font-size:11px" onclick="askAIAdvisor('Can we afford to buy a new truck for $100,000?')"> Afford $100K truck?</button>
            <button class="btn btn-secondary" style="font-size:11px" onclick="askAIAdvisor('Should we hire another driver?')"> Hire driver?</button>
            <button class="btn btn-secondary" style="font-size:11px" onclick="askAIAdvisor('What is our break-even point per truck?')"> Break-even?</button>
            <button class="btn btn-secondary" style="font-size:11px" onclick="askAIAdvisor('How can we improve profitability?')"> Improve profits?</button>
            <button class="btn btn-secondary" style="font-size:11px" onclick="askAIAdvisor('Analyze our best and worst lanes')"> Lane analysis</button>
            <button class="btn btn-secondary" style="font-size:11px" onclick="askAIAdvisor('Which broker is most profitable?')"> Best broker?</button>
            <button class="btn btn-secondary" style="font-size:11px" onclick="askAIAdvisor('What are our biggest financial risks?')"> Risks?</button>
            <button class="btn btn-secondary" style="font-size:11px" onclick="askAIAdvisor('How much cash reserve should we have?')"> Cash reserve?</button>
          </div>
        </div>
        
        <div class="card" style="display:flex;flex-direction:column;height:420px">
          <div class="card-header" style="border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
            <h3> Chat with AI Advisor</h3>
            <div style="display:flex;gap:8px">
              <button class="btn btn-secondary btn-sm" onclick="exportAIChat()"> Export</button>
              <button class="btn btn-secondary btn-sm" onclick="clearAIAdvisorHistory()"> Clear</button>
            </div>
          </div>
          
          <div id="aiAdvisorMessages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:16px">
            ${aiAdvisorHistory.length === 0 ? `
              <div style="text-align:center;color:var(--text-muted);padding:40px">
                <div style="font-size:48px;margin-bottom:16px"></div>
                <div style="font-size:16px;font-weight:600;margin-bottom:8px">AI Financial Advisor</div>
                <div style="font-size:13px">Ask me anything about your business finances.<br>I analyze your real data to give specific advice.</div>
              </div>
            ` : aiAdvisorHistory.map(msg => `
              <div style="display:flex;gap:12px;${msg.role === 'user' ? 'flex-direction:row-reverse' : ''}">
                <div style="width:36px;height:36px;border-radius:50%;background:${msg.role === 'user' ? 'var(--blue)' : 'var(--green)'};display:flex;align-items:center;justify-content:center;flex-shrink:0">
                  ${msg.role === 'user' ? '' : ''}
                </div>
                <div style="max-width:80%;padding:12px 16px;border-radius:12px;background:${msg.role === 'user' ? 'var(--blue)' : 'var(--bg-darker)'};color:${msg.role === 'user' ? 'white' : 'var(--text-primary)'}">
                  <div style="white-space:pre-wrap;font-size:14px;line-height:1.6">${formatAIMessage(msg.content)}</div>
                </div>
              </div>
            `).join('')}
            ${aiAdvisorLoading ? `
              <div style="display:flex;gap:12px">
                <div style="width:36px;height:36px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;flex-shrink:0"></div>
                <div style="padding:12px 16px;border-radius:12px;background:var(--bg-darker)">
                  <span class="typing-dot"></span>
                  <span class="typing-dot" style="animation-delay:0.2s"></span>
                  <span class="typing-dot" style="animation-delay:0.4s"></span>
                </div>
              </div>
            ` : ''}
          </div>
          
          <div style="padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:12px">
            <button class="btn btn-secondary" onclick="startVoiceInput()" title="Voice input"></button>
            <input type="text" id="aiAdvisorInput" placeholder="Ask about your finances..." style="flex:1;padding:12px 16px;border-radius:8px;border:1px solid var(--border);background:var(--bg-darker);color:var(--text-primary);font-size:14px" onkeypress="if(event.key==='Enter')sendAIAdvisorMessage()">
            <button class="btn btn-primary" onclick="sendAIAdvisorMessage()" ${!hasApiKey ? 'disabled' : ''}>Send </button>
          </div>
        </div>
      `;
      setTimeout(() => { const m = document.getElementById('aiAdvisorMessages'); if(m) m.scrollTop = m.scrollHeight; }, 100);
    }

    function getFinancialSummaryForAI() {
      const now = new Date();
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      
      const monthlyTrips = appData.trips.filter(t => {
        if (!t.trip_date) return false;
        const d = new Date(t.trip_date);
        return d >= startOfMonth && d <= endOfMonth;
      });
      
      const monthlyOrders = appData.orders.filter(o => monthlyTrips.some(t => t.id === o.trip_id));
      const grossRevenue = monthlyOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
      const brokerFees = monthlyOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
      const localFees = monthlyOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
      const monthlyRevenue = grossRevenue - brokerFees - localFees;
      
      const driverCuts = monthlyTrips.reduce((sum, trip) => {
        const tripOrders = monthlyOrders.filter(o => o.trip_id === trip.id);
        const tripRevenue = tripOrders.reduce((s, o) => s + parseFloat(o.revenue || 0), 0);
        const tripBroker = tripOrders.reduce((s, o) => s + parseFloat(o.broker_fee || 0), 0);
        const tripLocal = tripOrders.reduce((s, o) => s + parseFloat(o.local_fee || 0), 0);
        const tripClean = tripRevenue - tripBroker - tripLocal;
        return sum + (tripClean * ((trip.driver_cut_percent || 32) / 100));
      }, 0);
      
      const tripIds = monthlyTrips.map(t => t.id);
      const monthlyExpenses = (appData.expenses || []).filter(e => tripIds.includes(e.trip_id)).reduce((s, e) => s + parseFloat(e.amount || 0), 0);
      const monthlyFixedCosts = (appData.fixed_costs || []).reduce((s, fc) => s + parseFloat(fc.amount || 0), 0);
      const activeTrucks = appData.trucks.filter(t => t.status === 'ACTIVE').length;
      const monthlyProfit = monthlyRevenue - driverCuts - monthlyExpenses - monthlyFixedCosts;
      const profitPerTruck = activeTrucks > 0 ? monthlyProfit / activeTrucks : 0;
      const cashCollected = monthlyOrders.filter(o => o.driver_paid_status === 'PAID').reduce((s, o) => s + parseFloat(o.driver_paid_amount || 0), 0);
      const outstanding = monthlyOrders.filter(o => o.driver_paid_status !== 'PAID' && (o.payment_type === 'COD' || o.payment_type === 'COP' || o.payment_type === 'LOCAL_COD')).reduce((s, o) => s + parseFloat(o.revenue || 0), 0);

      return {
        monthlyRevenue, monthlyProfit, activeTrucks, profitPerTruck,
        cashOnHand: cashCollected, monthlyFixedCosts, driverCuts, monthlyExpenses,
        totalTrips: monthlyTrips.length, totalCars: monthlyOrders.length, outstanding,
        avgRevenuePerCar: monthlyOrders.length > 0 ? monthlyRevenue / monthlyOrders.length : 0,
        avgTripsPerTruck: activeTrucks > 0 ? monthlyTrips.length / activeTrucks : 0,
        drivers: appData.drivers?.length || 0,
        brokerFeePercent: grossRevenue > 0 ? (brokerFees / grossRevenue) * 100 : 0,
        profitMargin: monthlyRevenue > 0 ? (monthlyProfit / monthlyRevenue) * 100 : 0
      };
    }

    // Tools Tab
    function renderAIToolsTab(c, fs) {
      const breakEven = fs.monthlyFixedCosts / Math.max(fs.activeTrucks, 1) / ((100 - 32 - fs.brokerFeePercent) / 100);
      const carsNeeded = fs.avgRevenuePerCar > 0 ? Math.ceil(breakEven / fs.avgRevenuePerCar) : 0;
      
      c.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px">
          <div class="card">
            <div class="card-header"><h3> Break-Even Calculator</h3></div>
            <div style="padding:16px">
              <div style="background:var(--bg-darker);padding:var(--spacing-4);border-radius:var(--radius);margin-bottom:16px">
                <div style="font-size:12px;color:var(--text-muted)">Break-Even per Truck/Month</div>
                <div style="font-size:28px;font-weight:700;color:var(--amber)">${formatMoney(breakEven)}</div>
                <div style="font-size:12px;color:var(--text-muted);margin-top:8px">= ${carsNeeded} cars at ${formatMoney(fs.avgRevenuePerCar)}/car</div>
              </div>
              <div style="font-size:13px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
                <div>Fixed/Truck: <strong>${formatMoney(fs.monthlyFixedCosts / Math.max(fs.activeTrucks, 1))}</strong></div>
                <div>Status: <strong style="color:${fs.monthlyRevenue > breakEven * fs.activeTrucks ? 'var(--green)' : 'var(--red)'}">${fs.monthlyRevenue > breakEven * fs.activeTrucks ? ' Above' : ' Below'}</strong></div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header"><h3> Loan Calculator</h3></div>
            <div style="padding:16px">
              <div class="form-group"><label>Loan Amount ($)</label><input type="number" id="loanAmt" value="100000" onchange="calcLoan()" style="width:100%"></div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                <div class="form-group"><label>Interest (%)</label><input type="number" id="loanRate" value="8" step="0.1" onchange="calcLoan()" style="width:100%"></div>
                <div class="form-group"><label>Term (mo)</label><input type="number" id="loanTerm" value="60" onchange="calcLoan()" style="width:100%"></div>
              </div>
              <div id="loanResult" style="background:var(--bg-darker);padding:var(--spacing-4);border-radius:var(--radius);margin-top:12px">
                <div style="font-size:12px;color:var(--text-muted)">Monthly Payment</div>
                <div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--blue)">$2,028</div>
                <div style="font-size:12px;margin-top:8px;color:${fs.monthlyProfit > 2028 ? 'var(--green)' : 'var(--red)'}">${fs.monthlyProfit > 2028 ? ' Affordable' : ' Exceeds profit'}</div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header"><h3> New Truck ROI</h3></div>
            <div style="padding:16px">
              <div class="form-group"><label>Truck Cost ($)</label><input type="number" id="truckCost" value="100000" onchange="calcTruckROI()" style="width:100%"></div>
              <div id="truckROI" style="background:var(--bg-darker);padding:var(--spacing-4);border-radius:var(--radius)">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
                  <div><div style="font-size:12px;color:var(--text-muted)">Est. Monthly Profit</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--green)">${formatMoney(fs.profitPerTruck)}</div></div>
                  <div><div style="font-size:12px;color:var(--text-muted)">Payback</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--blue)">${fs.profitPerTruck > 0 ? Math.ceil(100000 / fs.profitPerTruck) : ''} mo</div></div>
                </div>
                <div style="margin-top:12px;font-size:12px;color:var(--text-muted)">ROI: <strong style="color:var(--amber)">${fs.profitPerTruck > 0 ? ((fs.profitPerTruck * 12 / 100000) * 100).toFixed(1) : 0}%</strong>/year</div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header"><h3> 6-Month Cash Forecast</h3></div>
            <div style="padding:16px">${renderCashForecast(fs)}</div>
          </div>
        </div>
      `;
      calcLoan();
    }
    
    function calcLoan() {
      const a = parseFloat(document.getElementById('loanAmt')?.value || 100000);
      const r = parseFloat(document.getElementById('loanRate')?.value || 8) / 100 / 12;
      const t = parseInt(document.getElementById('loanTerm')?.value || 60);
      const pmt = (a * r * Math.pow(1+r,t)) / (Math.pow(1+r,t) - 1);
      const fs = getFinancialSummaryForAI();
      const el = document.getElementById('loanResult');
      if (el) el.innerHTML = '<div style="font-size:12px;color:var(--text-muted)">Monthly Payment</div><div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--blue)">' + formatMoney(pmt) + '</div><div style="font-size:12px;margin-top:8px;color:' + (fs.monthlyProfit > pmt ? 'var(--green)' : 'var(--red)') + '">' + (fs.monthlyProfit > pmt ? ' Affordable' : ' Exceeds profit') + '</div>';
    }
    
    function calcTruckROI() {
      const cost = parseFloat(document.getElementById('truckCost')?.value || 100000);
      const fs = getFinancialSummaryForAI();
      const el = document.getElementById('truckROI');
      if (el) el.innerHTML = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div><div style="font-size:12px;color:var(--text-muted)">Est. Monthly Profit</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--green)">' + formatMoney(fs.profitPerTruck) + '</div></div><div><div style="font-size:12px;color:var(--text-muted)">Payback</div><div style="font-size:var(--text-xl);font-weight:var(--weight-bold);color:var(--blue)">' + (fs.profitPerTruck > 0 ? Math.ceil(cost / fs.profitPerTruck) : '') + ' mo</div></div></div><div style="margin-top:12px;font-size:12px;color:var(--text-muted)">ROI: <strong style="color:var(--amber)">' + (fs.profitPerTruck > 0 ? ((fs.profitPerTruck * 12 / cost) * 100).toFixed(1) : 0) + '%</strong>/year</div>';
    }
    
    function renderCashForecast(fs) {
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const cm = new Date().getMonth();
      let cash = fs.cashOnHand;
      let html = '<div style="display:flex;gap:6px;align-items:flex-end;height:100px">';
      for (let i = 0; i < 6; i++) {
        cash += fs.monthlyProfit * (0.85 + Math.random() * 0.3);
        html += '<div style="flex:1;text-align:center"><div style="background:' + (cash >= 0 ? 'var(--green)' : 'var(--red)') + ';height:' + Math.min(Math.max(cash/500, 10), 70) + 'px;border-radius:4px 4px 0 0"></div><div style="font-size:9px;color:var(--text-muted);margin-top:4px">' + months[(cm+i)%12] + '</div></div>';
      }
      html += '</div><div style="margin-top:12px;font-size:12px;color:var(--text-muted)">Projected: <strong style="color:var(--green)">' + formatMoney(cash) + '</strong></div>';
      return html;
    }

    // Scenario Tab
    function renderAIScenarioTab(c, fs) {
      const addTrucks = scenarioData.trucks || 0;
      const addDrivers = scenarioData.drivers || 0;
      const revChange = scenarioData.revenue || 0;
      
      const avgRevPerTruck = fs.activeTrucks > 0 ? fs.monthlyRevenue / fs.activeTrucks : 0;
      const newRevenue = (fs.monthlyRevenue + addTrucks * avgRevPerTruck) * (1 + revChange/100);
      const addedCosts = addTrucks * (fs.monthlyFixedCosts / Math.max(fs.activeTrucks,1)) * 0.8 + addDrivers * 4000;
      const newProfit = newRevenue - (fs.monthlyRevenue - fs.monthlyProfit) - addedCosts;
      const profitDiff = newProfit - fs.monthlyProfit;
      
      c.innerHTML = `
        <div class="card">
          <div class="card-header"><h3> What-If Scenario Planner</h3></div>
          <div style="padding:20px">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px">
              <div class="form-group"><label>Add Trucks</label><input type="number" value="${addTrucks}" min="0" max="10" onchange="scenarioData.trucks=+this.value;switchAITab('scenario')" style="width:100%"></div>
              <div class="form-group"><label>Add Drivers</label><input type="number" value="${addDrivers}" min="0" max="10" onchange="scenarioData.drivers=+this.value;switchAITab('scenario')" style="width:100%"></div>
              <div class="form-group"><label>Revenue Change (%)</label><input type="number" value="${revChange}" min="-50" max="100" onchange="scenarioData.revenue=+this.value;switchAITab('scenario')" style="width:100%"></div>
            </div>
            
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
              <div style="background:var(--bg-darker);padding:20px;border-radius:12px">
                <div style="font-weight:600;color:var(--text-muted);margin-bottom:16px"> Current</div>
                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span>Trucks</span><strong>${fs.activeTrucks}</strong></div>
                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)"><span>Revenue</span><strong style="color:var(--green)">${formatMoney(fs.monthlyRevenue)}</strong></div>
                <div style="display:flex;justify-content:space-between;padding:8px 0"><span>Profit</span><strong style="color:${fs.monthlyProfit >= 0 ? 'var(--green)' : 'var(--red)'}">${formatMoney(fs.monthlyProfit)}</strong></div>
              </div>
              <div style="background:linear-gradient(135deg,var(--text-primary),var(--blue));padding:20px;border-radius:12px;border:2px solid var(--blue)">
                <div style="font-weight:600;color:var(--blue);margin-bottom:16px"> Projected</div>
                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);color:var(--blue-dim)"><span>Trucks</span><strong>${fs.activeTrucks + addTrucks}</strong></div>
                <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1);color:var(--blue-dim)"><span>Revenue</span><strong style="color:var(--green)">${formatMoney(newRevenue)}</strong></div>
                <div style="display:flex;justify-content:space-between;padding:8px 0;color:var(--blue-dim)"><span>Profit</span><strong style="color:${newProfit >= 0 ? 'var(--green)' : 'var(--red)'}">${formatMoney(newProfit)}</strong></div>
              </div>
            </div>
            
            <div style="margin-top:20px;padding:16px;background:${profitDiff >= 0 ? 'var(--green-dim)' : 'var(--red-dim)'};border-radius:8px">
              <div style="font-weight:600;color:${profitDiff >= 0 ? 'var(--green)' : 'var(--red)'}">${profitDiff >= 0 ? ' Positive Impact' : ' Negative Impact'}</div>
              <div style="font-size:13px;color:${profitDiff >= 0 ? 'var(--green)' : 'var(--red)'}">Profit change: <strong>${formatMoney(profitDiff)}</strong>/month</div>
            </div>
            
            <button class="btn btn-primary" style="margin-top:16px" onclick="askAIAdvisor('Analyze scenario: adding ${addTrucks} trucks, ${addDrivers} drivers, ${revChange}% revenue change. Good idea?')"> Get AI Analysis</button>
          </div>
        </div>
      `;
    }

    // Goals Tab
    function renderAIGoalsTab(c, fs) {
      c.innerHTML = `
        <div class="card">
          <div class="card-header"><h3> Financial Goals</h3><button class="btn btn-primary btn-sm" onclick="openGoalModal()">+ Add Goal</button></div>
          <div style="padding:16px">
            ${aiGoals.length === 0 ? '<div style="text-align:center;padding:40px;color:var(--text-muted)"><div style="font-size:48px;margin-bottom:16px"></div><div>No goals yet. Add your first financial goal!</div></div>' : aiGoals.map((g, i) => {
              let current = 0;
              if (g.type === 'revenue') current = fs.monthlyRevenue;
              else if (g.type === 'profit') current = fs.monthlyProfit;
              else if (g.type === 'savings') current = fs.cashOnHand;
              else if (g.type === 'trucks') current = fs.activeTrucks;
              else if (g.type === 'margin') current = fs.profitMargin;
              const pct = g.target > 0 ? Math.min((current / g.target) * 100, 100) : 0;
              return '<div class="goal-card"><div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px"><div><div style="font-weight:600">' + (g.icon||'') + ' ' + g.name + '</div>' + (g.description ? '<div style="font-size:12px;color:var(--text-muted)">' + g.description + '</div>' : '') + '</div><button class="btn btn-secondary btn-sm" onclick="deleteGoal(' + i + ')"></button></div><div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:8px"><span>' + formatMoney(current) + ' / ' + formatMoney(g.target) + '</span><span style="color:' + (pct >= 100 ? 'var(--green)' : pct >= 50 ? 'var(--amber)' : 'var(--text-secondary)') + '">' + pct.toFixed(0) + '%</span></div><div class="progress-bar"><div class="progress-fill" style="width:' + pct + '%;background:' + (pct >= 100 ? 'var(--green)' : pct >= 50 ? 'var(--amber)' : 'var(--blue)') + '"></div></div>' + (pct >= 100 ? '<div style="margin-top:8px;font-size:var(--text-xs);color:var(--green)"> Goal achieved!</div>' : '') + '</div>';
            }).join('')}
          </div>
        </div>
      `;
    }
    
    function openGoalModal() {
      const m = document.createElement('div');
      m.className = 'modal-overlay';
      m.innerHTML = '<div class="modal" style="max-width:400px"><div class="modal-header"><h3> Add Goal</h3><button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()"></button></div><div class="modal-body"><div class="form-group"><label>Goal Name</label><input type="text" id="goalName" placeholder="Save for new truck"></div><div class="form-group"><label>Type</label><select id="goalType"><option value="savings"> Savings</option><option value="revenue"> Revenue</option><option value="profit"> Profit</option><option value="margin"> Margin %</option><option value="trucks"> Trucks</option></select></div><div class="form-group"><label>Target</label><input type="number" id="goalTarget" placeholder="50000"></div><div class="form-group"><label>Description</label><input type="text" id="goalDesc" placeholder="Optional"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="this.closest(\'.modal-overlay\').remove()">Cancel</button><button class="btn btn-primary" onclick="saveGoal()">Save</button></div></div>';
      document.body.appendChild(m);
    }
    
    function saveGoal() {
      const name = document.getElementById('goalName').value;
      const type = document.getElementById('goalType').value;
      const target = parseFloat(document.getElementById('goalTarget').value);
      const desc = document.getElementById('goalDesc').value;
      if (!name || !target) { showToast('Fill name and target', 'error'); return; }
      const icons = {savings:'',revenue:'',profit:'',margin:'',trucks:''};
      aiGoals.push({name, type, target, description: desc, icon: icons[type]});
      localStorage.setItem('ai_advisor_goals', JSON.stringify(aiGoals));
      document.querySelector('.modal-overlay').remove();
      switchAITab('goals');
      showToast('Goal added!');
    }
    
    function deleteGoal(i) {
      if (!confirm('Delete this goal?')) return;
      aiGoals.splice(i, 1);
      localStorage.setItem('ai_advisor_goals', JSON.stringify(aiGoals));
      switchAITab('goals');
    }

    // Analysis Tab
    function renderAIAnalysisTab(c, fs) {
      const brokers = analyzeBrokersForAI();
      const lanes = analyzeLanesForAI();
      const risks = analyzeRisksForAI(fs);
      
      c.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:16px">
          <div class="card">
            <div class="card-header"><h3> Broker Scorecard</h3></div>
            <div style="padding:16px">
              ${brokers.length === 0 ? '<div style="color:var(--text-muted);text-align:center;padding:20px">No broker data</div>' : '<table style="width:100%;font-size:13px"><thead><tr style="border-bottom:2px solid var(--border)"><th style="text-align:left;padding:8px">Broker</th><th style="text-align:right;padding:8px">Revenue</th><th style="text-align:right;padding:8px">Fee %</th></tr></thead><tbody>' + brokers.slice(0,5).map((b,i) => '<tr style="border-bottom:1px solid var(--border)"><td style="padding:8px">' + (i===0?'':i===1?'':i===2?'':'') + ' ' + escapeHtml(b.name) + '</td><td style="text-align:right;padding:8px;color:var(--green)">' + formatMoney(b.revenue) + '</td><td style="text-align:right;padding:8px;color:' + (b.feeRate<=5?'var(--green)':b.feeRate<=10?'var(--amber)':'var(--red)') + '">' + b.feeRate.toFixed(1) + '%</td></tr>').join('') + '</tbody></table>'}
            </div>
          </div>
          
          <div class="card">
            <div class="card-header"><h3> Lane Optimizer</h3></div>
            <div style="padding:16px">
              <div style="margin-bottom:16px"><div style="font-size:12px;color:var(--text-muted);margin-bottom:8px"> Best Lanes</div>${lanes.best.slice(0,3).map(l => '<div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-darker);border-radius:6px;margin-bottom:6px"><span>' + escapeHtml(l.lane) + '</span><span style="color:var(--green);font-weight:600">' + formatMoney(l.rpm) + '/mi</span></div>').join('')}</div>
              <div><div style="font-size:12px;color:var(--text-muted);margin-bottom:8px"> Avoid</div>${lanes.worst.slice(0,3).map(l => '<div style="display:flex;justify-content:space-between;padding:8px;background:var(--red-dim);border-radius:6px;margin-bottom:6px"><span style="color:var(--red)">' + escapeHtml(l.lane) + '</span><span style="color:var(--red);font-weight:600">' + formatMoney(l.rpm) + '/mi</span></div>').join('')}</div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header"><h3> Risk Analysis</h3></div>
            <div style="padding:16px">
              ${risks.length === 0 ? '<div style="background:var(--green-dim);padding:var(--spacing-4);border-radius:var(--radius);text-align:center"><div style="font-size:24px"></div><div style="color:var(--green);font-weight:600">No major risks</div></div>' : risks.map(r => '<div style="display:flex;gap:12px;padding:12px;background:' + (r.high?'var(--red-dim)':'var(--amber-dim)') + ';border-radius:8px;margin-bottom:8px"><span style="font-size:20px">' + (r.high?'':'') + '</span><div><div style="font-weight:600;color:' + (r.high?'var(--red)':'var(--amber)') + '">' + r.title + '</div><div style="font-size:12px;color:' + (r.high?'var(--red)':'var(--amber)') + '">' + r.desc + '</div></div></div>').join('')}
            </div>
          </div>
        </div>
      `;
    }
    
    function analyzeBrokersForAI() {
      const data = {};
      appData.orders.forEach(o => {
        const broker = appData.brokers?.find(b => b.id === o.broker_id);
        const name = broker?.name || 'Unknown';
        if (!data[name]) data[name] = {name, revenue: 0, fees: 0};
        data[name].revenue += parseFloat(o.revenue || 0);
        data[name].fees += parseFloat(o.broker_fee || 0);
      });
      return Object.values(data).map(b => ({...b, feeRate: b.revenue > 0 ? (b.fees/b.revenue)*100 : 0})).sort((a,b) => b.revenue - a.revenue);
    }
    
    function analyzeLanesForAI() {
      const data = new Map();
      appData.trips.forEach(t => {
        if (!t.origin || !t.destination) return;
        const key = extractReportState(t.origin) + '' + extractReportState(t.destination);
        const orders = appData.orders.filter(o => o.trip_id === t.id);
        const rev = orders.reduce((s,o) => s + parseFloat(o.revenue||0), 0);
        const mi = parseFloat(t.miles||0);
        if (!data.has(key)) data.set(key, {lane:key, revenue:0, miles:0, trips:0});
        const l = data.get(key);
        l.revenue += rev; l.miles += mi; l.trips++;
      });
      const lanes = Array.from(data.values()).map(l => ({...l, rpm: l.miles > 0 ? l.revenue/l.miles : 0})).filter(l => l.trips >= 2);
      return { best: lanes.sort((a,b) => b.rpm - a.rpm), worst: lanes.sort((a,b) => a.rpm - b.rpm) };
    }
    
    function analyzeRisksForAI(fs) {
      const risks = [];
      if (fs.profitMargin < 10) risks.push({high:true, title:'Low Profit Margin', desc: fs.profitMargin.toFixed(1) + '% is dangerously low'});
      if (fs.cashOnHand < fs.monthlyFixedCosts) risks.push({high:true, title:'Low Cash Reserve', desc:'Less than 1 month of fixed costs'});
      if (fs.outstanding > fs.monthlyRevenue * 0.5) risks.push({high:false, title:'High Receivables', desc: formatMoney(fs.outstanding) + ' outstanding'});
      if (fs.activeTrucks <= 2) risks.push({high:false, title:'Concentration Risk', desc:'Only ' + fs.activeTrucks + ' trucks - one breakdown hurts'});
      return risks;
    }

    // Alerts Tab
    function renderAIAlertsTab(c) {
      c.innerHTML = `
        <div class="card">
          <div class="card-header"><h3> Alert Configuration</h3></div>
          <div style="padding:20px">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px">
              <div class="form-group"><label> Alert when profit margin below (%)</label><input type="number" value="${aiAlerts.profitMargin}" onchange="aiAlerts.profitMargin=+this.value;saveAIAlerts()" style="width:100%"></div>
              <div class="form-group"><label> Alert when cash reserve below ($)</label><input type="number" value="${aiAlerts.cashReserve}" onchange="aiAlerts.cashReserve=+this.value;saveAIAlerts()" style="width:100%"></div>
            </div>
            <button class="btn btn-primary" style="margin-top:16px" onclick="showToast('Settings saved!')">Save Settings</button>
          </div>
        </div>
      `;
    }
    
    function saveAIAlerts() { localStorage.setItem('ai_advisor_alerts', JSON.stringify(aiAlerts)); }

    // Helper Functions
    function checkFinancialAlerts(fs) {
      const alerts = [];
      if (fs.profitMargin < aiAlerts.profitMargin) alerts.push('Profit margin ' + fs.profitMargin.toFixed(1) + '% below ' + aiAlerts.profitMargin + '%');
      if (fs.cashOnHand < aiAlerts.cashReserve) alerts.push('Cash ' + formatMoney(fs.cashOnHand) + ' below ' + formatMoney(aiAlerts.cashReserve));
      return alerts;
    }
    
    function getDailyTip(fs) {
      const tips = [
        fs.profitMargin < 20 ? 'Your margin is ' + fs.profitMargin.toFixed(1) + '%. Consider raising rates by $50-100/car.' : null,
        fs.avgTripsPerTruck < 2 ? 'Averaging ' + fs.avgTripsPerTruck.toFixed(1) + ' trips/truck. Target is 2+.' : null,
        fs.brokerFeePercent > 8 ? 'Broker fees at ' + fs.brokerFeePercent.toFixed(1) + '%. Negotiate lower rates.' : null,
        'A 5% rate increase would add ' + formatMoney(fs.monthlyRevenue * 0.05) + ' monthly.',
        fs.profitPerTruck > 3000 ? 'Great job! ' + formatMoney(fs.profitPerTruck) + '/truck profit.' : 'Profit/truck: ' + formatMoney(fs.profitPerTruck) + '. Room to improve.'
      ].filter(Boolean);
      return tips[new Date().getDate() % tips.length] || 'Keep up the great work!';
    }
    
    function formatAIMessage(text) {
      // First escape HTML to prevent XSS, then apply markdown-style formatting
      const escaped = escapeHtml(text);
      return escaped.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
    }
    
    function startVoiceInput() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        showToast('Voice not supported', 'error'); return;
      }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const r = new SR();
      r.lang = 'en-US';
      r.onresult = e => { document.getElementById('aiAdvisorInput').value = e.results[0][0].transcript; showToast('Voice captured!'); };
      r.onerror = () => showToast('Voice failed', 'error');
      r.start();
      showToast('Listening...');
    }
    
    function exportAIChat() {
      if (aiAdvisorHistory.length === 0) { showToast('No chat to export', 'error'); return; }
      const txt = aiAdvisorHistory.map(m => (m.role === 'user' ? 'You' : 'AI') + ': ' + m.content).join('\n\n---\n\n');
      const blob = new Blob([txt], {type:'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ai_advisor_' + new Date().toISOString().split('T')[0] + '.txt';
      a.click();
      showToast('Chat exported!');
    }
    
    async function generateWeeklyDigest() {
      const apiKey = getApiKey();
      if (!apiKey) { showToast('Add API key first', 'error'); return; }
      showToast('Generating digest...');
      try {
        const ctx = getDetailedFinancialContext();
        const r = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-api-key': apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
          body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 1500, system: 'Generate a concise weekly financial digest. Include: 1) Key metrics, 2) Wins, 3) Concerns, 4) Action items. Be specific.', messages: [{role:'user', content: ctx}] })
        });
        const d = await r.json();
        aiAdvisorHistory = [{role:'assistant', content:' **Weekly Digest**\n\n' + d.content[0].text}];
        switchAITab('chat');
      } catch(e) { showToast('Error: ' + e.message, 'error'); }
    }

    function getDetailedFinancialContext() {
      const s = getFinancialSummaryForAI();
      const fc = (appData.fixed_costs || []).map(f => f.name + ': $' + parseFloat(f.amount||0).toFixed(2)).join(', ');
      
      // Get truck performance
      const truckPerf = appData.trucks.filter(t => t.status === 'ACTIVE').map(truck => {
        const trips = appData.trips.filter(t => t.truck_id === truck.id);
        const orders = appData.orders.filter(o => trips.some(t => t.id === o.trip_id));
        return truck.truck_number + ': ' + trips.length + ' trips, $' + orders.reduce((sum,o) => sum + parseFloat(o.revenue||0), 0).toFixed(0);
      }).join('; ');
      
      // Get lane data
      const laneMap = new Map();
      appData.trips.forEach(trip => {
        if (!trip.origin || !trip.destination) return;
        const key = extractReportState(trip.origin) + ' to ' + extractReportState(trip.destination);
        const orders = appData.orders.filter(o => o.trip_id === trip.id);
        const rev = orders.reduce((sum,o) => sum + parseFloat(o.revenue||0), 0);
        if (!laneMap.has(key)) laneMap.set(key, {trips:0, revenue:0, miles:0});
        const l = laneMap.get(key);
        l.trips++; l.revenue += rev; l.miles += parseFloat(trip.miles||0);
      });
      const topLanes = Array.from(laneMap.entries()).map(([lane, d]) => lane + ': ' + d.trips + ' trips, $' + (d.miles>0 ? (d.revenue/d.miles).toFixed(2) : '0') + '/mi').slice(0,5).join('; ');
      
      return 'FINANCIAL DATA FOR HORIZON STAR LLC:\n\n' +
        'CURRENT MONTH: Revenue: $' + s.monthlyRevenue.toFixed(2) + ', Profit: $' + s.monthlyProfit.toFixed(2) + ', Margin: ' + s.profitMargin.toFixed(1) + '%, Trucks: ' + s.activeTrucks + ', Drivers: ' + s.drivers + ', Trips: ' + s.totalTrips + ', Cars: ' + s.totalCars + ', Avg/Car: $' + s.avgRevenuePerCar.toFixed(2) + ', Profit/Truck: $' + s.profitPerTruck.toFixed(2) + '\n\n' +
        'COSTS: Driver Cuts: $' + s.driverCuts.toFixed(2) + ', Expenses: $' + s.monthlyExpenses.toFixed(2) + ', Fixed: $' + s.monthlyFixedCosts.toFixed(2) + ' (' + fc + '), Broker Fees: ' + s.brokerFeePercent.toFixed(1) + '%\n\n' +
        'CASH: On Hand: $' + s.cashOnHand.toFixed(2) + ', Outstanding: $' + s.outstanding.toFixed(2) + '\n\n' +
        'TRUCKS: ' + truckPerf + '\n\n' +
        'TOP LANES: ' + topLanes + '\n\n' +
        'CONTEXT: Auto transport carrier between PA, CA, FL. Driver cut typically 32%. Target 2+ trips/truck/month. Healthy margin is 25%+.';
    }

    function askAIAdvisor(question) {
      document.getElementById('aiAdvisorInput').value = question;
      aiAdvisorTab = 'chat';
      renderAIAdvisor(document.getElementById('main-content'));
      setTimeout(sendAIAdvisorMessage, 100);
    }

    async function sendAIAdvisorMessage() {
      const input = document.getElementById('aiAdvisorInput');
      const question = input.value.trim();
      if (!question) return;
      
      const apiKey = getApiKey();
      if (!apiKey) {
        showToast('Please add your Anthropic API key in Settings first', 'error');
        return;
      }
      
      aiAdvisorHistory.push({ role: 'user', content: question });
      input.value = '';
      aiAdvisorLoading = true;
      renderAIAdvisor(document.getElementById('main-content'));
      
      try {
        const financialContext = getDetailedFinancialContext();
        
        const systemPrompt = 'You are an expert financial advisor for "Horizon Star LLC" auto transport company. You have access to their real financial data and should provide specific, actionable advice based on their actual numbers.\n\nWhen answering:\n1. Reference their specific numbers\n2. Provide concrete recommendations with calculations\n3. Be direct and practical\n4. Calculate ROI and payback for major purchases\n5. Consider cash flow implications\n6. Flag any risks\n7. Use simple language\n\nDATA:\n' + financialContext;

        const messages = aiAdvisorHistory.map(msg => ({
          role: msg.role === 'user' ? 'user' : 'assistant',
          content: msg.content
        }));

        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 1024,
            system: systemPrompt,
            messages: messages
          })
        });

        if (!response.ok) {
          throw new Error('API error: ' + response.status);
        }

        const data = await response.json();
        aiAdvisorHistory.push({ role: 'assistant', content: data.content[0].text });
        
      } catch (error) {
        console.error('AI Advisor error:', error);
        aiAdvisorHistory.push({ 
          role: 'assistant', 
          content: 'Sorry, I encountered an error: ' + error.message + '\n\nPlease check your API key in Settings and try again.' 
        });
      }
      
      aiAdvisorLoading = false;
      renderAIAdvisor(document.getElementById('main-content'));
    }

    function clearAIAdvisorHistory() {
      aiAdvisorHistory = [];
      renderAIAdvisor(document.getElementById('main-content'));
    }

    // ============================================
    // DRIVER APPLICATIONS ADMIN PAGE
    // ============================================
    let applicationsData = [];
    let applicationsFilter = 'all';
    let selectedApplication = null;

    async function renderApplications(m) {
      m.innerHTML = `
        <div style="padding:24px;max-width:1400px;margin:0 auto">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;flex-wrap:wrap;gap:16px">
            <h1 style="margin:0;font-size:24px;font-weight:600"> Driver Applications</h1>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn ${applicationsFilter === 'all' ? 'btn-primary' : 'btn-secondary'}" onclick="filterApplications('all')">All</button>
              <button class="btn ${applicationsFilter === 'pending' ? 'btn-primary' : 'btn-secondary'}" onclick="filterApplications('pending')"> Pending</button>
              <button class="btn ${applicationsFilter === 'under_review' ? 'btn-primary' : 'btn-secondary'}" onclick="filterApplications('under_review')"> Under Review</button>
              <button class="btn ${applicationsFilter === 'approved' ? 'btn-primary' : 'btn-secondary'}" onclick="filterApplications('approved')"> Approved</button>
              <button class="btn ${applicationsFilter === 'rejected' ? 'btn-primary' : 'btn-secondary'}" onclick="filterApplications('rejected')"> Rejected</button>
            </div>
          </div>

          <div id="applicationsContent">
            <div style="text-align:center;padding:40px">
              <div class="spinner"></div>
              <p style="color:var(--text-muted);margin-top:16px">Loading applications...</p>
            </div>
          </div>
        </div>
      `;

      await loadApplications();
    }

    async function loadApplications() {
      try {
        let query = sb.from('driver_applications').select('*').order('submitted_at', { ascending: false });

        if (applicationsFilter !== 'all') {
          query = query.eq('status', applicationsFilter);
        }

        const { data, error } = await query;

        if (error) throw error;

        applicationsData = data || [];
        renderApplicationsList();
      } catch (err) {
        console.error('Error loading applications:', err);
        document.getElementById('applicationsContent').innerHTML = `
          <div class="card" style="text-align:center;padding:40px">
            <p style="color:var(--danger)">Error loading applications: ${err.message}</p>
            <button class="btn btn-primary" onclick="loadApplications()" style="margin-top:16px">Retry</button>
          </div>
        `;
      }
    }

    function filterApplications(filter) {
      applicationsFilter = filter;
      renderApplications(document.getElementById('main-content'));
    }

    function renderApplicationsList() {
      const content = document.getElementById('applicationsContent');

      if (applicationsData.length === 0) {
        content.innerHTML = `
          <div class="card" style="text-align:center;padding:60px">
            <div style="font-size:48px;margin-bottom:16px"></div>
            <h3 style="margin:0 0 8px">No Applications Found</h3>
            <p style="color:var(--text-muted);margin:0">
              ${applicationsFilter === 'all' ? 'No driver applications have been submitted yet.' : `No ${applicationsFilter.replace('_', ' ')} applications.`}
            </p>
          </div>
        `;
        return;
      }

      const statusColors = {
        pending: { bg: 'var(--amber-dim)', text: 'var(--amber)', icon: '' },
        under_review: { bg: 'var(--blue-dim)', text: 'var(--blue)', icon: '' },
        approved: { bg: 'var(--green-dim)', text: 'var(--green)', icon: '' },
        rejected: { bg: 'var(--red-dim)', text: 'var(--red)', icon: '' }
      };

      content.innerHTML = `
        <div class="card" style="overflow:hidden">
          <div style="overflow-x:auto">
            <table style="width:100%;border-collapse:collapse;min-width:800px">
              <thead>
                <tr style="background:var(--bg-secondary);border-bottom:1px solid var(--border)">
                  <th style="padding:14px 16px;text-align:left;font-weight:600">Applicant</th>
                  <th style="padding:14px 16px;text-align:left;font-weight:600">Contact</th>
                  <th style="padding:14px 16px;text-align:left;font-weight:600">License</th>
                  <th style="padding:14px 16px;text-align:left;font-weight:600">Submitted</th>
                  <th style="padding:14px 16px;text-align:center;font-weight:600">Status</th>
                  <th style="padding:14px 16px;text-align:center;font-weight:600">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${applicationsData.map(app => {
                  const status = statusColors[app.status] || statusColors.pending;
                  const submittedDate = app.submitted_at ? new Date(app.submitted_at).toLocaleDateString() : 'N/A';
                  const endorsements = (app.endorsements || []).join(', ') || 'None';

                  return `
                    <tr style="border-bottom:1px solid var(--border);transition:background 0.2s" onmouseover="this.style.background='var(--bg-hover)'" onmouseout="this.style.background=''">
                      <td style="padding:14px 16px">
                        <div style="font-weight:600">${app.first_name || ''} ${app.last_name || ''}</div>
                        <div style="font-size:12px;color:var(--text-muted)">${app.city || ''}, ${app.state || ''}</div>
                      </td>
                      <td style="padding:14px 16px">
                        <div style="font-size:13px">${app.email || 'N/A'}</div>
                        <div style="font-size:12px;color:var(--text-muted)">${app.phone || 'N/A'}</div>
                      </td>
                      <td style="padding:14px 16px">
                        <div style="font-size:13px">Class ${app.license_class || 'N/A'} - ${app.license_state || 'N/A'}</div>
                        <div style="font-size:12px;color:var(--text-muted)">Endorsements: ${endorsements}</div>
                      </td>
                      <td style="padding:14px 16px;font-size:13px">${submittedDate}</td>
                      <td style="padding:14px 16px;text-align:center">
                        <span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:500;background:${status.bg};color:${status.text}">
                          ${status.icon} ${app.status ? app.status.replace('_', ' ').toUpperCase() : 'PENDING'}
                        </span>
                      </td>
                      <td style="padding:14px 16px;text-align:center">
                        <div style="display:flex;gap:8px;justify-content:center">
                          <button class="btn btn-secondary" onclick="viewApplication(${app.id})" style="padding:6px 12px;font-size:12px"> View</button>
                          ${app.status === 'pending' ? `<button class="btn btn-primary" onclick="reviewApplication(${app.id})" style="padding:6px 12px;font-size:12px">Review</button>` : ''}
                        </div>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>

        <div style="margin-top:16px;color:var(--text-muted);font-size:13px">
          Showing ${applicationsData.length} application${applicationsData.length !== 1 ? 's' : ''}
        </div>
      `;
    }

    async function viewApplication(id) {
      const app = applicationsData.find(a => a.id === id);
      if (!app) return;

      selectedApplication = app;

      const statusColors = {
        pending: { bg: 'var(--amber-dim)', text: 'var(--amber)', label: ' Pending' },
        under_review: { bg: 'var(--blue-dim)', text: 'var(--blue)', label: ' Under Review' },
        approved: { bg: 'var(--green-dim)', text: 'var(--green)', label: ' Approved' },
        rejected: { bg: 'var(--red-dim)', text: 'var(--red)', label: ' Rejected' }
      };

      const status = statusColors[app.status] || statusColors.pending;
      const endorsements = (app.endorsements || []).join(', ') || 'None';
      const employmentHistory = app.employment_history || [];
      const accidents = app.accidents_details || [];
      const violations = app.violations_details || [];

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px';
      modal.onclick = e => { if (e.target === modal) modal.remove(); };

      modal.innerHTML = `
        <div class="card" style="max-width:900px;width:100%;max-height:90vh;overflow-y:auto;position:relative">
          <button onclick="this.closest('.modal-overlay').remove()" style="position:absolute;top:16px;right:16px;background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-muted)">&times;</button>

          <div style="padding:24px;border-bottom:1px solid var(--border)">
            <div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:16px">
              <div>
                <h2 style="margin:0 0 8px;font-size:24px">${app.first_name || ''} ${app.last_name || ''}</h2>
                <p style="margin:0;color:var(--text-muted)">Application ID: #${app.id}</p>
              </div>
              <span style="padding:6px 14px;border-radius:20px;font-size:13px;font-weight:500;background:${status.bg};color:${status.text}">
                ${status.label}
              </span>
            </div>
          </div>

          <div style="padding:24px">
            <!-- Personal Information -->
            <div style="margin-bottom:24px">
              <h3 style="margin:0 0 16px;font-size:16px;color:var(--primary);display:flex;align-items:center;gap:8px">
                <span></span> Personal Information
              </h3>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
                <div><span style="color:var(--text-muted);font-size:12px">Full Name</span><div style="font-weight:500">${app.first_name || ''} ${app.last_name || ''}</div></div>
                <div><span style="color:var(--text-muted);font-size:12px">Date of Birth</span><div style="font-weight:500">${app.date_of_birth || 'N/A'}</div></div>
                <div><span style="color:var(--text-muted);font-size:12px">Phone</span><div style="font-weight:500">${app.phone || 'N/A'}</div></div>
                <div><span style="color:var(--text-muted);font-size:12px">Email</span><div style="font-weight:500">${app.email || 'N/A'}</div></div>
                <div style="grid-column:span 2"><span style="color:var(--text-muted);font-size:12px">Address</span><div style="font-weight:500">${app.address || ''}, ${app.city || ''}, ${app.state || ''} ${app.zip || ''}</div></div>
              </div>
            </div>

            <!-- License Information -->
            <div style="margin-bottom:24px">
              <h3 style="margin:0 0 16px;font-size:16px;color:var(--primary);display:flex;align-items:center;gap:8px">
                <span></span> License Information
              </h3>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
                <div><span style="color:var(--text-muted);font-size:12px">License Number</span><div style="font-weight:500">${app.license_number || 'N/A'}</div></div>
                <div><span style="color:var(--text-muted);font-size:12px">State</span><div style="font-weight:500">${app.license_state || 'N/A'}</div></div>
                <div><span style="color:var(--text-muted);font-size:12px">Class</span><div style="font-weight:500">${app.license_class || 'N/A'}</div></div>
                <div><span style="color:var(--text-muted);font-size:12px">Expires</span><div style="font-weight:500">${app.license_expires || 'N/A'}</div></div>
                <div><span style="color:var(--text-muted);font-size:12px">Endorsements</span><div style="font-weight:500">${endorsements}</div></div>
              </div>
              ${app.license_front_url ? `<div style="margin-top:16px"><a href="${app.license_front_url}" target="_blank" class="btn btn-secondary" style="font-size:12px"> View License Front</a></div>` : ''}
              ${app.license_back_url ? `<a href="${app.license_back_url}" target="_blank" class="btn btn-secondary" style="font-size:12px;margin-left:8px"> View License Back</a>` : ''}
            </div>

            <!-- Medical Card -->
            <div style="margin-bottom:24px">
              <h3 style="margin:0 0 16px;font-size:16px;color:var(--primary);display:flex;align-items:center;gap:8px">
                <span></span> Medical Card
              </h3>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
                <div><span style="color:var(--text-muted);font-size:12px">Expires</span><div style="font-weight:500">${app.medical_expires || 'N/A'}</div></div>
              </div>
              ${app.medical_card_url ? `<div style="margin-top:16px"><a href="${app.medical_card_url}" target="_blank" class="btn btn-secondary" style="font-size:12px"> View Medical Card</a></div>` : ''}
            </div>

            <!-- Drug & Alcohol -->
            <div style="margin-bottom:24px">
              <h3 style="margin:0 0 16px;font-size:16px;color:var(--primary);display:flex;align-items:center;gap:8px">
                <span></span> Drug & Alcohol History
              </h3>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px">
                <div style="padding:var(--spacing-3);border-radius:var(--radius);background:${app.tested_positive ? 'var(--red-dim)' : 'var(--green-dim)'}">
                  ${app.tested_positive ? '' : ''} Tested positive for controlled substance: <strong>${app.tested_positive ? 'Yes' : 'No'}</strong>
                </div>
                <div style="padding:var(--spacing-3);border-radius:var(--radius);background:${app.alcohol_concentration ? 'var(--red-dim)' : 'var(--green-dim)'}">
                  ${app.alcohol_concentration ? '' : ''} Alcohol concentration .04+: <strong>${app.alcohol_concentration ? 'Yes' : 'No'}</strong>
                </div>
                <div style="padding:var(--spacing-3);border-radius:var(--radius);background:${app.refused_test ? 'var(--red-dim)' : 'var(--green-dim)'}">
                  ${app.refused_test ? '' : ''} Refused required test: <strong>${app.refused_test ? 'Yes' : 'No'}</strong>
                </div>
                <div style="padding:var(--spacing-3);border-radius:var(--radius);background:${app.clearinghouse_registered ? 'var(--green-dim)' : 'var(--amber-dim)'}">
                  ${app.clearinghouse_registered ? '' : ''} FMCSA Clearinghouse registered: <strong>${app.clearinghouse_registered ? 'Yes' : 'No'}</strong>
                </div>
              </div>
            </div>

            <!-- Driving Record -->
            <div style="margin-bottom:24px">
              <h3 style="margin:0 0 16px;font-size:16px;color:var(--primary);display:flex;align-items:center;gap:8px">
                <span></span> Driving Record (Past 3 Years)
              </h3>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px">
                <div style="padding:var(--spacing-3);border-radius:var(--radius);background:${app.accidents_3_years ? 'var(--amber-dim)' : 'var(--green-dim)'}">
                  ${app.accidents_3_years ? '' : ''} Accidents/Crashes: <strong>${app.accidents_3_years ? 'Yes' : 'No'}</strong>
                </div>
                <div style="padding:var(--spacing-3);border-radius:var(--radius);background:${app.violations_3_years ? 'var(--amber-dim)' : 'var(--green-dim)'}">
                  ${app.violations_3_years ? '' : ''} Traffic Violations: <strong>${app.violations_3_years ? 'Yes' : 'No'}</strong>
                </div>
                <div style="padding:var(--spacing-3);border-radius:var(--radius);background:${app.denied_license ? 'var(--red-dim)' : 'var(--green-dim)'}">
                  ${app.denied_license ? '' : ''} License Ever Denied: <strong>${app.denied_license ? 'Yes' : 'No'}</strong>
                </div>
                <div style="padding:var(--spacing-3);border-radius:var(--radius);background:${app.license_revoked ? 'var(--red-dim)' : 'var(--green-dim)'}">
                  ${app.license_revoked ? '' : ''} License Ever Revoked: <strong>${app.license_revoked ? 'Yes' : 'No'}</strong>
                </div>
              </div>
            </div>

            <!-- Employment History -->
            <div style="margin-bottom:24px">
              <h3 style="margin:0 0 16px;font-size:16px;color:var(--primary);display:flex;align-items:center;gap:8px">
                <span></span> Employment History (Past 10 Years)
              </h3>
              ${employmentHistory.length === 0 ? '<p style="color:var(--text-muted)">No employment history provided</p>' : `
                <div style="display:flex;flex-direction:column;gap:12px">
                  ${employmentHistory.map((emp, i) => `
                    <div style="padding:var(--spacing-4);border-radius:var(--radius);background:var(--bg-secondary);border:1px solid var(--border)">
                      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
                        <div>
                          <div style="font-weight:600">${emp.employer_name || 'Unknown Employer'}</div>
                          <div style="font-size:13px;color:var(--text-muted)">${emp.position || 'Position not specified'}</div>
                        </div>
                        <div style="text-align:right;font-size:13px;color:var(--text-muted)">
                          ${emp.date_from || '?'} - ${emp.date_to || 'Present'}
                        </div>
                      </div>
                      <div style="font-size:13px;color:var(--text-muted)">${emp.city || ''}, ${emp.state || ''}</div>
                      ${emp.reason_leaving ? `<div style="font-size:13px;margin-top:8px"><strong>Reason for leaving:</strong> ${emp.reason_leaving}</div>` : ''}
                      <div style="display:flex;gap:16px;margin-top:8px;font-size:12px">
                        <span style="padding:2px 8px;border-radius:4px;background:${emp.subject_to_fmcsr ? 'var(--blue-dim)' : 'var(--bg-card-hover)'}">FMCSR: ${emp.subject_to_fmcsr ? 'Yes' : 'No'}</span>
                        <span style="padding:2px 8px;border-radius:4px;background:${emp.safety_sensitive ? 'var(--blue-dim)' : 'var(--bg-card-hover)'}">DOT Regulated: ${emp.safety_sensitive ? 'Yes' : 'No'}</span>
                      </div>
                    </div>
                  `).join('')}
                </div>
              `}
              ${app.employment_gaps ? `<div style="margin-top:12px;padding:var(--spacing-3);border-radius:var(--radius);background:var(--amber-dim)"><strong>Employment Gaps Explained:</strong> ${app.employment_gaps}</div>` : ''}
            </div>

            <!-- Signatures -->
            <div style="margin-bottom:24px">
              <h3 style="margin:0 0 16px;font-size:16px;color:var(--primary);display:flex;align-items:center;gap:8px">
                <span></span> Signatures
              </h3>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px">
                ${[1,2,3,4,5,6,7,8].map(p => {
                  const sig = app['page' + p + '_signature'];
                  const date = app['page' + p + '_date'];
                  return `<div style="text-align:center;padding:var(--spacing-3);border-radius:var(--radius);background:${sig ? 'var(--green-dim)' : 'var(--red-dim)'}">
                    <div style="font-weight:500">Page ${p}</div>
                    <div style="font-size:12px;color:var(--text-muted)">${sig ? ' Signed' : ' Not signed'}</div>
                    ${date ? `<div style="font-size:var(--text-xs);color:var(--text-muted)">${date}</div>` : ''}
                  </div>`;
                }).join('')}
              </div>
            </div>

            <!-- Actions -->
            ${app.status === 'pending' || app.status === 'under_review' ? `
              <div style="display:flex;gap:12px;padding-top:24px;border-top:1px solid var(--border)">
                <button class="btn btn-primary" onclick="approveApplication(${app.id})" style="flex:1"> Approve Application</button>
                <button class="btn" onclick="rejectApplicationPrompt(${app.id})" style="flex:1;background:var(--red-dim);color:var(--red);border:none"> Reject Application</button>
                ${app.status === 'pending' ? `<button class="btn btn-secondary" onclick="markUnderReview(${app.id})" style="flex:1"> Mark Under Review</button>` : ''}
              </div>
            ` : ''}

            ${app.status === 'rejected' && app.rejection_reason ? `
              <div style="margin-top:24px;padding:var(--spacing-4);border-radius:var(--radius);background:var(--red-dim);border:1px solid var(--red-dim)">
                <strong style="color:var(--red)">Rejection Reason:</strong>
                <p style="margin:8px 0 0;color:var(--red)">${app.rejection_reason}</p>
              </div>
            ` : ''}

            ${app.status === 'approved' ? `
              <div style="margin-top:24px;padding:var(--spacing-4);border-radius:var(--radius);background:var(--green-dim);border:1px solid var(--green);text-align:center">
                <strong style="color:var(--green)"> This application has been approved</strong>
                ${app.reviewed_at ? `<p style="margin:8px 0 0;color:var(--green);font-size:13px">Reviewed on ${new Date(app.reviewed_at).toLocaleDateString()}</p>` : ''}
              </div>
            ` : ''}
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function reviewApplication(id) {
      viewApplication(id);
    }

    async function markUnderReview(id) {
      try {
        const { error } = await sb
          .from('driver_applications')
          .update({ status: 'under_review' })
          .eq('id', id);

        if (error) throw error;

        showToast('Application marked as under review', 'success');
        document.querySelector('.modal-overlay')?.remove();
        loadApplications();
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    async function approveApplication(id) {
      if (!confirm('Are you sure you want to approve this application?')) return;

      try {
        const { error } = await sb
          .from('driver_applications')
          .update({
            status: 'approved',
            reviewed_at: new Date().toISOString(),
            reviewed_by: currentUser?.id
          })
          .eq('id', id);

        if (error) throw error;

        showToast('Application approved successfully!', 'success');
        document.querySelector('.modal-overlay')?.remove();
        loadApplications();
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    function rejectApplicationPrompt(id) {
      const reason = prompt('Please provide a reason for rejection:');
      if (reason === null) return; // Cancelled

      rejectApplication(id, reason);
    }

    async function rejectApplication(id, reason) {
      try {
        const { error } = await sb
          .from('driver_applications')
          .update({
            status: 'rejected',
            rejection_reason: reason || 'No reason provided',
            reviewed_at: new Date().toISOString(),
            reviewed_by: currentUser?.id
          })
          .eq('id', id);

        if (error) throw error;

        showToast('Application rejected', 'info');
        document.querySelector('.modal-overlay')?.remove();
        loadApplications();
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    // ============================================================
    // DEALER PORTAL
    // ============================================================

    /**
     * Render dealer-specific navigation
     */
    function renderDealerNav() {
      const dealerNavItems = [
        { id: 'dealer_dashboard', label: 'Dashboard', icon: '' },
        { id: 'dealer_submit', label: 'Submit Vehicle', icon: '' },
        { id: 'dealer_orders', label: 'My Orders', icon: '' },
        { id: 'dealer_spending', label: 'Spending', icon: '' }
      ];

      let html = '<div class="nav-section">';
      html += '<div class="nav-section-title">DEALER PORTAL</div>';

      dealerNavItems.forEach(item => {
        html += '<button class="nav-item ' + (currentPage === item.id ? 'active' : '') + '" onclick="navigate(\'' + item.id + '\')" role="menuitem">' +
          '<span class="icon">' + item.icon + '</span> <span class="nav-item-text">' + item.label + '</span></button>';
      });

      html += '</div>';
      document.getElementById('nav').innerHTML = html;
    }

    /**
     * Render dealer dashboard
     */
    async function renderDealerDashboard(m) {
      // Load dealer profile if not loaded
      if (!currentDealerProfile) {
        await loadDealerProfile();
      }

      if (!currentDealerProfile) {
        m.innerHTML = '<div class="card" style="text-align:center;padding:60px">' +
          '<div style="font-size:64px;margin-bottom:20px"></div>' +
          '<h2>Dealer Profile Not Found</h2>' +
          '<p style="color:var(--text-secondary)">Your dealer account is not fully set up. Please contact support.</p>' +
          '</div>';
        return;
      }

      // Get dealer stats
      const stats = await getDealerSpending(currentDealerProfile.id);
      const recentOrders = stats.orders.slice(0, 10);

      m.innerHTML = '<div class="page-header">' +
        '<h1>Welcome, ' + (currentDealerProfile.company_name || 'Dealer') + '</h1>' +
        '<p style="color:var(--text-secondary);margin-top:4px">Dealer Code: <strong>' + currentDealerProfile.dealer_code + '</strong></p>' +
        '</div>' +

        // Stats cards
        '<div class="stats-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:24px">' +
        '<div class="stat-card" style="background:var(--bg-card);padding:20px;border-radius:12px;text-align:center">' +
        '<div style="font-size:32px;font-weight:700;color:var(--accent-primary)">' + stats.totalVehicles + '</div>' +
        '<div style="color:var(--text-secondary);font-size:13px">Total Orders</div></div>' +
        '<div class="stat-card" style="background:var(--bg-card);padding:20px;border-radius:12px;text-align:center">' +
        '<div style="font-size:32px;font-weight:700;color:var(--amber)">' + stats.pending + '</div>' +
        '<div style="color:var(--text-secondary);font-size:13px">Pending</div></div>' +
        '<div class="stat-card" style="background:var(--bg-card);padding:20px;border-radius:12px;text-align:center">' +
        '<div style="font-size:32px;font-weight:700;color:var(--blue)">' + (stats.pickedUp + stats.inTransit) + '</div>' +
        '<div style="color:var(--text-secondary);font-size:13px">In Transit</div></div>' +
        '<div class="stat-card" style="background:var(--bg-card);padding:20px;border-radius:12px;text-align:center">' +
        '<div style="font-size:32px;font-weight:700;color:var(--green)">' + stats.delivered + '</div>' +
        '<div style="color:var(--text-secondary);font-size:13px">Delivered</div></div>' +
        '<div class="stat-card" style="background:var(--bg-card);padding:20px;border-radius:12px;text-align:center">' +
        '<div style="font-size:32px;font-weight:700;color:var(--purple)">$' + formatNumber(stats.totalSpent) + '</div>' +
        '<div style="color:var(--text-secondary);font-size:13px">Total Spent</div></div>' +
        '</div>' +

        // Quick action + Recent orders
        '<div class="card">' +
        '<div class="card-header" style="display:flex;justify-content:space-between;align-items:center">' +
        '<h3>Recent Orders</h3>' +
        '<button class="btn btn-primary" onclick="navigate(\'dealer_submit\')">+ Submit New Vehicle</button>' +
        '</div>' +
        '<div class="table-wrapper"><table><thead><tr><th>Order #</th><th>Vehicle</th><th>Route</th><th>Status</th><th>Date</th></tr></thead><tbody>' +
        (recentOrders.length === 0 ? '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-muted)">No orders yet. Submit your first vehicle!</td></tr>' :
        recentOrders.map(o => {
          const statusColors = { pending: 'var(--amber)', picked_up: 'var(--blue)', in_transit: 'var(--blue)', delivered: 'var(--green)' };
          const statusLabels = { pending: 'Pending', picked_up: 'Picked Up', in_transit: 'In Transit', delivered: 'Delivered' };
          return '<tr>' +
            '<td><strong>' + (o.order_number || '-') + '</strong></td>' +
            '<td>' + [o.vehicle_year, o.vehicle_make, o.vehicle_model].filter(Boolean).join(' ') + '</td>' +
            '<td>' + (o.origin || '-') + '  ' + (o.destination || '-') + '</td>' +
            '<td><span class="badge" style="background:' + (statusColors[o.delivery_status] || 'var(--text-secondary)') + '">' + (statusLabels[o.delivery_status] || o.delivery_status || 'Unknown') + '</span></td>' +
            '<td>' + formatDate(o.created_at) + '</td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }

    /**
     * Render dealer submit vehicle form
     */
    function renderDealerSubmitVehicle(m) {
      m.innerHTML = '<div class="page-header">' +
        '<h1>Submit Vehicle for Transport</h1>' +
        '<p style="color:var(--text-secondary);margin-top:4px">Fill out the form below to request vehicle transport</p>' +
        '</div>' +

        '<div class="card" style="max-width:800px">' +
        '<form onsubmit="handleDealerSubmitVehicle(event)">' +

        // Vehicle Information
        '<div style="margin-bottom:24px">' +
        '<h4 style="margin-bottom:16px;color:var(--text-primary)"> Vehicle Information</h4>' +
        '<div class="form-row" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px">' +
        '<div class="form-group"><label>Year *</label><input type="number" id="dealer-vehicle-year" required min="1900" max="2030" placeholder="2024"></div>' +
        '<div class="form-group"><label>Make *</label><input type="text" id="dealer-vehicle-make" required placeholder="Toyota"></div>' +
        '<div class="form-group"><label>Model *</label><input type="text" id="dealer-vehicle-model" required placeholder="Camry"></div>' +
        '</div>' +
        '<div class="form-row" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px">' +
        '<div class="form-group"><label>VIN</label><input type="text" id="dealer-vehicle-vin" maxlength="17" placeholder="17-character VIN"></div>' +
        '<div class="form-group"><label>Color</label><input type="text" id="dealer-vehicle-color" placeholder="White"></div>' +
        '</div>' +
        '</div>' +

        // Pickup Information
        '<div style="margin-bottom:24px">' +
        '<h4 style="margin-bottom:16px;color:var(--text-primary)"> Pickup Information</h4>' +
        '<div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">' +
        '<div class="form-group"><label>Pickup Location *</label><input type="text" id="dealer-pickup-location" required placeholder="City, State (e.g., Los Angeles, CA)"></div>' +
        '<div class="form-group"><label>Pickup Date *</label><input type="date" id="dealer-pickup-date" required></div>' +
        '</div>' +
        '</div>' +

        // Delivery Information
        '<div style="margin-bottom:24px">' +
        '<h4 style="margin-bottom:16px;color:var(--text-primary)"> Delivery Information</h4>' +
        '<div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">' +
        '<div class="form-group"><label>Delivery Location *</label><input type="text" id="dealer-delivery-location" required placeholder="City, State (e.g., Miami, FL)"></div>' +
        '<div class="form-group"><label>Requested Delivery Date</label><input type="date" id="dealer-delivery-date"></div>' +
        '</div>' +
        '</div>' +

        // Notes
        '<div style="margin-bottom:24px">' +
        '<div class="form-group"><label>Additional Notes</label><textarea id="dealer-notes" rows="3" placeholder="Any special instructions or notes..."></textarea></div>' +
        '</div>' +

        // Submit buttons
        '<div style="display:flex;gap:12px;justify-content:flex-end">' +
        '<button type="button" class="btn btn-secondary" onclick="navigate(\'dealer_dashboard\')">Cancel</button>' +
        '<button type="submit" class="btn btn-primary" id="dealer-submit-btn">Submit Vehicle</button>' +
        '</div>' +
        '</form></div>';

      // Set default pickup date to today
      document.getElementById('dealer-pickup-date').value = new Date().toISOString().split('T')[0];
    }

    /**
     * Handle dealer vehicle submission
     */
    async function handleDealerSubmitVehicle(e) {
      e.preventDefault();
      const btn = document.getElementById('dealer-submit-btn');
      btn.disabled = true;
      btn.textContent = 'Submitting...';

      try {
        const orderData = {
          vehicle_year: document.getElementById('dealer-vehicle-year').value,
          vehicle_make: document.getElementById('dealer-vehicle-make').value,
          vehicle_model: document.getElementById('dealer-vehicle-model').value,
          vehicle_vin: document.getElementById('dealer-vehicle-vin').value,
          vehicle_color: document.getElementById('dealer-vehicle-color').value,
          pickup_location: document.getElementById('dealer-pickup-location').value,
          pickup_date: document.getElementById('dealer-pickup-date').value,
          delivery_location: document.getElementById('dealer-delivery-location').value,
          delivery_date: document.getElementById('dealer-delivery-date').value,
          notes: document.getElementById('dealer-notes').value
        };

        await submitDealerOrder(orderData);
        showToast('Vehicle submitted successfully!', 'success');
        navigate('dealer_orders');
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
        btn.disabled = false;
        btn.textContent = 'Submit Vehicle';
      }
    }

    /**
     * Render dealer orders list
     */
    async function renderDealerOrders(m) {
      if (!currentDealerProfile) {
        await loadDealerProfile();
      }

      if (!currentDealerProfile) {
        m.innerHTML = '<div class="card" style="text-align:center;padding:60px"><h2>Dealer profile not found</h2></div>';
        return;
      }

      // Get filter from URL or default
      const statusFilter = window.dealerOrdersFilter || 'all';
      const orders = await loadDealerOrders(currentDealerProfile.id, { status: statusFilter === 'all' ? null : statusFilter });

      const statusColors = { pending: 'var(--amber)', picked_up: 'var(--blue)', in_transit: 'var(--blue)', delivered: 'var(--green)' };
      const statusLabels = { pending: 'Pending', picked_up: 'Picked Up', in_transit: 'In Transit', delivered: 'Delivered' };

      m.innerHTML = '<div class="page-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px">' +
        '<h1>My Orders</h1>' +
        '<button class="btn btn-primary" onclick="navigate(\'dealer_submit\')">+ Submit New Vehicle</button>' +
        '</div>' +

        // Status filter tabs
        '<div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap">' +
        ['all', 'pending', 'picked_up', 'in_transit', 'delivered'].map(s => {
          const label = s === 'all' ? 'All' : statusLabels[s];
          const isActive = statusFilter === s;
          return '<button class="btn btn-sm ' + (isActive ? 'btn-primary' : 'btn-secondary') + '" onclick="filterDealerOrders(\'' + s + '\')">' + label + '</button>';
        }).join('') +
        '</div>' +

        '<div class="card">' +
        '<div class="table-wrapper"><table><thead><tr><th>Order #</th><th>Vehicle</th><th>VIN</th><th>Pickup</th><th>Delivery</th><th>Status</th><th>Submitted</th></tr></thead><tbody>' +
        (orders.length === 0 ? '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted)">No orders found</td></tr>' :
        orders.map(o => {
          return '<tr onclick="viewDealerOrderDetail(' + o.id + ')" style="cursor:pointer">' +
            '<td><strong>' + (o.order_number || '-') + '</strong></td>' +
            '<td>' + [o.vehicle_year, o.vehicle_make, o.vehicle_model].filter(Boolean).join(' ') + '</td>' +
            '<td style="font-family:monospace;font-size:12px">' + (o.vehicle_vin || '-') + '</td>' +
            '<td>' + (o.origin || '-') + '<br><small style="color:var(--text-muted)">' + formatDate(o.pickup_date) + '</small></td>' +
            '<td>' + (o.destination || '-') + '<br><small style="color:var(--text-muted)">' + formatDate(o.dropoff_date) + '</small></td>' +
            '<td><span class="badge" style="background:' + (statusColors[o.delivery_status] || 'var(--text-secondary)') + '">' + (statusLabels[o.delivery_status] || o.delivery_status || 'Unknown') + '</span></td>' +
            '<td>' + formatDate(o.created_at) + '</td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }

    function filterDealerOrders(status) {
      window.dealerOrdersFilter = status;
      renderDealerOrders(document.getElementById('main-content'));
    }

    function viewDealerOrderDetail(orderId) {
      // Simple modal to view order details
      const order = appData.orders.find(o => o.id === orderId);
      if (!order) return;

      const statusColors = { pending: 'var(--amber)', picked_up: 'var(--blue)', in_transit: 'var(--blue)', delivered: 'var(--green)' };
      const statusLabels = { pending: 'Pending', picked_up: 'Picked Up', in_transit: 'In Transit', delivered: 'Delivered' };

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.onclick = e => { if (e.target === modal) modal.remove(); };
      modal.innerHTML = `
        <div class="modal" style="max-width:500px">
          <div class="modal-header">
            <h3>Order Details</h3>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
          </div>
          <div class="modal-body">
            <div style="text-align:center;margin-bottom:20px">
              <div style="font-size:var(--text-2xl);font-weight:var(--weight-bold);color:var(--accent-primary)">${order.order_number || 'N/A'}</div>
              <span class="badge" style="background:${statusColors[order.delivery_status] || 'var(--text-secondary)'};margin-top:8px">${statusLabels[order.delivery_status] || 'Unknown'}</span>
            </div>
            <div style="background:var(--bg-darker);padding:var(--spacing-4);border-radius:var(--radius);margin-bottom:16px">
              <div style="font-weight:600;margin-bottom:8px"> Vehicle</div>
              <div>${[order.vehicle_year, order.vehicle_make, order.vehicle_model].filter(Boolean).join(' ') || '-'}</div>
              <div style="color:var(--text-muted);font-size:13px">VIN: ${order.vehicle_vin || 'N/A'}</div>
              <div style="color:var(--text-muted);font-size:13px">Color: ${order.vehicle_color || 'N/A'}</div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
              <div style="background:var(--bg-darker);padding:var(--spacing-4);border-radius:var(--radius)">
                <div style="font-weight:600;margin-bottom:8px"> Pickup</div>
                <div>${order.origin || '-'}</div>
                <div style="color:var(--text-muted);font-size:13px">${formatDate(order.pickup_date)}</div>
              </div>
              <div style="background:var(--bg-darker);padding:var(--spacing-4);border-radius:var(--radius)">
                <div style="font-weight:600;margin-bottom:8px"> Delivery</div>
                <div>${order.destination || '-'}</div>
                <div style="color:var(--text-muted);font-size:13px">${formatDate(order.dropoff_date)}</div>
              </div>
            </div>
            ${order.dispatcher_notes ? '<div style="margin-top:16px;background:var(--bg-darker);padding:var(--spacing-4);border-radius:var(--radius)"><div style="font-weight:600;margin-bottom:8px"> Notes</div><div style="color:var(--text-secondary)">' + order.dispatcher_notes + '</div></div>' : ''}
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Close</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    /**
     * Render dealer spending/financial page
     */
    async function renderDealerSpending(m) {
      if (!currentDealerProfile) {
        await loadDealerProfile();
      }

      if (!currentDealerProfile) {
        m.innerHTML = '<div class="card" style="text-align:center;padding:60px"><h2>Dealer profile not found</h2></div>';
        return;
      }

      const stats = await getDealerSpending(currentDealerProfile.id);

      m.innerHTML = '<div class="page-header">' +
        '<h1>Spending History</h1>' +
        '<p style="color:var(--text-secondary);margin-top:4px">Track your vehicle transport spending</p>' +
        '</div>' +

        // Stats cards
        '<div class="stats-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">' +
        '<div class="card" style="padding:24px;text-align:center">' +
        '<div style="font-size:36px;font-weight:700;color:var(--purple)">$' + formatNumber(stats.totalSpent) + '</div>' +
        '<div style="color:var(--text-secondary);margin-top:4px">Total Spent</div></div>' +
        '<div class="card" style="padding:24px;text-align:center">' +
        '<div style="font-size:36px;font-weight:700;color:var(--accent-primary)">' + stats.totalVehicles + '</div>' +
        '<div style="color:var(--text-secondary);margin-top:4px">Total Vehicles</div></div>' +
        '<div class="card" style="padding:24px;text-align:center">' +
        '<div style="font-size:36px;font-weight:700;color:var(--green)">$' + formatNumber(stats.avgCostPerVehicle) + '</div>' +
        '<div style="color:var(--text-secondary);margin-top:4px">Avg Cost/Vehicle</div></div>' +
        '</div>' +

        // Transaction history
        '<div class="card">' +
        '<div class="card-header"><h3>Transaction History</h3></div>' +
        '<div class="table-wrapper"><table><thead><tr><th>Order #</th><th>Vehicle</th><th>Date</th><th>Amount</th><th>Status</th></tr></thead><tbody>' +
        (stats.orders.length === 0 ? '<tr><td colspan="5" style="text-align:center;padding:40px;color:var(--text-muted)">No transactions yet</td></tr>' :
        stats.orders.map(o => {
          const statusColors = { pending: 'var(--amber)', picked_up: 'var(--blue)', in_transit: 'var(--blue)', delivered: 'var(--green)' };
          return '<tr>' +
            '<td><strong>' + (o.order_number || '-') + '</strong></td>' +
            '<td>' + [o.vehicle_year, o.vehicle_make, o.vehicle_model].filter(Boolean).join(' ') + '</td>' +
            '<td>' + formatDate(o.created_at) + '</td>' +
            '<td style="font-weight:600">$' + formatNumber(o.revenue || 0) + '</td>' +
            '<td><span class="badge" style="background:' + (statusColors[o.delivery_status] || 'var(--text-secondary)') + '">' + (o.delivery_status || '-') + '</span></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }

    // ============================================================
    // ADMIN DEALER MANAGEMENT
    // ============================================================

    /**
     * Render dealers admin page
     */
    async function renderDealersAdmin(m) {
      // Ensure dealers are loaded
      let dealers = appData.dealers || [];
      if (dealers.length === 0) {
        try {
          dealers = await dbFetch('dealers', { order: 'company_name' }) || [];
          appData.dealers = dealers;
        } catch(e) { console.error('Failed to load dealers:', e); }
      }

      // Calculate stats for each dealer
      const dealerStats = dealers.map(d => {
        const orders = appData.orders.filter(o => o.dealer_id === d.id);
        const totalRevenue = orders.reduce((sum, o) => sum + (parseFloat(o.revenue) || 0), 0);
        const pending = orders.filter(o => o.delivery_status === 'pending').length;
        const delivered = orders.filter(o => o.delivery_status === 'delivered').length;
        return { ...d, orderCount: orders.length, totalRevenue, pending, delivered };
      });

      m.innerHTML = '<div class="page-header" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px">' +
        '<h1> Dealer Management</h1>' +
        '<button class="btn btn-primary" onclick="openDealerModal()">+ Add Dealer</button>' +
        '</div>' +

        '<div class="card">' +
        '<div class="table-wrapper"><table><thead><tr><th>Company</th><th>Code</th><th>Contact</th><th>Orders</th><th>Revenue</th><th>Status</th><th class="sticky-col">Actions</th></tr></thead><tbody>' +
        (dealerStats.length === 0 ? '<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text-muted)">No dealers yet. Click "Add Dealer" to create one.</td></tr>' :
        dealerStats.map(d => {
          return '<tr>' +
            '<td><strong>' + (d.company_name || '-') + '</strong></td>' +
            '<td><code style="background:var(--bg-darker);padding:2px 6px;border-radius:4px">' + (d.dealer_code || '-') + '</code></td>' +
            '<td>' + (d.contact_name || '-') + '<br><small style="color:var(--text-muted)">' + (d.contact_phone || '') + '</small></td>' +
            '<td style="text-align:center">' + d.orderCount + ' <small style="color:var(--text-muted)">(' + d.pending + ' pending)</small></td>' +
            '<td style="font-weight:600">$' + formatNumber(d.totalRevenue) + '</td>' +
            '<td><span class="badge ' + (d.is_active ? 'badge-green' : 'badge-gray') + '">' + (d.is_active ? 'Active' : 'Inactive') + '</span></td>' +
            '<td class="sticky-col"><div class="actions">' +
            '<button class="action-btn edit" onclick="openDealerModal(' + d.id + ')">Edit</button>' +
            '<button class="action-btn delete" onclick="deleteDealer(' + d.id + ')">Del</button>' +
            '</div></td></tr>';
        }).join('')) +
        '</tbody></table></div></div>';
    }

    /**
     * Open dealer modal for create/edit
     */
    async function openDealerModal(dealerId) {
      const isEdit = !!dealerId;
      let dealer = null;

      if (isEdit) {
        dealer = appData.dealers.find(d => d.id === dealerId);
        if (!dealer) {
          showToast('Dealer not found', 'error');
          return;
        }
      }

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.onclick = e => { if (e.target === modal) modal.remove(); };
      modal.innerHTML = `
        <div class="modal" style="max-width:600px">
          <div class="modal-header">
            <h3>${isEdit ? 'Edit Dealer' : 'Add New Dealer'}</h3>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()"></button>
          </div>
          <div class="modal-body">
            <form id="dealer-form" onsubmit="saveDealer(event, ${dealerId || 'null'})">
              <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div class="form-group">
                  <label>Company Name *</label>
                  <input type="text" id="dealer-company-name" required value="${dealer?.company_name || ''}" placeholder="ABC Auto Dealership">
                </div>
                <div class="form-group">
                  <label>Dealer Code *</label>
                  <input type="text" id="dealer-code" required value="${dealer?.dealer_code || generateDealerCode('')}" placeholder="ABC123" maxlength="10" ${isEdit ? 'readonly style="background:var(--bg-darker)"' : ''}>
                </div>
              </div>
              <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div class="form-group">
                  <label>Contact Name</label>
                  <input type="text" id="dealer-contact-name" value="${dealer?.contact_name || ''}" placeholder="John Smith">
                </div>
                <div class="form-group">
                  <label>Contact Phone</label>
                  <input type="tel" id="dealer-contact-phone" value="${dealer?.contact_phone || ''}" placeholder="(555) 123-4567">
                </div>
              </div>
              <div class="form-group">
                <label>Company Address</label>
                <input type="text" id="dealer-address" value="${dealer?.company_address || ''}" placeholder="123 Main St, City, State">
              </div>
              <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div class="form-group">
                  <label>Payment Terms</label>
                  <select id="dealer-payment-terms">
                    <option value="NET30" ${dealer?.payment_terms === 'NET30' ? 'selected' : ''}>NET 30</option>
                    <option value="NET15" ${dealer?.payment_terms === 'NET15' ? 'selected' : ''}>NET 15</option>
                    <option value="COD" ${dealer?.payment_terms === 'COD' ? 'selected' : ''}>COD</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Status</label>
                  <select id="dealer-status">
                    <option value="true" ${dealer?.is_active !== false ? 'selected' : ''}>Active</option>
                    <option value="false" ${dealer?.is_active === false ? 'selected' : ''}>Inactive</option>
                  </select>
                </div>
              </div>
              ${!isEdit ? `
              <hr style="margin:20px 0;border:none;border-top:1px solid var(--border)">
              <h4 style="margin-bottom:16px"> Login Credentials</h4>
              <div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div class="form-group">
                  <label>Login Email *</label>
                  <input type="email" id="dealer-email" required placeholder="dealer@company.com">
                </div>
                <div class="form-group">
                  <label>Password *</label>
                  <input type="password" id="dealer-password" required minlength="6" placeholder="Min 6 characters">
                </div>
              </div>
              ` : ''}
              <div class="form-group">
                <label>Notes</label>
                <textarea id="dealer-notes" rows="2" placeholder="Internal notes about this dealer...">${dealer?.notes || ''}</textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
            <button class="btn btn-primary" onclick="document.getElementById('dealer-form').requestSubmit()">${isEdit ? 'Save Changes' : 'Create Dealer'}</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      // Auto-generate dealer code from company name
      if (!isEdit) {
        document.getElementById('dealer-company-name').addEventListener('input', (e) => {
          document.getElementById('dealer-code').value = generateDealerCode(e.target.value);
        });
      }
    }

    /**
     * Save dealer (create or update)
     */
    async function saveDealer(e, dealerId) {
      e.preventDefault();

      const companyName = document.getElementById('dealer-company-name').value.trim();
      const dealerCode = document.getElementById('dealer-code').value.trim().toUpperCase();
      const contactName = document.getElementById('dealer-contact-name').value.trim();
      const contactPhone = document.getElementById('dealer-contact-phone').value.trim();
      const address = document.getElementById('dealer-address').value.trim();
      const paymentTerms = document.getElementById('dealer-payment-terms').value;
      const isActive = document.getElementById('dealer-status').value === 'true';
      const notes = document.getElementById('dealer-notes').value.trim();

      try {
        if (dealerId) {
          // Update existing dealer
          await dbUpdate('dealers', dealerId, {
            company_name: companyName,
            contact_name: contactName,
            contact_phone: contactPhone,
            company_address: address,
            payment_terms: paymentTerms,
            is_active: isActive,
            notes: notes,
            updated_at: new Date().toISOString()
          });
          showToast('Dealer updated', 'success');
        } else {
          // Create new dealer with user account
          const email = document.getElementById('dealer-email').value.trim().toLowerCase();
          const password = document.getElementById('dealer-password').value;

          // First create user with DEALER role
          const hashedPassword = await hashPassword(password);

          // Try to create Supabase Auth user first
          let authId = null;
          try {
            const { data: authData, error: authError } = await sb.auth.signUp({
              email: email,
              password: password,
              options: { data: { first_name: contactName || companyName, last_name: '' } }
            });
            if (!authError && authData.user) {
              authId = authData.user.id;
            }
          } catch (authErr) {
            console.warn('Supabase Auth signup failed, using legacy auth:', authErr);
          }

          // Create user record
          const newUser = await dbInsert('users', {
            auth_id: authId,
            email: email,
            first_name: contactName || companyName,
            last_name: '',
            password: hashedPassword,
            role: 'DEALER',
            is_active: isActive
          });

          // Create dealer profile
          await dbInsert('dealers', {
            user_id: newUser.id,
            company_name: companyName,
            dealer_code: dealerCode,
            contact_name: contactName,
            contact_phone: contactPhone,
            company_address: address,
            payment_terms: paymentTerms,
            is_active: isActive,
            notes: notes
          });

          await logActivity('DEALER_CREATED', { company_name: companyName, dealer_code: dealerCode, email: email });
          showToast('Dealer created successfully', 'success');
        }

        document.querySelector('.modal-overlay')?.remove();
        await loadAllData(true);
        renderDealersAdmin(document.getElementById('main-content'));

      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }

    /**
     * Delete a dealer
     */
    async function deleteDealer(dealerId) {
      const dealer = appData.dealers.find(d => d.id === dealerId);
      if (!dealer) return;

      const orders = appData.orders.filter(o => o.dealer_id === dealerId);
      if (orders.length > 0) {
        if (!confirm('This dealer has ' + orders.length + ' orders. Deleting will unlink these orders from the dealer. Continue?')) {
          return;
        }
      } else {
        if (!confirm('Delete dealer "' + dealer.company_name + '"?')) {
          return;
        }
      }

      try {
        // Delete dealer profile (user account remains but can be deactivated separately)
        await dbDelete('dealers', dealerId);
        await logActivity('DEALER_DELETED', { company_name: dealer.company_name, dealer_code: dealer.dealer_code });
        showToast('Dealer deleted', 'success');
        await loadAllData(true);
        renderDealersAdmin(document.getElementById('main-content'));
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }
  </script>
</body>
</html>
