<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Detail - Horizon Star TMS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #22c55e;
      --primary-hover: #16a34a;
      --primary-light: rgba(34, 197, 94, 0.12);
      --secondary: #64748b;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --purple: #8b5cf6;

      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f1f5f9;
      --bg-card: #ffffff;
      --bg-hover: #f1f5f9;

      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;

      --border: #e2e8f0;
      --border-light: #f1f5f9;

      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
      --shadow-card: 0 1px 3px rgba(0,0,0,0.04), 0 4px 20px rgba(0,0,0,0.03);

      --radius-sm: 6px;
      --radius: 10px;
      --radius-lg: 14px;
      --sidebar-width: 240px;
      --header-height: 64px;

      --font-display: 'Space Grotesk', -apple-system, sans-serif;
      --font-body: 'IBM Plex Sans', -apple-system, sans-serif;
      --font-mono: 'JetBrains Mono', 'SF Mono', monospace;

      --gradient-primary: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: var(--font-body);
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 15px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    h1, h2, h3 {
      font-family: var(--font-display);
      letter-spacing: -0.03em;
      font-weight: 700;
    }

    .mono {
      font-family: var(--font-mono);
    }

    .app {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: #0a1014;
      color: white;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      border-right: 1px solid rgba(255, 255, 255, 0.06);
      z-index: 100;
    }

    .logo {
      padding: 24px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .logo h1 {
      font-size: 1.375rem;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--gradient-primary);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      -webkit-text-fill-color: white;
    }

    .logo p {
      font-family: var(--font-mono);
      font-size: 10px;
      color: rgba(255,255,255,0.4);
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 0.15em;
    }

    .nav-section {
      padding: 8px 8px 4px;
    }

    .nav-section-title {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      color: rgba(255,255,255,0.35);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 16px 16px 8px;
      margin: 0 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.04);
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      margin: 2px 12px;
      color: rgba(255,255,255,0.6);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      background: none;
      width: calc(100% - 24px);
      text-align: left;
      border-radius: 10px;
      transition: all 0.2s;
      text-decoration: none;
    }

    .nav-item:hover {
      color: rgba(255,255,255,0.95);
      background: rgba(255,255,255,0.06);
    }

    .nav-item.active {
      color: var(--primary);
      background: rgba(34, 197, 94, 0.12);
      font-weight: 600;
    }

    .nav-item .icon {
      width: 20px;
      text-align: center;
    }

    /* Main Content */
    .main-wrapper {
      flex: 1;
      margin-left: var(--sidebar-width);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .top-header {
      height: var(--header-height);
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .breadcrumb a {
      color: var(--text-secondary);
      text-decoration: none;
    }

    .breadcrumb a:hover {
      color: var(--primary);
    }

    .breadcrumb .separator {
      color: var(--text-muted);
    }

    .breadcrumb .current {
      color: var(--text-primary);
      font-weight: 500;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .main-content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    /* Page Header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .page-title-section {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .page-title-section h1 {
      font-size: 28px;
    }

    .status-badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .status-badge.pending {
      background: rgba(245, 158, 11, 0.15);
      color: #d97706;
    }

    .status-badge.picked_up, .status-badge.in-transit {
      background: rgba(59, 130, 246, 0.15);
      color: #2563eb;
    }

    .status-badge.delivered {
      background: rgba(34, 197, 94, 0.15);
      color: #16a34a;
    }

    /* Buttons */
    .btn {
      padding: 10px 20px;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      font-family: var(--font-body);
    }

    .btn-primary {
      background: var(--gradient-primary);
      color: white;
    }

    .btn-primary:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-tertiary);
    }

    /* Content Grid */
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 24px;
    }

    @media (max-width: 1200px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-card);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-primary);
    }

    .card-title .icon {
      font-size: 18px;
    }

    /* Info Grid */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .info-item {
      background: var(--bg-tertiary);
      padding: 14px;
      border-radius: var(--radius);
    }

    .info-item.full-width {
      grid-column: span 2;
    }

    .info-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
      font-family: var(--font-mono);
    }

    .info-value {
      font-size: 15px;
      font-weight: 500;
      color: var(--text-primary);
    }

    /* Route Display */
    .route-display {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--bg-tertiary);
      border-radius: var(--radius);
    }

    .route-point {
      flex: 1;
    }

    .route-point .city {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .route-point .details {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .route-arrow {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 20px;
    }

    .route-arrow .arrow {
      font-size: 24px;
      color: var(--primary);
    }

    .route-arrow .distance {
      font-size: 11px;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    /* Inspection Cards */
    .inspection-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .inspection-card {
      background: var(--bg-tertiary);
      border-radius: var(--radius);
      padding: 16px;
      border: 2px solid transparent;
    }

    .inspection-card.completed {
      border-color: var(--success);
    }

    .inspection-card.pending {
      opacity: 0.6;
    }

    .inspection-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .inspection-type {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }

    .inspection-status {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
    }

    .inspection-status.completed {
      background: rgba(34, 197, 94, 0.15);
      color: #16a34a;
    }

    .inspection-status.in_progress {
      background: rgba(245, 158, 11, 0.15);
      color: #d97706;
    }

    .inspection-status.pending {
      background: var(--bg-secondary);
      color: var(--text-muted);
    }

    .inspection-photos {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }

    .inspection-photo {
      width: 48px;
      height: 48px;
      background: var(--bg-secondary);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: var(--text-muted);
      overflow: hidden;
      cursor: pointer;
      border: 1px solid var(--border);
    }

    .inspection-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .inspection-photo:hover {
      border-color: var(--primary);
    }

    .inspection-meta {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .inspection-meta span {
      display: block;
      margin-bottom: 4px;
    }

    .damages-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 8px;
    }

    .no-damages-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(34, 197, 94, 0.1);
      color: var(--success);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 8px;
    }

    .view-btn {
      margin-top: 12px;
      width: 100%;
      padding: 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 12px;
      cursor: pointer;
      font-family: var(--font-body);
    }

    .view-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .view-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Timeline */
    .timeline {
      position: relative;
      padding-left: 24px;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 7px;
      top: 8px;
      bottom: 8px;
      width: 2px;
      background: var(--border);
    }

    .timeline-item {
      position: relative;
      padding-bottom: 20px;
    }

    .timeline-item:last-child {
      padding-bottom: 0;
    }

    .timeline-dot {
      position: absolute;
      left: -20px;
      top: 4px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--border);
      border: 2px solid var(--bg-card);
    }

    .timeline-dot.completed {
      background: var(--success);
    }

    .timeline-dot.current {
      background: var(--info);
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
    }

    .timeline-content {
      background: var(--bg-tertiary);
      padding: 12px 14px;
      border-radius: var(--radius);
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 4px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .timeline-title {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-primary);
    }

    .timeline-time {
      font-size: 11px;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    .timeline-detail {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Sidebar Cards */
    .sidebar-card {
      background: var(--bg-tertiary);
      border-radius: var(--radius);
      padding: 16px;
    }

    .sidebar-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-row:last-child {
      border-bottom: none;
    }

    .sidebar-label {
      color: var(--text-secondary);
      font-size: 13px;
    }

    .sidebar-value {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .sidebar-value a {
      color: var(--primary);
      text-decoration: none;
    }

    /* Payment Grid */
    .payment-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .payment-item {
      background: var(--bg-tertiary);
      padding: 14px;
      border-radius: var(--radius);
      text-align: center;
    }

    .payment-amount {
      font-size: 20px;
      font-weight: 700;
      font-family: var(--font-mono);
    }

    .payment-amount.revenue { color: var(--success); }
    .payment-amount.expense { color: var(--warning); }
    .payment-amount.purple { color: var(--purple); }

    .payment-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .payment-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
    }

    .payment-status.paid {
      background: rgba(34, 197, 94, 0.1);
      color: var(--success);
    }

    .payment-status.pending {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning);
    }

    /* Signature */
    .signature-section {
      margin-bottom: 16px;
    }

    .signature-display {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 8px;
    }

    .signature-display img {
      max-height: 60px;
      max-width: 100%;
    }

    .signature-placeholder {
      color: var(--text-muted);
      font-size: 12px;
      font-style: italic;
    }

    .signature-meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Quick Actions */
    .quick-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .quick-action-btn {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: var(--font-body);
      transition: all 0.2s;
    }

    .quick-action-btn:hover {
      border-color: var(--primary);
      background: var(--bg-secondary);
    }

    .quick-action-btn .icon {
      font-size: 16px;
    }

    /* Photo Modal */
    .photo-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .photo-modal.active {
      display: flex;
    }

    .photo-modal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
    }

    .photo-modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--bg-secondary);
      border: none;
      color: var(--text-primary);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 400px;
      flex-direction: column;
      gap: 16px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Order Selector Modal */
    .order-selector-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .order-selector-content {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      width: 100%;
      max-width: 800px;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .order-selector-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .order-selector-header h2 {
      font-size: 18px;
    }

    .order-selector-body {
      padding: 20px;
      overflow-y: auto;
    }

    .order-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }

    .order-option {
      background: var(--bg-tertiary);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .order-option:hover {
      border-color: var(--primary);
    }

    .order-option .vehicle {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .order-option .route {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .order-option .meta {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .order-option .meta span {
      background: var(--bg-secondary);
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
    }

    .order-option .has-inspection {
      background: rgba(34, 197, 94, 0.1);
      color: var(--success);
    }

    /* Prototype Badge */
    .prototype-badge {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--purple);
      color: white;
      padding: 10px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      z-index: 9999;
      box-shadow: var(--shadow-md);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">
        <h1><span class="logo-icon">‚≠ê</span> <span>HORIZON STAR</span></h1>
        <p>Transportation Management</p>
      </div>

      <nav>
        <div class="nav-section">
          <a class="nav-item" href="#"><span class="icon">üìä</span> Dashboard</a>
          <a class="nav-item" href="#"><span class="icon">üöõ</span> Trips</a>
          <a class="nav-item active" href="#"><span class="icon">üì¶</span> Orders</a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Operations</div>
          <a class="nav-item" href="#"><span class="icon">üìã</span> Future Cars</a>
          <a class="nav-item" href="#"><span class="icon">üë•</span> Drivers</a>
          <a class="nav-item" href="#"><span class="icon">üöö</span> Fleet</a>
          <a class="nav-item" href="#"><span class="icon">üè¢</span> Brokers</a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Finance</div>
          <a class="nav-item" href="#"><span class="icon">üí∞</span> Financials</a>
          <a class="nav-item" href="#"><span class="icon">üìë</span> Payroll</a>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-wrapper">
      <header class="top-header">
        <div class="breadcrumb">
          <a href="#" onclick="showOrderSelector()">Orders</a>
          <span class="separator">/</span>
          <span class="current" id="breadcrumbTitle">Select an Order</span>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" onclick="showOrderSelector()">üìã Change Order</button>
        </div>
      </header>

      <main class="main-content" id="mainContent">
        <div class="loading">
          <div class="spinner"></div>
          <div>Loading orders...</div>
        </div>
      </main>
    </div>
  </div>

  <!-- Order Selector Modal -->
  <div id="orderSelectorModal" class="order-selector-modal" style="display:none;">
    <div class="order-selector-content">
      <div class="order-selector-header">
        <h2>üì¶ Select Order to View</h2>
        <button class="btn btn-secondary" onclick="hideOrderSelector()" style="padding:8px 12px">‚úï</button>
      </div>
      <div class="order-selector-body">
        <div id="orderGrid" class="order-grid"></div>
      </div>
    </div>
  </div>

  <!-- Photo Modal -->
  <div id="photoModal" class="photo-modal" onclick="closePhotoModal()">
    <button class="photo-modal-close" onclick="closePhotoModal()">√ó</button>
    <img id="photoModalImg" src="" alt="Inspection Photo">
  </div>

  <div class="prototype-badge">üß™ Prototype - Live Data</div>

  <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://yrrczhlzulwvdqjwvhtu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlycmN6aGx6dWx3dmRxand2aHR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NDYyOTQsImV4cCI6MjA4MTEyMjI5NH0.qVVxDH36OkLXnUe3Sfng1CJY7_Qt_IOGC-1QaDw6WlE';

    // State
    let orders = [];
    let selectedOrder = null;
    let inspections = [];
    let photos = [];
    let damages = [];
    let trip = null;
    let driver = null;

    // API Helper
    async function supabaseGet(endpoint) {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      if (!response.ok) throw new Error(`API Error: ${response.status}`);
      return response.json();
    }

    // Load orders
    async function loadOrders() {
      try {
        orders = await supabaseGet('orders?select=*&order=id.desc&limit=50');
        const allInspections = await supabaseGet('vehicle_inspections?select=*');

        orders = orders.map(order => ({
          ...order,
          hasInspection: allInspections.some(i => i.order_id === order.id)
        }));

        renderOrderGrid();
        showOrderSelector();
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('mainContent').innerHTML = `
          <div style="text-align:center;padding:60px;color:var(--danger)">
            Failed to load orders: ${error.message}
          </div>
        `;
      }
    }

    // Render order grid in modal
    function renderOrderGrid() {
      const grid = document.getElementById('orderGrid');
      grid.innerHTML = orders.map(order => `
        <div class="order-option" onclick="selectOrder(${order.id})">
          <div class="vehicle">${order.vehicle_year || ''} ${order.vehicle_make || ''} ${order.vehicle_model || ''}</div>
          <div class="route">${order.origin || 'Unknown'} ‚Üí ${order.destination || 'Unknown'}</div>
          <div class="meta">
            <span>${order.order_number || 'No #'}</span>
            ${order.hasInspection ? '<span class="has-inspection">‚úì Inspection</span>' : ''}
          </div>
        </div>
      `).join('');
    }

    function showOrderSelector() {
      document.getElementById('orderSelectorModal').style.display = 'flex';
    }

    function hideOrderSelector() {
      document.getElementById('orderSelectorModal').style.display = 'none';
    }

    // Select order
    async function selectOrder(orderId) {
      hideOrderSelector();
      selectedOrder = orders.find(o => o.id === orderId);

      document.getElementById('mainContent').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <div>Loading order details...</div>
        </div>
      `;

      try {
        inspections = await supabaseGet(`vehicle_inspections?order_id=eq.${orderId}&select=*`);

        photos = [];
        damages = [];
        for (const insp of inspections) {
          const p = await supabaseGet(`inspection_photos?inspection_id=eq.${insp.id}&select=*`);
          const d = await supabaseGet(`inspection_damages?inspection_id=eq.${insp.id}&select=*`);
          photos.push(...p.map(x => ({ ...x, inspection_type: insp.inspection_type })));
          damages.push(...d.map(x => ({ ...x, inspection_type: insp.inspection_type })));
        }

        trip = null;
        driver = null;
        if (selectedOrder.trip_id) {
          const trips = await supabaseGet(`trips?id=eq.${selectedOrder.trip_id}&select=*`);
          trip = trips[0];
          if (trip?.driver_id) {
            const drivers = await supabaseGet(`drivers?id=eq.${trip.driver_id}&select=*`);
            driver = drivers[0];
          }
        }

        renderOrderDetail();
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('mainContent').innerHTML = `
          <div style="text-align:center;padding:60px;color:var(--danger)">
            Failed to load: ${error.message}
          </div>
        `;
      }
    }

    // Format helpers
    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      return new Date(dateStr).toLocaleDateString('en-US', {
        month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit'
      });
    }

    function formatCurrency(amt) {
      return '$' + (Number(amt) || 0).toLocaleString();
    }

    function getInspection(type) {
      return inspections.find(i => i.inspection_type === type);
    }

    function getPhotosForType(type) {
      return photos.filter(p => p.inspection_type === type);
    }

    function getDamagesForType(type) {
      return damages.filter(d => d.inspection_type === type);
    }

    // Render inspection card
    function renderInspectionCard(type, label, icon) {
      const insp = getInspection(type);
      const typePhotos = getPhotosForType(type);
      const typeDamages = getDamagesForType(type);

      if (!insp) {
        return `
          <div class="inspection-card pending">
            <div class="inspection-header">
              <span class="inspection-type">${icon} ${label}</span>
              <span class="inspection-status pending">Pending</span>
            </div>
            <div class="inspection-photos">
              ${[1,2,3,4,5].map(() => '<div class="inspection-photo">‚Äî</div>').join('')}
            </div>
            <div class="inspection-meta"><span>Awaiting ${type}</span></div>
            <button class="view-btn" disabled>Awaiting ${label}</button>
          </div>
        `;
      }

      return `
        <div class="inspection-card ${insp.status === 'completed' ? 'completed' : ''}">
          <div class="inspection-header">
            <span class="inspection-type">${icon} ${label}</span>
            <span class="inspection-status ${insp.status}">${insp.status === 'completed' ? '‚úì Completed' : 'In Progress'}</span>
          </div>
          <div class="inspection-photos">
            ${typePhotos.slice(0, 5).map(p => `
              <div class="inspection-photo" onclick="openPhotoModal('${p.photo_url}')">
                <img src="${p.photo_url}" onerror="this.parentElement.innerHTML='${p.photo_type}'">
              </div>
            `).join('')}
            ${typePhotos.length > 5 ? `<div class="inspection-photo">+${typePhotos.length - 5}</div>` : ''}
          </div>
          <div class="inspection-meta">
            <span>üìÖ ${formatDate(insp.completed_at || insp.started_at)}</span>
            <span>üî¢ Odometer: ${insp.odometer ? insp.odometer.toLocaleString() + ' mi' : 'N/A'}</span>
            ${insp.customer_name ? `<span>‚úçÔ∏è ${insp.customer_name}</span>` : ''}
          </div>
          ${typeDamages.length > 0
            ? `<div class="damages-badge">‚ö†Ô∏è ${typeDamages.length} Damage${typeDamages.length > 1 ? 's' : ''}</div>`
            : `<div class="no-damages-badge">‚úì No Damages</div>`}
          <button class="view-btn">View Full Inspection ‚Üí</button>
        </div>
      `;
    }

    // Render signature
    function renderSignature(insp, type, label) {
      if (!insp) {
        return `
          <div class="signature-section">
            <div class="info-label">${label}</div>
            <div class="signature-display"><span class="signature-placeholder">Awaiting inspection</span></div>
          </div>
        `;
      }

      const sig = type === 'customer' ? insp.customer_signature : insp.driver_signature;
      const signedAt = type === 'customer' ? insp.customer_signed_at : insp.driver_signed_at;
      const name = type === 'customer' ? insp.customer_name : (driver ? `${driver.first_name} ${driver.last_name}` : 'Driver');

      if (!sig) {
        return `
          <div class="signature-section">
            <div class="info-label">${label}</div>
            <div class="signature-display"><span class="signature-placeholder">Not signed</span></div>
          </div>
        `;
      }

      return `
        <div class="signature-section">
          <div class="info-label">${label}</div>
          <div class="signature-display"><img src="${sig}" alt="Signature"></div>
          <div class="signature-meta">${name} ‚Ä¢ ${formatDate(signedAt)}</div>
        </div>
      `;
    }

    // Build timeline
    function buildTimeline() {
      const events = [];
      const pickupInsp = getInspection('pickup');
      const deliveryInsp = getInspection('delivery');

      events.push({ title: 'üìù Order Created', detail: `Order ${selectedOrder.order_number || '#' + selectedOrder.id}`, time: selectedOrder.created_at, status: 'completed' });

      if (trip) {
        events.push({ title: 'üöõ Assigned to Trip', detail: `Trip #${trip.trip_number}${driver ? ' ‚Ä¢ ' + driver.first_name : ''}`, time: trip.created_at, status: 'completed' });
      }

      if (pickupInsp?.status === 'completed') {
        events.push({ title: '‚úÖ Pickup Complete', detail: `Signed by ${pickupInsp.customer_name || 'customer'}`, time: pickupInsp.completed_at, status: 'completed' });
      }

      if (selectedOrder.delivery_status === 'picked_up') {
        events.push({ title: 'üöö In Transit', detail: 'Vehicle in transit', time: pickupInsp?.completed_at, status: 'current' });
      }

      if (deliveryInsp?.status === 'completed') {
        events.push({ title: '‚úÖ Delivered', detail: `Signed by ${deliveryInsp.customer_name || 'customer'}`, time: deliveryInsp.completed_at, status: 'completed' });
      }

      return events.sort((a, b) => new Date(b.time) - new Date(a.time));
    }

    // Render order detail
    function renderOrderDetail() {
      const vehicleDesc = `${selectedOrder.vehicle_year || ''} ${selectedOrder.vehicle_make || ''} ${selectedOrder.vehicle_model || ''}`.trim() || 'Unknown Vehicle';
      const pickupInsp = getInspection('pickup');
      const deliveryInsp = getInspection('delivery');
      const timeline = buildTimeline();

      document.getElementById('breadcrumbTitle').textContent = vehicleDesc;

      document.getElementById('mainContent').innerHTML = `
        <div class="page-header">
          <div class="page-title-section">
            <h1>${vehicleDesc}</h1>
            <span class="status-badge ${selectedOrder.delivery_status || 'pending'}">${(selectedOrder.delivery_status || 'pending').replace('_', ' ')}</span>
          </div>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Print</button>
            <button class="btn btn-primary">‚úèÔ∏è Edit Order</button>
          </div>
        </div>

        <div class="content-grid">
          <div class="left-column">
            <!-- Order Info -->
            <div class="card">
              <div class="card-title"><span class="icon">üì¶</span> Order Information</div>
              <div class="info-grid">
                <div class="info-item">
                  <div class="info-label">Order Number</div>
                  <div class="info-value">${selectedOrder.order_number || 'N/A'}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">VIN</div>
                  <div class="info-value mono">${selectedOrder.vehicle_vin || pickupInsp?.vehicle_vin || 'N/A'}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Vehicle</div>
                  <div class="info-value">${vehicleDesc}</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Color</div>
                  <div class="info-value">${pickupInsp?.vehicle_color || 'N/A'}</div>
                </div>
                <div class="info-item full-width">
                  <div class="info-label">Route</div>
                  <div class="route-display">
                    <div class="route-point">
                      <div class="city">${selectedOrder.origin || 'Unknown'}</div>
                      <div class="details">${selectedOrder.pickup_full_address || ''}</div>
                    </div>
                    <div class="route-arrow">
                      <div class="arrow">‚Üí</div>
                    </div>
                    <div class="route-point">
                      <div class="city">${selectedOrder.destination || 'Unknown'}</div>
                      <div class="details">${selectedOrder.delivery_full_address || ''}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Inspections -->
            <div class="card">
              <div class="card-title"><span class="icon">üîç</span> Vehicle Inspections</div>
              <div class="inspection-grid">
                ${renderInspectionCard('pickup', 'Pickup Inspection', 'üì•')}
                ${renderInspectionCard('delivery', 'Delivery Inspection', 'üì§')}
              </div>
            </div>

            <!-- Activity Log -->
            <div class="card">
              <div class="card-title"><span class="icon">üìú</span> Activity Log</div>
              ${timeline.length > 0 ? `
                <div class="timeline">
                  ${timeline.map(e => `
                    <div class="timeline-item">
                      <div class="timeline-dot ${e.status}"></div>
                      <div class="timeline-content">
                        <div class="timeline-header">
                          <span class="timeline-title">${e.title}</span>
                          <span class="timeline-time">${formatDate(e.time)}</span>
                        </div>
                        <div class="timeline-detail">${e.detail}</div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              ` : '<div style="text-align:center;color:var(--text-muted);padding:20px">No activity yet</div>'}
            </div>
          </div>

          <div class="right-column">
            <!-- Assignment -->
            <div class="card">
              <div class="card-title"><span class="icon">üöõ</span> Assignment</div>
              <div class="sidebar-card">
                <div class="sidebar-row">
                  <span class="sidebar-label">Trip</span>
                  <span class="sidebar-value">${trip ? '#' + trip.trip_number : 'Not Assigned'}</span>
                </div>
                <div class="sidebar-row">
                  <span class="sidebar-label">Driver</span>
                  <span class="sidebar-value">${driver ? driver.first_name + ' ' + driver.last_name : 'Not Assigned'}</span>
                </div>
                <div class="sidebar-row">
                  <span class="sidebar-label">Pickup Seq</span>
                  <span class="sidebar-value">${selectedOrder.pickup_sequence || 'N/A'}</span>
                </div>
                <div class="sidebar-row">
                  <span class="sidebar-label">Delivery Seq</span>
                  <span class="sidebar-value">${selectedOrder.delivery_sequence || 'N/A'}</span>
                </div>
              </div>
            </div>

            <!-- Financials -->
            <div class="card">
              <div class="card-title"><span class="icon">üí∞</span> Financials</div>
              <div class="payment-grid">
                <div class="payment-item">
                  <div class="payment-amount revenue">${formatCurrency(selectedOrder.revenue)}</div>
                  <div class="payment-label">Revenue</div>
                  <div class="payment-status ${selectedOrder.payment_status === 'paid' ? 'paid' : 'pending'}">
                    ${selectedOrder.payment_status === 'paid' ? '‚úì Paid' : selectedOrder.payment_type || 'Pending'}
                  </div>
                </div>
                <div class="payment-item">
                  <div class="payment-amount expense">${formatCurrency(selectedOrder.broker_fee)}</div>
                  <div class="payment-label">Broker Fee</div>
                </div>
                <div class="payment-item">
                  <div class="payment-amount revenue">${formatCurrency((selectedOrder.revenue || 0) - (selectedOrder.broker_fee || 0))}</div>
                  <div class="payment-label">Net Revenue</div>
                </div>
                <div class="payment-item">
                  <div class="payment-amount purple">${formatCurrency(selectedOrder.driver_paid_amount)}</div>
                  <div class="payment-label">Driver Pay</div>
                  <div class="payment-status ${selectedOrder.driver_paid_status === 'paid' ? 'paid' : 'pending'}">
                    ${selectedOrder.driver_paid_status === 'paid' ? '‚úì Paid' : 'Unpaid'}
                  </div>
                </div>
              </div>
            </div>

            <!-- Signatures -->
            <div class="card">
              <div class="card-title"><span class="icon">‚úçÔ∏è</span> Signatures</div>
              ${renderSignature(pickupInsp, 'customer', 'Pickup - Customer')}
              ${renderSignature(pickupInsp, 'driver', 'Pickup - Driver')}
              ${renderSignature(deliveryInsp, 'customer', 'Delivery - Customer')}
            </div>

            <!-- Quick Actions -->
            <div class="card">
              <div class="card-title"><span class="icon">‚ö°</span> Quick Actions</div>
              <div class="quick-actions">
                <button class="quick-action-btn"><span class="icon">üìÑ</span> Generate Route Sheet</button>
                <button class="quick-action-btn"><span class="icon">üìß</span> Email BOL to Broker</button>
                <button class="quick-action-btn"><span class="icon">üíµ</span> Mark Payment Collected</button>
                <button class="quick-action-btn"><span class="icon">üîÑ</span> Change Assignment</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Photo modal
    function openPhotoModal(url) {
      document.getElementById('photoModalImg').src = url;
      document.getElementById('photoModal').classList.add('active');
    }

    function closePhotoModal() {
      document.getElementById('photoModal').classList.remove('active');
    }

    document.addEventListener('keydown', e => { if (e.key === 'Escape') closePhotoModal(); });

    // Initialize
    loadOrders();
  </script>
</body>
</html>
